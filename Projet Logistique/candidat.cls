VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
  Persistable = 0  'NotPersistable
  DataBindingBehavior = 0  'vbNone
  DataSourceBehavior  = 0  'vbNone
  MTSTransactionMode  = 0  'NotAnMTSObject
END
Attribute VB_Name = "Candidat"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = True

Public Application  As Application
Public Request As Request
Public Session As Session
Public Response As Response
Public Server As Server
Public FormCaption As String
Public FlagHTMLEditor As Boolean
 Public MyConnecSting As String
Const GlobalStyle = "<link rel=STYLESHEET href=""PMainStyle1.asp"" type=""text/css""> "
Function FunDateRelance(MyDate As Date) As String
'FunDateRelance = Format(MyDate - 2, "yyyy-mm-dd hh:mm:ss")
FunDateRelance = Format(MyDate - val(GetDefault("DateRelance", "3", DsnTableMenu(Session("candidat_ADOContact")))), "yyyy-mm-dd hh:mm:ss")
Reprise:

If Weekday(FunDateRelance) = (1 Or 7) Then
    FunDateRelance = Format(CDate(FunDateRelance) - 1, "yyyy-mm-dd hh:mm:ss")
    GoTo Reprise
End If
End Function
Public Function EnteteChamps(TableauChamps) As String
Dim I As Long

For I = 0 To UBound(TableauChamps)
    EnteteChamps = EnteteChamps & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("" & TableauChamps(I))) & "</td>"
Next
 
  
End Function
Public Function SousRubique(Titre As String) As String
'SousRubique = SousRubique & vbCrLf & "</table>"
        SousRubique = SousRubique & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
    SousRubique = SousRubique & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
    SousRubique = SousRubique & vbCrLf & "    <tr>"
    SousRubique = SousRubique & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
    SousRubique = SousRubique & vbCrLf & "bandeg.gif"" border=""0""></td>"
    SousRubique = SousRubique & vbCrLf & "        <td class=""ecomtitrecaddie2"" >" & Titre & "</td>"
    SousRubique = SousRubique & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
    SousRubique = SousRubique & vbCrLf & "banded.gif"" border=""0""></td>"
    SousRubique = SousRubique & vbCrLf & "    </tr>"
    SousRubique = SousRubique & vbCrLf & "</table>"
End Function
Public Function AfficheBounton(Titre As String, Id, Url) As String
'AfficheBounton = AfficheBounton & vbCrLf & "</table>"

        AfficheBounton = AfficheBounton & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
    AfficheBounton = AfficheBounton & vbCrLf & "Boutoncentre.bmp"" cellpadding=""0"" cellspacing=""0"" width=""100%"" "
    If Trim("" & Id) <> "" Then
        AfficheBounton = AfficheBounton & "id='" & Id & "'>"
    Else
       AfficheBounton = AfficheBounton & ">"
    End If
    AfficheBounton = AfficheBounton & vbCrLf & "    <tr>"
    AfficheBounton = AfficheBounton & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
    AfficheBounton = AfficheBounton & vbCrLf & "BoutonLeft.bmp"" border=""0""></td>"
    AfficheBounton = AfficheBounton & vbCrLf & ""
    AfficheBounton = AfficheBounton & vbCrLf & "        <td align=""center""><a href=" & Url & " border='0'>" & Titre & "</a></td>"
       AfficheBounton = AfficheBounton & vbCrLf & ""
    AfficheBounton = AfficheBounton & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
    AfficheBounton = AfficheBounton & vbCrLf & "Boutonrith.bmp"" border=""0""></td>"
    AfficheBounton = AfficheBounton & vbCrLf & "    </tr>"
    AfficheBounton = AfficheBounton & vbCrLf & "</table>"
  Debug.Print AfficheBounton
End Function

Public Function FunEmpouleFour(Conn, Comm As String, href, Traitement As String, Optional IsAdmin As Boolean)
Dim Sql As String
Dim RsFlag As Recordset
Dim Empoule As Boolean
'Empoule = True
FunEmpouleFour = ""

Select Case Traitement
    Case "Val"
            Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
            
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = True
            End If
 Case "Env"
            Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "

            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = False Then
                Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_BR.Id_Com_Four "
                Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
'                Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Empoule = True
                End If
            End If

 Case "BR"
            Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "

            Set RsFlag = Conn.Execute(Sql)
           
             If RsFlag.EOF = False Then
                Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_BR.Id_Com_Four "
                Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
'                Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = False Then
                    Sql = "SELECT T_Devis_Fournisseurs.[Ref Groupe Commande], Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                    Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                    Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                    Sql = Sql & "T_BR.Id_Com_Four "
                    Sql = Sql & "GROUP BY T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Four_Raison_Social.CommandeValider,  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                    Sql = Sql & "HAVING T_Devis_Fournisseurs.[Ref Groupe Commande]='" & Comm & "'   "
                    Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                    Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                    Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                    Set RsFlag = Conn.Execute(Sql)
                    If RsFlag.EOF = True Then
                        Empoule = True
                    End If
                End If
            End If
     
Case "ValDJ"
            Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
            
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = True
            End If
 Case "EnvDJ"
            Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "

            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = False Then
                Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_BR.Id_Com_Four "
                Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
'                Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Empoule = True
                End If
            End If

 Case "BRDJ"
            Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
            Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
            Sql = Sql & "T_BR.Id_Com_Four "
            Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
            Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
            Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
            Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "

            Set RsFlag = Conn.Execute(Sql)
           
             If RsFlag.EOF = False Then
                Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                Sql = Sql & "T_BR.Id_Com_Four "
                Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
                Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
'                Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = False Then
                    Sql = "SELECT T_Devis_Fournisseurs.Commande, Min(Br_Fournisseurs.Reste) AS MinDeReste,  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.CommandeValider, T_Devis_Four_Raison_Social.EnvoyeMail "
                    Sql = Sql & "FROM ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four) INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four)  "
                    Sql = Sql & "LEFT JOIN (T_BR LEFT JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id =  "
                    Sql = Sql & "T_BR.Id_Com_Four "
                    Sql = Sql & "GROUP BY T_Devis_Fournisseurs.Commande, T_Devis_Four_Raison_Social.CommandeValider,  "
                    Sql = Sql & "T_Devis_Four_Raison_Social.EnvoyeMail "
                    Sql = Sql & "HAVING T_Devis_Fournisseurs.Commande='" & Comm & "'   "
                    Sql = Sql & "AND Min(Br_Fournisseurs.Reste)=0  "
                    Sql = Sql & "AND T_Devis_Four_Raison_Social.CommandeValider=True  "
                    Sql = Sql & "AND T_Devis_Four_Raison_Social.EnvoyeMail Is Not Null;"
                    Set RsFlag = Conn.Execute(Sql)
                    If RsFlag.EOF = True Then
                        Empoule = True
                    End If
                End If
            End If
        
End Select
If Trim("" & FunEmpouleFour) = "" Then
    If Empoule = False Then
        FunEmpouleFour = "<td nowrap>&nbsp;</td>"
    Else
        FunEmpouleFour = href
    End If
End If
End Function
Public Function FunEmpoule(Conn, IdAvoire, href, Traitement As String, Optional IsAdmin As Boolean)
Dim Sql As String
Dim RsFlag As Recordset
Dim Empoule As Boolean
Empoule = True
FunEmpoule = ""

Select Case Traitement

 Case "Chek"
            Sql = "SELECT T_Avoire.IdAvoire "
            Sql = Sql & "From T_Avoire "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & IdAvoire & "  "
            Sql = Sql & "AND T_Avoire.FacturerOk=False  "
            Sql = Sql & "AND [Credit]-[Debit]<[Credit]  AND T_Avoire.Debit<>[Credit] "
            Sql = Sql & "AND T_Avoire.AnCoursFacturation=False;"

            
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = False
            End If
    Case "CommBL"
            Sql = "SELECT T_Num_Commande.NumCommande "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis  "
            Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"

             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = False
            End If
Case "CLIBL"
            Sql = "SELECT Users.UserID "
            Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN "
            Sql = Sql & "(T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) "
            Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) "
            Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
            Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                
                Empoule = False
         
            End If
Case "CMDTrans"
            Sql = "SELECT t_Devis.numDevis  "
                Sql = Sql & "From t_Devis  "
                Sql = Sql & "WHERE t_Devis.numDevis='" & IdAvoire & "'   "
                Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Sql = "SELECT T_Frais_Transport.numDevis "
                Sql = Sql & "From T_Frais_Transport "
                Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & IdAvoire & "'  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0;"



                    Set RsFlag = Conn.Execute(Sql)
                
                
                If RsFlag.EOF = True Then
                
                        Empoule = False
                End If
            Else
                Empoule = False
            End If

Case "Trans"
            Sql = "SELECT t_Devis.Id_Avoire From t_Devis "
            Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & " "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Sql = "SELECT t_Devis.Id_Avoire "
                Sql = Sql & "FROM t_Devis INNER JOIN T_Frais_Transport  "
                Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis "
                Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & "  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0;"


                    Set RsFlag = Conn.Execute(Sql)
                
                
                If RsFlag.EOF = True Then
                
                        Empoule = False
                End If
            Else
                Empoule = False
            End If
            

Case "CommTrans"
            Sql = "SELECT T_Num_Commande.NumCommande "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis  "
            Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Sql = "SELECT T_Num_Commande.NumCommande "
                Sql = Sql & "FROM T_Num_Commande INNER  "
                Sql = Sql & "JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
                Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
                Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
                Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                 Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0;"

                    Set RsFlag = Conn.Execute(Sql)
                
                
                If RsFlag.EOF = True Then
                
                        Empoule = False
                End If
            Else
                Empoule = False
            End If
            
    Case "CLITrans"
            Sql = "SELECT Users.UserID "
            Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis  "
            Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
            Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
            Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Sql = "SELECT Users.UserID   "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER  "
                    Sql = Sql & "JOIN (t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete  "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
                    Sql = Sql & "AND T_Frais_Transport.Frais=0;"
                    Set RsFlag = Conn.Execute(Sql)
                
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                   Empoule = False
                 
                End If
            Else
                Empoule = False
            End If
Case "AVN"
'            If Session("candidat_UserType") = "Administrator" Then
'                  FunEmpoule = FunCarteBleu(Conn, "" & IdAvoire, href)
'                  Exit Function
'            Else
               Sql = "SELECT t_Devis.Id_Avoire From t_Devis "
            Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & " "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
    '
                 Sql = "SELECT t_Devis.Id_Avoire "
                Sql = Sql & "FROM t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis "
                Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & "  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0  "
'                Sql = Sql & "OR (T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "'   "
'                Sql = Sql & "AND T_Frais_Transport.Frais=0));"



                        Set RsFlag = Conn.Execute(Sql)
    '
                     
                    If RsFlag.EOF = False Then
                            Empoule = False
                    Else
                            
                        Sql = "SELECT T_Avoire.IdAvoire "
                Sql = Sql & "FROM (T_Avoire LEFT JOIN T_Facturation_Cli ON T_Avoire.IdAvoire =  "
                Sql = Sql & "T_Facturation_Cli.Id_Avoire) LEFT JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire "
                Sql = Sql & "WHERE T_Avoire.IdAvoire=" & IdAvoire & "  "
                Sql = Sql & "AND t_Devis.Id Is Not Null  "
                Sql = Sql & "AND T_Facturation_Cli.Id Is Null;"


                     Set RsFlag = Conn.Execute(Sql)
                        If RsFlag.EOF = True Then
                            Empoule = False
                         Else
                            If IsAdmin = True Then
                                FunEmpoule = "<td nowrap><b><a href='" & href & "'><div align=""center""><img width=""20"" height=""20"" src=""CarteBleu.gif""border=""0""></div></b></a></td>"""
                            End If
                        End If
                        
                    End If
                Else
                    Empoule = False
                End If
'            End If
  
  Case "CommAvn"
             Sql = "SELECT T_Num_Commande.NumCommande "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis  "
            Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
'
                    Sql = "SELECT T_Num_Commande.NumCommande "
                Sql = Sql & "FROM T_Num_Commande INNER  "
                Sql = Sql & "JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
                Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
                Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
                Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0;"
                    Set RsFlag = Conn.Execute(Sql)
'
                 
                If RsFlag.EOF = False Then
                        Empoule = False
                Else
                        
                    Sql = "SELECT T_Num_Commande.NumCommande "
                    Sql = Sql & "FROM T_Num_Commande INNER JOIN ((T_Avoire INNER JOIN t_Devis  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) LEFT JOIN T_Facturation_Cli  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire)  "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                    Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                    Sql = Sql & "AND T_Facturation_Cli.NumFacture Is Null;"

                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Empoule = False
                End If
                
                End If
            Else
                Empoule = False
            End If
Case "CLIAvn"
            Sql = "SELECT Users.UserID "
            Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
            Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) ON Users.Id_Societes = T_Num_Commande.IdSociete "
            Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
'
                    Sql = "SELECT Users.UserID   "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
                    Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete  "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
                    Sql = Sql & "AND T_Frais_Transport.Frais=0;"
                    Set RsFlag = Conn.Execute(Sql)
'
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = False Then
                        Empoule = False
                Else
                        
                    Sql = "SELECT Users.UserID "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN ((T_Avoire INNER JOIN t_Devis  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) LEFT JOIN T_Facturation_Cli  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Facturation_Cli.NumFacture Is  Null;"



                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Empoule = False
                End If
                
                End If
            Else
                Empoule = False
            End If

Case "CommFac"
            Sql = "SELECT T_Num_Commande.NumCommande "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis  "
            Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
'
                   Sql = "SELECT T_Num_Commande.NumCommande "
                Sql = Sql & "FROM T_Num_Commande INNER  "
                Sql = Sql & "JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
                Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
                Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
                Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                 Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais<>0;"
                    Set RsFlag = Conn.Execute(Sql)
'
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                        Empoule = False
                Else
                    Sql = "SELECT T_Num_Commande.NumCommande "
                    Sql = Sql & "FROM T_Num_Commande INNER JOIN ((T_Avoire INNER JOIN t_Devis  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) LEFT JOIN T_Facturation_Cli  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire)  "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                    Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                    Sql = Sql & "AND T_Facturation_Cli.NumFacture Is Null;"


                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Sql = "SELECT T_Num_Commande.NumCommande  "
                    Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire  "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                    Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & IdAvoire & "'  "
                    Sql = Sql & "AND T_Avoire.FacturerOk=False  "
                    Sql = Sql & "AND  [Credit]-[Debit]<[Credit]  AND T_Avoire.Debit<>[Credit];"

                    
                     Set RsFlag = Conn.Execute(Sql)
                    If RsFlag.EOF = True Then
                         Empoule = False
                    End If
                Else
                    Empoule = False
                End If
                
                End If
            Else
                Empoule = False
            End If
    
Case "CLIFAC"
            Sql = "SELECT Users.UserID "
            Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER  "
            Sql = Sql & "JOIN (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
            Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
            Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
            Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"
             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
'
                    Sql = "SELECT Users.UserID   "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER   "
                    Sql = Sql & "JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport   "
                    Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis)   "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)   "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)   "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete  "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                     Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                    Sql = Sql & "AND T_Frais_Transport.Frais<>0;"
                    Set RsFlag = Conn.Execute(Sql)
'
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                        Empoule = False
                Else
                    Sql = "SELECT Users.UserID "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER  "
                    Sql = Sql & "JOIN ((T_Avoire INNER JOIN t_Devis  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) LEFT JOIN T_Facturation_Cli  "
                    Sql = Sql & "ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire)  "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Facturation_Cli.NumFacture Is Null;"

                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = True Then
                    Sql = "SELECT Users.UserID "
                    Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN T_Avoire  "
                    Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
                    Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete "
                    Sql = Sql & "WHERE Users.UserID=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Avoire.FacturerOk=false AND  [Credit]-[Debit]<[Credit]  AND T_Avoire.Debit<>[Credit];"
                    
                     Set RsFlag = Conn.Execute(Sql)
                    If RsFlag.EOF = True Then
                         Empoule = False
                    End If
                Else
                    Empoule = False
                End If
                
                End If
            Else
                Empoule = False
            End If

    Case "CMDBl"
                Sql = "SELECT t_Devis.numDevis  "
                Sql = Sql & "From t_Devis  "
                Sql = Sql & "WHERE t_Devis.numDevis='" & IdAvoire & "'   "
                Sql = Sql & "AND [qte_produit]-[Reste]<>0;"


    
'            Sql = "SELECT t_Devis.Id From t_Devis "
'            Sql = Sql & "WHERE [qte_produit]-[Reste]<>0 and t_Devis.Id=" & IdAvoire & ";"
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = False
            End If
    Case "BL"
            Sql = "SELECT t_Devis.Id_Avoire From t_Devis "
            Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & " "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"

    
'            Sql = "SELECT t_Devis.Id From t_Devis "
'            Sql = Sql & "WHERE [qte_produit]-[Reste]<>0 and t_Devis.Id=" & IdAvoire & ";"
            Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                Empoule = False
            End If
            
     Case "FAC"
            Sql = "SELECT t_Devis.Id_Avoire "
            Sql = Sql & "From t_Devis "
            Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & "  "
            Sql = Sql & "AND [qte_produit]-[Reste]<>0;"

             Set RsFlag = Conn.Execute(Sql)
            If RsFlag.EOF = True Then
'
                Sql = "SELECT t_Devis.Id_Avoire "
                Sql = Sql & "FROM t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
                Sql = Sql & "T_Frais_Transport.numDevis "
                Sql = Sql & "WHERE t_Devis.Id_Avoire=" & IdAvoire & "  "
                Sql = Sql & "AND T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "'   "
'                 Sql = Sql & " Or T_Frais_Transport.ModeTransport='" & replaceAccent(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session ("candidat_ADOContact"))(Session ("candidat_ADOContact"))), True, True) & "')   "
                Sql = Sql & "AND T_Frais_Transport.Frais=0;"

'
                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = False Then
                        Empoule = False
                Else
                    Sql = "SELECT T_Facturation_Cli.Id_Avoire "
                Sql = Sql & "From T_Facturation_Cli "
                Sql = Sql & "WHERE T_Facturation_Cli.Id_Avoire=" & IdAvoire & ";"


                 Set RsFlag = Conn.Execute(Sql)
                If RsFlag.EOF = False Then
                    Sql = "SELECT T_Avoire.IdAvoire "
                    Sql = Sql & "From T_Avoire "
                    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & IdAvoire & "  "
                    Sql = Sql & "AND T_Avoire.FacturerOk=False  "
                    Sql = Sql & "AND  [Credit]-[Debit]<[Credit]  AND T_Avoire.Debit<>[Credit];"


                    
                     Set RsFlag = Conn.Execute(Sql)
                    If RsFlag.EOF = True Then
                         Empoule = False
                    End If
                Else
                    Empoule = False
                End If
                
                End If
            Else
                Empoule = False
            End If
End Select
If Trim("" & FunEmpoule) = "" Then
    If Empoule = False Then
        FunEmpoule = "<td nowrap>&nbsp;</td>"
    Else
        FunEmpoule = href
    End If
End If
End Function
Function BuildCatList(IdLevel As Integer, IdParent As Integer, ValueToMatch) As String

   
    fieldNAME = "CategoryName"
 
    Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & " Where CatLevel=" & IdLevel & " AND CatParent=" & IdParent & " ORDER BY CatId")
    

    Buffer = ""
    Buffer = Buffer & vbCrLf & ("<script language=""javascript"">")
    Buffer = Buffer & vbCrLf & ("function javClient() {")
    Buffer = Buffer & vbCrLf & ("var prog = document.frm." & fieldNAME & ".options[document.frm." & fieldNAME & ".selectedIndex].value")
    Buffer = Buffer & vbCrLf & ("//alert(prog);")
 
    my_concats = GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact"))
    Do While Not RS1.EOF
     
        If RS1("CatId") = val(ValueToMatch) Then ValueString = RS1("CatName")
     
        Set RS2 = GeneralTools.My_Conn.Execute("SELECT Count(*) AS RecCount FROM " & my_concats & " Where CatParent=" & RS1("CatId"))
        Buffer = Buffer & vbCrLf & ("if (prog == " & RS1("CatId") & ") {")
        Buffer = Buffer & vbCrLf & ("   document.frm.SubCategoryName.length = " & RS2("RecCount"))
    
        Set rs3 = GeneralTools.My_Conn.Execute("SELECT * FROM " & my_concats & " Where CatLevel=2 AND CatParent=" & RS1("CatId") & " ORDER BY catname")
    
        I = 0
        Do While Not rs3.EOF
           Buffer = Buffer & vbCrLf & ("var NewOpt = new Option(""" & rs3("CatId") & "-" & rs3("CatName") & """,""" & rs3("CatId") & """)")
           Buffer = Buffer & vbCrLf & ("document.frm.SubCategoryName.options[" & I & "] = NewOpt")
           'Buffer = Buffer & vbCrLf & ("document.frm.SubCategoryName.options[" & i & "].text = """ & rs3("CatId") & "-" & rs3("CatName") & """")
           I = I + 1
           rs3.MoveNext
        Loop
        Buffer = Buffer & vbCrLf & ("}")
        RS1.MoveNext
    Loop
    
    Buffer = Buffer & vbCrLf & ("}")
    Buffer = Buffer & vbCrLf & ("</script>")
    Buffer = Buffer & vbCrLf & ("<select  class=""tbflat"" name=""" & fieldNAME & """ onChange=""javClient()"" size=""1"" tabindex=""17"">")
    Buffer = Buffer & vbCrLf & ("<option value=""" & ValueToMatch & """ selected>" & ValueToMatch & "-" & ValueString)
    
    Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & " Where CatLevel=" & IdLevel & " AND CatParent=" & IdParent & " ORDER BY Catname")
    Do While Not RS1.EOF
        If UCase(RS1("CatId")) <> UCase(ValueToMatch) Then
            Buffer = Buffer & vbCrLf & ("<option value='" & RS1("CatId") & "'>" & RS1("CatId") & "-" & RS1("CatName"))
        End If
    RS1.MoveNext
    Loop
    
    Buffer = Buffer & vbCrLf & ("</select>" & Session("candidat_subContactType"))
    BuildCatList = Buffer
    Buffer = ""
End Function

Public Function BuildSubCatList(IdLevel As Integer, IdParent As Integer, ValueToMatch) As String

    fieldNAME = "SubCategoryName"
    Buffer = ""
    Buffer = Buffer & vbCrLf & ("<select  class=""tbflat"" name=""SubCategoryName""  size=""1"" tabindex=""17"">")
    
    
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
 
    Set RS1 = New ADODB.Recordset

    Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & " Where CatLevel=" & IdLevel & " AND CatParent=" & IdParent & " ORDER BY CatId")
    Do While Not RS1.EOF
        If UCase(RS1("CatId")) <> val(ValueToMatch) Then
            Buffer = Buffer & vbCrLf & ("<option value='" & RS1("Catid") & "'>" & RS1("CatName"))
        Else
            Buffer = Buffer & vbCrLf & ("<option value=""" & ValueToMatch & """ selected>" & ValueToMatch & "-" & RS1("CatName"))
        End If
    RS1.MoveNext
    Loop
    Buffer = Buffer & vbCrLf & ("</select>" & Session("candidat_subContactType"))
    BuildSubCatList = Buffer
    Buffer = ""
    
End Function

Public Function BuildTableList(fieldNAME As String, IdLevel As Integer, IdParent As Integer, ValueToMatch) As String

    Buffer = ""
    Buffer = Buffer & vbCrLf & ("<select name=""" & fieldNAME & """  size=""1"">")
    
    
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    Set RS1 = New ADODB.Recordset
    Sql = "SELECT * FROM " & fieldNAME & " Where CatLevel=" & IdLevel & " AND CatParent=" & IdParent
    Set RS1 = GeneralTools.My_Conn.Execute(Sql)
    Do While Not RS1.EOF
        If val(RS1("CatId")) <> val(ValueToMatch) Then
            Buffer = Buffer & vbCrLf & ("<option value=""" & RS1("CatId") & """>" & RS1("CatName") & " </option>")
        Else
            Buffer = Buffer & vbCrLf & ("<option value=""" & ValueToMatch & """ selected>" & RS1("CatName") & " </option>")
        End If
    RS1.MoveNext
    Loop
    Buffer = Buffer & vbCrLf & ("</select>" & Session("subContactType"))
    BuildTableList = Buffer
    Buffer = ""

    RS1.Close
    Set RS1 = Nothing
End Function

Public Sub modSEARCH()
Dim Rs As Recordset
Dim Sql As String
Dim IndexTab As Long
Dim long_Ubound As Long
Dim TableauSherch() As String
 Dim SelecetList As String
 Dim boolSelecetList As Boolean
IndexTab = 0
boolSelecetList = False
' On recupere le nombre de lignes
'If Request("nbSelect") > 0 Then
 nbLignes = CInt(Request("nbSelect")) + 1
'Else
' nbLignes = 0
'End If
Const IndexOperateurDefault = 2
Dim IndexChamps As Long
Dim aSlt_OPERATEUR(1, 8)
aSlt_OPERATEUR(0, 0) = "<"
aSlt_OPERATEUR(0, 1) = "<="
aSlt_OPERATEUR(0, 2) = "="
aSlt_OPERATEUR(0, 3) = "=>"
aSlt_OPERATEUR(0, 4) = ">"
aSlt_OPERATEUR(0, 5) = "LIKE1"
aSlt_OPERATEUR(0, 6) = "LIKE2"
aSlt_OPERATEUR(0, 7) = "LIKE"
aSlt_OPERATEUR(0, 8) = "<>"

aSlt_OPERATEUR(1, 0) = "Inférieur à"
aSlt_OPERATEUR(1, 1) = "Inférieur ou Egal à"
aSlt_OPERATEUR(1, 2) = "Egal à"
aSlt_OPERATEUR(1, 3) = "Supérieur ou Egal à"
aSlt_OPERATEUR(1, 4) = "Supérieur à"
aSlt_OPERATEUR(1, 5) = " Commençant par"
aSlt_OPERATEUR(1, 6) = "Finissant par"
aSlt_OPERATEUR(1, 7) = "Contient"
aSlt_OPERATEUR(1, 8) = "Différent"

Dim aSlt_Logique(1, 2)
aSlt_Logique(0, 0) = "(Aucun)"
aSlt_Logique(0, 1) = "AND"
aSlt_Logique(0, 2) = "OR"

aSlt_Logique(1, 0) = "(Aucun)"
aSlt_Logique(1, 1) = "ET"
aSlt_Logique(1, 2) = "OU"








Dim aSlt2(1, 1)
aSlt2(0, 0) = 3
aSlt2(1, 0) = "Option 3"
aSlt2(0, 1) = 4
aSlt2(1, 1) = "Option 4"

    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
'    Sql = "SELECT con_FieldDefs.FieldAlias, con_FieldDefs.FieldName,con_FieldDefs.FieldAttribut From con_FieldDefs "
    Sql = "SELECT DISTINCT con_FieldDefs.FieldAlias, con_FieldDefs.FieldName,con_FieldDefs.FieldAttribut FROM con_FieldDefs LEFT JOIN con_Fields ON con_FieldDefs.FieldID = con_Fields.FieldID "
    Sql = Sql & "WHERE (con_FieldDefs.FieldAlias<>''  AND  (con_FieldDefs.FieldAttribut Like '%CRI%'  or con_FieldDefs.FieldAttribut Like '%CRINV%' )) "

    
'WHERE (((con_FieldDefs.FieldAttribut) Like '%CRI%'));
'SELECT DISTINCT con_FieldDefs.FieldAlias, con_FieldDefs.FieldName, con_FieldDefs.FieldAttribut
'WHERE (((con_FieldDefs.FieldAttribut) Like '*CRI*') AND ((con_Fields.UserID)=1)) OR (((con_FieldDefs.FieldAttribut) Like '*CRINV*') AND ((con_Fields.UserID) Is Null))
'ORDER BY con_FieldDefs.FieldAlias;


    If Session("candidat_UserType") <> "Administrator" Then
        Sql = Sql & " and con_FieldDefs.FieldAttribut Not Like '%SYS%' "
 
    End If
    If Session("Droits_SockEncelade") <> 1 Then
         Sql = Sql & " and con_FieldDefs.FieldAttribut Not Like '%ENC%' "
    End If
    Sql = Sql & "ORDER BY con_FieldDefs.FieldAlias;"
   Debug.Print Replace(Sql, "%", "*")
    Set Rs = GeneralTools.My_Conn.Execute(Sql)
    IndexChamps = 0
    While Rs.EOF = False
    If InStr(1, UCase(Rs!FieldAttribut), "CRI1") <> 0 Then
     IndexChamps = IndexTab
    End If
    ReDim Preserve TableauSherch(IndexTab)
     TableauSherch(IndexTab) = Rs("FieldName") & ";" & Rs("FieldAlias") & ";" & Rs("FieldAttribut")
    IndexTab = IndexTab + 1
        Rs.MoveNext
    Wend
            pr "<SCRIPT>"
            
            pr "function MyChangeFilde(MyChangeFilde_inFORM,MyChangeFilde_Obj) {"
            pr "    MyChangeFilde_oSlt = eval(""document."" + MyChangeFilde_inFORM + ""."" + MyChangeFilde_Obj);"
            pr "                    MyChangeFilde_oSlt.value='';"
             pr " document.CloseWhere.submit();"
           
            pr "}"
            pr "function CheckedRadiobutton(IndexRadiobutton,nbLignes){"
            pr "for(i=1;i<nbLignes+1;i++) {"
            pr "}"
             pr "            }"
            
            pr "function MyChange( MyChange_inFORM,MyChange_Obj,MyChange_Obj2,MyChange_Index) {"
            pr "    MyChange_oSlt = eval(""document."" + MyChange_inFORM + ""."" + MyChange_Obj);"
            pr "    MyChange_oSlt2 = eval(""document."" + MyChange_inFORM + ""."" + MyChange_Obj2);"
            pr "    MyChange_oSlt3 = eval(""document."" + MyChange_inFORM + "".nbSelect"" );"
            pr "    for (MyChange_k = 0; MyChange_k < MyChange_oSlt.options.length; MyChange_k++) {"
            pr "        if (MyChange_oSlt.options[MyChange_k].selected == true) {"
            pr "            var MyChange_STRTEXTE =MyChange_oSlt.options[MyChange_k].text;"
            pr "            if ((MyChange_STRTEXTE  ==""(Aucun)"") && (MyChange_oSlt2.value!=""(Aucun)"")) {"
            pr "                    MyChange_oSlt3.value=MyChange_Index"
            pr "                    MyChange_oSlt2.value=MyChange_STRTEXTE;"
             pr " document.CloseWhere.submit();"
            pr "            } else {"
            pr "                if ((MyChange_STRTEXTE  !=""(Aucun)"") && (MyChange_oSlt2.value==""(Aucun)"")) {"
            pr "                    MyChange_oSlt2.value=MyChange_STRTEXTE;"
             pr " document.CloseWhere.submit();"
            pr "               }"
            pr "            }"
            pr "        }"
            pr "    }"
            pr "}"
            '
            
          
            
            pr "function mySubmit(Mode) {"
            pr " myForm = this.document.forms[0];"
            pr "myForm.action = ""Contact.asp?mode=con_lst&Category=All"";"
            pr " myForm.EnceladeSearch.value=""Search"" + Mode;"
            pr " myForm.mode.value=""con_lst"";"
           
            pr " document.CloseWhere.submit();"
            
          
              pr "}"
            
'            Session("candidat_MainTable") = "con_Contacts"
'
'
        pr "  </SCRIPT>"
              
    pr ("<form name=""CloseWhere"" method=""post"" action=""Contact.asp?mode=Search#FinDoc"" >")
    pr (" <input type=""hidden"" name=""mode"" value=""Search"">")
    pr "  <input type=""hidden"" name=""EnceladeSearch"" >"
    pr (" <table width=""100%"" border=""2"" bgcolor='#B7B8DE' cellpadding=""1"" cellspacing=""0"">")
    pr ("  <tr valign=""bottom"">")
    pr ("   <td>")
    pr ("    <table width=""100%"" border=""0"">")
    pr ("     <tr valign=""bottom"">")
    pr ("       <td align=""left"" valign=""middle"">")
    pr "<font color='#FFFFFF' size='" & GetDefault("con_H_Linge", "2", Session("candidat_ADOContact")) & "' >"
    pr ("        " & Session("Encelade_Message"))
    pr "</font>"
    pr ("       </td>")
    pr ("       <td>")
'    pr ("        <font size=""1""> Nombre de lignes a afficher </font> ")
    If Session("candidat_UserType") = "Administrator" Then
        pr ("        <INPUT TYPE=""hidden"" NAME =""NbLiges"" value=""" & GetDefault("con_PageNum", "15", Session("candidat_ADOContact")) & """>")

'   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""NBLignesRecherche"" VALUE=" & GetDefault("NBLignesRecherche", "25", Session("candidat_ADOContact")) & "></TD>       ")
   Else
    pr ("        <INPUT TYPE=""hidden"" NAME =""NbLiges"" value=""" & GetDefault("NBLignesRecherche", "25", Session("candidat_ADOContact")) & """>")
    End If
    pr ("       </td>")
    pr ("       <td align=""right"" class=""smallerheader"" valign=""middle""></td>")
    pr ("       <td align=""right"" class=""smallerheader"" valign=""middle"">")
    pr ("        <input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""mySubmit('Annuler');"">") ' onClick=""javNewContact()"">")
    pr ("        <input type=""button""  class=""cmdflat""   value=""Chercher"" onClick=""mySubmit('EXE');"">")
    pr ("       </td>")
    pr ("      </tr>")
    pr ("     </table>")
    pr ("    </td>")
    pr ("   </tr>")
    pr ("  </table>")
    pr "     <table  width=""100%"" >"
        pr "     <TR width=><td></td></tr>"
    pr "     <TR >"
      pr "     <table bgcolor='#B7B8DE' width=""70%"" align=""center"">"
'    pr ("  <table bgcolor=""" & GetDefault("bglst", "#CFCEDB", Session("candidat_ADOContact")) & """ width=""100%"">")
'        pr "<font color='#FFFFFF' size='1' >"

    pr "    <TR>"
    pr "     <TD  >"
    pr "      <font  color='#FFFFFF' size='1' >    TRIER  A -> Z  </font>  "
    pr "     </TD>"
    pr "     <TD  >"
    pr "      <font  color='#FFFFFF' size='1' >    TRIER  Z -> A    </font>  "
    pr "     </TD>"
    pr "     <TD  >"
    pr "      <font  color='#FFFFFF' size='1' >    NOM DES CHAMPS   </font>  "
    pr "     </TD>"
    pr "     <TD>"
    pr "      <font  color='#FFFFFF' size='1' >  OPERATEUR  </font> "
    pr "     </TD>"
    pr "     <TD>"
    pr "      <font  color='#FFFFFF' size='1' >  VALEUR  </font> "
    pr "     </TD>"
    pr "     <TD>"
    pr "      <font  color='#FFFFFF' size='1' > OPERATEUR LOGIQUE</font>"
    pr "     </TD>"
    pr "   </TR>"
    
      If nbLignes > 0 Then
            For I = 1 To nbLignes - 1
               
               
                
                pr "   <TR ID=SUITE" & CStr(I) & " NAME=""SUITE" & CStr(I) & """ >"
                
                SelecetList = ""
                SelecetList = "" & Request("radiobutton")
                If SelecetList = CStr(I) Then
                 pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & """ Checked></TD>"
                Else
                 pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & """></TD>"
                End If
                
               
                
                If SelecetList = CStr(I) & "DESC" Then
                 pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & "DESC"" Checked></TD>"
                Else
                 pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & "DESC""></TD>"
                End If
                
                pr "    <TD>"
                                                                                                
                pr "     <font class=""smallerheader"">   <SELECT NAME=""CHAMP" & CStr(I) & """ onChange=""MyChangeFilde('CloseWhere','VALEUR" & CStr(I) & "');"">"
                If Request("CHAMP" & CStr(I)).Count > 0 Then
                    txt = Request("CHAMP" & CStr(I))
                Else
                    txt = ""
                End If
               
                SelecetList = ""
                For IndexTab = 0 To UBound(TableauSherch)
                    aContenu = Split(TableauSherch(IndexTab), ";")
                    If txt = aContenu(0) Then
                     If InStr(1, UCase(aContenu(2)), "CBO") <> 0 Then SelecetList = aContenu(0)
'                       If "" & Session("saveSelecetList") = "" Then Session("saveSelecetList") = SelecetList
                        pr "<OPTION VALUE=" & aContenu(0) & " selected>" & aContenu(1) & ""
                    Else
                        pr "<OPTION VALUE=" & aContenu(0) & ">" & aContenu(1) & ""
                    End If
                Next IndexTab
                pr "</SELECT></font>"
                pr "         </TD>"
                pr "         <TD>"
                pr " <font class=""smallerheader"">  <SELECT NAME=""OPERATEUR" & CStr(I) & """>"
      
                If Request("OPERATEUR" & CStr(I)).Count > 0 Then
                    slt = Request("OPERATEUR" & I)
                Else
                    slt = ""
                End If
                For j = 0 To UBound(aSlt_OPERATEUR, 2)
                     If Trim(slt) = Trim(aSlt_OPERATEUR(0, j)) Then
                         pr " <option value=""" & aSlt_OPERATEUR(0, j) & """ selected>" & aSlt_OPERATEUR(1, j)
                     Else
                        pr " <option value=""" & aSlt_OPERATEUR(0, j) & """>" & aSlt_OPERATEUR(1, j)
                     End If
                 Next
       pr "</SELECT></font>"
       pr "         </TD>"
       pr "         <TD>"
       If Request("VALEUR" & CStr(I)).Count > 0 Then
            txt = Request("VALEUR" & CStr(I))
        Else
            txt = ""
        End If
        If SelecetList <> "" Then
            pr ListeSherch(GeneralTools.My_Conn, SelecetList, txt, "VALEUR" & CStr(I))
        Else
'        If Session("saveSelecetList") <> "" Then
'            txt = ""
'         End If
       pr "              <font class=""smallerheader"">   <input type=""text"" NAME =""VALEUR" & CStr(I) & """ value=" & txt & "></font>"
       End If
'       Session("saveSelecetList") = SelecetList
       pr "         </TD>"
       pr "         <TD>"
       pr "               <font class=""smallerheader"">  <select name=""Logique" & CStr(I) & """ onChange=""MyChange('CloseWhere',  'Logique" & CStr(I) & "','SaveLogique" & CStr(I) & "'," & CStr(I) & ");"">"
       
       
        If Request("Logique" & CStr(I)).Count > 0 Then
            slt_Logique = Request("Logique" & I)
        Else
            slt_Logique = ""
        End If
       For j = 0 To UBound(aSlt_Logique, 2)
            If Trim(slt_Logique) = Trim(aSlt_Logique(0, j)) Then
                pr " <option value=""" & aSlt_Logique(0, j) & """ selected>" & aSlt_Logique(1, j)
            Else
                pr " <option value=""" & aSlt_Logique(0, j) & """>" & aSlt_Logique(1, j)
            End If
        Next
        
       pr "              </select></font>"
       pr "         </TD>"
       pr "         <TD>"
       
        If Request("SaveLogique" & CStr(I)) > 0 Then
            txt = Request("Logique" & I)
        Else
            txt = ""
        End If
       pr "              <font class=""smallerheader"">   <INPUT TYPE=""hidden"" NAME =""SaveLogique" & CStr(I) & """  VALUE=" & txt & "></font>"
       pr "         </TD>"
       
       pr "    </TR>"
        
       Next I
       End If
       If I = 0 Then I = 1
       
       If (Trim(slt_Logique) <> "(Aucun)") And (Rs.EOF <> Rs.BOF) Then
       
       pr "   <TR ID=SUITE" & CStr(I) & " NAME=""SUITE" & CStr(I) & """ >"
        pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & """></TD>"
        
         pr "<TD><input type=""radio"" name=""radiobutton"" value=""" & CStr(I) & "DESC""></TD>"
       pr "         <TD>"
       txt = ""
        txt = "" & Request("CHAMP" & CStr(I))
        
       pr "              <font class=""smallerheader"">   <SELECT NAME=""CHAMP" & CStr(I) & """ onChange=""MyChangeFilde('CloseWhere','VALEUR" & CStr(I) & "');"">"
        SelecetList = ""
        
        boolSelecetList = False
        ReDim aConten(0)
        aConten(0) = ""
       
        
       For IndexTab = 0 To UBound(TableauSherch)
             aContenu = Split(TableauSherch(IndexTab), ";")
             
             If IndexChamps = IndexTab Then
                pr "<OPTION VALUE=" & aContenu(0) & " selected>" & aContenu(1) & ""
                If boolSelecetList = False Then
                If InStr(1, UCase(aContenu(2)), "CBO") <> 0 Then SelecetList = aContenu(0)
'                If "" & Session("saveSelecetList") = "" Then Session("saveSelecetList2") = SelecetList
             boolSelecetList = True
             End If
             Else
                pr "<OPTION VALUE=" & aContenu(0) & " >" & aContenu(1) & ""
             End If
       Next IndexTab
       pr "</SELECT></font>"
       pr "         </TD>"
       pr "         <TD>"
       pr "               <font class=""smallerheader"">  <SELECT NAME=""OPERATEUR" & CStr(I) & """>"
       
       pr " <option value=""" & aSlt_OPERATEUR(0, 0) & """ selected>" & aSlt_OPERATEUR(1, 0)
        For j = 1 To UBound(aSlt_OPERATEUR, 2)
          If IndexOperateurDefault = j Then
               pr " <option value=""" & aSlt_OPERATEUR(0, j) & """ selected>" & aSlt_OPERATEUR(1, j)
          Else
                pr " <option value=""" & aSlt_OPERATEUR(0, j) & """>" & aSlt_OPERATEUR(1, j)

          End If
          
        Next
       pr "</SELECT></font>"
       pr "         </TD>"
       pr "         <TD>"
      
        If (SelecetList <> "") And (InStr(1, UCase(SelecetList), "LST") <> 0) Then
                    pr ListeSherch(GeneralTools.My_Conn, SelecetList, txt, "VALEUR" & CStr(I))
        Else
'        If Session("saveSelecetList2") <> "" Then
'        txt = ""
'         End If
       pr "              <font class=""smallerheader"">   <input type=""text"" NAME =""VALEUR" & CStr(I) & """ ></font>"
       End If
       Session("saveSelecetList") = SelecetList
       pr "         </TD>"
       pr "         <TD>"
       pr "               <font class=""smallerheader"">  <select name=""Logique" & CStr(I) & """ onChange=""MyChange('CloseWhere',  'Logique" & CStr(I) & "','SaveLogique" & CStr(I) & "'," & CStr(I) & ");""><option VALUE='(Aucun)'>(Aucun)<option value=AND>ET<option value=OR>OU</select></font>"
       pr "         </TD>"
       pr "         <TD>"
       pr "              <font class=""smallerheader"">   <INPUT TYPE=""hidden"" NAME =""SaveLogique" & CStr(I) & """  VALUE=""(Aucun)""></font>"
       pr "         </TD>"
       
       pr "    </TR>"
       End If

       pr ("</table>")
       pr "    <td></td></tr>"
       pr "    <TR >"
       pr "    <td></td>"
       pr "    </tr>"
       pr "    </table>"
       If slt_Logique = "(Aucun)" Then nbLignes = nbLignes - 1
           pr "<input type=""hidden"" name=""nbSelect"" value=""" & nbLignes & """>"
       pr ("</form>")
       pr ("</body>")
       pr ("</html>")
  GeneralTools.My_Conn.Close
 Set GeneralTools.My_Conn = Nothing
  Set Rs = Nothing

End Sub

Public Sub Main()
Dim SaveIdCaddiy
Session("candidat_id_caddy") = Session("candidat_id_caddy")
' Session("Timeout") = 1055
' Server.ScriptTimeout = 15000
''Dim boolInit As Boolean
'If Session("HisoriqueCLI") = "" Then Session("HisoriqueCLI") = "javascript:parent.frames['main'].location='Contact.asp?mode=EspaceClient&NumFrm=1'"
'If Session("FactureCLI") = "" Then Session("FactureCLI") = "javascript:parent.frames['main'].location='Contact.asp?mode=EspaceClient&NumFrm=1&'"
'Application("PortalId") = 1
Debug.Print "Request(""ModeFacture"") : " & Request("ModeFacture")
If Session("candidat_id_pays") = "" Then Session("candidat_id_pays") = 47
'Session("ADMIN") = 1
a = Session("portal_candidat_Recherhe")
a = Session("candidat_UserType")
'If Session("ADMIN") = 1 Then 1 = 1

    '**************************  License ****
    Session("candidat_IsEvaluation") = "False"
    Session("candidat_LicensedTo") = "EUXIA"
    Session("candidat_ProductID") = "CON-09292"
    Session("candidat_DateLicensed") = "10/03/2001"
'    '******************************************Contact.asp?mode=con_lst&Category=All

    Set GeneralTools.My_Conn = OpenDb(DsnTableMenu(Session("candidat_ADOContact")))
    
    MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="

    
    Set RS1 = New ADODB.Recordset
    
    If Len("" & Session("candidat_id_caddy")) = 0 Then
        If Session("candidat_UserType") = "Administrator" Then
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT T_IdCadiFour.IdCaddy FROM T_IdCadiFour;")
            If RS1.EOF = False Then
                Session("candidat_id_caddy") = RS1!IdCaddy + 1
                GeneralTools.My_Conn.Execute "UPDATE T_IdCadiFour SET T_IdCadiFour.IdCaddy = " & Session("candidat_id_caddy") & ";"
            Else
                Session("candidat_id_caddy") = 1
                GeneralTools.My_Conn.Execute "INSERT INTO T_IdCadiFour ( IdCaddy ) SELECT " & Session("candidat_id_caddy") & " AS Expr1;"
            End If
        Else
'          Session("candidat_id_caddy") = Fun_ID_Cadie(NumeroChrono("CAD", "CAD_"), GeneralTools.My_Conn)
'            Set RS1 = GeneralTools.My_Conn.Execute("SELECT T_IdCaddy.IdCaddy FROM T_IdCaddy;")
'            If RS1.EOF = False Then
'                Session("candidat_id_caddy") = RS1!IdCaddy + 1
'                GeneralTools.My_Conn.Execute "UPDATE T_IdCaddy SET T_IdCaddy.IdCaddy = " & Session("candidat_id_caddy") & ";"
'            Else
'                Session("candidat_id_caddy") = 1
'                GeneralTools.My_Conn.Execute "INSERT INTO T_IdCaddy ( IdCaddy ) SELECT " & Session("candidat_id_caddy") & " AS Expr1;"
'            End If
        End If
     End If
   Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
   
If RS1.EOF = False Then
    Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))
 
End If
    If Session("Encelade_CatId") = "" Then
       Set RS1 = GeneralTools.My_Conn.Execute("SELECT Menu.* FROM Menu WHERE PasVisible=false order by Menu.libelle;")
        boolInit = False
    Else
     Set RS1 = GeneralTools.My_Conn.Execute("SELECT Menu.* FROM Menu  WHERE PasVisible=false And Menu.CatId=" & Session("Encelade_CatId") & ";")
        boolInit = True
    End If
      If Session("portal_candidat_Recherhe") = 1 Then
        If val(Session("Save_Encelade_CatId")) <> val(Session("Encelade_CatId")) Then
            Session("Save_Encelade_CatId") = Session("Encelade_CatId")
             Response.Redirect "Contact.asp?mode=SEARCH"
   Exit Sub
        End If
       
     End If
    Session("Save_Encelade_CatId") = Session("Encelade_CatId")
    If RS1.EOF = False Then
        MyConnecSting = MyConnecSting & RS1("Base")
        Session("candidat_ADOContact") = MyConnecSting
         Session("Encelade_CatId") = val(RS1("CatId"))
         Session("Encelade_Message") = " Type de pièce: " & RS1("libelle")
         Session("Types_de_pieces") = "" & RS1("libelle")
      Set Server = Server
'        GeneralTools.My_Conn.Execute "UPDATE Filtre_CatId SET Filtre_CatId.CatId = " & rs1("CatId") & ";"
'Encelade_Menu.mdb
        
       
        
    End If
   
    Set RS1 = Nothing
     GeneralTools.My_Conn.Close
     Set GeneralTools.My_Conn = Nothing
     If boolInit = False Then
   Response.Redirect "Contact.asp?mode=con_lst&Category=All"
   Exit Sub
     End If
    '*******************  Timeout *********
    'If Len(1 ) = 0 Then
    '    Response.Redirect "frmTimeout.asp"
    'End If
    If Len(Session("candidat_MainTable")) = 0 Then
        Session("candidat_MainTable") = GetDefault("ContactTable", "con_Contacts", Session("candidat_ADOContact"))
    End If
   DoEvents
   '
   Session("NewUser") = Session("NewUser")
   Debug.Print Request("NumFrm")
      
    


    Select Case UCase(Trim(Request("mode")))
        Case UCase("VoirPanier")
            pr VoirPanier(DsnTableMenu(Session("candidat_ADOContact")))
    
        Case UCase("con_frmStyle")
            pr con_frmStyle
        Case "CONFIGC_USER_NEW"
                   
                CONFIGC_USER_NEW DsnTableMenu(Session("candidat_ADOContact"))
        Case "CONFIGCLIUSER"
               
            CONFIGUSER
'                IsRecherche mode=con_lst
        Case "HISTORIQUE_EBOUTIQUE_AFFICHE_FACTURE"
                  
               pr HISTORIQUE_EBOUTIQUE_AFFICHE_FACTURE
IsRecherche
        Case "CREERAVENANT"
               
        pr CreerAvenant(OpenDb(DsnTableMenu(Session("candidat_ADOContact"))))
        Case "HISORIQUEETAT"
               
                pr HISORIQUEETAT
        Case "GENERATEURETAT"
              
                pr GENERATEURETAT
        Case "MAILCOMMANDE"
               
                MAILCOMMANDE OpenDb(DsnTableMenu(Session("candidat_ADOContact"))), Request("ID")
    Case UCase("ListeCommandGroupee")
            
            ListeCommandGroupee
    Case UCase("AfficherCommande")
           
        If Request("Afficher") <> "" Then
             pr AfficherCommande(OpenDb(DsnTableMenu(Session("candidat_ADOContact"))), Request("ID"), True)
        Else
            pr AfficherCommande(OpenDb(DsnTableMenu(Session("candidat_ADOContact"))), Request("ID"))
        End If
    Case UCase("AfficheComGroupFour")
           
            AfficheComGroupFour Request("CommandeFournisseurGroupe")
    Case UCase("RaisonSicialEncelade")
            
        RaisonSicialEncelade DsnTableMenu(Session("candidat_ADOContact"))
    Case "VALIDERCOMMANDEFOURNISSEUR"
          
            ValiderCommandeFournisseur DsnTableMenu(Session("candidat_ADOContact"))
    Case UCase("Hisorique_Bl_Visu")
           
            Session("VisuDevis") = "TRUE"
            Affiche_devis "" & Request("RefCommande"), True, Request("Liv")
            Session("VisuDevis") = ""
        
     Case UCase("Hisorique_Bl")
            Session("VisuDevis") = "TRUE"
            Affiche_devis "" & Request("RefCommande"), True
            Session("VisuDevis") = ""
    Case UCase("HISTORIQUE_Eboutique_Affiche_Commande")
           
            Session("VisuDevis") = "TRUE"
            Affiche_devis "" & Request("RefCommande"), VisuBl:=True
            Session("VisuDevis") = ""
    Case "HISTORIQUE_EBOUTIQUE_COMMANDE"
            
         If Request("ModeFacture") = "" Then
            HISTORIQUE_EBOUTIQUE_COMMANDE Request("ID"), DsnTableMenu(Session("candidat_ADOContact"))
        Else
             HISTORIQUE_EBOUTIQUE_FACTURE Request("ID"), DsnTableMenu(Session("candidat_ADOContact"))
        End If
    Case UCase("HISTORIQUE_Compte")
            
            Session("ESPACECLIENT") = "ESPACECLIENT"
            HISTORIQUE_Compte DsnTableMenu(Session("candidat_ADOContact"))
        Case UCase("HISTORIQUE_Compte_Detail")
               
                HISTORIQUE_Avenant val("" & Request("ID")), DsnTableMenu(Session("candidat_ADOContact"))
        Case UCase("Historiques")
                IsRecherche False
                HISTORIQUE_MENU
'            pr ("<center><br><br><font size=""10"" color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """>Page en construction !<b></b></font></center>")
            Case "CONFIGCLICOMPTE"
                    
                    CONFIGCLICOMPTE DsnTableMenu(Session("candidat_ADOContact"))
            Case UCase("CONFIGCLI_New")
                    
                    CONFIGCLI_New DsnTableMenu(Session("candidat_ADOContact"))
            Case "CONFIGCLI"
              
                    CONFIGCLI
            Case "ESPACECLIENT"
                    
'            pr ("<center><br><br><font size=""10"" color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """>Page en construction !<b></b></font></center>")
                Session("ESPACECLIENT") = "ESPACECLIENT"
                EspaceCliantUseur DsnTableMenu(Session("candidat_ADOContact"))
            
            Case UCase("Ecom_Numcomade")
              
                    Call Ecom_Numcomade(DsnTableMenu(Session("candidat_ADOContact")), Request("Id_Caddie"))
            Case UCase("Ecom_NumcomadeValider")
                    
                    Call Ecom_NumcomadeValider(DsnTableMenu(Session("candidat_ADOContact")), Request("id_Caddie"))
                     
            Case "CON_LST"
                    
                    Session("ESPACECLIENT") = ""
                        Call con_lst
            Case "CON_SUBCONTACT"
                        
                        Call con_subContact
            Case "CON_SUBCAT"
                        IsRecherche False
                        Call con_subCat
            Case "CON_FRMCANDIDAT"
                   
                        Call con_frmCandidat
            Case "LSTCATEGORY"
                   
                        Call lstCategory
            Case "SUBCATEGORY"
                   
                        Call SubCategory
            Case "MODUSER"
                  
                        Call modUser
            Case "FORGOTPASS"
                      
                        Call forgotpass
            Case "EDITOR"
                       
                        Call HtmlEditor
            Case "SEARCH"
                        
                        Call modSEARCH
            Case "CON_FRMSETTING"
                    
                    pr con_frmSetting
            Case "CON_FRMSETTINGMODUSER"
                pr modUser1
            Case "CON_FRMFIELD"
                  
                pr con_frmField
            Case "CON_FRMSETFIELD"
                   
                pr con_frmSetField
            Case "CANDIDAT_CADDY"
                    
          
             
                Call CANDIDAT_CADDY(Request("Id_Caddie_0"))
                
            Case "CANDIDAT_CADDYREMPLI"
                   If Trim("" & Session("candidat_caddy_etape")) = "" Then Session("candidat_caddy_etape") = 2
                    Call CANDIDAT_CADDYREMPLI(Request("Id_Caddie_" & (val(Session("candidat_caddy_etape"))) & ""))
            Case "VALIDERCOMMANDE"
                
                    Call CANDIDAT_CADDYREMPLI(Request("Id_Caddie_" & (val(Session("candidat_caddy_etape"))) & ""))
            Case "CONFIG"
                 
                   pr Config
   End Select
 Session("candidat_num_id_caddy") = Session("Id_Caddie_CadiDefault")
            Session("candidat_id_caddy") = Session("Id_Caddie_CadiDefault")
            Session("candidat_id_caddy") = Session("Id_Caddie_CadiDefault")
'      IsRecherche

'GeneralTools.My_Conn.Close
'Set GeneralTools.My_Conn = Nothing
DoEvents
End Sub
Function HISTORIQUE_EBOUTIQUE_AFFICHE_FACTURE()
Dim Sql As String
Dim Rs As Recordset
Set Conn = OpenDb(DsnTableMenu(Session("candidat_ADOContact")))
Sql = "SELECT T_Facturation_Cli.Id_Avoire From T_Facturation_Cli "
Sql = Sql & "WHERE T_Facturation_Cli.NumFacture='" & Request("RefFacture") & "';"
Set Rs = Conn.Execute(Sql)
HISTORIQUE_EBOUTIQUE_AFFICHE_FACTURE = CrerFacture("" & Rs!Id_Avoire, Request("RefFacture"), Conn)
Rs.Close
Set Rs = Nothing
Conn.Close
Set Conn = Nothing
End Function
Function CreerAvenant(Conn)
Dim Sql As String
Dim Rs As Recordset
Dim Facture
Dim RsAvenant As Recordset
Dim idCommande As Long
Sql = "SELECT T_Avoire.IdAvoire, T_Avoire.AnCoursFacturation, T_Avoire.Facturer,  "
Sql = Sql & "T_Avoire.Cloturer, T_Commande_Liv.NumLiv "
Sql = Sql & "FROM (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & "  "
Sql = Sql & "AND (T_Avoire.AnCoursFacturation=True  "
Sql = Sql & "OR  T_Avoire.Facturer=True  "
Sql = Sql & "AND T_Avoire.Cloturer=True  "
Sql = Sql & "AND T_Commande_Liv.NumLiv Is Null);"

Set RsDeja = Conn.Execute(Sql)
If RsDeja.EOF = False Then
    RsDeja.Close
    Set RsDeja = Nothing
'                     Contact.asp?mode=HISTORIQUE_Compte&Id=5&ModeFacture=
    Response.Redirect "Contact.asp?mode=HISTORIQUE_Compte&Id=" & Request("id") & "&ModeFacture= "
    Exit Function
Else
    RsDeja.Close
    Set RsDeja = Nothing
End If
Facture = NumeroChrono("Fac", "Fac_")
Sql = "INSERT INTO T_Facturation_Cli ( NumFacture, NumCammande, RestePayer, Id_Avoire, Frais ) "
Sql = Sql & "SELECT DISTINCT '" & Facture & "' AS NumFacture, t_Devis.numDevis,  "
Sql = Sql & "Sum((([qte_produit]*[PrixU_produit]*(1/100)*[t_Devis].[TVA])+[qte_produit]*[PrixU_produit])) AS Valeurs,  "
Sql = Sql & "T_Avoire.IdAvoire, ([Frais]*(1/100)*[T_Frais_Transport].[TVA])+[Frais] AS Expr1 "
Sql = Sql & "FROM T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
Sql = Sql & "T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire = t_Devis.Id_Avoire "
Sql = Sql & "GROUP BY t_Devis.numDevis, T_Avoire.IdAvoire, ([Frais]*(1/100)*[T_Frais_Transport].[TVA])+[Frais] "
Sql = Sql & "HAVING T_Avoire.IdAvoire=" & Request("id") & " ;"
Conn.Execute Sql
Sql = "UPDATE T_Facturation_Cli SET T_Facturation_Cli.RestePayer = [RestePayer]+[Frais], T_Facturation_Cli.Frais = 0 "
Sql = Sql & "WHERE T_Facturation_Cli.NumFacture='" & Facture & "';"
CreerAvenant = CrerFacture(Request("id"), Facture, Conn)

Sql = "SELECT T_Avoire.IdNumCommande From T_Avoire WHERE T_Avoire.IdAvoire=" & Request("id") & ";"
 Set RsAvenant = Conn.Execute(Sql)
 idCommande = RsAvenant!IdNumCommande
 Sql = "UPDATE T_Avoire SET T_Avoire.Cloturer = True, T_Avoire.AnCoursFacturation = True "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & ";"
Conn.Execute Sql
Sql = "SELECT Count([NumAvoire]) AS Compte From T_Avoire "
Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & idCommande & ";"
 Set RsAvenant = Conn.Execute(Sql)
 numAvenant = RsAvenant!compte
 
 Sql = "SELECT T_Avoire.IdNumCommande, T_Avoire.NumAvoire, T_Avoire.Cloturer From T_Avoire "
Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & idCommande & " "
Sql = Sql & "AND T_Avoire.NumAvoire=" & numAvenant - 1 & ";"

 Set RsAvenant = Conn.Execute(Sql)
 If RsAvenant.EOF = True Then
    Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Credit ) "
    Sql = Sql & "values ( " & idCommande & ", " & numAvenant & ", 0 ); "
    Conn.Execute Sql

Else
    If RsAvenant!Cloturer = True Then
        Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Credit ) "
        Sql = Sql & "values ( " & idCommande & ", " & numAvenant & ", 0 ); "
        Conn.Execute Sql

    End If
End If
            
Sql = "SELECT DISTINCT [Credit]-[Debit] AS Solde From T_Avoire "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & " ;"

  Set RsAvenant = Conn.Execute(Sql)
  If RsAvenant!Solde > 0 Then
    Sql = "UPDATE T_Avoire SET T_Avoire.Credit = " & Replace("" & RsAvenant!Solde, ",", ".") & "  "
    Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & idCommande & " "
    Sql = Sql & "AND T_Avoire.NumAvoire=" & numAvenant & ";"
    Conn.Execute Sql

    Sql = "UPDATE T_Avoire SET T_Avoire.Debit = [Credit] "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & " ;"
    Conn.Execute Sql
    Sql = "SELECT T_Avoire.IdAvoire, T_Avoire.Cloturer, T_Avoire.Facturer, T_Avoire.AnCoursFacturation "
    Sql = Sql & "From T_Avoire "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=9 "
    Sql = Sql & "AND T_Avoire.Cloturer=True "
    Sql = Sql & "AND T_Avoire.Facturer=True "
    Sql = Sql & "AND T_Avoire.AnCoursFacturation=True;"
    Set RsAvenant = Conn.Execute(Sql)
    If RsAvenant.EOF = False Then
        Sql = "UPDATE T_Avoire SET T_Avoire.AnCoursFacturation = False, T_Avoire.FacturerOk = True "
        Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & " ;"
        Conn.Execute Sql
    End If
    RsAvenant.Close
    Set RsAvenant = Nothing
    
    Sql = "SELECT T_Avoire.FacturerOk, T_Avoire.Cloturer, T_Avoire.Facturer, T_Avoire.AnCoursFacturation "
    Sql = Sql & "From T_Avoire "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & "  "
    Sql = Sql & "AND T_Avoire.Cloturer=True "
    Sql = Sql & "AND T_Avoire.Facturer=True "
    Sql = Sql & "AND T_Avoire.AnCoursFacturation=True;"
    Set RsAvenant = Conn.Execute(Sql)
    If RsAvenant.EOF = False Then
        Sql = "UPDATE T_Avoire SET T_Avoire.FacturerOk = True, T_Avoire.AnCoursFacturation = False  "
        Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & ";  "
        Conn.Execute Sql
    End If

  End If
            
End Function
Sub TrillerDateTableau(tableau)
Dim a(2) As String
Dim Z(2) As String
For I = 1 To UBound(tableau) - 1
    If tableau(I, 1) > tableau(I + 1, 1) Then
        a(0) = tableau(I + 1, 0)
        a(1) = tableau(I + 1, 1)
        a(2) = tableau(I + 1, 2)
        
        Z(0) = tableau(I, 0)
        Z(1) = tableau(I, 1)
        Z(2) = tableau(I, 2)
        
        tableau(I, 0) = a(0)
        tableau(I, 1) = a(1)
        tableau(I, 2) = a(2)
        
        tableau(I + 1, 0) = Z(0)
        tableau(I + 1, 1) = Z(1)
        tableau(I + 1, 2) = Z(2)
        I = I - 2
    End If

Next
For I = 1 To UBound(tableau)
    
Debug.Print tableau(I, 1)
Next
End Sub
Function HISORIQUEETAT()
Dim RepDoc As String
Dim FS
Dim TableauFichier() As String
Set FS = Server.CreateObject("Scripting.FileSystemObject")
RepRacineDoc = GetDefault("PathDOC", "Portal_DOC/Catalogue/", DsnTableMenu(Session("candidat_ADOContact")))
RepDoc = GetDefault("RepDoc", "CSV/", DsnTableMenu(Session("candidat_ADOContact")))
If Left(RepRacineDoc, 1) = "/" Then RepRacineDoc = Right(RepRacineDoc, Len(RepRacineDoc) - 1)
If Right(RepRacineDoc, 1) = "/" Then RepRacineDoc = Left(RepRacineDoc, Len(RepRacineDoc) - 1)

If Left(RepDoc, 1) = "/" Then RepDoc = Right(RepDoc, Len(RepDoc) - 1)
If Right(RepDoc, 1) = "/" Then RepDoc = Left(RepDoc, Len(RepDoc) - 1)
RepRacineDoc = "../" & RepRacineDoc & "/" & RepDoc & "/"
RepDoc = CreatRep
For I = Request("LsupStat") To 1 Step -1
If Trim("" & Request("Sup_" & I)) <> "" Then

    FS.DeleteFile RepDoc & Request("File_" & I)
End If
Next
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<title>ETAT HSTIRIQUE</title>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & ""
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"

HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> <tr>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td background=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<tr><td background=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgh2.gif"">"

HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">Historique des Etats de statistiques.</font>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</b></font>"

HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr><tr>"

HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td background=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td bgcolor=""#EBE3D7"">"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<table border=""0"" width=""100%"">"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<tr>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td><a href='javascript:this.document.FRM.submit();'><img align=""right"" src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "icon_delete_reply.gif"" width=""22"" height=""22"" border =""0""></a></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<table border=""0"" width=""100%"">"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<tr>"


HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Nom du Fichier")) & "</td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Date de cr&eacute;ation")) & "</td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Taille du dossier (en Octets)")) & "</td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Supprimer")) & "</td>"


HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr>"
 Set f = FS.GetFolder(RepDoc)
    Set fc = f.Files
ReDim TableauFichier(fc.Count, 2)
I = 0
    For Each f1 In fc
    I = I + 1
       TableauFichier(I, 0) = f1.Name
       TableauFichier(I, 1) = Format(f1.DateCreated, "yyyy-mm-dd hh:mm:ss")
       TableauFichier(I, 2) = f1.Size

    Next
    TrillerDateTableau TableauFichier
    HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<form name=""FRM"" action=""Contact.asp"" method=""post"">"
    HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<INPUT TYPE=""HIDDEN"" NAME=""mode"" VALUE=""HisoriqueEtat"">   "
    For I = UBound(TableauFichier) To 1 Step -1
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "   "
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td><INPUT TYPE='HIDDEN' NAME='File_" & I & "' VALUE='" & TableauFichier(I, 0) & "'><a target='blank' href='" & RepRacineDoc & TableauFichier(I, 0) & "'>" & TableauFichier(I, 0) & "</a></td>"
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td ><a target=""blank"" href='" & RepRacineDoc & TableauFichier(I, 0) & "'>" & Format(TableauFichier(I, 1), "dd/mm/yyyy hh:mm:ss") & "</a></td>"
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td ><a target=""blank"" href='" & RepRacineDoc & TableauFichier(I, 0) & "'>" & TableauFichier(I, 2) & "</a></td>"
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td><input type='checkbox' name='Sup_" & I & "' value='OUI'></td>"
        HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr>"
    Next
    HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<INPUT TYPE=""HIDDEN"" NAME=""LsupStat"" VALUE=""" & UBound(TableauFichier) & """>   "
    HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</form >"
Set f = Nothing
Set Fso = Nothing
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</table>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</td><td background=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td background=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</tr></table>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</body>"
HISORIQUEETAT = HISORIQUEETAT & vbCrLf & "</html>"
End Function
Function CreatRep()
Dim Fso
Dim RepRacineDoc As String
Dim RepDoc As String
Dim PatServer As String
RepRacineDoc = GetDefault("PathDOC", "Portal_DOC/Catalogue/", DsnTableMenu(Session("candidat_ADOContact")))
RepDoc = GetDefault("RepDoc", "CSV/", DsnTableMenu(Session("candidat_ADOContact")))
Set Fso = Server.CreateObject("Scripting.FileSystemObject")
PatServer = Server.MapPath(Session("PortalPath"))
PatServer = PatServer & "\" & RepRacineDoc
PatServer = Replace(PatServer, "/", "\")
If Left(RepDoc, 1) = "\" Then RepDoc = Right(RepDoc, Len(RepDoc) - 1)
If Left(RepDoc, 1) = "/" Then RepDoc = Right(RepDoc, Len(RepDoc) - 1)

aa = Split(RepDoc & "/", "/")
If Right(PatServer, 1) = "\" Then PatServer = Left(PatServer, Len(PatServer) - 1)
CreatRep = PatServer
For I = 0 To UBound(aa) - 1
CreatRep = CreatRep & "\" & aa(I)
    If Fso.FolderExists(CreatRep) = False Then
        Fso.CreateFolder CreatRep
    End If
    
Next
Set Fso = Nothing
End Function
Function GENERATEURETAT()
Dim Sql As String
Dim TypeDsortie As Integer
Dim MsgTypeDsortie As String
Dim RsEtat As Recordset
Set Conn = OpenDb(DsnTableMenu(Session("candidat_ADOContact")))
If Request("AC") = "Exe" Then
    Sql = "SELECT T_Etat_Macros.* From T_Etat_Macros "
     Sql = Sql & "Where T_Etat_Macros.Id_Etat_Tire = " & Request("Id") & " "
    Sql = Sql & "ORDER BY T_Etat_Macros.Id;"
    Set RsEtat = Conn.Execute(Sql)
    While RsEtat.EOF = False
        GenaireCsv Conn, RsEtat, CInt(Request("TypeDsortie"))
        RsEtat.MoveNext
    Wend
    Response.Redirect "Contact.asp?mode=HisoriqueEtat"
End If

Sql = "SELECT T_Etats_Titre.* From T_Etats_Titre "
Sql = Sql & "WHERE T_Etats_Titre.Id=" & Request("Id") & ";"
Set Rs = Conn.Execute(Sql)
If Rs!SurDateDuJour = True Then
    TypeDsortie = 1
    MsgTypeDsortie = "Sur la date de ce jour : " & Format(Date, "dddd dd mmmm yyyy")
End If
If Rs!SurEntrerDate = True Then
    TypeDsortie = 2
    MsgTypeDsortie = "Sur la saisie d´une date. "
End If
If Rs!SurEntrerPeriode = True Then
    TypeDsortie = 3
    MsgTypeDsortie = "Sur la saisie d´une p&eacute;riode."
End If
If Rs!PasDeDate = True Then
    TypeDsortie = 4
    MsgTypeDsortie = "Pas de gestion de date."
End If



Etat = Rs!MenuName


GENERATEURETAT = GENERATEURETAT & vbCrLf & "<title>Commande N° " & commande & "</title>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<script language='javascript' src='../Portal_Java/FunJava.js'></script>"

GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> <tr>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td background=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<tr><td background=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgh2.gif"">"
 GENERATEURETAT = GENERATEURETAT & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">Etat : " & Etat & "</font></b></font>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</tr><tr>"

GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td background=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td bgcolor=""#EBE3D7"">"


GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bandeg.gif"" border=""0""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""ecomtitrecaddie2"" >" & MsgTypeDsortie & "</td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "banded.gif"" border=""0""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</table>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<form name=""FRM"" action=""Contact.asp""  method=""post""> "
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<INPUT TYPE=""HIDDEN"" NAME=""mode"" VALUE=""GENERATEURETAT"">       "
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<INPUT TYPE=""HIDDEN"" NAME=""Id"" VALUE=""" & Request("Id") & """>   "
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<INPUT TYPE=""HIDDEN"" NAME=""AC"" VALUE=""Exe"">   "
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<INPUT TYPE='HIDDEN' NAME='TypeDsortie' VALUE='" & TypeDsortie & "'>   "
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"

Select Case TypeDsortie
Case 2
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Saisissez la date")) & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("<input type='text'>")) & "</td>"


Case 3
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " <SCRIPT LANGUAGE=""JAVASCRIPT"">"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " function Valider()"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " {"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " var DateDeb;"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " var DateFin;"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " var ErrMsg='';"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "DateDeb = document.forms['FRM'].elements['DateDeb'];"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "DateFin = document.forms['FRM'].elements['DateFin'];"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " if (DateDeb.value=='') ErrMsg='" & GetMessage("DebPeriode", "Vous devez saisir la date de début de période.", DsnTableMenu(Session("candidat_ADOContact"))) & "';"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " if (DateFin.value=='') ErrMsg=ErrMsg +'\nVous " & GetMessage("FinPeriode", "Vous devez saisir la date de fin de période.", DsnTableMenu(Session("candidat_ADOContact"))) & "';"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " if (ErrMsg!=='') {"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " alert(ErrMsg);"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " return;"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "}"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " document.forms['FRM'].submit();"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " }"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " </SCRIPT>"

    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Saisissez la date de d&eacute;but de p&eacute;riode")) & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Saisissez la date de fin de p&eacute;riode")) & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("<input type=""text"" size=""100%"" name='DateDeb' value="""" onchange=""SaisieDate('FRM','DateDeb');""> ")) & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("<input type=""text""  size=""100%"" name='DateFin' value="""" onchange=""SaisieDate('FRM','DateFin');""> ")) & "</td>"


Case 4
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " <SCRIPT LANGUAGE=""JAVASCRIPT"">"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " function Valider()"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " {"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " document.forms['FRM'].submit();"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " }"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " </SCRIPT>"
End Select

GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr></table>"


GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bandeg.gif"" border=""0""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""ecomtitrecaddie2"" >R&eacute;capitulatif des Macros associ&eacute;es.</td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
GENERATEURETAT = GENERATEURETAT & vbCrLf & "banded.gif"" border=""0""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</table>"

GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"

GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Nom de la Macro:")) & "</td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Pr&eacute;fixe")) & "</td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Requête")) & "</td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Base de donn&eacute; externe")) & "</td>"

GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
    
Sql = "SELECT T_Etat_Macros.* From T_Etat_Macros "
Sql = Sql & "Where T_Etat_Macros.Id_Etat_Tire=" & Request("Id") & " "
Sql = Sql & "ORDER BY T_Etat_Macros.Id;"
Set Rs = Conn.Execute(Sql)
    PasAficheExe = True
   
While Rs.EOF = False
PasAficheExe = False
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "          <td align=""center"" >" & Rs![Macro Name] & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "          <td align=""center"" >" & Rs![Prefixe] & "</td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "          <td align=""center"" width=""50%"">" & Rs![Sql] & "</td>"
   GENERATEURETAT = GENERATEURETAT & vbCrLf & "          <td align=""center"" >" & Rs![Base Externe] & "</td>"

    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
   
        Rs.MoveNext
Wend
    

GENERATEURETAT = GENERATEURETAT & vbCrLf & " </table>"
If PasAficheExe = False Then
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "   <td align=""center"" ><a href=""javascript:Valider();""><img  src=""" & Session("contact_devis")
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "Xls.bmp"" width=""20"" height=""20"" border=""0"" id=""Doc""></a></td>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "    </tr>"
    GENERATEURETAT = GENERATEURETAT & vbCrLf & " </table>"
End If
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</form>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</td><td background=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td background=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
GENERATEURETAT = GENERATEURETAT & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
    
    GENERATEURETAT = GENERATEURETAT & vbCrLf & "</tr></table>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</body>"
GENERATEURETAT = GENERATEURETAT & vbCrLf & "</html>"

Conn.Close
Set Conn = Nothing
End Function
Sub GenaireCsv(Conn, Rs As Recordset, TypeTraitement As Integer)
Dim Sql As String
Dim SqlBase As String
Dim DateDeb As Date
Dim DateFin As Date
Dim RsBase As Recordset
Dim txtFichier As String
Dim C As Long
Dim FileNumber
Dim FileName As String
Dim RepDoc As String
RepDoc = CreatRep


Sql = "" & Rs!Sql
Select Case TypeTraitement
        Case 1
        Case 2
        Case 3
            DateDeb = CDate(Format(Request("DateDeb"), "dd/mm/yyyy"))
            DateFin = CDate(Format(Request("DateFin"), "dd/mm/yyyy"))
            DateDeb = DateDeb
            DateFin = DateFin
            Sql = Replace(Sql, "[Datedeb]", Format(DateDeb, "yyyy-mm-dd hh:mm:ss"))
            Sql = Replace(Sql, "[DateFin]", Format(DateFin, "yyyy-mm-dd hh:mm:ss"))
        
End Select
Debug.Print Sql

If Trim("" & Rs("Base Externe")) <> "" Then
    SqlBase = "SELECT Menu.Base  From Menu "
    SqlBase = SqlBase & "WHERE Menu.libelle='" & Replace(Replace(Rs("Base Externe"), "'", "''"), Chr(34), Chr(34) & Chr(34)) & "'"
    Set RsBase = Conn.Execute(SqlBase)
    If RsBase.EOF = True Then GoTo Fin
    Sql = Replace(Sql, "[bdExterne]", "" & RsBase!Base)
    Debug.Print Sql
End If

    Set RsBase = Conn.Execute(Sql)
    txtFichier = ""
    For C = 0 To RsBase.Fields.Count - 1
        txtFichier = txtFichier & RsBase.Fields(C).Name & ";"
        Debug.Print txtFichier
    Next
    txtFichier = Left(txtFichier, Len(txtFichier) - 1)
    If RsBase.EOF = False Then
    Const sDelimiteur$ = vbTab
    
    Dim toto
    toto = RsBase.GetString(, , ";", "¤")
    
'    toto = Replace(toto, vbCrLf, " ")
'    toto = Replace(toto, Chr(13), "")
'    toto = Replace(toto, Chr(10), "")
'    toto = Replace(toto, "\", "")
'    toto = Replace(toto, "¤", vbCrLf)
'    Spreadsheet1.ActiveSheet.Protection.Enabled = False
'    Spreadsheet1.ActiveSheet.Range("A2").ParseText _
'    toto, sDelimiteur$

End If
'    While RsBase.EOF = False
toto = Replace(toto, Chr(13), "")
toto = Replace(toto, Chr(10), " ")
toto = Replace(toto, "¤", vbCrLf)
        txtFichier = txtFichier & vbCrLf & toto
'        For C = 0 To RsBase.Fields.Count - 1
'            txtFichier = txtFichier & Replace(Replace("" & RsBase.Fields(C), Chr(10), ""), Chr(13), "") & ";"
'            Debug.Print txtFichier
'        Next
'        RsBase.MoveNext
'    Wend
  FileName = NumeroChrono("" & Rs!Prefixe, "" & Rs!Prefixe)
  FileName = RepDoc & FileName & ".CSV"
    FileNumber = FreeFile    ' Lit le numéro de fichier inutilisé.
' Crée le nom du fichier.
    Open FileName For Output As #FileNumber
    Print #FileNumber, txtFichier    ' Écrit le texte.
    Close #FileNumber    ' Ferme le fichier.


Fin:
RsBase.Close
Set RsBase = Nothing
End Sub
Function MAILCOMMANDE(Conn, numDevis, Optional Afficher As Boolean)
Dim MailTXT As String
Dim Rs As Recordset
Dim Sql As String
Dim MyErr As String
MyErr = " T_Devis_Four_Raison_Social.EnvoyeMail = Now() "
Sql = "SELECT [Nom] & ' ' & [pNom] AS Expr1, T_Devis_Four_Raison_Social.Contact, T_Devis_Four_Raison_Social.Mail "
Sql = Sql & "FROM T_Devis_Four_Societe INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Four_Societe.Id_Com_Four =  "
Sql = Sql & "T_Devis_Four_Raison_Social.Id_Com_Four "
Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"
Set Rs = Conn.Execute(Sql)
If (Trim("" & Rs!Mail) <> "") Or (Request("ValideBr") <> "") Then
Session("MSGCommande") = "PaAffiche"
 MailTXT = AfficherCommande(Conn, numDevis)
 On Error GoTo MailError
 If Request("NumerBr") <> "" Then
    If SendEmail2(GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))), "" & Rs!Mail, GetDefault("ObjetComFourBR", "Veuillez trouvez ci jointe notre Bordereau de réception.", DsnTableMenu(Session("candidat_ADOContact"))), MailTXT, True) = False Then GoTo MailError
 Else
    If Trim("" & Request("ValideBr")) = "" Then
        If SendEmail2(GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))), "" & Rs!Mail, GetDefault("ObjetComFour", "Veuillez trouvez ci jointe notre commande. En cas de problème merci de nous le signaler au plus vite.", DsnTableMenu(Session("candidat_ADOContact"))), MailTXT, True) = False Then GoTo MailError
    End If
 End If
    If Trim("" & Request("ValideBr")) = "" Then
        Session("MSGCommande") = "Mail Envoy&eacute; le " & Format(Date, "dddd dd mmmm yyyy") & "<br>&agrave; " & Time
    Else
        Session("MSGCommande") = "BR Enregistr&eacute; le " & Format(Date, "dddd dd mmmm yyyy") & "<br>&agrave; " & Time
    End If
Reprise:
On Error GoTo 0

If Request("NumerBr") <> "" Then
    Sql = "UPDATE T_BR SET  T_BR.BrMailDate = Now() WHERE T_BR.NumBr='" & Request("NumerBr") & "';"
 
Else
    Sql = "UPDATE  T_Devis_Four_Raison_Social set " & MyErr & "  "
    Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"

End If
Conn.Execute Sql
pr ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
    pr "window.opener.location ='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "';"
    pr ("</SCRIPT>")
Set Rs = Nothing
pr AfficherCommande(Conn, numDevis)
Session("MSGCommande") = ""
 
Else
    Set Rs = Nothing
        If Trim("" & Request("ValideBr")) = "" And Trim("" & Request("NumerBr")) = "" Then
            Session("MSGCommande") = "Adresse Email incorrecte"
            Sql = "UPDATE  T_Devis_Four_Raison_Social SET T_Devis_Four_Raison_Social.CommandeValider = False, T_Devis_Four_Raison_Social.EnvoyeMail = Null "
            Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"
            If Trim("" & Request("ValideBr")) = "" Then
                Conn.Execute Sql
             End If
        Else
            
            Session("MSGCommande") = "BR Enregistr&eacute; le " & Format(Date, "dddd dd mmmm yyyy") & "<br>&agrave; " & Time
        End If
       If Trim("" & Request("ValideBr")) <> "" Then
            pr ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
            pr "window.opener.location ='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&NumerBr=" & Request("NumerBr") & "';"
            pr ("</SCRIPT>")
            
            pr AfficherCommande(Conn, numDevis)
            Session("MSGCommande") = ""
        Else
             pr ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
             pr "window.opener.location ='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&NumerBr=" & Request("NumerBr") & "';"
             pr "window.close();"
             pr ("</SCRIPT>")
        End If
 GoTo Fin
MailError:
 Err.Clear
 If Trim("" & Request("ValideBr")) = "" And Trim("" & Request("NumerBr")) = "" Then
            Session("MSGCommande") = "Adresse Email incorrecte"
            Sql = "UPDATE T_Devis_Four_Raison_Social SET T_Devis_Four_Raison_Social.CommandeValider = False, T_Devis_Four_Raison_Social.EnvoyeMail = Null "
            Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"
            MyErr = " T_Devis_Four_Raison_Social.EnvoyeMail = Null "
                Conn.Execute Sql
             
              pr ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
             pr "window.opener.location ='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&NumerBr=" & Request("NumerBr") & "';"

             pr "window.close();"

             pr ("</SCRIPT>")
End If
 GoTo Reprise
 
End If
Fin:
 Conn.Close
    Set Conn = Nothing

End Function
Function con_frmStyle()
       Response.Expires = 0
          Session("CANDIDAT_CURRENTPAGE") = "con_frmStyle.ASP"
              
          

 
   
          If Request("MODE2") = "EXECUTE" Then
                If Request("USER_ACTION") = "VALEURS PAR DÉFAUT" Then
               
SetDefault "CON_BGCOLOR", safeEntry("#8486B6"), Session("candidat_ADOContact")
SetDefault "COLOR1", safeEntry("#8486B6"), Session("candidat_ADOContact")
SetDefault "COLOR2", safeEntry("#E2E3F2"), Session("candidat_ADOContact")
SetDefault "con_titre", safeEntry("#ffffff"), Session("candidat_ADOContact")
SetDefault "con_H_Linge", safeEntry("2"), Session("candidat_ADOContact")
SetDefault "bglstheadertr", safeEntry("#FFFFFF"), Session("candidat_ADOContact")
SetDefault "bglst", safeEntry("#989AC9"), Session("candidat_ADOContact")
SetDefault "bglsttr", safeEntry("#B7BADC"), Session("candidat_ADOContact")
SetDefault "bglsttrok", safeEntry("#8486B6"), Session("candidat_ADOContact")
SetDefault "bglsttrnook", safeEntry("#DBDEF1"), Session("candidat_ADOContact")
SetDefault "mouseover", safeEntry("#AFB4DC"), Session("candidat_ADOContact")
               
'SetDefault "DEFAULTFIELDSORTBY", "TXT1", session("candidat_ADOContact")
'
'SetDefault "IndexAlpha", "TXT1", session("candidat_ADOContact")
'
'SetDefault "PathImg", "Portal_Image/Catalogue/", session("candidat_ADOContact")
'SetDefault "TABLES", "Listes", session("candidat_ADOContact")
'SetDefault "RefCaddy", "txt1", session("candidat_ADOContact")
'SetDefault "EMAIL", "test@euxia.net", session("candidat_ADOContact")
'SetDefault "EMAILSujetClient", "Vous trouverez ci-joint l'exemplaire de votre demande Commande", session("candidat_ADOContact")
'SetDefault "EMAILSujetFourniseur", "Commande.", session("candidat_ADOContact")
'SetDefault "IMGaddy", "", session("candidat_ADOContact")
 msg = GetMessage("VALEURSPARDEFAUTACTIVEES", "VALEURS PAR DÉFAUT ACTIVÉES", DsnTableMenu(Session("candidat_ADOContact")))
                Else
               
SetDefault "CON_BGCOLOR", safeEntry(Request("CON_BGCOLOR")), Session("candidat_ADOContact")
'SetDefault "COLOR1", safeEntry(Request("COLOR1")), Session("candidat_ADOContact")
'SetDefault "COLOR2", safeEntry(Request("COLOR2")), Session("candidat_ADOContact")
SetDefault "con_titre", safeEntry(Request("con_titre")), Session("candidat_ADOContact")
SetDefault "con_H_Linge", safeEntry(Request("con_H_Linge")), Session("candidat_ADOContact")
SetDefault "bglstheadertr", safeEntry(Request("bglstheadertr")), Session("candidat_ADOContact")
SetDefault "bglst", safeEntry(Request("bglst")), Session("candidat_ADOContact")
SetDefault "bglsttr", safeEntry(Request("bglsttr")), Session("candidat_ADOContact")
SetDefault "bglsttrok", safeEntry(Request("bglsttrok")), Session("candidat_ADOContact")
SetDefault "bglsttrnook", safeEntry(Request("bglsttrnook")), Session("candidat_ADOContact")
SetDefault "mouseover", safeEntry(Request("mouseover")), Session("candidat_ADOContact")
'GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact"))
' my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
' my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))



'GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact"))



'SetDefault "DEFAULTFIELDSORTBY", safeEntry(Request("DEFAULTFIELDSORTBY")), session("candidat_ADOContact")
'SetDefault "IndexAlpha", safeEntry(Request("IndexAlpha")), session("candidat_ADOContact")
'SetDefault "PathImg", safeEntry(Request("PathImg")), session("candidat_ADOContact")
'SetDefault "RefCaddy", safeEntry(Request("RefCaddy")), session("candidat_ADOContact")
'SetDefault "TITREPAGE3", safeEntry(Request("TITREPAGE3")), session("candidat_ADOContact")
'SetDefault "TEXTE_PASSWORD", safeEntry(Request("TEXTE_PASSWORD")), session("candidat_ADOContact")
'SetDefault "EMAIL", safeEntry(Request("EMAIL")), session("candidat_ADOContact")
'SetDefault "EMAILSujetClient", safeEntry(Request("EMAILSujetClient")), session("candidat_ADOContact")
'SetDefault "EMAILSujetFourniseur", safeEntry(Request("EMAILSujetFourniseur")), session("candidat_ADOContact")
'SetDefault "IMGaddy", safeEntry(Request("IMGaddy")), session("candidat_ADOContact")


 msg = GetMessage("ParamMaj", "PARAMÈTRES MIS À JOUR", DsnTableMenu(Session("candidat_ADOContact")))
                 End If
           End If
          

   con_frmStyle = con_frmStyle & vbCrLf & ("<HTML>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<HEAD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TITLE>SETTINGS</TITLE>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</HEAD>       ")

   con_frmStyle = con_frmStyle & vbCrLf & ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
    con_frmStyle = con_frmStyle & vbCrLf & "function init()" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "{" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "bar.create();" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "}" & vbCrLf
    
    con_frmStyle = con_frmStyle & vbCrLf & "function Remplacer(Txt,C,R){"
    con_frmStyle = con_frmStyle & vbCrLf & "var a, tmp;"
    con_frmStyle = con_frmStyle & vbCrLf & "tmp = '';"
    con_frmStyle = con_frmStyle & vbCrLf & "a = ''+Txt;"
    con_frmStyle = con_frmStyle & vbCrLf & "if (a.length==0){"
    con_frmStyle = con_frmStyle & vbCrLf & "a=''"
    con_frmStyle = con_frmStyle & vbCrLf & "return a;"
    con_frmStyle = con_frmStyle & vbCrLf & "}"
    con_frmStyle = con_frmStyle & vbCrLf & ""
     con_frmStyle = con_frmStyle & vbCrLf & "for(var i = 0; i < a.length; i++)"
    con_frmStyle = con_frmStyle & vbCrLf & "{"
    con_frmStyle = con_frmStyle & vbCrLf & ""
     con_frmStyle = con_frmStyle & vbCrLf & " "
    con_frmStyle = con_frmStyle & vbCrLf & "    if (a.charAt(i) ==  C)"
    con_frmStyle = con_frmStyle & vbCrLf & "    {"
    con_frmStyle = con_frmStyle & vbCrLf & "    tmp = tmp + R;"
    con_frmStyle = con_frmStyle & vbCrLf & "    } else{"
     con_frmStyle = con_frmStyle & vbCrLf & "       tmp = tmp + a.charAt(i);"
    con_frmStyle = con_frmStyle & vbCrLf & "    }"
    con_frmStyle = con_frmStyle & vbCrLf & "}"
    con_frmStyle = con_frmStyle & vbCrLf & "  "
    con_frmStyle = con_frmStyle & vbCrLf & "return  tmp;"
    con_frmStyle = con_frmStyle & vbCrLf & ""
    con_frmStyle = con_frmStyle & vbCrLf & "}"
    con_frmStyle = con_frmStyle & vbCrLf
    
'    Police.asp

   con_frmStyle = con_frmStyle & vbCrLf & "function AffichefrmPolice(frm,txt)" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "{" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "window.open('Police.asp?frm=' + frm + '&txt=' + txt + '&VCouleur=' + Remplacer(this.document.forms[frm].elements[txt].value,'#','')  ,'dlgcat','resizable=yes,status=no,top=200,left=300,width=350,height=450')"
'    con_frmStyle = con_frmStyle & vbCrLf & " window.open(""Palette.asp?frm=frm&txt=txt&VCouleur=FFFFCC"",'dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"";" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "}" & vbCrLf
    
   con_frmStyle = con_frmStyle & vbCrLf & "function AffichefrmCouleur(frm,txt)" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "{" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "window.open('Palette.asp?frm=' + frm + '&txt=' + txt + '&VCouleur=' + Remplacer(this.document.forms[frm].elements[txt].value,'#','')  ,'dlgcat','resizable=yes,status=no,top=200,left=600,width=600,height=400')"
'    con_frmStyle = con_frmStyle & vbCrLf & " window.open(""Palette.asp?frm=frm&txt=txt&VCouleur=FFFFCC"",'dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"";" & vbCrLf
    con_frmStyle = con_frmStyle & vbCrLf & "}" & vbCrLf
    
   con_frmStyle = con_frmStyle & vbCrLf & ("</SCRIPT>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<LINK REL=""STYLESHEET"" HREF=""PMAINSTYLE1.ASP"">       ")
'   con_frmStyle = con_frmStyle & vbCrLf & ("<BODY BACKGROUND='BACKGROUND.ASP'>       ")

  
'   con_frmStyle = con_frmStyle & vbCrLf &  GetMenu


     '****** HEADER *****
      con_frmStyle = con_frmStyle & vbCrLf & ("<FORM NAME=""FRM"" ACTION=""Contact.asp?mode=con_frmStyle"" method=""post"">  ")
'  con_frmStyle = con_frmStyle & vbCrLf & GetMenu2
  con_frmStyle = con_frmStyle & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=" & GetDefault("con_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & " CELLPADDING=""0"" CELLSPACING=""0"">       ")

   con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
'       con_frmStyle = con_frmStyle & vbCrLf &  "toto"
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD ALIGN=""LEFT"">       ")

   con_frmStyle = con_frmStyle & vbCrLf & ("<font color='" & GetDefault("con_titre", "#ffffff", Session("candidat_ADOContact")) & "' size='" & GetDefault("con_H_Linge", "2", Session("candidat_ADOContact")) & "' ><b>" & Session("Encelade_Message") & " </b></font>")
'   con_frmStyle = con_frmStyle & vbCrLf & ("</B></FONT>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
  
  
   con_frmStyle = con_frmStyle & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE"" VALUE=""con_frmStyle"">       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD ALIGN=""RIGHT"">       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALIDER"">       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALEURS PAR DÉFAUT"">       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TABLE>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TABLE>       ")

     '******  MESSAGE ******

   con_frmStyle = con_frmStyle & vbCrLf & ("<CENTER><FONT COLOR=""RED""><B>") & msg & "</B></FONT></CENTER>       "



   con_frmStyle = con_frmStyle & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE2"" VALUE=""EXECUTE"">       ")

   con_frmStyle = con_frmStyle & vbCrLf & ("<TABLE BORDER=""0"">       ")

'
   con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DU TITRE : &nbsp;</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""CON_BGCOLOR"" VALUE=" & GetDefault("CON_BGCOLOR", "", Session("candidat_ADOContact")) & ">")
     con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','CON_BGCOLOR');""  border=""0"">"
    con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
    con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
   
   con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DU TIRE : &nbsp;</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""con_titre"" VALUE=" & GetDefault("con_titre", "#ffffff", Session("candidat_ADOContact")) & ">")
     con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','con_titre');""  border=""0"">"
    con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurTxt.jpg' width='22' height='21' align='middle' border=""0""></a>"
    con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")

 con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TAILLE DU TITRE : &nbsp;</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""con_H_Linge"" VALUE=" & GetDefault("con_H_Linge", "2", Session("candidat_ADOContact")) & ">")
     con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmPolice('FRM','con_H_Linge');""  border=""0"">"
    con_frmStyle = con_frmStyle & vbCrLf & "<img src='Police.jpg' width='22' height='21' align='middle' border=""0""></a>"
    con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")

'
'   con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
'   con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE DES LISTES</TD>       ")
'   con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""COLOR1"" VALUE=" & GetDefault("COLOR1", "", Session("candidat_ADOContact")) & ">")
'     con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','COLOR1');""  border=""0"">"
'    con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
'    con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
'   con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
'
'con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
'con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE ALTERNÉE DES LISTES</TD>       ")
'con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""COLOR2"" VALUE=" & GetDefault("COLOR2", "", Session("candidat_ADOContact")) & ">")
'con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','COLOR2');""  border=""0"">"
'con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurTxt.jpg' width='22' height='21' align='middle' border=""0""></a>"
'con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
'con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
   
   
con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & "<TD colspan='10'>" & ApprecuCoulurTableau
con_frmStyle = con_frmStyle & vbCrLf & ("<br></TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")


   
con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">GRILLE LISER&Eacute;E :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""bglst"" VALUE=" & GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','bglst');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
   

'GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact"))
'bgcolor = """ & "

con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">GRILLE TITRE :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""bglsttr"" VALUE=" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','bglsttr');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")


con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">GRILLE ENCADR&Eacute;E :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""bglstheadertr"" VALUE=" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','bglstheadertr');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CadrePlin.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")

con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">CHAMPS IMPAIRES :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""bglsttrok"" VALUE=" & GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','bglsttrok');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")




'GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact"))
'


' my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
' my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))

con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">CHAMPS PAIRES :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""bglsttrnook"" VALUE=" & GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','bglsttrnook');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
'
con_frmStyle = con_frmStyle & vbCrLf & ("<TR>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">GRILLE SOURIE :</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("<TD><input type=""text"" NAME=""mouseover"" VALUE=" & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & ">")
con_frmStyle = con_frmStyle & vbCrLf & "<a href=""javascript:AffichefrmCouleur('FRM','mouseover');""  border=""0"">"
con_frmStyle = con_frmStyle & vbCrLf & "<img src='CouleurFont.jpg' width='22' height='21' align='middle' border=""0""></a>"
con_frmStyle = con_frmStyle & vbCrLf & ("</TD>       ")
con_frmStyle = con_frmStyle & vbCrLf & ("</TR>        ")
    
   con_frmStyle = con_frmStyle & vbCrLf & ("</TABLE>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</FORM>       ")
'   con_frmStyle = con_frmStyle & vbCrLf & ("</CENTER>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</BODY>       ")
   con_frmStyle = con_frmStyle & vbCrLf & ("</HTML>       ")




End Function
Function Config()
       Response.Expires = 0
          Session("CANDIDAT_CURRENTPAGE") = "CONFIG.ASP"
              
          

 
   
          If Request("MODE2") = "EXECUTE" Then
                If Request("USER_ACTION") = "VALEURS PAR DÉFAUT" Then
               
'SetDefault "CON_BGCOLOR", "#DCC9B2", DsnTableMenu(Session ("candidat_ADOContact"))
'
' SetDefault "COLOR1", "#DCC9B2", DsnTableMenu(Session ("candidat_ADOContact"))
'
' SetDefault "COLOR2", "#E1D2BF", DsnTableMenu(Session ("candidat_ADOContact"))
               
'SetDefault "DEFAULTFIELDSORTBY", "TXT1", DsnTableMenu(Session ("candidat_ADOContact"))
'
'SetDefault "IndexAlpha", "TXT1", DsnTableMenu(Session ("candidat_ADOContact"))
'
'SetDefault "PathImg", "Portal_Image/Catalogue/", DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "TABLES", "Listes", DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "RefCaddy", "txt1", DsnTableMenu(Session ("candidat_ADOContact"))
SetDefault "EMAIL", "test@euxia.net", DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "EMAILSujetClient", "Vous trouverez ci-joint l'exemplaire de votre demande Commande", DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "EMAILSujetFourniseur", "Commande.", DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "IMGaddy", "", DsnTableMenu(Session("candidat_ADOContact"))

 msg = GetMessage("VALEURSPARDEFAUTACTIVEES", "VALEURS PAR DÉFAUT ACTIVÉES", DsnTableMenu(Session("candidat_ADOContact")))
                Else
               
'SetDefault "CON_BGCOLOR", safeEntry(Request("CON_BGCOLOR")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "COLOR1", safeEntry(Request("COLOR1")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "COLOR2", safeEntry(Request("COLOR2")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "DEFAULTFIELDSORTBY", safeEntry(Request("DEFAULTFIELDSORTBY")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "IndexAlpha", safeEntry(Request("IndexAlpha")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "PathImg", safeEntry(Request("PathImg")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "RefCaddy", safeEntry(Request("RefCaddy")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "TITREPAGE3", safeEntry(Request("TITREPAGE3")), DsnTableMenu(Session ("candidat_ADOContact"))
'SetDefault "TEXTE_PASSWORD", safeEntry(Request("TEXTE_PASSWORD")), DsnTableMenu(Session ("candidat_ADOContact"))
SetDefault "EMAIL", safeEntry(Request("EMAIL")), DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "EMAILSujetClient", safeEntry(Request("EMAILSujetClient")), DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "EMAILSujetFourniseur", safeEntry(Request("EMAILSujetFourniseur")), DsnTableMenu(Session("candidat_ADOContact"))
SetDefault "IMGaddy", safeEntry(Request("IMGaddy")), DsnTableMenu(Session("candidat_ADOContact"))


 msg = GetMessage("ParamMaj", "PARAMÈTRES MIS À JOUR", DsnTableMenu(Session("candidat_ADOContact")))
                 End If
           End If
          

'   CONFIG = CONFIG & vbCrLf & ("<HTML>       ")
'   CONFIG = CONFIG & vbCrLf & ("<HEAD>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TITLE>SETTINGS</TITLE>       ")
'   CONFIG = CONFIG & vbCrLf & ("</HEAD>       ")

   Config = Config & vbCrLf & ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
    Config = Config & vbCrLf & "function init()" & vbCrLf
    Config = Config & vbCrLf & "{" & vbCrLf
    Config = Config & vbCrLf & "bar.create();" & vbCrLf
    Config = Config & vbCrLf & "}" & vbCrLf
   
    
   Config = Config & vbCrLf & ("</SCRIPT>       ")
   Config = Config & vbCrLf & ("<LINK REL=""STYLESHEET"" HREF=""PMAINSTYLE1.ASP"">       ")
'   CONFIG = CONFIG & vbCrLf & ("<BODY BACKGROUND='BACKGROUND.ASP'>       ")

  
'   CONFIG = CONFIG & vbCrLf &  GetMenu


     '****** HEADER *****
      Config = Config & vbCrLf & ("<FORM NAME=""FRM"" ACTION=""Contact.asp?mode=CONFIG"" method=""post"">  ")
'  Config = Config & vbCrLf & GetMenu2
  Config = Config & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=" & GetDefault("con_bgcolor", "#DCC9B2", DsnTableMenu(Session("candidat_ADOContact"))) & " CELLPADDING=""0"" CELLSPACING=""0"">       ")

   Config = Config & vbCrLf & ("<TR>       ")
'       CONFIG = CONFIG & vbCrLf &  "toto"
   Config = Config & vbCrLf & ("<TD>       ")
   Config = Config & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
   Config = Config & vbCrLf & ("<TR>       ")
   Config = Config & vbCrLf & ("<TD ALIGN=""LEFT"">       ")

   Config = Config & vbCrLf & ("<font class='header'><b>" & UCase("Configuration Générale") & " </b></font>")
'   CONFIG = CONFIG & vbCrLf & ("</B></FONT>       ")
   Config = Config & vbCrLf & ("</TD>       ")
  
  
   Config = Config & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE"" VALUE=""CONFIG"">       ")
   Config = Config & vbCrLf & ("<TD ALIGN=""RIGHT"">       ")
   Config = Config & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALIDER"">       ")
   Config = Config & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALEURS PAR DÉFAUT"">       ")
   Config = Config & vbCrLf & ("</TD>       ")
   Config = Config & vbCrLf & ("</TR>       ")
   Config = Config & vbCrLf & ("</TABLE>       ")
   Config = Config & vbCrLf & ("</TD>       ")
   Config = Config & vbCrLf & ("</TR>       ")
   Config = Config & vbCrLf & ("</TABLE>       ")

     '******  MESSAGE ******

   Config = Config & vbCrLf & ("<CENTER><FONT COLOR=""RED""><B>") & msg & "</B></FONT></CENTER>       "



   Config = Config & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE2"" VALUE=""EXECUTE"">       ")

   Config = Config & vbCrLf & ("<TABLE BORDER=""0"">       ")

'
'   CONFIG = CONFIG & vbCrLf & ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE FOND DE PAGE</TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD><input type=""text"" NAME=""CON_BGCOLOR"" VALUE=" & GetDefault("CON_BGCOLOR", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("</TR>        ")

'   CONFIG = CONFIG & vbCrLf & ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE DES LISTES</TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD><input type=""text"" NAME=""COLOR1"#DCC9B2" VALUE=" & GetDefault("COLOR1", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("</TR>        ")
'
'   CONFIG = CONFIG & vbCrLf & ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE ALTERNÉE DES LISTES</TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("<TD><input type=""text"" NAME=""COLOR2"" VALUE=" & GetDefault("COLOR2", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf & ("</TR>        ")
'   CONFIG = CONFIG & vbCrLf &  ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TRI PAR DÉFAUT</TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD><input type=""text"" NAME=""DEFAULTFIELDSORTBY"" VALUE=" & GetDefault("DEFAULTFIELDSORTBY", "TXT1", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("</TR>       ")

'   CONFIG = CONFIG & vbCrLf &  ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Recherche Alphanumérique</TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD><input type=""text"" NAME=""IndexAlpha"" VALUE=" & GetDefault("IndexAlpha", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("</TR>       ")

'   CONFIG = CONFIG & vbCrLf &  ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Répertoire Racine Images </TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD><input type=""text"" NAME=""PathImg"" VALUE=" & GetDefault("PathImg", "Portal_Image/Catalogue/", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("</TR>        ")
   
   
'CONFIG = CONFIG & vbCrLf &  ("<TR>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ de référence Caddy </TD>       ")
'   CONFIG = CONFIG & vbCrLf &  ("<TD><input type=""text"" NAME=""RefCaddy"" VALUE=" & GetDefault("RefCaddy", "txt1", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'CONFIG = CONFIG & vbCrLf &  ("</TR>        ")

ONFIG = Config & ("<TR>       ")
   Config = Config & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">BOITE DE RECEPTION COMMANDE</TD>       ")
   Config = Config & vbCrLf & ("<TD><input type=""text"" NAME=""EMAIL"" VALUE=" & GetDefault("EMAIL", "test@euxia.net", DsnTableMenu(Session("candidat_ADOContact"))) & "></TD>       ")
Config = Config & vbCrLf & ("</TR>        ")

ONFIG = Config & ("<TR>       ")
   Config = Config & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">SUJET RECEPTION COMMANDE</TD>       ")
   Config = Config & vbCrLf & ("<TD><input type=""text"" NAME=""EMAILSujetFourniseur"" VALUE=""" & GetDefault("EMAILSujetFourniseur", "Commande.", DsnTableMenu(Session("candidat_ADOContact"))) & """></TD>       ")
Config = Config & vbCrLf & ("</TR>        ")

ONFIG = Config & ("<TR>       ")
   Config = Config & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">SUJET Commande CLIENT</TD>       ")
   Config = Config & vbCrLf & ("<TD><input type=""text"" NAME=""EMAILSujetClient"" VALUE=""" & GetDefault("EMAILSujetClient", "Vous trouverez ci-joint l'exemplaire de votre demande de Commande", DsnTableMenu(Session("candidat_ADOContact"))) & """></TD>       ")
Config = Config & vbCrLf & ("</TR>        ")

ONFIG = Config & ("<TR>       ")
   Config = Config & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">IMAGE BOUTON CADDIE</TD>       ")
   Config = Config & vbCrLf & ("<TD><input type=""text"" NAME=""IMGaddy"" VALUE=""" & GetDefault("IMGaddy", "", DsnTableMenu(Session("candidat_ADOContact"))) & """></TD>       ")
Config = Config & vbCrLf & ("</TR>        ")

'
   Config = Config & vbCrLf & ("</TABLE>       ")
   Config = Config & vbCrLf & ("</FORM>       ")
'   CONFIG = CONFIG & vbCrLf & ("</CENTER>       ")
   Config = Config & vbCrLf & ("       ")
   Config = Config & vbCrLf & ("</BODY>       ")
   Config = Config & vbCrLf & ("</HTML>       ")




End Function
Function CANDIDAT_CADDY(Optional Id_Caddie As String)

      
   Ecom_AjoutCaddie DsnTableMenu(Session("candidat_ADOContact")), Id_Caddie
  
End Function
Function CANDIDAT_CADDYREMPLI(Optional Id_Caddie As String)
    Ecom_ValiderCommande DsnTableMenu(Session("candidat_ADOContact")), Id_Caddie
    
End Function
Sub HtmlEditor()
 
TargetObject = "window.opener." & Request("TargetObject")
pr ("<HTML>")
pr ("<link rel=""stylesheet"" type=""text/css"" href=""ifedit.css"">")
pr ("<SCRIPT>")
pr ("function SetVals() {")
pr (TargetObject & " = editor.GetHTML();")
pr ("    if (" & TargetObject & " == '<P></P>')")
pr ("       { " & TargetObject & " = ''; }")
pr ("     history.go(-1);")
pr ("}")
pr ("</SCRIPT>")
pr ("<BODY onload=""editor.SetHTML(" & TargetObject & ");""")
pr ("<table border=""1"" cellspacing=""0"" cellpadding=""3"" width=""100%"">")
pr ("<tr>")
pr ("<td colspan=""2"">")
pr ("<script>")
pr ("    HtmlEditorStyle='" & Session("candidat_StyleSheet") & "';")
pr ("</script>")
pr ("<SCRIPT SRC=""ifeditscript.js""></SCRIPT>")
pr ("</td></tr><tr><td colspan=""2"" align=""center"">")
pr ("<input type=""hidden"" name=""submitter"" value=""1"">")
pr ("<input type=""button"" value=""" & translate("Actualiser") & """ class=""cmdflat"" onclick=""SetVals();self.close();"">")
pr ("<input type=""button"" value=""" & translate("Annuler") & """ class=""cmdflat"" onclick=""self.close();"">")
pr ("<BR></td>")
pr ("</tr></table></DIV>")
pr (vbCrLf)
pr (vbCrLf)
 
 
 
pr ("</td></tr>")
 

End Sub

Public Function con_subCat()
    Response.Expires = 0
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    Set RS1 = New ADODB.Recordset
    PG = "Contact.asp?mode=con_lst"
    If Request("sub") = "edit" Then
        SearchBlob = ""
        STRSQL = "UPDATE " & Session("candidat_MainTable") & " SET "
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID"))
        If Not RS1.EOF Then
    
            For I = 0 To RS1.Fields.Count - 1
                If RS1(I).Name <> "ContactID" And RS1(I).Name <> "SearchBlob" Then
                    If RS1(I).Name = "UserID" Then      'Numeric
                        STRSQL = STRSQL & RS1(I).Name & " = " & safeEntry(Request(RS1(I).Name)) & ","
                    Else
                        STRSQL = STRSQL & RS1(I).Name & " = '" & safeEntry(Request(RS1(I).Name)) & "',"
                    End If
                End If
                SearchBlob = SearchBlob & " " & safeEntry(Request(RS1(I).Name))
            Next
            STRSQL = STRSQL & "SearchBlob = '" & SearchBlob & "' WHERE ContactID = " & Request("ContactID")
            GeneralTools.My_Conn.Execute (STRSQL)
            PG = "Contact.asp?mode=con_lst&msg=Mise+à+jour+réussie."
        End If
    End If
    
    If Request("sub") = "new" Then
        STRSQL = "INSERT INTO " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & "(UserID,CatName) VALUES("
        STRSQL = STRSQL & "" & 1 & ","
        STRSQL = STRSQL & "'" & safeEntry(Request("CatName")) & "')"
        GeneralTools.My_Conn.Execute (STRSQL)
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT Max(CatID) AS NewID FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & "")
        
        If Session("candidat_CurrentPage") = "con_lst.asp" Then
            PG = "dlgStatus.asp?toPage=Contact.asp&key=mode&keyValue=con_lst&key2=CatID&keyValue2=" & RS1("NewID") & "&msg=Création+de+la+nouvelle+catégorie..."
        Else
            PG = "dlgStatus.asp?toPage=Contact.asp&key=mode&keyValue=con_lst&key2=CatID&keyValue2=" & RS1("NewID") & "&msg=Création+de+la+nouvelle+catégorie..."
        End If
    End If
    
    If Request("sub") = "delete" Then
        STRSQL = STRSQL & "DELETE FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & " WHERE CatID = " & Request("CatID")
        GeneralTools.My_Conn.Execute (STRSQL)
        STRSQL = STRSQL & "DELETE FROM con_CatIDs WHERE CatID = " & Request("CatID")
        GeneralTools.My_Conn.Execute (STRSQL)
        If Session("candidat_CurrentPage") = "con_lst.asp" Then
            PG = "Contact.asp?mode=con_lst&CatID=All&msg=Categorie+supprimée."
        Else
            PG = "Contact.asp?mode=con_lstCat&msg=Categorie+supprimée."
        End If
    End If
    RS1.Close
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
    Response.Redirect PG
End Function

Public Function con_subContact()
STRSQL = "UPDATE con_contacts SET con_contacts.ckb1 = 'NON', con_contacts.ckb2 = 'NON', con_contacts.ckb3 = 'NON', con_contacts.ckb4 = 'NON', con_contacts.ckb5 = 'NON', con_contacts.ckb6 = 'NON', con_contacts.ckb7 = 'NON', con_contacts.ckb8 = 'NON', con_contacts.ckb9 = 'NON', con_contacts.ckb10 = 'NON', con_contacts.ckb11 = 'NON', con_contacts.ckb12 = 'NON', con_contacts.ckb13 = 'NON'  WHERE ContactID = " & Request("ContactID")

    Response.Expires = 0
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    GeneralTools.My_Conn.Execute STRSQL
    STRSQL = ""
    Set RS1 = New ADODB.Recordset
    Set RS1 = GeneralTools.My_Conn.Execute("SELECT fieldname FROM con_FieldDefs WHERE FieldAttribut like '%CRI%' and fieldalias<>''")
    my_lst_blob = " "
    Do While Not RS1.EOF
        my_lst_blob = my_lst_blob & RS1("fieldname") & " "
        RS1.MoveNext
    Loop
    numpage = Request("numpage")
    nbpage = GetDefault("NBPage", 6, Session("candidat_ADOContact"))
    PG = "Contact.asp?mode=con_lst"
    If Request("sub") = "edit" And GetDefault("ModificationMode", "", Session("candidat_ADOContact")) = "Modification" Then
        SearchBlob = ""
        STRSQL = "UPDATE " & Session("candidat_MainTable") & " SET "
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID"))
        If Not RS1.EOF Then
       
            For I = 0 To RS1.Fields.Count - 1
'            i = i + 1
  a = RS1(I).Type
                If RS1(I).Name <> "ContactID" And RS1(I).Name <> "SearchBlob" Then
                    If RS1(I).Name = "UserID" Then      'Numeric
                        STRSQL = STRSQL & RS1(I).Name & " = " & 1 & ","
                    ElseIf Len(Request(RS1(I).Name)) > 0 Then
                        If InStr(1, RS1(I).Name, "lst") > 0 Or RS1(I).Name = "CategoryName" Or RS1(I).Name = "SubCategoryName" Then 'Numeric
                            STRSQL = STRSQL & RS1(I).Name & " = " & Request(RS1(I).Name) & ","
                        Else
                        If UCase(Request("" & RS1(I).Value)) = "OUI" Then
                        STRSQL = STRSQL & RS1(I).Name & " = OUI,"
                        Else
                        
                        End If
                            STRSQL = STRSQL & RS1(I).Name & " = '" & safeEntry(Request(RS1(I).Name)) & "',"
                               Set Rs = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
                                If Rs.EOF = False Then
                                Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Path"))

                                End If
                                Set Rs = Nothing
    
                            If RS1(I).Name = GetDefault("nom", "txt1", Session("candidat_ADOContact")) Then
                                GeneralTools.My_Conn.Execute ("update users set lastname='" & safeEntry(Request(RS1(I).Name)) & "' where userid=" & Request("userid"))
                            ElseIf RS1(I).Name = GetDefault("prenom", "txt2", Session("candidat_ADOContact")) Then
                                GeneralTools.My_Conn.Execute ("update users set firstname='" & safeEntry(Request(RS1(I).Name)) & "' where userid=" & Request("userid"))
                            End If
                            Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
                        End If
                        Else
                   
                    End If
                End If
                
                If Len(Request(RS1(I).Name)) > 0 Then
                    If InStr(1, my_lst_blob, RS1(I).Name) Then
                        If InStr(1, UCase(RS1(I).Name), "LST") Then
                        Dim Sql
                        Dim RsLst As Recordset
                           Sql = "SELECT DISTINCT " & RS1(I).Name & ".CatName From " & RS1(I).Name & " "
                            Sql = Sql & "WHERE " & RS1(I).Name & ".CatID=" & Request(RS1(I).Name) & ";"
                            Set RsLst = GeneralTools.My_Conn.Execute(Sql)
                            If RsLst.EOF = False Then
                                SearchBlob = SearchBlob & " " & safeEntry(RsLst("CatName"))
                            End If
                            RsLst.Close
                            Set RsLst = Nothing
                        Else
                            SearchBlob = SearchBlob & " " & safeEntry(Request(RS1(I).Name))
                        End If
                    End If
                End If
            Next
            If Len(SearchBlob) > 0 Then
                STRSQL = STRSQL & "SearchBlob = '" & SearchBlob & "' WHERE ContactID = " & Request("ContactID")
            Else
                STRSQL = Mid(STRSQL, 1, Len(STRSQL) - 1)
                STRSQL = STRSQL & " WHERE ContactID = " & Request("ContactID")
            End If
            GeneralTools.My_Conn.Execute (STRSQL)
            If nbpage > numpage Then
                PG = "contact.asp?mode=con_frmCandidat&ContactID=" & Request("ContactID") & "&numpage=" & numpage + 1
            Else
                PG = "Contact.asp?mode=con_lst&msg=Mise+à+jour+réussie."
            End If
        End If
    End If
    
    'pg = "Contact.asp?mode=con_lst"
    
    Regrpfld = GetDefault("RegroupingField", "", Session("candidat_ADOContact"))
    If GetDefault("ModificationMode", "", Session("candidat_ADOContact")) = "HistoryMode" Then
        flag_histo_mode = True
    Else
        flag_histo_mode = False
    End If
    
    If Request("sub") = "new" Or flag_histo_mode = True Then
        SearchBlob = ""
        catname = safeEntry(Request("CategoryName"))
        If InStr(Request("SubCategoryName"), "-") > 0 Then
            subcatname = Left(Request("SubCategoryName"), InStr(Request("SubCategoryName"), "-") - 1)
        Else
            subcatname = Request("SubCategoryName")
        End If
'        catname = "Candidat"
'        subcatname = "Nouveau"
         'catname = GetDefault("Candidat", "62")
         'subcatname = GetDefault("Nouveau", "65")
        'insert dans users avec contrôle sur le login
'        my_login = Mid(Request("txt2"), 1, 1) & Request("txt1")
        I = 1
        Sortie = False
        Do While Not Sortie
            my_sql = "select userid from users where username='" & my_login & "'"
            
            Set Rs = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
            If Rs.EOF = False Then
                Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Path"))
            
            End If
            Set Rs = Nothing
            Set RS1 = GeneralTools.My_Conn.Execute(my_sql)
            If Not RS1.EOF Then
                my_login = my_login & I
                I = I + 1
            Else
                Sortie = True
            End If
            RS1.Close
           
        Loop
'        my_sql = "insert into users(firstname,lastname,username, usertype,datecreate) values ('" & Request("txt2") & "', '" & Request("txt1") & "', '" & my_login & "','Standard User','" & Now() & "')"
'        GeneralTools.My_Conn.Execute (my_sql)
'        my_sql = "select userid, usertype from users where username='" & my_login & "'"
'        Set RS1 = GeneralTools.My_Conn.Execute(my_sql)
'        If Not RS1.EOF Then my_id = RS1("userid")
'        1 = my_id
'        Session("candidat_UserType") = RS1("UserType")
'        RS1.Close
         Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
        strINSERT = "INSERT INTO " & Session("candidat_MainTable") & " (UserID,RegroupBlob,CategoryName,SubCategoryName"
        strVALUES = " VALUES(" & 1 & ",'" & Request(GetDefault("RegroupingField", "txt1", Session("candidat_ADOContact"))) & "','" & catname & "','" & subcatname & "'"
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM con_FieldDefs where page=" & numpage & " ORDER BY FieldID")
        Do While Not RS1.EOF
            If Len(RS1("FieldAlias")) > 0 And RS1("FieldName") <> "CategoryName" And RS1("FieldName") <> "SubCategoryName" Then
                If InStr(RS1("FieldAttribut"), "REQ") > 0 And Trim(Request(RS1("FieldName"))) = "" Then
                    PG = "Javascript:history.back();"
                End If
                strINSERT = strINSERT & "," & RS1("FieldName")
                If InStr(1, RS1("FieldAttribut"), "CBO") > 0 Then
                    strVALUES = strVALUES & "," & safeEntry(Request(RS1("FieldName")))
                Else
                    strVALUES = strVALUES & ",'" & safeEntry(Request(RS1("FieldName"))) & "'"
                End If
                If Len(Request(RS1("FieldName"))) > 0 Then
                    If InStr(1, my_lst_blob, RS1("FieldName")) Then SearchBlob = SearchBlob & " " & safeEntry(Request(RS1("FieldName")))
                End If
            End If
            RS1.MoveNext
        Loop
        strINSERT = strINSERT & ",SearchBlob) "
        strVALUES = strVALUES & ",'" & SearchBlob & "')"
        STRSQL = strINSERT & " " & strVALUES
        GeneralTools.My_Conn.Execute (STRSQL)
        
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT Max(ContactID) AS NewID FROM  " & Session("candidat_MainTable"))
        Session("candidat_currEmpID") = RS1("NewID").Value
        If nbpage > numpage Then
                PG = "contact.asp?mode=con_frmCandidat&ContactID=" & Session("candidat_currEmpID") & "&numpage=" & numpage
            Else
            If PG <> "Javascript:history.back();" Then PG = "Contact.asp?mode=con_lst&msg=Nouvel+enregistrement+créé."
        End If                                                  'Contact.asp?mode=con_lst&msg=Suppression+réussie.
    End If
    
    If Request("sub") = "delete" Then
        STRSQL = STRSQL & "DELETE * FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID")
        GeneralTools.My_Conn.Execute (STRSQL)
        PG = "Contact.asp?mode=con_lst&msg=Suppression+réussie."
    End If
    
    RS1.Close
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
    Session("candidat_UserType") = Session("candidat_UserType")
    Response.Redirect PG
End Function



Function ReplaceChampName(txt)
ReplaceChampName = txt
ReplaceChampName = Replace(UCase(ReplaceChampName), UCase(" Desc"), "")
ReplaceChampName = Replace(UCase(ReplaceChampName), UCase("[con_Contacts]"), "")
ReplaceChampName = Replace(ReplaceChampName, ".", "")
ReplaceChampName = Replace(ReplaceChampName, "[", "")
ReplaceChampName = Replace(ReplaceChampName, "]", "")
ReplaceChampName = Replace(UCase(ReplaceChampName), UCase("catname"), "")
ReplaceChampName = Trim(ReplaceChampName)
End Function

Public Function ApprecuCoulurTableau()
ApprecuCoulurTableau = "<BR>"
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & "<link rel=""stylesheet"" href=""my_Hreff.css"">"
Dim MyAtribut As New Collection

   
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<script language='javascript'>")
    
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javCadyRempli() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("myForm = this.document.forms[0];")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("myForm.mode.value = 'Candidat_caddy';")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("myForm.action='Contact.asp?mode=Candidat_caddy';")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("myForm.submit();")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
        
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javSendEmail() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   document.frm.submit()")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javSelectAll(chk) {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   len = document.frm.elements.length;")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   var i=0;")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   for( i=0; i<len; i++) {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("       if (document.frm.elements[i].name=='lstTO') {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("           document.frm.elements[i].checked=chk;")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("       }")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   }")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javNewContact() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   location.href = 'contact.asp?mode=con_frmCandidat&ContactID=0'")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
      
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javResetSearch() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   location.href = 'Contact.asp?mode=con_lst&reset=true'")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javCat() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   var ID = document.frmSearch.CatID.options[document.frmSearch.CatID.selectedIndex].value")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   location.href = 'Contact.asp?mode=con_lst&CatID=' + ID")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javAddToCat() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   window.open('con_dlgAddToCat.asp?CatID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javRemoveFromCat() {")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   window.open('con_dlgRemoveFromCat.asp?CatID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    
     ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function javDelete(ContactID) {")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("        location.href = ""Contact.asp?mode=con_subContact&sub=delete&ContactID=+ContactID""")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("    } else {")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("        return")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("    }")
        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("}")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</script>")
    
    '***** VBScript to highlight rows
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<script language=""VBscript"">")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function vbMouseOver(a)")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("end function")
   
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function vbMouseOut(a)")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   a.style.backgroundcolor = """ & GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact")) & """")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("end function")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function vbMouseOut2(a)")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("   a.style.backgroundcolor = """ & GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact")) & """")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("end function")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("function vbEditContact(ID)")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("end function")
    
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</script>")

    '******** TitleBar
'
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("con_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr valign=""bottom"">")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td><br>")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<table width=""100%"" border=""0"">")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr valign=""bottom"">")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<form name=""frmSearch"" action=""Contact.asp"" method=""get"">")
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<input type=""hidden"" name=""mode"" value=""con_lst"">")
    
   
    
    '************** Headers ******
     ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr bgcolor='" & GetDefault("bglst", "#ffffff", Session("candidat_ADOContact")) & "'><td align=""left"" valign=""middle"" colspan=""10"">")
'   ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & "<font color='" & GetDefault("bglst", "#ffffff", Session("candidat_ADOContact")) & "' size='" & GetDefault("con_H_Linge", "2", Session("candidat_ADOContact")) & "' >"
'    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & "&nbsp;"
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & "</td></tr>"
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")
    '------------  To/Cc/Bcc

    
         
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='A'><a href='#A'><b>A</b></a></td>")
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='B'><a href='#B'><b>B</b></a></td>")
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='C'><a href='#C'><b>C</b></a></td>")
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='D'><a href='#D'><b>D</b></a></td>")
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='E'><a href='#E'><b>E</b></a></td>")
ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='F'><a href='#F'><b>F</b></a></td>")
'ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='G'><a href='#G'><b>G</b></a></td>")
'ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='H'><a href='#H'><b>H</b></a></td>")
'ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='I'><a href='#I'><b>I</b></a></td>")
'ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='J'><a href='#J'><b>J</b></a></td>")

     

    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</tr>")
    
    
    'On Error Resume Next
    
    '************  Initiate page counter
    
'    lstPage = 1
'    ENDITEM = currPageNum
'    BEGINITEM = 1
'    I = 0
'    ICOUNTER = 0
'
'    INTPAGE = Trim(Request("con_lstPage"))
'    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
'        Session("candidat_con_lstPage") = INTPAGE
'    End If
    
'    If Len(Session("candidat_con_lstPage")) > 0 Then
'        lstPage = CInt(Session("candidat_con_lstPage"))
'        ENDITEM = lstPage * currPageNum
'        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
'    End If
    I = 1
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
   For I = 1 To 5
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
       

'        If (I >= BEGINITEM And I <= val(ENDITEM)) Then

'            LastRegroupBlob = rs0("RegroupBlob")
            If (I Mod 2) = 0 Then 'CStr(i) = CStr(Session("candidat_currContactID")) Then
                ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr id=""tr" & I & """ style=""background:" & my_bglsttrok & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & I & ")"" OnMouseOut=""vbMouseOut(tr" & I & ")"" OnClick=""vbEditContact(" & I & ")"">")
            Else
                ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<tr id=""tr" & I & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & I & ")"" OnMouseOut=""vbMouseOut2(tr" & I & ")"" OnClick=""vbEditContact(" & I & ")"">")
            End If

            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='A" & CStr(I) & "'><a href='#A" & CStr(I) & "'><b>A" & CStr(I) & "</b></a></td>")
            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='B" & CStr(I) & "'><a href='#B" & CStr(I) & "'><b>B" & CStr(I) & "</b></a></td>")
            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='C" & CStr(I) & "'><a href='#C" & CStr(I) & "'><b>C" & CStr(I) & "</b></a></td>")
            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id=D" & CStr(I) & "><a href='#D" & CStr(I) & "'><b>D" & CStr(I) & "</b></a></td>")
            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='E" & CStr(I) & "'><a href='#E" & CStr(I) & "'><b>E" & CStr(I) & "</b></a></td>")
            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='F" & CStr(I) & "'><a href='#F" & CStr(I) & "'><b>F" & CStr(I) & "</b></a></td>")
'            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='G" & CStr(I) & "'><a href='#G" & CStr(I) & "'><b>G" & CStr(I) & "</b></a></td>")
'            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='H" & CStr(I) & "'><a href='#H" & CStr(I) & "'><b>H" & CStr(I) & "</b></a></td>")
'            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id='I" & CStr(I) & "'><a href='#I" & CStr(I) & "'><b>I" & CStr(I) & "</b></a></td>")
'            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("<td nowrap id= 'J" & CStr(I) & "'><a href='#J" & CStr(I) & "'><b>J" & CStr(I) & "</b></a></td>")

          

            ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</tr>")

            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
'        End If
        Next
  
    ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</table>")
    

        
'        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</td>")
'        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</tr>")
'        ApprecuCoulurTableau = ApprecuCoulurTableau & vbCrLf & ("</form>")

End Function
Public Function con_lst()
pr "<link rel=""stylesheet"" href=""my_Hreff.css"">"
Dim MyAtribut As New Collection

 If UCase(Request("EnceladeSearch")) = "SEARCHEXE" Then
            Session("CloseWereSearch") = MyCloseWhere
    End If


    If Request("EnceladeSearch") = "SearchAnnuler" Then
        Session("CloseWereSearch") = ""
         Session("Encelade_contactSearch") = ""
    End If
    If Len(Session("CloseWereSearch")) <> 0 Then
        strSearch = "<font class=""smallheader"" color=""" & GetDefault("con_color", "white", Session("candidat_ADOContact")) & """>"
         strSearch = strSearch & vbCrLf & "<b>"
         strSearch = strSearch & vbCrLf & "<img src=""" & GetDefault("imgrech", "query.gif", Session("candidat_ADOContact")) & """ border=""0"">"
         strSearch = strSearch & vbCrLf & "&nbsp;Résultat de la recherche"
         strSearch = strSearch & vbCrLf & "</b></font>"

        Session("Encelade_contactSearch") = "true"

        
                    
    End If

    
       
           
    Response.Expires = 0
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
   
   Sql = "SELECT DISTINCT con_FieldDefs.FieldName, con_FieldDefs.FieldAttribut,  "
   Sql = Sql & "con_FieldDefs.FieldOrder From con_FieldDefs "
   Sql = Sql & " "
   Sql = Sql & "ORDER BY con_FieldDefs.FieldOrder;"
    For I = MyAtribut.Count To 1 Step -1
        MyAtribut.Remove (I)
    Next
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    SockEncelade = GetDefault("StockEncelade", "TXT81", Session("candidat_ADOContact"))
    While rs0.EOF = False
       If InStr(1, UCase("" & rs0!fieldNAME), SockEncelade) = 0 Then
            If InStr(1, UCase("" & rs0!FieldAttribut), "SYS") = 0 Then
                MyAtribut.Add False, rs0!fieldNAME
            Else
                 MyAtribut.Add True, rs0!fieldNAME
            End If
        Else
            If Session("Droits_SockEncelade") = 1 Then
                
                MyAtribut.Add False, rs0!fieldNAME
            Else
                 MyAtribut.Add True, rs0!fieldNAME
            End If

      End If
        rs0.MoveNext
    Wend
    
    
  

    Session("candidat_CurrentPage") = "contact.asp?mode=con_lst"
    AlphaIndexField = GetDefault("IndexAlpha", "LastName", Session("candidat_ADOContact"))
    If Request("EnceladeSearch") = "SearchEXE" Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_SubCategory") = ""
    End If
    
     If Request("EnceladeSearch") = "SearchAnnuler" Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_SubCategory") = ""
        Session("CloseWereSearch") = ""
        Session("CloseWhereOrder") = ""
        Session("CloseWhereFrom") = ""
        Session("candidat_contactSortBy") = ""
        Session("Encelade_contactSearch") = ""
    End If
      
   
    If Len(Request("Category")) > 0 Then
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_con_lstPage") = ""
        Session("candidat_Category") = Request("Category")
        Session("candidat_SubCategory") = ""
    End If

    If Len(Request("contactLetter")) > 0 Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactLetter") = Request("contactLetter")
        Session("CloseWereSearch") = ""
        Session("CloseWhereOrder") = ""
        Session("CloseWhereFrom") = ""
        Session("candidat_contactSortBy") = ""
        Session("candidat_contactSearch") = ""
        Session("Encelade_contactSearch") = ""
        'Session("candidat_contactQuery") = ""
    End If
    
    If Request("contactLetter") = "All" Then
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactLetter") = ""
    End If
    
    If Len(Request("SubCategory")) > 0 Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_SubCategory") = Request("SubCategory")
    End If

    '------------ MAIN CONTACT LIST
    If Request("SubCategory") = "All" Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_SubCategory") = ""
    End If
    
    If Request("Category") = "All" Then
        Session("candidat_con_lstPage") = ""
'        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_Category") = ""
        
    End If
    '------------- SEARCH
    If Len(Request("contactSearch")) > 0 Then
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactSearch") = Request("contactSearch")
        Session("candidat_Category") = ""
        Session("candidat_SubCategory") = ""
        Session("Encelade_contactSearch") = ""

    End If
    
    '-------------- QUERY
    If (Request("contactQuery") = "true") Then
        Session("candidat_contactQuery") = "true"
        Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_Category") = ""
        Session("candidat_SubCategory") = ""
    End If
    
    If Request("reset") = "true" Then
       Session("candidat_con_lstPage") = ""
        Session("candidat_contactSearch") = ""
        Session("candidat_contactQuery") = ""
        Session("candidat_contactLetter") = ""
        Session("candidat_SubCategory") = ""
        Session("CloseWhereOrder") = ""
         Session("CloseWhereFrom") = ""
        Session("CloseWereSearch") = ""
        Session("candidat_contactSortBy") = ""
        Session("Encelade_contactSearch") = ""
    End If
    
  currPageNum = GetDefault("con_PageNum", "15", Session("candidat_ADOContact"))
   
    If val("" & Request("NbLiges")) <> 0 Then
        Session("CloseWherNbLiges") = Request("NbLiges")
    End If
If Session("CloseWherNbLiges") <> "" Then
    currPageNum = Session("CloseWherNbLiges")
End If
 currPageNum = CInt(currPageNum)
If "" & Session("CloseWhereOrder") <> "" Then
    Session("candidat_contactSortBy") = Session("CloseWhereOrder")
Else
    If "" & Session("candidat_contactSortBy") = "" Then
        Session("candidat_contactSortBy") = GetDefault("DefaultFieldSortBy", "", Session("candidat_ADOContact"))
    End If
End If
    
    '**** Category
    Catoption = ""
    
    If Session("candidat_Category") <> "" And Session("candidat_Category") <> "All" Then
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & "  WHERE CatID=" & Session("candidat_Category"))
        Catoption = GetDefault("CategoryName", "Category", Session("candidat_ADOContact")) & " : " & RS1("CatName")
    End If
    If Session("candidat_Category") = "All" Then
        Catoption = GetDefault("CategoryName", "Category", Session("candidat_ADOContact")) & " : " & GetDefault("AllCategories", "All", Session("candidat_ADOContact"))
        Session("candidat_Category") = ""
    End If
    If Session("candidat_SubCategory") <> "" And Session("candidat_SubCategory") <> "All" Then
      
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & GetDefault("CatsTable", "con_Cats", Session("candidat_ADOContact")) & "  WHERE CatID=" & Session("candidat_SubCategory"))
        Catoption = Catoption & "<br>" & GetDefault("SubCategoryName", "SubCategory", Session("candidat_ADOContact")) & " : " & RS1("CatName")
    End If
    If Session("candidat_SubCategory") = "All" Then
        Catoption = Catoption & "<br>" & GetDefault("AllSubCategories", "All", Session("candidat_ADOContact"))
        Session("candidat_SubCategory") = ""
    End If
    
    
    Set RS1 = Nothing
    '**** Get select string
   
    STRSQL = "SELECT " & Session("candidat_MainTable") & ".ContactID,UserID," & Session("candidat_MainTable") & ".RegroupBlob "
    strRS1 = "SELECT con_FieldDefs.FieldName, con_FieldDefs.FieldAttribut FROM con_FieldDefs,con_Fields "
    strRS1 = strRS1 & " WHERE con_FieldDefs.FieldID = con_Fields.FieldID "
    strRS1 = strRS1 & "AND UserID = 1 "
    strRS1 = strRS1 & "ORDER BY con_Fields.FieldOrder, con_Fields.FieldID "

    Set RS1 = GeneralTools.My_Conn.Execute(strRS1)
    If RS1.EOF Then
        STRSQL = "SELECT * "
    End If
    my_end = ""
    Do While Not RS1.EOF
    Debug.Print STRSQL
        If InStr(1, RS1("FieldName"), "lst") > 0 Then
            If InStr(1, RS1("FieldAttribut").Value, "NUM") <> 0 Then
                STRSQL = STRSQL & ",val('' & " & RS1("FieldName") & ".catname) as " & RS1("FieldName")
            Else
                STRSQL = STRSQL & "," & RS1("FieldName") & ".catname as " & RS1("FieldName")
            End If
            If my_end <> "" Then
                my_end = " (" & my_end & ") LEFT JOIN " & RS1("FieldName") & " ON con_Contacts." & RS1("FieldName") & " = " & RS1("FieldName") & ".CatID "
            Else
                my_end = "" & Session("candidat_MainTable") & " LEFT JOIN " & RS1("FieldName") & " ON con_Contacts." & RS1("FieldName") & " = " & RS1("FieldName") & ".CatID "
            End If
        Else
            If InStr(1, RS1("FieldAttribut"), "NUM") <> 0 Then
                STRSQL = STRSQL & ",val('' & " & Session("candidat_MainTable") & "." & RS1("FieldName") & ") as  " & RS1("FieldName") & "§"
            Else
                STRSQL = STRSQL & "," & Session("candidat_MainTable") & "." & RS1("FieldName")
            End If
        End If
        RS1.MoveNext
    Loop
     Session("CloseWhereFrom") = ""
If Session("CloseWhereFrom") = "" Then
    SplitClaoseWhere = Split(Session("CloseWereSearch") & "(", "(")

For I = 0 To UBound(SplitClaoseWhere) - 1
 Close_w = Trim(Replace(Replace(Replace("" & SplitClaoseWhere(I), "(", ""), "[", ""), "]", ""))
 If Close_w <> "" Then
 Close_w = Split(Close_w, ".")
 If InStr(Session("CloseWhereFrom"), Close_w(0)) = 0 Then
    Session("CloseWhereFrom") = Session("CloseWhereFrom") & Close_w(0) & vbCrLf
  End If
End If
Next
End If
    If Session("CloseWhereFrom") <> "" Then
    MyFrom = Split(Session("CloseWhereFrom"), vbCrLf)
    
    Dim IndexForm
    For IndexForm = 0 To UBound(MyFrom) - 1
        If InStr(1, UCase(my_end), UCase(MyFrom(IndexForm) & ".CatID ")) = 0 And Left(UCase(MyFrom(IndexForm)) & "   ", 3) = "LST" Then
            If my_end <> "" Then
                my_end = " (" & my_end & ") LEFT JOIN " & MyFrom(IndexForm) & " ON con_Contacts." & MyFrom(IndexForm) & " = " & MyFrom(IndexForm) & ".CatID "
            Else
                my_end = "" & Session("candidat_MainTable") & " LEFT JOIN " & MyFrom(IndexForm) & " ON con_Contacts." & MyFrom(IndexForm) & " = " & MyFrom(IndexForm) & ".CatID "
            End If

        End If
    Next IndexForm
    End If
    STRSQL = STRSQL & " FROM  "
    If my_end = "" Then STRSQL = STRSQL & Session("candidat_MainTable")
    STRSQL = Replace(STRSQL, "UserID", "con_Contacts.UserID")
  
    STRSQL = STRSQL & my_end
    
    
    sqlcount = "SELECT Count(*) as RecCount FROM "
    
    If my_end = "" Then sqlcount = sqlcount & Session("candidat_MainTable")
    sqlcount = sqlcount & my_end
   
   
    
    '***** Build sql
    If Len(Session("candidat_contactSearch")) > 0 Then
        STRSQL = STRSQL & "  WHERE (con_Contacts.UserID = 0 OR con_Contacts.UserID = " & 1 & ") "
        sqlcount = sqlcount & "  WHERE (con_Contacts.UserID = 0 OR con_Contacts.UserID =" & 1 & ") "
        
        STRSQL = STRSQL & "AND (SearchBlob Like '%" & Session("candidat_contactSearch") & "%') "
        sqlcount = sqlcount & "AND (SearchBlob Like '%" & Session("candidat_contactSearch") & "%') "
    
        strSearch = "<font class=""smallheader"" color=""" & GetDefault("con_color", "white", Session("candidat_ADOContact")) & """><b><img src=""" & GetDefault("imgrech", "query.gif", Session("candidat_ADOContact")) & """ border=""0"">&nbsp;Résultat pour: '" & Session("candidat_contactSearch") & "'</b></font>"
       
         ElseIf Session("candidat_contactQuery") = "true" Then
        STRSQL = STRSQL & " WHERE (con_Contacts.UserID = 0 OR con_Contacts.UserID = " & 1 & ") "
        sqlcount = sqlcount & " WHERE (con_Contacts.UserID = 0 OR con_Contacts.UserID " & 1 & ") "
       
        
        Set rs0 = New ADODB.Recordset
        Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM con_FieldDefs")
        Do While Not rs0.EOF
            If InStr(rs0("FieldAttribut"), "CRI") > 0 And rs0("FieldAlias") <> "" Then
                tmp = "Qry" & rs0("FieldName")
                If Trim(Request("con_lstPage")) = "" Then
                    Session(tmp) = Request(rs0("FieldName"))
                End If
                If Len(Session(tmp)) > 0 Then
                    STRSQL = STRSQL & "AND (" & rs0("FieldName") & " LIKE '" & Session(tmp) & "%') "
                    sqlcount = sqlcount & "AND (" & rs0("FieldName") & " LIKE '" & Session(tmp) & "%') "
                End If
            End If
            rs0.MoveNext
        Loop
        
        strSearch = "<font class=""smallheader"" color=""" & GetDefault("con_color", "white", Session("candidat_ADOContact")) & """><b><img src=""" & GetDefault("imgrech", "query.gif", Session("candidat_ADOContact")) & """ border=""0"">&nbsp;Résultat</b></font>"
    Else
        If Session("candidat_Category") <> "" And Session("candidat_SubCategory") = "" Then
            STRSQL = STRSQL & " WHERE (CategoryName = '" & Session("candidat_Category") & "') "
            sqlcount = sqlcount & " WHERE (CategoryName = '" & Session("candidat_Category") & "') "
            
            CaptionStr = Session("candidat_Category")
        End If
        If Session("candidat_SubCategory") <> "" Then
            STRSQL = STRSQL & " WHERE (SubCategoryName = '" & Session("candidat_SubCategory") & "') "
            sqlcount = sqlcount & " WHERE (SubCategoryName = '" & Session("candidat_SubCategory") & "') "
            CaptionStr = "Personal List"
        End If
    End If
    
    '***********  By LETTER
    If Len(Session("candidat_contactLetter")) > 0 Then
        If InStr(1, STRSQL, " WHERE") < 1 Then
            STRSQL = STRSQL & "  WHERE (" & AlphaIndexField & "  LIKE '" & Session("candidat_contactLetter") & "%') "
            sqlcount = sqlcount & "  WHERE (" & AlphaIndexField & "  LIKE '" & Session("candidat_contactLetter") & "%') "
        Else
            STRSQL = STRSQL & " AND (" & AlphaIndexField & "  LIKE '" & Session("candidat_contactLetter") & "%') "
            sqlcount = sqlcount & " AND (" & AlphaIndexField & "  LIKE '" & Session("candidat_contactLetter") & "%') "
        End If
    End If
     If Len(Session("CloseWereSearch")) <> 0 Then
        If InStr(1, UCase(STRSQL), " WHERE ") <> 0 Then
            STRSQL = STRSQL & " AND ( " & Session("CloseWereSearch") & " ) "
        Else
             
             STRSQL = STRSQL & " WHERE " & Session("CloseWereSearch")
              
         End If
        Else
        If Session("portal_candidat_Recherhe") = 1 Then
                   Response.Redirect "Contact.asp?mode=SEARCH"
                Exit Function
             End If
     End If
'     STRSQL = STRSQL & Session("CloseWereSearch")
       
    '********* Order by
    If GetDefault("ModificationMode", "", Session("candidat_ADOContact")) = "HistoryMode" Then
    
    If Len(Request("contactSortBy")) > 0 Then
        Set RsNum = GeneralTools.My_Conn.Execute("SELECT con_FieldDefs.FieldAttribut From con_FieldDefs WHERE con_FieldDefs.FieldName=" & Request("contactSortBy") & ";")
    Else
        Set RsNum = GeneralTools.My_Conn.Execute("SELECT con_FieldDefs.FieldAttribut From con_FieldDefs WHERE con_FieldDefs.FieldName=" & Session("candidat_contactSortBy") & ";")

    End If
    
        If Len(Request("contactSortBy")) > 0 Then
            Session("candidat_contactSortBy") = Request("contactSortBy")
            
            STRSQL = STRSQL & " ORDER BY RegroupBlob," & Request("contactSortBy")
        ElseIf Len(Session("candidat_contactSortBy")) > 0 Then
            STRSQL = STRSQL & " ORDER BY RegroupBlob," & Session("candidat_contactSortBy")
        Else
           
            STRSQL = STRSQL & " ORDER BY RegroupBlob," & Session("candidat_contactSortBy")
        End If
    Else
        If Len(Request("contactSortBy")) > 0 Then
        Set RsNum = GeneralTools.My_Conn.Execute("SELECT con_FieldDefs.FieldAttribut From con_FieldDefs WHERE con_FieldDefs.FieldName='" & ReplaceChampName(Request("contactSortBy")) & "';")
    Else
        Set RsNum = GeneralTools.My_Conn.Execute("SELECT con_FieldDefs.FieldAttribut From con_FieldDefs WHERE con_FieldDefs.FieldName='" & ReplaceChampName(Session("candidat_contactSortBy")) & "';")

    End If
        If Len(Request("contactSortBy")) > 0 Then
            Session("candidat_contactSortBy") = Request("contactSortBy")
            If InStr(1, RsNum("FieldAttribut"), "NUM") <> 0 Then
                MyTxt = Replace(Request("contactSortBy"), " Desc", "")
                
                STRSQL = STRSQL & " ORDER BY " & Replace(Request("contactSortBy"), MyTxt, "Val('' & " & MyTxt & ")")
            Else
                STRSQL = STRSQL & " ORDER BY " & Request("contactSortBy")
            End If
        ElseIf Len(Session("candidat_contactSortBy")) > 0 Then
           
        Else
            
           
        End If
    End If
    Dim a As Recordset
'    a.DataSource
    If InStr(1, UCase(STRSQL), " ORDER BY ") = 0 Then
        MyTxt = Replace(UCase(Session("candidat_contactSortBy")), UCase(" Desc"), "")
        If InStr(1, RsNum("FieldAttribut"), "NUM") <> 0 Then
           
                
                STRSQL = STRSQL & " ORDER BY " & "Val('' & " & MyTxt & ") "
                If InStr(1, UCase(Session("candidat_contactSortBy")), " DESC") <> 0 Then
                
                     STRSQL = STRSQL & " Desc "
                End If
            
       
    Else
    
        STRSQL = STRSQL & " ORDER BY " & Session("candidat_contactSortBy")
   End If
    End If
    Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    
    
    '*********** Get record count
    
Debug.Print Session("CloseWereSearch")
If Session("CloseWereSearch") <> "" Then
    If InStr(1, STRSQL, " WHERE ") <> 0 Then
        STRSQL = STRSQL & " AND ( " & Session("CloseWereSearch") & " ) "
        Else
           STRSQL = STRSQL & " WHERE " & Session("CloseWereSearch")
        End If
    End If
   
    If Session("CloseWereSearch") <> "" Then
        If InStr(1, sqlcount, " WHERE ") <> 0 Then
            sqlcount = sqlcount & " AND ( " & Session("CloseWereSearch") & " ) "
        Else
            sqlcount = sqlcount & " where " & Session("CloseWereSearch")
        End If
    End If
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    
    'pr ("<html>")
    'pr ("<head>")
    'pr ("<title>" & GetDefault("con_AppTitle", "Contact Manager") & "</title>")
    
    'pr ("</head>")
    pr ("<script language='javascript'>")
'
'    pr "function javDevis() {"
'    pr "myForm = this.document.forms[0];"
'    pr "myForm.mode.value = 'candidat_caddy';"
'    pr "myForm.act.value = 'ajout';"
'    pr "myForm.action='Contact.asp?mode=Candidat_caddy';"
'    pr "myForm.submit();"
'    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=Candidat_caddy';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=con_frmCandidat&ContactID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=con_lst&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.CatID.options[document.frmSearch.CatID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=con_lst&CatID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?CatID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?CatID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ContactID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = ""Contact.asp?mode=con_subContact&sub=delete&ContactID=+ContactID""")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    '***** VBScript to highlight rows
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
   
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut2(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbEditContact(ID)")
    If Session("candidat_UserType") <> "Anonyme" Then
        pr ("   location.href = ""contact.asp?mode=con_frmCandidat&ContactID="" & ID")
    Else
    'contact.asp?mode=CANDIDAT_CADDY&act=ajout&ContactID
        pr ("   location.href = ""contact.asp?mode=CANDIDAT_CADDY&act=ajout&ContactID="" & ID")
    End If
    pr ("end function")
    
    pr ("</script>")
    'pr ("<link rel=""stylesheet"" href=""PMainStyle1.asp"">")
    'pr ("<body background=""" & Session("candidat_Background") & """  onLoad=""document.frmSearch.contactSearch.focus()"">")

    '******** TitleBar
    
    pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("con_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmSearch"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""con_lst"">")
    pr ("<td align=""left"" valign=""middle"">")
   pr "<font color='" & GetDefault("con_titre", "#ffffff", Session("candidat_ADOContact")) & "' size='" & GetDefault("con_H_Linge", "2", Session("candidat_ADOContact")) & "' >"
    pr (Session("Encelade_Message"))
    pr "</font>"
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
     If Session("portal_candidat_Recherhe") <> "1" Then
    pr ("<input type=""text""   name=""contactSearch"" size=""17"" value=""" & Session("candidat_contactSearch") & """>")
    pr ("<input type=""submit""  class=""cmdflat""   value=""Chercher"">")
End If
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr ("<input type=""button""  class=""cmdflat""   value=""Réinitialiser"" onClick=""javResetSearch()"">")
    End If
        If Session("candidat_UserType") = "Administrator" Then
    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Mydsn = DsnTableMenu(Session("candidat_ADOContact"))
     Set CaddyConn = OpenDb(Mydsn)
    If Session("candidat_UserType") = "Administrator" Then
        
       pr "<input type=""hidden"" name=""ComFour"" value=""True"">"
        Set RsCaddy = CaddyConn.Execute("SELECT T_Caddie_Four.* FROM T_Caddie_Four WHERE T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy") & ";")
        If RsCaddy.EOF = False Then
            IMGaddy = Trim(GetDefault("IMGaddy", "", DsnTableMenu(Session("candidat_ADOContact"))))
            
                pr ("<input type=""button""  class=""cmdflat""   value=""Com. Fourniseur"" onClick=""javCadyRempli()"">")
            
        End If
    Else
        
        
        Set RsCaddy = CaddyConn.Execute("SELECT t_caddie.* FROM t_caddie WHERE t_caddie.id_caddie=" & val("" & Session("candidat_id_caddy")) & ";")
        If RsCaddy.EOF = False Then
        IMGaddy = Trim(GetDefault("IMGaddy", "", DsnTableMenu(Session("candidat_ADOContact"))))
        If IMGaddy = "" Then
        pr ("<input type=""button""  class=""cmdflat""   value=""Voir Caddy"" onClick=""javCadyRempli()"">")
        Else
        pr ("<a href=""javascript:javCadyRempli();"" border=""0""><img src=""" & IMGaddy & """ alt=""Voir Caddy"" border=""0"" ></a>")
        '            pr ("<img src=""" & IMGaddy & """ onClick=""javCadyRempli()"" alt=""Voir Caddy"">")
        End If
        End If
    End If
    RsCaddy.Close
    Set RsCaddy = Nothing
    CaddyConn.Close
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
    '***************** MESSAGE **********
    
    If Len(Request("msg")) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & Request("msg") & "</b></font></center>")
    End If
    
    
    '***************** Command Bar **********
    pr ("<table bgcolor=""" & GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact")) & """ width=""100%"">")
    pr ("<tr>")
    pr ("<td nowrap>")
    If Session("portal_candidat_Recherhe") <> "1" Then
'
'    If Len(Session("candidat_contactLetter")) > 0 Then
'        pr ("<a href=""Contact.asp?mode=con_lst&contactLetter=All""><font class=""smallerheader"">[Tous]</font></a>&nbsp;")
'    Else
'        pr ("<a href=""Contact.asp?mode=con_lst&contactLetter=All""><font color=""" & GetDefault("letteron", "#DCC9B2", Session("candidat_ADOContact")) & """><b>[Tous]</b></font></a>&nbsp;")
'    End If
'    my_colorred = GetDefault("letteron", "#DCC9B2", Session("candidat_ADOContact"))

'    For t = 1 To 36
'        LTR = getLetter(t)
'        LTR = UCase(LTR)
'        If Session("candidat_contactLetter") = LTR Then
'            pr ("<font  color=""" & my_colorred & """><b>" & LTR & "</b></font>&nbsp;")
'        Else
'            pr ("<a href=""Contact.asp?mode=con_lst&contactLetter=" & LTR & """><font class=""smallerheader"">" & LTR & "</font></a>&nbsp;")
'        End If
'    Next
   End If
    pr ("</td></tr>")
    pr ("</table>")
    
    '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")
    '------------  To/Cc/Bcc
    'pr ("<td nowrap width='20'>To</td><td nowrap width='20'>Cc</td><td nowrap width='20'>Bcc</td>")
    
'    If Len(Session("candidat_contactSearch")) > 0 Or Session("candidat_contactQuery") = "true" Then
'        If InStr(Session("candidat_contactSortBy"), "UserID") Then
'            If InStr(Session("candidat_contactSortBy"), "Desc") Then
'                pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=UserID'><img src='SortDesc.gif' border='0'><b>Lister par</b></a></td>")
'            Else
'                pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=UserID+Desc'><img src='SortAss.gif' border='0'><b>Lister par</b></a></td>")
'            End If
'        Else
'            pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=UserID'><b>Lister par</b></a></td>")
'        End If
'    End If

    For I = 3 To rs0.Fields.Count - 1
    If (I = 3) And (Session("candidat_UserType") = "Anonyme") Then
         If Session("UserCommander") = 1 Then
            pr ("<td nowrap><a href='Contact.asp?mode=Candidat_caddy&contactSortBy=" & rs0(I).Name & "'><b>" & "Ajouter Commande" & "</b></a></td>")
         End If
    End If
     T_MyAtribut = Split(rs0(I).Name & "§", "§")
        MyTxt = getHeading("" & T_MyAtribut(0))
      
       If (MyAtribut(T_MyAtribut(0)) = False) Or (Session("candidat_UserType") = "Administrator") Then
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("candidat_contactSortBy")), UCase(T_MyAtribut(0))) Then
                
            If InStr(Session("candidat_contactSortBy"), "Desc") Then
                pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=" & T_MyAtribut(0) & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=" & T_MyAtribut(0) & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            pr ("<td nowrap><a href='Contact.asp?mode=con_lst&contactSortBy=" & T_MyAtribut(0) & "'><b>" & MyTxt & "</b></a></td>")
        End If
        If Session("candidat_UserType") = "Administrator" Then
            If I = rs0.Fields.Count - 1 Then
                pr ("<td nowrap><a href='Contact.asp?mode=Candidat_caddy&contactSortBy=" & T_MyAtribut(0) & "'><b>" & "Supprime Fiche" & "</b></a></td>")
            End If
        End If
        End If
    Next
    pr ("</tr>")
    
    
    'On Error Resume Next
    
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("con_lstPage"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("candidat_con_lstPage") = INTPAGE
    End If
    
    If Len(Session("candidat_con_lstPage")) > 0 Then
        lstPage = CInt(Session("candidat_con_lstPage"))
        ENDITEM = lstPage * currPageNum
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 1
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
            
            LastRegroupBlob = rs0("RegroupBlob")
            If (I Mod 2) = 0 Then 'CStr(rs0("ContactID")) = CStr(Session("candidat_currContactID")) Then
                pr ("<tr id=""tr" & rs0("ContactID") & """ style=""background:" & my_bglsttrok & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & rs0("ContactID") & ")"" OnMouseOut=""vbMouseOut(tr" & rs0("ContactID") & ")"" OnClick=""vbEditContact(" & rs0("ContactID") & ")"">")
            Else
                pr ("<tr id=""tr" & rs0("ContactID") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & rs0("ContactID") & ")"" OnMouseOut=""vbMouseOut2(tr" & rs0("ContactID") & ")"" OnClick=""vbEditContact(" & rs0("ContactID") & ")"">")
            End If
            
            '-------------  To/Cc/Bcc ----------
            'pr ("<td nowrap width='20'><input type='checkbox' name='lstTO' value='" & RS0("ContactID") & "'></td>")
            'pr ("<td nowrap width='20'><input type='checkbox' name='lstCC' value='" & RS0("ContactID") & "'></td>")
            'pr ("<td nowrap width='20'><input type='checkbox' name='lstBCC' value='" & RS0("ContactID") & "'></td>")
            
'            If Len(Session("candidat_contactSearch")) > 0 Or Session("candidat_contactQuery") = "true" Then
'                If rs0("UserID") = 0 Then
'                    LType = "Company"
'                Else
'                    LType = "Personal"
'                End If
'                pr ("<td nowrap><a href=""contact.asp?mode=con_frmCandidat&ContactID=" & rs0("ContactID") & """>" & LType & "</a></td>")
'            End If
            
            For j = 3 To (rs0.Fields.Count - 1)
            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
                If Session("UserCommander") = 1 Then
                    pr ("<td nowrap><a href=""contact.asp?mode=CANDIDAT_CADDY&act=ajout&ContactID=" & rs0("ContactID") & """>" & "Cliquez ici" & " </a></td>")
                End If
            End If
             T_MyAtribut = Split(rs0(j).Name & "§", "§")
         If (MyAtribut(T_MyAtribut(0)) = False) Or (Session("candidat_UserType") = "Administrator") Then
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace("" & MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
 
                    If Session("candidat_UserType") <> "Anonyme" Then
                    
                        pr ("<td nowrap><a href=""contact.asp?mode=con_frmCandidat&ContactID=" & rs0("ContactID") & """>" & MyTxt & " </a></td>")
                    Else
                        If Session("UserCommander") = 1 Then
                             pr ("<td nowrap><a href=""contact.asp?mode=CANDIDAT_CADDY&act=ajout&ContactID=" & rs0("ContactID") & """ >" & MyTxt & " </a></td>")
                    Else
                        pr ("<td nowrap class=""A_Not_href"">" & MyTxt & " </td>")
                     End If

                    End If
                If Session("candidat_UserType") = "Administrator" Then
                    If j = rs0.Fields.Count - 1 Then
                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("ContactID") & "');"" >Cliquez ici </a></td>")
                    End If
                End If

            
            End If
            Next

            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '-----------------  ADD/REMOVE Category
    'pr ("<br>")
    'If Len(Session("candidat_SubCategory")) > 0 Then
    '    pr ("<a href=""javascript:javAddToCat()"">[Ajouter]</a>")
    '    pr ("<a href=""javascript:javRemoveFromCat()"">[Réaffecter]</a> ")
    'End If
        

    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
        INTLEFT = PageCount - 1
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        
        PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""HISTORIQUE_Eboutique_Affiche_Commande"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=con_lst&con_lstPage=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=con_lst&con_lstPage=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=con_lst&con_lstPage=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=con_lst&con_lstPage=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
    End If
    
    
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function
Public Function RaisonSicialEncelade(DSN)

Session("Cli") = Request("Id")
pr "<script language='javascript' >"
pr "function recopie()"
pr ""
pr "{"
pr "    var f = document.form_etape;"
pr ""
pr "    var id_pays = f.c_id_pays.options[f.c_id_pays.selectedIndex].value;"
pr "    var existe = false;"
pr "    var index = -1;"
pr "    f.l_beneficiaire.value = f.c_nom.value + "" "" + f.c_prenom.value;"
pr "    f.l_societe.value = f.c_societe.value;"
pr "    f.AddLiv1.value = f.AddFac1.value;"
pr "    f.AddLiv2.value = f.AddFac2.value;"
pr "    f.AddLiv3.value = f.AddFac3.value;"
pr "    f.l_cp.value = f.c_codepostal.value;"
pr "    f.l_ville.value = f.c_ville.value;"
pr "    f.l_id_pays.options.selectedIndex=f.c_id_pays.options.selectedIndex;"
pr "}"
pr "</script>"

    Set Conn = Server.CreateObject("adodb.connection")
    Dim Sql1 As String
    Conn.Open DSN
    Debug.Print Request("mode")
    pr "<script language='javascript'>"
pr "function valide()"
pr "{"
pr "    var f = document.form_etape;"
pr "    var ret = true;"

pr "    var err = """ & GetMessage("ErreursApparues", "Les erreurs suivantes sont apparues:", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    "
'pr "    if (f.c_NumIndiveClient.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += ""\nN° Client nom est vide"";"
'pr "    }"

pr "    if (f.c_nom.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("NomEstVide", "\nVotre nom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_prenom.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("PreNomEstVide", "\nVotre prénom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.AddFac1.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("AdressePersonnelleVide", "\nVotre adresse personnelle est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_codepostal.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_ville.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("NomVotreVilleVide", "\nLe nom de votre ville est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_id_pays.options.selectedIndex<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("PaysVotreAdressePersonnelleIncorrect", "\nLe Pays de votre adresse personnelle est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_codepostal.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "       err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    "
pr "    if (f.l_beneficiaire.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("NomBeneficiaireVide", "\nLe nom du bénéficiaire est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"

pr "    if (f.AddFac1.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("Votreadresselivraisionvide", "\nVotre adresse de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "        err += """ & GetMessage("CodePostalLivraisionVide", "\nLe code postal de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.l_cp.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("CodePostalLivraisionVide", "\nLe code postal de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.l_ville.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("NomVilleLivraisonVide", "\nLe nom de la ville de livraison est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.l_id_pays.options.selectedIndex<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("PaysAdresseLivraisonIncorrect", "\nLe Pays de l'adresse de livraison est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_phone.value.length<1)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("VotreTelEphoneVide", "\nVotre Téléphone est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "/*  if (!f.accepte.checked)"
pr "    {"
pr "        ret = false;"

pr "        err += """ & GetMessage("VousAvezPasAccepteConditionsGeneralesVente", "\nVous n'avez pas accepté les conditions générales de vente", DsnTableMenu(Session("candidat_ADOContact"))) & """"
pr "    }"
pr "*/"
'pr "    if (f.c_passwd1.value.length>1)"
'pr "    {"
'pr "        if (f.c_login.value.length<1)"
'pr "        {"
'pr "            ret = false;"
'pr "            err += ""\nVotre login est vide"";"
'pr "        }"
''pr "        if (f.c_passwd1.value!=f.c_passwd2.value)"
''pr "        {"
''pr "        ret = false;"
''pr "        err += ""\nVos mots de passe ne sont pas identiques"";"
''pr "        }"
'pr "    }"
'pr "    else"
'pr "    {"
'pr "        err += ""\nVotre mot de passe est vide"";"
'pr "    }"
pr "    if (ret)"
pr "    {"
pr "//      alert(""ok"");"
pr "        f.submit();"
pr "    }"
pr "    else"
pr "    {"
pr "        alert(err);"
pr "    }"
pr ""
pr "}"
pr "</script>"
    'Vérification du login & mot de passe
    If Trim(Request("act")) = "Update" Then
    
    SetDefault "EMAIL", safeEntry(Request("EMAIL")), DsnTableMenu(Session("candidat_ADOContact"))
    
    Sql = "UPDATE T_Raison_Sociale_Societe  "
    Sql = Sql & "SET T_Raison_Sociale_Societe.Nom = " & noquote2(Request("c_nom")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.pNom =" & noquote2(Request("c_prenom")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.RaisonSocialLiv = " & noquote2(Request("l_societe")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddLiv1 = " & noquote2(Request("AddLiv1")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddLiv2 = " & noquote2(Request("AddLiv2")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddLiv3 = " & noquote2(Request("AddLiv3")) & ",  "



    Sql = Sql & "T_Raison_Sociale_Societe.CpLiv = " & noquote2(Request("l_cp")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.VilleLiv = " & noquote2(Request("l_ville")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Id_Pays_Liv = " & noquote2(Request("l_id_pays")) & ",  "
    
    Sql = Sql & "T_Raison_Sociale_Societe.TelLiv = " & noquote2(Request("TelLiv")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.FaxLiv = " & noquote2(Request("FaxLiv")) & ",  "
''
    Sql = Sql & "T_Raison_Sociale_Societe.FormJuridique = " & noquote2(Request("FormJuridique")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Capital = " & noquote2(Request("Capital")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Creation = " & noquote2(Request("Creation")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.CodeApe = " & noquote2(Request("CodeApe")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Activite = " & noquote2(Request("Activite")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.RcsVille = " & noquote2(Request("RcsVille")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.RCS = " & noquote2(Request("RCS")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Siret = " & noquote2(Request("Siret")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.NumTva = " & noquote2(Request("NumTva")) & ",  "

    
    Sql = Sql & "T_Raison_Sociale_Societe.RaisonSocialFac = " & noquote2(Request("c_societe")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.beneficiaire = " & noquote2(Request("l_beneficiaire")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddFac1 = " & noquote2(Request("AddFac1")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddFac2 = " & noquote2(Request("AddFac2")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.AddFac3 = " & noquote2(Request("AddFac3")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.CpLiFac = " & noquote2(Request("c_codepostal")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.VilleFac = " & noquote2(Request("c_ville")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.Id_PaysFac = " & noquote2(Request("c_id_pays")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.TelFac = " & noquote2(Request("c_phone")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.FaxFac = " & noquote2(Request("c_Fax")) & ",  "
    
    Sql = Sql & "T_Raison_Sociale_Societe.Certif = " & noquote2(Request("Certif")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.OrganismeCertif = " & noquote2(Request("OrganismeCertif")) & ", "
    Sql = Sql & "T_Raison_Sociale_Societe.NumCertif = " & noquote2(Request("NumCertif")) & ",  "
    Sql = Sql & "T_Raison_Sociale_Societe.DateCertif = " & noquote2(Request("DateCertif")) & " "
    Sql = Sql & "WHERE T_Raison_Sociale_Societe.Societe='Entreprise';"

    Conn.Execute Sql

    End If
    If Request.Form("act") = "login" Then
   
        Sql = "SELECT users.UserID, users.NumIndiveClient,users.FirstName, users.Password, users.UserType "
        Sql = Sql & "From users "
        Sql = Sql & "WHERE users.UserLogin='" & Request("c_login") & "' "
        Sql = Sql & "AND  "
        Sql = Sql & "users.UserEmailPass='" & Request("c_password") & "'"

'        Sql = Sql & " WHERE UserLogin='" & Request("c_login") & "' "
'        Sql = Sql & " AND UserEmailPass='" & Request("c_password") & "'"
        Set Rs = Conn.Execute(Sql)
        If Not Rs.BOF Then
            Session("username") = Rs("FirstName")
            Session("UserId") = Rs("UserID")
            Session("c_password") = "" & Rs("Password")
            Session("NumIndiveClient") = "" & Rs("NumIndiveClient")
            is_client = -1
            Session("NewUser") = 0
        Else
        
            Session("username") = "guest"
            Session("candidat_caddy_etape") = Session("candidat_caddy_etape") - 1
            Response.Redirect ("Contact.asp?mode=Candidat_caddyRempli&mode2=validercommande&err=1&etape=" & Session("candidat_caddy_etape"))
            Session("NewUser") = 1
        End If
   End If

 
         
RepriseSql:
            Sql = "SELECT T_Raison_Sociale_Societe.* From T_Raison_Sociale_Societe WHERE T_Raison_Sociale_Societe.Societe='Entreprise';"
            Set cur = Conn.Execute(Sql)
            If cur.EOF = True Then
                Sql = "INSERT INTO T_Raison_Sociale_Societe ( Societe ) values( 'Entreprise');"
                Conn.Execute Sql
            GoTo RepriseSql
            End If
            
c_nom = "" & cur!Nom
c_prenom = "" & cur!pNom

l_id_pays = "47"

            
l_beneficiaire = "" & cur!beneficiaire
RaisonSocialFac = "" & cur!RaisonSocialFac
RaisonSocialLiv = "" & cur!RaisonSocialFac
AddLiv1 = "" & cur!AddLiv1
AddLiv2 = "" & cur!AddLiv2
AddLiv3 = "" & cur!AddLiv3
CpLiv = "" & cur!CpLiv
VilleLiv = "" & cur!VilleLiv
Id_Pays_Liv = "" & cur!Id_Pays_Liv
TelLiv = "" & cur!TelLiv
FaxLiv = "" & cur!FaxLiv
FormJuridique = "" & cur!FormJuridique
Capital = "" & cur!Capital
creation = "" & cur!creation
CodeApe = "" & cur!CodeApe
Activite = "" & cur!Activite
RcsVille = "" & cur!RcsVille
RCS = "" & cur!RCS
Siret = "" & cur!Siret
NumTva = "" & cur!NumTva
AddFac1 = "" & cur!AddFac1
AddFac2 = "" & cur!AddFac2
AddFac3 = "" & cur!AddFac3
CpLiFac = "" & cur!CpLiFac
VilleFac = "" & cur!VilleFac
Id_PaysFac = "" & cur!Id_PaysFac
TelFac = "" & cur!TelFac
FaxFac = "" & cur!FaxFac
Certif = "" & cur!Certif
OrganismeCertif = "" & cur!OrganismeCertif
NumCertif = "" & cur!NumCertif
DateCertif = "" & cur!DateCertif
 If val(Id_PaysFac) = 0 Then Id_PaysFac = 47
 If val(Id_Pays_Liv) = 0 Then Id_Pays_Liv = 47
'            If is_client > -1 Then
'            If Session("username") <> "guest" Then
'                If is_client = -1 Then
'                    Session("NewUser") = 1
'                Else
'                    Session("NewUser") = 0
'                End If
'                is_client = -1
'
'            Else
'                is_client = 0
'                Session("NewUser") = 1
'            End If
'            pr GetMenu2
            pr ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=" & GetDefault("con_bgcolor", "#DCC9B2", DsnTableMenu(Session("candidat_ADOContact"))) & " CELLPADDING=""0"" CELLSPACING=""0"">       ")

  pr ("<TR>       ")
'      pr "toto"
  pr ("<TD>       ")
  pr ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
  pr ("<TR>       ")
  pr ("<TD ALIGN=""LEFT"">       ")

  pr ("<font class='header'><b>" & UCase("Configuration Société") & " </b></font>")
'  pr("</B></FONT>       ")
  pr ("</TD>       ")
  
  
 
  pr ("<TD ALIGN=""RIGHT"">   &nbsp;</td>    ")
  
  pr ("</TR>       ")
  pr ("</TABLE>       ")
  pr ("</TD>       ")
  pr ("</TR>       ")
  pr ("</TABLE>       ")
                pr ("<form name='form_etape' action='Contact.asp?mode=RaisonSicialEncelade&Act=Update' method='post'>")
                
              
               
               
               
              
              
                
                pr ("<input type='hidden' name='modifie' value='0'>")
            
            'MESSAGE ERREUR EVENTUEL
            '=======================
        If Msg_Err <> "" Then pr ("<CENTER><FONT COLOR='RED'><B>" & Msg_Err & "</B></FONT></CENTER>")
        
        pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Contact") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
            
            
            
           pr ("<tr class='smalltext'><td width='26%'>" & translate("Nom") & ":</td>")
             pr ("<td width='74%'><input type='text' name='c_nom' value='" & c_nom & "' maxlength=40  size=20 class='champ'></td></tr>")
             pr ("<tr class='smalltext'><td width='26%'>" & translate("Prénom") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_prenom' value='" & c_prenom & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_phone' value='" & TelFac & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_Fax' value='" & FaxFac & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>Email:</td>")
            
             pr ("<td width='74%'><input type='text' name='email' value='" & GetDefault("email", "contact@euxia.net", DSN) & "'  maxlength=40  size=50 class='champ'></td></tr>")
             pr ("<tr><td colspan=2> &nbsp; </td></tr>")
              pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Adresse de facturation") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
            
              pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_societe' value='" & RaisonSocialFac & "' maxlength=40  size=20 class='champ'></td></tr>")
            
            
       
                 

  
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
            pr ("<td width='74%'><input type='text' name='AddFac1' value='" & AddFac1 & "' maxlength=150  size=50 class='champ'></td></tr>")
             pr ("<tr class='smalltext'><td width='26%'>&nbsp;</td>")
            pr ("<td width='74%'><input type='text' name='AddFac2' value='" & AddFac2 & "' maxlength=150  size=50 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>&nbsp;</td>")
            pr ("<td width='74%'><input type='text' name='AddFac3' value='" & AddFac3 & "' maxlength=150  size=50 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_codepostal' value='" & CpLiFac & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_ville' value='" & VilleFac & "' maxlength=60  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Pays") & ":</td>")
'
              pr ("<td width='74%'>")
            pr ("<select name='c_id_pays' class='champ'>")
                pr ("<option value='' selected>[" & translate("Choisissez") & "]")

                        Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
                        Set cur = Conn.Execute(Sql)
                        While Not cur.EOF
                            pr ("<option value=" & cur(0))
                                If (CInt(Id_PaysFac) = CInt(cur(0))) Or (CInt(Session("candidat_Fact_id_pays")) = CInt(cur(0))) Then
                                    pr ("SELECTED")
                                End If
                                pr (" >" & cur(1))
                            cur.MoveNext
                        Wend
                        Set cur = Nothing
                        pr ("</select></td></tr>")
            
            
           
            
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")


            ' COORDONNES DE LIVRAISON
            '========================
             pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Adresse de livraison") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr>")
                    pr ("<td colspan=""3"" align=""left""><span class='smallertext'><a href='javascript:recopie();'>")
                    pr ("<img src=""copiercoller.gif"" border=""0"" al=""" & translate("Recopier les informations personnelles") & """>&nbsp;&nbsp;" & translate("Recopier les informations personnelles") & "</a></span></td>")
                    pr ("<td>&nbsp;</td></tr>")
                    
                pr ("</table>")
            pr ("</td></tr>")
            
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' align=""right""><img src=""" & Session("candidat_EcomPathImages") & "cadeau.gif"" alt=""cadeau"">&nbsp;&nbsp;</td>")
'            pr ("<td width='74%'><input type='checkbox' value='1' name='l_kdo' class='champ'>" & translate("Cochez la case si cette commande est un cadeau") & "</td></tr>")
            pr ("<tr class='smalltext'>")
            
            
            pr ("<td width='26%'>" & translate("Soci&eacute;t&eacute;") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_societe' value='" & RaisonSocialLiv & "' maxlength=40  size=30 class='champ'></td></tr>")
            pr ("<tr class='smalltext'>")
            pr ("<td width='26%'>" & translate("B&eacute;n&eacute;ficiaire") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_beneficiaire' value='" & l_beneficiaire & "' maxlength=40  size=30 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
            pr ("<td width='74%'><input type='text' name='AddLiv1' value='" & AddLiv1 & "' maxlength=150  size=50 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>&nbsp;</td>")
            pr ("<td width='74%'><input type='text' name='AddLiv2' value='" & AddLiv2 & "' maxlength=150  size=50 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>&nbsp;</td>")
            pr ("<td width='74%'><input type='text' name='AddLiv3' value='" & AddLiv3 & "' maxlength=150  size=50 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_cp' value='" & CpLiv & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville:") & "</td>")
            pr ("<td width='74%'><input type='text' name='l_ville' value='" & VilleLiv & "' maxlength=60  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Pays") & ":</td><td width='74%'>")
'                          pr ("<td width='74%'>")
            pr ("<select name='l_id_pays' class='champ'>")
                pr ("<option value='' selected>[" & translate("Choisissez") & "]")

                        Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
                        Set cur = Conn.Execute(Sql)
                        While Not cur.EOF
                            pr ("<option value=" & cur(0))
                                If (CInt(Id_Pays_Liv) = CInt(cur(0))) Or (CInt(Session("candidat_Liv_id_pays")) = CInt(cur(0))) Then
                                    pr ("SELECTED")
                                End If
                                pr (" >" & cur(1))
                            cur.MoveNext
                        Wend
                        Set cur = Nothing
                        pr ("</select></td></tr>")
'            pr ("<input type='hidden' name='l_id_pays' value='" & Session("candidat_Fact_id_pays") & "'></td></tr>")
            pr (" </td></tr>")
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
             pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Fiche d´identit&eacute;") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
'
                pr ("</table>")
                pr ("<tr><td colspan=2> &nbsp; </td></tr>")
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Forme juridique") & ":</td>")
                pr ("<td width='74%'><input type='text' name='FormJuridique' value='" & FormJuridique & "' maxlength=40  size=30 class='champ'></td></tr>")
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Capital") & ":</td>")
                pr ("<td width='74%'><input type='text' name='Capital' value='" & Capital & "' maxlength=40  size=30 class='champ'></td></tr>")
                
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Cr&eacute;ation") & ":</td>")
                pr ("<td width='74%'><input type='text' name='Creation' value='" & creation & "' maxlength=40  size=30 class='champ'></td></tr>")
                
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Code APE") & ":</td>")
                pr ("<td width='74%'><input type='text' name='CodeAPE' value='" & CodeApe & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Activit&eacute;") & ":</td>")
                pr ("<td width='74%'><input type='text' name='Activite' value='" & Activite & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("RCS Ville") & ":</td>")
                pr ("<td width='74%'><input type='text' name='RCSVille' value='" & RcsVille & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("RCS") & ":</td>")
                pr ("<td width='74%'><input type='text' name='RCS' value='" & RCS & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("SIRET") & ":</td>")
                pr ("<td width='74%'><input type='text' name='Siret' value='" & Siret & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("N° TVA intercommunotaire") & ":</td>")
                pr ("<td width='74%'><input type='text' name='NumTva' value='" & NumTva & "' maxlength=40  size=30 class='champ'></td></tr>")
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Certification") & ":</td>")
                pr ("<td width='74%'><input type='text' name='Certif' value='" & Certif & "' maxlength=40  size=30 class='champ'></td></tr>")
            
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Organisme certificateur") & ":</td>")
                pr ("<td width='74%'><input type='text' name='OrganismeCertif' value='" & OrganismeCertif & "' maxlength=40  size=30 class='champ'></td></tr>")
            
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("N°") & ":</td>")
                pr ("<td width='74%'><input type='text' name='NumCertif' value='" & NumCertif & "' maxlength=40  size=30 class='champ'></td></tr>")
            
            
                pr ("<tr class='smalltext'>")
                pr ("<td width='26%'>" & translate("Date") & ":</td>")
                pr ("<td width='74%'><input type='text' name='DateCertif' value='" & DateCertif & "' maxlength=40  size=30 class='champ'></td></tr>")

                    pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")



            pr ("</td></tr>")
           
            
                
            
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' valign=""top"">" & translate("Message du cadeau") & ":</td>")
'            pr ("<td width='74%'><textarea name=""l_kdotxt"" cols=""40"" rows=""5"" wrap=""physical"" class=""champs"">&nbsp;</textarea></td></tr>")
            
'            pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
              
'            'CONDITIONS GENERALES DE VENTES
'            '==============================
'            pr ("<tr class=""smallertext"">")
'            pr ("<td>&nbsp;</td>")
'            pr ("<td>")
'            pr ("<input type='checkbox' name='accepte'>&nbsp;" & translate("J'accepte les") & "<a href='" & GetDefault("EcomPathCGV", "../portal_ecom/commander/conditions/conditions.html") & "' target='_blank'>")
'            pr (translate("conditions générales de vente") & "</a>&nbsp;")
'            pr ("</td></tr>")
            
            'pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
            
            pr ("</table>")
        
            'VALIDATION & COMMANDER
            '======================
        pr ("<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        pr ("<td align=""right""><a href='javascript:valide();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
         If val(Request("Id")) <> "0" Then
                      pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
                Else
                    If val("" & id_client) <> 0 Then
                        pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&id=" & id_client & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
                    End If
                End If
       
         pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLI'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>")
        pr ("</tr></table></form>")
            
            'INFORMATIONS LEGALES
            '====================
        pr ("<table border=""0"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""smallertext""><tr>")
        pr ("<td align=""left"">")
        pr ("Les informations qui vous concernent sont destinées à Encelade. Elles ne seront pas transmises à des tiers.")
        pr ("Vous disposez d'un droit d'accès, de modification, de rectification et de suppression des données qui vous concernent (art. 34 de la loi Informatique et Libertés)" & ".")
        pr ("Pour l'exercer, contactez-nous à" & " <a href=""mailto:" & GetDefault("EcomEmailContact", "contact@euxia.net", Session("candidat_ADOContact")) & """>" & Session("EcomEmailContact") & "</a></td>")
        pr ("</tr></table>")
        
        
    Conn.Close
    Set Conn = Nothing

End Function

Public Function CONFIGUSER()
Dim MyAtribut As New Collection
Dim Sql As String


    
       
           
    Response.Expires = 0
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Request("ID") & ";"
'        Sql = "DELETE t_R_Social.* From t_R_Social WHERE t_R_Social.SocieteId=" & Request("ID") & ";"

        GeneralTools.My_Conn.Execute Sql
        
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Request("id") & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
   currPageNum = GetDefault("CONFIG_User_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
      
 If Trim("" & Request("CONFIG_User_SortBy")) <> "" Then
        Session("CONFIG_User_SortBy") = Request("CONFIG_User_SortBy")
 End If
   If Trim("" & Session("CONFIG_User_SortBy")) = "" Then Session("CONFIG_User_SortBy") = GetDefault("SetDefauleCONFIGCLIUSERSortBy", "DateCreate", DsnTableMenu(Session("candidat_ADOContact")))
   

 '

    
    STRSQL = "SELECT Users.UserID, Users.Id_Societes,Users.DateCreate, Users.FirstName, Users.LastName ,  Users.UserEMail, Users.UserLogin, Users.UserEmailPass, Users.Rechercher, Users.Visualiser, Users.Commander, Users.Acheter, Users.Administrer, Users.phone, Users.Portable, Users.fax "

    STRSQL = STRSQL & "FROM t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "
    STRSQL = STRSQL & "WHERE t_R_Social.SocieteId=" & Session("id_client") & " "

    If Trim("" & Session("CONFIG_User_SortBy")) = "" Then
        STRSQL = STRSQL & "ORDER BY FirstName;"
    Else
        STRSQL = STRSQL & "ORDER BY Users." & ReplaceChamp(Session("CONFIG_User_SortBy"), True) & ";"
    End If



 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) as RecCount FROM Users "
    If val(Session("id_client")) <> 0 Then
    sqlcount = sqlcount & "WHERE users.Id_Societes=" & Session("id_client") & " "
    End If
    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("CONFIG_User_SortBy")) > 0 Then
'            Session("candidat_CONFIG_User_SortBy") = Request("CONFIG_User_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("CONFIG_User_SortBy")
'        ElseIf Len(Session("candidat_CONFIG_User_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CONFIGCLI_New';"
    pr "myForm.action='Contact.asp';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLIUSER';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGC_USER_NEW&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLIUSER&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLIUSERUSER&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLIUSER&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbEditContact(ID)")
    If Session("candidat_UserType") <> "Anonyme" Then
        pr ("   location.href = ""contact.asp?mode=CONFIGCLIUSER&act=edite&ID="" & ID")
    Else
        pr ("   location.href = ""contact.asp?mode=CONFIGCLIUSER&act=ajout&ID="" & ID")
    End If
    pr ("end function")
    
    pr ("</script>")

    '******** TitleBar
    pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLIUSER_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmSearch"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLIUSER"">")
     pr ("<input type=""hidden"" name=""Id"" value='" & Session("id_client") & "'>")
    
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Gestion des comptes Clients")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
    '***************** MESSAGE **********
    
    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If
    
    
    '***************** Command Bar **********
    pr ("<table bgcolor=""" & GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact")) & """ width=""100%"">")
    pr ("<tr>")
    pr ("<td nowrap>")
    If Session("portal_candidat_Recherhe") <> "1" Then
   End If
    pr ("</td></tr>")
    pr ("</table>")
    
    '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 2 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("CONFIG_User_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("CONFIG_User_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLIUSER&CONFIG_User_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLIUSER&CONFIG_User_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLIUSER&CONFIG_User_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>")
        End If
        If Session("candidat_UserType") = "Administrator" Then
            If I = rs0.Fields.Count - 1 Then
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLIUSER&CONFIG_User_SortBy=" & rs0(I).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
            End If
        End If
    Next
    pr ("</tr>")
    
    
    'On Error Resume Next
    
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("CONFIGCLIUSER_ClientPage") = INTPAGE
    End If
    
    If Len(Session("CONFIGCLIUSER_ClientPage")) > 0 Then
    If CInt(Session("CONFIGCLIUSER_ClientPage")) = 0 Then Session("CONFIGCLIUSER_ClientPage") = 1
        lstPage = CInt(Session("CONFIGCLIUSER_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
    If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""tr" & rs0("UserID") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & rs0("UserID") & ")"" OnMouseOut=""vbMouseOut(tr" & rs0("UserID") & ")"" OnClick=""vbEditContact(" & rs0("UserID") & ")"">")
            
            For j = 2 To (rs0.Fields.Count - 1)
'            If (j = 2) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGC_USER_NEW&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name) & ": " & Trim("" & rs0(j))
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                            If IsNumeric("" & MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                   
                    If Session("candidat_UserType") <> "Anonyme" Then
                        If UCase(rs0(j).Name) = UCase("Listerouge") Then
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGC_USER_NEW&sub=update&Id=" & rs0("UserID") & "&Listerouge=" & MyTxt & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGC_USER_NEW&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGC_USER_NEW&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")

                    End If
                If Session("candidat_UserType") = "Administrator" Then
                    If j = rs0.Fields.Count - 1 Then
                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
                    End If
                End If

            
            Next

            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLIUSER"">")
         pr ("<input type=""hidden"" name=""Id"" value='" & Session("id_client") & "'>")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CONFIGCLIUSER&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=CONFIGCLIUSER&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CONFIGCLIUSER&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=CONFIGCLIUSER&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
    End If
    
    
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function

Public Function CONFIGCLI()
Dim MyAtribut As New Collection
Dim Sql As String


    
       
           
    Response.Expires = 0
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Request("ID") & ";"
        Sql = "DELETE t_R_Social.* From t_R_Social WHERE t_R_Social.SocieteId=" & Request("ID") & ";"

        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE t_R_Social SET t_R_Social.Listerouge = False WHERE t_R_Social.SocieteId=" & Request("id") & " ;"
    Else
        Sql = "UPDATE t_R_Social SET t_R_Social.Listerouge = True WHERE t_R_Social.SocieteId=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
   currPageNum = GetDefault("CONFIGCLI_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
      
 If Trim("" & Request("CONFIGCLI_SortBy")) <> "" Then
        Session("CONFIGCLI_SortBy") = Request("CONFIGCLI_SortBy")
 End If
   If Trim("" & Session("CONFIGCLI_SortBy")) = "" Then Session("CONFIGCLI_SortBy") = GetDefault("SetDefauleCONFIGCLISortBy", "DateCreate", DsnTableMenu(Session("candidat_ADOContact")))
   

 '

    
    STRSQL = "SELECT  t_R_Social.SocieteId," & ChampsNameAs("FirstName", "Users", "Nom") & ", " & ChampsNameAs("LastName", "Users", "Prénom") & "," & ChampsNameAs("DateCreation", "t_R_Social", "Créé le") & ", t_R_Social.fld3 as Société,  "
    STRSQL = STRSQL & "t_R_Social.SocieteId as [Code Client]," & ChampsNameAs("UserEMail", "Users", "Contact email") & ",  "
    STRSQL = STRSQL & ChampsNameAs("UserLogin", "Users", "Contact login") & "," & ChampsNameAs("Listerouge", "t_R_Social", "Liste rouge") & "  "

    STRSQL = STRSQL & "FROM t_R_Social LEFT JOIN Users ON t_R_Social.Id_Contact = Users.UserID "
    If Trim("" & Session("CONFIGCLI_SortBy")) = "" Then
        STRSQL = STRSQL & "ORDER BY FirstName;"
    Else
        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("CONFIGCLI_SortBy"), "CONFIGCLI") & ";"
    End If


 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) as RecCount FROM t_R_Social "
    
    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("CONFIGCLI_SortBy")) > 0 Then
'            Session("candidat_CONFIGCLI_SortBy") = Request("CONFIGCLI_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("CONFIGCLI_SortBy")
'        ElseIf Len(Session("candidat_CONFIGCLI_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CON_lst';"
    pr "myForm.action='Contact.asp?mode=CON_lst';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLI';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbEditContact(ID)")
    If Session("candidat_UserType") <> "Anonyme" Then
        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
    Else
        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
    End If
    pr ("end function")
    
    pr ("</script>")

    '******** TitleBar
    pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmSearch"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Gestion des comptes Clients")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
    '***************** MESSAGE **********
    
    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If
    
    
    '***************** Command Bar **********
    pr ("<table bgcolor=""" & GetDefault("bglst", "#F3E6DD", Session("candidat_ADOContact")) & """ width=""100%"">")
    pr ("<tr>")
    pr ("<td nowrap>")
    If Session("portal_candidat_Recherhe") <> "1" Then
   End If
    pr ("</td></tr>")
    pr ("</table>")
    
    '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 3 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("CONFIGCLI_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("CONFIGCLI_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&CONFIGCLI_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&CONFIGCLI_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&CONFIGCLI_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>")
        End If
        If Session("candidat_UserType") = "Administrator" Then
            If I = rs0.Fields.Count - 1 Then
                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&CONFIGCLI_SortBy=" & rs0(I).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
            End If
        End If
    Next
    pr ("</tr>")
    
    
    'On Error Resume Next
    
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("CONFIGCLI_ClientPage") = INTPAGE
    End If
    
    If Len(Session("CONFIGCLI_ClientPage")) > 0 Then
    If CInt(Session("CONFIGCLI_ClientPage")) = 0 Then Session("CONFIGCLI_ClientPage") = 1
        lstPage = CInt(Session("CONFIGCLI_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
      
                pr ("<tr id=""tr" & rs0("SocieteId") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(tr" & rs0("SocieteId") & ")"" OnMouseOut=""vbMouseOut(tr" & rs0("SocieteId") & ")"" OnClick=""vbEditContact(" & rs0("SocieteId") & ")"">")
            
            For j = 3 To (rs0.Fields.Count - 1)
            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                    
                
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                   If UCase(rs0(j).Name) = "CODE CLIENT" Then MyTxt = Format(MyTxt, "000#")
                    If Session("candidat_UserType") <> "Anonyme" Then
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a href=""Contact.asp?mode=ConfigCLI&sub=update&Id=" & rs0("SocieteId") & "&Listerouge=" & MyTxt & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("SocieteId") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("SocieteId") & """>" & MyTxt & " </a></td>")

                    End If
                If Session("candidat_UserType") = "Administrator" Then
                    If j = rs0.Fields.Count - 1 Then
                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("SocieteId") & "');"" >Cliquez ici </a></td>")
                    End If
                End If

            
            Next

            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CONFIGCLI&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=CONFIGCLI&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CONFIGCLI&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=CONFIGCLI&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
    End If
    
    
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function
Public Function AfficheComGroupFour(CommandeFournisseurGroupe)
 Response.Expires = 0
     Session("CommandeFournisseurGroupe") = CommandeFournisseurGroupe
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
     pr ("<script language='javascript'>")
    
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    
    
 pr ("</script>")
 pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
 
  AfficheListeCommandDuJour CommandeFournisseurGroupe, DsnTableMenu(Session("candidat_ADOContact"))
'HISTORIQUE_Compte
'HISTORIQUE_Avenant
 pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
'   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function
Public Function HISTORIQUE_MENU()
 Response.Expires = 0
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
     pr ("<script language='javascript'>")
    
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    
    
 pr ("</script>")
 pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
 
  HISTORIQUE_Client
'HISTORIQUE_Compte
'HISTORIQUE_Avenant
 pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function

Public Function ListeCommandGroupee()
 Response.Expires = 0
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
     pr ("<script language='javascript'>")
    
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    
    
 pr ("</script>")
 pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
 
  HISTORIQUE_Comande_Groupee
'HISTORIQUE_Compte
'HISTORIQUE_Avenant
 pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
End Function
Public Function HISTORIQUE_EBOUTIQUE_FACTURE(Id As Long, DSN)
Dim MyAtribut As New Collection
Dim Sql As String

 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
      
Session("IdAvoire") = Id
   
   
  
       Set GeneralTools.My_Conn = OpenDb(DSN)

    
Sql = "SELECT t_R_Social.fld3,  t_R_Social.SocieteId, T_Num_Commande.NumCommande, T_Avoire.NumAvoire "
Sql = Sql & "FROM (t_R_Social INNER JOIN T_Num_Commande ON  t_R_Social.SocieteId = T_Num_Commande.UserID)  "
Sql = Sql & "INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Id & ";"


Set Rs = GeneralTools.My_Conn.Execute(Sql)
If Rs.EOF = False Then
    Societe = "" & Rs("fld3")
    NumCommande = "" & Rs("NumCommande")
    NumAvoire = "" & Rs("NumAvoire")
 End If
Rs.Close
Set Rs = Nothing
  currPageNum = GetDefault("HISTORIQUE_Eboutique_FACTURE_NB_Record", "25", DSN)
 'NumAvoire
   
 If Trim("" & Request("HISTORIQUE_Eboutique_FACTURE_SortBy")) <> "" Then
        Session("HISTORIQUE_Eboutique_FACTURE_SortBy") = Request("HISTORIQUE_Eboutique_FACTURE_SortBy")
 End If
   If Trim("" & Session("HISTORIQUE_Eboutique_FACTURE_SortBy")) = "" Then Session("HISTORIQUE_Eboutique_FACTURE_SortBy") = GetDefault("SetDefauleAvenantSortBy", "NumFacture", DsnTableMenu(Session("candidat_ADOContact")))
 '
 
 STRSQL = "SELECT T_Facturation_Cli.Id_Avoire, T_Facturation_Cli.NumFacture AS [N° Facture], T_Avoire.Credit AS [Motant Versé],  "
STRSQL = STRSQL & "T_Avoire.Debit AS [Motant Facture], [Credit]-[Debit] AS [Reste Payer] "
STRSQL = STRSQL & "FROM T_Avoire INNER JOIN T_Facturation_Cli ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire "
STRSQL = STRSQL & "Where T_Facturation_Cli.Id_Avoire = " & Id & " "
STRSQL = STRSQL & "GROUP BY T_Facturation_Cli.Id_Avoire, T_Facturation_Cli.NumFacture, T_Avoire.Credit,  "
STRSQL = STRSQL & "T_Avoire.Debit, [Credit]-[Debit], T_Avoire.NumAvoire  "
STRSQL = STRSQL & "ORDER BY T_Avoire.NumAvoire "

 
 
 'STRSQL = "SELECT T_Facturation_Cli.Id_Avoire, " & ChampsNameAs("NumFacture", "T_Facturation_Cli", "N° Facture") & ", Sum(T_Facturation_Cli.MotantVerse) AS [Motant Versé], "
'STRSQL = STRSQL & "Sum(T_Facturation_Cli.RestePayer) AS[Reste Payer], Sum(T_Facturation_Cli.MontantEncaiser) AS[Montant à Encaiser] "
'STRSQL = STRSQL & "FROM T_Avoire INNER JOIN T_Facturation_Cli ON T_Avoire.IdAvoire = T_Facturation_Cli.Id_Avoire "
'STRSQL = STRSQL & "WHERE T_Facturation_Cli.Id_Avoire=" & Id & " "
'STRSQL = STRSQL & "GROUP BY T_Facturation_Cli.Id_Avoire, T_Facturation_Cli.NumFacture ,NumAvoire "


'    If Trim("" & Session("HISTORIQUE_Eboutique_FACTURE_SortBy")) <> "" Then
'
'        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("HISTORIQUE_Eboutique_FACTURE_SortBy"), "HISTORIQUE_EBOUTIQUE_FACTURE") & ";"
'    End If
 
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Rq_Regroupe_Factuer.NumFacture) AS RecCount "
    sqlcount = sqlcount & "From Rq_Regroupe_Factuer "
    sqlcount = sqlcount & "WHERE Rq_Regroupe_Factuer.Id_Avoire=" & Id & ";"
    
    
    
'    sqlcount = "SELECT Count([T_Num_Commande].[IdNumCommande]) as RecCount "
'    sqlcount = sqlcount & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
'    sqlcount = sqlcount & "WHERE T_Num_Commande.IdNumCommande = " & Id & ";"

'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Eboutique_FACTURE_SortBy")) > 0 Then
'            Session("HISTORIQUE_Eboutique_FACTURE_SortBy") = Request("HISTORIQUE_Eboutique_FACTURE_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Eboutique_FACTURE_SortBy")
'        ElseIf Len(Session("HISTORIQUE_Eboutique_FACTURE_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")

    pr "function javAnnuler() {"
    pr "myForm = this.document.Annuler;"
        pr "myForm.mode.value = 'HISTORIQUE_Compte_Detail';"
     pr "myForm.Id.value = '" & Session("IdCommande") & "';"
    pr "myForm.action='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Session("IdCommande") & "&ModeFacture=" & Request("ModeFacture") & "';"
    pr "myForm.submit();"
    pr "}"

     
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
  pr "<form name=""Annuler"" method=""post"">"
  pr ("<input type=""hidden"" name=""mode"" value="""">") '
   pr ("<input type=""hidden"" name=""Id"" value="""">") '
   pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
   
   pr "</form>"
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
   
    pr ("<td align=""left"" valign=""middle"">")
    
    pr ("Liste des Commandes de l´Avenant: " & NumAvoire & " pour la Commande  N° : " & NumCommande & " de la Soci&eacute;t&eacute; : " & Societe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
      pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    pr "<form name""HisoDetailCommande"" method=""post"">"
'     pr ("<input type=""hidden"" name=""Id"" value=""" & Id & """>")
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUE_Eboutique_FACTURE_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_Eboutique_FACTURE_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_FACTURE_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_FACTURE_SortBy=" & rs0(I).Name & "+Desc&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_FACTURE_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Eboutique_FACTURE_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
    
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_FACTURE_SortBy=" & rs0(I - 1).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'>BL en cours</b></a></td>")
    
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("EBOUTIQUE_NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_Eboutique_CommandePage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_Eboutique_CommandePage")) > 0 Then
    If CInt(Session("HISTORIQUE_Eboutique_CommandePage")) = 0 Then Session("HISTORIQUE_Eboutique_CommandePage") = 1
        lstPage = CInt(Session("HISTORIQUE_Eboutique_CommandePage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CMD_FRM" & rs0("N° Facture") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CMD_FRM" & rs0("N° Facture") & ")"" OnMouseOut=""vbMouseOut(CMD_FRM" & rs0("N° Facture") & ")"" >") 'OnClick=""vbEditContact(" & rs0("IdNumCommande") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                        
                    If Session("candidat_UserType") <> "Anonyme" Then
'                    Société = "" & Rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Facture N : " & rs0("N° Facture") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Facture&RefFacture=" & rs0("N° Facture") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Facture N : " & rs0("N° Facture") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Facture&RefFacture=" & rs0("N° Facture") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Facture N : " & rs0("N° Facture") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Facture&RefFacture=" & rs0("N° Facture") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If

                href = "Contact.asp?mode=CreerAvenant&RefFacture=" & rs0("N° Facture")
            Next
            

            Sql = "SELECT t_Devis.numDevis "
            Sql = Sql & "FROM t_Devis INNER JOIN T_FACTURE_Liv ON t_Devis.Id = T_FACTURE_Liv.Id_Devis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("N° Facture"), True, True) & "' "
            Sql = Sql & "AND T_FACTURE_Liv.Reste=0;"

'            Sql = Sql & "AND t_Devis.numDevis='" & replaceAccent("" & Rs0("N° Facture"), True, True) & "';"
            Debug.Print Sql
            
            
            Sql = "SELECT t_Devis.numDevis, T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_FACTURE_Liv ON t_Devis.Id = T_FACTURE_Liv.Id_Devis)  "
            Sql = Sql & "LEFT JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("N° Facture"), True, True) & "' AND ( "
            Sql = Sql & "T_FACTURE_Liv.Reste=0 OR T_Frais_Transport.Frais=0 AND T_Frais_Transport.ModeTransport<> "
            Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "');"
            
            Sql = "SELECT t_Devis.numDevis, T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
            Sql = Sql & "LEFT JOIN T_FACTURE_Liv ON t_Devis.Id = T_FACTURE_Liv.Id_Devis "
            Sql = Sql & "WHERE t_Devis.numDevis='COM_38769_3 ' and " '" & replaceAccent("" & Rs0("N° Facture"), True, True) & "' AND ("
            
Sql = "SELECT t_Devis.numDevis, [t_Devis].[qte_produit]-[t_Devis].[Reste], T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_FACTURE_Liv ON t_Devis.Id = "
            Sql = Sql & "T_FACTURE_Liv.Id_Devis) LEFT JOIN T_Frais_Transport "
            Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("N° Facture"), True, True) & "' AND ("
            Sql = Sql & "T_Frais_Transport.Frais=0 AND T_Frais_Transport.ModeTransport="
            Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "' "
            Sql = Sql & "OR [t_Devis].[qte_produit]-[t_Devis].[Reste]<>0  "
            Sql = Sql & "OR T_FACTURE_Liv.Id Is Null);"

            

            Debug.Print Sql
            
'           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
'            If RsFlag.EOF = True Then
                pr ("<td nowrap>&nbsp</td>")

'            Else
'            pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Facture N : " & rs0("N° Facture") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Facture&RefFacture=" & rs0("N° Facture") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>")
'            End If
'
'            RsFlag.Close
'            Set RsFlag = Nothing
             
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
       
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
     pr ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0)) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        EBOUTIQUE_NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
       
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=1&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=" & PREVPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If EBOUTIQUE_NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=" & EBOUTIQUE_NEXTPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=" & PageCount & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
    pr AfficheAvenant(Id, GeneralTools.My_Conn)
    
    pr ("</body>")
    pr ("</html>")
    

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   End Function
   Public Function HISTORIQUE_EBOUTIQUE_COMMANDE(Id As Long, DSN)
Dim MyAtribut As New Collection
Dim Sql As String

 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
      
Session("IdAvoire") = Id
   
   
  
       Set GeneralTools.My_Conn = OpenDb(DSN)

    
Sql = "SELECT t_R_Social.fld3,  t_R_Social.SocieteId, T_Num_Commande.NumCommande, T_Avoire.NumAvoire "
Sql = Sql & "FROM (T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "INNER JOIN t_R_Social ON T_Num_Commande.IdSociete = t_R_Social.SocieteId "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Id & ";"


Set Rs = GeneralTools.My_Conn.Execute(Sql)
If Rs.EOF = False Then
    Societe = "" & Rs("fld3")
    NumCommande = "" & Rs("NumCommande")
    NumAvoire = "" & Rs("NumAvoire")
 End If
Rs.Close
Set Rs = Nothing
  currPageNum = GetDefault("HISTORIQUE_Eboutique_Commande_NB_Record", "25", DSN)
 'NumAvoire
   
 If Trim("" & Request("HISTORIQUE_Eboutique_Commande_SortBy")) <> "" Then
        Session("HISTORIQUE_Eboutique_Commande_SortBy") = Request("HISTORIQUE_Eboutique_Commande_SortBy")
 End If
   If Trim("" & Session("HISTORIQUE_Eboutique_Commande_SortBy")) = "" Then Session("HISTORIQUE_Eboutique_Commande_SortBy") = GetDefault("SetDefauleAvenantSortBy", "Ref Commande", DsnTableMenu(Session("candidat_ADOContact")))
 '
 STRSQL = "SELECT  t_Devis.id_caddie,t_Devis.numDevis AS [Ref Commande], Sum([qte_produit]*[PrixU_produit]) AS [Prix Total HT],  "
    STRSQL = STRSQL & "T_Frais_Transport.ModeTransport as [Mode de Transport]"
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN ((T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
    STRSQL = STRSQL & "INNER JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis) ON T_Num_Commande.IdNumCommande =  "
    STRSQL = STRSQL & "T_Avoire.IdNumCommande "
    STRSQL = STRSQL & "WHERE T_Avoire.IdAvoire=" & Id & " "
    STRSQL = STRSQL & "GROUP BY  t_Devis.id_caddie,T_Avoire.IdAvoire, t_Devis.numDevis, T_Frais_Transport.ModeTransport, T_Num_Commande.NumCommande ;"
    
    
    STRSQL = "SELECT MyForm2.id_caddie,MyForm2.[Ref Commande], [Total HT]+[Frais] AS [Prix Total HT], MyForm2.[Mode de Transport] "
    STRSQL = STRSQL & "FROM  "
    STRSQL = STRSQL & "(SELECT t_Devis.id_caddie, t_Devis.numDevis AS [Ref Commande], T_Frais_Transport.ModeTransport AS  "
    STRSQL = STRSQL & "[Mode de Transport], T_Frais_Transport.Frais, T_Avoire.NumAvoire "
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
    STRSQL = STRSQL & "T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande =  "
    STRSQL = STRSQL & "T_Avoire.IdNumCommande "
    
    STRSQL = STRSQL & "Where T_Avoire.IdAvoire = " & Id & " "
    
    STRSQL = STRSQL & "GROUP BY t_Devis.id_caddie, t_Devis.numDevis, T_Frais_Transport.ModeTransport, T_Avoire.IdAvoire,  "
    STRSQL = STRSQL & "T_Num_Commande.NumCommande, T_Frais_Transport.Frais, T_Avoire.NumAvoire "
    STRSQL = STRSQL & ") AS MyForm2 INNER JOIN  "
    
    STRSQL = STRSQL & "(select   "
    STRSQL = STRSQL & "t_Devis.id_caddie,t_Devis.numDevis AS [Ref Commande2], Sum([qte_produit]*[PrixU_produit]) AS [Total HT] "
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
    STRSQL = STRSQL & "T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande =  "
    STRSQL = STRSQL & "T_Avoire.IdNumCommande "
    
    STRSQL = STRSQL & "Where T_Avoire.IdAvoire = " & Id & " "
    
    STRSQL = STRSQL & "GROUP BY t_Devis.id_caddie, t_Devis.numDevis, T_Frais_Transport.ModeTransport, T_Avoire.IdAvoire,  "
    STRSQL = STRSQL & "T_Num_Commande.NumCommande"
    STRSQL = STRSQL & ") AS MyFrom ON MyForm2.[Ref Commande] = MyFrom.[Ref Commande2] "

STRSQL = "SELECT MyForm2.id_caddie, MyForm2.[Ref Commande], [Total HT]+[Frais] AS [Prix Total HT], [Expr2]+[Frais TTC] AS [Prix Total TTC],  "
    STRSQL = STRSQL & "MyForm2.[Mode de Transport] "
    STRSQL = STRSQL & "FROM (SELECT t_Devis.id_caddie, t_Devis.numDevis AS [Ref Commande], T_Frais_Transport.ModeTransport "
    STRSQL = STRSQL & "AS [Mode de Transport], T_Frais_Transport.Frais, [Frais]*(1+([T_Frais_Transport].[TVA]*(1/100)))  "
    STRSQL = STRSQL & "AS [Frais TTC], T_Avoire.NumAvoire "
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
    STRSQL = STRSQL & "T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande =  "
    STRSQL = STRSQL & "T_Avoire.IdNumCommande  "
    
    STRSQL = STRSQL & "Where T_Avoire.IdAvoire = " & Id & " "
    STRSQL = STRSQL & "GROUP BY t_Devis.id_caddie, t_Devis.numDevis, T_Frais_Transport.ModeTransport, T_Frais_Transport.Frais,  "
    STRSQL = STRSQL & "[Frais]*(1+([T_Frais_Transport].[TVA]*(1/100))), T_Avoire.NumAvoire, T_Avoire.IdAvoire, T_Num_Commande.NumCommande) AS MyForm2  "
    
    STRSQL = STRSQL & "INNER JOIN (SELECT t_Devis.id_caddie, t_Devis.numDevis AS [Ref Commande2], Sum([qte_produit]*[PrixU_produit]*(1-[t_Devis].[Remise])) AS [Total HT],  "
    STRSQL = STRSQL & "Sum([qte_produit]*[PrixU_produit]*(1-[t_Devis].[Remise])*(1+([t_Devis].[TVA]*(1/100)))) AS Expr2 "
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON  "
    STRSQL = STRSQL & "t_Devis.numDevis = T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande =  "
    STRSQL = STRSQL & "T_Avoire.IdNumCommande "
    
    STRSQL = STRSQL & "Where T_Avoire.IdAvoire = " & Id & " "
    STRSQL = STRSQL & "GROUP BY t_Devis.id_caddie, t_Devis.numDevis, T_Frais_Transport.ModeTransport, T_Avoire.IdAvoire,  "
    STRSQL = STRSQL & "T_Num_Commande.NumCommande) AS MyFrom ON MyForm2.[Ref Commande] = MyFrom.[Ref Commande2] "
    


    If Trim("" & Session("HISTORIQUE_Eboutique_Commande_SortBy")) <> "" Then

        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("HISTORIQUE_Eboutique_Commande_SortBy"), "HISTORIQUE_EBOUTIQUE_COMMANDE") & ";"
        
        
    End If
 
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Rq_Regroupe_Commande.numDevis) AS RecCount "
    sqlcount = sqlcount & "From Rq_Regroupe_Commande "
    sqlcount = sqlcount & "WHERE Rq_Regroupe_Commande.Id_Avoire=" & Id & ";"
    
    
    
'    sqlcount = "SELECT Count([T_Num_Commande].[IdNumCommande]) as RecCount "
'    sqlcount = sqlcount & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
'    sqlcount = sqlcount & "WHERE T_Num_Commande.IdNumCommande = " & Id & ";"

'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Eboutique_Commande_SortBy")) > 0 Then
'            Session("HISTORIQUE_Eboutique_Commande_SortBy") = Request("HISTORIQUE_Eboutique_Commande_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Eboutique_Commande_SortBy")
'        ElseIf Len(Session("HISTORIQUE_Eboutique_Commande_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")

    pr "function javAnnuler() {"
    pr "myForm = this.document.Annuler;"
        pr "myForm.mode.value = 'HISTORIQUE_Compte_Detail';"
     pr "myForm.Id.value = '" & Session("IdCommande") & "';"
    pr "myForm.action='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Session("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & "';"
    pr "myForm.submit();"
    pr "}"

     
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
  pr "<form name=""Annuler"" method=""post"">"
  pr ("<input type=""hidden"" name=""mode"" value="""">") '
   pr ("<input type=""hidden"" name=""Id"" value="""">") '
   pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
   
   pr "</form>"
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
   
    pr ("<td align=""left"" valign=""middle"">")
    
    pr ("Liste des Commandes de l´Avenant: " & NumAvoire & " pour la Commande  N° : " & NumCommande & " de la Soci&eacute;t&eacute; : " & Societe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
      pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    pr "<form name""HisoDetailCommande"" method=""post"">"
'     pr ("<input type=""hidden"" name=""Id"" value=""" & Id & """>")
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUE_Eboutique_Commande_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_Eboutique_Commande_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_Commande_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_Commande_SortBy=" & rs0(I).Name & "+Desc&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&HISTORIQUE_Eboutique_Commande_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Eboutique_Commande_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
    
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&Id=" & Id & "'>BL en cours</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&Id=" & Id & "'>Transport non int&eacute;gr&eacute;</b></a></td>")
    
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("EBOUTIQUE_NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_Eboutique_CommandePage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_Eboutique_CommandePage")) > 0 Then
    If CInt(Session("HISTORIQUE_Eboutique_CommandePage")) = 0 Then Session("HISTORIQUE_Eboutique_CommandePage") = 1
        lstPage = CInt(Session("HISTORIQUE_Eboutique_CommandePage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CMD_FRM" & rs0("Ref Commande") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CMD_FRM" & rs0("Ref Commande") & ")"" OnMouseOut=""vbMouseOut(CMD_FRM" & rs0("Ref Commande") & ")"" >") 'OnClick=""vbEditContact(" & rs0("IdNumCommande") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
             
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                   
                    If Session("candidat_UserType") <> "Anonyme" Then
'                    Société = "" & Rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Commande N : " & rs0("Ref Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & rs0("Ref Commande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Commande N : " & rs0("Ref Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & rs0("Ref Commande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Commande N : " & rs0("Ref Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & rs0("Ref Commande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If

                href = "Contact.asp?mode=CreerAvenant&RefCommande=" & rs0("Ref Commande")
            Next
            

            Sql = "SELECT t_Devis.numDevis "
            Sql = Sql & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("Ref Commande"), True, True) & "' "
            Sql = Sql & "AND T_Commande_Liv.Reste=0;"

'            Sql = Sql & "AND t_Devis.numDevis='" & replaceAccent("" & Rs0("Ref Commande"), True, True) & "';"
            Debug.Print Sql
            
            
            Sql = "SELECT t_Devis.numDevis, T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis)  "
            Sql = Sql & "LEFT JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("Ref Commande"), True, True) & "' AND ( "
            Sql = Sql & "T_Commande_Liv.Reste=0 OR T_Frais_Transport.Frais=0 AND T_Frais_Transport.ModeTransport<> "
            Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "');"
            
            Sql = "SELECT t_Devis.numDevis, T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_Frais_Transport ON t_Devis.numDevis = T_Frais_Transport.numDevis)  "
            Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
            Sql = Sql & "WHERE t_Devis.numDevis='COM_38769_3 ' and " '" & replaceAccent("" & Rs0("Ref Commande"), True, True) & "' AND ("
            
Sql = "SELECT t_Devis.numDevis, [t_Devis].[qte_produit]-[t_Devis].[Reste], T_Frais_Transport.Frais, T_Frais_Transport.ModeTransport "
            Sql = Sql & "FROM (t_Devis LEFT JOIN T_Commande_Liv ON t_Devis.Id = "
            Sql = Sql & "T_Commande_Liv.Id_Devis) LEFT JOIN T_Frais_Transport "
            Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis "
            Sql = Sql & "WHERE t_Devis.numDevis='" & replaceAccent("" & rs0("Ref Commande"), True, True) & "' AND ("
            Sql = Sql & "T_Frais_Transport.Frais=0 AND T_Frais_Transport.ModeTransport="
            Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "' "
            Sql = Sql & "OR [t_Devis].[qte_produit]-[t_Devis].[Reste]<>0  "
            Sql = Sql & "OR T_Commande_Liv.Id Is Null);"

            

            Debug.Print Sql
href = "<td nowrap><a  onMouseOver='message(""aller &agrave; Commande N : " & rs0("Ref Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & rs0("Ref Commande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div> </a></td>"
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("Ref Commande"), href, "CMDBl")
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("Ref Commande"), href, "CMDTrans")

'           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
'            If RsFlag.EOF = True Then
'                pr ("<td nowrap>&nbsp</td>")
'
'            Else
'            pr ("<td nowrap><a  onMouseOver='message(""aller &agrave; Commande N : " & rs0("Ref Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & rs0("Ref Commande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>")
'            End If
'
'            RsFlag.Close
'            Set RsFlag = Nothing
             
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
       
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
     pr ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0)) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        EBOUTIQUE_NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
       
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=1&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&EBOUTIQUE_NEXTPAGE=" & PREVPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If EBOUTIQUE_NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_EBOUTIQUE_COMMANDE&EBOUTIQUE_NEXTPAGE=" & EBOUTIQUE_NEXTPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&EBOUTIQUE_NEXTPAGE=" & PageCount & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
    pr AfficheAvenant(Id, GeneralTools.My_Conn)
    
    pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   End Function
   Public Function HISTORIQUE_Avenant(Id As Long, DSN)
Dim MyAtribut As New Collection
Dim Sql As String
Dim IsSoldeNegat As Boolean
Dim NoTraitement As Boolean

 Session("IdCommande") = Id
 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
      
           
   
   
  
       Set GeneralTools.My_Conn = OpenDb(DSN)

   
    
Sql = "SELECT t_R_Social.fld3,  t_R_Social.SocieteId, T_Num_Commande.NumCommande "
Sql = Sql & "FROM T_Num_Commande INNER JOIN t_R_Social ON T_Num_Commande.IdSociete = t_R_Social.SocieteId "
Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & Id & ";"

Set Rs = GeneralTools.My_Conn.Execute(Sql)
If Rs.EOF = False Then
    Societe = "" & Rs("fld3")
    NumCommande = "" & Rs("NumCommande")
 End If
Rs.Close
Set Rs = Nothing
  currPageNum = GetDefault("HISTORIQUE_Avenant_NB_Record", "25", DSN)
 
   
 If Trim("" & Request("HISTORIQUE_Avenant_SortBy")) <> "" Then
        Session("HISTORIQUE_Avenant_SortBy") = Request("HISTORIQUE_Avenant_SortBy")
 End If
   If Trim("" & Session("HISTORIQUE_Avenant_SortBy")) = "" Then Session("HISTORIQUE_Avenant_SortBy") = GetDefault("SetDefauleAvenantSortBy", "Avenant", DsnTableMenu(Session("candidat_ADOContact")))
 '
 STRSQL = "SELECT T_Avoire.IdNumCommande, T_Avoire.IdAvoire, T_Num_Commande.NumCommande as [N° Commande], T_Avoire.NumAvoire as Avenant, T_Avoire.Credit as [Credit TTC], "
    STRSQL = STRSQL & " T_Avoire.Debit as [Debit TTC], [Credit]-[Debit] AS [Solde TTC]," & ChampsNameAs("Cloturer", "T_Avoire", "Cloturé") & ", " & ChampsNameAs("Facturer", "T_Avoire", "Facturé") & " "
    STRSQL = STRSQL & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
    STRSQL = STRSQL & "WHERE T_Avoire.IdNumCommande=" & Id & " "

    If Trim("" & Session("HISTORIQUE_Avenant_SortBy")) = "" Then
        STRSQL = STRSQL & "ORDER BY IdAvoire;"
    Else
        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("HISTORIQUE_Avenant_SortBy"), "HISTORIQUE_Avenant") & ";"
    End If
 
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) as RecCount FROM  (Users LEFT JOIN T_Num_Commande ON Users.UserID = T_Num_Commande.UserID)  "
    sqlcount = sqlcount & "INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId "
    sqlcount = sqlcount & "Where Users.UserID = " & Id & " "
    
    
    
    sqlcount = "SELECT Count([T_Num_Commande].[IdNumCommande]) as RecCount "
    sqlcount = sqlcount & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
    sqlcount = sqlcount & "WHERE T_Num_Commande.IdNumCommande = " & Id & ";"

'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Avenant_SortBy")) > 0 Then
'            Session("HISTORIQUE_Avenant_SortBy") = Request("HISTORIQUE_Avenant_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Avenant_SortBy")
'        ElseIf Len(Session("HISTORIQUE_Avenant_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.Annuler;"
    pr "myForm.mode.value = 'HISTORIQUE_Compte';"
    pr "myForm.Id.value = '" & Session("Cli") & "';"
    pr "myForm.action='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Session("Cli") & "&ModeFacture=" & Request("ModeFacture") & "';"
    pr "myForm.submit();"
    pr "}"
    
    
     
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    pr ("</script>")
    pr "<form name=""Annuler"" method=""post"">"
    pr "<input type=""hidden"" name=""mode"" value="""">"
    pr "<input type=""hidden"" name=""Id"" value="""">"
    pr "<input type=""hidden"" name=""ModeFacture"" value='" & Request("ModeFacture") & "'>"
   
    pr "</form>"
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
  
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
   
    pr ("<td align=""left"" valign=""middle"">")
    
    pr ("Liste des Avenants pour la Commande  N° : " & NumCommande & " de la Soci&eacute;t&eacute; : " & Societe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
      pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    pr "<form name""HisoDetailCommande"" method=""post"">"


'     pr ("<input type=""hidden"" name=""Id"" value=""" & Id & """>")
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 2 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUE_Avenant_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_Avenant_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&HISTORIQUE_Avenant_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&HISTORIQUE_Avenant_SortBy=" & rs0(I).Name & "+Desc&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&HISTORIQUE_Avenant_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Avenant_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>BL en cours</b></a></td>")
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>Transport non int&eacute;gr&eacute;</b></a></td>")
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>G&eacute;n&eacute;rer facture</b></a></td>")
'    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>Avenant</b></a></td>")
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>Solde n&eacute;gatif</b></a></td>")
    
If Session("candidat_UserType") = "Administrator" Then
'          pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte_Detail&Id=" & Id & "'>Demande d´avenant</b></a></td>")
    End If
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("Avenant_NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_AvenantPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_AvenantPage")) > 0 Then
    If CInt(Session("HISTORIQUE_AvenantPage")) = 0 Then Session("HISTORIQUE_AvenantPage") = 1
        lstPage = CInt(Session("HISTORIQUE_AvenantPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
        If rs0![Solde TTC] < 0 Then
            IsSoldeNegat = True
        Else
            IsSoldeNegat = False
        End If
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""AVE_FRM" & rs0("IdAvoire") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(AVE_FRM" & rs0("IdAvoire") & ")"" OnMouseOut=""vbMouseOut(AVE_FRM" & rs0("IdAvoire") & ")"" >") 'OnClick=""vbEditContact(" & rs0("IdNumCommande") & ")"">")
            
            For j = 2 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp;" Else MyTxt = rs0(j)
                
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                        
                    If Session("candidat_UserType") <> "Anonyme" Then
'                    Société = "" & Rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller aux Commandes Imput&eacute;s &agrave; l´avenant N : " & rs0("Avenant") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Commande&ID=" & rs0("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller aux Commandes Imput&eacute;s &agrave; l´avenant N : " & rs0("Avenant") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Commande&ID=" & rs0("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller aux Commandes Imput&eacute;s &agrave; l´avenant N : " & rs0("Avenant") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Commande&ID=" & rs0("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If
                    href2 = "Contact.asp?mode=CreerAvenant&ID=" & rs0("IdAvoire")
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
           
          
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        Sql = "SELECT T_Avoire.Cloturer "
            Sql = Sql & "From T_Avoire "
            Sql = Sql & "WHERE T_Avoire.Cloturer=False  "
            Sql = Sql & "AND T_Avoire.IdAvoire=" & rs0("IdAvoire") & ";"

Debug.Print Sql

'Sql = "SELECT t_Devis.Id, T_Num_Commande.UserID, T_Num_Commande.NumCommande, U.UserID, A.numDevis, "
'Sql = Sql & "T.IdAvoire, t_Devis.Reste, T_Commande_Liv.Id "
'Sql = Sql & "FROM (T_Num_Commande INNER JOIN ((((T_Avoire LEFT JOIN "
'
'Sql = Sql & "(SELECT [Credit]-[Debit] AS FlagSold,  T_Num_Commande.UserID,  "
'Sql = Sql & "T_Avoire.Cloturer, T_Avoire.IdAvoire FROM T_Num_Commande LEFT JOIN T_Avoire  ON T_Num_Commande.IdNumCommande =  "
'Sql = Sql & "T_Avoire.IdNumCommande WHERE [Credit]-[Debit]<0) AS U "
'
'Sql = Sql & "ON T_Avoire.IdAvoire = U.IdAvoire)  "
'Sql = Sql & "LEFT JOIN "
'
'Sql = Sql & "(SELECT t_Devis.Id_Avoire, t_Devis.numDevis  FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id =  "
'Sql = Sql & "T_Commande_Liv.Id_Devis  WHERE T_Commande_Liv.Reste=0) AS A "
'
'Sql = Sql & "ON T_Avoire.IdAvoire = A.Id_Avoire) LEFT JOIN  "
'
'Sql = Sql & "(SELECT T_Avoire.IdAvoire, T_Frais_Transport.numDevis  FROM (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
'Sql = Sql & "t_Devis.Id_Avoire)  INNER JOIN T_Frais_Transport  ON t_Devis.numDevis = T_Frais_Transport.numDevis   "
'Sql = Sql & "WHERE T_Frais_Transport.ModeTransport=   "
'Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session ("candidat_ADOContact"))), True, True) & "' "
'Sql = Sql & "AND T_Frais_Transport.Frais=0)AS T "
'
'Sql = Sql & "ON T_Avoire.IdAvoire = T.IdAvoire) LEFT JOIN t_Devis ON T_Avoire.IdAvoire =  "
'Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
'Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
'
'
'Sql = Sql & "WHERE  T_Avoire.IdAvoire=" & rs0("IdAvoire") & " AND ("
'Sql = Sql & "U.UserID Is Not Null "
'Sql = Sql & "OR t_Devis.Id Is Not Null AND A.numDevis Is Null "
'Sql = Sql & "OR T.IdAvoire Is Not Null  "
'Sql = Sql & "OR t_Devis.Id Is Not Null AND U.UserID Is Null AND A.numDevis Is Null AND t_Devis.Reste<>0 "
'Sql = Sql & "OR t_Devis.Id Is Not Null AND T_Commande_Liv.Id Is Null);"
'
'
'
'Debug.Print Sql
'
'           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
'            If RsFlag.EOF = True Then
'                NoTraitement = True
'                pr ("<td nowrap>&nbsp</td>")
'
'            Else
'                pr ("<td nowrap><a  onMouseOver='message(""aller aux Commandes Imput&eacute;s &agrave; l´avenant N : " & rs0("Avenant") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Commande&ID=" & rs0("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>")
'            End If
             


href = "<td nowrap><a  onMouseOver='message(""aller aux Commandes Imput&eacute;s &agrave; l´avenant N : " & rs0("Avenant") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Eboutique_Commande&ID=" & rs0("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>"
pr FunEmpoule(GeneralTools.My_Conn, rs0("IdAvoire"), href, "BL")
pr FunEmpoule(GeneralTools.My_Conn, rs0("IdAvoire"), href, "Trans")
If Session("candidat_UserType") = "Administrator" Then
    pr FunEmpoule(GeneralTools.My_Conn, rs0("IdAvoire"), href2, "AVN", True)
Else
    pr FunEmpoule(GeneralTools.My_Conn, rs0("IdAvoire"), href, "AVN")
End If
pr FunEmpoule(GeneralTools.My_Conn, rs0("IdAvoire"), href, "FAC")
             pr ("</tr>")
             NoTraitement = False
'            RsFlag.Close
'            Set RsFlag = Nothing
            
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
     pr ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0)) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        Avenant_NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&Avenant_NEXTPAGE=1&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&Avenant_NEXTPAGE=" & PREVPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If Avenant_NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&Avenant_NEXTPAGE=" & Avenant_NEXTPAGE & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&Avenant_NEXTPAGE=" & PageCount & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   End Function
Public Function HISTORIQUE_Compte(DSN)
'Dim sql As String
'Dim Rs As Recordset
Dim IndexTr As Long
' Set Conn = Server.CreateObject("adodb.connection")
'    Conn.Open Dsn
'    sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
   
'sql = "SELECT Users.UserID FROM Users INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId;"

'Set Rs = Conn.Execute(sql)
'While Rs.EOF = False
If Request("ModeFacture") <> "" Then
End If
    HISTORIQUE_CompteDetal Request("Id"), IndexTr, DSN
'    Rs.MoveNext
'Wend
'Rs.Close
'Set Rs = Nothing

End Function
Public Function VoirPanier(DSN)
'Dim sql As String
'Dim Rs As Recordset
Dim IndexTr As Long
' Set Conn = Server.CreateObject("adodb.connection")
'    Conn.Open Dsn
'    sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
   
'sql = "SELECT Users.UserID FROM Users INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId;"

'Set Rs = Conn.Execute(sql)
'While Rs.EOF = False
If Request("ModeFacture") <> "" Then
End If
   VoirPanier = VoirPanierDetal(val("" & Session("UserId")), IndexTr, DSN)
'    Rs.MoveNext
'Wend
'Rs.Close
'Set Rs = Nothing

End Function


Public Function VoirPanierDetal(Id As Long, IndexTr As Long, DSN)
Dim MyAtribut As New Collection
Dim Sql As String
Session("Cli") = Id
 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE T_NumCadi.*, T_NumCadi.id From T_NumCadi WHERE T_NumCadi.id=" & Request("Cadie_ID") & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
            
             If Trim("" & Session("Id_Caddie_CadiDefault")) = Trim("" & Request("Cadie_ID")) Then
                Session("Id_Caddie_CadiDefault") = ""
            End If
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Id & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Id & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
Sql = "SELECT t_R_Social.fld3,  t_R_Social.SocieteId  From t_R_Social WHERE  t_R_Social.SocieteId=" & Id & ";"

Sql = "SELECT t_R_Social.fld3, Users.UserID "
Sql = Sql & "FROM t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.Id_Societes "
Sql = Sql & "WHERE Users.UserID=" & Id & ";"

Set Rs = GeneralTools.My_Conn.Execute(Sql)
If Rs.EOF = False Then Societe = "" & Rs("fld3")
Rs.Close
Set Rs = Nothing
  currPageNum = GetDefault("HISTORIQUE_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("VoirPanierDetal_SortBy")) <> "" Then
        Session("VoirPanierDetal_SortBy") = Request("VoirPanierDetal_SortBy")
 End If
 
   If Trim("" & Session("VoirPanierDetal_SortBy")) = "" Then Session("VoirPanierDetal_SortBy") = GetDefault("SetDefauleVoirPanierDetalSortBy", "Cadie", DsnTableMenu(Session("candidat_ADOContact")))
   
 '
' STRSQL = "SELECT  t_R_Social.SocieteId,T_Num_Commande.id, t_R_Social.NumIndiveClient AS [Code Client], t_R_Social.fld3 AS Société,  "
'    STRSQL = STRSQL & "T_Num_Commande.NumCommande AS [NumCadi], T_Num_Commande.Montantinitial AS [Montant initial],  "
'    STRSQL = STRSQL & ChampsNameAs("T_Num_Commande.CloturerCommande") & ", " & ChampsNameAs("T_Num_Commande.Verouiller") & ",  "
'    STRSQL = STRSQL & "T_Num_Commande.DateMiseEnService AS [Date de Création] "
'     STRSQL = STRSQL & "FROM (t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes) INNER JOIN T_Num_Commande ON t_R_Social.SocieteId = T_Num_Commande.IdSociete "
''    STRSQL = STRSQL & "FROM (Users LEFT JOIN T_Num_Commande ON Users.UserID = T_Num_Commande.UserID)  "
''    STRSQL = STRSQL & "INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId "
'    STRSQL = STRSQL & "Where Users.UserID = " & Id & " "


            STRSQL = "SELECT distinct T_NumCadi.id, T_NumCadi.NumCadi AS Cadie, Users_1.LastName, Users_1.FirstName, Users_1.UserLogin, Users_1.UserEMail AS Mail, T_NumCadi.DateCreation AS [Date de création], T_NumCadi.DateMiseaDisposition AS [validé le] "
            STRSQL = STRSQL & "FROM ((t_R_Social INNER JOIN Users AS Users_1 ON t_R_Social.SocieteId = Users_1.Id_Societes) INNER JOIN T_NumCadi ON Users_1.UserID = T_NumCadi.Id_User) INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "
If Session("UserAcheter") = 1 Then
            
            STRSQL = STRSQL & "WHERE  Users.UserID=" & Id & " "
            STRSQL = STRSQL & "AND Users.Acheter=True "
'STRSQL = STRSQL & "WHERE T_NumCadi.id Is Not Null  "
'            STRSQL = STRSQL & "AND T_NumCadi.DateMiseaDisposition  Is Not Null"
Else
             STRSQL = STRSQL & "WHERE T_NumCadi.id Is Not Null  "
            STRSQL = STRSQL & "AND Users_1.UserID=" & Id & " "
End If
            
            'STRSQL = STRSQL & "AND T_NumCadi.DateMiseaDisposition Is Null "
'    If Session("UserAcheter") = 0 Then
'      STRSQL = STRSQL & "AND t_R_Social.Id_Contact= " & Id & " "
'
'    End If

    If Trim("" & Session("VoirPanierDetal_SortBy")) <> "" Then
    
        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("VoirPanierDetal_SortBy"), "VoirPanierDetal") & ";"
    End If
 
            

          
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) AS RecCount "
sqlcount = sqlcount & "FROM ((t_R_Social LEFT JOIN Users AS Users_1 ON t_R_Social.SocieteId = Users_1.Id_Societes)  "
sqlcount = sqlcount & "LEFT JOIN T_NumCadi ON Users_1.UserID = T_NumCadi.Id_User) INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "

If Session("UserAcheter") = 1 Then
'         sqlcount = sqlcount & "WHERE T_NumCadi.id Is Not Null  "
'            sqlcount = sqlcount & "AND Users.UserID=" & Session("UserId") & "  "
'            sqlcount = sqlcount & "AND T_NumCadi.DateMiseaDisposition Is Not Null "
'            sqlcount = sqlcount & "OR Users.UserID=" & Id & "  "
'            sqlcount = sqlcount & "AND T_NumCadi.Id_User=" & Id & "  "
'            sqlcount = sqlcount & "AND Users.Acheter=True ;"
            
            
            
             sqlcount = sqlcount & "WHERE T_NumCadi.id Is Not Null  "
            sqlcount = sqlcount & "AND Users.UserID=" & Id & " "
Else
         sqlcount = "SELECT Count(*) AS RecCount From T_NumCadi WHERE T_NumCadi.Id_User=" & Id & ";"

End If
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("VoirPanierDetal_SortBy")) > 0 Then
'            Session("VoirPanierDetal_SortBy") = Request("VoirPanierDetal_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("VoirPanierDetal_SortBy")
'        ElseIf Len(Session("VoirPanierDetal_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<script language='javascript'>")
    
     

 VoirPanierDetal = VoirPanierDetal & vbCrLf & ("function javDelete(ID) {")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("        location.href = 'Contact.asp?mode=VoirPanier&sub=delete&Cadie_ID='+ID")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("    } else {")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("        return")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("    }")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("}")

If Session("candidat_UserType") = "Administrator" Then
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "function javAnnuler() {"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm = this.document.forms[0];"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.mode.value = 'Historiques';"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.action='Contact.asp?mode=Historiques';"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.submit();"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "}"
    Else
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "function javAnnuler() {"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm = this.document.forms[0];"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.mode.value = 'con_lst';"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.action='Contact.asp?mode=con_lst';"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "myForm.submit();"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "}"
    End If
    
     
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "function message(txt) {"
   VoirPanierDetal = VoirPanierDetal & vbCrLf & "top.status=txt;"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "}"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</script>")
    
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<script language=""VBscript"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("function vbMouseOver(a)")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("end function")
    
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("function vbMouseOut(a)")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("end function")
 VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</script>")
  
     VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<a name=""#Haut""></a>")

    '******** TitleBar
     VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<tr valign=""bottom"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<table width=""100%"" border=""0"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<tr valign=""bottom"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
     VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
   
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td align=""left"" valign=""middle"">")
    
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("Liste des N° de Cadies pour la Soci&eacute;t&eacute; : " & Societe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        VoirPanierDetal = VoirPanierDetal & vbCrLf & (strSearch)
    Else
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<font class=""header"">" & Catoption & "</font>")
    End If
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</td>")

    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
     VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
   
VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    VoirPanierDetal= VoirPanierDetal & vbcrlf & ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</td>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</form>")
      VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</tr>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</table>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</td>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</tr>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</table>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & "<form name""HisoDetailCommande"" method=""post"">"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
'     VoirPanierDetal= VoirPanierDetal & vbcrlf & ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>")
     '************** Headers ******
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp;"
        If InStr(UCase(Session("VoirPanierDetal_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("VoirPanierDetal_SortBy"), "Desc") Then
            
                VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a href='Contact.asp?mode=VoirPanier&VoirPanierDetal_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a href='Contact.asp?mode=VoirPanier&VoirPanierDetal_SortBy=" & rs0(I).Name & "+Desc&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a href='Contact.asp?mode=VoirPanier&VoirPanierDetal_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
            If I = rs0.Fields.Count - 1 Then
                VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a href='Contact.asp?mode=VoirPanier&VoirPanierDetal_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & "Supprime Fiche" & "</b></a></td>")
            End If
'        End If
    Next
    
    
     
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ VoirPanierDetal") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ VoirPanierDetal")) > 0 Then
    If CInt(Session("HISTORIQUE_ VoirPanierDetal")) = 0 Then Session("HISTORIQUE_ VoirPanierDetal") = 1
        lstPage = CInt(Session("HISTORIQUE_ VoirPanierDetal"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<tr id=""CLI_FRM" & rs0("id") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("id") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("id") & ")"" >") 'OnClick=""vbEditContact(" & rs0("id") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 VoirPanierDetal= VoirPanierDetal & vbcrlf & ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp;" Else MyTxt = rs0(j)
                 
                     If IsNumeric(Replace(MyTxt, ",", ".")) = True And rs0(j).Name <> "Code Client" Then MyTxt = FomatNum("" & MyTxt, 3)
               
                    If Session("candidat_UserType") <> "Anonyme" Then
'                    SOCIÉTÉ = "" & rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                          
                          
                            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("Cadie") & """);return true;' href=""Contact.asp?mode=Candidat_caddy&Id_Caddie_0=" & rs0("id") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                            
                        Else
                             VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("Cadie") & """);return true;' href=""Contact.asp?mode=Candidat_caddy&Id_Caddie_0=" & rs0("id") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("Cadie") & """);return true;' href=""Contact.asp?mode=Candidat_caddy&Id_Caddie_0=" & rs0("id") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If
'
                    If j = rs0.Fields.Count - 1 Then
                         VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td nowrap><a href=""javascript:javDelete('" & rs0("ID") & "');"" >Cliquez ici </a></td>")

                End If

            
            Next

 



            
            
            
            
            

VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</table>")
     VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0)) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            VoirPanierDetal= VoirPanierDetal & vbcrlf & ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' VoirPanierDetal= VoirPanierDetal & vbcrlf & ("<hr>")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<table border=""0"" cellspacing=""0"">")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td><a href=""Contact.asp?mode=VoirPanierDetal&NEXTPAGE=1" & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=VoirPanierDetal&NEXTPAGE=" & PREVPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td><a href=""Contact.asp?mode=VoirPanierDetal&NEXTPAGE=" & NEXTPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=VoirPanierDetal&NEXTPAGE=" & PageCount & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</tr>")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</form>")
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        VoirPanierDetal = VoirPanierDetal & vbCrLf & ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    VoirPanierDetal = VoirPanierDetal & vbCrLf & "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</body>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</body>")
    VoirPanierDetal = VoirPanierDetal & vbCrLf & ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   
End Function
Public Function HISTORIQUE_CompteDetal(Id As Long, IndexTr As Long, DSN)
Dim MyAtribut As New Collection
Dim Sql As String
Session("Cli") = Id
 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Id & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Id & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Id & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
Sql = "SELECT t_R_Social.fld3,  t_R_Social.SocieteId  From t_R_Social WHERE  t_R_Social.SocieteId=" & Id & ";"

Sql = "SELECT t_R_Social.fld3, Users.UserID "
Sql = Sql & "FROM t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.Id_Societes "
Sql = Sql & "WHERE Users.UserID=" & Id & ";"

Set Rs = GeneralTools.My_Conn.Execute(Sql)
If Rs.EOF = False Then Societe = "" & Rs("fld3")
Rs.Close
Set Rs = Nothing
  currPageNum = GetDefault("HISTORIQUE_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("HISTORIQUE_CompteDetal_SortBy")) <> "" Then
        Session("HISTORIQUE_CompteDetal_SortBy") = Request("HISTORIQUE_CompteDetal_SortBy")
 End If
   If Trim("" & Session("HISTORIQUE_CompteDetal_SortBy")) = "" Then Session("HISTORIQUE_CompteDetal_SortBy") = GetDefault("SetDefauleComptSortBy", "Code Client", DsnTableMenu(Session("candidat_ADOContact")))
 '
 STRSQL = "SELECT  t_R_Social.SocieteId,T_Num_Commande.IdNumCommande," & ChampsNameAs("SocieteId", "t_R_Social", "Code Client") & ", " & ChampsNameAs("fld3", "t_R_Social", "Société") & ",  "
    STRSQL = STRSQL & ChampsNameAs("NumCommande", "T_Num_Commande", "N° Commande") & " ,  " & ChampsNameAs("Montantinitial", "T_Num_Commande", "Montant initial TTC") & ",  "
    STRSQL = STRSQL & ChampsNameAs("CloturerCommande", "T_Num_Commande", "Cloturéée") & ", " & ChampsNameAs("Verouiller", "T_Num_Commande", "Verrouillée") & ",  "
    STRSQL = STRSQL & "T_Num_Commande.DateMiseEnService AS [Date de Création] "
     STRSQL = STRSQL & "FROM (t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes) INNER JOIN T_Num_Commande ON t_R_Social.SocieteId = T_Num_Commande.IdSociete "
'    STRSQL = STRSQL & "FROM (Users LEFT JOIN T_Num_Commande ON Users.UserID = T_Num_Commande.UserID)  "
'    STRSQL = STRSQL & "INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId "
    STRSQL = STRSQL & "Where Users.UserID = " & Id & " "
    If Session("UserAcheter") = 0 Then
      STRSQL = STRSQL & "AND t_R_Social.Id_Contact= " & Id & " "

    End If
    If Trim("" & Session("HISTORIQUE_CompteDetal_SortBy")) = "" Then
        STRSQL = STRSQL & "ORDER BY t_R_Social.fld3;"
    Else
        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("HISTORIQUE_CompteDetal_SortBy"), "HISTORIQUE_CompteDetal") & ";"
    End If
 
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) as RecCount FROM  (Users LEFT JOIN T_Num_Commande ON Users.UserID = T_Num_Commande.UserID)  "
    sqlcount = sqlcount & "INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId "
    sqlcount = sqlcount & "Where Users.UserID = " & Id & " "
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_CompteDetal_SortBy")) > 0 Then
'            Session("HISTORIQUE_CompteDetal_SortBy") = Request("HISTORIQUE_CompteDetal_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_CompteDetal_SortBy")
'        ElseIf Len(Session("HISTORIQUE_CompteDetal_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")

If Session("candidat_UserType") = "Administrator" Then
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'Historiques';"
    pr "myForm.action='Contact.asp?mode=Historiques';"
    pr "myForm.submit();"
    pr "}"
    Else
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'con_lst';"
    pr "myForm.action='Contact.asp?mode=con_lst';"
    pr "myForm.submit();"
    pr "}"
    End If
    
     
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
  
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
     pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
   
    pr ("<td align=""left"" valign=""middle"">")
    
    pr ("Liste des N° de Commande  pour la Soci&eacute;t&eacute; : " & Societe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
     pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
   
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
      pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    pr "<form name""HisoDetailCommande"" method=""post"">"
    pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
'     pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>")
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 2 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp;"
        If InStr(UCase(Session("HISTORIQUE_CompteDetal_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_CompteDetal_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte&HISTORIQUE_CompteDetal_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte&HISTORIQUE_CompteDetal_SortBy=" & rs0(I).Name & "+Desc&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Compte&HISTORIQUE_CompteDetal_SortBy=" & rs0(I).Name & "&Id=" & Id & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_CompteDetal_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
     pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Id & "'>BL en cours</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Id & "'>Transport non int&eacute;gr&eacute;</b></a></td>")
    pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Id & "'>G&eacute;n&eacute;rer facture</b></a></td>")
      pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Id & "'>Solde n&eacute;gatif</b></a></td>")
    
     
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CLI_FRM" & rs0("IdNumCommande") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("IdNumCommande") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("IdNumCommande") & ")"" >") 'OnClick=""vbEditContact(" & rs0("IdNumCommande") & ")"">")
            
            For j = 2 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp;" Else MyTxt = rs0(j)
                 
                     If IsNumeric(Replace(MyTxt, ",", ".")) = True And rs0(j).Name <> "Code Client" Then MyTxt = FomatNum("" & MyTxt, 3)
                        If UCase(rs0(j).Name) = "CODE CLIENT" Then MyTxt = Format(MyTxt, "000#")
                    If Session("candidat_UserType") <> "Anonyme" Then
                    SOCIÉTÉ = "" & rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                          
                          
                            pr ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & -rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
Sql = "SELECT [Credit]-[Debit] AS FlagSold, T_Num_Commande.UserID, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE ([Credit]-[Debit]<0 "
            Sql = Sql & "OR T_Avoire.Cloturer=False) "
            Sql = Sql & "AND T_Num_Commande.NumCommande='" & replaceAccent("" & rs0("N° Commande"), True, True) & "';"
            Debug.Print Sql

            
Sql = "SELECT t_Devis.Id, T_Num_Commande.UserID, T_Num_Commande.NumCommande, U.UserID, A.numDevis, "
Sql = Sql & "T.IdAvoire, t_Devis.Reste, T_Commande_Liv.Id "
Sql = Sql & "FROM (T_Num_Commande INNER JOIN ((((T_Avoire LEFT JOIN "

Sql = Sql & "(SELECT [Credit]-[Debit] AS FlagSold,  T_Num_Commande.UserID,  "
Sql = Sql & "T_Avoire.Cloturer, T_Avoire.IdAvoire FROM T_Num_Commande LEFT JOIN T_Avoire  ON T_Num_Commande.IdNumCommande =  "
Sql = Sql & "T_Avoire.IdNumCommande WHERE [Credit]-[Debit]<0) AS U "

Sql = Sql & "ON T_Avoire.IdAvoire = U.IdAvoire)  "
Sql = Sql & "LEFT JOIN "

Sql = Sql & "(SELECT t_Devis.Id_Avoire, t_Devis.numDevis  FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id =  "
Sql = Sql & "T_Commande_Liv.Id_Devis  WHERE T_Commande_Liv.Reste=0) AS A "

Sql = Sql & "ON T_Avoire.IdAvoire = A.Id_Avoire) LEFT JOIN  "

Sql = Sql & "(SELECT T_Avoire.IdAvoire, T_Frais_Transport.numDevis  FROM (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire)  INNER JOIN T_Frais_Transport  ON t_Devis.numDevis = T_Frais_Transport.numDevis   "
Sql = Sql & "WHERE T_Frais_Transport.ModeTransport=   "
Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "' "
Sql = Sql & "AND T_Frais_Transport.Frais=0)AS T "

Sql = Sql & "ON T_Avoire.IdAvoire = T.IdAvoire) LEFT JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "


Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & rs0("N° Commande"), True, True) & "' AND ("
Sql = Sql & "U.UserID Is Not Null "
Sql = Sql & "OR t_Devis.Id Is Not Null AND A.numDevis Is Null "
Sql = Sql & "OR T.IdAvoire Is Not Null  "
Sql = Sql & "OR t_Devis.Id Is Not Null AND U.UserID Is Null AND A.numDevis Is Null AND t_Devis.Reste<>0 "
Sql = Sql & "OR t_Devis.Id Is Not Null AND T_Commande_Liv.Id Is Null);"
            
            
            
            
             Debug.Print Sql
pr FunEmpoule(GeneralTools.My_Conn, replaceAccent("" & rs0("N° Commande"), True, True), "<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>", "CommBL")
pr FunEmpoule(GeneralTools.My_Conn, replaceAccent("" & rs0("N° Commande"), True, True), "<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>", "CommTrans")
pr FunEmpoule(GeneralTools.My_Conn, replaceAccent("" & rs0("N° Commande"), True, True), "<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>", "CommAvn")
pr FunEmpoule(GeneralTools.My_Conn, replaceAccent("" & rs0("N° Commande"), True, True), "<td nowrap><a  onMouseOver='message(""aller aux avenants de la Commande N° : " & rs0("N° Commande") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & rs0("IdNumCommande") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>", "CommFac")

pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
     pr ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0)) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>") '
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_CompteDetal&NEXTPAGE=1" & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_CompteDetal&NEXTPAGE=" & PREVPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUE_CompteDetal&NEXTPAGE=" & NEXTPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_CompteDetal&NEXTPAGE=" & PageCount & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   
End Function
Public Function AfficheListeCommandDuJour(CommandeFournisseurGroupe, DSN)
Dim MyAtribut As New Collection
Dim Sql As String
Session("CommandeFournisseurGroupe") = CommandeFournisseurGroupe
 Set GeneralTools.My_Conn = OpenDb(DSN)
    
      
           
   
   
 
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Id & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Id & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Id & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
'Sql = "SELECT T_Devis_Fournisseurs.id, T_Devis_Fournisseurs.RefGroupeCommande, T_Devis_Fournisseurs.numDevis "
'Sql = Sql & "From T_Devis_Fournisseurs "
'Sql = Sql & "WHERE T_Devis_Fournisseurs.RefGroupeCommande='" & CommandeFournisseurGroupe & "';"
'
'Set Rs = GeneralTools.My_Conn.Execute(Sql)
'
'Set Rs = Nothing
  currPageNum = GetDefault("CommandeFournisseur", "25", DSN)
 
   
 If Trim("" & Request("CommandeFournisseur_SortBy")) <> "" Then
        Session("CommandeFournisseur_SortBy") = Request("CommandeFournisseur_SortBy")
 End If

   If Trim("" & Session("CommandeFournisseur_SortBy")) = "" Then Session("CommandeFournisseur_SortBy") = GetDefault("SetDefauleCommandeFournisseurBy", "[Ref Groupe Commande]", DsnTableMenu(Session("candidat_ADOContact")))
 '
' STRSQL = "SELECT  t_R_Social.SocieteId,T_Num_Commande.IdNumCommande, Users.NumIndiveClient AS [Code Client], t_R_Social.fld3 AS Société,  "
'    STRSQL = STRSQL & "T_Num_Commande.NumCommande AS [N° Commande], T_Num_Commande.Montantinitial AS [Montant initial],  "
'    STRSQL = STRSQL & "T_Num_Commande.CloturerCommande AS Cloturer, T_Num_Commande.Verouiller,  "
'    STRSQL = STRSQL & "T_Num_Commande.DateMiseEnService AS [Date de Création] "
'    STRSQL = STRSQL & "FROM (Users LEFT JOIN T_Num_Commande ON Users.UserID = T_Num_Commande.UserID)  "
'    STRSQL = STRSQL & "INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId "
'    STRSQL = STRSQL & "Where Users.UserID = " & Id & " "
    
    STRSQL = "SELECT T_Devis_Fournisseurs.Id, T_Devis_Fournisseurs.[Date Commande], T_Devis_Four_Raison_Social.CatName AS Fournisseur,  "
    STRSQL = STRSQL & "T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Fournisseurs.Commande "
    STRSQL = STRSQL & "FROM T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Raison_Social ON T_Devis_Fournisseurs.Id =  "
    STRSQL = STRSQL & "T_Devis_Four_Raison_Social.Id_Com_Four "
    STRSQL = STRSQL & "WHERE T_Devis_Fournisseurs.[Ref Groupe Commande]='" & CommandeFournisseurGroupe & "' "
'    If Trim("" & Session("CommandeFournisseur_SortBy")) = "" Then
'        STRSQL = STRSQL & "ORDER BY t_R_Social.fld3;"
'    Else
        STRSQL = STRSQL & "ORDER BY " & ReplaceChamp(Session("CommandeFournisseur_SortBy"), "AfficheListeCommandDuJour") & ";"
'    End If
 
 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(*) as RecCount FROM  T_Devis_Fournisseurs "
    sqlcount = sqlcount & "WHERE T_Devis_Fournisseurs.[Ref Groupe Commande]='" & CommandeFournisseurGroupe & "'; "
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("CommandeFournisseur_SortBy")) > 0 Then
'            Session("CommandeFournisseur_SortBy") = Request("CommandeFournisseur_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("CommandeFournisseur_SortBy")
'        ElseIf Len(Session("CommandeFournisseur_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")

If Session("candidat_UserType") = "Administrator" Then
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'ListeCommandGroupee';"
    pr "myForm.action='Contact.asp?mode=ListeCommandGroupee';"
    pr "myForm.submit();"
    pr "}"
    Else
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'con_lst';"
    pr "myForm.action='Contact.asp?mode=con_lst';"
    pr "myForm.submit();"
    pr "}"
    End If
    
     
    pr "function message(txt) {"
   pr "top.status=txt;"
    pr "}"
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    pr ("function vbMouseOver(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """")
    pr ("end function")
    
    pr ("function vbMouseOut(a)")
    pr ("   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """")
    pr ("end function")
 pr ("</script>")
  
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">") '
   
    pr ("<td align=""left"" valign=""middle"">")
    
    pr ("Liste des Commandes pour le groupe de commande N° : " & CommandeFournisseurGroupe)
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
      pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    pr "<form name""HisoDetailCommande"" method=""post"">"
'     pr ("<input type=""hidden"" name=""Id"" value=""" & Id & """>")
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If UCase(Trim(Replace(Session("CommandeFournisseur_SortBy"), "Desc", ""))) = UCase(rs0(I).Name) Then
              
            If InStr(Session("CommandeFournisseur_SortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseur_SortBy=" & rs0(I).Name & "&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseur_SortBy=" & rs0(I).Name & "+Desc&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseur_SortBy=" & rs0(I).Name & "&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&CommandeFournisseur_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
'     pr ("<td nowrap><b><a href='Contact.asp?mode=HISTORIQUE_Compte&Id=" & Id & "'>En Traitement</b></a></td>")
 pr ("<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'>&Agrave; Valid&eacutee</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'>&Agrave; exp&eacute;di&eacute;e</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & CommandeFournisseurGroupe & "'>&Agrave; r&eacute;ceptionn&eacute;e</b></a></td>")
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CMF_FRM" & rs0("id") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CMF_FRM" & rs0("id") & ")"" OnMouseOut=""vbMouseOut(CMF_FRM" & rs0("id") & ")"" >") 'OnClick=""vbEditContact(" & rs0("id") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                     If IsNumeric(Replace(MyTxt, ",", ".")) = True Then MyTxt = FomatNum("" & MyTxt, 3)
                 
                    If Session("candidat_UserType") <> "Anonyme" Then
                    SOCIÉTÉ = "" & rs0("commande")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""Afficher la Commande N° : " & rs0("Commande") & """);return true;' href=""Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""Afficher la Commande N° : " & rs0("commande") & """);return true;' href=""Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""Afficher la Commande N° : " & rs0("Commande") & """);return true;' href=""Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
pr FunEmpouleFour(GeneralTools.My_Conn, "" & rs0("Commande"), "<td nowrap><b><a href='Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "ValDJ")
pr FunEmpouleFour(GeneralTools.My_Conn, "" & rs0("Commande"), "<td nowrap><b><a href='Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "EnvDJ")
pr FunEmpouleFour(GeneralTools.My_Conn, "" & rs0("Commande"), "<td nowrap><b><a href='Contact.asp?mode=AfficherCommande&ID=" & rs0("id") & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "BRDJ")

            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
     pr ("</form>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmCommadeFour"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CommandeFournisseur&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=CommandeFournisseur&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=CommandeFournisseur&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=CommandeFournisseur&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    pr ("</body>")
    pr ("</html>")

   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
    pr ("</body>")
    pr ("</html>")
   GeneralTools.My_Conn.Close
   Set GeneralTools.My_Conn = Nothing
   Session("CloseWhereOrder") = ""
    Session("CloseWhereFrom") = ""
   
End Function

Public Function HISTORIQUE_Client()
Dim MyAtribut As New Collection
Dim Sql As String


    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Request("ID") & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Request("id") & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
  currPageNum = GetDefault("HISTORIQUE_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("HISTORIQUE_Client_SortBy")) <> "" Then
        Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
 End If
   If Trim("" & Session("HISTORIQUEsSortBy")) = "" Then Session("HISTORIQUEsSortBy") = GetDefault("SetDefauleSortBy", "Société", DsnTableMenu(Session("candidat_ADOContact")))
 '
STRSQL = "SELECT Users.UserID,  " & ChampsNameAs("fld3", "t_R_Social", "Société") & ", " & ChampsNameAs("SocieteId", "t_R_Social", "Code Client") & " , "
    STRSQL = STRSQL & "t_R_Social.Address," & ChampsNameAs("Zip", "t_R_Social", "Cp") & ", t_R_Social.City AS Ville, " & ChampsNameAs("label_pays", "t_pays", "Pays") & ", " & ChampsNameAs("Listerouge", "t_R_Social", "Liste rouge") & " "
    STRSQL = STRSQL & "FROM Users INNER JOIN (t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) "
    STRSQL = STRSQL & "ON Users.UserID = t_R_Social.Id_Contact "
    If Session("HISTORIQUEsSortBy") = "" Then
        STRSQL = STRSQL & "ORDER BY t_R_Social.fld3;"
    Else
        
        STRSQL = STRSQL & "ORDER BY     " & ReplaceChamp(Session("HISTORIQUEsSortBy"), "HISTORIQUE_Client") & ";"
    End If

    
'    STRSQL = "SELECT Users.UserID, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Users.UserID) as RecCount FROM Users INNER JOIN (t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) ON Users.UserID = t_R_Social.Id_Contact;"

    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Client_SortBy")) > 0 Then
'            Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Client_SortBy")
'        ElseIf Len(Session("HISTORIQUEsSortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CON_lst';"
    pr "myForm.action='Contact.asp?mode=CON_lst';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLI';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    
    
'    pr ("function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'    pr ("end function")
    
    pr ("</script>")
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
    pr ("<input type=""hidden"" name=""ModeFacture"" value=""" & Request("ModeFacture") & """>")
    
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Liste des Clients")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUEsSortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUEsSortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "&ModeFacture=" & Request("ModeFacture") & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "+Desc&ModeFacture=" & Request("ModeFacture") & "'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "&ModeFacture=" & Request("ModeFacture") & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Client_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
     pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques&ModeFacture=" & Request("ModeFacture") & "'>BL en cours</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques&ModeFacture=" & Request("ModeFacture") & "'>Transport non int&eacute;gr&eacute; </b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques&ModeFacture=" & Request("ModeFacture") & "'>G&eacute;n&eacute;rer facture</b></a></td>")
        pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques&ModeFacture=" & Request("ModeFacture") & "'>Solde n&eacute;gatif</b></a></td>")
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CLI_FRM" & rs0("UserID") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("UserID") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("UserID") & ")"" >") 'OnClick=""vbEditContact(" & rs0("UserID") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                     If IsNumeric(Replace(MyTxt, ",", ".")) = True Then MyTxt = FomatNum("" & MyTxt, 3)
                  If UCase(rs0(j).Name) = UCase("Code Client") Then MyTxt = Format(MyTxt, "000#")
                    If Session("candidat_UserType") <> "Anonyme" Then
                    SOCIÉTÉ = "" & rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & "&ModeFacture=" & Request("ModeFacture") & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
            Sql = "SELECT [Credit]-[Debit] AS FlagSold, T_Num_Commande.UserID, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE ([Credit]-[Debit]<0 "
            Sql = Sql & "OR T_Avoire.Cloturer=False) "
            Sql = Sql & "AND T_Num_Commande.UserID=" & rs0("UserID") & ";"
            
          
           
            
            
 
            
      href = "<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & "&ModeFacture=" & Request("ModeFacture") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>"
            
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("UserID"), href, "CLIBL")
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("UserID"), href, "CLITrans")
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("UserID"), href, "CLIAvn")
pr FunEmpoule(GeneralTools.My_Conn, "" & rs0("UserID"), href, "CLIFAC")



            
'            Debug.Print Sql
'           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
'            If RsFlag.EOF = True Then
'                pr ("<td nowrap>&nbsp</td>")
'
'            Else
'
'            End If
'            RsFlag.Close
'            Set RsFlag = Nothing
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=1&ModeFacture=" & Request("ModeFacture") & """><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PREVPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & NEXTPAGE & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PageCount & "&ModeFacture=" & Request("ModeFacture") & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function
Public Function HISTORIQUE_Comande_Groupee()
Dim MyAtribut As New Collection
Dim Sql As String


    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.id From Users WHERE Users.id=" & Request("ID") & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.id=" & Request("id") & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.id=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
  currPageNum = GetDefault("HISTORIQUE_Comande_Groupee", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("HISTORIQUE_Comande_Groupee_SortBy")) <> "" Then
        Session("HISTORIQUE_Comande_GroupeeSortBy") = Request("HISTORIQUE_Comande_Groupee_SortBy")
 End If
 
   If Trim("" & Session("HISTORIQUE_Comande_GroupeeSortBy")) = "" Then Session("HISTORIQUE_Comande_GroupeeSortBy") = GetDefault("SetDefauleHISTORIQUE_Comande_GroupeeSortBy", "Date Commande", DsnTableMenu(Session("candidat_ADOContact")))
 '
STRSQL = "SELECT DISTINCT  T_Devis_Fournisseurs.[Ref Groupe Commande], T_Devis_Fournisseurs.[Date Commande] FROM T_Devis_Fournisseurs "
    If Session("HISTORIQUE_Comande_GroupeeSortBy") <> "" Then
       
        
        STRSQL = STRSQL & "ORDER BY  T_Devis_Fournisseurs." & ReplaceChamp(Session("HISTORIQUE_Comande_GroupeeSortBy"), "HISTORIQUE_Comande_Groupee") & ";"
    End If

    
'    STRSQL = "SELECT Users.id, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Myform.[Ref Groupe Commande]) AS RecCount "
    sqlcount = sqlcount & "FROM (SELECT DISTINCT  T_Devis_Fournisseurs.[Ref Groupe Commande] FROM T_Devis_Fournisseurs)  AS Myform;"

    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Comande_Groupee_SortBy")) > 0 Then
'            Session("HISTORIQUE_Comande_GroupeeSortBy") = Request("HISTORIQUE_Comande_Groupee_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Comande_Groupee_SortBy")
'        ElseIf Len(Session("HISTORIQUE_Comande_GroupeeSortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CON_lst';"
    pr "myForm.action='Contact.asp?mode=CON_lst';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLI';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_id") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_id") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    
    
'    pr ("function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'    pr ("end function")
    
    pr ("</script>")
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Liste des commandes group&eacute;es:")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 0 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If UCase(Trim(Replace("" & Session("HISTORIQUE_Comande_GroupeeSortBy"), "Desc", ""))) = UCase(UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_Comande_GroupeeSortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=ListeCommandGroupee&HISTORIQUE_Comande_Groupee_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=ListeCommandGroupee&HISTORIQUE_Comande_Groupee_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=ListeCommandGroupee&HISTORIQUE_Comande_Groupee_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Comande_Groupee_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
     pr ("<td nowrap><b><a href='Contact.asp?mode=ListeCommandGroupee'>&Agrave; valid&eacutee</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=ListeCommandGroupee'>&Agrave; exp&eacute;di&eacute;e</b></a></td>")
     pr ("<td nowrap><b><a href='Contact.asp?mode=ListeCommandGroupee'>&Agrave; r&eacute;ceptionn&eacute;e</b></a></td>")
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
'    currPageNum = 2
'    ENDITEM = 2
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_Comande_GroupeePage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_Comande_GroupeePage")) > 0 Then
    If CInt(Session("HISTORIQUE_Comande_GroupeePage")) = 0 Then Session("HISTORIQUE_Comande_GroupeePage") = 1
        lstPage = CInt(Session("HISTORIQUE_Comande_GroupeePage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CLI_FRM" & rs0("Ref Groupe Commande") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("Ref Groupe Commande") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("Ref Groupe Commande") & ")"" >") 'OnClick=""vbEditContact(" & Rs0("Ref Groupe Commande") & ")"">")
            
            For j = 0 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & Rs0("Ref Groupe Commande") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
               
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                       
                    If Session("candidat_UserType") <> "Anonyme" Then
                    Ref_Groupe_Commande = "" & rs0("Ref Groupe Commande")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            pr ("<td nowrap><a  onMouseOver='message(""Afficher la commande groupée N° : " & Ref_Groupe_Commande & """);return true;' href=""Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""Afficher la commande groupée N° : " & Ref_Groupe_Commande & """);return true;' href=""Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""Afficher la commande groupée N° : " & Ref_Groupe_Commande & """);return true;' href=""Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & Rs0("Ref Groupe Commande") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
         
            
          
           
            
            
 

               
pr FunEmpouleFour(GeneralTools.My_Conn, "" & Ref_Groupe_Commande, "<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "Val")
pr FunEmpouleFour(GeneralTools.My_Conn, "" & Ref_Groupe_Commande, "<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "Env")
pr FunEmpouleFour(GeneralTools.My_Conn, "" & Ref_Groupe_Commande, "<td nowrap><b><a href='Contact.asp?mode=AfficheComGroupFour&GCF=" & Ref_Groupe_Commande & "&CommandeFournisseurGroupe=" & Ref_Groupe_Commande & "'><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif"" border=""0""></div></b></a></td>", "BR")

            Set RsFlag = Nothing
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = Replace(RecCount / currPageNum, ",", ".")
    
    
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
'        INTLEFT = PageCount + 1
        
        If InStr(PageCount, ".") <> 0 Then
            PageCount = Left(PageCount, InStr(PageCount, ".") - 1)
           
         Else
            INTLEFT = 0
            PageCount = PageCount - 1
         End If
        
        PageCount = PageCount + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=ListeCommandGroupee&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=ListeCommandGroupee&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=ListeCommandGroupee&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=ListeCommandGroupee&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function
Public Function DetailAfficheCommandeDuJour()
Dim MyAtribut As New Collection
Dim Sql As String


    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Request("ID") & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Request("id") & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
  currPageNum = GetDefault("HISTORIQUE_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("HISTORIQUE_Client_SortBy")) <> "" Then
        Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
 End If
   If Trim("" & Session("HISTORIQUEsSortBy")) = "" Then Session("HISTORIQUEsSortBy") = GetDefault("SetDefauleSortBy", "Société", DsnTableMenu(Session("candidat_ADOContact")))
 '
STRSQL = "SELECT Users.UserID,  t_R_Social.fld3 AS Société, Users.NumIndiveClient AS [Code Client], "
    STRSQL = STRSQL & "t_R_Social.Address, t_R_Social.Zip AS Cp, t_R_Social.City AS Ville, t_pays.label_pays AS Pays, t_R_Social.Listerouge AS [Liste rouge] "
    STRSQL = STRSQL & "FROM (Users INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId) INNER  "
    STRSQL = STRSQL & "JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays "
    If Session("HISTORIQUEsSortBy") = "" Then
        STRSQL = STRSQL & "ORDER BY t_R_Social.fld3;"
    Else
        
        STRSQL = STRSQL & "ORDER BY     " & ReplaceChamp(Session("HISTORIQUEsSortBy"), "DetailAfficheCommandeDuJour") & ";"
    End If

    
'    STRSQL = "SELECT Users.UserID, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Users.UserID) as RecCount FROM Users INNER JOIN (t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) ON Users.UserID =  t_R_Social.SocieteId;"

    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Client_SortBy")) > 0 Then
'            Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Client_SortBy")
'        ElseIf Len(Session("HISTORIQUEsSortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CON_lst';"
    pr "myForm.action='Contact.asp?mode=CON_lst';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLI';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    
    
'    pr ("function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'    pr ("end function")
    
    pr ("</script>")
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Liste des Clients")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUEsSortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUEsSortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Client_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
     pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques'>En Traitement</b></a></td>")
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CLI_FRM" & rs0("UserID") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("UserID") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("UserID") & ")"" >") 'OnClick=""vbEditContact(" & rs0("UserID") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                        
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                     
                    If Session("candidat_UserType") <> "Anonyme" Then
                    SOCIÉTÉ = "" & rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
            Sql = "SELECT [Credit]-[Debit] AS FlagSold, T_Num_Commande.UserID, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE ([Credit]-[Debit]<0 "
            Sql = Sql & "OR T_Avoire.Cloturer=False) "
            Sql = Sql & "AND T_Num_Commande.UserID=" & rs0("UserID") & ";"
            
          
           
            
            
 

Sql = "SELECT t_Devis.Id, T_Num_Commande.UserID, T_Num_Commande.NumCommande, U.UserID, A.numDevis, "
Sql = Sql & "T.IdAvoire, t_Devis.Reste, T_Commande_Liv.Id "
Sql = Sql & "FROM (T_Num_Commande INNER JOIN ((((T_Avoire LEFT JOIN "

Sql = Sql & "(SELECT [Credit]-[Debit] AS FlagSold,  T_Num_Commande.UserID,  "
Sql = Sql & "T_Avoire.Cloturer, T_Avoire.IdAvoire FROM T_Num_Commande LEFT JOIN T_Avoire  ON T_Num_Commande.IdNumCommande =  "
Sql = Sql & "T_Avoire.IdNumCommande WHERE [Credit]-[Debit]<0) AS U "

Sql = Sql & "ON T_Avoire.IdAvoire = U.IdAvoire)  "
Sql = Sql & "LEFT JOIN "

Sql = Sql & "(SELECT t_Devis.Id_Avoire, t_Devis.numDevis  FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id =  "
Sql = Sql & "T_Commande_Liv.Id_Devis  WHERE T_Commande_Liv.Reste=0) AS A "

Sql = Sql & "ON T_Avoire.IdAvoire = A.Id_Avoire) LEFT JOIN  "

Sql = Sql & "(SELECT T_Avoire.IdAvoire, T_Frais_Transport.numDevis  FROM (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire)  INNER JOIN T_Frais_Transport  ON t_Devis.numDevis = T_Frais_Transport.numDevis   "
Sql = Sql & "WHERE T_Frais_Transport.ModeTransport=   "
Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "' "
Sql = Sql & "AND T_Frais_Transport.Frais=0)AS T "

Sql = Sql & "ON T_Avoire.IdAvoire = T.IdAvoire) LEFT JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "


Sql = Sql & "WHERE T_Num_Commande.UserID=" & rs0("UserID") & "AND ("
Sql = Sql & "U.UserID Is Not Null "
Sql = Sql & "OR t_Devis.Id Is Not Null AND A.numDevis Is Null "
Sql = Sql & "OR T.IdAvoire Is Not Null  "
Sql = Sql & "OR t_Devis.Id Is Not Null AND U.UserID Is Null AND A.numDevis Is Null AND t_Devis.Reste<>0 "
Sql = Sql & "OR t_Devis.Id Is Not Null AND T_Commande_Liv.Id Is Null);"
            
            
            

            
            Debug.Print Sql
           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                pr ("<td nowrap>&nbsp</td>")

            Else
            pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>")
            End If
            RsFlag.Close
            Set RsFlag = Nothing
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function
Public Function HISTORIQUE_GFC()
Dim MyAtribut As New Collection
Dim Sql As String


    
      
           
   
   
   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"

    
    Set rs0 = GeneralTools.My_Conn.Execute(Sql)
    If rs0.EOF = False Then
       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & rs0("Path")))

    End If
    Select Case Request("sub")
    Case "delete"
        Sql = "DELETE Users.*, Users.UserID From Users WHERE Users.UserID=" & Request("ID") & ";"
        GeneralTools.My_Conn.Execute Sql
            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
    Case "update"
    If Trim(Request("Listerouge")) = "OUI" Then
    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.UserID=" & Request("id") & " ;"
    Else
        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.UserID=" & Request("id") & " ;"
    End If
    GeneralTools.My_Conn.Execute Sql
End Select
  currPageNum = GetDefault("HISTORIQUE_NB_Record", "25", DsnTableMenu(Session("candidat_ADOContact")))
 
   
 If Trim("" & Request("HISTORIQUE_Client_SortBy")) <> "" Then
        Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
 End If
   If Trim("" & Session("HISTORIQUEsSortBy")) = "" Then Session("HISTORIQUEsSortBy") = GetDefault("SetDefauleSortBy", "Société", DsnTableMenu(Session("candidat_ADOContact")))
 '
STRSQL = "SELECT Users.UserID,  t_R_Social.fld3 AS Société, Users.NumIndiveClient AS [Code Client], "
    STRSQL = STRSQL & "t_R_Social.Address, t_R_Social.Zip AS Cp, t_R_Social.City AS Ville, t_pays.label_pays AS Pays, t_R_Social.Listerouge AS [Liste rouge] "
    STRSQL = STRSQL & "FROM (Users INNER JOIN t_R_Social ON Users.UserID =  t_R_Social.SocieteId) INNER  "
    STRSQL = STRSQL & "JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays "
    If Session("HISTORIQUEsSortBy") = "" Then
        STRSQL = STRSQL & "ORDER BY t_R_Social.fld3;"
    Else
        
        STRSQL = STRSQL & "ORDER BY     " & ReplaceChamp(Session("HISTORIQUEsSortBy"), "HISTORIQUE_GFC") & ";"
    End If

    
'    STRSQL = "SELECT Users.UserID, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = GeneralTools.My_Conn.Execute(STRSQL)
    sqlcount = "SELECT Count(Users.UserID) as RecCount FROM Users INNER JOIN (t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) ON Users.UserID =  t_R_Social.SocieteId;"

    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Client_SortBy")) > 0 Then
'            Session("HISTORIQUEsSortBy") = Request("HISTORIQUE_Client_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Client_SortBy")
'        ElseIf Len(Session("HISTORIQUEsSortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = GeneralTools.My_Conn.Execute(sqlcount)

    RecCount = RS11("RecCount")
    pr ("<script language='javascript'>")
'
    pr "function javAnnuler() {"
    pr "myForm = this.document.forms[0];"
    pr "myForm.mode.value = 'CON_lst';"
    pr "myForm.action='Contact.asp?mode=CON_lst';"
    pr "myForm.submit();"
    pr "}"
    
    
    pr ("function javCadyRempli() {")
    pr ("myForm = this.document.forms[0];")
    pr ("myForm.mode.value = 'Candidat_caddy';")
    pr ("myForm.action='Contact.asp?mode=CONFIGCLI';")
    pr ("myForm.submit();")
    pr ("}")
        
    pr ("function javSendEmail() {")
    pr ("   document.frm.submit()")
    pr ("}")
    
    pr ("function javSelectAll(chk) {")
    pr ("   len = document.frm.elements.length;")
    pr ("   var i=0;")
    pr ("   for( i=0; i<len; i++) {")
    pr ("       if (document.frm.elements[i].name=='lstTO') {")
    pr ("           document.frm.elements[i].checked=chk;")
    pr ("       }")
    pr ("   }")
    pr ("}")
    
    pr ("function javNewContact() {")
    pr ("   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'")
    pr ("}")
      
    pr ("function javResetSearch() {")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'")
    pr ("}")
    
    pr ("function javCat() {")
    pr ("   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value")
    pr ("   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID")
    pr ("}")
    
    pr ("function javAddToCat() {")
    pr ("   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
    pr ("function javRemoveFromCat() {")
    pr ("   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & 1 & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')")
    pr ("}")
    
     pr ("function javDelete(ID) {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    pr ("</script>")
    
    pr ("<script language=""VBscript"">")
    
    
'    pr ("function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'        pr ("   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'    pr ("end function")
    
    pr ("</script>")
     pr ("<a name=""#Haut""></a>")

    '******** TitleBar
     pr ("<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<td>")
    pr ("<table width=""100%"" border=""0"">")
    pr ("<tr valign=""bottom"">")
    pr ("<form name=""frmClient"" action=""Contact.asp"" method=""get"">")
    pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
    pr ("<td align=""left"" valign=""middle"">")
    pr ("Liste des Clients")
    
    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
        pr (strSearch)
    Else
        pr ("<font class=""header"">" & Catoption & "</font>")
    End If
    pr ("</td>")

    pr ("<td align=""right"" class=""smallerheader"" valign=""middle"">")
pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'    pr ("<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
    pr ("</td>")
    pr ("</form>")
    pr ("</tr>")
    pr ("</table>")
    pr ("</td>")
    pr ("</tr>")
    pr ("</table>")
    
     '************** Headers ******
    pr ("<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>")
    
    pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")

    For I = 1 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUEsSortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUEsSortBy"), "Desc") Then
            
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            Else
                pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>")
            End If
        Else
            
            pr ("<td nowrap><a href='Contact.asp?mode=Historiques&HISTORIQUE_Client_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>")
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'                pr ("<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Client_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
     pr ("<td nowrap><b><a href='Contact.asp?mode=Historiques'>En Traitement</b></a></td>")
    pr ("</tr>")
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
                pr ("<tr id=""CLI_FRM" & rs0("UserID") & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & rs0("UserID") & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & rs0("UserID") & ")"" >") 'OnClick=""vbEditContact(" & rs0("UserID") & ")"">")
            
            For j = 1 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                 pr ("<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("UserID") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                    
                    If Session("candidat_UserType") <> "Anonyme" Then
                    SOCIÉTÉ = "" & rs0("SOCIÉTÉ")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                            pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")
                        Else
                             pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")
                        End If
                    Else
                        pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """>" & MyTxt & " </a></td>")

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                         pr ("<td nowrap><a href=""javascript:javDelete('" & rs0("UserID") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next
            Sql = "SELECT [Credit]-[Debit] AS FlagSold, T_Num_Commande.UserID, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE ([Credit]-[Debit]<0 "
            Sql = Sql & "OR T_Avoire.Cloturer=False) "
            Sql = Sql & "AND T_Num_Commande.UserID=" & rs0("UserID") & ";"
            
          
           
            
            
 

Sql = "SELECT t_Devis.Id, T_Num_Commande.UserID, T_Num_Commande.NumCommande, U.UserID, A.numDevis, "
Sql = Sql & "T.IdAvoire, t_Devis.Reste, T_Commande_Liv.Id "
Sql = Sql & "FROM (T_Num_Commande INNER JOIN ((((T_Avoire LEFT JOIN "

Sql = Sql & "(SELECT [Credit]-[Debit] AS FlagSold,  T_Num_Commande.UserID,  "
Sql = Sql & "T_Avoire.Cloturer, T_Avoire.IdAvoire FROM T_Num_Commande LEFT JOIN T_Avoire  ON T_Num_Commande.IdNumCommande =  "
Sql = Sql & "T_Avoire.IdNumCommande WHERE [Credit]-[Debit]<0) AS U "

Sql = Sql & "ON T_Avoire.IdAvoire = U.IdAvoire)  "
Sql = Sql & "LEFT JOIN "

Sql = Sql & "(SELECT t_Devis.Id_Avoire, t_Devis.numDevis  FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id =  "
Sql = Sql & "T_Commande_Liv.Id_Devis  WHERE T_Commande_Liv.Reste=0) AS A "

Sql = Sql & "ON T_Avoire.IdAvoire = A.Id_Avoire) LEFT JOIN  "

Sql = Sql & "(SELECT T_Avoire.IdAvoire, T_Frais_Transport.numDevis  FROM (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire)  INNER JOIN T_Frais_Transport  ON t_Devis.numDevis = T_Frais_Transport.numDevis   "
Sql = Sql & "WHERE T_Frais_Transport.ModeTransport=   "
Sql = Sql & "'" & replaceAccent(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact"))), True, True) & "' "
Sql = Sql & "AND T_Frais_Transport.Frais=0)AS T "

Sql = Sql & "ON T_Avoire.IdAvoire = T.IdAvoire) LEFT JOIN t_Devis ON T_Avoire.IdAvoire =  "
Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "LEFT JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "


Sql = Sql & "WHERE T_Num_Commande.UserID=" & rs0("UserID") & "AND ("
Sql = Sql & "U.UserID Is Not Null "
Sql = Sql & "OR t_Devis.Id Is Not Null AND A.numDevis Is Null "
Sql = Sql & "OR T.IdAvoire Is Not Null  "
Sql = Sql & "OR t_Devis.Id Is Not Null AND U.UserID Is Null AND A.numDevis Is Null AND t_Devis.Reste<>0 "
Sql = Sql & "OR t_Devis.Id Is Not Null AND T_Commande_Liv.Id Is Null);"
            
            
            

            
            Debug.Print Sql
           Set RsFlag = GeneralTools.My_Conn.Execute(Sql)
            If RsFlag.EOF = True Then
                pr ("<td nowrap>&nbsp</td>")

            Else
            pr ("<td nowrap><a  onMouseOver='message(""aller Compte de la Soci&eacute;t&eacute : " & rs0("SOCIÉTÉ") & """);return true;' href=""Contact.asp?mode=HISTORIQUE_Compte&ID=" & rs0("UserID") & """><div align=""center""><img width=""20"" height=""20"" src=""Flag.gif""border=""0""></div> </a></td>")
            End If
            RsFlag.Close
            Set RsFlag = Nothing
            pr ("</tr>")
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
    pr ("</table>")
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'            pr ("<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       ' pr ("<hr>")
        pr ("<table border=""0"" cellspacing=""0"">")
        pr ("<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">")
        pr ("<input type=""hidden"" name=""mode"" value=""CONFIGCLI"">")
        pr ("<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>")
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
            pr ("<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>")
        
        If NEXTPAGE > PageCount Then
            pr ("<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>")
        Else
            pr ("<td><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUEs&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>")
        End If
        
        pr ("<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount)
        pr ("&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>")
        pr ("</tr>")
        pr ("</form>")
        pr ("</table>")
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
        pr ("<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & """><b>" & msg & "</b></font></center>")
    End If

    pr "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function

Public Function HISTORIQUE_BR(numDevis As String, Con)
Dim MyAtribut As New Collection
Dim Sql As String
Dim MyL As Long
On Error GoTo 0
    
      
           
   
   
'   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"
'
'
'    Set Rs0 = GeneralTools.My_Conn.Execute(Sql)
'    If Rs0.EOF = False Then
'       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs0("Path")))
'
'    End If
'    Select Case Request("sub")
'    Case "delete"
'        Sql = "DELETE Users.*, Users.numDevis From Users WHERE Users.numDevis=" & Request("ID") & ";"
'        GeneralTools.My_Conn.Execute Sql
'            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
'    Case "update"
'    If Trim(Request("Listerouge")) = "OUI" Then
'    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.numDevis=" & Request("id") & " ;"
'    Else
'        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.numDevis=" & Request("id") & " ;"
'    End If
'    GeneralTools.My_Conn.Execute Sql
'End Select
  currPageNum = GetDefault("HISTORIQUE_NB_BR_Record", "5", DsnTableMenu(Session("candidat_ADOContact")))

   
 If Trim("" & Request("HISTORIQUE_BR_SortBy")) <> "" Then
        Session("HISTORIQUEsBrSortBy") = Request("HISTORIQUE_BR_SortBy")
 End If
 
   If Trim("" & Session("HISTORIQUEsBrSortBy")) = "" Then Session("HISTORIQUEsBrSortBy") = GetDefault("HISTORIQUEsBrSortBy", "DateCration", DsnTableMenu(Session("candidat_ADOContact")))
 
STRSQL = "SELECT " & ChampsNameAs("NumBr", "T_BR", "N° Br") & ", " & ChampsNameAs("DateCration", "T_BR", "Créé le") & ", " & ChampsNameAs("BrMailDate", "T_BR", "Emal le") & ", " & ChampsNameAs("Solder", "T_BR", "Soldé le") & " "
    STRSQL = STRSQL & "From T_BR "
    STRSQL = STRSQL & "WHERE T_BR.Id_Com_Four=" & numDevis & " "
    STRSQL = STRSQL & "ORDER BY     " & ReplaceChamp(Session("HISTORIQUEsBrSortBy"), "HISTORIQUE_BR") & ";"
 

    
'    STRSQL = "SELECT Users.numDevis, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = Con.Execute(STRSQL)
    sqlcount = "SELECT Count(T_BR.Id) AS RecCount From T_BR "
    sqlcount = sqlcount & "WHERE T_BR.Id_Com_Four=" & numDevis & ";"
 


    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_BR_SortBy")) > 0 Then
            Session("HISTORIQUE_BR_SortBy") = Request("HISTORIQUE_BR_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_BR_SortBy")
'        ElseIf Len(Session("HISTORIQUE_BR_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = Con.Execute(sqlcount)

    RecCount = RS11("RecCount")
    
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<script language=""VBscript"">"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function vbMouseOver(a)"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "end function"
    
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function vbMouseOut(a)"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "end function"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</script>"
  
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<script language='javascript'>"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function message(txt) {"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   top.status=txt;"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & ""
   
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javAnnuler() {"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm = this.document.forms[0];"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.mode.value = 'CON_lst';"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.action='Contact.asp?mode=CON_lst';"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.submit();"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javCadyRempli() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm = this.document.forms[0];"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.mode.value = 'Candidat_caddy';"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.action='Contact.asp?mode=CONFIGCLI';"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "myForm.submit();"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
        
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javSendEmail() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   document.frm.submit()"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javSelectAll(chk) {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   len = document.frm.elements.length;"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   var i=0;"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   for( i=0; i<len; i++) {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "       if (document.frm.elements[i].name=='lstTO') {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "           document.frm.elements[i].checked=chk;"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "       }"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   }"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javNewContact() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
      
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javResetSearch() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javCat() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javAddToCat() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_numDevis") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javRemoveFromCat() {"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_numDevis") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
    
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "function javDelete(ID) {"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "    } else {"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "        return"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "    }"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "}"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</script>"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<script language=""VBscript"">"
    
    
'   HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'       HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'       HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'   HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "end function")
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</script>"
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<a name=""#Haut""></a>"

    '******** TitleBar
    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<tr valign=""bottom"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<table width=""100%"" border=""0"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<tr valign=""bottom"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<form name=""frmBL"" action=""Contact.asp"" method=""get"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<input type=""hidden"" name=""mode"" value=""HISTORIQUE_Eboutique_Affiche_Commande"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td align=""left"" valign=""middle"">"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "Liste des bons de r&eacute;ception."
    
'    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
'        pr (strSearch)
'    Else
'       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<font class=""header"">" & numDevis & "</font>"
'    End If
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</td>"

   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td align=""right"" class=""smallerheader"" valign=""middle"">"
'pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'   HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</td>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</form>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</tr>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</table>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</td>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</tr>"
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</table>"
    
     '************** Headers ******
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>"
    
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>"

    For I = 0 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUE_BR_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_BR_SortBy"), "Desc") Then
            
               HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a href='Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&HISTORIQUE_BR_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>"
            Else
               HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a href='Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&HISTORIQUE_BR_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>"
            End If
        Else
            
           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a href='Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&HISTORIQUE_BR_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>"
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'               HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_BR_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</tr>"
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
               HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<tr id=""CLI_FRM" & I & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & I & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & I & ")"" >" 'OnClick=""vbEditContact(" & rs0("N° Comm Encelade") & ")"">
            
            For j = 0 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("N° Comm Encelade") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
              Debug.Print rs0(j).Type
                If rs0(j).Type <> 11 Then
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                   End If
                    If Session("candidat_UserType") <> "Anonyme" Then
                   NumBr = "" & rs0("N° Br")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BR N° " & rs0("N° Br") & """);return true;' href=""Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&NumerBr=" & rs0("N° Br") & """>" & MyTxt & " </a></td>"
                        Else
                            HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BR N° " & rs0("N° Br") & """);return true;' href=""Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&NumerBr=" & rs0("N° Br") & """>" & MyTxt & " </a></td>"
                        End If
                    Else
                       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BR N° " & rs0("N° Br") & """);return true;' href=""Contact.asp?mode=AfficherCommande&Id=" & numDevis & "&NumerBr=" & rs0("N° Br") & """>" & MyTxt & " </a></td>"

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                        HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<td nowrap><a href=""javascript:javDelete('" & rs0("N° Comm Encelade") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next

           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</tr>"
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
   HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</table>"
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'           HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       'HISTORIQUE_BR=HISTORIQUE_BR &  vbcrlf & "<hr>")
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<table border=""0"" cellspacing=""0"">"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<input type=""hidden"" name=""mode"" value=""HISTORIQUE_Eboutique_Affiche_Commande"">"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<input type=""hidden"" name=""Id"" value=""" & numDevis & """>"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>"
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>"
        Else
           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&Id=" & numDevis & "&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&Id=" & numDevis & "&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>"
        End If
        
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>"
        
        If NEXTPAGE > PageCount Then
           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>"
        Else
           HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&Id=" & numDevis & "&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&Id=" & numDevis & "&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>"
        End If
        
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</tr>"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</form>"
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "</table>"
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
       HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & "><b>" & msg & "</b></font></center>"
    End If

    HISTORIQUE_BR = HISTORIQUE_BR & vbCrLf & "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function
Public Function HISTORIQUE_BL(numDevis As String, Con, BlExiste As Boolean)
Dim MyAtribut As New Collection
Dim Sql As String
Dim MyL As Long
On Error GoTo 0
 BlExiste = False
      
           
   
   
'   Sql = "SELECT BaseDefault.Path FROM BaseDefault;"
'
'
'    Set Rs0 = GeneralTools.My_Conn.Execute(Sql)
'    If Rs0.EOF = False Then
'       Set GeneralTools.My_Conn = OpenDb(Trim("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs0("Path")))
'
'    End If
'    Select Case Request("sub")
'    Case "delete"
'        Sql = "DELETE Users.*, Users.numDevis From Users WHERE Users.numDevis=" & Request("ID") & ";"
'        GeneralTools.My_Conn.Execute Sql
'            msg = GetMessage("SuppEnr", "L'enregistrement a bien &eacutet&eacute; supprim&eacute;.", DsnTableMenu(Session("candidat_ADOContact")))
'    Case "update"
'    If Trim(Request("Listerouge")) = "OUI" Then
'    Sql = "UPDATE Users SET t_R_Social.Listerouge = False WHERE Users.numDevis=" & Request("id") & " ;"
'    Else
'        Sql = "UPDATE Users SET t_R_Social.Listerouge = True WHERE Users.numDevis=" & Request("id") & " ;"
'    End If
'    GeneralTools.My_Conn.Execute Sql
'End Select
  currPageNum = GetDefault("HISTORIQUE_NB_BL_Record", "5", DsnTableMenu(Session("candidat_ADOContact")))

   
 If Trim("" & Request("HISTORIQUE_BL_SortBy")) <> "" Then
        Session("HISTORIQUEsBlSortBy") = Request("HISTORIQUE_BL_SortBy")
 End If
   If Trim("" & Session("HISTORIQUEsBlSortBy")) = "" Then Session("HISTORIQUEsBlSortBy") = GetDefault("SetDefauleBLSortBy", "Créé le", DsnTableMenu(Session("candidat_ADOContact")))
 
STRSQL = "SELECT DISTINCT " & ChampsNameAs("numDevis", "t_Devis", "N° Comm Encelade") & "," & ChampsNameAs("NumLiv", "T_Commande_Liv", "BL") & ", " & ChampsNameAs("creation", "T_Commande_Liv", "Créé le") & " "
    STRSQL = STRSQL & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis  "
    STRSQL = STRSQL & "Where t_Devis.numDevis = '" & numDevis & "' "
    If Session("HISTORIQUEsBlSortBy") = "" Then
        STRSQL = STRSQL & "ORDER BY T_Commande_Liv.creation;"

    Else
        
        STRSQL = STRSQL & "ORDER BY     " & ReplaceChamp(Session("HISTORIQUEsBlSortBy"), "HISTORIQUE_BL") & ";"
    End If

    
'    STRSQL = "SELECT Users.numDevis, Users.FirstName, Users.LastName, Users.DateCreate, Users.UserEMail, Users.UserDisplayName, "
'    STRSQL = STRSQL & "Users.UserLogin, Users.UserEmailPass, Users.NumIndiveClient,t_R_Social.Listerouge  "
'    STRSQL = STRSQL & "FROM Users "


 Set rs0 = Con.Execute(STRSQL)
    sqlcount = "SELECT Count([T_Commande_Liv].[Id]) AS RecCount "
        sqlcount = sqlcount & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
        sqlcount = sqlcount & "WHERE t_Devis.numDevis='" & numDevis & "';"


sqlcount = "SELECT Count([DEVIS].[NumLiv]) AS RecCount "
        sqlcount = sqlcount & "FROM (SELECT distinct t_Devis.numDevis, T_Commande_Liv.NumLiv "
        sqlcount = sqlcount & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis) AS DEVIS "
        sqlcount = sqlcount & "WHERE DEVIS.numDevis='" & numDevis & "';"



    
'    '***** Build sql
'    If Len(Session("candidat_contactSearch")) > 0 Then
'    End If
'        If Len(Request("HISTORIQUE_Bl_SortBy")) > 0 Then
            Session("HISTORIQUE_Bl_SortBy") = Request("HISTORIQUE_Bl_SortBy")
'            STRSQL = STRSQL & " ORDER BY " & Request("HISTORIQUE_Bl_SortBy")
'        ElseIf Len(Session("HISTORIQUE_Bl_SortBy")) > 0 Then
'
'        Else
'
'
'        End If
    '*********** Get record count
   
    Set RS11 = Con.Execute(sqlcount)

    RecCount = RS11("RecCount")
    
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<script language=""VBscript"">"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function vbMouseOver(a)"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   a.style.backgroundcolor = """ & GetDefault("mouseover", "#AFB4DC", Session("candidat_ADOContact")) & """"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "end function"
    
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function vbMouseOut(a)"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   a.style.backgroundcolor = """ & GetDefault("mouseout", "#DBDEF1", Session("candidat_ADOContact")) & """"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "end function"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</script>"
  
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<script language='javascript'>"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function message(txt) {"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   top.status=txt;"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & ""
   
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javAnnuler() {"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm = this.document.forms[0];"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.mode.value = 'CON_lst';"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.action='Contact.asp?mode=CON_lst';"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.submit();"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javCadyRempli() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm = this.document.forms[0];"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.mode.value = 'Candidat_caddy';"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.action='Contact.asp?mode=CONFIGCLI';"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "myForm.submit();"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
        
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javSendEmail() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   document.frm.submit()"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javSelectAll(chk) {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   len = document.frm.elements.length;"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   var i=0;"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   for( i=0; i<len; i++) {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "       if (document.frm.elements[i].name=='lstTO') {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "           document.frm.elements[i].checked=chk;"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "       }"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   }"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javNewContact() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   location.href = 'contact.asp?mode=CONFIGCLI_New&ID=0'"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
      
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javResetSearch() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   location.href = 'Contact.asp?mode=CONFIGCLI&reset=true'"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javCat() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   var ID = document.frmSearch.ID.options[document.frmSearch.ID.selectedIndex].value"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   location.href = 'Contact.asp?mode=CONFIGCLI_New&ID=' + ID"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javAddToCat() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   window.open('con_dlgAddToCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_numDevis") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javRemoveFromCat() {"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "   window.open('con_dlgRemoveFromCat.asp?ID=" & Session("candidat_SubCategory") & "&sid=" & Session("candidat_web_numDevis") & "&ListType=" & Session("candidat_Category") & "','dlgcat','resizable=yes,status=no,top=200,left=200,width=300,height=400')"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
    
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "function javDelete(ID) {"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "        location.href = 'Contact.asp?mode=CONFIGCLI&sub=delete&ID='+ID"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "    } else {"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "        return"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "    }"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "}"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</script>"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<script language=""VBscript"">"
    
    
'   HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "function vbEditContact(ID)")
'    If Session("candidat_UserType") <> "Anonyme" Then
'       HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "   location.href = ""contact.asp?mode=CONFIGCLI&act=edite&ID="" & ID")
'    Else
'       HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "   location.href = ""contact.asp?mode=CONFIGCLI&act=ajout&ID="" & ID")
'    End If
'   HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "end function")
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</script>"
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<a name=""#Haut""></a>"

    '******** TitleBar
    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<table width=""100%"" border=""2"" bgcolor=""" & GetDefault("CONFIGCLI_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<tr valign=""bottom"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<table width=""100%"" border=""0"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<tr valign=""bottom"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<form name=""frmBL"" action=""Contact.asp"" method=""get"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<input type=""hidden"" name=""mode"" value=""HISTORIQUE_Eboutique_Affiche_Commande"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td align=""left"" valign=""middle"">"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "Liste des BL"
    
'    If (Len(Session("candidat_contactSearch")) > 0) Or (Session("candidat_contactQuery") = "true") Or (Session("Encelade_contactSearch") = "true") Then
'        pr (strSearch)
'    Else
'       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<font class=""header"">" & numDevis & "</font>"
'    End If
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</td>"

   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td align=""right"" class=""smallerheader"" valign=""middle"">"
'pr ("<input type=""button""  class=""cmdflat""   value=""Annuler"" onClick=""javAnnuler()"">")
        If Session("candidat_UserType") = "Administrator" Then
'   HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<input type=""button""  class=""cmdflat""   value=""Nouveau"" onClick=""javNewContact()"">")
    End If
     Set CaddyConn = Nothing
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</td>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</form>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</tr>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</table>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</td>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</tr>"
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</table>"
    
     '************** Headers ******
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<table border=""0"" width=""100%"" cellspacing=""1"" bgcolor=""" & GetDefault("bglstheadertr", "silver", Session("candidat_ADOContact")) & """>"
    
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>"

    For I = 0 To rs0.Fields.Count - 1
        MyTxt = getHeading(rs0(I).Name)
        If Trim(MyTxt) = "" Then MyTxt = "&nbsp"
        If InStr(UCase(Session("HISTORIQUE_Bl_SortBy")), UCase(rs0(I).Name)) Then
              
            If InStr(Session("HISTORIQUE_Bl_SortBy"), "Desc") Then
            
               HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&HISTORIQUE_Bl_SortBy=" & rs0(I).Name & "'><img src='SortDesc.gif' border='0'><b>" & MyTxt & "</b></a></td>"
            Else
               HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&HISTORIQUE_Bl_SortBy=" & rs0(I).Name & "+Desc'><img src='SortAss.gif' border='0'><b>" & MyTxt & "</b></a></td>"
            End If
        Else
            
           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a href='Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&HISTORIQUE_Bl_SortBy=" & rs0(I).Name & "'><b>" & MyTxt & "</b></a></td>"
        End If
'        If Session("candidat_UserType") = "Administrator" Then
'            If i = rs0.Fields.Count - 1 Then
'               HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<td nowrap><a href='Contact.asp?mode=CONFIGCLI&HISTORIQUE_Bl_SortBy=" & rs0(i).Name & "'><b>" & "Supprime Fiche" & "</b></a></td>")
'            End If
'        End If
    Next
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</tr>"
    
    
     
    '************  Initiate page counter
    
    lstPage = 1
    ENDITEM = currPageNum
    BEGINITEM = 1
    I = 0
    ICOUNTER = 0
    
    INTPAGE = Trim(Request("NEXTPAGE"))
    If Len(INTPAGE) > 0 And IsNumeric(INTPAGE) Then
        Session("HISTORIQUE_ClientPage") = INTPAGE
    End If
    
    If Len(Session("HISTORIQUE_ClientPage")) > 0 Then
    If CInt(Session("HISTORIQUE_ClientPage")) = 0 Then Session("HISTORIQUE_ClientPage") = 1
        lstPage = CInt(Session("HISTORIQUE_ClientPage"))
       
        ENDITEM = lstPage * currPageNum
        
        BEGINITEM = val(ENDITEM) - (currPageNum - 1)
    End If
     If RecCount < BEGINITEM Then
        lstPage = 1
        ENDITEM = currPageNum
        BEGINITEM = 1
        I = 0
        ICOUNTER = 0
    End If
    I = 0
    LastRegroupBlob = ""
    my_bglsttrok = GetDefault("bglsttrok", "#DCC9B2", Session("candidat_ADOContact"))
    my_bglsttrnook = GetDefault("bglsttrnook", "#DBDEF1", Session("candidat_ADOContact"))
    Do While Not rs0.EOF
       
        ' if (LastRegroupBlob <> rs0("RegroupBlob")) then
        I = I + 1
       
        If (I >= BEGINITEM And I <= val(ENDITEM)) Then
             BlExiste = True
               HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<tr id=""CLI_FRM" & I & """ style=""background:" & my_bglsttrnook & ";"" valign=""top"" OnMouseOver=""vbMouseOver(CLI_FRM" & I & ")"" OnMouseOut=""vbMouseOut(CLI_FRM" & I & ")"" >" 'OnClick=""vbEditContact(" & rs0("N° Comm Encelade") & ")"">
            
            For j = 0 To (rs0.Fields.Count - 1)
'            If (j = 3) And (Session("candidat_UserType") = "Anonyme") Then
'                HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<td nowrap><a href=""Contact.asp?mode=CONFIGCLI_New&ID=" & rs0("N° Comm Encelade") & """>" & "Cliquez ici" & " </a></td>")
'            End If
Debug.Print UCase(rs0(j).Name)
                If Trim("" & rs0(j)) = "" Then MyTxt = "&nbsp" Else MyTxt = rs0(j)
                            Debug.Print rs0(j).Type
                            If IsNumeric(MyTxt) Then
                                MyTxt = FomatNum("" & MyTxt, 3)
                            Else
                                If IsNumeric(Replace(MyTxt, ",", ".")) Then MyTxt = FomatNum("" & MyTxt, 3)
                            End If
                  
                    If Session("candidat_UserType") <> "Anonyme" Then
                    Bl = "" & rs0("bl")
                    
                        If UCase(rs0(j).Name) = UCase("Liste rouge") Then
                           
                            If rs0(j) = False Then
                                MyTxt = "NON"
                            Else
                                MyTxt = "OUI"
                            End If
                           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BL N° " & rs0("bl") & """);return true;' href=""Contact.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & rs0("BL") & """>" & MyTxt & " </a></td>"
                        Else
                            HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BL N° " & rs0("bl") & """);return true;' href=""Contact.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & rs0("BL") & """>" & MyTxt & " </a></td>"
                        End If
                    Else
                       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td nowrap><a  onMouseOver='message(""Ouvir BL N° " & rs0("bl") & """);return true;' href=""Contact.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & rs0("BL") & """>" & MyTxt & " </a></td>"

                    End If
'                If Session("candidat_UserType") = "Administrator" Then
'                    If j = rs0.Fields.Count - 1 Then
'                        HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<td nowrap><a href=""javascript:javDelete('" & rs0("N° Comm Encelade") & "');"" >Cliquez ici </a></td>")
'                    End If
'                End If

            
            Next

           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</tr>"
            ICOUNTER = ICOUNTER + 1
            
            '*** Build javascript for select all
            'strClearAll = strClearAll & "document.frm.
        End If
        If I = val(ENDITEM) Then
            Exit Do
        End If
    
        rs0.MoveNext
    Loop
  
   HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</table>"
    
    '***********************************  Page Count  *****************
    PageCount = CInt(RecCount / currPageNum)
     PageCount2 = RecCount / currPageNum
     If PageCount < PageCount2 Then PageCount = PageCount + 1
    If RecCount = 0 Then
        PageCount = 0
    ElseIf PageCount < 1 Then
        PageCount = 1
    Else
'    If Trim("" & INTLEFT) = "" Then INTLEFT = PageCount
        INTLEFT = PageCount
        
        If InStr(PageCount, ".") Then INTLEFT = Left(PageCount, InStr(PageCount, ".") - 1)
        If InStr(PageCount, ",") Then INTLEFT = Left(PageCount, InStr(PageCount, ",") - 1)
        If val(Replace(INTLEFT, ",", ".")) > val(PageCount) Then PageCount = INTLEFT + 1
    End If
    
    If ((ICOUNTER > 0) And (Session("candidat_UserType") = "Administrator")) Or ((ICOUNTER > 0) And (Session("portal_candidat_Recherhe") = 0)) Then
        
        BRCOUNT = currPageNum - ICOUNTER
'        For j = 0 To brCount - 1
'           HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<br>")
'        Next
        PREVPAGE = lstPage - 1
        NEXTPAGE = lstPage + 1
       'HISTORIQUE_BL=HISTORIQUE_BL &  vbcrlf & "<hr>")
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<table border=""0"" cellspacing=""0"">"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<form name=""frmClientUser"" action=""Contact.asp"" method=""post"">"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<input type=""hidden"" name=""mode"" value=""HISTORIQUE_Eboutique_Affiche_Commande"">"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<input type=""hidden"" name=""RefCommande"" value=""" & numDevis & """>"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<tr valign=""middle""><td>&nbsp;</td><td valign=""middle"" nowrap class=""smallerheader"">Page:&nbsp;</td>"
        
        '******************* Previous Page *************** -->
        If PREVPAGE < 1 Then
           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td><img src=""leftEnd_.gif"" border=""0""><img src=""leftOne_.gif"" border=""0""></td>"
        Else
           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&NEXTPAGE=1""><img src=""leftEnd.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&NEXTPAGE=" & PREVPAGE & """><img src=""leftOne.gif"" border=""0""></a></td>"
        End If
        
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td><input align=""right"" class=""cmdflat"" type=""text"" name=""lstPage"" value=""         " & lstPage & """ size=""4""></td>"
        
        If NEXTPAGE > PageCount Then
           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td><img src=""rightOne_.gif"" border=""0""><img src=""rightEnd_.gif"" border=""0""></td>"
        Else
           HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&NEXTPAGE=" & NEXTPAGE & """><img src=""rightOne.gif"" border=""0""></a><a href=""Contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & numDevis & "&NEXTPAGE=" & PageCount & """><img src=""rightEnd.gif"" border=""0""></a></td>"
        End If
        
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<td valign=""middle""><font class=""smallerheader"">&nbsp;sur " & PageCount
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "&nbsp;&nbsp;&nbsp;&nbsp;Total :&nbsp;" & RecCount & "</font></td>"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</tr>"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</form>"
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "</table>"
        End If

    

    '***************** MESSAGE **********

    If Len(msg) > 0 Then
       HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<center><font color=""" & GetDefault("colormsg", "red", Session("candidat_ADOContact")) & "><b>" & msg & "</b></font></center>"
    End If

    HISTORIQUE_BL = HISTORIQUE_BL & vbCrLf & "<a  onMouseOver='message(""Haut de page"");return true;' href=""#Haut""><img src=""hautdepage.gif"" border=""0""></a>"
    
   
End Function
'Public Function GetMenu()
'     GetMenu = GetMenu & ("<script language='javascript'>")
'    GetMenu = GetMenu & ("function javAbout() {")
'    GetMenu = GetMenu & ("   window.open('Contact.asp?mode=dlgAbout','dlgabout','resizable=yes,status=no,top=150,left=150,width=400,height=150')")
'    GetMenu = GetMenu & ("}")
'    GetMenu = GetMenu & ("</script>")
'
'    GetMenu = GetMenu & ("<script language='vbscript'>")
'    GetMenu = GetMenu & ("function mnMouseOver(i)")
'    GetMenu = GetMenu & ("   if i = 1 then")
'    GetMenu = GetMenu & ("       td1.style.backgroundcolor = ""navy""")
'    GetMenu = GetMenu & ("       sp1.style.color = ""white""")
'    For k = 2 To 10
'    GetMenu = GetMenu & ("   elseif i = " & k & " then")
'    GetMenu = GetMenu & ("       td" & k & ".style.backgroundcolor = ""navy""")
'    GetMenu = GetMenu & ("       sp" & k & ".style.color = ""white""")
'    Next
'    GetMenu = GetMenu & ("   end if")
'    GetMenu = GetMenu & ("end function")
'
'    GetMenu = GetMenu & ("function mnMouseOut(i)")
'    GetMenu = GetMenu & ("   if i = 1 then")
'    GetMenu = GetMenu & ("       td1.style.backgroundcolor = ""white""")
'    GetMenu = GetMenu & ("       sp1.style.color = ""navy""")
'    For k = 2 To 10
'    GetMenu = GetMenu & ("   elseif i = " & k & " then")
'    GetMenu = GetMenu & ("       td" & k & ".style.backgroundcolor = ""white""")
'    GetMenu = GetMenu & ("       sp" & k & ".style.color = ""navy""")
'    Next
'    GetMenu = GetMenu & ("   end if")
'    GetMenu = GetMenu & ("end function")
'    GetMenu = GetMenu & ("</script>")
'
'
'    '****************  CONTACT MANAGER
'    If Session("candidat_CurrentPage") = "con_frmSetting.asp" Or Session("candidat_CurrentPage") = "con_frmField.asp" Or Session("candidat_CurrentPage") = "con_frmSetField.asp" Then
'        GetMenu = GetMenu & ("<table border='0' bgcolor='white' cellspacing='1'><tr>")
'        GetMenu = GetMenu & ("<td id='td1' nowrap bgcolor='white' onMouseOver='mnMouseOver(1)' onMouseOut='mnMouseOut(1)'><a href='con_frmSetting.asp'><span id='sp1'><b>&nbsp;Settings&nbsp;</b></span></a></td>")
'        GetMenu = GetMenu & ("<td id='td2' nowrap bgcolor='white' onMouseOver='mnMouseOver(2)' onMouseOut='mnMouseOut(2)'><a href='con_frmField.asp'><span id='sp2'><b>&nbsp;Select Fields&nbsp;</b></span></a></td>")
'        If Session("candidat_UserType") = "Administrator" Then
'            GetMenu = GetMenu & ("<td id='td5' nowrap bgcolor='white' onMouseOver='mnMouseOver(5)' onMouseOut='mnMouseOut(5)'><a href='con_frmSetField.asp'><span id='sp5'><b>&nbsp;Customize Fields&nbsp;</b></span></a></td>")
'        End If
'        GetMenu = GetMenu & ("</tr></table>")
'    End If
'End Function






Public Function GetMenu()

    GetMenu = GetMenu & vbCrLf & ("<script language='javascript'>")
    GetMenu = GetMenu & vbCrLf & ("function javAbout() {")
    GetMenu = GetMenu & vbCrLf & ("   window.open('Contact.asp?mode=dlgAbout','dlgabout','resizable=yes,status=no,top=150,left=150,width=400,height=150')")
    GetMenu = GetMenu & vbCrLf & ("}")
    GetMenu = GetMenu & vbCrLf & ("</script>")
    
    GetMenu = GetMenu & vbCrLf & ("<script language='vbscript'>")
    GetMenu = GetMenu & vbCrLf & ("function mnMouseOver(i)")
    GetMenu = GetMenu & vbCrLf & ("   if i = 1 then")
    GetMenu = GetMenu & vbCrLf & ("       td1.style.backgroundcolor = ""navy""")
    GetMenu = GetMenu & vbCrLf & ("       sp1.style.color = ""white""")
    For k = 2 To 10
    GetMenu = GetMenu & vbCrLf & ("   elseif i = " & k & " then")
    GetMenu = GetMenu & vbCrLf & ("       td" & k & ".style.backgroundcolor = ""navy""")
    GetMenu = GetMenu & vbCrLf & ("       sp" & k & ".style.color = ""white""")
    Next
    GetMenu = GetMenu & vbCrLf & ("   end if")
    GetMenu = GetMenu & vbCrLf & ("end function")
    
    GetMenu = GetMenu & vbCrLf & ("function mnMouseOut(i)")
    GetMenu = GetMenu & vbCrLf & ("   if i = 1 then")
    GetMenu = GetMenu & vbCrLf & ("       td1.style.backgroundcolor = ""white""")
    GetMenu = GetMenu & vbCrLf & ("       sp1.style.color = ""navy""")
    For k = 2 To 10
    GetMenu = GetMenu & vbCrLf & ("   elseif i = " & k & " then")
    GetMenu = GetMenu & vbCrLf & ("       td" & k & ".style.backgroundcolor = ""white""")
    GetMenu = GetMenu & vbCrLf & ("       sp" & k & ".style.color = ""navy""")
    Next
    GetMenu = GetMenu & vbCrLf & ("   end if")
    GetMenu = GetMenu & vbCrLf & ("end function")
    GetMenu = GetMenu & vbCrLf & ("</script>")
    
    
    '****************  CONTACT MANAGER
    
    If UCase(Session("candidat_CurrentPage")) = UCase("con_frmSetSubField.asp") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmSetting.asp") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmField.asp") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmSetField.asp") Then
        GetMenu = GetMenu & vbCrLf & ("<table border='0' bgcolor='gray' cellspacing='1'><tr>")
        GetMenu = GetMenu & vbCrLf & ("<td id='td1' nowrap bgcolor='white' onMouseOver='mnMouseOver(1)' onMouseOut='mnMouseOut(1)'><a href='Contact.asp?mode=CON_FRMSETTING'><span id='sp1'><b>&nbsp;Paramètres&nbsp;</b></span></a></td>")
        GetMenu = GetMenu & vbCrLf & ("<td id='td2' nowrap bgcolor='white' onMouseOver='mnMouseOver(2)' onMouseOut='mnMouseOut(2)'><a href='Contact.asp?mode=con_frmField'><span id='sp2'><b>&nbsp;Champs affichés&nbsp;</b></span></a></td>")
        If UCase(Session("candidat_UserType")) = UCase("Administrator") Then
            GetMenu = GetMenu & vbCrLf & ("<td id='td5' nowrap bgcolor='white' onMouseOver='mnMouseOver(5)' onMouseOut='mnMouseOut(5)'><a href='Contact.asp?mode=con_frmSetField'><span id='sp5'><b>&nbsp;Personnalisation&nbsp;</b></span></a></td>")
        End If
        GetMenu = GetMenu & vbCrLf & ("</tr></table>")
    End If
End Function
Public Function GetMenu2()

    GetMenu2 = GetMenu2 & vbCrLf & ("<script language='javascript'>")
    GetMenu2 = GetMenu2 & vbCrLf & ("function javAbout() {")
    GetMenu2 = GetMenu2 & vbCrLf & ("   window.open('Contact.asp?mode=dlgAbout','dlgabout','resizable=yes,status=no,top=150,left=150,width=400,height=150')")
    GetMenu2 = GetMenu2 & vbCrLf & ("}")
    GetMenu2 = GetMenu2 & vbCrLf & ("</script>")
    
    GetMenu2 = GetMenu2 & vbCrLf & ("<script language='vbscript'>")
    GetMenu2 = GetMenu2 & vbCrLf & ("function mnMouseOver(i)")
    GetMenu2 = GetMenu2 & vbCrLf & ("   if i = 1 then")
    GetMenu2 = GetMenu2 & vbCrLf & ("       td1.style.backgroundcolor = ""navy""")
    GetMenu2 = GetMenu2 & vbCrLf & ("       sp1.style.color = ""white""")
    For k = 2 To 10
    GetMenu2 = GetMenu2 & vbCrLf & ("   elseif i = " & k & " then")
    GetMenu2 = GetMenu2 & vbCrLf & ("       td" & k & ".style.backgroundcolor = ""navy""")
    GetMenu2 = GetMenu2 & vbCrLf & ("       sp" & k & ".style.color = ""white""")
    Next
    GetMenu2 = GetMenu2 & vbCrLf & ("   end if")
    GetMenu2 = GetMenu2 & vbCrLf & ("end function")
    
    GetMenu2 = GetMenu2 & vbCrLf & ("function mnMouseOut(i)")
    GetMenu2 = GetMenu2 & vbCrLf & ("   if i = 1 then")
    GetMenu2 = GetMenu2 & vbCrLf & ("       td1.style.backgroundcolor = ""white""")
    GetMenu2 = GetMenu2 & vbCrLf & ("       sp1.style.color = ""navy""")
    For k = 2 To 10
    GetMenu2 = GetMenu2 & vbCrLf & ("   elseif i = " & k & " then")
    GetMenu2 = GetMenu2 & vbCrLf & ("       td" & k & ".style.backgroundcolor = ""white""")
    GetMenu2 = GetMenu2 & vbCrLf & ("       sp" & k & ".style.color = ""navy""")
    Next
    GetMenu2 = GetMenu2 & vbCrLf & ("   end if")
    GetMenu2 = GetMenu2 & vbCrLf & ("end function")
    GetMenu2 = GetMenu2 & vbCrLf & ("</script>")
    
    
    '****************  CONTACT MANAGER
    
    If UCase(Session("candidat_CurrentPage")) = UCase("CONFIG.ASP") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmSetting.asp") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmField.asp") Or UCase(Session("candidat_CurrentPage")) = UCase("con_frmSetField.asp") Then
        GetMenu2 = GetMenu2 & vbCrLf & "<table border='0' bgcolor='gray' cellspacing='1'><tr>"
        GetMenu2 = GetMenu2 & vbCrLf & "<td id='td1' nowrap bgcolor='white' onMouseOver='mnMouseOver(1)' onMouseOut='mnMouseOut(1)'><a href='Contact.asp?mode=Config'><span id='sp1'><b>&nbsp;G&eacute;n&eacute;rale&nbsp;</b></span></a></td>"
        GetMenu2 = GetMenu2 & vbCrLf & "<td id='td2' nowrap bgcolor='white' onMouseOver='mnMouseOver(2)' onMouseOut='mnMouseOut(2)'><a href='Contact.asp?mode=RaisonSicialEncelade'><span id='sp2'><b>&nbsp;Soci&eacute;t&eacute;&nbsp;</b></span></a></td>"
'        If UCase(Session("candidat_UserType")) = UCase("Administrator") Then
'            GetMenu2 = GetMenu2 & vbCrLf & "<td id='td5' nowrap bgcolor='white' onMouseOver='mnMouseOver(5)' onMouseOut='mnMouseOut(5)'><a href='Contact.asp?mode=con_frmSetField'><span id='sp5'><b>&nbsp;Personnalisation&nbsp;</b></span></a></td>"
''             GetMenu2 = GetMenu2 & vbCrLf & "<tr> <td height='21' colspan='3' nowrap b>   &nbsp;</td>"
'        End If
        GetMenu2 = GetMenu2 & vbCrLf & "</tr></table><br>"
        
        






    End If
End Function
Public Function RegroupField(RgFld, ValRgFLd, orgfld, newfld) As String

    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    Set rs0 = New ADODB.Recordset
    Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Session("candidat_MainTable") & " WHERE " & RgFld & " = '" & ValRgFLd & "' Order By ContactId")
    
    
    FldInfo = GetDefault("RegroupingFldInfo", "", Session("candidat_ADOContact"))
    FldTxt = GetDefault("RegroupingInfoTxt", "", Session("candidat_ADOContact"))

    my_RegroupingInfoTitle = GetDefault("RegroupingInfoTitle", appName, Session("candidat_ADOContact"))
    Do While Not rs0.EOF
                ray1 = Split(FldInfo, ";")
                ray2 = Split(FldTxt, ";")
                Mytext = ""
                For I = 0 To UBound(ray1) - 1
                    Mytext = Mytext & ray2(I) & rs0(ray1(I))
                Next I
                tmp = rs0(orgfld)
                subkey = "sub" & orgfld
                StartStr = "<A onmouseout=""HideInfo();"" onmouseover=""ShowInfo('$TEXT$','" & my_RegroupingInfoTitle & "');"">"
                StartStr = Replace(StartStr, "$TITLE$", "HISTORIQUE MODIFICATION :")
                StartStr = Replace(StartStr, "$TEXT$", Mytext)
                pr ("<tr>" & StartStr)
                pr ("<td align=""right""><font class=""smallerheader"">" & newfld & "</font></td>")
                Select Case UCase(Left(orgfld, 3))
                    Case "TXT"
                         pr ("<td align=""left"" class=""smallerHeader"">" & tmp & "  " & Session(subkey) & "</td>")
                    Case "MEM"
                         pr ("<td align=""left"" ><font size=""1"">" & tmp & "  " & Session(subkey) & "</td>")
                End Select
                pr ("</A></tr>")
                    
                RegroupField = tmp & " "
                rs0.MoveNext
    Loop

    

End Function

Function SetDefault(fld, val, DSN)
val = safeEntry(val)
    Set GeneralTools.My_Conn2 = OpenDb(DSN)
       GeneralTools.My_Conn2.Execute ("UPDATE Defaults SET defValue = '" & val & "' WHERE defName = '" & fld & "'")
    GeneralTools.My_Conn2.Close
    Set GeneralTools.My_Conn2 = Nothing
End Function



Function SetDefaultUser(fld, val)
 Set GeneralTools.My_Conn2 = OpenDb(Session("candidat_ADOContact"))
    GeneralTools.My_Conn2.Execute ("UPDATE DefaultUsers SET defValue = '" & safeEntry(val) & "' WHERE defName = '" & fld & "' AND UserID = " & 1)
    GeneralTools.My_Conn2.Close
     Set GeneralTools.My_Conn2 = Nothing
End Function

Function GetDefaultUser(fld, def, DSN)
    Set GeneralTools.My_Conn2 = OpenDb(DSN)
    Set RSSpec = GeneralTools.My_Conn2.Execute("SELECT defValue FROM DefaultUsers WHERE defName = '" & fld & "' AND UserID = " & 1)
    If Not RSSpec.EOF Then
        GetDefaultUser = Trim(RSSpec("defValue"))
    Else
        GeneralTools.My_Conn2.Execute ("INSERT INTO DefaultUsers(UserID,defName,defValue) VALUES(" & 1 & ",'" & fld & "','" & def & "')")
        GetDefaultUser = def
    End If
    GeneralTools.My_Conn2.Close
     Set GeneralTools.My_Conn2 = Nothing
End Function



Function pr(strPrint)
    Response.Write strPrint & vbCrLf
End Function

Function funY2K(D)
    strDate = Trim(D)
    If InStr(strDate, " ") Then
        strDate = Left(strDate, InStr(strDate, " "))
        trailer = Right(D, Len(D) - InStr(D, " "))
    End If
    If IsDate(strDate) Then
        dateY2K = strDate
        If InStr(strDate, "/") = 2 Then
            strMonth = Left(strDate, 1)
            If InStr(3, strDate, "/") = 4 Then
                strDay = Mid(strDate, 3, 1)
            Else
                strDay = Mid(strDate, 3, 2)
            End If
            strYear = Right(strDate, Len(strDate) - InStr(3, strDate, "/"))
        ElseIf InStr(strDate, "/") = 3 Then
            strMonth = Left(strDate, 2)
            If InStr(4, strDate, "/") = 5 Then
                strDay = Mid(strDate, 4, 1)
            Else
                strDay = Mid(strDate, 4, 2)
            End If
            strYear = Right(strDate, Len(strDate) - InStr(4, strDate, "/"))
        End If
        intYear = CInt(strYear)
        If intYear >= 0 And intYear < 51 Then
            strYear = "20" & strYear
        ElseIf intYear > 50 And intYear < 100 Then
            strYear = "19" & strYear
        End If
        
        funY2K = strMonth & "/" & strDay & "/" & strYear & " " & trailer
    Else
        funY2K = ""
    End If
End Function

Function getLetter(Num)
Select Case Num
    Case 1
        getLetter = "0"
    Case 2
        getLetter = "1"
    Case 3
        getLetter = "2"
    Case 4
        getLetter = "3"
    Case 5
        getLetter = "4"
    Case 6
        getLetter = "5"
    Case 7
        getLetter = "6"
    Case 8
        getLetter = "7"
    Case 9
        getLetter = "8"
    Case 10
        getLetter = "9"
    Case 11
        getLetter = "a"
    Case 12
        getLetter = "b"
    Case 13
        getLetter = "c"
    Case 14
        getLetter = "d"
    Case 15
        getLetter = "e"
    Case 16
        getLetter = "f"
    Case 17
        getLetter = "g"
    Case 18
        getLetter = "h"
    Case 19
        getLetter = "i"
    Case 20
        getLetter = "j"
    Case 21
        getLetter = "k"
    Case 22
        getLetter = "l"
    Case 23
        getLetter = "m"
    Case 24
        getLetter = "n"
    Case 25
        getLetter = "o"
    Case 26
        getLetter = "p"
    Case 27
        getLetter = "q"
    Case 28
        getLetter = "r"
    Case 29
        getLetter = "s"
    Case 30
        getLetter = "t"
    Case 31
        getLetter = "u"
    Case 32
        getLetter = "v"
    Case 33
        getLetter = "w"
    Case 34
        getLetter = "x"
    Case 35
        getLetter = "y"
    Case 36
        getLetter = "z"
    Case Else
        getLetter = ""
    End Select
End Function

Function getHeading(strName) 'Server.CreateObject("ADODB.Connection")
    Set GeneralTools.My_Conn2 = OpenDb(Session("candidat_ADOContact"))
 
   
    Set RS111 = GeneralTools.My_Conn2.Execute("SELECT FieldAlias FROM con_FieldDefs WHERE FieldName = '" & strName & "'")
    If Not RS111.EOF Then
        getHeading = RS111("FieldAlias")
    Else
        getHeading = strName
    End If
    If strName = "ContactID" Then
        getHeading = "ID"
    End If
    GeneralTools.My_Conn2.Close
     Set GeneralTools.My_Conn2 = Nothing
End Function
Function getAtribut(strName) 'Server.CreateObject("ADODB.Connection")
    Set GeneralTools.My_Conn2 = OpenDb(Session("candidat_ADOContact"))
 
   
    Set RS111 = GeneralTools.My_Conn2.Execute("SELECT FieldAttribut FROM con_FieldDefs WHERE FieldName = '" & strName & "'")
    If Not RS111.EOF Then
        getAtribut = RS111("FieldAttribut")
    Else
        getAtribut = strName
    End If
    If strName = "ContactID" Then
        getAtribut = "ID"
    End If
    GeneralTools.My_Conn2.Close
     Set GeneralTools.My_Conn2 = Nothing
End Function

Public Function safeEntry(strField)

    strSafe = Trim(strField)
    
    strSafe = funReplace(strSafe, "'", "´")
    strSafe = funReplace(strSafe, "<", "&lt;")
    strSafe = funReplace(strSafe, ">", "&gt;")
    strSafe = noquoteNumTxt(strSafe)
    safeEntry = strSafe
End Function

Public Function funReplace(a, b, C)
If IsNull(a) Then Exit Function
If IsNull(b) Then Exit Function
If IsNull(C) Then Exit Function
    funReplace = Replace(a, b, C)
End Function

'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'                OnStartPage
'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Public Sub OnStartPage(PassedScriptingContext As ScriptingContext)
    Set MyScriptingContext = PassedScriptingContext
    Set Request = MyScriptingContext.Request
    Set Response = MyScriptingContext.Response
    Set Application = MyScriptingContext.Application
    Set Server = MyScriptingContext.Server
    Set Session = MyScriptingContext.Session
    'For i = 1 To Request.ServerVariables.Count
    '    Debug.Print i & " : " & Request.ServerVariables(i) & vbCrLf
    '
    'Next i
End Sub

Public Sub con_frmCandidat()
Dim orgfld As String

 tmp = ""
Response.Expires = 0
 Session("lePathRootDoc") = GetDefault("PathDOC", "Portal_DOC/Catalogue/", Session("candidat_ADOContact"))
Session("candidat_CurrentPage") = "contact.asp?mode=con_frmCandidat"

If Len(Request.QueryString("numpage")) > 0 Then
    numpage = Request.QueryString("numpage")
Else
    numpage = 1
End If
If GetDefault("NBPage", 6, Session("candidat_ADOContact")) >= numpage Then
    fldNumAuto = 3
    fldDate = 135
    fldText = 202
    fldMemo = 203
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
    Set rs0 = New ADODB.Recordset
    Set RS1 = New ADODB.Recordset
    flaghtml = False
       Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID"))
    'pr ("<html><head><title>" & GetDefault("con_AppTitle", "Contact Manager") & "</title></head>")
    pr ("<script language=""javascript"">")
    
pr ("function jsTrim(monItem) {")
pr ("  var monTexte = new String("""");")
pr ("  monTexte = monItem.value;")
pr ("  while (monTexte.charAt(0) == ' ') {")
pr ("    monTexte = monTexte.substring(1,monTexte.length);")
pr ("  }")
pr ("  while (monTexte.charAt(monTexte.length - 1) == ' ') {")
pr ("    monTexte = monTexte.substring(0, (monTexte.length - 1));")
pr ("  }")
pr ("  return(monTexte);")

pr ("};")




     pr "function DelTxt(my_Doc,IsImage) {"
    pr ("myForm = this.document.forms[0];")
    pr "my_DelTxt=eval (""myForm.""+my_Doc);"
     pr "my_DelTxt.value=' ';"
     pr " if (IsImage!=""""){"
     pr "my_IsImage=eval(""myForm.""+IsImage+my_Doc);"
'     pr "alert(my_IsImage.name);"
     pr "my_IsImage.src=""MigVide.jpg"";}"
     pr "}"
     
   pr "function apercu_Doc(Rep,my_Doc, My_Message) {"
    pr ("myForm = this.document.forms[0];")
    pr ("oSlt = eval(""myForm."" + my_Doc);")
    pr ("  var Mytxt = new String("""");")
    pr ("Mytxt=jsTrim(oSlt);")
'    pr ("alert('/' + Mytxt + '/');")
    pr ("if (Mytxt != """") {")
    
    'pr "var my_Doc_oSlt"
''    myForm
'pr "eval (""my_Doc_oSlt = myForm.""+my_Doc+"".value;"");"
'pr "if (my_Doc_oSlt != """"){"
pr "window.open(Rep+Mytxt, ""apercu_horizontal"", ""toolbar=no, location=no, directories=no, status=no, scrollbars=yes, resizable=yes, copyhistory=no,  left=0, top=0"");"
pr "} else {"
pr "alert(My_Message);"
pr "}}"
'    pr ("}")
    
    
  
        pr ("function javCancel() {")
        pr ("    location.href = ""Contact.asp?mode=con_lst""")
        pr ("}")
        

        pr ("function javDelete() {")
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("        location.href = ""Contact.asp?mode=con_subContact&sub=delete&ContactID=" & Request("ContactID") & """")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
  
    pr ("function openImgBiblio(inFormBack, inImgChange) {")
    pr (" var leftPos = (screen.availWidth-700) / 2;")
    pr (" var topPos = (screen.availHeight-500) / 2;")
    pr (" var imageWin = window.open('" & Session("PortalPath") & "Portal_HtmlEditor/Popups/HE_Candidat.asp?h_imgchange=' + inImgChange + '&h_formback=' + inFormBack,'','width=700,height=500,scrollbars=yes,resizable=yes,titlebar=0,top=' + topPos + ',left=' + leftPos);")
    pr ("}")
'    Debug.Print Server.MapPath("")
     pr ("function openDocBiblio(inFormBack, inImgChange) {")
    pr (" var leftPos = (screen.availWidth-700) / 2;")
    pr (" var topPos = (screen.availHeight-500) / 2;")
    pr (" var imageWin = window.open('" & Session("PortalPath") & "Portal_HtmlEditor/Popups/HE_Candidat_Files.asp?h_imgchange=' + inImgChange + '&h_formback=' + inFormBack,'','width=700,height=500,scrollbars=yes,resizable=yes,titlebar=0,top=' + topPos + ',left=' + leftPos);")
    pr ("}")
    
        pr ("function javDevis() {")
        pr ("myForm = this.document.forms[0];")
        pr ("myForm.mode.value = 'candidat_caddy';")
         pr ("myForm.act.value = 'ajout';")
         pr ("myForm.action='Contact.asp?mode=Candidat_caddy';")
'
        pr ("myForm.submit();")
        pr ("}")
        
' pr ("function ClickCheck(MyCheck) {")
''pr "alert( MyCheck );"
'    pr "STRTEXTE = document.all[MyCheck];"
'        pr ("if (STRTEXTE.value =='OUI') {")
'        pr ("STRTEXTE.value='NON';")
'         pr ("} else {")
'         pr ("STRTEXTE.value='OUI';")
'         pr ("}")
'          pr ("}")
    pr ("</SCRIPT>")
    
    
    'pr ("<link rel=""stylesheet"" href=""PMainStyle1.asp""><body>")
    
    
    ' Buffer pour différer l'envoi du code après le <body>
    If GetDefault("MentionLegale", "", Session("candidat_ADOContact")) <> "" And numpage = 1 Then
        Buffer = Buffer & vbCrLf & GetDefault("MentionLegale", "", Session("candidat_ADOContact"))
    End If
   
    Buffer = Buffer & vbCrLf & ("<div align=""center""><form name=""frm"" action=""Contact.asp"" method=""post""><table align=""center"" width=""600PX"" bgcolor=""" & GetDefault("con_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & """ cellpadding=""1"" cellspacing=""0"">")
    Buffer = Buffer & vbCrLf & ("<tr><td><table align=""center"" width=""100%"" border=""0"" cellpadding=""1"" cellspacing=""0""><tr>")
    
    Buffer = Buffer & vbCrLf & ("")
    id_produit = Request("candidat_ItemWebId")
'     Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""ContactID"" value=""" & Request("ContactID") & """>")

If Request("ContactID") <> 0 Then
     Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""act"">")
     
    Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""candidat_fieldref"" value=""" & rs0(GetDefault("RefCaddy", "txt1", Session("candidat_ADOContact"))) & """>")
    Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""candidat_ItemWebId"" value=""" & rs0("ContactID") & """ >")
    Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""candidat_ItemMenu"" value=""" & Session("Encelade_CatId") & """ >")
End If
    Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""mode"" value=""con_subContact"">")
    Buffer = Buffer & vbCrLf & ("<input type=""hidden"" name=""ContactID"" value=""" & Request("ContactID") & """>")
    
    If GetDefault("NBPage", 6, Session("candidat_ADOContact")) > 1 Then
    Buffer = Buffer & vbCrLf & ("<td width=""10%"" class=""header""><font class=""header"">") & " " & numpage & "/" & GetDefault("NBPage", 6, Session("candidat_ADOContact")) & "</font></td>"
    Buffer = Buffer & vbCrLf & ("<td width=""60%"" class=""header"">")
    Buffer = Buffer & vbCrLf & ("<b>" & GetDefault("Titrepage" & numpage + 1, "Etape " & numpage, Session("candidat_ADOContact")) & strName & "</b>")
    Buffer = Buffer & vbCrLf & ("</td>")
    End If
    
        Buffer = Buffer & vbCrLf & ("<td width=""60%"" class=""header"" align=""left"">")
       Buffer = Buffer & vbCrLf & "<font color='" & GetDefault("con_titre", "#ffffff", Session("candidat_ADOContact")) & "' size='1' >"
    Buffer = Buffer & vbCrLf & ("<b>" & Session("Encelade_Message") & "</b></font>")
    Buffer = Buffer & vbCrLf & ("</td>")

    
    
    Buffer = Buffer & vbCrLf & ("<td class=""header"" width=""40%"" align=""right"">")
'   If Request("ContactID") <> 0 Then
'        Buffer = Buffer & ("<input type=""button""  class=""cmdflat""   value=""Ajouter Commande"" onClick=""javDevis()"">")
'    End If
    If Session("candidat_UserType") = "Administrator" Then
        If GetDefault("NBPage", 6, Session("candidat_ADOContact")) > 1 Then
            Buffer = Buffer & vbCrLf & ("<input type=""button""  class=""cmdflat"" value=""Valider " & numpage & " sur " & GetDefault("NBPage", 6, Session("candidat_ADOContact")) & """ onClick=""javSubmit();SetVals();"">&nbsp;")
        Else
            Buffer = Buffer & vbCrLf & ("<input type=""button""  class=""cmdflat"" value=""Valider"" onClick=""javSubmit();SetVals();"">&nbsp;")
        End If
    End If
    If Request("ContactID") > 0 And Session("candidat_UserType") = "Administrator" Then
        Buffer = Buffer & vbCrLf & ("<input type=""button"" class=""cmdflat""   value=""Supprimer"" onClick=""javDelete();"" >&nbsp;")
    End If
    Buffer = Buffer & vbCrLf & ("<input type=""button"" class=""cmdflat""   onClick=""javCancel()"" value=""Annuler"">&nbsp;")
      Mydsn = DsnTableMenu(Session("candidat_ADOContact"))
'    Set CaddyConn = OpenDb(Mydsn)
 If Session("ADMIN") <> 1 Then
   If Request("ContactID") <> 0 Then
    If Session("candidat_UserType") <> "Administrator" Then
        If Session("UserCommander") = 1 Then
        IMGaddy = Trim(GetDefault("IMGaddy", "", DsnTableMenu(Session("candidat_ADOContact"))))
        If IMGaddy = "" Then
            
                Buffer = Buffer & ("<input type=""button""  class=""cmdflat""   value=""Ajouter Commande"" onClick=""javDevis();"">")
           
        Else
            
            Buffer = Buffer & ("<a href=""javascript:javDevis();"" border=""0""><img src=""" & IMGaddy & """ alt=""Ajouter Commande"" border=""0"" ></a>")
            End If
        End If
     End If
    End If
 End If
If Session("candidat_UserType") = "Administrator" Then
If Request("ContactID") <> "0" Then
    Buffer = Buffer & vbCrLf & ("<input type=""button""  class=""cmdflat""   value=""Com. Fourniseur"" onClick=""javDevis();"">")
    Buffer = Buffer & vbCrLf & "<input type=""hidden"" name=""ComFour"" value=""True"">"
    End If
End If
    Buffer = Buffer & vbCrLf & ("</td></tr></table></td></tr></table>")
    
    Buffer = Buffer & vbCrLf & ("<script language=""javascript"">")
    Buffer = Buffer & vbCrLf & "function javSubmit() {"
    Buffer = Buffer & vbCrLf & "var count=0;"

    '**********  Get Field Labels and SUB Fields
     Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM con_FieldDefs where page=" & numpage)
    Do While Not rs0.EOF
        
        ' On construit les contrôles Javascript de champs obligatoires
        'cas des listes
        If InStr(rs0("FieldAttribut"), "REQ") > 0 And rs0("FieldAlias") <> "" And (InStr(rs0("FieldAttribut"), "CBO") > 0) Then
            Buffer = Buffer & vbCrLf & "if (document.frm." & rs0("FieldName") & ".selectedIndex==0) {"
            Buffer = Buffer & vbCrLf & "alert('" & rs0("FieldAlias") & " : Champ Obligatoire.');"
            Buffer = Buffer & vbCrLf & "document.frm." & rs0("FieldName") & ".focus();"
            Buffer = Buffer & vbCrLf & "count++;"
            'Buffer = Buffer & vbCrLf & "return"
            Buffer = Buffer & vbCrLf & "}"
        End If
       
        If InStr(rs0("FieldAttribut"), "REQ") > 0 And rs0("FieldAlias") <> "" And Not (InStr(rs0("FieldAttribut"), "RDB") > 0) And Not (InStr(rs0("FieldAttribut"), "CKB") > 0) And Not (InStr(rs0("FieldAttribut"), "CBO") > 0) Then
            Buffer = Buffer & vbCrLf & "if (document.frm." & rs0("FieldName") & ".value.length==0) {"
            Buffer = Buffer & vbCrLf & "alert('" & rs0("FieldAlias") & " : Champ Obligatoire.');"
            Buffer = Buffer & vbCrLf & "document.frm." & rs0("FieldName") & ".focus();"
            Buffer = Buffer & vbCrLf & "count++;"
            'Buffer = Buffer & vbCrLf & "return"
            Buffer = Buffer & vbCrLf & "}"
        End If
         
'        If InStr(rs0("FieldAttribut"), "REQ") > 0 And rs0("FieldAlias") <> "" And InStr(rs0("FieldAttribut"), "RDB") > 0 Or InStr(rs0("FieldAttribut"), "CKB") > 0 Then
'            Buffer = Buffer & vbCrLf & "if (document.frm." & rs0("FieldName") & ".checked == false) {"
'            Buffer = Buffer & vbCrLf & "alert(""" & rs0("FieldAlias") & " : Champ Obligatoire."")"
'            Buffer = Buffer & vbCrLf & "document.frm." & rs0("FieldName") & ".focus()"
'            Buffer = Buffer & vbCrLf & "count++"
'            'Buffer = Buffer & vbCrLf & "return"
'            Buffer = Buffer & vbCrLf & "}"
'        End If
          
          
        If InStr(rs0("FieldAttribut"), "DAT") > 0 Then
            Buffer = Buffer & vbCrLf & "var my_" & rs0("FieldName") & "=document.frm." & rs0("FieldName") & ".value;"
            Buffer = Buffer & vbCrLf & "if (my_" & rs0("FieldName") & ".length==10) {"
            Buffer = Buffer & vbCrLf & "for(var k = 0; k < my_" & rs0("FieldName") & ".length;k++)"
            Buffer = Buffer & vbCrLf & "{"
            Buffer = Buffer & vbCrLf & "var " & rs0("FieldName") & "c = my_" & rs0("FieldName") & ".substring(k,k+1);"
            Buffer = Buffer & vbCrLf & "var " & rs0("FieldName") & "i = 0;"
            Buffer = Buffer & vbCrLf & "if ( ((" & rs0("FieldName") & "c == '/') && ((k == 2) || (k == 5)) ) || ((((" & rs0("FieldName") & "c >= 0) && (" & rs0("FieldName") & "c <= 9) )) && ((k == 0) || (k == 1) || (k == 3) || (k == 4) || (k == 6) || (k == 7) || (k == 8) || (k == 9) ) ) ) {" & rs0("FieldName") & "i++;}"
            Buffer = Buffer & vbCrLf & "else{alert(document.frm." & rs0("FieldName") & ".value + "" n'est pas au format jj/mm/aaaa"");"
            Buffer = Buffer & vbCrLf & "document.frm." & rs0("FieldName") & ".focus();"
            Buffer = Buffer & vbCrLf & "count++;"
            Buffer = Buffer & vbCrLf & "k=my_" & rs0("FieldName") & ".length;"
            Buffer = Buffer & vbCrLf & "}}}"
            Buffer = Buffer & vbCrLf & "else{if (my_" & rs0("FieldName") & ".length>0) {alert(document.frm." & rs0("FieldName") & ".value + "" n'est pas au format jj/mm/aaaa"");"
            Buffer = Buffer & vbCrLf & "document.frm." & rs0("FieldName") & ".focus();"
            Buffer = Buffer & vbCrLf & "count++;}"
            Buffer = Buffer & vbCrLf & "}"
        End If
         
        ' On construit le body sur le champ HTML
        If InStr(rs0("FieldAttribut"), "HTML") > 0 And rs0("FieldAlias") <> "" Then
            TargetObject = "document.frm." & rs0("FieldName") & ".value"
            pr ("<body background=""" & Session("candidat_background") & """ onload=""editor.SetHTML(" & TargetObject & ");init();"">")
        End If
        
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM con_subFieldDefs WHERE FieldID = " & rs0("FieldID"))
        subkey = "sub" & rs0("FieldName")
        If Not RS1.EOF Then
            Session(subkey) = " <input type=""button""  class=""cmdflat""   value=""..."" onClick=""javSUB(" & Request("ContactID") & "," & rs0("FieldID") & ");"">"
        Else
            Session(subkey) = ""
        End If
        Session(rs0("FieldName")) = "" & rs0("FieldAlias")
        rs0.MoveNext
    Loop
    Buffer = Buffer & vbCrLf & "    if (count==0) {document.frm.submit();}"
    
    Buffer = Buffer & vbCrLf & "}"

    Buffer = Buffer & vbCrLf & "</script>"
    pr (Buffer)
    
    pr ("<br><font class=""smallerheader"">Vous devez remplir au minimum les champs suivis de <img src=""" & GetDefault("img_oblig", "boulerose.gif", Session("candidat_ADOContact")) & """ width=""15"" height=""12"" align=""absmiddle"" border=""0"">. Merci.</font><br>")
    pr (Session("Encelade_Message"))
    Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID"))
    Session("candidat_currContactID") = Request("ContactID")
    
    ' création du champ
    
    If Not rs0.EOF Then
        pr ("<input type=""hidden"" name=""sub"" value=""edit"">")
        pr ("<input type=""hidden"" name=""userid"" value=""" & rs0("userid") & """>")
        EditMode = True
    Else
        pr ("<input type=""hidden"" name=""sub"" value=""new"">")
        strName = "Nouveau"
        EditMode = False
    End If
        
    pr ("<table border=""0"" class=""table"" align=""center"" >")
    pr ("<br>")
    If EditMode = True Then
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM con_FieldDefs where page=" & numpage & " ORDER BY FieldOrder,FieldID")
        Do While Not RS1.EOF
            If Trim(RS1("FieldAlias")) <> "" Then
                orgfld = RS1("Fieldname")
                newfld = RS1("FieldAlias")
                
                ATTRIBUT = RS1("FieldAttribut")
                IsDisabled = ""
                If InStr(ATTRIBUT, "DAT") > 0 Then newfld = newfld & " " & GetDefault("FormatDate", "JJ/MM/AAAA", Session("candidat_ADOContact"))
                If InStr(ATTRIBUT, "BR") > 0 Then newfld = "<br></td><td><br></td></tr><td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld

                tmp = rs0(orgfld)
                
                If InStr(ATTRIBUT, "RG") > 0 Then
                    RgFld = GetDefault("RegroupingField", "", Session("candidat_ADOContact"))
                    tmp = RegroupField(RgFld, rs0(RgFld), orgfld, newfld)
                End If
                
                If InStr(ATTRIBUT, "REQ") > 0 Then
                    RequestField = "<img src=""" & GetDefault("img_oblig", "boulerose.gif", Session("candidat_ADOContact")) & """ width=""15"" height=""12"" align=""absmiddle"" border=""0"">"
                Else
                    RequestField = ""
                End If
                subkey = "sub" & orgfld

                    If InStr(ATTRIBUT, "SYS") > 0 Then
                        Select Case orgfld
                            Case "CreationDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & rs0(orgfld) & """ tabindex=""1"" >" & rs0(orgfld) & Session(subkey)
                            Case "ModificationDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Now & """ tabindex=""1"" >" & Now & Session(subkey)
                            Case "DeleteDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Now & """ tabindex=""1"" >" & Now & Session(subkey)
                            Case "UserId"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & rs0("UserID") & """ tabindex=""1"" >" & rs0("UserID") & Session(subkey)
                            Case "ContactId"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""0"" tabindex=""1"" >"
                            Case "LastName"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conLastName") & """ tabindex=""1"" >" & Session("candidat_conLastName") & Session(subkey)
                            Case "FirstName"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conFirstName") & """ tabindex=""1"" >" & Session("candidat_conFirstName") & Session(subkey)
                            Case "Location"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conLocation") & """ tabindex=""1"" >" & Session("candidat_conLocation") & Session(subkey)
                            Case "SubCategoryName"
                                pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                tmp = BuildSubCatList(2, val(CategoryName), rs0(orgfld)) ' a suivre
                                pr ("<td align=""left"" class=""td2"">" & tmp & "</td>")
                                tmp = ""
                            Case "CategoryName"
                                pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                CategoryName = rs0(orgfld)
                                tmp = BuildCatList(1, 0, rs0(orgfld)) ' a suivre
                                pr ("<td align=""left"" class=""td2"">" & tmp & "</td>")
                                tmp = ""
                            Case Else
                               
                                If Session("candidat_UserType") = "Administrator" And InStr(1, UCase(rs0(orgfld)), "TXT") > 0 Then
                                    pr ("<tr>")
                                    pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                    tmp = "<input type=""text"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField
                                    pr ("<td align=""left"" class=""td2"">" & tmp & "</td>")
                                    tmp = ""
                                Else
                                    If InStr(1, UCase(rs0(orgfld)), "TXT") > 0 Then
                                        tmp = "<input type=""Hidden""   name=""" & orgfld & """ size=""30"" tabindex=""1"" value=""" & tmp & """>"
                                    Else
                                        tmp = ""
                                    End If
                                End If
                        End Select
                        pr (tmp)
                    End If
                    If InStr(ATTRIBUT, "TXT") > 0 And InStr(ATTRIBUT, "SYS") < 1 Then
                             pr ("<tr>")
                             pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")

                             If InStr(ATTRIBUT, "RO") > 0 Then
                                pr ("<td align=""left"" class=""td2"" ><input type=""Hidden""   name=""" & orgfld & """ size=""30"" tabindex=""1"" value=""" & tmp & """><font  class=""smallerheader"">" & rs0(orgfld) & RequestField & "</font></td>")
                             Else
                                pr ("<td align=""left"" class=""td2"" ><input type=""text"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField & "</td>")
                             End If
                    End If
                    If InStr(ATTRIBUT, "MEM") > 0 Then
                            If InStr(ATTRIBUT, "HTML") > 0 Then
                                pr ("<td  class=""td2"" valign=""top"">")
                                CreateHtmlEditor orgfld, newfld, tmp, "frm"
                                pr (RequestField & "</td>")
                                flaghtml = True
                            Else
                                pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                pr ("<td  class=""td2"" colspan=""3"" valign=""top"" align=""left""><textarea " & IsDisabled & " name=""" & orgfld & """ cols=""50"" rows=""4"" tabindex=""18"">" & tmp & "</textarea>" & RequestField & "</td>")
                            End If
                    End If
                    If InStr(ATTRIBUT, "CBO") > 0 Then
                            pr ("<tr>")
                            pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")

                            pr ("<td  class=""td2"">")
                            pr (BuildTableList(orgfld, 1, 0, IIf(Not IsNull(rs0(orgfld)), rs0(orgfld), 0)))
                            pr (RequestField & "</td>")
                    End If
                    
                     If InStr(ATTRIBUT, "IMG") > 0 Then
                        pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                           
                         pr ("<td align=""left"" class=""td2"" ><input type=""hidden"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField) '& "</td>")
                          
'                            pr ("<td  class=""td2"">")
                             Session("lePathRoot") = GetDefault("PathImg", "Portal_Upload/Catalogue/", Session("candidat_ADOContact"))
                          
                         If Trim(tmp) <> "" Then
                        
                            pr ("<img src='" & Session("PortalPath") & GetDefault("PathImg", "Portal_Upload/Catalogue/", Session("candidat_ADOContact")) & tmp & "' align='middle' name='IMG_" & orgfld & "'>")
                         Else
                            pr ("<img src=""MigVide.jpg"" align=""middle"" name=""IMG_" & orgfld & """>")
                         End If
                          
'                          pr ("<td  class=""td2"">")
                           If Session("candidat_UserType") = "Administrator" Then
                                pr ("<a href=""javascript:openImgBiblio('document.frm." & orgfld & "', 'IMG_" & orgfld & "');"" border=""0"">")
                                pr ("<img src=""OPEN.gif"" border=""0"" align=""middle"">")
                                pr ("</a>")
                                pr ("<a href=""javascript:DelTxt('" & orgfld & " ', 'IMG_');"" border=""0"">")
                                      pr ("<img src=""trash.gif"" border=""0"" align=""middle""></a>")
                                pr ("</a>")
                               
                           End If
                           pr "</td>"
                    End If
                    
                    If InStr(ATTRIBUT, "DOC") > 0 Then
'                          Session("lePathRootDoc") = GetDefault("PathDOC", "Portal_DOC/Catalogue/", Session("candidat_ADOContact"))
                        pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                           
                         pr ("<td align=""left"" class=""td2"" ><input type=""hidden"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField) '& "</td>")
''                         If tmp <> "" Then
'                         Mhref = Session("lePathRootDoc") & tmp
'                         pr "<a target=""blank"" href=""../" & Session("lePathRootDoc") & tmp & """  > Cliquez ici</a>"
'                         Else
'                         pr "<font class=""smallerheader""> Cliquez ici Pas de " & newfld & " disponible !</font>"
'                         End If
                        pr "<a href=""javascript:apercu_Doc('../" & Session("lePathRootDoc") & "','" & orgfld & "','Pas de " & newfld & " disponible !') "" > Cliquez ici</a>"
                        If Session("candidat_UserType") = "Administrator" Then
                                pr ("<a href=""javascript:openDocBiblio('document.frm." & orgfld & "', 'DOC_" & orgfld & "');"" border=""0"">")
                                     pr ("<img src=""he_attach.gif"" border=""0"" align=""middle""></a>")
                                      pr ("<a href=""javascript:DelTxt('" & orgfld & " ','');"" border=""0"">")
                                      pr ("<img src=""trash.gif"" border=""0"" align=""middle""></a>")
                             End If
                        pr " </TD>"
                     
                    
                    End If
                    If InStr(ATTRIBUT, "RDB") > 0 Then
                       If rs0(orgfld) = "OUI" Then
                            chk1 = "checked"
                            chk2 = ""
                           
                        ElseIf rs0(orgfld) = "NON" Then
                            
                            chk2 = "checked"
                            chk1 = ""
                        Else
                            MyValue = ""
                            chk2 = ""
                            chk1 = ""
                        End If
                        pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                        pr ("<td align=""left"" class=""td2"" ><font class=smallerheader><input type=""radio"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk1 & " value=""OUI"">Oui<input type=""radio"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk2 & " value=""NON"">Non " & RequestField & "</font></td>")
                    End If
                    
                    
                    If InStr(ATTRIBUT, "CKB") > 0 Then
                        If rs0(orgfld) = "OUI" Then
                            chk1 = "checked"
                             MyValue = "OUI"
                        Else
                            chk1 = ""
                             MyValue = "NON"
                        End If
                        pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                        pr ("<td align=""left"" class=""td2"" ><font class=smallerheader><input type=""checkbox"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk1 & " value=""OUI"" ) > " & RequestField & "</font></td>")
                        pr ("</tr>")
                        End If
                    
            
            End If
            RS1.MoveNext
    Loop
        pr ("</table>")
        pr ("<input type=""hidden"" name=""numpage"" value=""" & numpage & """>")
        pr ("</form></div></body>")
        If Not flaghtml Then
            pr ("<SCRIPT language=Javascript>function SetVals() {}</script></html>")
        Else
            pr ("</html>")
        End If
        GeneralTools.My_Conn.Close
        Set GeneralTools.My_Conn = Nothing
    End If
    
    If EditMode = False Then
        my_FormatDate = GetDefault("FormatDate", "JJ/MM/AAAA", Session("candidat_ADOContact"))
        my_img_oblig = GetDefault("img_oblig", "boulerose.gif", Session("candidat_ADOContact"))
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM con_FieldDefs where page=" & numpage & " ORDER BY FieldOrder,FieldID")
        Do While Not RS1.EOF
            If Trim(RS1("FieldAlias")) <> "" Then
                orgfld = RS1("Fieldname")
                newfld = RS1("FieldAlias")
                ATTRIBUT = RS1("FieldAttribut")
                IsDisabled = ""
                If InStr(ATTRIBUT, "DAT") > 0 Then newfld = newfld & " " & my_FormatDate
                If InStr(ATTRIBUT, "BR") > 0 Then newfld = "<br></td><td><br></td></tr><td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld
               
                If InStr(ATTRIBUT, "REQ") > 0 Then
                    RequestField = "<img src=""" & my_img_oblig & """ width=""15"" height=""12"" align=""absmiddle"" border=""0"">"
                Else
                    RequestField = ""
                End If
                'If InStr(rs1("FieldAttribut"), "RO") > 0 Then IsDisabled = " DISABLED='' "
                subkey = "sub" & orgfld
                   
                    If InStr(ATTRIBUT, "SYS") > 0 Then
                        Select Case orgfld
                            Case "CreationDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Now & """ tabindex=""1"" >" & Now & Session(subkey)
                            Case "ModificationDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & "" & """ tabindex=""1"" >" & "" & Session(subkey)
                            Case "DeleteDate"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Now & """ tabindex=""1"" >" & Now & Session(subkey)
                            Case "UserId"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & 1 & """ tabindex=""1"" >" & 1 & Session(subkey)
                            Case "ContactId"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""0"" tabindex=""1"" >"
                            Case "LastName"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conLastName") & """ tabindex=""1"" >" & Session("candidat_conLastName") & Session(subkey)
                            Case "FirstName"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conFirstName") & """ tabindex=""1"" >" & Session("candidat_conFirstName") & Session(subkey)
                            Case "Location"
                                tmp = "<input type=""Hidden"" class=""smallerheader""  name=""" & orgfld & """ size=""30"" Value=""" & Session("candidat_conLocation") & """ tabindex=""1"" >" & Session("candidat_conLocation") & Session(subkey)
                            Case "SubCategoryName"
                                 pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                tmp = BuildSubCatList(2, 0, "")
                                 pr ("<td align=""left"" class=""td2"">" & tmp & "</td>")
                                tmp = ""
                            Case "CategoryName"
                                pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                tmp = BuildCatList(1, 0, "")
                                 pr ("<td align=""left"" class=""td2"">" & tmp & "</td>")
                                tmp = ""
                        End Select
                    End If
                    If InStr(ATTRIBUT, "TXT") > 0 Then
                                 pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                pr ("<td align=""left"" class=""td2"" ><input type=""text""  name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & ">" & RequestField & "</td>")
                    End If
                    If InStr(ATTRIBUT, "MEM") > 0 Then
                            If InStr(ATTRIBUT, "HTML") > 0 Then
                                pr ("<td class=""td2"" >")
                                CreateHtmlEditor orgfld, newfld, "", "frm"
                                flaghtml = True
                                pr (RequestField & " </td>")
                            Else
                                 pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                                pr ("<td colspan=""3"" align=""left"" class=""td2"" ><textarea " & IsDisabled & " name=""" & orgfld & """ cols=""50"" rows=""4"" tabindex=""18""></textarea>" & RequestField & "</td>")
                            End If
                    End If
                    If InStr(ATTRIBUT, "CBO") > 0 Then
                             pr ("<tr>")
                                pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                            pr ("<td  class=""td2"">")
                            pr (BuildTableList(orgfld, 1, 0, 0))
                            pr (RequestField & "</td>")
                    End If
                    
                    If InStr(ATTRIBUT, "IMG") > 0 Then
                            pr ("<tr>")
                    pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                            pr ("<td align=""left"" class=""td2"" ><input type=""hidden"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField)
                          
'                            pr ("<td  class=""td2"">")
                         If Trim(tmp) <> "" Then
                            pr ("<img src=""" & GetDefault("PathImg", "Portal_Image/Catalogue/", Session("candidat_ADOContact")) & tmp & """ align=""middle"" name=""IMG_" & orgfld & """>")
                         Else
                            pr ("<img src=""" & "MigVide.jpg"" align=""middle"" name=""IMG_" & orgfld & """>")
                         End If
'                          pr ("<td  class=""td2"">")
'                           If Session("candidat_UserType") = "Administrator" Then
Session("lePathRoot") = GetDefault("PathImg", "Portal_Image/Catalogue/", Session("candidat_ADOContact"))
                                pr ("<a href=""javascript:openImgBiblio('document.frm." & orgfld & "', 'IMG_" & orgfld & "');"" border=""0"">")
                                pr ("<img src=""" & "OPEN.gif"" border=""0"" align=""middle"">")
                                pr ("</a>")
                                pr ("<a href=""javascript:DelTxt('" & orgfld & " ', 'IMG_');"" border=""0"">")
                                      pr ("<img src=""trash.gif"" border=""0"" align=""middle""></a>")
                                pr ("</a>")
'                           End If
                        pr "</td>"
                    End If
                    If InStr(ATTRIBUT, "DOC") > 0 Then
'                          Session("lePathRootDoc") = GetDefault("PathImg", "Portal_Upload/Catalogue/", Session("candidat_ADOContact"))
                        pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                           
                         pr ("<td align=""left"" class=""td2"" ><input type=""hidden"" name=""" & orgfld & """ size=""30"" tabindex=""1"" " & IsDisabled & " value=""" & tmp & """>" & RequestField) '& "</td>")
'                         If tmp <> "" Then
'                         Mhref = Session("lePathRootDoc") & tmp
                         pr "<a href=""javascript:apercu_Doc('../" & Session("lePathRootDoc") & "','" & orgfld & "','Pas de " & newfld & " disponible !') "" > Cliquez ici</a>"
'                         Else
'                         pr "<font class=""smallerheader""> Cliquez ici Pas de " & newfld & "disponible !</font>"
'                         End If
                        If Session("candidat_UserType") = "Administrator" Then
                                pr ("<a href=""javascript:openDocBiblio('document.frm." & orgfld & "', 'DOC_" & orgfld & "');"" border=""0"">")
                                     pr ("<img src=""he_attach.gif"" border=""0"" align=""middle""></a>")
                                      pr ("<a href=""javascript:DelTxt('" & orgfld & " ','');"" border=""0"">")
                                     pr ("<img src=""trash.gif"" border=""0"" align=""middle""></a>")
                                     
                             End If
                        pr " </TD>"
                         pr "  </tr>"
                    
                    End If
                    If InStr(ATTRIBUT, "RDB") > 0 Then
                        chk1 = ""
                        chk2 = ""
                        pr ("<td align=""left"" class=""td2"" ><font class=smallerheader><input type=""radio"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk1 & " value=""OUI"">Oui<input type=""radio"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk2 & " value=""NON"">Non " & RequestField & "</font></td>")
                    End If

                    If InStr(ATTRIBUT, "CKB") > 0 Then
                        chk1 = ""
                         pr ("<tr>")
                        pr ("<td align=""right"" class=""td1"" valign=""top""><font class=""smallerheader"">" & newfld & " : </font></td>")
                        pr ("<td align=""left"" class=""td2"" ><font class=smallerheader><input type=""checkbox"" class=""smallerheader""  name=""" & orgfld & """ tabindex=""1"" " & chk1 & " value=""OUI"">" & RequestField & "</font></td>")
                    End If

                    pr ("</tr>")
            End If
            RS1.MoveNext
    Loop
        pr ("<tr><td colspan=""2"">&nbsp;</td></tr><tr><td colspan=""2"" align=""right""><input type=""button""  class='cmdflat' value=""Valider Etape " & numpage & " sur " & GetDefault("NBPage", 6, Session("candidat_ADOContact")) & """ onClick=""return javSubmit();return SetVals();"">&nbsp;</td></tr></table>")
        pr ("<input type=""hidden"" name=""numpage"" value=""" & numpage & """>")
        pr ("</form></div></body>")
        If Not flaghtml Then
            pr ("<SCRIPT language=Javascript>function SetVals() {return true;}</script></html>")
        Else
            pr ("</html>")
        End If
        GeneralTools.My_Conn.Close
        Set GeneralTools.My_Conn = Nothing
    End If
Else
' formulaire rempli, affichage des infos login/mot de passe:
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    Set Rs = GeneralTools.My_Conn.Execute("SELECT userid FROM " & Session("candidat_MainTable") & " WHERE ContactID = " & Request("ContactID"))

    Response.Redirect "contact.asp?mode=moduser&userid=" & Rs("userid")
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
End If
End Sub


Public Sub FieldList()


    For Each fld In rs0.Fields
                subkey = "sub" & fld.Name
                pr ("<tr>")
                pr ("<td align=""right""><font class=""smallerheader"">" & Session(fld.Name) & "</font></td>")
                Select Case fld.Type
                    Case fldNumAuto
                        pr ("<td align=""left""><input type=""text"" class=""smallerheader""  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & fld.Value & """>" & Session(subkey) & "</td>")
                    Case fldNum
                        pr ("<td align=""left""><input type=""text"" class=""smallerheader""  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & fld.Value & """>" & Session(subkey) & "</td>")
                    Case fldText
                        pr ("<td align=""left""><input type=""text"" class=""smallerheader""  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & fld.Value & """>" & Session(subkey) & "</td>")
                    Case fldMemo
                        pr ("<td colspan=""3"" align=""left""><textarea class='smallerheader' name=""" & fld.Name & """ cols=""50"" rows=""4"" tabindex=""18"">" & fld.Value & "</textarea>" & Session(subkey) & "</td>")
                    Case fldDate
                        pr ("<td align=""left""><input type=""text"" class=""smallerheader""  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & fld.Value & """>" & Session(subkey) & "</td>")
                End Select
                pr ("</tr>")
    Next

End Sub

Public Function lstCategory()
    Response.Expires = 0
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
   
    pr ("<script language='JavaScript'>")
    
   pr ("function javCategory(ID,tabl,TypeListe) {")
    pr ("      location.href='contact.asp?mode=SubCategory&CatId='+ID+'&tabl='+tabl+'&TypeListe='+TypeListe")
    pr ("}")
     
    pr ("function javNewCategory(ID,tabl,TypeListe) {")
    pr ("    location.href='contact.asp?mode=SubCategory&CatId='+ID+'&tabl='+tabl+'&TypeListe='+TypeListe")
    pr ("}")
    
    pr ("function javNewSubCategory(ID,tabl,TypeListe) {")
    pr ("    location.href='contact.asp?mode=SubCategory&CatId=0&CatParent='+ID+'&tabl='+tabl+'&TypeListe='+TypeListe")
    pr ("}")
    If Session("Sessionalert") <> "" Then
      pr ("        alert(""" & Session("Sessionalert") & """);")
      Session("Sessionalert") = ""
   End If
                      
    pr ("</script>")
     pr ("<form name=""MyListe"" action="" method=""post"">")
    TaskBgcolor = GetDefault("color1", "#DCC9B2", Session("candidat_ADOContact"))
    altTaskBgcolor = GetDefault("color2", "#E1D2BF", Session("candidat_ADOContact"))
'    ' CATEGORY
'        pr ("<TABLE border=""0"" bgcolor=""" & GetDefault("bglstcat", "#DCC9B2") & """ width=""100%"" cellspacing='0' cellpadding='0'>")
'        pr ("<tr class='smallheader'>")
'        pr ("<td><b><img src='Param.gif'>&nbsp;" & GetDefault("CategoryName", "") & "</b></td>")
'        pr ("<td><input type=""button"" class=""cmdflat"" value=""Ajouter " & GetDefault("CategoryName", "") & """ onclick=""javascript:javNewCategory(0);""></b></font></a></td>")
'        pr ("<td>" & GetDefault("SubCategoryName", "") & "</td>")
'        pr ("</tr>")
'        tog = 0
        my_catstable = GetDefault("CatsTable", "", Session("candidat_ADOContact"))
        my_puce_cat = GetDefault("puce_cat", "puce_carre.gif", Session("candidat_ADOContact"))
         my_bglstcat = GetDefault("bglstcat", "#DCC9B2", Session("candidat_ADOContact"))
    my_imgparam = GetDefault("imgparam", "Param.gif", Session("candidat_ADOContact"))
        
        
'    Types de pièces

        pr ("<br>")
        pr ("</table>")
        pr ("<hr color=""white"" width=""100%"">")
        pr ("<TABLE border=""0"" bgcolor=""" & my_bglstcat & """ width=""100%"" cellspacing=""0"" cellpadding=""0"">")
        pr ("<tr class=""smallheader"">")
        pr ("<td><b><img src=""" & my_imgparam & """>&nbsp; Types de pièces </b></td>")
        pr ("<td align=""right""><input type=""button"" class=""cmdflat"" value=""Ajouter Types de pièces "" onclick=""javascript:javNewCategory( 0 ,'Menu','Menu');""></td>")
        pr ("<td>&nbsp;</td>")
        pr ("</tr>")
        tog = 0
         Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
    MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
    Set RS1 = New ADODB.Recordset
   Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")

If RS1.EOF = False Then
    Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))

End If
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT Menu.* FROM Menu WHERE menu.PasVisible=false ORDER BY Menu.libelle")
        Do While Not RS1.EOF
            If tog = 1 Then
                tog = 0
                COL = altTaskBgcolor
            Else
                tog = 1
                COL = altTaskBgcolor
            End If
            pr ("<TR bgcolor=""" & COL & """ valign=""Top"">")
            pr ("<TD>")
    
            pr ("<a onMouseOver=""window.status='ModifierMenu " & safeEntry("Encelade_Menu") & "'; return true;"" href=""javascript:javCategory(" & RS1("CatId") & ",'Menu','Menu');""><img src=""" & my_puce_cat & """ border=""0"">&nbsp;<font size=""1"" class=""smallerheader"">" & RS1("libelle") & "</font></a>")
            pr ("</TD>")
            pr ("<TD>&nbsp;</td><td>&nbsp;")
            
'            pr ("<TD><hr color='white' size='1'>")
'
'            Set RS2 = Conn.Execute("SELECT * FROM " & rs("fieldname") & " WHERE CatLevel=2 And CatParent=" & rs1("CatId") & " ORDER BY CatID")
'            Do While Not RS2.EOF
'                 pr ("<a href=""javascript:javCategory(" & RS2("CatID") & ",'" & rs("fieldname") & "')""><img src='puce_carre.gif' border='0'>&nbsp;<font size='1'>" & RS2("CatName") & "</font></a><br>")
'                 RS2.MoveNext
'            Loop
'            pr ("<a href=""javascript:javNewSubCategory(" & rs1("CatID") & ",'" & rs("fieldname") & "')""><img src='add.gif' border='0'></a>")
            pr ("</TD>")
            pr ("</TR>")
            RS1.MoveNext
        Loop
        pr ("</TABLE>")


        
'
'        Set rs1 = conn.execute("SELECT * FROM " & my_catstable & " WHERE CatLevel=1 ORDER BY Catname")
'        Do While Not rs1.EOF
'            If tog = 1 Then
'                tog = 0
'                col = TaskBgcolor
'            Else
'                tog = 1
'                col = altTaskBgcolor
'            End If
'            pr ("<TR bgcolor=""" & col & """ valign=""Top"">")
'            pr ("<TD>")
'
'            pr ("<a onMouseOver=""window.status='Modifier " & safeEntry(rs1("CatName")) & "'; return true;"" href=""javascript:javCategory(" & rs1("CatID") & ",'" & my_catstable & "')""><img src=""" & my_puce_cat & """ border=""0"">&nbsp;<font class=""smallerheader"" size=""1"">" & rs1("CatName") & "</font></a>")
'            pr ("</TD>")
'            pr ("<td></td>")
'            pr ("<TD>")
'
'            Set RS2 = conn.execute("SELECT * FROM " & my_catstable & " WHERE CatLevel=2 And CatParent=" & rs1("CatId") & " ORDER BY Catname")
'            Do While Not RS2.EOF
'                 pr ("<a onMouseOver=""window.status='Modifier " & safeEntry(RS2("CatName")) & "'; return true;"" href=""javascript:javCategory(" & RS2("CatID") & ",'" & my_catstable & "')""><img src=""" & my_puce_cat & """ border=""0"">&nbsp;<font size=""1"" class=""smallerheader"">" & RS2("CatName") & "</font></a><br>")
'                 RS2.MoveNext
'            Loop
'            pr ("<a href=""javascript:javNewSubCategory(" & rs1("CatID") & ",'" & my_catstable & "')""><img src=""add.gif"" border=""0""></a>")
'            pr ("</TD>")
'            pr ("</TR>")
'            rs1.MoveNext
'        Loop
'        pr ("</TABLE>")
'    'TABLES TYPE CBO
 Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
 
    Set Rs = GeneralTools.My_Conn.Execute("select fieldname,fieldalias from con_fielddefs where (fieldname like 'lst%') and not (fieldalias='') order by page, fieldorder")
    my_bglstcat = GetDefault("bglstcat", "#DCC9B2", Session("candidat_ADOContact"))
    my_imgparam = GetDefault("imgparam", "Param.gif", Session("candidat_ADOContact"))
    Do While Not Rs.EOF
    
        pr ("<br>")
      
        pr ("<hr color=""white"" width=""100%"">")
        pr ("<TABLE border=""0"" bgcolor=""" & my_bglstcat & """ width=""100%"" cellspacing=""0"" cellpadding=""0"">")
        pr ("<tr class=""smallheader"">")
        pr ("<td><b><img src=""" & my_imgparam & """>&nbsp;" & Rs("fieldalias") & "</b></td>")
        pr ("<td align=""right""><input type=""button"" class=""cmdflat"" value=""Ajouter " & Rs("fieldalias") & """ onclick=""javascript:javNewCategory(0,'" & Rs("fieldname") & "','');""></td>")
        pr ("<td>&nbsp;</td>")
        pr ("</tr>")
        tog = 0
        Set RS1 = GeneralTools.My_Conn.Execute("SELECT * FROM " & Rs("fieldname") & " WHERE CatLevel=1 ORDER BY Catname")
        Do While Not RS1.EOF
            If tog = 1 Then
                tog = 0
                COL = altTaskBgcolor
            Else
                tog = 1
                COL = altTaskBgcolor
            End If
            pr ("<TR bgcolor=""" & COL & """ valign=""Top"">")
            pr ("<TD>")
    
            pr ("<a onMouseOver=""window.status='Modifier " & safeEntry(RS1("CatName")) & "'; return true;"" href=""javascript:javCategory(" & RS1("CatID") & ",'" & Rs("fieldname") & "','')""><img src=""" & my_puce_cat & """ border=""0"">&nbsp;<font size=""1"" class=""smallerheader"">" & RS1("CatName") & "</font></a>")
            pr ("</TD>")
            pr ("<TD>&nbsp;</td><td>&nbsp;")
            
'            pr ("<TD><hr color='white' size='1'>")
'
'            Set RS2 = Conn.Execute("SELECT * FROM " & rs("fieldname") & " WHERE CatLevel=2 And CatParent=" & rs1("CatId") & " ORDER BY CatID")
'            Do While Not RS2.EOF
'                 pr ("<a href=""javascript:javCategory(" & RS2("CatID") & ",'" & rs("fieldname") & "')""><img src='puce_carre.gif' border='0'>&nbsp;<font size='1'>" & RS2("CatName") & "</font></a><br>")
'                 RS2.MoveNext
'            Loop
'            pr ("<a href=""javascript:javNewSubCategory(" & rs1("CatID") & ",'" & rs("fieldname") & "')""><img src='add.gif' border='0'></a>")
            pr ("</TD>")
            pr ("</TR>")
            RS1.MoveNext
        Loop
        pr ("</TABLE>")
        Rs.MoveNext
    Loop
    pr ("</form>")
    pr ("</body>")
    pr ("</html>")
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
End Function


Public Function SubCategory()
 Dim RsMenu As Recordset
Dim BaseSource As String
Dim BaseCible As String
Dim coparDb As String
Dim Fso As Scripting.FileSystemObject

    fldNumAuto = 3
    fldDate = 135
    fldText = 202
    fldMemo = 203

   If UCase(Request("TypeListe")) = "MENU" Then
      Session("Encelade_TypeListe") = "MENU"
        
    
   Else
    Session("Encelade_TypeListe") = ""
    End If
    
     pr ("<link rel='stylesheet' href='PMainStyle1.asp'>")
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    ray = Split(Request("FieldList"), ",")
   If UBound(ray) > -1 Then
            cible = replaceAccent(Request(ray(0)))
   End If
    Select Case Request("action")
        Case "UpdateCategory"
                   If (Trim("" & Request("libelle")) <> "") Or (Trim("" & Request("CatName")) <> "") Then
           STRSQL = ""
           STRSQL2 = ""
            For I = 0 To UBound(ray) - 1
                STRSQL = STRSQL & ray(I) & " = '" & safeEntry(Request(ray(I))) & "',"
                STRSQL2 = STRSQL2 & "Base Like '%" & safeEntry(cible) & "%',"
            Next I
             
            If Session("Encelade_TypeListe") = "MENU" Then
                Set GeneralTools.My_Conn2 = OpenDb(Session("candidat_ADOContact"))
                Set Rs = GeneralTools.My_Conn2.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
                If Rs.EOF = False Then
                    Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Path"))
                
                End If
                Set Rs = Nothing
                
                GeneralTools.My_Conn2.Close
                Set GeneralTools.My_Conn2 = Nothing
            
            STRSQL = Mid(STRSQL, 1, Len(STRSQL) - 1)
         
            STRSQL2 = Mid(STRSQL2, 1, Len(STRSQL2) - 1)
            Set RsMenu = CreateObject("ADODB.recordset")
            Set RsMenu = GeneralTools.My_Conn.Execute("SELECT Menu.* FROM Menu WHERE  " & STRSQL2)
            
            If RsMenu.EOF = True Then
                
                STRSQL = "UPDATE " & Request("tabl") & " SET " & STRSQL
                GeneralTools.My_Conn.Execute (STRSQL & " WHERE CatID=" & Request("CatId"))
                 
                  Set RsMenu = Nothing
                  Set RsMenu = CreateObject("ADODB.recordset")
                Set RsMenu = GeneralTools.My_Conn.Execute("SELECT Menu.* FROM Menu WHERE CatID=" & Request("CatId"))
                
                If RsMenu.EOF = False Then
                    BaseSource = RsMenu("Base")
                    BaseCible = RsMenu("Path") & "Encelade_" & cible & ".mdb"
                    GeneralTools.My_Conn.Execute "UPDATE Menu SET Menu.Base = '" & BaseCible & "' WHERE Menu.CatId=" & Request("CatId")
                    Const ComparSession = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
                    GeneralTools.My_Conn.Close
                    
                     Set GeneralTools.My_Conn = Nothing
                                      Set Fso = New Scripting.FileSystemObject
                     Set RsMenu = Nothing
                
                    If BaseSource <> BaseCible Then
                    Fso.MoveFile BaseSource, BaseCible
                    Set Fso = Nothing
                    End If
                
                    If Session("candidat_ADOContact") = ComparSession & BaseSource Then
                        Session("candidat_ADOContact") = ComparSession & BaseCible
                    End If
                  Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
                End If
             Else
                pr ("call javascript:javEnceladeMessage(""aa"")")
            End If
            Else
                If Trim("" & Request("CatName")) <> "" Then
                DsnMenu = DsnTableMenu(Session("candidat_ADOContact"))
            Set ConnMenu = OpenDb(DsnMenu)
            Set RsMenu = ConnMenu.Execute("SELECT Menu.* FROM Menu ;")
              If RsMenu.EOF = False Then
                    STRSQL = "UPDATE " & Request("tabl") & " SET "
                    STRSQLval = ""
                    For I = 0 To UBound(ray) - 1
                STRSQLval = STRSQLval & ray(I) & " = '" & safeEntry(Request(ray(I))) & "',"
                
            Next I
            STRSQLval = Left(STRSQLval, Len(STRSQLval) - 1) & " "
                    STRSQL = STRSQL & STRSQLval & " WHERE CatID=" & Request("CatId")
                     ExecSqlListe RsMenu, STRSQL
          
                    End If
                      RsMenu.Close
            Set RsMenu = Nothing
            
            ConnMenu.Close
            Set ConnMenu = Nothing
                End If
            End If
            Else
                        
                        Session("Sessionalert") = "Fiche  non modifiée valeur Nulle !"
                        
                    End If
            Response.Redirect ("contact.asp?mode=lstCategory")
              
            Exit Function
        Case "NewCategory"
        If (Trim("" & Request("libelle")) <> "") Or (Trim("" & Request("CatName")) <> "") Then
            If UCase(Request("tabl")) = "MENU" Then
                Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
            
                MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
                Set RS1 = New ADODB.Recordset
                Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
            
                If RS1.EOF = False Then
                    Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))
            
                End If
           
        End If
            Set Rs = GeneralTools.My_Conn.Execute("select max(catid) as id from " & Request("tabl"))
            If Not Rs.EOF Then
                my_id = IIf(IsNull(Rs("id")), 1, Rs("id") + 1)
            End If
               
            If Request("FieldList") <> "" Then
           
            If Session("Encelade_TypeListe") = "MENU" Then
           
            ray = Split(Request("FieldList"), ",")
               
                STRSQL = "SELECT Menu.*  FROM Menu WHERE Menu.libelle='" & Replace(Replace(Request(ray(0)), Chr(34), "''", 1), "'", "''", 1) & "';"
                 STRSQL2 = "SELECT Menu.*  FROM Menu WHERE " & "Base Like '%" & Replace(Replace(cible, Chr(34), "''", 1), "'", "''", 1) & ".%';"
                Set RsMenu = My_Conn.Execute(STRSQL2)
                
                 
                    If RsMenu.EOF = True Then
                         STRSQL = "Insert Into " & Request("tabl") & " (libelle) VALUES('" & Replace(Replace(Request(ray(0)), Chr(34), "''", 1), "'", "''", 1) & "')"
                         
                        GeneralTools.My_Conn.Execute (STRSQL)
                        
                        Set RsMenu = Nothing
                        
                        STRSQL = "SELECT Menu.*  FROM Menu WHERE Menu.libelle='" & Replace(Replace(Request(ray(0)), Chr(34), "''", 1), "'", "''", 1) & "';"
                        
                      
                        
                        My_Conn.Close
                         Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
                         If UCase(Request("tabl")) = "MENU" Then
                            Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
                            
                            MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
                            Set RS1 = New ADODB.Recordset
                            Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
                            
                            If RS1.EOF = False Then
                                Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))
                            
                            End If
                        End If
                         Set RsMenu = My_Conn.Execute(STRSQL)
                        If RsMenu.EOF = False Then
                        
                             BaseSource = RsMenu("Model")
                             BaseCible = RsMenu("Path") & RsMenu("Prefix") & replaceAccent(RsMenu("libelle")) & RsMenu("Extension")
                             
                             STRSQL = "UPDATE Menu SET Menu.Base = '" & Replace(Replace(BaseCible, "'", "''", 1), Chr(34), Chr(34) & Chr(34), 1) & "'  WHERE Menu.CatId=" & RsMenu("CatId") & ";"
                             My_Conn.Execute (STRSQL)
                             Set Fso = New Scripting.FileSystemObject
                             
                             Fso.CopyFile BaseSource, BaseCible
                             
                             Set RsMenu = Nothing
                             Set Fso = Nothing
                        End If
                    Else
                        pr ("<script language='JavaScript'>")
                        pr ("        alert(""" & RsMenu("libelle") & " " & RsMenu("Mssage") & """);")
                        pr ("</script>")
                    End If
                
            Else
            DsnMenu = DsnTableMenu(Session("candidat_ADOContact"))
            Set ConnMenu = OpenDb(DsnMenu)
            Set RsMenu = ConnMenu.Execute("SELECT Menu.* FROM Menu ;")
            STRSQL = "Insert Into " & Request("tabl") & "(catid, UserID,CatParent,CatLevel"
         
            ray = Split(Request("FieldList"), ",")
            For I = 0 To UBound(ray) - 1
                STRSQL = STRSQL & "," & ray(I)
            Next I
            STRSQL = STRSQL & ") VALUES(" & my_id & ",0,0,1"
            ray = Split(Request("FieldList"), ",")
            For I = 0 To UBound(ray) - 1
                STRSQL = STRSQL & ",'" & Request(ray(I)) & "'"
            Next I
            STRSQL = STRSQL & ")"
            ExecSqlListe RsMenu, STRSQL
            RsMenu.Close
            Set RsMenu = Nothing
            
            ConnMenu.Close
            Set ConnMenu = Nothing
            End If
            
          End If
          Else
         
                        pr ("<script language='JavaScript'>")
                        pr ("        alert('" & GetMessage("FicheNonCreeValeuNulle", "Fiche non crée valeur Nulle !", DsnTableMenu(Session("candidat_ADOContact"))) & "');")
                        pr ("</script>")
          End If
        Case "NewSubCategory"
        If Trim("" & Request("CatName")) <> "" Then
            Set Rs = GeneralTools.My_Conn.Execute("select max(catid) as id from " & Request("tabl"))
            If Not Rs.EOF Then
                my_id = IIf(IsNull(Rs("id")), 1, Rs("id") + 1)
            End If
            STRSQL = "Insert Into " & Request("tabl") & "(catid,UserID,CatParent,CatLevel"
            ray = Split(Request("FieldList"), ",")
            For I = 0 To UBound(ray) - 1
                STRSQL = STRSQL & "," & ray(I)
            Next I
            STRSQL = STRSQL & ") VALUES(" & my_id & ",0," & Request("Parent") & ",2"
            ray = Split(Request("FieldList"), ",")
            For I = 0 To UBound(ray) - 1
                STRSQL = STRSQL & ",'" & Request(ray(I)) & "'"
            Next I
            STRSQL = STRSQL & ")"
            GeneralTools.My_Conn.Execute (STRSQL)
            Response.Redirect ("contact.asp?mode=lstCategory")
            End If
            Exit Function
        Case "DeleteCategory"
             If Session("Encelade_TypeListe") = "MENU" Then
         
            Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
            MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
            Set RS1 = New ADODB.Recordset
            Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
            
            If RS1.EOF = False Then
            Dim Path_Menu As String
            Path_Menu = RS1("Path")
            GeneralTools.My_Conn.Close
            Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Path_Menu)
            
            End If
        
                Set RsMenu = GeneralTools.My_Conn.Execute("select Menu.*  FROM Menu WHERE Menu.CatId=" & Request("CatId") & " AND Menu.PasVisible=False;")
                If RsMenu.EOF = False Then
                    BaseSource = RsMenu("Base")
'                GeneralTools.My_Conn.Execute "DELETE con_contacts.*, con_contacts.CatId FROM con_contacts WHERE con_contacts.CatId=" & Request("CatId") & ";"
                    GeneralTools.My_Conn.Execute ("delete * from " & Request("tabl") & " where CatID=" & Request("CatId"))
                       coparDb = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
                       coparDb = coparDb & BaseSource
'                        GeneralTools.My_Conn.Close
'                        Set GeneralTools.My_Conn = Nothing
                        Set Fso = New Scripting.FileSystemObject
                    
                    If Fso.FileExists(BaseSource) = True Then
                    
                 
                      Fso.DeleteFile BaseSource
                     
                       If Session("candidat_ADOContact") = coparDb Then
                           Session("Encelade_CatId") = ""
                            Session("candidat_ADOContact") = ""
                       End If
                    End If
                End If
            Else
                 DsnMenu = DsnTableMenu(Session("candidat_ADOContact"))
            Set ConnMenu = OpenDb(DsnMenu)
            Set RsMenu = ConnMenu.Execute("SELECT Menu.* FROM Menu ;")
            If RsMenu.EOF = False Then
                  STRSQL = "delete * from " & Request("tabl") & " where CatID=" & Request("CatId")
                   ExecSqlListe RsMenu, STRSQL
                   End If
            RsMenu.Close
            Set RsMenu = Nothing
            
            ConnMenu.Close
            Set ConnMenu = Nothing
            End If
            GeneralTools.My_Conn.Close
            Set GeneralTools.My_Conn = Nothing
            Response.Redirect ("contact.asp?mode=lstCategory")
            Exit Function
    End Select
   
    If val(Request("CatId")) > 0 And Len(Request("CatParent")) = 0 Then ' Edit Category or Sub Category
        If UCase(Request("tabl")) = "MENU" Then

            Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
            MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
            Set RS1 = New ADODB.Recordset
            Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
            
            If RS1.EOF = False Then
            Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))
            
            End If
        End If
        Set rs0 = GeneralTools.My_Conn.Execute("select * from " & Request("tabl") & " where CatId=" & Request("CatId"))
        flagEdit = True
        PG = "contact.asp?mode=SubCategory&action=UpdateCategory"
    End If
    
    If val(Request("CatId")) = 0 And Len(Request("CatParent")) = 0 Then ' New Category
        If UCase(Request("tabl")) = "MENU" Then
            Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
            
            MyConnecSting = "DRIVER={Microsoft Access Driver (*.mdb)};DBQ="
            Set RS1 = New ADODB.Recordset
            Set RS1 = GeneralTools.My_Conn.Execute("SELECT BaseDefault.Path FROM BaseDefault;")
            
            If RS1.EOF = False Then
                Set GeneralTools.My_Conn = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RS1("Path"))
            
            End If
        End If
        Set rs0 = GeneralTools.My_Conn.Execute("select * from " & Request("tabl") & "")
        flagEdit = False
        PG = "contact.asp?mode=SubCategory&action=NewCategory"
    End If
    
    If Request("CatId") = 0 And Len(Request("CatParent")) > 0 Then ' New Sub Category
        Set rs0 = GeneralTools.My_Conn.Execute("select * from " & Request("tabl") & "")
        flagEdit = False
        PG = "contact.asp?mode=SubCategory&action=NewSubCategory"
    End If
    
    pr ("<script language='JavaScript'>")
    pr ("function javDelete(ID) {")
    
'    TypeListe=MENU
    If Session("Encelade_TypeListe") = "MENU" Then
        pr ("    if (confirm(""Supprimer cette fiche supprimera la base associée?"")) {")
        pr ("      location.href='contact.asp?TypeListe=MENU&mode=SubCategory&action=DeleteCategory&tabl=" & Request("tabl") & "&CatID=' + ID")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    Else
        pr ("    if (confirm('" & GetMessage("SuppFiche", "Supprimer cette fiche?", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {")
        pr ("      location.href('contact.asp?mode=SubCategory&action=DeleteCategory&tabl=" & Request("tabl") & "&CatID=' + ID)")
        pr ("    } else {")
        pr ("        return")
        pr ("    }")
        pr ("}")
    End If

    
    

    pr ("</script>")
    
    pr ("<table class=""table"">")
     If UCase(Session("Encelade_TypeListe")) = "MENU" Then
        PG = PG & "&TypeListe=MENU"
     End If
    pr ("<form name=""frm"" action=""" & PG & """  method=""post"" >")
    
    If UCase(Session("Encelade_TypeListe")) = "MENU" Then
 
    
      For Each fld In rs0.Fields
      
        If UCase(fld.Name) = "LIBELLE" Then
        InputType = "text"
                    fieldNAME = fld.Name
                    ListofFields = ListofFields & fld.Name & ","
        Else
             InputType = "Hidden"
                    fieldNAME = ""
        End If
         pr ("<tr>")
                If UCase(fieldNAME) = "LIBELLE" Then pr ("<td align=""right""><font class=""smallerheader"">Intitulé</font></td>")
                If flagEdit = True Then
                    MyValue = fld.Value
                Else
                    MyValue = ""
                End If
        Select Case fld.Type
                    Case fldNumAuto
                        pr ("<td align=""left"" class=""smallerheader"" ><input type=""" & InputType & """ name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                    Case fldNum
                        pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                    Case fldText
                        pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                    Case fldMemo
                        pr ("<td colspan=""3"" align=""left"" class='smallerheader'><textarea name=""" & fld.Name & """ cols=""50"" rows=""4"" tabindex=""18"">" & MyValue & "</textarea></td>")
                    Case fldDate
                        pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                End Select
                pr ("</tr>")
      Next
   
    Else
     Session("Encelade_TypeListe") = ""
    For Each fld In rs0.Fields
                If fld.Name = "CatID" Or fld.Name = "UserID" Or fld.Name = "CatLevel" Or fld.Name = "CatParent" Then
                    InputType = "Hidden"
                    fieldNAME = ""
                Else
                    InputType = "text"
                    fieldNAME = fld.Name
                    ListofFields = ListofFields & fld.Name & ","
                End If
                pr ("<tr>")
                If fieldNAME = "CatName" Then pr ("<td align=""right""><font class=""smallerheader"">Intitulé</font></td>")
                If flagEdit = True Then
                    MyValue = fld.Value
                Else
                    MyValue = ""
                End If
                Select Case fld.Type
                    Case fldNumAuto
                        pr ("<td align=""left"" class=""smallerheader"" ><input type=""" & InputType & """ name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                    Case fldNum
                        pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                    Case fldText
                        If fld.Name = "CatName" Then
                            pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                        Else
                        pr ("<td align=""right"" class=""smallerheader"">" & fld.Name & "<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                        End If
                    Case fldMemo
                        pr ("<td colspan=""3"" align=""left"" class='smallerheader'><textarea name=""" & fld.Name & """ cols=""50"" rows=""4"" tabindex=""18"">" & MyValue & "</textarea></td>")
                    Case fldDate
                        pr ("<td align=""left"" class=""smallerheader""><input type=""" & InputType & """  name=""" & fld.Name & """ size=""30"" tabindex=""1"" value=""" & MyValue & """></td>")
                End Select
                pr ("</tr>")
    Next
    End If
'pr ("</td></tr>")
pr ("<tr><td>&nbsp;</td><td>&nbsp;</td></tr>")
pr ("<tr><td colspan=""2"">")
pr ("<input type=""submit"" class=""cmdflat"" value=""Valider"">&nbsp;")
If flagEdit = True Then
    pr ("<input type=""button"" class=""cmdflat"" value=""Supprimer"" onClick=""javascript:javDelete(" & Request("CatId") & ");"">&nbsp;")
End If

pr ("<script language='javascript'>")
pr ("function javRetour() {")
pr ("   location.href = 'contact.asp?mode=LSTCATEGORY'")
pr ("}")
pr ("</script>")
 
pr ("<input type=""button"" class=""cmdflat"" value=""Annuler"" onClick=""javascript:javRetour();"">&nbsp;")
pr ("<input type=""hidden"" name=""Parent"" value=""" & Request("CatParent") & """ >")
pr ("<input type=""hidden"" name=""tabl"" value=""" & Request("tabl") & """ >")
pr ("<input type=""hidden"" name=""FieldList"" value=""" & ListofFields & """ >")
pr ("</td></tr>")
pr ("</form></table>")
'pr ("</center>")
pr ("</body>")
pr ("</html>")

End Function

Public Sub modUser()
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
    If Request("action") = "subEdit" Then
        Set Rs = GeneralTools.My_Conn.Execute("select password from users where userid=" & Request("userid"))
        my_old_pass = Rs("password")
        Set Rs = Nothing
        STRSQL = "UPDATE Users SET "
        STRSQL = STRSQL & "password = '" & safeEntry(Request("Password")) & "' "
        STRSQL = STRSQL & "WHERE UserID = " & Request("UserID")
        GeneralTools.My_Conn.Execute (STRSQL)
        'pg = "modUser.asp?mode=web_lst&msg=Update+successful."
        'Response.Redirect pg
        Set Rs = GeneralTools.My_Conn.Execute("select * from " & Session("candidat_MainTable") & " where userid=" & Request("userid"))
        If my_old_pass = "" Or IsNull(my_old_pass) Then
            my_text = "Nouvelle inscription à " & Now() & vbCrLf & vbCrLf
            my_text = my_text & "Login  : " & Request("username") & vbCrLf
            my_text = my_text & "Nom    : " & Rs(GetDefault("nom", "", Session("candidat_ADOContact"))) & vbCrLf
            my_text = my_text & "Prénom : " & Rs(GetDefault("prenom", "", Session("candidat_ADOContact"))) & vbCrLf
            SendEmail "Moteur de CV", "Espace Candidat", GetDefault("WebMaster", "webmaster@euxia.net", Session("candidat_ADOContact")), "Nouvel inscrit", my_text
        End If
        my_welcome_text = Replace(Replace(GetDefault("texte_bienvenue", "", Session("candidat_ADOContact")), "[nom]", Rs(GetDefault("nom", "", Session("candidat_ADOContact")))), "[prenom]", Rs(GetDefault("prenom", "", Session("candidat_ADOContact")))) & vbCrLf & vbCrLf
        my_welcome_text = my_welcome_text & "Votre compte       : " & Request("username") & vbCrLf
        my_welcome_text = my_welcome_text & "Votre mot de passe : " & Request("password")
        SendEmail "Espace Candidat", GetDefault("WebMaster", "webmaster@euxia.net", Session("candidat_ADOContact")), Rs(GetDefault("email", "txt12", Session("candidat_ADOContact"))), "Vos identifiants ", my_welcome_text
        Response.Redirect ("espace.asp?contactid=" & Rs("contactid"))
    Else
    
        Set rs0 = GeneralTools.My_Conn.Execute("SELECT * FROM Users WHERE UserID= " & Request("userid"))
        If rs0.EOF Then
            Response.Redirect "modUser.asp?mode=web_lst&msg=Statut:+utilisateur+inconnu."
        End If
        pr ("<html>")
        pr ("<head>")
        pr ("<title></title>")
        pr ("</head>")
        pr ("<script language='JavaScript'>")
        pr ("function javSubmit() {")
        pr ("    if (document.frm.Password.value.length == 0) {")
        
        pr ("        alert(""Un mot de passe est requis."");")
        pr ("        document.frm.Password.focus();")
        pr ("        return")
        pr ("    }")
        pr ("    else if (document.frm.Password2.value != document.frm.Password.value) {")
        pr ("        alert(""Echec de la confirmation du mot de passe"");")
        pr ("        document.frm.Password2.focus();")
        pr ("        return")
        pr ("    }")
        pr ("    else document.frm.submit()")
        pr ("}")
            
        pr ("</script>")
        
        pr ("<link rel=""stylesheet"" href=""PMainStyle1.asp"">")
        pr ("<body onLoad=""document.frm.Password.focus();"">")
            
        
        '***************  TitleBar
        pr ("<table border=""0"" width=""100%"" cellpadding=""1"" cellspacing=""0""><tr><td>")
        pr ("<table border=""0"" width=""100%"" cellpadding=""1"" cellspacing=""0"">")
        pr ("<tr valign=""bottom"">")
        pr ("<td align=""left"" class=""header"">")
        pr ("<b>Paramètres de connexion </b>")
        pr ("</td>")
        pr ("</tr>")
        pr ("</table>")
        pr ("</td></tr></table>")
    
        If Len(Request("msg")) > 0 Then
            pr ("<table border=""0""><tr><td>" & Request("msg") & "</td></tr></table>")
        End If
        
        pr ("<form name='frm' action='contact.asp?mode=modUser' method='post'>")
        pr ("<input type='hidden' name='action' value='subEdit'>")
        pr ("<input type='hidden' name='username' value='" & rs0("username") & "'>")
        pr ("<input type='hidden' name='UserID' value='" & rs0("userid") & "'>")
        pr ("<font class='smallerheader'><center>Vos paramètres de connexion et votre mot de passe vous seront envoyés par e-mail.</center></font><br>")
            
        pr ("<table border='0' Align='center'>")
        
        pr ("<tr>")
        pr ("<td align='right' class='smallerheader'>Nom : </td>")
        pr ("<td class='td2'><font class=smallerheader>" & rs0("LastName") & "</font></td>")
        pr ("</tr>")
            
        pr ("<tr>")
        pr ("<td align='right' class='smallerheader'>Prénom : </td>")
        pr ("<td class='td2'><font class=smallerheader>" & rs0("FirstName") & "</font></td>")
        pr ("</tr>")
            
        pr ("<tr>")
        pr ("<td align='right' class='smallerheader'>Login : </td>")
        pr ("<td class='td2'><font class=smallerheader>" & rs0("UserName") & "</font></td>")
        pr ("</tr>")
        
        pr ("<tr>")
        pr ("<td align='right'  class='smallerheader'>Mot de passe</td>")
        pr ("<td class='td2'><input type='Password' name='Password' size='20' value='" & rs0("password") & "'></td>")
        pr ("</tr>")
        
        pr ("<tr>")
        pr ("<td align='right'  class='smallerheader'>Confirmation</td>")
        pr ("<td class='td2'><input type='Password' name='Password2' size='20' value='" & rs0("password") & "'></td>")
        pr ("</tr>")
        
        pr ("<tr><td>&nbsp;</td><td>&nbsp;</td></tr>")

 
        pr ("<tr>")
        pr ("<td>&nbsp;</td>")
        pr ("<td>")
        pr ("<input type='button'  class='cmdflat'   value='Valider' onClick='javSubmit();'>&nbsp;")
        pr ("</tr>")
            
        pr ("</table>")
            
            
        pr ("</form>")
            
        pr ("</body>")
        pr ("</html>")
    
    End If
GeneralTools.My_Conn.Close
Set GeneralTools.My_Conn = Nothing
End Sub



Public Sub SendEmail(NameFrom, EmailFrom, MailTo, EmailSubject, EmailText)

Dim my_Mail
    Set my_Mail = Server.CreateObject("CDONTS.NewMail")
    my_Mail.BodyFormat = 1 ' Text Only, 0 for HTML
    my_Mail.Subject = EmailSubject
    my_Mail.To = MailTo
    my_Mail.Body = EmailText
    my_Mail.Send (NameFrom & "<" & EmailFrom & ">")
    Set my_Mail = Nothing
    
    
End Sub

Public Sub forgotpass()
    
    Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
    
    Set Rs = GeneralTools.My_Conn.Execute("select * from " & Session("candidat_MainTable") & " as c,users as u where u.userid=c.SocieteId and u.username='" & Request("username") & "'")
    If Not Rs.EOF Then
        my_text = GetDefault("texte_password", "", Session("candidat_ADOContact")) & vbCrLf & vbCrLf
        my_text = my_text & "Vos paramètres de connexion " & vbCrLf
        my_text = my_text & "----------------------------" & vbCrLf & vbCrLf
        my_text = my_text & "Nom                : " & Rs(GetDefault("nom", "", Session("candidat_ADOContact"))) & vbCrLf
        my_text = my_text & "Prénom             : " & Rs(GetDefault("prenom", "", Session("candidat_ADOContact"))) & vbCrLf
        my_text = my_text & "Votre Compte       : " & Rs("username") & vbCrLf
        my_text = my_text & "Votre mot de passe : " & Rs("password")
        SendEmail "Espace Candidat", GetDefault("WebMaster", "webmaster@euxia.net", Session("candidat_ADOContact")), Rs(GetDefault("email", "txt12", Session("candidat_ADOContact"))), "Vos identifiants ", my_text
        Response.Redirect "frmlogon.asp?msg=Email+Envoyé"
    Else
        Response.Redirect "forgotpass.asp?msg=Compte+Inconnu"
    End If
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
End Sub
Sub CreateHtmlEditor(fieldNAME, fieldCAPTION, FieldVALUE, NomForm)
 
  
pr (vbCrLf)
pr (vbCrLf)
pr ("<link rel=""stylesheet"" type=""text/css"" href=""ifedit.css"">")
pr ("<table border=""0"" cellspacing=""0"" cellpadding=""3"" width=""600px"">")
pr ("<tr>")
pr ("<td colspan=""2"">")
pr ("<SCRIPT SRC=""ifeditscript.js""></SCRIPT>")
pr ("<TEXTAREA NAME=""" & fieldNAME & """ style=""visibility:hidden;position:absolute;top:0px;left:0px"">" & FieldVALUE & "<P></TEXTAREA><BR>")
pr ("</td></tr><tr><td colspan=2 align=""center"">")
pr ("<BR></td>")
pr ("</tr></table></DIV>")
pr (vbCrLf)
pr (vbCrLf)
 
TargetObject = "document." & NomForm & "." & fieldNAME & ".value"
 

pr ("<SCRIPT>")
 
pr ("function SetVals() {")
pr (TargetObject & " = editor.GetHTML();")
pr ("    if (" & TargetObject & " == '<P></P>')")
pr ("       { " & TargetObject & " = ''; }")
pr ("}")
pr ("</SCRIPT>")
 
pr ("<BODY onload=""editor.SetHTML(" & TargetObject & ");""")
 
FlagHTMLEditor = True
 
End Sub

Private Function ImgLste(orgfld As String)

End Function


Function MyCloseWhere() As String
Dim txt As String
Dim TxtChamp As String
Dim TxtChamp2 As String
Dim TxtOperateur As String
Dim TxtValeur As String
Dim TxtLogique As String
Dim BoolNull As Boolean
Dim IsNuber As Boolean
Dim Rs As Recordset
Dim Sql As String
 Session("CloseWhereFrom") = ""
 Dim radiobutton
 Session("CloseWhereOrder") = ""
  Session("CloseWhereFrom") = ""
'.catname
txt = ""
   radiobutton = Request("radiobutton")
nbLignes = CInt(Request("nbSelect"))
  For I = 1 To nbLignes
 

 TxtOperateur = Request("Operateur" & CStr(I))
    TxtChamp = Request("Champ" & CStr(I))
    TxtChamp2 = TxtChamp
    TxtValeur = Request("Valeur" & CStr(I))
   IsNuber = False
 Sql = "SELECT DISTINCT con_FieldDefs.FieldAttribut "
 Sql = Sql & "FROM con_FieldDefs LEFT JOIN con_Fields ON con_FieldDefs.FieldID = con_Fields.FieldID "
 Sql = Sql & "WHERE con_FieldDefs.FieldName='" & TxtChamp & "';"
Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
Set Rs = GeneralTools.My_Conn.Execute(Sql)
If InStr(1, UCase("" & Rs("FieldAttribut")), "NUM") <> 0 Then IsNuber = True
    Rs.Close
    Set Rs = Nothing
    GeneralTools.My_Conn.Close
    Set GeneralTools.My_Conn = Nothing
    If Trim(TxtValeur) = "" Then
        BoolNull = True
    Else
        BoolNull = False
    End If
   
    TxtLogique = Request("Logique" & CStr(I))
 If InStr(1, UCase(TxtChamp), "LST") <> 0 Then
     Session("CloseWhereFrom") = Session("CloseWhereFrom") & TxtChamp & vbCrLf

    TxtChamp = "[" & TxtChamp & "].[catname]"

 Else
    TxtChamp = "[con_Contacts].[" & TxtChamp & "]"
    
 End If
 
 
  If TxtChamp = "" Then Exit Function
   If radiobutton = CStr(I) Then
        Session("CloseWhereOrder") = TxtChamp & " "
    End If
  If radiobutton = CStr(I) & "DESC" Then
        Session("CloseWhereOrder") = TxtChamp & " Desc "
    End If
  Select Case Trim(TxtOperateur)
       
        Case "<"
               
                If BoolNull = False Then
                    If IsNuber = True Then
                        txt = txt & "(val('' & " & TxtChamp & ")  <   val('" & TxtValeur & "')  ) " & TxtLogique
                    Else
                        txt = txt & " (" & TxtChamp & " < '" & TxtValeur & "' ) " & TxtLogique
                    End If
                    
                Else
                    If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                  
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
        Case "<="
                If BoolNull = False Then
                   If IsNuber = True Then
'                    txt = txt & "(val('' & " & TxtChamp & ")  <   val('" & TxtValeur & "') and " & TxtChamp & " <> '' ) "
                        txt = txt & " (val('' & " & TxtChamp & ") <= val('" & TxtValeur & "') ) " & TxtLogique
                   Else
                     txt = txt & " (" & TxtChamp & "<= '" & TxtValeur & "' ) " & TxtLogique
                   End If
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
                
        Case "="
                If BoolNull = False Then
                If IsNuber = True Then
                        txt = txt & "(val('' & " & TxtChamp & ")  =   val('" & TxtValeur & "') ) " & TxtLogique
                        Else
                 txt = txt & " (" & TxtChamp & " = '" & TxtValeur & "') " & TxtLogique
                 End If
                 
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
                 
        Case "=>"
                If BoolNull = False Then
                If IsNuber = True Then
                        txt = txt & "(val('' & " & TxtChamp & ")  >=  val('" & TxtValeur & "')  ) " & TxtLogique
                Else
                 txt = txt & " (" & TxtChamp & ">= '" & TxtValeur & "' ) " & TxtLogique
                End If
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
                 
        Case ">"
                If BoolNull = False Then
                    
                    If IsNuber = True Then
                        txt = txt & "(val('' & " & TxtChamp & ")  >   val('" & TxtValeur & "')  ) " & TxtLogique
                    Else
                        txt = txt & " (" & TxtChamp & " > '" & TxtValeur & "') " & TxtLogique
                    End If
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
                 
        Case "<>"
                If BoolNull = False Then
                 
                    If IsNuber = True Then
                        txt = txt & "(val('' & " & TxtChamp & ")  <>   val('" & TxtValeur & "') ) " & TxtLogique
                    Else
                    txt = txt & " (" & TxtChamp & " <> '" & TxtValeur & "') " & TxtLogique
                    End If
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
                 
        Case "LIKE1"
                If BoolNull = False Then
                     TxtValeur = TxtValeur & "*"
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
               
                TxtValeur = Replace(TxtValeur, "*", "%", 1)
                TxtValeur = Replace(TxtValeur, "'", "''", 1)
                TxtValeur = Replace(TxtValeur, Chr(34), Chr(34) & Chr(34), 1)
                txt = txt & " (" & TxtChamp & " LIKE '" & TxtValeur & "') " & TxtLogique

        Case "LIKE2"
                If BoolNull = False Then
                    TxtValeur = "*" & TxtValeur
                Else
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
                End If
               
                TxtValeur = Replace(TxtValeur, "*", "%", 1)
                TxtValeur = Replace(TxtValeur, "'", "''", 1)
                TxtValeur = Replace(TxtValeur, Chr(34), Chr(34) & Chr(34), 1)
                txt = txt & " (" & TxtChamp & " LIKE '" & TxtValeur & "') " & TxtLogique
         
         Case "LIKE"
               
                      If Session("portal_candidat_Recherhe") = 1 Then MyCloseWhere = "": Exit Function
                    'txt = txt & " (" & TxtChamp & " Is NULL ) " & TxtLogique
               
            
               
                TxtValeur = Replace(TxtValeur, "'", "''", 1)
                TxtValeur = Replace(TxtValeur, Chr(34), Chr(34) & Chr(34), 1)
                txt = txt & " (" & TxtChamp & " LIKE '%" & TxtValeur & "%') " & TxtLogique
  End Select
  
   
Next I
txt = " " & Replace(txt, "(Aucun)", "", 1) & " "
MyCloseWhere = txt
End Function
Private Function con_frmSetting()
        Response.Expires = 0
          Session("CANDIDAT_CURRENTPAGE") = "CON_FRMSETTING.ASP"
              
          

 
   
          If Request("MODE2") = "EXECUTE" Then
                If Request("USER_ACTION") = "VALEURS PAR DÉFAUT" Then
               
'SetDefault "CON_BGCOLOR", "#DCC9B2", Session("candidat_ADOContact")
'
' SetDefault "COLOR1", "#DCC9B2", Session("candidat_ADOContact")
'
' SetDefault "COLOR2", "#E1D2BF", Session("candidat_ADOContact")
               
SetDefault "DEFAULTFIELDSORTBY", "TXT1", Session("candidat_ADOContact")
SetDefault "StockEncelade", "TXT81", Session("candidat_ADOContact")
SetDefault "IndexAlpha", "TXT1", Session("candidat_ADOContact")

SetDefault "ChampQuantite", "txt11", Session("candidat_ADOContact")
             
'               PathImg"" VALUE=" & GetDefault("PathImg", "Portal_Image/Catalogue/") & "></TD>       ")
SetDefault "PathImg", "Portal_Image/Catalogue/", Session("candidat_ADOContact")
SetDefault "PathDOC", "Portal_DOC/Catalogue/", Session("candidat_ADOContact")
'
'   con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("ALLCATEGORIES", "TOUS LES UTILISATEURS")
'
SetDefault "TABLES", "Listes", Session("candidat_ADOContact")
SetDefault "RefCaddy", "txt1", Session("candidat_ADOContact")
SetDefault "RefCaddyPrixU", "txt1", Session("candidat_ADOContact")
SetDefault "RefCaddyDesignation", "txt1", Session("candidat_ADOContact")
SetDefault "NBLignesRecherche", "25", Session("candidat_ADOContact")

'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TITREPAGE1", "ETAT CIVIL")
'
'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TITREPAGE2", "FORMATION")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("TITREPAGE3", "EXPERIENCE")
'
'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TITREPAGE4", "RÉFÉRENCES")
'
'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TITREPAGE5", "FONCTIONS RECHERCHÉES")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("TITREPAGE6", "DIVERS")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("WEBMASTER", "WEBMASTER@CL-INNOVATION.FR")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("NOM", "TXT1")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("PRENOM", "TXT2")
'
'  con_frmSetting=con_frmSetting & vbCrLf &  SetDefault("EMAIL", "TXT12")
'
'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TEXTE_BIENVENUE", "BIENVENUE [NOM] [PRENOM] !")
'
'  con_frmSetting=con_frmSetting &  vbCrLf & SetDefault("TEXTE_PASSWORD", "VOUS TROUVEREZ CI-APRÈS VOS PARAMÈTRES")
 msg = GetMessage("VALEURSPARDEFAUTACTIVEES", "VALEURS PAR DÉFAUT ACTIVÉES", DsnTableMenu(Session("candidat_ADOContact")))
                Else
               
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("CON_BGCOLOR", safeEntry(Request("CON_BGCOLOR")), Session("candidat_ADOContact"))
'
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("COLOR1", safeEntry(Request("COLOR1")), Session("candidat_ADOContact"))
'
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("COLOR2", safeEntry(Request("COLOR2")), Session("candidat_ADOContact"))
               
  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("DEFAULTFIELDSORTBY", safeEntry(Request("DEFAULTFIELDSORTBY")), Session("candidat_ADOContact"))
               
  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("IndexAlpha", safeEntry(Request("IndexAlpha")), Session("candidat_ADOContact"))
  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("ChampQuantite", safeEntry(Request("ChampQuantite")), Session("candidat_ADOContact"))
               
  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("PathImg", safeEntry(Request("PathImg")), Session("candidat_ADOContact"))
    con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("PathDOC", safeEntry(Request("PathDOC")), Session("candidat_ADOContact"))

  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("RefCaddy", safeEntry(Request("RefCaddy")), Session("candidat_ADOContact"))
  SetDefault "RefCaddyPrixU", safeEntry(Request("RefCaddyPrixU")), Session("candidat_ADOContact")
  SetDefault "RefCaddyDesignation", safeEntry(Request("RefCaddyDesignation")), Session("candidat_ADOContact")
    SetDefault "NBLignesRecherche", safeEntry(Request("NBLignesRecherche")), Session("candidat_ADOContact")
     SetDefault "StockEncelade", safeEntry(Request("StockEncelade")), Session("candidat_ADOContact")

  
'  RefCaddy
               
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("ALLCATEGORIES", safeEntry(Request("ALLCATEGORIES")))
               
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TABLES", safeEntry(Request("TABLES")))
               
'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TITREPAGE1", safeEntry(Request("TITREPAGE1")))

'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TITREPAGE2", safeEntry(Request("TITREPAGE2")))

'  con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("TITREPAGE3", safeEntry(Request("TITREPAGE3")), Session("candidat_ADOContact"))

' con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TITREPAGE4", safeEntry(Request("TITREPAGE4")))
''
' con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TITREPAGE5", safeEntry(Request("TITREPAGE5")))
'
'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TITREPAGE6", safeEntry(Request("TITREPAGE6")))
'
'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("WEBMASTER", safeEntry(Request("WEBMASTER")))
'
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("NOM", safeEntry(Request("NOM")))
'
'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("PRENOM", safeEntry(Request("PRENOM")))
'
'  con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("EMAIL", safeEntry(Request("EMAIL")))
'
'   con_frmSetting = con_frmSetting & vbCrLf &  vbCrLf & SetDefault("TEXTE_BIENVENUE", safeEntry(Request("TEXTE_BIENVENUE")))

' con_frmSetting = con_frmSetting & vbCrLf & vbCrLf & SetDefault("TEXTE_PASSWORD", safeEntry(Request("TEXTE_PASSWORD")), Session("candidat_ADOContact"))
 msg = GetMessage("ParamMaj", "PARAMÈTRES MIS À JOUR", DsnTableMenu(Session("candidat_ADOContact")))
                 End If
           End If
          

'   con_frmSetting = con_frmSetting & vbCrLf &  ("<HTML>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<HEAD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TITLE>SETTINGS</TITLE>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("</HEAD>       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<SCRIPT LANGUAGE=""JAVASCRIPT"">       ")
    con_frmSetting = con_frmSetting & vbCrLf & "function init()" & vbCrLf
    con_frmSetting = con_frmSetting & vbCrLf & "{" & vbCrLf
    con_frmSetting = con_frmSetting & vbCrLf & "bar.create();" & vbCrLf
    con_frmSetting = con_frmSetting & vbCrLf & "}" & vbCrLf
   
    
   con_frmSetting = con_frmSetting & vbCrLf & ("</SCRIPT>       ")
   
   con_frmSetting = con_frmSetting & vbCrLf & ("<LINK REL=""STYLESHEET"" HREF=""PMAINSTYLE1.ASP"">       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<BODY BACKGROUND='BACKGROUND.ASP'>       ")

  
'   con_frmSetting = con_frmSetting & vbCrLf & GetMenu
 con_frmSetting = con_frmSetting & vbCrLf & ("<FORM NAME=""FRM"" ACTION=""Contact.asp?mode=con_frmSetting"" method=""post"">       ")

     '****** HEADER *****
  
  con_frmSetting = con_frmSetting & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=" & GetDefault("con_bgcolor", "#DCC9B2", Session("candidat_ADOContact")) & " CELLPADDING=""0"" CELLSPACING=""0"">       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
'       con_frmSetting = con_frmSetting & vbCrLf &  "toto"
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD>       ")
   
   con_frmSetting = con_frmSetting & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD ALIGN=""LEFT"">       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<font class='header'><b>" & UCase(Session("Encelade_Message")) & "</b></font>")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("</B></FONT>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TD>       ")
  
  
   con_frmSetting = con_frmSetting & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE"" VALUE=""con_frmSetting"">       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD ALIGN=""RIGHT"">       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALIDER"">       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   NAME=""USER_ACTION"" VALUE=""VALEURS PAR DÉFAUT"">       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TABLE>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TABLE>       ")

     '******  MESSAGE ******

   con_frmSetting = con_frmSetting & vbCrLf & ("<CENTER><FONT COLOR=""RED""><B>") & msg & "</B></FONT></CENTER>       "



   con_frmSetting = con_frmSetting & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE2"" VALUE=""EXECUTE"">       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<TABLE BORDER=""0"">       ")


'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TR>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE FOND DE PAGE</TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD><input type=""text"" NAME=""CON_BGCOLOR"" VALUE=" & GetDefault("CON_BGCOLOR", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("</TR>        ")

'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TR>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE DES LISTES</TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD><input type=""text"" NAME=""COLOR1"" VALUE=" & GetDefault("COLOR1", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("</TR>        ")

'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TR>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">COULEUR DE LIGNE ALTERNÉE DES LISTES</TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("<TD><input type=""text"" NAME=""COLOR2"" VALUE=" & GetDefault("COLOR2", "", DsnTableMenu(Session ("candidat_ADOContact"))) & "></TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf &  ("</TR>        ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TRI PAR DÉFAUT</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""DEFAULTFIELDSORTBY"" VALUE=" & GetDefault("DEFAULTFIELDSORTBY", "TXT1", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Recherche Alphanumérique</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""IndexAlpha"" VALUE=" & GetDefault("IndexAlpha", "", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")

   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ stock ENCELADE</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""StockEncelade"" VALUE=" & GetDefault("StockEncelade", "TXT81", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")
   
   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ à décrémenter</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""ChampQuantite"" VALUE=" & GetDefault("ChampQuantite", "TXT66", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>       ")
   
   con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Répertoire Racine Images </TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""PathImg"" VALUE=" & GetDefault("PathImg", "Portal_Image/Catalogue/", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")
   
  con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Répertoire Racine de la Documentaion </TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""PathDOC"" VALUE=" & GetDefault("PathDOC", "Portal_DOC/Catalogue/", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")
   
'con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
'   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ de référence Caddy </TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""RefCaddy"" VALUE=" & GetDefault("RefCaddy", "txt1", Session("candidat_ADOContact")) & "></TD>       ")
'   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")

con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ de référence pour le Caddy </TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""RefCaddy"" VALUE=" & GetDefault("RefCaddy", "txt1", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")

con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ de référence Prix/U pour le Caddy </TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""RefCaddyPrixU"" VALUE=" & GetDefault("RefCaddyPrixU", "txt1", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")
 
con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">Champ de référence Désignation pour le Caddy </TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""RefCaddyDesignation"" VALUE=" & GetDefault("RefCaddyDesignation", "txt1", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")
   
con_frmSetting = con_frmSetting & vbCrLf & ("<TR>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">NB Lignes à Afficher pour une Recherche</TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("<TD><input type=""text"" NAME=""NBLignesRecherche"" VALUE=" & GetDefault("NBLignesRecherche", "25", Session("candidat_ADOContact")) & "></TD>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</TR>        ")

'   con_frmSetting=con_frmSetting & ("<TR>       ")RefCaddyDesignation
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">INTITULÉ ""LISTE DES TABLES""</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TABLES"" VALUE=" & GetDefault("TABLES", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>       ")
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'
'   con_frmSetting=con_frmSetting & ("<TD >&nbsp;</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD>&nbsp;</TD>       ")
'
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA PREMIÈRE ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE1"" VALUE=" & GetDefault("TITREPAGE1", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA DEUXIÈME ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE2"" VALUE=" & GetDefault("TITREPAGE2", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA TROISIÈME ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE3"" VALUE=" & GetDefault("TITREPAGE3", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA QUATRIÈME ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE4"" VALUE=" & GetDefault("TITREPAGE4", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA CINQUIÈME ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE5"" VALUE=" & GetDefault("TITREPAGE5", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">TITRE DE LA SIXIÈME ÉTAPE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""TITREPAGE6"" VALUE=" & GetDefault("TITREPAGE6", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'
'   con_frmSetting=con_frmSetting & ("<TD >&nbsp;</TD>       ")
'
'   con_frmSetting=con_frmSetting & ("<TD>&nbsp;</TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">EMAIL DU WEBMESTRE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""WEBMASTER"" VALUE=" & GetDefault("WEBMASTER", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">NOM DU CHAMP CONTENANT LE NOM</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""NOM"" VALUE=" & GetDefault("NOM", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>        ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">NOM DU CHAMP CONTENANT LE PRÉNOM</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""PRENOM"" VALUE=" & GetDefault("PRENOM", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>       ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" ALIGN=""RIGHT"">NOM DU CHAMP CONTENANT L'EMAIL</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><input type=""text"" NAME=""EMAIL"" VALUE=" & GetDefault("EMAIL", "") & "></TD>       ")
'   con_frmSetting=con_frmSetting & ("</TR>       ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" VALIGN=""TOP"" ALIGN=""RIGHT"">TEXTE ENVOYÉ PAR EMAIL LORS D'UNE NOUVELLE INSCRIPTION</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><TEXTAREA NAME=""TEXTE_BIENVENUE"" COLS=50 ROW=10 >") & GetDefault("TEXTE_BIENVENUE", "") & "</TEXTAREA></TD>       "
'   con_frmSetting=con_frmSetting & ("</TR>       ")
'
'   con_frmSetting=con_frmSetting & ("<TR>       ")
'   con_frmSetting=con_frmSetting & ("<TD CLASS=""SMALLERHEADER"" VALIGN=""TOP"" ALIGN=""RIGHT"">TEXTE ENVOYÉ PAR EMAIL LORS D'UN OUBLI DE MOT DE PASSE</TD>       ")
'   con_frmSetting=con_frmSetting & ("<TD><TEXTAREA NAME=""TEXTE_PASSWORD"" COLS=50 ROW=10>") & GetDefault("TEXTE_PASSWORD", "") & "</TEXTAREA></TD>       "
'   con_frmSetting=con_frmSetting & ("</TR>       ")



   con_frmSetting = con_frmSetting & vbCrLf & ("</TABLE>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</FORM>       ")
'   con_frmSetting = con_frmSetting & vbCrLf & ("</CENTER>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</BODY>       ")
   con_frmSetting = con_frmSetting & vbCrLf & ("</HTML>       ")




End Function
Function con_frmField()
          Response.Expires = 0
          Session("CANDIDAT_CURRENTPAGE") = "CON_FRMFIELD.ASP"
  Set Conn = OpenDb(Session("candidat_ADOContact"))

  
        
          If Request("MODE2") = "EXECUTE" Then
                Conn.Execute ("DELETE FROM CON_FIELDS ;")
                STRARRAY = Split(Request("LSTFIELDID"), ",")
                          
                For I = 0 To UBound(STRARRAY)
                        Order = "ORDER" & Trim(STRARRAY(I))
                        FieldOrder = Request(Order)
                        If Not IsNumeric(FieldOrder) Then
                                FieldOrder = 0
                         End If
                        Conn.Execute ("INSERT INTO CON_FIELDS(USERID,FIELDID,FIELDORDER) VALUES(" & 1 & "," & Trim(STRARRAY(I)) & "," & FieldOrder & ")")
                Next
                '**** REINDEX
                I = 0
                Set rs0 = Conn.Execute("SELECT * FROM CON_FIELDS   ORDER BY FIELDORDER")
                Do While Not rs0.EOF
                        Set RS1 = Conn.Execute("SELECT * FROM CON_FIELDDEFS WHERE FIELDID = " & rs0("FIELDID"))
                        If Not RS1.EOF Then
                                I = I + 1
                                Conn.Execute ("UPDATE CON_FIELDS SET FIELDORDER = " & I & " WHERE FIELDID = " & rs0("FIELDID"))
                         End If
                        rs0.MoveNext
                Loop
                 msg = GetMessage("FIELDSSELECTED", "FIELDS SELECTED.", DsnTableMenu(Session("candidat_ADOContact")))

           End If
          


   con_frmField = con_frmField & vbCrLf & ("<LINK REL=""STYLESHEET"" HREF=""PMAINSTYLE1.ASP"">       ")
  
'    con_frmField = con_frmField & vbCrLf & GetMenu



     '****** HEADER *****
     con_frmField = con_frmField & vbCrLf & ("<FORM NAME=""FRM"" ACTION=""Contact.asp?mode=con_frmField"" method=""post"">       ")
   con_frmField = con_frmField & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=""") & GetDefaultUser("CON_BGCOLOR", "NAVY", Session("candidat_ADOContact")) & """ CELLPADDING=""0"" CELLSPACING=""0"">       "
   con_frmField = con_frmField & vbCrLf & ("<TR>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD>       ")
   con_frmField = con_frmField & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
   con_frmField = con_frmField & vbCrLf & ("<TR>       ")
  
   con_frmField = con_frmField & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE"" VALUE=""con_frmField"">       ")
   con_frmField = con_frmField & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE2"" VALUE=""EXECUTE"">       ")
   con_frmField = con_frmField & vbCrLf & ("<TD ALIGN=""LEFT"">       ")
   con_frmField = con_frmField & vbCrLf & ("<FONT CLASS='HEADER' ><B>AFFICHAGE DES CHAMPS:  ") & " " & Session("Encelade_Message") & "</B></FONT>       "
   con_frmField = con_frmField & vbCrLf & ("</TD>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD ALIGN=""RIGHT"">       ")
   con_frmField = con_frmField & vbCrLf & ("<INPUT TYPE=""SUBMIT""  CLASS='CMDFLAT'   VALUE=""VALIDER"">&nbsp;       ")
   con_frmField = con_frmField & vbCrLf & ("</TD>       ")

   con_frmField = con_frmField & vbCrLf & ("</TR>       ")
   con_frmField = con_frmField & vbCrLf & ("</TABLE>       ")
   con_frmField = con_frmField & vbCrLf & ("</TD>       ")
   con_frmField = con_frmField & vbCrLf & ("</TR>       ")
   con_frmField = con_frmField & vbCrLf & ("</TABLE>       ")

   con_frmField = con_frmField & vbCrLf & ("<CENTER><FONT COLOR=""RED""><B>") & msg & "</B></FONT></CENTER>       "

   con_frmField = con_frmField & vbCrLf & ("<BR>       ")
   con_frmField = con_frmField & vbCrLf & ("&nbsp;&nbsp;SÉLECTIONNEZ LES CHAMPS QUE VOUS VOULEZ VOIR APPARAITRE DANS LE LISTING.       ")
   con_frmField = con_frmField & vbCrLf & ("<BR><BR>       ")
   con_frmField = con_frmField & vbCrLf & ("<TABLE WIDTH=""90%"" BORDER=""0"" CELLPADDING=""0"" CELLSPACING=""0"">       ")
   con_frmField = con_frmField & vbCrLf & ("<TR>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD>&nbsp;</TD>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD>&nbsp;</TD>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD><B>CHAMP</B></TD>       ")
   con_frmField = con_frmField & vbCrLf & ("<TD><B>ORDRE</B></TD>       ")
   con_frmField = con_frmField & vbCrLf & ("</TR>       ")
         
          Set rs0 = Conn.Execute("SELECT * FROM CON_FIELDS ORDER BY FIELDORDER")
          Do While Not rs0.EOF
                Set RS1 = Conn.Execute("SELECT * FROM CON_FIELDDEFS WHERE FIELDID = " & rs0("FIELDID"))
                If Not RS1.EOF Then
                        con_frmField = con_frmField & vbCrLf & ("<TR>")
                        con_frmField = con_frmField & vbCrLf & ("<TD>&nbsp;</TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD ALIGN='RIGHT'><INPUT TYPE='CHECKBOX' NAME='LSTFIELDID' VALUE='" & RS1("FIELDID") & "' CHECKED></TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD><FONT CLASS='SMALLERHEADER'>" & RS1("FIELDALIAS") & "</FONT></TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD><INPUT TYPE='TEXT' NAME='ORDER" & RS1("FIELDID") & "' VALUE='" & rs0("FIELDORDER") & "' SIZE='4'></TD>")
                        con_frmField = con_frmField & vbCrLf & ("</TR>")
                 End If
                rs0.MoveNext
          Loop
              
              
          Set rs0 = Conn.Execute("SELECT * FROM CON_FIELDDEFS WHERE FIELDALIAS <> '' ORDER BY FIELDID")
          Do While Not rs0.EOF
                Set RS1 = Conn.Execute("SELECT * FROM CON_FIELDS WHERE FIELDID = " & rs0("FIELDID") & " AND USERID = " & 1)
                If RS1.EOF Then
                        con_frmField = con_frmField & vbCrLf & ("<TR>")
                        con_frmField = con_frmField & vbCrLf & ("<TD>&nbsp;</TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD ALIGN='RIGHT'><INPUT TYPE='CHECKBOX' NAME='LSTFIELDID' VALUE='" & rs0("FIELDID") & "'></TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD><FONT CLASS='SMALLERHEADER'>NOM DE CHAMP : """ & rs0("FIELDALIAS") & """ (" & rs0("FIELDNAME") & " - APPARAÎT SUR LA PAGE " & rs0("PAGE") & ")</FONT></TD>")
                        con_frmField = con_frmField & vbCrLf & ("<TD><INPUT TYPE='TEXT' CLASS='SMALLERHEADER'  NAME='ORDER" & rs0("FIELDID") & "' VALUE='' SIZE='4'></TD>")
                        con_frmField = con_frmField & vbCrLf & ("</TR>")
                 End If
                rs0.MoveNext
          Loop
          

   con_frmField = con_frmField & vbCrLf & ("</TABLE>       ")

   con_frmField = con_frmField & vbCrLf & ("</FORM>       ")
   con_frmField = con_frmField & vbCrLf & ("</BODY>       ")
   con_frmField = con_frmField & vbCrLf & ("</HTML>       ")

Conn.Close
Set Conn = Nothing

End Function
Function con_frmSetField()
Set Conn = OpenDb(Session("candidat_ADOContact"))
          Response.Expires = 0
          Session("CANDIDAT_CURRENTPAGE") = "CON_FRMSETFIELD.ASP"
          If Request("MODE2") = "EXECUTE" Then
                Set RS1 = Conn.Execute("SELECT FIELDID FROM CON_FIELDDEFS")
                Do While Not RS1.EOF
                        Key = "KEY" & RS1("FIELDID")
                        Order = "ORDER" & RS1("FIELDID")
                        ATTRIBUT = "ATTRIBUT" & RS1("FIELDID")
'                        Page = "PAGE" & Rs1("FIELDID")
                        STRSQL = "UPDATE CON_FIELDDEFS SET "
                        STRSQL = STRSQL & "FIELDALIAS = '" & safeEntry(Request(Key)) & "' "
                        If Request(Order) <> "" Then STRSQL = STRSQL & ",FIELDORDER = " & Request(Order) & " "
                        If Request(ATTRIBUT) <> "" Then STRSQL = STRSQL & ",FIELDATTRIBUT = '" & UCase(Request(ATTRIBUT)) & "' "
'                        If Request(Page) <> "" Then STRSQL = STRSQL & ", PAGE = " & Request(Page) & " "
                        STRSQL = STRSQL & "WHERE FIELDID = " & RS1("FIELDID")
              
                        Conn.Execute (STRSQL)
                        RS1.MoveNext
                Loop
                          
                 msg = GetMessage("FIELDSARESET", "FIELDS ARE SET.", DsnTableMenu(Session("candidat_ADOContact")))
                 
           End If
              
          


    con_frmSetField = con_frmSetField & vbCrLf & ("<LINK REL=""STYLESHEET"" HREF=""PMAINSTYLE1.ASP"">       ")
  
'     con_frmSetField = con_frmSetField & vbCrLf & GetMenu

     '****** HEADER *****

con_frmSetField = con_frmSetField & vbCrLf & ("<FORM NAME=""FRM"" ACTION=""Contact.asp?mode=CON_FRMSETFIELD"" METHOD=""POST"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"" BGCOLOR=""") & GetDefaultUser("CON_BGCOLOR", "NAVY", Session("candidat_ADOContact")) & """ CELLPADDING=""0"" CELLSPACING=""0"">       "
    con_frmSetField = con_frmSetField & vbCrLf & ("<TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TABLE WIDTH=""100%"" BORDER=""0"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD ALIGN=""LEFT"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<FONT CLASS='HEADER'><B>PERSONNALISATION DES CHAMPS:") & " " & Session("Encelade_Message") & "</B></FONT>       "
    con_frmSetField = con_frmSetField & vbCrLf & ("</TD>       ")
    
        con_frmSetField = con_frmSetField & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE"" VALUE=""CON_FRMSETFIELD"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<INPUT TYPE=""HIDDEN"" NAME=""MODE2"" VALUE=""EXECUTE"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD ALIGN=""RIGHT"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<INPUT CLASS=""CMDFLAT"" TYPE='SUBMIT' NAME='SUBMIT' VALUE='VALIDER'>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TABLE>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TABLE>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<CENTER><FONT COLOR=""RED""><B>") & msg & "</B></FONT></CENTER>       "
    con_frmSetField = con_frmSetField & vbCrLf & ("<CENTER>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TABLE BORDER=""0"" CELLPADDING=""1"" CELLSPACING=""4"" WIDTH=""95%"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TR VALIGN=""TOP"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TABLE BORDER=""0"" CELLPADDING=""0"" CELLSPACING=""0"" WIDTH=""100%"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD COLSPAN=""5"">&nbsp;</TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TR>       ")

    con_frmSetField = con_frmSetField & vbCrLf & ("<TR ALIGN=""CENTER"">       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD><B>NOM DU CHAMP</B></TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD><B>INTITULÉ</B></TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD><B>ORDRE</B></TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TD><B>ATTRIBUTS</B></TD>       ")
'    con_frmSetField = con_frmSetField & vbCrLf & ("<TD><B>PAGE</B></TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TR>       ")

         
              
          Set rs0 = Conn.Execute("SELECT * FROM CON_FIELDDEFS WHERE CON_FIELDDEFS.FieldAlias Is Not Null And CON_FIELDDEFS.FieldAlias<>'' ORDER BY FIELDORDER,FIELDID ")
          Do While Not rs0.EOF
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TR ALIGN=""CENTER"">")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><FONT CLASS='SMALLERHEADER'>" & rs0("FIELDNAME") & "</FONT></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'  NAME='KEY" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDALIAS") & "' SIZE='30'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'   NAME='ORDER" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDORDER") & "' SIZE='2'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'   NAME='ATTRIBUT" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDATTRIBUT") & "' SIZE='20'></TD>")
'                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'  NAME='PAGE" & RS0("FIELDID") & "' VALUE='" & RS0("PAGE") & "' SIZE='2'></TD>")
                        ' con_frmSetField = con_frmSetField & vbCrLf &  ("<TD><INPUT TYPE='BUTTON'  CLASS='CMDFLAT'   VALUE='...' ONCLICK='JAVSUB(" & RS0("FIELDID") & ")'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("</TR>")
                rs0.MoveNext
          Loop
          
 Set rs0 = Conn.Execute("SELECT * FROM CON_FIELDDEFS WHERE CON_FIELDDEFS.FieldAlias Is  Null or CON_FIELDDEFS.FieldAlias='' ORDER BY FIELDORDER,FIELDID")
          Do While Not rs0.EOF
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TR ALIGN=""CENTER"">")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><FONT CLASS='SMALLERHEADER'>" & rs0("FIELDNAME") & "</FONT></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'  NAME='KEY" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDALIAS") & "' SIZE='30'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'   NAME='ORDER" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDORDER") & "' SIZE='2'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'   NAME='ATTRIBUT" & rs0("FIELDID") & "' VALUE='" & rs0("FIELDATTRIBUT") & "' SIZE='20'></TD>")
'                         con_frmSetField = con_frmSetField & vbCrLf & ("<TD><INPUT TYPE='TEXT'  NAME='PAGE" & RS0("FIELDID") & "' VALUE='" & RS0("PAGE") & "' SIZE='2'></TD>")
                        ' con_frmSetField = con_frmSetField & vbCrLf &  ("<TD><INPUT TYPE='BUTTON'  CLASS='CMDFLAT'   VALUE='...' ONCLICK='JAVSUB(" & RS0("FIELDID") & ")'></TD>")
                         con_frmSetField = con_frmSetField & vbCrLf & ("</TR>")
                rs0.MoveNext
          Loop

    con_frmSetField = con_frmSetField & vbCrLf & ("</TABLE>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TD>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("<TR><TD></TD></TR>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</TABLE>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</CENTER>       ")

    con_frmSetField = con_frmSetField & vbCrLf & ("</FORM>       ")

    con_frmSetField = con_frmSetField & vbCrLf & ("</BODY>       ")
    con_frmSetField = con_frmSetField & vbCrLf & ("</HTML>       ")
 Conn.Close
Set Conn = Nothing

End Function

Function replaceAccent(txt As String, Optional noEspace As Boolean, Optional NotMajuscule As Boolean) As String
If NotMajuscule = False Then
    txt = UCase(txt)
Else
     txt = txt
End If
If noEspace = False Then
txt = Replace(txt, " ", "_", 1)
End If
txt = Replace(txt, UCase("¨"), "_")
txt = Replace(txt, UCase("^"), "_")
txt = Replace(txt, UCase("é"), "E")
txt = Replace(txt, UCase("è"), "E")
txt = Replace(txt, UCase("ê"), "E")
txt = Replace(txt, UCase("ë"), "E")
txt = Replace(txt, UCase("à"), "A")

txt = Replace(txt, UCase("â"), "A")
txt = Replace(txt, UCase("î"), "I")
txt = Replace(txt, UCase("ô"), "O")
txt = Replace(txt, UCase("û"), "U")

txt = Replace(txt, UCase("ä"), "A")
txt = Replace(txt, UCase("ï"), "I")
txt = Replace(txt, UCase("ö"), "O")
txt = Replace(txt, UCase("ü"), "U")

'txt = Replace(txt, UCase("'"), "_")
txt = Replace(txt, Chr(34), "''")
txt = Replace(txt, "<", "")
txt = Replace(txt, ">", "")
txt = Replace(txt, "'", "''")
txt = Replace(txt, Chr(34), Chr(34) & Chr(34))
replaceAccent = txt





End Function



Public Function Ecom_AjoutCaddie(DSN, Optional Id_Caddie As String)
 
Dim PrixU As Double
Dim PirxTotalHt As Double
Dim RsRemise As Recordset
Dim Remise As Double
'id_produit = Request("candidat_ref")
' pr ' Session("MySql")
RepriseId_Caddie:
If Trim("" & Id_Caddie) = "" Then
'    If Session("Id_Caddie_CadiDefault") <> "" Then
'        Id_Caddie = Session("Id_Caddie_CadiDefault")
'        GoTo RepriseId_Caddie
'    End If
    If Session("UserCommander") = 0 Then
    
        If UCase(Request("ComFour")) <> UCase("true") Then
            Id_Caddie = 0
            Session("Encelade_contactSearch") = "true"
            Response.Redirect "default.asp?mode=con_lst"
            Exit Function
        Else
            Id_Caddie = Session("candidat_id_caddy")
        End If
'    Else
'        Id_Caddie = Session("candidat_id_caddy")
    End If
End If

    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Mode = 16
    Conn.Open DSN
If Trim("" & Request("Msg_Err")) = "" Then
    If Trim("" & Session("Message_Caddy_Err")) = "" Then
        If Trim("" & Session("Message_Caddy")) = "" Then
            id_Num_caddie = LireId_Cadie(Id_Caddie, Conn)
            If Trim("" & Session("Id_Caddie_CadiDefault")) = "" Then
                Session("Id_Caddie_CadiDefault") = id_Num_caddie
             End If
        End If
    End If
End If

Debug.Print Session("userid")
    Sql = "SELECT t_R_Social.Remise FROM t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "
        Sql = Sql & "WHERE Users.UserID=" & Session("userid") & ";"
        Set RsRemise = Conn.Execute(Sql)
        Remise = "" & RsRemise!Remise
        RsRemise.Close
        Set RsRemise = Nothing
Session("MySql") = ""
ACT = Request("act")
a = Request("ContactID")

If Len("" & Request("qte_produit")) <> 0 Then
  qte_produit = Request("qte_produit")
Else
    qte_produit = 0
End If

Sql = "SELECT con_contacts." & GetDefault("RefCaddyPrixU", "txt1", Session("candidat_ADOContact")) & " as PrixU, con_contacts." & GetDefault("RefCaddy", "txt3", Session("candidat_ADOContact")) & " as RefProduit, con_contacts." & GetDefault("RefCaddyDesignation", "mem1", Session("candidat_ADOContact")) & " as RefCaddyDesignation , con_contacts." & GetDefault("Prixderevient", "txt47", Session("candidat_ADOContact")) & " as Prixderevient FROM con_contacts WHERE con_contacts.ContactID=" & Request("ContactID") & ";"
Set GeneralTools.My_Conn = OpenDb(Session("candidat_ADOContact"))
If Request("ContactID") <> "" Then
Set Rs = GeneralTools.My_Conn.Execute(Sql)

PrixU = 0
PrixU = val(Replace("" & Rs("PrixU"), ",", ".", 1))   ' Request("""" & GetDefault("RefCaddyPrixU", "txt1", Session("candidat_ADOContact")) & "")
RefProduit = Rs("RefProduit")
RefCaddyDesignation = Rs("RefCaddyDesignation")
PrixRevient = "" & Rs("Prixderevient")
    tva = GetDefault("TVA", "19.6", DsnTableMenu(Session("candidat_ADOContact")))

End If
 GeneralTools.My_Conn.Close
 Set GeneralTools.My_Conn = Nothing
RacineImages = GetDefault("EcomPathImages", "../portal_ecom/img/", DSN)
'    pr ("<html><head>")
'    pr ("<link rel='stylesheet' href=""PMainStyle1.asp"">")
'    Session("portalpath")
'    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
'    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
'    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'>")
'    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
pr "<script language='javascript'>"
pr "function MyTrim(V){"
pr " var monTexte = new String('');"
pr "  monTexte = V;"
pr "  while (monTexte.charAt(0) == ' ') {"
pr "    monTexte = monTexte.substring(1,monTexte.length);"
pr "  }"
pr "  while (monTexte.charAt(monTexte.length - 1) == ' ') {"
pr "    monTexte = monTexte.substring(0, (monTexte.length - 1));"
pr "  }"
pr "  return monTexte;"
pr "}"

pr "function ValidePrix(PrixU){"
'pr "alert(PrixU.value);"
pr " if (IsNumeric2(MyTrim(Remplacer(PrixU.value,"","",""."")))==false){"
pr "   alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
pr "   PrixU.value=0;"
pr "   PrixU.focus();"
pr " }"
pr "}"

pr "function IsNumeric2(sText){"
pr "//vérifie si la chaine envoyée est de type numérique"
'pr "if (IsNumeric(sText==false){"
'pr "return false;"
'pr "}"
pr "   var ValidChars = ""0123456789."";"
pr "   var IsNumber=true;"
pr "   var Char;"
pr "  "
pr " "
pr "   for (i = 0; i < sText.length && IsNumber == true; i++)"
pr "     {"
pr "      Char = sText.charAt(i);"
pr "      if (ValidChars.indexOf(Char) == -1)"
pr "         {"
pr "         IsNumber = false;"
pr "         }"
pr& "      }"
pr "   return IsNumber;"
pr "    "
pr "  }"
pr ""
pr "function Remplacer(Txt,C,R){"
pr "var a, tmp;"
pr "tmp = '';"
pr "a = Txt;"
pr "  "
pr "for(var i = 0; i < a.length; i++)"
pr "{"
pr ""
pr "  "
pr "    if (a.charAt(i) ==  C)"
pr "    {"
pr "    tmp = tmp + R;"
pr "    } else{"
pr "        tmp = tmp + a.charAt(i);"
pr "    }"
pr "}"
pr "  "
pr "return  tmp;"
'CrerDevis = CrerDevis & vbCrLf & "alert(a);"
pr "}"


pr "</script>"
'    pr ("</head><body>")
  pr ("<form name='form_caddie' action='Contact.asp?Mode=AjoutCommander' method='post'>")
    pr ("<table border=""0"" width=""100%"" align=""center""><tr>")
    pr ("<td>" & ImgTransparent(1, 20) & "</td></tr>")
    pr ("<tr><td>")
    If Request("ComFour") <> "" Then
        pr ("<IMG src=""" & GetDefault("EcomPathImages", "../portal_ecom/commander/img/", DSN) & "ComFour.gif"" border=""0"" alt=""" & Text & """></td></tr>")
    Else
        
            pr ("<IMG src=""" & GetDefault("EcomPathImages", "../portal_ecom/commander/img/", DSN) & "caddie.gif"" border=""0"" alt=""" & Text & """></td></tr>")
        
    End If
    pr ("<tr><td>")
    If Request("ComFour") <> "" Then
        pr (ImgTitreEcommerce(translate("Votre Commande Fournisseur")))
    Else
        MyNumCadi = ""
        If Trim("" & Id_Caddie) <> "" Then
            Sql = "SELECT T_NumCadi.NumCadi From T_NumCadi WHERE T_NumCadi.id=" & Id_Caddie & ";"
             Set RsNumCadi = Conn.Execute(Sql)
                
                If RsNumCadi.EOF = False Then
                    MyNumCadi = "" & RsNumCadi!NumCadi
                End If
                 RsNumCadi.Close
                Set RsNumCadi = Nothing
           End If
        pr (ImgTitreEcommerce(translate("Votre Panier : " & MyNumCadi)))
    End If
    pr ("</td></tr>")
    pr ("<tr><td>")
  
    
    If CStr(ACT) = "" Then
        ACT = "aff"
    End If

    'If Len(CStr(Request("pognon"))) > 0 Then
    '    Session("candidat_pognon") = CStr(Request("pognon"))
    'End If
    
    'If Len(CStr(Session("candidat_pognon"))) < 1 Then
    '    Session("candidat_pognon") = ""
    'End If
    
    'pognon = Session("candidat_pognon")
    
    'If Len(CStr(Request("last_page"))) > 0 Then
    '    Session("last_page") = Request("last_page")
    'End If
   
    
    
'     If val("" & id_Num_caddie) = 0 And Len("" & Request("qte_produit")) <> 0 Then
'        NumCadi = NumeroChrono("PAN", "PAN_")
'        Sql = "INSERT INTO T_NumCadi ( NumCadi,Id_User ) VALUES( '" & NumCadi & "'," & Session("UserId") & " );"
'        Conn.Execute (Sql)
'        Sql = "SELECT T_NumCadi.id From T_NumCadi "
'        Sql = Sql & "WHERE T_NumCadi.NumCadi='" & NumCadi & "';"
'        Set Rs = Conn.Execute(Sql)
'        If Rs.EOF = False Then
'           Id_Caddie = Rs("id")
'           Session("candidat_num_id_caddy") = Id_Caddie
'            Session("candidat_id_caddy") = Id_Caddie
'            id_Num_caddie = Session("candidat_id_caddy")
'        End If
'        Rs.Close
'        Set Rs = Nothing
'       End If
        id_produit = Request("ContactID")
        Id_Menu = Session("Encelade_CatId")
        ref_produit = RefProduit
       Ref_CaddyDesignation = RefCaddyDesignation
    If Len(CStr(Id_Caddie)) < 1 And Len("" & Request("qte_produit")) <> 0 Then
        Sql = "select max(id_caddie) from t_caddie"
        Set cur = Conn.Execute(Sql)
        Id_Caddie = inc(TOZS(cur(0)))
        Session("candidat_id_caddy") = Id_Caddie
        Set cur = Nothing
         id_produit = Request("ContactID")
        Id_Menu = Session("Encelade_CatId")
        Sql = "insert into t_caddie (id_caddie, id_produit, date_modif) values (" & Id_Caddie & ",-1,Now())"
        Conn.Execute (Sql)
    End If
    
    
    
    If ACT = "ajout" Then
       If val("" & id_Num_caddie) = 0 Then
        NumCadi = NumeroChrono("CAD", "CAD_")
        Sql = "INSERT INTO T_NumCadi ( NumCadi,Id_User ) VALUES( '" & NumCadi & "'," & Session("UserId") & " );"
        Conn.Execute (Sql)
        Sql = "SELECT T_NumCadi.id From T_NumCadi "
        Sql = Sql & "WHERE T_NumCadi.NumCadi='" & NumCadi & "';"
        Set Rs = Conn.Execute(Sql)
        If Rs.EOF = False Then
           Id_Caddie = Rs("id")
           Session("candidat_num_id_caddy") = Id_Caddie
            Session("candidat_id_caddy") = Id_Caddie
            id_Num_caddie = Session("candidat_num_id_caddy")
        End If
        Rs.Close
        Set Rs = Nothing
       End If
        id_produit = Request("ContactID")
        Id_Menu = Session("Encelade_CatId")
        ref_produit = RefProduit
       Ref_CaddyDesignation = RefCaddyDesignation
'        If Session("id_produit") = "" Then
'            Session("id_produit") = id_produit
'        End If
If Request("ComFour") <> "" Then
    Sql = "SELECT t_Caddie_four.* " & _
                "From t_Caddie_four " & _
                "WHERE t_Caddie_four.id_caddie=" & Id_Caddie & " " & _
                "AND " & _
                    "t_Caddie_four.Id_Menu=" & Id_Menu & " " & _
                    "AND " & _
                        "t_Caddie_four.id_produit=" & id_produit & ";"
Else
            Sql = "SELECT t_caddie.* " & _
                "From t_caddie " & _
                "WHERE t_caddie.id_caddie=" & Id_Caddie & " " & _
                "AND " & _
                    "t_caddie.Id_Menu=" & Id_Menu & " " & _
                    "AND " & _
                        "t_caddie.id_produit=" & id_produit & ";"
End If
       
        Set cur = Conn.Execute(Sql)
        noprod = 1
        
        If Not cur.EOF Then
            nb = CInt(cur("qte_produit"))
            noprod = 0
        End If
        Set cur = Nothing
        If Request("ComFour") <> "" Then
            If noprod = 1 Then
                
                 Sql = "INSERT INTO t_Caddie_four ( id_caddie, Id_Menu, id_produit, RefProduit, TypePiece, qte_produit, PrixU_produit,Designation  ) "
                Sql = Sql & "values( " & Id_Caddie & ", " & Id_Menu & ", " & id_produit & ", '" & ref_produit & "', '" & Session("Types_de_pieces") & "', 1 ," & Replace(val("" & Replace(PrixRevient, ",", ".", 1)), ",", ".", 1) & " , '" & Replace("" & Ref_CaddyDesignation, "'", "''") & "');"
            Else
                nb = nb + Request("qte_produit")
               
    
                Sql = "update t_Caddie_four set qte_produit = " & nb & " where Id_Menu =" & Id_Menu & " and  id_caddie= " & Id_Caddie & " And id_produit = " & id_produit & " "
            End If
         Else
             If noprod = 1 Then
           

                 Sql = "INSERT INTO t_caddie ( id_caddie, Id_Menu, id_produit, RefProduit, TypePiece, qte_produit, PrixU_produit,Designation ,TVA,PrixRevient ,Remise) "
                Sql = Sql & "SELECT " & Id_Caddie & " AS id_caddie, " & Id_Menu & " AS Id_Menu, " & id_produit & " AS id_produit, '" & ref_produit & "' AS RefProduit, '" & Session("Types_de_pieces") & "' AS TypePiece, 1 AS qte_produit," & Replace(PrixU, ",", ".", 1) & " AS PrixU_produit, '" & Replace("" & Ref_CaddyDesignation, "'", "''") & "' AS Designation," & tva & " as TVA," & Replace(val("" & Replace(PrixRevient, ",", ".", 1)), ",", ".", 1) & " as PrixRevient," & Replace(CDbl(Replace(Remise, ",", ".")) * (1 / 100), ",", ".") & " ;"
            Else
                nb = nb + qte_produit
               
    
                Sql = "update t_caddie set qte_produit = " & nb & " where Id_Menu =" & Id_Menu & " and  id_caddie= " & Id_Caddie & " And id_produit = " & id_produit & " "
            End If
         End If
        Conn.Execute Sql
        ACT = "aff"
    End If
    
    
    If ACT = "modif" Then
    Session("Types_de_pieces") = Session("Types_de_pieces")
        id_produit = Request("id_produit")
        Id_Menu = Request("ID_Menu")
        PrixU_produit = Request("PrixU_" & Request("id_produit"))
'        ref_produit = Request("candidat_fieldref")
    
    
     If Request("ComFour") <> "" Then
        Sql = "update T_Caddie_Four set qte_produit = " & qte_produit & ",PrixU_produit=" & Replace(PrixU_produit, ",", ".") & " "
        Sql = Sql & ",Remise = " & val(Replace(Request("Rem_" & Request("id_produit")), ",", ".")) & "*(1/100) where Id_Menu =" & Id_Menu & " and  id_caddie= " & Id_Caddie & " And id_produit = " & id_produit & " "
     Else
        Sql = "update t_caddie set qte_produit = " & qte_produit & ",Remise = " & Replace(CDbl(Replace(Remise, ",", ".")) * (1 / 100), ",", ".") & " where Id_Menu =" & Id_Menu & " and  id_caddie= " & Id_Caddie & " And id_produit = " & id_produit & " "
     End If
'        Sql = "update t_caddie set qte_produit = " & qte_produit & " where id_caddie = " & id_caddie & " and id_produit = " & id_produit & " "
        Conn.Execute Sql
        ACT = "aff"
    End If
    
    
    If ACT = "suppr" Then
    id_produit = Request("id_produit")
        Id_Menu = Request("ID_Menu")
        If Request("ComFour") <> "" Then
            Sql = "DELETE T_Caddie_Four.* "
            Sql = Sql & "From T_Caddie_Four "
            Sql = Sql & "WHERE T_Caddie_Four.id_caddie=" & Id_Caddie & " AND T_Caddie_Four.id_produit=" & id_produit & " AND T_Caddie_Four.Id_Menu=" & Id_Menu & ";"
        
        Else
'        Sql = "delete from t_caddie where id_caddie=" & id_caddie & " And id_produit = " & id_produit & " "
            Sql = "DELETE t_caddie.* "
            Sql = Sql & "From t_caddie "
            Sql = Sql & "WHERE t_caddie.id_caddie=" & Id_Caddie & " AND t_caddie.id_produit=" & id_produit & " AND t_caddie.Id_Menu=" & Id_Menu & ";"
        End If
        Conn.Execute (Sql)
        ACT = "aff"
    End If
    

    If ACT = "aff" Then
    If Request("ComFour") <> "" Then
        Sql = "select count(*) from t_Caddie_four where  id_caddie=" & Id_Caddie
        Set cur = Conn.Execute(Sql)
        id_cpt = CInt(cur(0))
        
        Sql = "SELECT * "
        Sql = Sql & "FROM t_Caddie_four "
'        Sql = Sql & " FROM t_tva INNER JOIN (t_caddie INNER JOIN dbp_Topics ON t_caddie.id_produit = dbp_Topics.TopicId) ON t_tva.tva_id = dbp_Topics.tva_id "
        Sql = Sql & " where t_Caddie_four.id_caddie=" & Id_Caddie
        
        Set cur = Conn.Execute(Sql)
        Else
            Sql = "select count(*) from t_caddie where  id_caddie=" & val("" & Id_Caddie)
        Set cur = Conn.Execute(Sql)
        id_cpt = CInt(cur(0))

        Sql = "SELECT * "
        Sql = Sql & "FROM t_caddie "
'        Sql = Sql & " FROM t_tva INNER JOIN (t_caddie INNER JOIN dbp_Topics ON t_caddie.id_produit = dbp_Topics.TopicId) ON t_tva.tva_id = dbp_Topics.tva_id "
        Sql = Sql & " where t_caddie.id_caddie=" & val("" & Id_Caddie)

        Set cur = Conn.Execute(Sql)
        End If
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
        If cur.EOF Then
            rien = 1
            Session("candidat_caddyrempli") = 0
            If Session("Message_Caddy") <> "" Then
                pr (" <div align=""center"" class=""smallheader"">" & translate("<br><br>" & Session("Message_Caddy") & "") & "</div>")
                Session("Message_Caddy") = ""
            Else
                pr (" <div align=""center"" class=""smallheader"">" & translate("<br><br>Votre caddie est vide.") & "</div>")
            End If
            pr ("<br><br><br><br><br><br>")
            pr ("<div align=""left"">" & BoutonRetour(1, "", True) & "</div>")
        Else
            Session("candidat_caddyrempli") = 1
            
              pr ("<center>")
              pr ("<table border=""0"" width='100%'><tr><td>")
                
                  pr ("<table border=0 width='100%' cellspacing='1' cellpadding='0'>")
                  pr ("<tr nowrap class=""TrEntete"" height=""30"" align='center'>")
                   pr ("<input type='hidden' name='ContactID' value='" & Request("ContactID") & "'>")
                
                    pr ("<input type='hidden' name='id_produit' value=''>")
                    pr ("<input type='hidden' name='ID_Menu' value=''>")
                     pr ("<input type='hidden' name='qte_produit' value=''>")
                    pr ("<input type='hidden' name='act' value=''>")
                     
         pr ("<input type='hidden' name='mode' value=''>")
         If Request("ComFour") = "" Then
                  pr ("<td class='TextTrEntete' valign=""top""  width=""5%"">" & ImgEnteteColonne(translate("Désignation")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""5%"">" & ImgEnteteColonne(translate("Référence")) & "</td>")
          Else
                 pr ("<td class='TextTrEntete' valign=""top""  width=""20%"">" & ImgEnteteColonne(translate("Désignation")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""15%"">" & ImgEnteteColonne(translate("Référence")) & "</td>")
                 
          End If
                   pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""10%"">" & ImgEnteteColonne(translate("Qté")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center"" width=""10%"">" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>")
                 
                    pr ("<td class='TextTrEntete' valign=""top"" align=""center"">" & ImgEnteteColonne(translate("Remise %")) & "</td>")
                 pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""10%"">" & ImgEnteteColonne(translate("T. Remise ")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""10%"">" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>")
                  If Session("candidat_UserType") <> "Administrator" Then
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""10%"">" & ImgEnteteColonne(translate("T.V.A. %")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""   width=""10%"">" & ImgEnteteColonne(translate("T.V.A. ")) & "</td>")
                  pr ("<td class='TextTrEntete' valign=""top"" align=""center""  width=""10%"">" & ImgEnteteColonne(translate("P.T.T.C. ")) & "</td>")
                  End If
                 pr " </tr>"
                    
        End If
         'pr ("<input type='hidden' name='Id_Caddie_2' value='" & Id_Caddie & "'>")
         'pr ("<input type='hidden' name='Id_Caddie_1' value='" & Id_Caddie & "'>")
        While Not cur.EOF
            id_produit = cur("ID_produit")
            Id_Menu = cur("Id_Menu")
            TypePiece = cur("TypePiece")
            RefProduit = cur("RefProduit")
            Titre = cur("Designation")
            qte_produit = cur("qte_produit")
            
            PrixU = cur("PrixU_produit")
           
            Remise = val(Replace("" & cur("Remise"), ",", "."))
               
           
           If Session("candidat_UserType") <> "Administrator" Then
            tva = cur("TVA")
            Else
            tva = 1
            End If
           If Trim("" & Remise) = "" Then Remise = 0
            PrixT = qte_produit * cur("PrixU_produit")
            PrixT = PrixT - (PrixT * Remise)
            PrxTva = PrixT * (tva / 100)
            PrixTTC = PrixT + PrxTva
            PrixT = qte_produit * cur("PrixU_produit")
            cpt = cpt + qte_produit
            PrixU = FomatNum("" & PrixU, 3)
            PrixT = FomatNum("" & PrixT, 3)
            PrxTva = FomatNum("" & PrxTva, 3)
            PrixTTC = FomatNum("" & PrixTTC, 3)
           cpt = FomatNum("" & cpt, 3)
            'If cur("TTC") = 1 Then
            '    Prix = fmt(cur("Prix"))
            '    prixf = fmt(cur("prixf"))
            '    sous_total_e = CDbl(cur("qte_produit")) * CDbl(cur("Prix"))
            '    sous_total = CDbl(cur("qte_produit")) * CDbl(cur("prixf"))
            'Else
            '    Tva = 1 + (cur("tva") / 100)
            '    Prix = fmt(cur("Prix") * Tva)
            '    prixf = fmt(cur("prixf") * Tva)
            '    sous_total_e = (CDbl(cur("qte_produit")) * CDbl(cur("Prix")) * Tva)
            '    sous_total = (CDbl(cur("qte_produit")) * CDbl(cur("prixf")) * Tva)
            'End If
            'total = (total + sous_total_e)
            'totalf = (totalf + sous_total)
            
            '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            'A MODIFIER - INTEGRER VALEUR CANDIDAT
            '!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", DSN)
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", DSN)
            End If
                pr "<div align=align='center'>"
                  pr ("<tr class=""smalltext"" height=""30"" align='center'>")
                    pr ("<td bgcolor=""" & bgcolor & """ >" & Titre & "</td>")
                     pr ("<td bgcolor=""" & bgcolor & """  >" & RefProduit & "</td>")
                                        
                      pr ("<td  bgcolor='" & bgcolor & "'  >")
                        pr ("<input type='text' name='qte_" & id_produit & "' maxlength=6 size=4 value='" & qte_produit & "' >")
'
                        pr ("<img src='" & RacineImages & "/plus_moins.gif' alt='+/- 1' usemap='#mainmap" & id_produit & "' border=0 align='absmiddle'>")
                        pr ("<map name='mainmap" & id_produit & "'>")
                        pr ("<area shape=RECT coords='0,0,8,9' href=""javascript:plus_un('" & id_produit & "','" & Id_Menu & "') "">")
                        pr ("<area shape=RECT coords='0,10,8,19' href=""javascript:moins_un('" & id_produit & "','" & Id_Menu & "') "">")
                        If Request("ComFour") <> "" Then
                            pr ("<input type='hidden' name='ComFour' value='true'>")
                             pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  ><input type='text' name='PrixU_" & id_produit & "'onchange=""ValidePrix(this.document.form_caddie.PrixU_" & id_produit & ");"" maxlength=12 size=4 value='" & PrixU & "'></td>")
                        Else
                            
                            
                        pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  > " & PrixU & "</td>")
                        End If
                        If Request("ComFour") <> "" Then
                        pr ("<td align='center' bgcolor='" & bgcolor & "'><input type='text' name='Rem_" & id_produit & "' maxlength=6 size=4 value='  " & Remise * 100 & "' onchange=""ValidePrix(this.document.form_caddie.Rem_" & id_produit & ");""></td>")
                        Else
                            pr ("<td align='center' bgcolor='" & bgcolor & "'>" & Remise * 100 & "</td>")
                        End If
                         
                         pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  > " & PrixT * Remise & "</td>")
                         pr ("<td align='center' bgcolor='" & bgcolor & "'  > " & PrixT - (PrixT * Remise) & "</td>")
                         If Session("candidat_UserType") <> "Administrator" Then
                         pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  > " & tva & " %</td>")
                            pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  > " & PrxTva & " </td>")
                         pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'  > " & PrixTTC & " </td>")
                         End If
                         PrxTvaTotal = PrxTvaTotal + PrxTva
                        PrixTTCTotal = PrixTTCTotal + PrixTTC
                        PirxTotalHt = PirxTotalHt + PrixT - (PrixT * Remise)
                         
                    'End If
'                     pr ("" & PrixU & "</td>")
                    'If pognon = "FF" Then
                    '    Response.Write (fmt(sous_total))
                    'Else
                    '     Response.Write (fmt(sous_total_e))
                         pr ("<td valign='middle' align='center'  bgcolor='" & bgcolor & "'  >&nbsp;<a href=""javascript:modifie('" & id_produit & "','" & Id_Menu & "') ;""><img src='" & RacineImages & "/mise_jour.gif' alt='Mise à jour' border=0></a>&nbsp;&nbsp;&nbsp;")
                        pr ("<a href=""javascript:suppr('" & id_produit & "','" & Id_Menu & "') ;""><img src='" & RacineImages & "/delete_small.gif' alt='Supprimer' border=0></a></td></tr>")
                        pr "</div>"
                    'End If
                    
                    
                    
            cur.MoveNext
        Wend
        If ACT <> "aff" Then
        TDbg = TDbg + 1
        If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", DSN)
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", DSN)
            End If
        pr ("<tr class=""smalltext"" height=""30"">")
        pr ("<td bgcolor=""" & bgcolor & """>Total commande</td>")
        pr ("<td bgcolor=""" & bgcolor & """>&nbsp</td>")
        pr ("<td align='center' bgcolor='" & bgcolor & "'>")
        pr ("&nbsp")
        pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'> &nbsp</td>")
        pr ("</map> </td><td align='center' bgcolor='" & bgcolor & "'> " & PirxTotalHt & "</td>")
        pr ("<td valign='middle' align='center'  bgcolor='" & bgcolor & "'>&nbsp;&nbsp;&nbsp;</TR>")
        End If
        TDbg = 0
        
        
        If rien = 0 Then
        '          pr ("<tr class=""TrEntete"" height=""30"">")
        '            pr ("<td class='TextTrEntete' colspan='2' height='29'>" & translate("Total") & ":</td>")
        '            pr ("<td class='TextTrEntete' align='middle' height='29'>" & cpt & "</td>")
        '            pr ("<td class='TextTrEntete' align='middle' height='29'>")
        '             Response.Write (fmt(total))
        '            pr ("</td><td height='29' class='TextTrEntete'>&nbsp;</td></tr>")
        If Session("candidat_UserType") <> "Administrator" Then
             ViewBasPageCaddy 7, val("" & Id_Caddie)
        Else
            ViewBasPageCaddy 4
        End If
                    pr ("</table>")
                    If InStr(1, Session("Message_Caddy"), "§erre§ ") <> 0 Then
                        pr "<p align=""center""><font color=""#CC0033"" size=""1"">" & Mid(Session("Message_Caddy"), 8, Len(Session("Message_Caddy")) - 7) & "</font></p>"
                        Session("Message_Caddy") = ""
                    End If
                    If Trim("" & Session("Message_Caddy_Err")) <> "" Then
                    pr "<p align=""center""><font color=""#CC0033"" size=""1"">" & Session("Message_Caddy_Err") & "</font></p>"
                        Session("Message_Caddy_Err") = ""
                    End If
              pr ("</td></tr></table></center>")
        End If
    End If
pr CaddyJava(Id_Caddie, Request("ComFour"), Session("candidat_ADOContact"))
Session("candidat_caddy_etape") = 2
 Session("candidat_num_id_caddy") = Id_Caddie
  Session("candidat_id_caddy") = Id_Caddie
  pr ("</td></tr></table>")
    Conn.Close
    Set Conn = Nothing
  
  pr ("</form></BODY></HTML>")
            
            Session("Message_Caddy") = ""
End Function


Public Function ValiderCommandeFournisseur(DSN)

    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    
    Id_Caddie = Session("candidat_id_caddy")
    
    Session("candidat_caddy_etape") = Request("etape")
   
'    If Len(CStr(Session("candidat_caddy_etape"))) < 1 Then
'        Session("candidat_caddy_etape") = 1
'    End If
    
    'pognon = Session("candidat_pognon")
    
'    pr ("<head>")
'    pr ("<link rel=STYLESHEET href='PMainStyle1.asp' type='text/css'>")
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
'    pr ("<style>")
'    pr ("body         {")
 '   pr ("font-family: verdana;")
'    pr ("font-size:xx-small;")
'    pr ("font-weight: normal;")
'    pr ("background-color: White;")
'    pr ("margin: 0px;")
'    pr ("background : url(../flyway/img/bgciel.jpg);")
'    pr ("}")
'    pr ("</style>")
'    pr ("</head>")

'<BODY>
pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")

            image = "etape2.gif"
            
                Text = translate("R&eacute;capitulatif de Votre Panier.")
            
'    If Session("candidat_EcomPathImages") = "" Then Session("candidat_EcomPathImages") = GetDefault("EcomPathImages", "../portal_ecom/commander/img/")
'pr ("<IMG src=""" & Session("candidat_EcomPathImages") & image & """ border=""0"" alt=""" & Text & """ usemap=""#etapes""><br>")
'pr ("<map name=""etapes"">")
'    If Session("candidat_caddy_etape") > 4 Then pr ("<area shape=""rect"" coords=""560,143,659,160"" href=""Contact.asp?mode=validercommande&etape=5"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 3 Then pr ("<area shape=""rect"" coords=""476,143,558,160"" href=""Contact.asp?mode=validercommande&etape=4"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 2 Then pr ("<area shape=""rect"" coords=""387,143,475,160"" href=""Contact.asp?mode=validercommande&etape=3"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 1 Then pr ("<area shape=""rect"" coords=""294,143,385,160"" href=""Contact.asp?mode=validercommande&etape=2"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 0 Then pr ("<area shape=""rect"" coords=""201,144,292,159"" href=""Contact.asp?mode=validercommande&etape=1"" target=""_self"">")
'pr ("</map>")
'pr ("<br><br>")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
  


            Call Ecom_ValiderFournisseuer(DSN)
   

    pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing

End Function
Public Function Ecom_ValiderCommande(DSN, Optional Id_Caddie As String)

    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    
      LireId_Cadie Id_Caddie, Conn
   
    Session("candidat_caddy_etape") = Request("etape")
   
    If Len(CStr(Session("candidat_caddy_etape"))) < 1 Then
        Session("candidat_caddy_etape") = 1
    End If
    
    'pognon = Session("candidat_pognon")
    
'    pr ("<head>")
'    pr ("<link rel=STYLESHEET href='PMainStyle1.asp' type='text/css'>")
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
'    pr ("<style>")
'    pr ("body         {")
 '   pr ("font-family: verdana;")
'    pr ("font-size:xx-small;")
'    pr ("font-weight: normal;")
'    pr ("background-color: White;")
'    pr ("margin: 0px;")
'    pr ("background : url(../flyway/img/bgciel.jpg);")
'    pr ("}")
'    pr ("</style>")
'    pr ("</head>")

'<BODY>
pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")
If Session("candidat_caddy_etape") = 1 Then
    Session("candidat_caddy_etape") = 2
    
End If
If Session("candidat_caddy_etape") = 3 Then
    If Session("PassOk") = "OK" Then
        Session("candidat_caddy_etape") = 4
    End If
End If
            Set RsNumCadie = Conn.Execute("SELECT T_NumCadi.NumCadi From T_NumCadi WHERE T_NumCadi.id= " & Id_Caddie & ";")
            MyRsNumCadie = ""
    If RsNumCadie.EOF = False Then
        MyRsNumCadie = "" & RsNumCadie!NumCadi
    End If
    RsNumCadie.Close
    Set RsNumCadie = Nothing
    Select Case Session("candidat_caddy_etape")
        Case 1
            image = "etape1.gif"
            Text = translate("Frais de port")
        Case 2
            image = "etape2.gif"
            If Request("ComFour") <> "" Then
                Text = translate("R&eacute;capitulatif de Votre Commande.")
            Else

            Text = translate("R&eacute;capitulatif de Votre Panier : " & MyRsNumCadie)
            End If
        Case 3
            image = "etape3.gif"
            Text = translate("Identification")
        Case 4
            image = "etape4.gif"
            Text = translate("Vos coordonn&eacute;s")
        Case 5
            image = "etape5.gif"
            Text = translate("Paiement")
    End Select
'    If Session("candidat_EcomPathImages") = "" Then Session("candidat_EcomPathImages") = GetDefault("EcomPathImages", "../portal_ecom/commander/img/")
'pr ("<IMG src=""" & Session("candidat_EcomPathImages") & image & """ border=""0"" alt=""" & Text & """ usemap=""#etapes""><br>")
'pr ("<map name=""etapes"">")
'    If Session("candidat_caddy_etape") > 4 Then pr ("<area shape=""rect"" coords=""560,143,659,160"" href=""Contact.asp?mode=validercommande&etape=5"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 3 Then pr ("<area shape=""rect"" coords=""476,143,558,160"" href=""Contact.asp?mode=validercommande&etape=4"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 2 Then pr ("<area shape=""rect"" coords=""387,143,475,160"" href=""Contact.asp?mode=validercommande&etape=3"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 1 Then pr ("<area shape=""rect"" coords=""294,143,385,160"" href=""Contact.asp?mode=validercommande&etape=2"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 0 Then pr ("<area shape=""rect"" coords=""201,144,292,159"" href=""Contact.asp?mode=validercommande&etape=1"" target=""_self"">")
'pr ("</map>")
'pr ("<br><br>")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
  


    Select Case Session("candidat_caddy_etape")
        Case 1
            Call Ecom_ValiderCommande1(DSN, Id_Caddie)
        Case 2
        
            Call Ecom_ValiderCommande2(DSN, Id_Caddie)
        Case 3
            Call Ecom_ValiderCommande3(DSN, Id_Caddie)
        Case 4
            If Ecom_ValiderCommande4(DSN, Id_Caddie) = False Then Exit Function
        Case 5
            Call Ecom_ValiderCommande5(DSN, Id_Caddie)
    End Select

    pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing

End Function
Public Function EspaceClient(DSN, Id_Caddie As String)

    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    
    Id_Caddie = Session("candidat_id_caddy")
    
    Session("candidat_caddy_etape") = Request("etape")
   
    If Len(CStr(Session("candidat_caddy_etape"))) < 1 Then
        Session("candidat_caddy_etape") = 1
    End If
    
    'pognon = Session("candidat_pognon")
    
'    pr ("<head>")
'    pr ("<link rel=STYLESHEET href='PMainStyle1.asp' type='text/css'>")
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
'    pr ("<style>")
'    pr ("body         {")
 '   pr ("font-family: verdana;")
'    pr ("font-size:xx-small;")
'    pr ("font-weight: normal;")
'    pr ("background-color: White;")
'    pr ("margin: 0px;")
'    pr ("background : url(../flyway/img/bgciel.jpg);")
'    pr ("}")
'    pr ("</style>")
'    pr ("</head>")

'<BODY>
pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")
'If Session("candidat_caddy_etape") = 1 Then Session("candidat_caddy_etape") = 2
    Select Case UCase(Trim(Request("mode")))
        Case 1
            image = "etape1.gif"
            Text = translate("Frais de port")
        Case "2"
            image = "etape2.gif"
            Text = translate("Commande finale")
        Case "ESPACECLIENT"
            image = "etape3.gif"
            Text = translate("Identification")
        Case 4
            image = "etape4.gif"
            Text = translate("Vos coordonn&eacute;es")
        Case 5
            image = "etape5.gif"
            Text = translate("Paiement")
    End Select
'    If Session("candidat_EcomPathImages") = "" Then Session("candidat_EcomPathImages") = GetDefault("EcomPathImages", "../portal_ecom/commander/img/")
'pr ("<IMG src=""" & Session("candidat_EcomPathImages") & image & """ border=""0"" alt=""" & Text & """ usemap=""#etapes""><br>")
'pr ("<map name=""etapes"">")
'    If Session("candidat_caddy_etape") > 4 Then pr ("<area shape=""rect"" coords=""560,143,659,160"" href=""Contact.asp?mode=validercommande&etape=5"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 3 Then pr ("<area shape=""rect"" coords=""476,143,558,160"" href=""Contact.asp?mode=validercommande&etape=4"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 2 Then pr ("<area shape=""rect"" coords=""387,143,475,160"" href=""Contact.asp?mode=validercommande&etape=3"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 1 Then pr ("<area shape=""rect"" coords=""294,143,385,160"" href=""Contact.asp?mode=validercommande&etape=2"" target=""_self"">")
'    If Session("candidat_caddy_etape") > 0 Then pr ("<area shape=""rect"" coords=""201,144,292,159"" href=""Contact.asp?mode=validercommande&etape=1"" target=""_self"">")
'pr ("</map>")
'pr ("<br><br>")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
  


   Select Case UCase(Trim(Request("mode")))
        Case "ESPACECLIENT"
            Call Ecom_ValiderCommande3(DSN, Id_Caddie)
        Case 2
        
            Call Ecom_ValiderCommande2(DSN, Id_Caddie)
        Case 3
            Call Ecom_ValiderCommande3(DSN, Id_Caddie)
        Case 4
            Call Ecom_ValiderCommande4(DSN, Id_Caddie)
        Case 5
            Call Ecom_ValiderCommande5(DSN, Id_Caddie)
    End Select

    pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing

End Function

Public Function Ecom_ValiderCommande_TableauRecap(DSN)
        
        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
        If Session("candidat_id_caddy") = "" Then
         Set RS1 = GeneralTools.My_Conn.Execute("SELECT T_IdCaddy.IdCaddy FROM T_IdCaddy;")
            If RS1.EOF = False Then
                Session("candidat_id_caddy") = RS1!IdCaddy + 1
                GeneralTools.My_Conn.Execute "UPDATE T_IdCaddy SET T_IdCaddy.IdCaddy = " & Session("candidat_id_caddy") & ";"
            Else
                Session("candidat_id_caddy") = 1
                GeneralTools.My_Conn.Execute "INSERT INTO T_IdCaddy ( IdCaddy ) SELECT " & Session("candidat_id_caddy") & " AS Expr1;"
            End If
        End If
        Sql = " SELECT t_caddie.id_caddie as ID_caddy, t_caddie.id_produit as ID_produit, t_caddie.qte_produit,"
        Sql = Sql & " t_tva.tva_valeur as Tva, t_tva.tva_id, dbp_Topics.Title as Title, dbp_Topics.prix as Prix, dbp_Topics.prixttc as TTC, dbp_Topics.prix * 6.55957 as prixf"
        Sql = Sql & " FROM t_tva INNER JOIN (t_caddie INNER JOIN dbp_Topics ON t_caddie.id_produit = dbp_Topics.TopicId) ON t_tva.tva_id = dbp_Topics.tva_id "
        Sql = Sql & " where t_caddie.id_caddie=" & Session("candidat_id_caddy")
        
        Sql = "SELECT t_caddie.* "
        Sql = Sql & "FROM t_caddie  "
        Sql = Sql & "where t_caddie.id_caddie=" & Session("candidat_id_caddy")

        Set cur = Conn.Execute(Sql)
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
        pr ("<center><table border=""0"" width=""100%"">")
            pr ("<tr><td class=""smallerheader"" colspan=""4"">")
            
                 pr ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">")
                 pr ("<tr class=""TrEntete"" valign=""top"">")
                pr ("<td  class=""TextTrEntete"" valign=""top"" >" & ImgEnteteColonne(translate("Désignation")) & "</td>")
        '        pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("Prix")) & "</td>")
                pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("Référence")) & "</td>")
                pr ("<td align='right' class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("Qté")) & "</td>")
                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>")
                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("P.H.T. ")) & "</td></tr>")
        '        pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("Sous-total")) & "</td></tr>")
                    
             
      While Not cur.EOF
      
            TypePiece = cur("Designation")
            RefProduit = cur("RefProduit")
            qte_produit = cur("qte_produit")
            PrixU = cur("PrixU_produit")
            PrixT = qte_produit * cur("PrixU_produit")
            TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                pr ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                      pr ("<td >" & TypePiece & "</td>")
                  pr ("<td >" & RefProduit & "</td>")
                     pr ("<td align='right'>" & Trim(qte_produit) & "</td>")
                     pr ("<td align='right'>" & Trim(PrixU) & "</td>")
                     pr ("<td align='right'>" & Trim(PrixT) & "</td>")

'
                  pr ("</tr>")
            cur.MoveNext
        Wend
          TDbg = 0
          
        
    Conn.Close
    Set Conn = Nothing
     pr "</table></td></tr>"
End Function



Public Function Ecom_ValiderCommande_TableauRecap2(DSN, Id_Caddie As String)
Dim PrixTotalHt As Double
        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
 If Request("ComFour") <> "" Then
'        Sql = " SELECT t_caddie.id_caddie as ID_caddy, t_caddie.id_produit as ID_produit, dbp_Topics.poids as poids, t_caddie.qte_produit,"
'        Sql = Sql & " t_tva.tva_valeur as Tva, t_tva.tva_id, dbp_Topics.Title as Title, dbp_Topics.prix as Prix, dbp_Topics.prixttc as TTC, dbp_Topics.prix * 6.55957 as prixf"
'        Sql = Sql & " FROM t_tva INNER JOIN (t_caddie INNER JOIN dbp_Topics ON t_caddie.id_produit = dbp_Topics.TopicId) ON t_tva.tva_id = dbp_Topics.tva_id "
'        Sql = Sql & " where t_caddie.id_caddie=" & Session("candidat_id_caddy")
''        Sql = Sql & " where t_caddie.id_caddie=" & Session("candidat_id_caddy")
'
        Sql = "SELECT T_Caddie_Four.* "
        Sql = Sql & "FROM T_Caddie_Four  "
        Sql = Sql & "where T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy")

        
 Else
    Sql = "SELECT t_caddie.* "
        Sql = Sql & "FROM t_caddie  "
        If Id_Caddie <> "" Then
            Sql = Sql & "where t_caddie.id_caddie=" & Id_Caddie
        Else
            Sql = Sql & "where t_caddie.id_caddie=" & Session("candidat_id_caddy")
        End If
 End If
 Set cur = Conn.Execute(Sql)
        rien = 0
        cpt = 0
'        total = 0#
'        totalf = 0#
        If Request("ComFour") <> "" Then
            LESTR = LESTR & vbCrLf & "<input type='hidden' name='ComFour' value='true'>"
            LESTR = LESTR & vbCrLf & "<input type='hidden' name='Id_Caddie' value='" & Id_Caddie & "'>"
           
        End If
        LESTR = LESTR & vbCrLf & ("<center><table border=""0"" width=""100%"">")
            LESTR = LESTR & vbCrLf & ("<tr><td class=""smallerheader"" colspan=""5"">")
            
                 LESTR = LESTR & vbCrLf & ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1""><tr class=""TrEntete"" align=""top"">")
                LESTR = LESTR & vbCrLf & ("<td  class=""TextTrEntete"" valign=""top"" width=""20%"">" & ImgEnteteColonne(translate("R&eacute;capitulatif commande.")) & "</td>")
        '        pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("Prix")) & "</td>")
                LESTR = LESTR & vbCrLf & ("<td  class=""TextTrEntete"" valign=""top"" width=""10%"">" & ImgEnteteColonne(translate("Référence")) & "</td>")
                LESTR = LESTR & vbCrLf & ("<td align='right' class=""TextTrEntete"" valign=""top"" width=""10%"">" & ImgEnteteColonne(translate("Qté")) & "</td>")
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" valign=""center"" width=""10%"">" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>")
'                If Request("ComFour") <> "" Then
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" valign=""center"" width=""10%"">" & ImgEnteteColonne(translate("Remise %")) & "</td>")
'                End If
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" align=""center"" width=""10%"">" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>")
                If Session("candidat_UserType") <> "Administrator" Then
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" align=""center"" width=""10%"">" & ImgEnteteColonne(translate("T.V.A. %")) & "</td>")
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" align=""center"" width=""10%"">" & ImgEnteteColonne(translate("Total T.V.A")) & "</td>")
                LESTR = LESTR & vbCrLf & ("<td class='TextTrEntete' valign=""top"" align=""center"" width=""10%"">" & ImgEnteteColonne(translate("P.T.T.C. ")) & "</td>")
                End If
                  
               LESTR = LESTR & vbCrLf & "</tr>"
                    
                
      While Not cur.EOF
      
            TypePiece = cur("Designation")
            RefProduit = cur("RefProduit")
            qte_produit = cur("qte_produit")
            PrixU_produit = cur("PrixU_produit")
'            If Request("ComFour") <> "" Then
            Remise = cur("Remise")
'            End If
            Prixt_produit = cur("qte_produit") * cur("PrixU_produit")
            Prixt_produit = Prixt_produit * (1 - Remise)
            If Session("candidat_UserType") <> "Administrator" Then
            tva = cur("TVA")
            Else
                tva = 1
            End If
            TotalTVA = Prixt_produit * ((1 / 100) * tva)
            
            ttc = TotalTVA + Prixt_produit
            PrixTotalHt = PrixTotalHt + Prixt_produit
            PrixTotalTva = PrixTotalTva + TotalTVA
            PrixTTC = PrixTTC + ttc
            
            PrixU_produit = FomatNum("" & PrixU_produit, 3)
                        
            TotalTVA = FomatNum("" & TotalTVA, 3)
            ttc = FomatNum("" & ttc, 3)
            Prixt_produit = FomatNum("" & Prixt_produit, 3)
            
            
            TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                LESTR = LESTR & vbCrLf & ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                 LESTR = LESTR & vbCrLf & ("<td width=""20%"">" & TypePiece & "</td>")
                 LESTR = LESTR & vbCrLf & ("<td  width=""10%"">" & RefProduit & "</td>")
                 LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & qte_produit & "</td>")
                 LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & PrixU_produit & "</td>")
                 LESTR = LESTR & vbCrLf & ("<td align='right'>" & Remise * 100 & "</td>")
                 LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & Prixt_produit & "</td>")
                 If Session("candidat_UserType") <> "Administrator" Then
                   LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & tva & " %</td>")
                   LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & TotalTVA & "</td>")
                   LESTR = LESTR & vbCrLf & ("<td align='right' width=""10%"">" & ttc & "</td>")
                 End If
             
                 If Request("ComFour") <> "" Then
                
                End If
                
                LESTR = LESTR & vbCrLf & ("</tr>")
            cur.MoveNext
        Wend
        
        
           

            TDbg = TDbg + 1
        If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", DSN)
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", DSN)
            End If
        LESTR = LESTR & vbCrLf & ("<tr class=""smalltext"" height=""40"">")
        If Request("ComFour") <> "" Then
            LESTR = LESTR & vbCrLf & ("<td bgcolor=""" & bgcolor & """ colspan=""5""  >Total commande</td>")
        Else
             LESTR = LESTR & vbCrLf & ("<td bgcolor=""" & bgcolor & """ colspan=""5""  >Total commande</td>")
        End If
'        LESTR = LESTR & vbCrLf & ("<td bgcolor=""" & bgcolor & """ width=""15%"">&nbsp</td>")
'        LESTR = LESTR & vbCrLf & ("<td align='center' bgcolor='" & bgcolor & "' width=""15%"">")
'        LESTR = LESTR & vbCrLf & ("&nbsp")
'        LESTR = LESTR & vbCrLf & ("<td align='center' bgcolor='" & bgcolor & "' width=""15%""> &nbsp</td>")

    PrixTotalHt = FomatNum("" & PrixTotalHt, 3)
   PrixTotalTva = FomatNum("" & PrixTotalTva, 3)
     PrixTTC = FomatNum("" & PrixTTC, 3)
    
        LESTR = LESTR & vbCrLf & (" <td align='center' bgcolor='" & bgcolor & "' > " & PrixTotalHt & "</td>")
        If Session("candidat_UserType") <> "Administrator" Then
           LESTR = LESTR & vbCrLf & ("<td align='center' bgcolor='" & bgcolor & "'> &nbsp</td>")
           
        LESTR = LESTR & vbCrLf & (" <td align='center' bgcolor='" & bgcolor & "' > " & PrixTotalTva & "</td>")
        LESTR = LESTR & vbCrLf & (" <td align='center' bgcolor='" & bgcolor & "' > " & PrixTTC & "</td>")
       End If
            
'            Je désire  que ma commande me soit transmise au comptoir.

'Je désire  que ma commande me soit transmise par transporteur suivant les condition générale de vantes.
          
         
          TDbg = 0
'                'Calcul frais de port
'                '====================
'                SQL = "select prix from  t_tarif_livraison  where poids_mini <= " & i_poids & " and poids_maxi > " & i_poids
'                Set cur = Conn.Execute(SQL)
'                If Not cur.EOF Then
'                    port_eu = CDbl(cur(0))
'                Else
'                    port_eu = 0
'                End If
'
'                SQL = "select label_pays, tarif_normal from t_pays where id_pays = " & Session("candidat_id_pays")
'                Set cur = Conn.Execute(SQL)
'                If Not cur.EOF Then
'                    coeff = CDbl(cur(1))
'                    label_pays = cur(0)
'                End If
'                Set cur = Nothing
'                If IsNull(coeff) Or (Len(CStr(coeff)) < 1) Then
'                    coeff = 1
'                End If
        
 '               port_eu = port_eu * coeff
 '               total = total + port_eu
 '               Session("total_eu") = CDbl(total)
        
'          leStr = leStr & vbCrLf & "<tr class='smalltext' height=""25"">"
'          If port_eu = 0 Then
'            leStr = leStr & vbCrLf & "<td>" & translate("Frais de port offerts") & "</td>"
'            leStr = leStr & vbCrLf & "<td align=""right"" colspan=""3"">&nbsp;</td></tr>"
'          Else
'            leStr = leStr & vbCrLf & "<td>" & translate("Frais de port") & " (<b>" & i_poids & "</b>g / " & label_pays & ") : </td>"
'            leStr = leStr & vbCrLf & "<td colspan=""2"">&nbsp;</td>"
'            leStr = leStr & vbCrLf & "<td align=""right"">" & fmt(port_eu) & "</td></tr>"
'          End If
          
'            leStr = leStr & vbCrLf & "<tr class=""TrEntete"" height=""25"">"
'            leStr = leStr & vbCrLf & "<td class=""TextTrEntete"">" & translate("Total TTC") & " ()&nbsp;:</td>"
'            leStr = leStr & vbCrLf & "<td width=""20%"" align=""right"" class=""TextTrEntete"">&nbsp;</td>"
'            leStr = leStr & vbCrLf & "<td width=""20%"" align=""center"" class=""TextTrEntete"">" & cpt & "</td>"
'            leStr = leStr & vbCrLf & "<td width=""20%"" align=""right"" class=""TextTrEntete"">" & fmt(total) & "</td></tr>"

    Conn.Close
    Set Conn = Nothing
    
    Ecom_ValiderCommande_TableauRecap2 = LESTR
End Function


Public Function Ecom_ValiderCommande1(DSN, Id_Caddie As String)
        
  Set Conn = Server.CreateObject("adodb.connection")
  Conn.Open DSN
    pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI' method='post'>")
  pr (Ecom_ValiderCommande_TableauRecap(DSN))
    
  If Session("candidat_id_pays") = "" Then Session("candidat_id_pays") = 0

 
        Session("candidat_caddy_etape") = 1
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
        pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
        pr ("<tr>")
        pr ("<td rowspan=""2"" align=""right""><img src=""" & Session("candidat_EcomPathImages") & "carteFT.gif"" border=""0""></td>")
        pr ("<td class=""paysliv"" colspan=""2"" valign=""middle"">" & translate("Pays de Livraison") & ":<br></td>")
        pr ("<td align=""center"" valign=""top""><a href=""javascript:valide_" & Session("candidat_caddy_etape") & "();"">")
        pr ("<img src=""" & Session("candidat_EcomPathImages") & "poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("<tr><td valign=""top"">")
                pr ("<select name='id_pays'>")
                    pr ("<option value='' selected>[" & translate("Choisissez") & "]")
                    pr ("<option value='999'>mon pays ne figure pas dans la liste>")
                id_pays = Session("candidat_id_pays") = 47
                Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
                Set cur = Conn.Execute(Sql)
                While Not cur.EOF
                    MyOp = ""
                    MyOp = ("<option value='" & cur(0) & "'")
'                    pr ("<option value='" & cur(0) & "'")
                    If CInt(Session("candidat_id_pays")) = CInt(cur(0)) Then
                        MyOp = MyOp & ("selected")
                        End If
                    MyOp = MyOp & (">" & cur(1))
                    pr MyOp
                    cur.MoveNext
                Wend
                  pr ("</select></td>")
          pr ("</tr></table>")
         
    
    pr ("</td></tr></table></center>")
    pr ("</form>")
    Conn.Close
    Set Conn = Nothing
        
End Function



Public Function Ecom_ValiderCommande2(DSN, Id_Caddie As String)
          pr "<script language='javascript' src='../Portal_Java/FunJava.js'></script>"
          pr "<script language='javascript'>"
         pr "function AfficherCalendar(test,txt) {"
''FrmCondi','DateLivraison'
pr " window.open('calendar.asp?jour='+ this.document.forms[test].elements[txt].value+'&test='+test+'&txt='+txt+'','dlgcat','resizable=yes,status=no,top=200,left=600,width=200,height=400')"

'pr"window.open('testCalandar.htm?test=tes&txt=txt','resizable=yes,status=no,top=200,left=200,width=300,height=400');"
pr "}"
          pr "function ValidCmd(frm,obj,Action){"
          pr "var mydate=document.forms[frm].elements[obj];"
          pr "mydate.value=MyTrim('' + mydate.value); "
          pr "if( mydate.value==''){"
          
          pr "alert('" & GetMessage("DevezSaisirDateLivraison", "vous devez saisir une date de livraison", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
          pr "return;"
          pr "}"
          pr "if (SaisieDate(frm,obj)==false){"
          pr "return;"
          pr "}"
          pr "var myfrm=document.forms[frm];"
          pr "myfrm.action=Action"
          pr "myfrm.submit();"
          pr "}"
          pr "</script>"
'pr"<script language='javaScript' src=/FunJava.js'></script>"

        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
        If val(Session("candidat_id_pays")) = 0 Then Session("candidat_id_pays") = Request("id_pays")
        If IsEmpty(Session("candidat_id_pays")) And Session("candidat_id_pays") = "" Then Session("candidat_id_pays") = "0"
        
If Session("candidat_id_pays") = "999" Or Session("candidat_id_pays") = "0" Then

            pr ("<span class='alert'>" & translate("Votre pays ne figure pas encore dans notre liste") & ".</span><br><br>")
            pr ("<span class='alert'>" & translate("Merci de nous contacter afin de connaître les frais de port correspondant à votre commande") & ".</span><br><br>")
            pr (translate("E-mail") & ": <a href='mailto:" & GetDefault("EcomEmailCommandes", "commandes@euxia.net", Session("candidat_ADOContact")) & "'>" & GetDefault("EcomEmailCommandes", "commandes@euxia.net", Session("candidat_ADOContact")) & "</a></span><BR><br><center>")
        
            Exit Function
Else
       pr (Ecom_ValiderCommande_TableauRecap2(DSN, Id_Caddie))

    'test pour sauter l'étape 3 d'dentification si le user est déjà authentifié.
    '---------------------------------------------------------------------------
    If Session("USERNAME") = "Guest" Then
        pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI' method='post'?Id_Caddie_3= " & Id_Caddie & " method=""post"">")
        pr ("<span class='smallheader'>")
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
        pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
        pr ("<input type='hidden' name='is_client' value=''>")
        pr ("<input type='hidden' name='client' value='0'>")
        pr ("<input type='hidden' name='compte_client' value='" & Session("USERNAME") & "'>")
        pr ("</span></form>")

            pr ("<tr><td colspan=""3"">&nbsp;</td>")
            pr ("<!--" & Session("candidat_caddy_etape") & "-->")
            pr ("<td align=""right""><a href='javascript:valide_" & Session("candidat_caddy_etape") & "();'>")
            pr ("<img src=""" & Session("candidat_EcomPathImages") & "poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("</tr></table></table></center>")
        

    Else
            If val(Session("candidat_caddy_etape")) = 1 Then
                pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI&Id_Caddie_2= " & Id_Caddie & "' method='post'>")
            Else
                pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI&Id_Caddie_" & Session("candidat_caddy_etape") & "= " & Id_Caddie & "' method='post'>")
            End If
        pr ("<span class='smallheader'>")
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
        pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
'        pr ("<input type='hidden' name='Id_Caddie' value='" & Id_Caddie & "'>")
        pr ("<input type='hidden' name='client' value='1'>")
        pr ("<input type='hidden' name='compte_client' value='" & Session("USERNAME") & "'>")
        If Request("ComFour") <> "" And Session("candidat_caddy_etape") = 2 Then
                         pr "<tr><td colspan=""7"">&nbsp;</td></tr>"
                       pr "<tr class=""smalltext"" height=""40""><td >&nbsp;</td><td colspan=""2"" align='right'>Livraison pr&eacute;vue le :</td>"
                       pr "<td><input type='text' size=""8"" name='DateRecep' onchange=""SaisieDate('form_etape" & Session("candidat_caddy_etape") & "','DateRecep');"" > <a href=""javascript:AfficherCalendar('form_etape" & Session("candidat_caddy_etape") & "','DateRecep');""><img src=""c_btn.bmp"" border=""0""></a></td></tr>"
                        pr "<tr><td colspan=""7"">&nbsp;</td></tr>"
        End If
        pr ("</span></form>")

           
'            pr ("Session(""candidat_caddy_etape"") : " & Session("candidat_caddy_etape"))
            If Request("ComFour") <> "" And Session("candidat_caddy_etape") = 2 Then
                         
                 pr ("<tr><td colspan=""3"">&nbsp;</td>")
                pr ("<td align=""right""><a href=""javascript: ValidCmd('form_etape" & Session("candidat_caddy_etape") & "','DateRecep','contact.asp?mode=ValiderCommandeFournisseur&ComFour=true')"">")
            Else
                 pr ("<tr><td colspan=""7"">&nbsp;</td>")
                pr ("<td align=""right"" ><a href=""javascript:valide_" & Session("candidat_caddy_etape") & "();"">")
            End If
         
            pr ("<img src=""poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("</tr></table></table></center>")

    End If
    

    
End If

    Conn.Close
    Set Conn = Nothing
        
End Function

Public Function Ecom_NumCommandeValiderCommande(DSN, Id_Caddie As String)
        
pr ("<script language=javascript>")
        pr ("function validerCom(){")
       
         
        If UCase(Trim(Request("mode"))) <> "ESPACECLIENT" Then
         pr ("if (this.document.frm.Comptoir.value=='') {")
          pr "alert('" & GetDefault("ErrorSelectionLivraison", "Vous devez choisir le mode de transport.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
        pr "return;"
        pr "}"
'            pr ("<FORM method=""post"" action=""Contact.asp?mode=EspaceClient&NumFrm=1"" name='frm'>")
'
'        pr ("<FORM method=""post"" action=""Contact.asp"" name=""form_etape" & Session("candidat_caddy_etape") & """>")
        End If
       
        pr ("this.document.frm.submit();")
        pr ("}")
pr ("</script >")
        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
        If val(Session("candidat_id_pays")) = 0 Then Session("candidat_id_pays") = Request("id_pays")
        If IsEmpty(Session("candidat_id_pays")) And Session("candidat_id_pays") = "" Then Session("candidat_id_pays") = "0"
        
If Session("candidat_id_pays") = "999" Or Session("candidat_id_pays") = "0" Then

            pr ("<span class='alert'>" & translate("Votre pays ne figure pas encore dans notre liste") & ".</span><br><br>")
            pr ("<span class='alert'>" & translate("Merci de nous contacter afin de connaître les frais de port correspondant à votre commande") & ".</span><br><br>")
            pr (translate("E-mail") & ": <a href='mailto:" & GetDefault("EcomEmailCommandes", "commandes@euxia.net", Session("candidat_ADOContact")) & "'>" & GetDefault("EcomEmailCommandes", "commandes@euxia.net", Session("candidat_ADOContact")) & "</a></span><BR><br><center>")
        
            Exit Function
Else
       pr (Ecom_ValiderCommande_TableauRecap2(DSN, Id_Caddie))

    'test pour sauter l'étape 3 d'dentification si le user est déjà authentifié.
    '---------------------------------------------------------------------------
    If Session("USERNAME") = "Guest" Then
        pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI' method='post'>")
        pr ("<span class='smallheader'>")
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
        pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
        pr ("<input type='hidden' name='is_client' value=''>")
        pr ("<input type='hidden' name='client' value='0'>")
        pr ("<input type='hidden' name='compte_client' value='" & Session("USERNAME") & "'>")
        pr ("</span></form>")

            pr ("<tr><td colspan=""3"">&nbsp;</td>")
            pr ("<!--" & Session("candidat_caddy_etape") & "-->")
            pr ("<td align=""right""><a href='javascript:valide_" & Session("candidat_caddy_etape") & "();'>")
            pr ("<img src=""" & Session("candidat_EcomPathImages") & "poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("</tr></table></table></center>")
        

    Else
        pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=CANDIDAT_CADDYREMPLI' method='post'>")
        pr ("<span class='smallheader'>")
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
        pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
        pr ("<input type='hidden' name='client' value='1'>")
        pr ("<input type='hidden' name='compte_client' value='" & Session("USERNAME") & "'>")
       
        Text = translate("Mode de livraison")
         pr ("<tr><td colspan=""3"">&nbsp;</td></tr>")
        pr vbCrLf & "<tr><td colspan='5'>" & ImgTitreEcommerce(Text) & "</td></tr>"
         bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
         pr ("<script language=javascript>")
        pr ("function ClickLivraison(Valeur){")
        pr ("this.document.frm.Comptoir.value=Valeur;")
'        pr ("alert(this.document.frm.Comptoir.value);")
        pr ("}")
pr ("</script >")
         pr "<tr><td  colspan='5' class=""TextTrEntete"" valign=""cetrer"">" & ImgEnteteColonne(translate("S&eacute;lectionez le mode de livraison")) & "</td></TR>"
                pr vbCrLf & ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
'               pr "<td >&nbsp;</td>"
                 pr vbCrLf & "<td colspan='5'>"
                 livraison = GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact")))
'                 DsnTableMenu(Session ("candidat_ADOContact"))
                 pr "<input type=""radio"" name=""Comptoir"" value=""""  onclick=""ClickLivraison('NON');"">&nbsp;&nbsp;"
                  pr livraison & "</td></tr>"
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
                  pr vbCrLf & ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
'               pr "<td >&nbsp;</td>"
                 pr vbCrLf & "<td colspan='5'>"
                 livraison = GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générale de ventes.", DsnTableMenu(Session("candidat_ADOContact")))
                 pr "<input type=""radio"" name=""Comptoir"" value=""OUI""  onclick=""ClickLivraison('OUI');"">&nbsp;&nbsp;"
                  pr livraison & "</td></tr>"
'                pr "<tr><td>&nbsp</td></tr>"
       
        pr ("</span>")
        
     
          
        
        

        pr ("</form>")

            pr ("<tr><td colspan=""3"">&nbsp;</td>")
'            pr ("Session(""candidat_caddy_etape"") : " & Session("candidat_caddy_etape"))
            pr ("<td align=""right""><a href=""javascript:validerCom();"">")
            pr ("<img src=""poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("</tr></table></table></center>")

    End If
    

    
End If

    Conn.Close
    Set Conn = Nothing
        
End Function

Public Function Ecom_ValiderCommande3(DSN, Id_Caddie As String)
        etapesuivante = val("" & Session("candidat_caddy_etape")) + 1

Session("NewUser") = 0

'If Session("Username") = "guest" Then
    If Request("err") = 1 Then
            Msg_Err = "<span class=warn>"
            Msg_Err = "<b>Echec de votre identification</b>.<br>"
            Msg_Err = Msg_Err & " <i>Nous vous invitons à vérifier la saisie de votre accès.<br>"
            Msg_Err = Msg_Err & " Si l'erreur persiste merci de contacter notre <a href=mailto:contact@flywayonline.com>webmaster</a><br></i>"
            Msg_Err = Msg_Err & " </span><br>"
    End If
    pr ("<center>")
    pr ("<table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">")
    pr ("<tr>")
        pr ("<td width=""1""><img src=""tab1_hg.gif"" width=""17"" height=""37""></td>")
        pr ("<td background=""tab1_bgh.gif"" height=""2"">")
            pr ("<div align=""left""><img src=""dejauncompte.gif""></div></td>")
        pr ("<td height=""2""><img src=""tab1_hd.gif"" width=""24"" height=""37""></td></tr>")
    pr ("<tr>")
        pr ("<td background=""tab1_bgg.gif""width=""1""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgg.gif"" width=""17"" height=""8""></td>")
        pr ("<td bgcolor=""" & GetDefault("EcomTdColor3", "F1E9DE", DsnTableMenu(Session("candidat_ADOContact"))) & """>")
        
        If UCase(Trim(Request("mode"))) = "ESPACECLIENT" Then
            pr ("<FORM method=""post"" action=""Contact.asp?mode=EspaceClient&NumFrm=1"" name='frm'>")
        Else
        pr ("<FORM method=""post"" action=""Contact.asp"" name=""form_etape" & Session("candidat_caddy_etape") & """>")
        End If
            pr ("<input type='hidden' name='mode' value='VALIDERCOMMANDE'>")
            pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
            pr ("<input type='hidden' name='act' value='login'>")
            
          pr ("<TABLE border=""0"" cellspacing=""0"" cellpadding=""2"" width=""100%"">")
            'pr ("<TR><TD colspan=""3"" class=""smallerheader"" width=""50%"" bgcolor=""#FFFFF8"">" & translate("Accès client") & "</TD></TR>")
            pr ("<TR class=""smalltext""><TD rowspan=""2"">")
            pr (translate("Afin de valider votre commande,") & "</TD></TR>")
            pr ("<TR class=""smalltext""><TD>" & translate("login") & "</TD>")
            pr ("<TD><input type=""text"" name=""c_login""></TD></TR>")
             pr (" <TR class=""smalltext""><TD>" & translate("nous vous invitons &agrave; saisir votre login et mot de passe") & ".</TD>")
            pr ("<TD>" & translate("mot de passe") & "</TD>")
            pr ("<TD><INPUT type=""password"" name=""c_password""></TD></TR>")
            pr ("<TR class=""smalltext""><TD align=""right"" colspan=""3"">")
            If UCase(Request("monde")) <> "ESPACECLIENT" Then
                 pr ("<a href='javascript:valide_" & Session("candidat_caddy_etape") & "();'><img src =""" & Session("candidat_EcomPathImages") & "valider.gif"" border=""0""></a>")
            Else
                pr ("<a href='javascript:this.document.frm.submit();'><img src =""" & Session("candidat_EcomPathImages") & "valider.gif"" border=""0""></a>")
            End If
            pr ("</TR>")
            pr ("<TR class=""smalltext""><Td colspan=""4""><CENTER><FONT COLOR='RED'><B>" & Msg_Err & "</B></FONT></CENTER></TD></TR>")
          pr ("</TABLE>")
          Session("NewUser") = 0
        pr ("</form>")
          
          pr ("</td>")
          pr ("<td background=""tab1_bgd.gif"" width=""25""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgd.gif"" width=""24"" height=""6""></td></tr>")
        pr ("<tr>")
          pr ("<td width=""1""><img src=""tab1_bg.gif"" width=""17"" height=""20""></td>")
          pr ("<td background=""tab1_bgb.gif""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgb.gif"" width=""9"" height=""20""></td>")
          pr ("<td width=""25""><img src=""tab1_bd.gif"" width=""24"" height=""20""></td>")
        pr ("</tr></table>")
        
pr ("<br><br>")

'    pr ("<table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">")
'        pr ("<tr>")
'        pr ("<td width=""1""><img src=""tab1_hg.gif"" width=""17"" height=""37""></td>")
'        pr ("<td background=""tab1_bgh.gif"" height=""2"" colspan=""2"">")
'            pr ("<div align=""left""><img src=""pasdecompte.gif""></div></td>")
'        pr ("<td height=""2""><img src=""tab1_hd.gif"" width=""24"" height=""37""></td></tr>")
'        pr ("<tr bgcolor=""" & GetDefault("EcomTdColor3", "F1E9DE", DsnTableMenu(Session ("candidat_ADOContact"))) & """>")
'        pr ("<td background=""tab1_bgg.gif""width=""1""><img src=""tab1_bgg.gif"" width=""17"" height=""8""></td>")
'        pr ("<td colspan=""2"">")
        
'        pr ("<table border=""0"" cellpadding=""0"" cellspacing=""5"" width=""100%"">")
'        pr ("<tr><td align=""left"" width=""50%"">")
'
''            pr ("<form action=""Contact.asp"" name=""form_etape" & Session("candidat_caddy_etape") & "b"">")
''                pr ("<input type='hidden' name='mode' value='VALIDERCOMMANDE'>")
''                pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
''                pr ("<input type='hidden' name='act' value='devenirclient'>")
''
''                pr ("<TABLE border=""0"" cellspacing=""0"" cellpadding=""2"" width=""80%"">")
''                  'pr ("<TR class=""smallerheader"" bgcolor=""#FFFFF8""><TD>" & translate("Devenir client") & "</TD></TR>")
''                  pr ("<TR class=""smalltext""><TD>" & translate("Si vous n'avez aucun accès et souhaitez devenir client") & ".</td></TR>")
''                  pr ("<TR><TD align=""right""><a href='javascript:valide_" & Session("candidat_caddy_etape") & "b();'><img src=""" & Session("candidat_EcomPathImages") & "devenirclient.gif"" alt=""" & translate("Devenir client") & """ border=""0""></A></TD></TR>")
''                pr ("</TABLE>")
''            pr ("</form>")
'
''        pr ("</td><td align=""left"" width=""50%"">")
'
''            pr ("<form action=""Contact.asp"" name=""form_etape" & Session("candidat_caddy_etape") & "c"">")
''                pr ("<input type='hidden' name='mode' value='VALIDERCOMMANDE'>")
''                pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
''                pr ("<input type='hidden' name='act' value='commanderapide'>")
''                pr ("<TABLE border=""0"" cellspacing=""0"" cellpadding=""2"" width=""80%"">")
''                    'pr ("<TR class=""smallerheader"" bgcolor=""#FFFFF8""><TD>" & translate("Commande Rapide") & "</TD></TR>")
''                    pr ("<TR class=""smalltext""><TD>" & translate("Si vous souhaitez Commander") & ".</td></TR>")
''                    pr ("<TR><td align=""right""><a href='javascript:valide_" & Session("candidat_caddy_etape") & "c();'><img src=""" & Session("candidat_EcomPathImages") & "commanderapide.gif"" alt=""" & translate("Commande rapide") & """ border=""0""></A></TD></TR>")
''                pr ("</TABLE>")
''            pr ("</form>")
'
'        pr ("</td></tr></table>")
'
'        pr ("</td>")
'        pr ("<td background=""tab1_bgd.gif"" width=""25""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgd.gif"" width=""24"" height=""6""></td></tr>")
'        pr ("<tr>")
'        pr ("<td width=""1""><img src=""tab1_bg.gif"" width=""17"" height=""20""></td>")
'        pr ("<td colspan=""2"" background=""tab1_bgb.gif""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgb.gif"" width=""9"" height=""20""></td>")
'        pr ("<td width=""25""><img src=""tab1_bd.gif"" width=""24"" height=""20""></td>")
'    pr ("</tr></table>")
    pr ("</center>")
'Else
'    Response.Redirect ("Contact.asp?mode=VALIDERCOMMANDE&etape=" & etapesuivante)
'End If
End Function

Public Function EspaceCliantUseur(DSN)
  Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
pr ("<script language='javascript'>")
pr "function valide()"
pr "{"
pr "    var f "
pr "eval(""f=this.document.frm;"");"
pr "    var ret = true;"
pr "    var err = """ & GetMessage("ErreursApparues", "Les erreurs suivantes sont apparues:", DsnTableMenu(Session("candidat_ADOContact"))) & """;"

pr "    if (f.c_login.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += ""\nVotre login est vide"";"
pr "    }"
 pr "   if (f.c_password.value.length<1)"
 pr "   {"
 pr "       ret = false;"
 pr "       err += ""\nVotre mot de passe est vide"";"
 pr "   }"
pr ""
 pr "   if (ret)"
pr "    {"
pr "//      alert(""ok"");"
 pr "       f.submit();"
pr "    } else  {"
 pr "       alert(err);"
 pr "   }"

pr "}"
pr ("</script>")
pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
image = "etape3.gif"
Text = translate("Identification")
pr (ImgTitreEcommerce(Text))
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
  
If Trim("" & Request("c_login")) <> "" Then
Sql = "SELECT users.UserID, users.NumIndiveClient,users.FirstName, users.Password, users.UserType "
        Sql = Sql & "From users "
        Sql = Sql & "WHERE users.UserLogin='" & Request("c_login") & "' "
        Sql = Sql & "AND  "
        Sql = Sql & "users.UserEmailPass='" & Request("c_password") & "'"

'        Sql = Sql & " WHERE UserLogin='" & Request("c_login") & "' "
'        Sql = Sql & " AND UserEmailPass='" & Request("c_password") & "'"
        Set Rs = Conn.Execute(Sql)
        If Rs.EOF = True Then
            Response.Redirect "Contact.asp?mode=" & Request("mode") & "&err=1"
        Else
            Session("HisoriqueCLI") = "Contact.asp?mode=HISTORIQUE_Compte&ID=" & Rs!UserID
             Session("FactureCLI") = "Contact.asp?mode=HISTORIQUE_Compte&ID=" & Rs!UserID & "&ModeFacture=OK"
             Response.Redirect "Contact.asp?mode=HISTORIQUE_Compte&ID=" & Rs!UserID & "&ModeFacture=" & Request("ModeFacture")
             Session("username") = Rs("FirstName")
            Session("UserId") = Rs("UserID")
            Session("NumIndiveClient") = "" & Rs("NumIndiveClient")
            is_client = -1
            Session("NewUser") = 0
            Session("PassOk") = "OK"
             Rs.Close
             Set Rs = Nothing
             Conn.Close
             Set Conn = Nothing
        End If
        Exit Function
End If


'If Session("Username") = "guest" Then
    If Request("err") = 1 Then
            Msg_Err = "<span class=warn>"
            Msg_Err = "<b>Echec de votre identification</b>.<br>"
            Msg_Err = Msg_Err & " <i>Nous vous invitons à vérifier la saisie de votre accès.<br>"
            Msg_Err = Msg_Err & " Si l'erreur persiste merci de contacter notre <a href=mailto:contact@flywayonline.com>webmaster</a><br></i>"
            Msg_Err = Msg_Err & " </span><br>"
    End If
    pr ("<center>")
    pr ("<table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">")
    pr ("<tr>")
        pr ("<td width=""1""><img src=""tab1_hg.gif"" width=""17"" height=""37""></td>")
        pr ("<td background=""tab1_bgh.gif"" height=""2"">")
            pr ("<div align=""left""><img src=""dejauncompteRd.gif""></div></td>")
        pr ("<td height=""2""><img src=""tab1_hd.gif"" width=""24"" height=""37""></td></tr>")
    pr ("<tr>")
        pr ("<td background=""tab1_bgg.gif""width=""1""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgg.gif"" width=""17"" height=""8""></td>")
        pr ("<td bgcolor=""" & GetDefault("EcomTdColor3", "F1E9DE", DsnTableMenu(Session("candidat_ADOContact"))) & """>")
        
        If UCase(Trim(Request("mode"))) = "ESPACECLIENT" Then
            pr ("<FORM method=""post"" action=""Contact.asp?mode=EspaceClient&NumFrm=1"" name='frm'>")
        Else
        pr ("<FORM method=""post"" action=""Contact.asp"" name=""form_etape"">")
        End If
            pr ("<input type='hidden' name='mode' value='VALIDERCOMMANDE'>")
            pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
            pr ("<input type='hidden' name='act' value='login'>")
            pr ("<input type='hidden' name='ModeFacture' value='" & Request("ModeFacture") & "'>")
           
          pr ("<TABLE border=""0"" cellspacing=""0"" cellpadding=""2"" width=""100%"">")
            'pr ("<TR><TD colspan=""3"" class=""smallerheader"" width=""50%"" bgcolor=""#FFFFF8"">" & translate("Accès client") & "</TD></TR>")
            pr ("<TR class=""smalltext""><TD rowspan=""2"">")
            pr (translate("Nous vous invitons &agrave; saisir votre login et mot de passe") & ".</TD></TR>")
            pr ("<TR class=""smalltext""><TD>" & translate("login") & "</TD>")
            pr ("<TD><input type=""text"" name=""c_login""></TD></TR>")
             pr (" <TR class=""smalltext""><TD>&nbsp</TD>")
            pr ("<TD>" & translate("mot de passe") & "</TD>")
            pr ("<TD><INPUT type=""password"" name=""c_password""></TD></TR>")
            pr ("<TR class=""smalltext""><TD align=""right"" colspan=""3"">")
            If UCase(Request("monde")) <> "ESPACECLIENT" Then
                 pr ("<a href='javascript:valide();'><img src =""" & Session("candidat_EcomPathImages") & "valider.gif"" border=""0""></a>")
            Else
                pr ("<a href='javascript:this.document.frm.submit();'><img src =""" & Session("candidat_EcomPathImages") & "valider.gif"" border=""0""></a>")
            End If
            pr ("</TR>")
            pr ("<TR class=""smalltext""><Td colspan=""4""><CENTER><FONT COLOR='RED'><B>" & Msg_Err & "</B></FONT></CENTER></TD></TR>")
          pr ("</TABLE>")
          Session("NewUser") = 0
        pr ("</form>")
          
          pr ("</td>")
          pr ("<td background=""tab1_bgd.gif"" width=""25""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgd.gif"" width=""24"" height=""6""></td></tr>")
        pr ("<tr>")
          pr ("<td width=""1""><img src=""tab1_bg.gif"" width=""17"" height=""20""></td>")
          pr ("<td background=""tab1_bgb.gif""><img src=""" & Session("candidat_EcomPathImages") & "tab1_bgb.gif"" width=""9"" height=""20""></td>")
          pr ("<td width=""25""><img src=""tab1_bd.gif"" width=""24"" height=""20""></td>")
        pr ("</tr></table>")
        
pr ("<br><br>")
 pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing
End Function

Public Function CONFIGC_USER_NEW(DSN)
'Session("Cli") = Request("Id")
'pr "<script language='javascript' >"
''pr "function recopie()"
''pr ""
''pr "{"
''pr "    var f = document.form_etape;"
''pr ""
''pr "    var id_pays = f.c_id_pays.options[f.c_id_pays.selectedIndex].value;"
''pr "    var existe = false;"
''pr "    var index = -1;"
'''pr "    var numoption=f.c_id_User_P.selectedindex;"
'''pr "    alert(numoption);"
''pr "    f.l_beneficiaire.value =f.c_id_User_P.options[f.c_id_User_P.selectedIndex].text;"
''pr "    f.l_societe.value = f.c_societe.value;"
''pr "    f.l_adresse.value = f.c_adresse.value;"
''pr "    f.l_cp.value = f.c_codepostal.value;"
''pr "    f.l_ville.value = f.c_ville.value;"
''pr "}"
'pr "</script>"

    Set Conn = Server.CreateObject("adodb.connection")
    Dim Sql1 As String
    Conn.Open DSN
    pr "<script language='javascript'>"
pr "function valide()"
pr "{"
pr "    var f = document.form_etape;"
pr "    var ret = true;"
pr "    var err = """ & GetMessage("ErreursApparues", "Les erreurs suivantes sont apparues:", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    "
'pr "    if (f.c_NumIndiveClient.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += ""\nN° Client nom est vide"";"
'pr "    }"

pr "    if (f.c_nom.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("NomEstVide", "\nVotre nom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_p_nom.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("PreNomEstVide", "\nVotre prénom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
'pr "    if (f.c_adresse.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("AdressePersonnelleVide", "\nVotre adresse personnelle est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_codepostal.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_ville.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomVotreVilleVide", "\nLe nom de votre ville est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysVotreAdressePersonnelleIncorrect", "\nLe Pays de votre adresse personnelle est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_codepostal.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "       err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    "
'pr "    if (f.l_beneficiaire.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomBeneficiaireVide", "\nLe nom du bénéficiaire est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.l_cp.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("CodePostalLivraisionVide", "\nLe code postal de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.l_ville.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomVilleLivraisonVide", "\nLe nom de la ville de livraison est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysAdresseLivraisonIncorrect", "\nLe Pays de l'adresse de livraison est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_phone.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("VotreTelEphoneVide", "\nVotre Téléphone est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "/*  if (!f.accepte.checked)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("VousAvezPasAccepteConditionsGeneralesVente", "\nVous n'avez pas accepté les conditions générales de vente", DsnTableMenu(Session("candidat_ADOContact"))) & """"
'pr "    }"
'pr "*/"
pr "    if (f.c_passwd1.value.length>1)"
pr "    {"
pr "        if (f.c_UserLogin.value.length<1)"
pr "        {"
pr "            ret = false;"
pr "            err += ""\nVotre login est vide"";"
pr "        }"
'pr "        if (f.c_passwd1.value!=f.c_passwd2.value)"
'pr "        {"
'pr "        ret = false;"
'pr "        err += ""\nVos mots de passe ne sont pas identiques"";"
'pr "        }"
pr "    }"
pr "    else"
pr "    {"
pr "        err += ""\nVotre mot de passe est vide"";"
pr "    }"
pr "    if (ret)"
pr "    {"
pr "//      alert(""ok"");"
pr "        f.submit();"
pr "    }"
pr "    else"
pr "    {"
pr "        alert(err);"
pr "    }"
pr ""
pr "}"
pr "</script>"
    'Vérification du login & mot de passe
    If Trim(Request("act")) = "Update" Then
       
        
        Sql = "SELECT users.* From users "
                Sql = Sql & "WHERE users.UserLogin=" & noquote2(Request("c_UserLogin")) & " "
        
        'pr sql & "<br><br>"
        If val(Trim("" & Request("Id"))) <> 0 Then
            Sql = Sql & "AND Users.userid<>" & Trim(Request("Id")) & ";"
         
        End If
        'pr sql & "<br><br>"
        Set Rs = Conn.Execute(Sql)
        If Rs.EOF = False Then
            Msg_Err = "Erreur le User : " & Request("c_UserLogin") & GetMessage("ExistedejaEnregistrmentNonEffectuee", " Existe d&eacute;j&agrave; enregistrment non effectu&eacute;", DsnTableMenu(Session("candidat_ADOContact")))
        Else
'            Sql = "SELECT t_pays.id_pays From t_pays WHERE t_pays.label_pays=" & noquote2(Request("c_id_pays")) & ";"
'            Set Rs = Conn.Execute(Sql)
'            If Rs.EOF = False Then
'            c_id_pays = Trim("" & Request("c_id_pays"))
'            If Trim(c_id_pays) = "" Then
'                c_id_pays = 47
'             Else
'                Session("candidat_id_pays") = c_id_pays
'             End If
            If val(Trim("" & Request("Id"))) = 0 Then 'nouveau client
 
                    Sql = "select max(userid) from users;"
                    Set cur = Conn.Execute(Sql)
                    Id_User = cur(0)
                    If IsNull(Id_User) Then
                        Id_User = 1
                    End If
                    
'
                    
                    Id_User = Id_User + 1
                     Session("id_User") = Id_User
                   

                    
                    'Mise à jour de Dbp_Users
'                    UserLogin = Request("c_nom") & " " & Request("c_nom")
                    Sql = "INSERT INTO Users ( phone,FirstName,LastName,Password,UserEMail,CId,UserLogin,UserEmailPass,Portable, fax, Rechercher, Visualiser, Commander, Acheter, Administrer,  "
                Sql = Sql & "UserDisplayName, Id_Societes, UserID ) "
                Sql = Sql & "VALUES ("
                 Sql = Sql & noquote2(Request("c_phone")) & ",  "
                Sql = Sql & noquote2(Request("c_Nom")) & ",  "
                Sql = Sql & noquote2(Request("c_P_Nom")) & ",  "
                Sql = Sql & noquote2(Request("c_passwd1")) & ",  "
                Sql = Sql & noquote2(Request("c_UserEMail")) & ",  "
                Sql = Sql & Application("PortalId") & ", "
                Sql = Sql & noquote2(Request("c_UserLogin")) & ",  "
                 Sql = Sql & noquote2(Request("c_passwd1")) & ",  "
                Sql = Sql & noquote2(Request("c_Portable")) & ",  "
                Sql = Sql & noquote2(Request("c_fax")) & ",  "
                If Request("c_Rechercher") = "TRUE" Then Sql = Sql & "true, " Else Sql = Sql & " false, "
               If Request("c_Visualiser") = "TRUE" Then Sql = Sql & "true, " Else Sql = Sql & " false, "
               If Request("c_Commander") = "TRUE" Then Sql = Sql & "true, " Else Sql = Sql & " false, "
               If Request("c_Acheter") = "TRUE" Then Sql = Sql & "true, " Else Sql = Sql & " false, "
               If Request("c_Administrer") = "TRUE" Then Sql = Sql & "true, " Else Sql = Sql & " false, "
                Sql = Sql & noquote2(Request("c_nom") & " " & Request("c_p_nom")) & ",  "
                Sql = Sql & Session("id_client") & ",  "
                Sql = Sql & Session("id_User") & " );"

                Conn.Execute (Sql)
                  
              
              Msg_Err = GetMessage("InformationsAjout", "Vos informations ont été correctement ajout&eacute;es.", DsnTableMenu(Session("candidat_ADOContact")))
        Else                'déjà client
        UserDisplayName = Trim(Request("c_nom")) & " " & Trim(Request("c_nom"))
                
                Sql = "update users set "
                Sql = Sql & " CId = " & Application("PortalId") & ", "
                Sql = Sql & " FirstName = " & noquote2(Request("c_nom")) & ", "
                Sql = Sql & " LastName = " & noquote2(Request("c_p_nom")) & ", "
                Sql = Sql & " UserEMail = " & noquote2(Request("c_UserEMail")) & ", "
                Sql = Sql & " Password = " & noquote2(Request("c_passwd1")) & ", "
                Sql = Sql & " UserEmailPass = " & noquote2(Request("c_passwd1")) & ", "
                Sql = Sql & " UserLogin = " & noquote2(Request("c_UserLogin")) & ", "
                Sql = Sql & " phone = " & noquote2(Request("c_phone")) & ", "
                Sql = Sql & " Portable = " & noquote2(Request("c_Portable")) & ", "
                Sql = Sql & " fax = " & noquote2(Request("c_fax")) & ", "
                If Request("c_Rechercher") = "TRUE" Then Sql = Sql & " Rechercher = true, " Else Sql = Sql & " Rechercher = false, "
                If Request("c_Visualiser") = "TRUE" Then Sql = Sql & " Visualiser = true, " Else Sql = Sql & " Visualiser = false, "
                If Request("c_Commander") = "TRUE" Then Sql = Sql & " Commander = true, " Else Sql = Sql & " Commander = false, "
                If Request("c_Acheter") = "TRUE" Then Sql = Sql & " Acheter = true, " Else Sql = Sql & " Acheter = false, "
                 If Request("c_Administrer") = "TRUE" Then Sql = Sql & " Administrer = true, " Else Sql = Sql & " Administrer = false, "
                Sql = Sql & " UserDisplayName = " & noquote2(Request("c_nom") & " " & Request("c_p_nom")) & ", "
                Sql = Sql & " Id_Societes = " & Session("id_client") & " "
                Sql = Sql & " where  UserID=" & Request("Id") & ";"
                    

                Conn.Execute (Sql)
                
'        If Request("c_Administrer") = "TRUE" Then
'            Session("candidat_UserType") = "Administrator"
'        Else
''            Session("candidat_UserType") = ""
'
''            If Request("c_Commander") = "TRUE" Then
''                Session("UserCommander") = 1
''            Else
''                Session("UserCommander") = 0
''            End If
'
''            If Request("c_Acheter") = "TRUE" Then
''            Session("UserAcheter") = 1
''            Else
''                Session("UserAcheter") = 0
''            End If
'
'
''            If Request("c_Visualiser") = "TRUE" Then
''                Session("candidat_UserType") = "Invite"
''
''            Else
''                If Trim("" & Session("candidat_UserType")) <> "Administrator" Then
''                    Session("candidat_UserType") = "Anonyme"
''                    Session("portal_candidat_Recherhe") = 1
''                End If
'
'
'        End If

'        End If
        
'        If Request("c_Rechercher") = "TRUE" Then
'            Session("portal_candidat_Recherhe") = 1
'        Else
'            Session("portal_candidat_Recherhe") = 0
'        End If
       
                
'                 RsRaison.Close

                     Msg_Err = GetMessage("InformationsMAJ", "Vos informations ont été correctement mises à jour.", DsnTableMenu(Session("candidat_ADOContact")))
                End If
        End If
    End If
    On Error GoTo 0
    If val(Trim("" & Id_User)) = 0 Then Session("id_User") = val(Trim("" & Request("id")))
                If val("" & Request("Id")) <> 0 Then
                Session("id_User") = Request("Id")
                Id_User = Request("Id")
                Sql = "SELECT users.* From users "
                Sql = Sql & "WHERE users.UserID=" & Request("id") & ";"
                Else
                    
                Sql = "SELECT users.* From users "
                Sql = Sql & "WHERE users.UserID=" & Session("id_User") & ";"
                End If

                
                Set cur = Conn.Execute(Sql)
                If cur.EOF = False Then
                c_nom = "" & cur("FirstName")
                 c_P_Nom = "" & cur("LastName")
                c_UserLogin = "" & cur("UserLogin")
                If cur("Rechercher") = True Then c_Rechercher = "checked" Else c_Rechercher = ""
                If cur("Visualiser") = True Then c_Visualiser = "checked" Else c_Visualiser = ""
                If cur("Commander") = True Then c_Commander = "checked" Else c_Commander = ""
                If cur("Acheter") = True Then c_Acheter = "checked" Else c_Acheter = ""
                If cur("Administrer") = True Then c_Administrer = "checked" Else c_Administrer = ""
                c_phone = "" & cur("phone")
                c_Portable = "" & cur("Portable")
                 c_fax = "" & cur("fax")
                 c_UserEMail = "" & cur("UserEMail")
                 c_passwd1 = "" & cur("UserEmailPass")
                 Else
                 Session("id_User") = ""
                 Id_User = ""
                End If
'                b = cur.BOF
               

                 
                    
           
           
            
                pr ("<form name='form_etape' action='Contact.asp?mode=CONFIGC_USER_NEW&Act=Update' method='post'>")
                
                etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
                pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
                pr ("<input type='hidden' name='is_client' value='" & is_client & "'>")
                If val(Request("Id")) = 0 Then
                    If Trim("" & Session("id_User")) <> "" Then Id_User = val(Trim("" & Session("id_User")))
                     pr ("<input type='hidden' name='id' value='" & Id_User & "'>")
                    Else
                        If Trim("" & Session("id_User")) <> "" And Trim("" & Id_User) <> "" Then
                            pr ("<input type='hidden' name='id' value='" & Request("Id") & "'>")
                    Else
                            pr ("<input type='hidden' name='id' value=''>")
                    End If
                End If
                pr ("<input type='hidden' name='act' value='" & Request("act") & "'>")
                pr ("<input type='hidden' name='id_livraison' value='" & id_livraison & "'>")
                pr ("<input type='hidden' name='compte_client' value='" & Session("username") & "'>")
                pr ("<input type='hidden' name='modifie' value='0'>")
            
            'MESSAGE ERREUR EVENTUEL
            '=======================
        If Msg_Err <> "" Then pr ("<CENTER><FONT COLOR='RED'><B>" & Msg_Err & "</B></FONT></CENTER>")
        
        pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Profil utilisateur") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("N° Client") & ":</td>")
'             pr ("<td width='74%'><input type='text' name='c_NumIndiveClient' value='" & c_NumIndiveClient & "' maxlength=40  size=20 class='champ'></td></tr>")
'              pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_societe' value='" & c_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Nom") & ":</td>")
             pr ("<td width='74%'><input type='text' name='c_nom' value='" & c_nom & "' maxlength=40  size=20 class='champ'></td>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Prénom") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_p_nom' value='" & c_P_Nom & "' maxlength=40  size=20 class='champ'></td>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Login") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_UserLogin ' value='" & c_UserLogin & "' maxlength=40  size=20 class='champ'></td>")
'            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Contact pricipale") & ":</td>")
''
'              pr ("<td width='74%'>")
'            pr ("<select name='c_id_User_P' class='champ'>")
'                pr ("<option value='' selected>[" & translate("Choisissez") & "]")
'
'                        Sql = "SELECT Users.* "
'                        Sql = Sql & "FROM t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "
'                        If Trim("" & Request("Id")) = "" Then
'                            Sql = Sql & "WHERE t_R_Social.SocieteId= " & id_client & "  "
'                        Else
'                            Sql = Sql & "WHERE t_R_Social.SocieteId= " & Request("Id") & "  "
'                        End If
'                        Sql = Sql & "ORDER BY Users.FirstName, Users.LastName ;"
'                        Set cur = Conn.Execute(Sql)
'                        While Not cur.EOF
'                            pr ("<option value=" & cur("UserID"))
'                                If UCase(Trim("" & c_Nom)) = UCase(Trim("" & cur("FirstName"))) And UCase(Trim("" & c_prenom)) = UCase(Trim("" & cur("LastName"))) Then
'                                    pr ("SELECTED")
'                                End If
'                                pr (" >" & cur("FirstName") & " " & cur("LastName"))
'                            cur.MoveNext
'                        Wend
'                        Set cur = Nothing
'                        pr ("</select></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_adresse' value='" & c_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_codepostal' value='" & c_codepostal & "' maxlength=10  size=10 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_ville' value='" & c_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Pays") & ":</td>")
'
'              pr ("<td width='74%'>")
'            pr ("<select name='c_id_pays' class='champ'>")
'                pr ("<option value='' selected>[" & translate("Choisissez") & "]")
'
'                        Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
'                        Set cur = Conn.Execute(Sql)
'                        While Not cur.EOF
'                            pr ("<option value=" & cur(0))
'                                If (CInt(l_id_pays) = CInt(cur(0))) Or (CInt(Session("candidat_id_pays")) = CInt(cur(0))) Then
'                                    pr ("SELECTED")
'                                End If
'                                pr (" >" & cur(1))
'                            cur.MoveNext
'                        Wend
'                        Set cur = Nothing
'                        pr ("</select></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_phone' value='" & c_phone & "' maxlength=40  size=20 class='champ'></td>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_Fax' value='" & c_fax & "' maxlength=40  size=20 class='champ'></td>")
            
           
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("E-Mail") & ":</td>")
            pr ("<td><input type='text' name='c_UserEMail' value='" & c_UserEMail & "' maxlength=150 size=60 class='champ'></td>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           
'
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("D&eacute;lai de paiement (en jours)") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NbJour' value='" & c_NbJour & "' maxlength=2 size=2 class='champ'></td></tr>")
               
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Taux de remise (en %)") & ":</td>")
'           pr ("<td width='74%'><input type='text' name='c_Remise' value='" & c_Remise & "' maxlength=2 size=2 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           
'
' pr ("<tr class='smalltext'><td width='26%'>" & translate("Stock ENCELADE") & ":</td>")
'  pr ("<td width='74%'><input type='checkbox' name='c_SockEncelade' value='TRUE' " & c_SockEncelade & " maxlength=2 size=2 class='champ'></td></tr>")
             pr ("<tr><td colspan=2> &nbsp; </td></tr>")
                pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Gestion des droits") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
             pr ("<tr><td class=""smalltext"">" & translate("Rechercher") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""checkbox"" name=""c_Rechercher"" value='TRUE' " & c_Rechercher & "  class=""champ""></dt>")
                    pr ("<tr><td class=""smalltext"">" & translate("Visualiser") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""checkbox"" name=""c_Visualiser"" value='TRUE' " & c_Visualiser & "  class=""champ""></dt>")
                    pr ("<tr><td class=""smalltext"">" & translate("Commander") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""checkbox"" name=""c_Commander"" value='TRUE' " & c_Commander & " class=""champ""></dt>")
                     pr ("<tr><td class=""smalltext"">" & translate("Acheter") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""checkbox"" name=""c_Acheter"" value='TRUE' " & c_Acheter & " maxlength=16 size=20 class=""champ""></dt>")
                    pr ("<tr><td class=""smalltext"">" & translate("Administrer") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""checkbox"" name=""c_Administrer"" value='TRUE' " & c_Administrer & " class=""champ""></dt>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
'                If Request("act") = "devenirclient" Then
                'DONNE LOGIN ET MOT DE PASSE POUR LE NOUVEAU CLIENT
                '==================================================
                    pr ("<tr><td colspan=2 class=""smallheader"" >")
                        pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                            pr ("<tr class=""smallheader"">")
                            pr ("<td width=""50%"" background=""" & Session("candidat_EcomPathImages") & "entete_bg.gif"">&nbsp;</td>")
                            pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete1.gif""></td>")
                            pr ("<td align=""right"" background=""" & Session("candidat_EcomPathImages") & "entete2.gif"">" & translate("Informations de connexion au site") & "&nbsp; ")
                            pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete3.gif""></td></tr>")
                            pr ("<tr height=""10""><td colspan=""4"">")
                            pr ("<img src=""" & Session("candidat_EcomPathImages") & "transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                        pr ("</table>")
                    pr ("</td></tr>")
                    pr ("<tr><td class=""smalltext"">" & translate("Votre login") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""text"" name=""c_UserLogin"" value='" & c_UserLogin & "' maxlength=16 size=20 class=""champ"">")
                    pr ("<tr><td class=""smalltext"">" & translate("Mot de passe") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""text"" name=""c_passwd1"" value='" & c_passwd1 & "' maxlength=16 size=20 class=""champ"">")
'                    pr ("<tr><td class=""smalltext"">" & translate("Confirmez") & ":</td>")
'                    pr ("<td  class=""smalltext"">")
'                    pr ("<input type='password' name='c_passwd2' value='' maxlength=16 size=20 class=""champ""></tr>")
'                    pr ("<input type='hidden' name='passwd_client' value=''>")
                    pr ("<tr><td colspan=2>&nbsp;</td></tr>")
''                Else
'                    pr ("<tr><td colspan=2>&nbsp;")
'                    pr ("<input type='hidden' name='c_login' value='" & Session("username") & "'>")
'                    pr ("<input type='hidden' name='c_passwd1' value='********'>")
'                    pr ("<input type='hidden' name='c_passwd2' value='********'>")
'                    pr ("</td></tr>")
'                End If
                
                
            ' COORDONNES DE LIVRAISON
            '========================
'            pr ("<tr><td colspan=2 class=""smallheader"" >")
'                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
'                    pr ("<tr class=""smallheader"">")
'                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
'                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
'                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Vos coordonnées de Livraison") & "&nbsp; ")
'                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
'                    pr ("<tr>")
'                    pr ("<td colspan=""3"" align=""left""><span class='smallertext'><a href='javascript:recopie();'>")
'                    pr ("<img src=""copiercoller.gif"" border=""0"" al=""" & translate("Recopier les informations personnelles") & """>&nbsp;&nbsp;" & translate("Recopier les informations personnelles") & "</a></span></td>")
'                    pr ("<td>&nbsp;</td></tr>")
'                pr ("</table>")
'            pr ("</td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' align=""right""><img src=""" & Session("candidat_EcomPathImages") & "cadeau.gif"" alt=""cadeau"">&nbsp;&nbsp;</td>")
'            pr ("<td width='74%'><input type='checkbox' value='1' name='l_kdo' class='champ'>" & translate("Cochez la case si cette commande est un cadeau") & "</td></tr>")
'            pr ("<tr class='smalltext'>")
'
'
'            pr ("<td width='26%'>" & translate("Soci&eacute;t&eacute;") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='l_societe' value='" & l_societe & "' maxlength=40  size=30 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%'>" & translate("B&eacute;n&eacute;ficiaire") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='l_beneficiaire' value='" & l_beneficiaire & "' maxlength=40  size=30 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='l_adresse' value='" & l_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='l_cp' value='" & l_cp & "' maxlength=10  size=10 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville:") & "</td>")
'            pr ("<td width='74%'><input type='text' name='l_ville' value='" & l_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Pays") & ":</td><td width='74%'>")
'                        Sql = "select label_pays from t_pays where id_pays = " & Session("candidat_id_pays")
'                        Set cur = Conn.Execute(Sql)
'                            pr (cur("label_pays"))
'                        Set cur = Nothing
'            pr ("<input type='hidden' name='l_id_pays' value='" & Session("candidat_id_pays") & "'></td></tr>")
'            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
''            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' valign=""top"">" & translate("Message du cadeau") & ":</td>")
'            pr ("<td width='74%'><textarea name=""l_kdotxt"" cols=""40"" rows=""5"" wrap=""physical"" class=""champs"">&nbsp;</textarea></td></tr>")
            
            pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
              
'            'CONDITIONS GENERALES DE VENTES
'            '==============================
'            pr ("<tr class=""smallertext"">")
'            pr ("<td>&nbsp;</td>")
'            pr ("<td>")
'            pr ("<input type='checkbox' name='accepte'>&nbsp;" & translate("J'accepte les") & "<a href='" & GetDefault("EcomPathCGV", "../portal_ecom/commander/conditions/conditions.html") & "' target='_blank'>")
'            pr (translate("conditions générales de vente") & "</a>&nbsp;")
'            pr ("</td></tr>")
            
            'pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
            
            pr ("</table>")
        
            'VALIDATION & COMMANDER
            '======================
        pr ("<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        pr ("<td align=""right""><a href='javascript:valide();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
'         If val(Request("Id")) <> "0" Then
'                       pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLIUser&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_User.jpeg"" border=""0""></a>")
'                      pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
'                Else
'                    If val("" & id_client) <> 0 Then
'                    Session("NumIndiveClient") = id_client
'                    Session("id_client") = id_client
'                            pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLIUser&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_User.jpeg"" border=""0""></a>")
'                        pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&Id=" & id_client & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
'                    End If
'                End If
       
         pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=CONFIGCLIUSER&Id=" & Session("id_client") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>")
        pr ("</tr></table></form>")
            
            'INFORMATIONS LEGALES
            '====================
        pr ("<table border=""0"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""smallertext""><tr>")
        pr ("<td align=""left"">")
        pr ("Les informations qui vous concernent sont destinées à Encelade. Elles ne seront pas transmises à des tiers.")
        pr ("Vous disposez d'un droit d'accès, de modification, de rectification et de suppression des données qui vous concernent (art. 34 de la loi Informatique et Libertés)" & ".")
        pr ("Pour l'exercer, contactez-nous à" & " <a href=""mailto:" & GetDefault("EcomEmailContact", "contact@euxia.net", Session("candidat_ADOContact")) & """>" & Session("EcomEmailContact") & "</a></td>")
        pr ("</tr></table>")
        
        
    Conn.Close
    Set Conn = Nothing
    
End Function
Public Function CONFIGCLI_New(DSN)
Session("Cli") = Request("Id")
pr "<script language='javascript' >"
pr "function recopie()"
pr ""
pr "{"
pr "    var f = document.form_etape;"
pr ""
pr "    var id_pays = f.c_id_pays.options[f.c_id_pays.selectedIndex].value;"
pr "    var existe = false;"
pr "    var index = -1;"
'pr "    var numoption=f.c_id_User_P.selectedindex;"
'pr "    alert(numoption);"
pr "    f.l_beneficiaire.value =f.c_id_User_P.options[f.c_id_User_P.selectedIndex].text;"
pr "    f.l_societe.value = f.c_societe.value;"
pr "    f.l_adresse.value = f.c_adresse.value;"
pr "    f.l_cp.value = f.c_codepostal.value;"
pr "    f.l_ville.value = f.c_ville.value;"
pr "}"
pr "</script>"

    Set Conn = Server.CreateObject("adodb.connection")
    Dim Sql1 As String
    Conn.Open DSN
    pr "<script language='javascript'>"
pr "function valide()"
pr "{"
pr "    var f = document.form_etape;"
pr "    var ret = true;"
pr "    var err = """ & GetMessage("ErreursApparues", "Les erreurs suivantes sont apparues:", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    "
'pr "    if (f.c_NumIndiveClient.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += ""\nN° Client nom est vide"";"
'pr "    }"

'pr "    if (f.c_nom.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomEstVide", "\nVotre nom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_prenom.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PreNomEstVide", "\nVotre prénom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
pr "    if (f.c_adresse.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("AdressePersonnelleVide", "\nVotre adresse personnelle est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_codepostal.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.c_ville.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("NomVotreVilleVide", "\nLe nom de votre ville est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysVotreAdressePersonnelleIncorrect", "\nLe Pays de votre adresse personnelle est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
pr "    if (f.c_codepostal.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "       err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    "
pr "    if (f.l_beneficiaire.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("NomBeneficiaireVide", "\nLe nom du bénéficiaire est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.l_cp.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("CodePostalLivraisionVide", "\nLe code postal de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
pr "    if (f.l_ville.value.length<1)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("NomVilleLivraisonVide", "\nLe nom de la ville de livraison est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysAdresseLivraisonIncorrect", "\nLe Pays de l'adresse de livraison est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_phone.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("VotreTelEphoneVide", "\nVotre Téléphone est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
pr "/*  if (!f.accepte.checked)"
pr "    {"
pr "        ret = false;"
pr "        err += """ & GetMessage("VousAvezPasAccepteConditionsGeneralesVente", "\nVous n'avez pas accepté les conditions générales de vente", DsnTableMenu(Session("candidat_ADOContact"))) & """"
pr "    }"
pr "*/"
'pr "    if (f.c_passwd1.value.length>1)"
'pr "    {"
'pr "        if (f.c_login.value.length<1)"
'pr "        {"
'pr "            ret = false;"
'pr "            err += ""\nVotre login est vide"";"
'pr "        }"
''pr "        if (f.c_passwd1.value!=f.c_passwd2.value)"
''pr "        {"
''pr "        ret = false;"
''pr "        err += ""\nVos mots de passe ne sont pas identiques"";"
''pr "        }"
'pr "    }"
'pr "    else"
'pr "    {"
'pr "        err += ""\nVotre mot de passe est vide"";"
'pr "    }"
pr "    if (ret)"
pr "    {"
pr "//      alert(""ok"");"
pr "        f.submit();"
pr "    }"
pr "    else"
pr "    {"
pr "        alert(err);"
pr "    }"
pr ""
pr "}"
pr "</script>"
    'Vérification du login & mot de passe
    If Trim(Request("act")) = "Update" Then
        Sql = "SELECT  t_R_Social.fld3 "
        Sql = Sql & "FROM t_R_Social "
        Sql = Sql & "WHERE t_R_Social.fld3='" & Request("c_societe") & "' and  t_R_Social.Address ='" & Request("c_adresse") & "' and  t_R_Social.Zip='" & Request("c_codepostal") & "' and  t_R_Social.City='" & Request("c_ville") & "' "
        'pr sql & "<br><br>"
        If val(Trim("" & Request("Id"))) <> 0 Then
            Sql = Sql & "AND t_R_Social.SocieteId<>" & Trim(Request("Id")) & ";"
         
        End If
        'pr sql & "<br><br>"
        Set Rs = Conn.Execute(Sql)
        If Rs.EOF = False Then
       '" & GetMessage("ExistedejaEnregistrmentNonEffectuee", " Existe d&eacute;j&agrave; enregistrment non effectu&eacute;", DsnTableMenu(Session("candidat_ADOContact"))) & "'
            Msg_Err = GetMessage("ErreurNumClient", "Erreur le N° Client: ", DsnTableMenu(Session("candidat_ADOContact"))) & Request("c_NumIndiveClient") & GetMessage("ExistedejaEnregistrmentNonEffectuee", " Existe d&eacute;j&agrave; enregistrment non effectu&eacute;", DsnTableMenu(Session("candidat_ADOContact")))
        Else
'            Sql = "SELECT t_pays.id_pays From t_pays WHERE t_pays.label_pays=" & noquote2(Request("c_id_pays")) & ";"
'            Set Rs = Conn.Execute(Sql)
'            If Rs.EOF = False Then
            c_id_pays = Trim("" & Request("c_id_pays"))
            If Trim(c_id_pays) = "" Then
                c_id_pays = 47
             Else
                Session("candidat_id_pays") = c_id_pays
             End If
            If val(Trim("" & Request("Id"))) = 0 Then 'nouveau client
 
                    Sql = "select max(SocieteId) from t_R_Social"
                    Set cur = Conn.Execute(Sql)
                    id_client = cur(0)
                    If IsNull(id_client) Then
                        id_client = 1
                    End If
                    
                    Sql = "select max(id_livraison) from t_livraison"
                     'pr sql & "<br><br>"
                    Set cur = Conn.Execute(Sql)
                    id_livraison = cur(0)
                    If IsNull(id_livraison) Then
                        id_livraison = 1
                    End If
                    
                    id_client = id_client + 1
                    id_livraison = id_livraison + 1
                    
                   
                    Session("id_client") = id_client
                    Session("id_livraison") = id_livraison

                    
                    'Mise à jour de Dbp_Users
                    UserLogin = Request("c_nom") & " " & Request("c_nom")
'                    HashIt (passwd_client)
'                    sql0 = "insert into t_R_Social ( CId, SocieteId, NumIndiveClient,   id_livraison      ) values ("
'                    sql0 = sql0 & Application("PortalId") & ", "
'                    sql0 = sql0 & id_client & ", "
'                    sql0 = sql0 & noquote2(Request("c_NumIndiveClient")) & ", "
''                    sql0 = sql0 & noquote2(Request("c_login")) & ", "
''                    sql0 = sql0 & noquote2(Session("HashData")) & ", "
''                    sql0 = sql0 & noquote2(Request("c_nom")) & ", "
''                    sql0 = sql0 & noquote2(Request("c_prenom")) & ", "
''                    sql0 = sql0 & noquote2(UserLogin) & ", "
''                    sql0 = sql0 & noquote2(Request("c_email")) & ", "
''                    sql0 = sql0 & noquote2(Session("HashSecure")) & ", "
'                    sql0 = sql0 & id_livraison & " "
'                    sql0 = sql0 & ")"
'
'                     'pr sql0 & "<br><br>"
'                    Conn.Execute (sql0)
                    
                    Sql1 = ""
                    'Mise à jour de Dbp_UserInfos
                    Sql1 = "insert into t_R_Social (CId, SocieteId, id_livraison, LastName, FirstName, "
                    Sql1 = Sql1 & "Address, Zip, City, id_pays,  fld3, Email,phone,Fax,NumIndiveClient,Remise,SockEncelade,NbJoursPaie) values ("
                    Sql1 = Sql1 & Application("PortalId") & ", "
                    Sql1 = Sql1 & id_client & ", "
                    Sql1 = Sql1 & id_livraison & ", "
                    Sql1 = Sql1 & noquote2(Request("c_nom")) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_prenom")) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_adresse")) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_codepostal")) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_ville")) & ", "
                    Sql1 = Sql1 & c_id_pays & ", "
'                    Sql1 = Sql1 & noquote2(c_numfna) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_societe")) & ", "
                    Sql1 = Sql1 & noquote2(Request("c_email")) & ","
                    Sql1 = Sql1 & noquote2(Request("c_phone")) & ","

'                        Sql1 = Sql1 & "Portable=" & noquote2(c_Portable) & ","
                        Sql1 = Sql1 & noquote2(Request("c_Fax")) & ","
                        Sql1 = Sql1 & noquote2(Request("c_NumIndiveClient"))
                        Sql1 = Sql1 & "," & val(Request("c_Remise")) & ","
                        If Request("c_SockEncelade") = "TRUE" Then
                            Session("Droits_SockEncelade") = 1
                             Sql1 = Sql1 & "true,  "
                        Else
                             Sql1 = Sql1 & "false,  "
                             Session("Droits_SockEncelade") = 0
                        End If
                        Sql1 = Sql1 & val(Request("c_NbJour"))
                        Sql1 = Sql1 & ")"
                         'pr sql1 & "<br><br>"
                    Conn.Execute (Sql1)
                  
                    'Mise à jour de Dbp_GroupsPermission : Groupe Visiteur
'                    sql4 = "insert into Dbp_GroupsPermission (CId, GroupID, ObjTypeId, ObjPermId, ObjId, ObjPermType) values ("
'                    sql4 = sql4 & Application("PortalId") & ", "
'                    sql4 = sql4 & GetDefault("EcomGroupIdVisiteurs", "2", Session("candidat_ADOContact")) & ", "
'                    sql4 = sql4 & "50, "
'                    sql4 = sql4 & "1, "
'                    sql4 = sql4 & id_client & ", "
'                    sql4 = sql4 & "10)"
'                    conn.Execute (sql4)
                    
                    'Mise à jour de t_livraison
                    sql2 = "insert into t_livraison (id_livraison, id_pays, beneficiare_liv, adresse_liv, cp_liv, ville_liv, cadeau, cadeau_texte,Societe) values ("
                    sql2 = sql2 & id_livraison & ", "
                    sql2 = sql2 & c_id_pays & ", "
                    sql2 = sql2 & noquote2(Request("l_beneficiaire")) & ", "
                    sql2 = sql2 & noquote2(Request("l_adresse")) & ", "
                    sql2 = sql2 & noquote2(Request("l_cp")) & ", "
                    sql2 = sql2 & noquote2(Request("l_ville")) & ","
                    sql2 = sql2 & noquote2(Request("l_kdo")) & ","
                    sql2 = sql2 & noquote2(Request("l_kdotxt")) & ","
                    sql2 = sql2 & noquote2(Request("l_societe")) & ")"
                     'pr sql2 & "<br><br>"
                    Conn.Execute (sql2)
                
                Session("id_client") = id_client
                Session("HashData") = ""
                Session("HashSecure") = ""
                
                'Rappel du login et mot de passe pour un nouveau client.
                '-------------------------------------------------------
'             If Request("act") <> "commanderapide" Then
'                pr ("<span class=""smalltext""><b>" & translate("Vos informations ont été correctement enregistrées") & ".</b><br><br>")
'                    pr ("<span class=""alert""> " & translate("N'oubliez pas de noter vos") & " <b>" & translate("informations de connexion") & "</b> :</span><br>")
'                    pr ("<span class=""smalltext"">" & translate("Identifiant") & " : " & login & "</span> <br>")
'                    pr ("<span class=""smalltext"">" & translate("Mot de passe") & " : " & passwd_client & "</span>")
'                    pr ("<br><br>")
'              End If
              Msg_Err = GetMessage("InformationsAjout", "Vos informations ont été correctement ajout&eacute;es.", DsnTableMenu(Session("candidat_ADOContact")))
        Else                'déjà client
        UserDisplayName = Trim(Request("c_nom")) & " " & Trim(Request("c_nom"))
                
'                sql0 = "update users set "
'                sql0 = sql0 & " CId = " & Application("PortalId") & ", "
'                sql0 = sql0 & " NumIndiveClient = " & noquote2(Request("c_NumIndiveClient")) & ", "
'                sql0 = sql0 & " FirstName = " & noquote2(Request("c_nom")) & ", "
'                sql0 = sql0 & " LastName = " & noquote2(Request("c_prenom")) & ", "
'                sql0 = sql0 & " UserDisplayName = " & noquote2(UserDisplayName) & ", "
'                sql0 = sql0 & " UserEMail = " & noquote2(Request("c_email")) & ", "
'                sql0 = sql0 & " Password = " & noquote2(Request("c_passwd1")) & ", "
'                sql0 = sql0 & " UserEmailPass = " & noquote2(Request("c_passwd1")) & ", "
'                sql0 = sql0 & " UserLogin = " & noquote2(Request("c_Login")) & ", "
'                sql0 = sql0 & " NbJoursPaie=" & val(Request("c_NbJour")) & ", "
'                sql0 = sql0 & " Remise=" & val(Request("c_Remise")) & " "
'                sql0 = sql0 & " where  UserID=" & Request("Id") c_id_User_P
                    Sql1 = "SELECT t_R_Social.* FROM t_R_Social WHERE t_R_Social.SocieteId=" & Request("Id")
                    Set RsRaison = Conn.Execute(Sql1)
                 
                    If RsRaison.EOF = False Then
                    id_livraison = Trim("" & RsRaison("id_livraison"))
                    Sql1 = ""
'                        Sql1 = "update t_R_Social set "
'                        Sql1 = Sql1 & " CId = " & Application("PortalId") & ", "
'                        Sql1 = Sql1 & " LastName = " & noquote2(Request("c_nom")) & ", "
'                        Sql1 = Sql1 & " FirstName = " & noquote2(Request("c_prenom")) & ", "
'                        Sql1 = Sql1 & " fld3 = " & noquote2(Request("c_societe")) & ", "
'                        Sql1 = Sql1 & " Address = " & noquote2(Request("c_adresse")) & ", "
'                        Sql1 = Sql1 & " Zip = " & noquote2(Request("c_codepostal")) & ", "
'                        Sql1 = Sql1 & " City = " & noquote2(Request("c_ville")) & ", "
'                        Sql1 = Sql1 & " Email = " & noquote2(Request("c_email")) & ", "
'                        Sql1 = Sql1 & " fld2 = " & noquote2(Request("c_numfna")) & ", "
'                        Sql1 = Sql1 & " id_livraison = " & id_livraison & ", "
'                        Sql1 = Sql1 & " id_pays = " & c_id_pays & ","
'                        Sql1 = Sql1 & "phone= " & noquote2(Request("c_phone")) & ","
'                        Sql1 = Sql1 & "Id_Contact=" & Request("c_id_User_P") & ","
'                        Sql1 = Sql1 & "Fax  = " & noquote2(Request("c_Fax"))
'                        Sql1 = Sql1 & " where  UserId=" & Request("Id")

                        
                        Sql1 = "UPDATE t_R_Social  "
                        Sql1 = Sql1 & "LEFT JOIN (SELECT Users.* FROM Users WHERE Users.UserID=" & Request("c_id_User_P") & " ) AS frm ON t_R_Social.SocieteId = frm.Id_Societes  "
                        Sql1 = Sql1 & "SET t_R_Social.CId = " & Application("PortalId") & ",  "
                        Sql1 = Sql1 & "t_R_Social.LastName = [frm].[LastName],  "
                        Sql1 = Sql1 & "t_R_Social.FirstName = [frm].[FirstName],  "
                        Sql1 = Sql1 & "t_R_Social.fld3 = " & noquote2(Request("c_societe")) & ",  "
                        Sql1 = Sql1 & "t_R_Social.Address = " & noquote2(Request("c_adresse")) & ",  "
                        Sql1 = Sql1 & "t_R_Social.Zip = " & noquote2(Request("c_codepostal")) & ",  "
                        Sql1 = Sql1 & "t_R_Social.City = " & noquote2(Request("c_ville")) & ",  "
                        Sql1 = Sql1 & "t_R_Social.Email = [frm].[UserEMail],  "
                        Sql1 = Sql1 & "t_R_Social.Remise=" & val(Request("c_Remise")) & ", "
                        Sql1 = Sql1 & "t_R_Social.NbJoursPaie=" & val(Request("c_NbJour")) & ", "
                        If Request("c_SockEncelade") = "TRUE" Then
                                Session("Droits_SockEncelade") = 1
                             Sql1 = Sql1 & "t_R_Social.SockEncelade =true,  "
                        Else
                             Sql1 = Sql1 & "t_R_Social.SockEncelade =false,  "
                             Session("Droits_SockEncelade") = 0
                        End If
                       
                        Sql1 = Sql1 & "t_R_Social.fld2 =  "
                        Sql1 = Sql1 & "Null, t_R_Social.id_livraison = " & id_livraison & ",  "
                        Sql1 = Sql1 & "t_R_Social.id_pays = " & c_id_pays & ",  "
                        Sql1 = Sql1 & "t_R_Social.phone =[frm].[phone], "
                        Sql1 = Sql1 & "t_R_Social.Id_Contact = [frm].[UserID],  "
                        Sql1 = Sql1 & "t_R_Social.fax = [frm].[fax] "
                        Sql1 = Sql1 & "WHERE t_R_Social.SocieteId=" & Request("Id") & ";"

                        
                        
                        
                        
'                        Id_Contact
                    Else
                        Sql1 = "INSERT INTO t_R_Social ( "
                        Sql1 = Sql1 & "CId, "
                        Sql1 = Sql1 & "LastName, "
                        Sql1 = Sql1 & "FirstName, "
                        Sql1 = Sql1 & "fld3, "
                        Sql1 = Sql1 & "Address, "
                        Sql1 = Sql1 & "Zip, "
                        Sql1 = Sql1 & "City, "
                        Sql1 = Sql1 & "Email, "
                        Sql1 = Sql1 & "fld2, "
                        Sql1 = Sql1 & "id_livraison, "
                        Sql1 = Sql1 & "id_pays, "
                        Sql1 = Sql1 & "UserID,"
                        Sql1 = Sql1 & "phone , "
'                        Sql1 = Sql1 & "Portable"
                        Sql1 = Sql1 & "Fax) "
                        Sql1 = Sql1 & "values (  "
                        Sql1 = Sql1 & Application("PortalId") & ", "
                        Sql1 = Sql1 & noquote2(c_nom) & ", "
                        Sql1 = Sql1 & noquote2(c_prenom) & ", "
                        Sql1 = Sql1 & noquote2(c_societe) & ", "
                        Sql1 = Sql1 & noquote2(c_adresse) & ", "
                        Sql1 = Sql1 & noquote2(c_codepostal) & ", "
                        Sql1 = Sql1 & noquote2(c_ville) & ", "
                        Sql1 = Sql1 & noquote2(c_email) & ", "
                        Sql1 = Sql1 & noquote2(c_numfna) & ", "
                        Sql1 = Sql1 & id_livraison & ", "
                        Sql1 = Sql1 & c_id_pays & ", "
                        Sql1 = Sql1 & id_client & ", "
                         Sql1 = Sql1 & noquote2(c_phone) & ","
'                        Sql1 = Sql1 & noquote2(c_Portable) & ","
                        Sql1 = Sql1 & noquote2(c_fax)
                        Sql1 = Sql1 & ");"


                    End If
                   
                    'vérifie si client a un identifiant de livraison
                    sqltemp = "SELECT id_livraison FROM t_livraison where  id_livraison = " & id_livraison
                    Set test = Conn.Execute(sqltemp)
                    If test.BOF Then
                        'Insertion dans t_livraison
                        sql2 = "insert into t_livraison (id_livraison, id_pays, beneficiare_liv, adresse_liv, cp_liv, ville_liv, cadeau, cadeau_texte,societe) values ("
                        sql2 = sql2 & id_livraison & ", "
                        sql2 = sql2 & l_id_pays & ", "
                        sql2 = sql2 & noquote2(l_beneficiaire) & ", "
                        sql2 = sql2 & noquote2(l_adresse) & ", "
                        sql2 = sql2 & noquote2(l_cp) & ", "
                        sql2 = sql2 & noquote2(l_ville) & ","
                        sql2 = sql2 & noquote2(l_kdo) & ","
                        sql2 = sql2 & noquote2(l_kdotxt) & ";"
                        sql2 = sql2 & noquote2(l_societe) & ")"
                        
                    Else
                        'Mise à jour de t_livraison
                        sql2 = "update t_livraison set "
                        sql2 = sql2 & " id_pays=" & c_id_pays & ", "
                        sql2 = sql2 & " beneficiare_liv=" & noquote2(Request("l_beneficiaire")) & ", "
                        sql2 = sql2 & " adresse_liv=" & noquote2(Request("l_adresse")) & ", "
                        sql2 = sql2 & " cp_liv=" & noquote2(Request("l_cp")) & ", "
                        sql2 = sql2 & " ville_liv=" & noquote2(Request("l_ville")) & ", "
'                        sql2 = sql2 & " cadeau=" & Request("l_kdo") & ","
                        sql2 = sql2 & " cadeau_texte=" & noquote2(Request("l_kdotxt")) & ", "
                        sql2 = sql2 & " societe=" & noquote2(Request("l_societe")) & " "
                        
                        sql2 = sql2 & " where  id_livraison = " & id_livraison
                    End If
                  
                    Set test = Nothing
                    
                Conn.Execute (sql2)
                Conn.Execute (Sql1)
'                Conn.Execute (sql0)
                RsRaison.Requery
                 RsRaison.Close
                    Set RsRaison = Nothing
                     Msg_Err = GetMessage("InformationsMAJ", "Vos informations ont été correctement mises à jour.", DsnTableMenu(Session("candidat_ADOContact")))
                End If
        End If
    End If
    On Error GoTo 0
    If Request.Form("act") = "login" Then
   
        Sql = "SELECT users.UserID, users.NumIndiveClient,users.FirstName, users.Password, users.UserType "
        Sql = Sql & "From users "
        Sql = Sql & "WHERE users.UserLogin='" & Request("c_login") & "' "
        Sql = Sql & "AND  "
        Sql = Sql & "users.UserEmailPass='" & Request("c_password") & "'"

'        Sql = Sql & " WHERE UserLogin='" & Request("c_login") & "' "
'        Sql = Sql & " AND UserEmailPass='" & Request("c_password") & "'"
        Set Rs = Conn.Execute(Sql)
        If Not Rs.BOF Then
            Session("username") = Rs("FirstName")
            Session("UserId") = Rs("UserID")
            Session("c_password") = "" & Rs("Password")
            Session("NumIndiveClient") = "" & Rs("NumIndiveClient")
            is_client = -1
            Session("NewUser") = 0
        Else
        
            Session("username") = "guest"
            Session("candidat_caddy_etape") = Session("candidat_caddy_etape") - 1
            Response.Redirect ("Contact.asp?mode=Candidat_caddyRempli&mode2=validercommande&err=1&etape=" & Session("candidat_caddy_etape"))
            Session("NewUser") = 1
        End If
   End If

 
            If (val(Request("Id")) Or val("" & id_client) <> 0) Then
               If val(Trim(Request("Id"))) = 0 Then
                
                Sql = "SELECT UserId FROM users WHERE  UserId = " & val("" & id_client)
               Sql = "SELECT  t_R_Social.SocieteId  FROM users RIGHT JOIN t_R_Social ON users.UserID = t_R_Social.Id_Contact "
                Sql = Sql & "WHERE  t_R_Social.SocieteId=" & id_client & ";"
                Session("id_client") = id_client
               Else
                Session("id_client") = Request("Id")
                Sql = "SELECT  t_R_Social.SocieteId  FROM users RIGHT JOIN t_R_Social ON users.UserID = t_R_Social.Id_Contact "
                Sql = Sql & "WHERE  t_R_Social.SocieteId=" & Request("id") & ";"

                End If
                Set cur = Conn.Execute(Sql)
                a = cur.EOF
                b = cur.BOF
                cur.Requery
                If Not cur.EOF Then
                    id_client = cur(0)
                    Set cur = Nothing
                    Sql = "SELECT c.LastName, "         '0
                    Sql = Sql & " c.FirstName, "        '1
                    Sql = Sql & " c.Address, "          '2
                    Sql = Sql & " c.Zip, "              '3
                    Sql = Sql & " c.City, "             '4
                    Sql = Sql & " c.id_pays, "          '5
                    Sql = Sql & " p.label_pays, "       '6
                    Sql = Sql & " c.Email, "            '7
                    Sql = Sql & " c.id_livraison, "     '8
                    Sql = Sql & " c.fld2, "             '9 - numéro FNA"
                    Sql = Sql & " c.fld3, "             '10 - societe
'                    Sql = Sql & " c.Portable,"         '11
                    Sql = Sql & " c.phone,"             '11
                    Sql = Sql & " c.Fax, "              '12
                    Sql = Sql & " c.SockEncelade, "
                    Sql = Sql & " u.UserLogin, "          '13
                    Sql = Sql & " u.UserEmailPass "      '14
                    Sql = Sql & ", u.NumIndiveClient "  '15
                    Sql = Sql & ",c.NbJoursPaie  "          ' 16
                    Sql = Sql & ",c.Remise "
                    Sql = Sql & " FROM  t_R_Social c, t_pays p ,Users u "
                    Sql = Sql & " WHERE p.id_pays = c.id_pays "
                    Sql = Sql & " And c.SocieteId = " & id_client & " AND u.UserID = " & id_client
                    
                    Sql = "SELECT c.LastName,  "
                    Sql = Sql & "c.FirstName,  "
                    Sql = Sql & "c.Address,  "
                    Sql = Sql & "c.Zip,  "
                    Sql = Sql & "c.City,  "
                    Sql = Sql & "c.id_pays,  "
                    Sql = Sql & "p.label_pays,  "
                    Sql = Sql & "c.Email,  "
                    Sql = Sql & "c.id_livraison,  "
                    Sql = Sql & "c.fld2,  "
                    Sql = Sql & "c.fld3,  "
                    Sql = Sql & "c.phone,  "
                    Sql = Sql & "c.fax,  "
                    Sql = Sql & "u.UserLogin,  "
                    Sql = Sql & "u.UserEmailPass,  "
                    Sql = Sql & "c.NumIndiveClient,  "
                    Sql = Sql & "c.NbJoursPaie,  "
                    Sql = Sql & "c.Remise "
                    Sql = Sql & "FROM t_R_Social AS c, t_pays AS p, Users AS u "
                    Sql = Sql & "WHERE p.id_pays=[c].[id_pays]  "
                    Sql = Sql & "AND c.Id_Contact=[u].[UserID]  "
                    Sql = Sql & "AND c.SocieteId= " & id_client & ";"
                    
                    Sql = "SELECT c.LastName,   "
                    Sql = Sql & "c.FirstName,   "
                    Sql = Sql & "c.Address,   "
                    Sql = Sql & "c.Zip,   "
                    Sql = Sql & "c.City,   "
                    Sql = Sql & "c.id_pays,   "
                    Sql = Sql & "p.label_pays,   "
                    Sql = Sql & "c.Email,   "
                    Sql = Sql & "c.id_livraison,   "
                    Sql = Sql & "c.fld2,   "
                    Sql = Sql & "c.fld3,   "
                    Sql = Sql & "c.phone,   "
                    Sql = Sql & "c.fax,   "
                    Sql = Sql & "u.UserLogin,   "
                    Sql = Sql & "u.UserEmailPass,   "
                    Sql = Sql & "c.NumIndiveClient,   "
                    Sql = Sql & "c.NbJoursPaie,   "
                    Sql = Sql & "c.Remise,"
                     Sql = Sql & "c.SockEncelade "
                    Sql = Sql & "FROM (t_R_Social AS c LEFT JOIN Users AS u ON c.SocieteId = u.Id_Societes)   "
                    Sql = Sql & "INNER JOIN t_pays AS p ON c.id_livraison = p.id_pays  "
                    Sql = Sql & "WHERE c.SocieteId=" & id_client & ";"


                    Sql = "SELECT c.LastName, "
                    Sql = Sql & "c.FirstName, "
                    Sql = Sql & "c.Address, "
                    Sql = Sql & "c.Zip, "
                    Sql = Sql & "c.City, "
                    Sql = Sql & "c.id_pays, "
                    Sql = Sql & "p.label_pays, "
                    Sql = Sql & "c.Email, "
                    Sql = Sql & "c.id_livraison, "
                    Sql = Sql & "c.fld2, "
                    Sql = Sql & "c.fld3, "
                    Sql = Sql & "c.phone, "
                    Sql = Sql & "c.fax, "
                    Sql = Sql & "u.UserLogin, "
                    Sql = Sql & "u.UserEmailPass, "
                    Sql = Sql & "c.NumIndiveClient, "
                    Sql = Sql & "c.NbJoursPaie, "
                    Sql = Sql & "c.Remise, "
                    Sql = Sql & "c.SockEncelade "
                    Sql = Sql & "FROM "
                    Sql = Sql & "(t_R_Social AS c LEFT JOIN t_pays AS p ON c.id_livraison = p.id_pays) "
                    Sql = Sql & "LEFT JOIN Users AS u ON c.Id_Contact = u.UserID "
                    Sql = Sql & "WHERE c.SocieteId=" & id_client & ";"

                    
                    
                    
                    
                    
                    Set cur = Conn.Execute(Sql)
                        If cur.BOF Then
                        Session("NewUser") = 1
                         
                        Msg_Err = GetMessage("comptePasReconnu", "Votre compte n'a pas été reconnu.<br>", DsnTableMenu(Session("candidat_ADOContact")))
                        Msg_Err = Msg_Err & GetMessage("compteressaisir", " Nous vous invitons à ressaisir vos coordonn&eacute;es pour les mettre à jour.<br>", DsnTableMenu(Session("candidat_ADOContact")))
                        'Msg_Err = Msg_Err & "A l'issue vous recevrez un nouvel accès.""
                            c_nom = Session("UserLast")
                            c_prenom = Session("UserFirst")
                            c_societe = ""
                            c_adresse = ""
                            c_codepostal = ""
                            c_ville = ""
                            c_id_pays = 0
                            c_pays = ""
                            c_email = Session("EMAIL")
                            c_numfna = ""
'                            c_Portable = ""
                            c_phone = ""
                            c_fax = ""
                            c_NbJour = "30"
                            id_livraison = 0
                            c_Remise = 0
                        Else
                        
                        Session("NewUser") = 0
                            c_nom = Trim("" & cur(1))
                            c_prenom = Trim("" & cur(0))
                            c_societe = Trim("" & cur(10))
                            c_adresse = Trim("" & cur(2))
                            c_codepostal = Trim("" & cur(3))
                            c_ville = Trim("" & cur(4))
                            c_id_pays = cur(5)
                            c_pays = cur(6)
                            c_email = Trim("" & cur(7))
                            c_numfna = Trim("" & cur(9))
                             c_Login = Trim("" & cur(13))
                            c_passwd = Trim("" & cur(14))
                            c_NumIndiveClient = Format(Trim("" & id_client), "000#")
                            c_NbJour = Trim("" & cur(16))
                            c_Remise = Trim("" & cur(17))
                            If cur(18) = True Then c_SockEncelade = "checked"
                             c_phone = Trim("" & cur(11))
'                             c_Portable = Trim("" & cur(12))
                             c_fax = Trim("" & cur(12))
                            If cur(8) = "" Or IsEmpty(cur(8)) Then
                                id_livraison = 0
                            Else
                                id_livraison = cur(8)
                            End If
                            
                        End If
                    Set cur = Nothing

                    Sql = "select l.beneficiare_liv, "
                    Sql = Sql & " l.adresse_liv, "
                    Sql = Sql & " l.cp_liv, "
                    Sql = Sql & " l.ville_liv, "
                    Sql = Sql & " l.id_pays, "
                    Sql = Sql & " p.label_pays, "
                     Sql = Sql & "l.societe "
                    Sql = Sql & " from  t_livraison l, t_pays p "
                    Sql = Sql & " where l.id_livraison = " & id_livraison
                    Sql = Sql & " and   p.id_pays = l.id_pays"

                    Set cur = Conn.Execute(Sql)
                        If cur.BOF Then
                            l_beneficiaire = ""
                            l_adresse = ""
                            l_cp = ""
                            l_ville = ""
                            l_id_pays = 0
                            l_societe = ""
                        Else
                            l_beneficiaire = cur(0)
                            l_adresse = "" & cur(1)
                            l_cp = "" & cur(2)
                            l_ville = "" & cur(3)
                            l_id_pays = "" & cur(4)
                            l_societe = "" & cur(6)
                        End If
                Else
                    is_client = -1
                    
                End If
                Set cur = Nothing
            Else
'
'                Sql = "SELECT Max([UserID]) AS MaxUserID FROM users;"
'                Set cur = Conn.Execute(Sql)
'
'                If cur.EOF = True Then
'
'                id_client = 1
'                Else
'
'                 id_client = inc(cur(0))
'                End If
'                Set cur = Nothing
'
'                Sql = "select max(id_livraison) from t_livraison"
'                Set cur = Conn.Execute(Sql)
'                id_livraison = inc(cur(0))
'
'                Set cur = Nothing
                
                c_nom = ""
                c_prenom = ""
                c_adresse = ""
                c_codepostal = ""
                c_ville = ""
                c_id_pays = ""
                c_email = ""
                l_beneficiaire = ""
                l_adresse = ""
                l_cp = ""
                l_ville = ""
                l_id_pays = "47"
                compte_client = ""
                c_Remise = 0
                c_NbJour = 30
                'passwd_client = Session("passwd_client")
                
            End If
            
                        
'            If is_client > -1 Then
'            If Session("username") <> "guest" Then
'                If is_client = -1 Then
'                    Session("NewUser") = 1
'                Else
'                    Session("NewUser") = 0
'                End If
'                is_client = -1
'
'            Else
'                is_client = 0
'                Session("NewUser") = 1
'            End If
            
                pr ("<form name='form_etape' action='Contact.asp?mode=CONFIGCLI_New&Act=Update' method='post'>")
                
                etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
                pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
                pr ("<input type='hidden' name='is_client' value='" & is_client & "'>")
                If val(Request("Id")) = "0" Then
                     pr ("<input type='hidden' name='id' value='" & id_client & "'>")
                Else
                pr ("<input type='hidden' name='id' value='" & Request("Id") & "'>")
                End If
                pr ("<input type='hidden' name='act' value='" & Request("act") & "'>")
                pr ("<input type='hidden' name='id_livraison' value='" & id_livraison & "'>")
                pr ("<input type='hidden' name='compte_client' value='" & Session("username") & "'>")
                pr ("<input type='hidden' name='modifie' value='0'>")
            
            'MESSAGE ERREUR EVENTUEL
            '=======================
        If Msg_Err <> "" Then pr ("<CENTER><FONT COLOR='RED'><B>" & Msg_Err & "</B></FONT></CENTER>")
        
        pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Adresse de facturation") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("N° Client") & ":</td>")
             pr ("<td width='74%'><input type='text' disabled name='c_NumIndiveClient' value='" & c_NumIndiveClient & "' maxlength=40  size=20 class='champ'></td></tr>")
              pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_societe' value='" & c_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Nom") & ":</td>")
             pr ("<input type='hidden' name='c_nom' value='" & c_nom & "' maxlength=40  size=20 class='champ'>")
            
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Prénom") & ":</td>")
            pr ("<input type='hidden' name='c_prenom' value='" & c_prenom & "' maxlength=40  size=20 class='champ'>")
            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Contact pricipale") & ":</td>")
'
              pr ("<td width='74%'>")
            pr ("<select name='c_id_User_P' class='champ'>")
                pr ("<option value='' selected>[" & translate("Choisissez") & "]")

                        Sql = "SELECT Users.* "
                        Sql = Sql & "FROM t_R_Social INNER JOIN Users ON t_R_Social.SocieteId = Users.Id_Societes "
                        If Trim("" & Request("Id")) = "" Then
                            Sql = Sql & "WHERE t_R_Social.SocieteId= " & val("" & id_client) & "  "
                        Else
                            Sql = Sql & "WHERE t_R_Social.SocieteId= " & val("" & Request("Id")) & "  "
                        End If
                        Sql = Sql & "ORDER BY Users.FirstName, Users.LastName ;"
                        Set cur = Conn.Execute(Sql)
                        While Not cur.EOF
                            pr ("<option value=" & cur("UserID"))
                                If UCase(Trim("" & c_nom)) = UCase(Trim("" & cur("FirstName"))) And UCase(Trim("" & c_prenom)) = UCase(Trim("" & cur("LastName"))) Then
                                    pr ("SELECTED")
                                End If
                                pr (" >" & cur("FirstName") & " " & cur("LastName"))
                            cur.MoveNext
                        Wend
                        Set cur = Nothing
                        pr ("</select></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_adresse' value='" & c_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_codepostal' value='" & c_codepostal & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_ville' value='" & c_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Pays") & ":</td>")
'
              pr ("<td width='74%'>")
            pr ("<select name='c_id_pays' class='champ'>")
                pr ("<option value='' selected>[" & translate("Choisissez") & "]")

                        Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
                        Set cur = Conn.Execute(Sql)
                        While Not cur.EOF
                            pr ("<option value=" & cur(0))
                                If (CInt(l_id_pays) = CInt(cur(0))) Or (CInt(Session("candidat_id_pays")) = CInt(cur(0))) Then
                                    pr ("SELECTED")
                                End If
                                pr (" >" & cur(1))
                            cur.MoveNext
                        Wend
                        Set cur = Nothing
                        pr ("</select></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<input type='hidden' name='c_phone' value='" & c_phone & "' maxlength=40  size=20 class='champ'>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<input type='hidden' name='c_Fax' value='" & c_fax & "' maxlength=40  size=20 class='champ'>")
            
           
            
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("E-Mail") & ":</td>")
            pr ("<input type='hidden' name='c_email' value='" & c_email & "' maxlength=150 size=60 class='champ'>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("D&eacute;lai de paiement (en jours)") & ":</td>")
            pr ("<td width='74%'><input type='text' name='c_NbJour' value='" & c_NbJour & "' maxlength=2 size=2 class='champ'></td></tr>")
               
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Taux de remise (en %)") & ":</td>")
           pr ("<td width='74%'><input type='text' name='c_Remise' value='" & c_Remise & "' maxlength=2 size=2 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           

 pr ("<tr class='smalltext'><td width='26%'>" & translate("Stock ENCELADE") & ":</td>")
  pr ("<td width='74%'><input type='checkbox' name='c_SockEncelade' value='TRUE' " & c_SockEncelade & " maxlength=2 size=2 class='champ'></td></tr>")
             pr ("<tr><td colspan=2> &nbsp; </td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
'                If Request("act") = "devenirclient" Then
                'DONNE LOGIN ET MOT DE PASSE POUR LE NOUVEAU CLIENT
                '==================================================
'                    pr ("<tr><td colspan=2 class=""smallheader"" >")
'                        pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
'                            pr ("<tr class=""smallheader"">")
'                            pr ("<td width=""50%"" background=""" & Session("candidat_EcomPathImages") & "entete_bg.gif"">&nbsp;</td>")
'                            pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete1.gif""></td>")
'                            pr ("<td align=""right"" background=""" & Session("candidat_EcomPathImages") & "entete2.gif"">" & translate("Informations de connexion au site") & "&nbsp; ")
'                            pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete3.gif""></td></tr>")
'                            pr ("<tr height=""10""><td colspan=""4"">")
'                            pr ("<img src=""" & Session("candidat_EcomPathImages") & "transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
'                        pr ("</table>")
'                    pr ("</td></tr>")
'                    pr ("<tr><td class=""smalltext"">" & translate("Votre login") & ":</td>")
'                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""hidden"" name=""c_login"" value='" & c_Login & "' maxlength=16 size=20 class=""champ"">")
'                    pr ("<tr><td class=""smalltext"">" & translate("Mot de passe") & ":</td>")
'                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""hidden"" name=""c_passwd1"" value='" & c_passwd & "' maxlength=16 size=20 class=""champ"">")
'                    pr ("<tr><td class=""smalltext"">" & translate("Confirmez") & ":</td>")
'                    pr ("<td  class=""smalltext"">")
'                    pr ("<input type='password' name='c_passwd2' value='' maxlength=16 size=20 class=""champ""></tr>")
'                    pr ("<input type='hidden' name='passwd_client' value=''>")
'                    pr ("<tr><td colspan=2>&nbsp;</td></tr>")
''                Else
'                    pr ("<tr><td colspan=2>&nbsp;")
'                    pr ("<input type='hidden' name='c_login' value='" & Session("username") & "'>")
'                    pr ("<input type='hidden' name='c_passwd1' value='********'>")
'                    pr ("<input type='hidden' name='c_passwd2' value='********'>")
'                    pr ("</td></tr>")
'                End If
                
                
            ' COORDONNES DE LIVRAISON
            '========================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Vos coordonnées de Livraison") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr>")
                    pr ("<td colspan=""3"" align=""left""><span class='smallertext'><a href='javascript:recopie();'>")
                    pr ("<img src=""copiercoller.gif"" border=""0"" al=""" & translate("Recopier les informations personnelles") & """>&nbsp;&nbsp;" & translate("Recopier les informations personnelles") & "</a></span></td>")
                    pr ("<td>&nbsp;</td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' align=""right""><img src=""" & Session("candidat_EcomPathImages") & "cadeau.gif"" alt=""cadeau"">&nbsp;&nbsp;</td>")
'            pr ("<td width='74%'><input type='checkbox' value='1' name='l_kdo' class='champ'>" & translate("Cochez la case si cette commande est un cadeau") & "</td></tr>")
            pr ("<tr class='smalltext'>")
            
            
            pr ("<td width='26%'>" & translate("Soci&eacute;t&eacute;") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_societe' value='" & l_societe & "' maxlength=40  size=30 class='champ'></td></tr>")
            pr ("<tr class='smalltext'>")
            pr ("<td width='26%'>" & translate("B&eacute;n&eacute;ficiaire") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_beneficiaire' value='" & l_beneficiaire & "' maxlength=40  size=30 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_adresse' value='" & l_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
            pr ("<td width='74%'><input type='text' name='l_cp' value='" & l_cp & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville:") & "</td>")
            pr ("<td width='74%'><input type='text' name='l_ville' value='" & l_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Pays") & ":</td><td width='74%'>")
                        Sql = "select label_pays from t_pays where id_pays = " & Session("candidat_id_pays")
                        Set cur = Conn.Execute(Sql)
                            pr (cur("label_pays"))
                        Set cur = Nothing
            pr ("<input type='hidden' name='l_id_pays' value='" & Session("candidat_id_pays") & "'></td></tr>")
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' valign=""top"">" & translate("Message du cadeau") & ":</td>")
'            pr ("<td width='74%'><textarea name=""l_kdotxt"" cols=""40"" rows=""5"" wrap=""physical"" class=""champs"">&nbsp;</textarea></td></tr>")
            
            pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
              
'            'CONDITIONS GENERALES DE VENTES
'            '==============================
'            pr ("<tr class=""smallertext"">")
'            pr ("<td>&nbsp;</td>")
'            pr ("<td>")
'            pr ("<input type='checkbox' name='accepte'>&nbsp;" & translate("J'accepte les") & "<a href='" & GetDefault("EcomPathCGV", "../portal_ecom/commander/conditions/conditions.html") & "' target='_blank'>")
'            pr (translate("conditions générales de vente") & "</a>&nbsp;")
'            pr ("</td></tr>")
            
            'pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
            
            pr ("</table>")
        
            'VALIDATION & COMMANDER
            '======================
        pr ("<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        pr ("<td align=""right""><a href='javascript:valide();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
         If val(Request("Id")) <> "0" Then
         Session("NumIndiveClient") = Request("Id")
                       pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLIUser&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_User.jpeg"" border=""0""></a>")
                      pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
                Else
                    If val("" & id_client) <> 0 Then
                    Session("NumIndiveClient") = id_client
                    Session("id_client") = id_client
                            pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLIUser&Id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_User.jpeg"" border=""0""></a>")
                        pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&Id=" & id_client & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
                    End If
                End If
       
         pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLI'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>")
        pr ("</tr></table></form>")
            
            'INFORMATIONS LEGALES
            '====================
        pr ("<table border=""0"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""smallertext""><tr>")
        pr ("<td align=""left"">")
        pr ("Les informations qui vous concernent sont destinées à Encelade. Elles ne seront pas transmises à des tiers.")
        pr ("Vous disposez d'un droit d'accès, de modification, de rectification et de suppression des données qui vous concernent (art. 34 de la loi Informatique et Libertés)" & ".")
        pr ("Pour l'exercer, contactez-nous à" & " <a href=""mailto:" & GetDefault("EcomEmailContact", "contact@euxia.net", Session("candidat_ADOContact")) & """>" & Session("EcomEmailContact") & "</a></td>")
        pr ("</tr></table>")
        
        
    Conn.Close
    Set Conn = Nothing
    
End Function
Public Function Ecom_ValiderCommande4(DSN, Id_Caddie As String) As Boolean
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    pr "<script language='javascript'>"
    

pr "function recopie()"
pr ""
pr "{"
pr "    var f = document.form_etape4;"
pr ""
pr "    var id_pays = f.OptionPays.options[f.OptionPays.selectedIndex].value;"
pr "    var existe = false;"
pr "    var index = -1;"
pr "    f.l_beneficiaire.value = f.c_nom.value + "" "" + f.c_prenom.value;"
pr "    f.l_adresse.value = f.c_adresse.value;"
pr "    f.l_cp.value = f.c_codepostal.value;"
pr "    f.l_ville.value = f.c_ville.value;"
pr "    f.l_societe.value = f.c_societe.value;"
pr "}"

pr "function valide_4()"
pr "{"
pr "    var f = document.form_etape4;"
pr "    var ret = true;"
pr "    var err = """ & GetMessage("ErreursApparues", "Les erreurs suivantes sont apparues:", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
pr "    "
'pr "    if (f.c_nom.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomEstVide", "\nVotre nom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_prenom.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PreNomEstVide", "\nVotre prénom est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_adresse.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("AdressePersonnelleVide", "\nVotre adresse personnelle est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_codepostal.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_ville.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomVotreVilleVide", "\nLe nom de votre ville est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysVotreAdressePersonnelleIncorrect", "\nLe Pays de votre adresse personnelle est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.c_codepostal.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "       err += """ & GetMessage("CodePostalPersonnelVide", "\nVotre code postal personnel est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    "
'pr "    if (f.l_beneficiaire.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomBeneficiaireVide", "\nLe nom du bénéficiaire est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.l_cp.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("CodePostalLivraisionVide", "\nLe code postal de livraision est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
''pr "    }"
'pr "    if (f.l_ville.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("NomVilleLivraisonVide", "\nLe nom de la ville de livraison est vide", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_id_pays.options.selectedIndex<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("PaysAdresseLivraisonIncorrect", "\nLe Pays de l'adresse de livraison est incorrect", DsnTableMenu(Session("candidat_ADOContact"))) & """;"
'pr "    }"
'pr "    if (f.c_phone.value.length<1)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += ""\nVotre T&eacute;l&eacute;phone est vide"";"
'pr "    }"
'pr "/*  if (!f.accepte.checked)"
'pr "    {"
'pr "        ret = false;"
'pr "        err += """ & GetMessage("VousAvezPasAccepteConditionsGeneralesVente", "\nVous n'avez pas accepté les conditions générales de vente", DsnTableMenu(Session("candidat_ADOContact"))) & """"
'pr "    }"
'pr "*/"
pr "    if (f.c_passwd1.value.length>1)"
pr "    {"
pr "        if (f.c_login.value.length<1)"
pr "        {"
pr "            ret = false;"
pr "            err += ""\nVotre login est vide"";"
pr "        }"
pr "        if (f.c_passwd1.value!=f.c_passwd2.value)"
pr "        {"
pr "        ret = false;"
pr "        err += ""\nVos mots de passe ne sont pas identiques"";"
pr "        }"
pr "    }"
pr "    else"
pr "    {"
pr "        err += ""\nVotre mot de passe est vide"";"
pr "    }"
pr "    if (ret)"
pr "    {"
pr "//      alert(""ok"");"
pr "        f.submit();"
pr "    }"
pr "    else"
pr "    {"
pr "        alert(err);"
pr "    }"
pr ""
pr "}"
pr "</script>"
    'Vérification du login & mot de passe
    
   If Session("UserAcheter") <> 1 Then
   Sql = "UPDATE T_NumCadi SET T_NumCadi.DateMiseaDisposition = Now() "
    Sql = Sql & "WHERE T_NumCadi.id=" & Session("candidat_id_caddy") & ";"
    Session("Message_Caddy") = "Votre panier a bien été validé.<br> Veuillez prendre contact avec votre acheteur <br> Pour le suivi de votre commande."

Conn.Execute Sql
    Session("candidat_caddy_etape") = "Ecom_ValiderCommande5"
    Session("candidat_num_id_caddy") = ""
            Session("candidat_id_caddy") = ""
            If Trim("" & Session("Id_Caddie_CadiDefault")) = Trim("" & Id_Caddie) Then
                Session("Id_Caddie_CadiDefault") = ""
            End If
    Response.Redirect "Contact.asp?mode=Candidat_caddy&Id_Caddie=" & Session("candidat_id_caddy")
   Else
   
   
        Sql = "SELECT users.UserID, users.NumIndiveClient,users.FirstName, users.Password, users.UserType "
        Sql = Sql & "From users "
        Sql = Sql & "WHERE users.UserLogin='" & Request("c_login") & "' "
        Sql = Sql & "AND  "
        Sql = Sql & "users.UserEmailPass='" & Request("c_password") & "' "
        Sql = Sql & " AND users.Listerouge=false "

'        Sql = Sql & " WHERE UserLogin='" & Request("c_login") & "' "
'        Sql = Sql & " AND UserEmailPass='" & Request("c_password") & "'"
    If Session("PassOk") = "" Then
        Set Rs = Conn.Execute(Sql)
        If Not Rs.BOF Then
            Session("HisoriqueCLI") = "Contact.asp?mode=HISTORIQUE_Compte&ID=" & Rs!UserID
            Session("FactureCLI") = "Contact.asp?mode=HISTORIQUE_Compte&ID=" & Rs!UserID & "&ModeFacture=OK"
            Session("username") = Rs("FirstName")
            Session("UserId") = Rs("UserID")
            Session("NumIndiveClient") = "" & Rs("NumIndiveClient")
            is_client = -1
            Session("NewUser") = 0
            Session("PassOk") = "OK"
        Else
            Session("candidat_caddy_etape") = 3
            Response.Redirect ("Contact.asp?mode=CANDIDAT_CADDYREMPLI&etape=3&err=1")
        
            Exit Function
        End If
   End If

 
'            If Session("username") <> "guest" And Session("UserId") <> "" Then 'deb
               
                Sql = "SELECT UserId FROM users WHERE  UserId = " & Session("UserId")
                Set cur = Conn.Execute(Sql)
                a = cur.EOF
                b = cur.BOF
                If Not cur.EOF Then
                    id_client = cur(0)
                    Set cur = Nothing
                    Sql = "SELECT c.LastName, "     '0
                    Sql = Sql & " c.FirstName, "    '1
                    Sql = Sql & " c.Address, "      '2
                    Sql = Sql & " c.Zip, "          '3
                    Sql = Sql & " c.City, "         '4
                    Sql = Sql & " c.id_pays, "      '5
                    Sql = Sql & " p.label_pays, "   '6
                    Sql = Sql & " c.Email, "        '7
                    Sql = Sql & " c.id_livraison, " '8
                    Sql = Sql & " c.fld2, "         '9 - numéro FNA"
                    Sql = Sql & " c.fld3, "          '10 - societe
'                    Sql = Sql & " c.Portable,"      '11
                    Sql = Sql & " c.phone,"         '11
                    Sql = Sql & " c.Fax"            '12
'                    Sql = Sql & " c.Fax"            '12
                    Sql = Sql & " FROM  t_R_Social c, t_pays p "
                    Sql = Sql & " WHERE p.id_pays = c.id_pays "
                    Sql = Sql & " And c.SocieteId = " & id_client
                    
                    
                    Sql = "SELECT c.LastName,  "
                    Sql = Sql & "c.FirstName,  "
                    Sql = Sql & "c.Address,  "
                    Sql = Sql & "c.Zip,  "
                    Sql = Sql & "c.City,  "
                    Sql = Sql & "c.id_pays,  "
                    Sql = Sql & "p.label_pays,  "
                    Sql = Sql & "c.Email,  "
                    Sql = Sql & "Users_1.UserEmailPass,  "
                    Sql = Sql & "c.id_livraison,  "
                    Sql = Sql & "c.fld2, c.fld3,  "
                    Sql = Sql & "c.phone,  "
                    Sql = Sql & "c.fax,  "
                    Sql = Sql & "c.SocieteId,  "
                    Sql = Sql & "c.Id_Contact,  "
                    Sql = Sql & "Users.LastName AS DemName,  "
                    Sql = Sql & "Users.FirstName AS DemPnom,  "
                    Sql = Sql & "Users.UserEMail AS DemEmeal,  "
                    Sql = Sql & "Users.UserEmailPass AS  "
                    Sql = Sql & "demPassWord "
                    Sql = Sql & "FROM t_pays AS p,  "
                    Sql = Sql & "(Users INNER JOIN t_R_Social AS c  "
                    Sql = Sql & "ON Users.Id_Societes = c.SocieteId) INNER JOIN Users AS Users_1  "
                    Sql = Sql & "ON c.Id_Contact = Users_1.UserID "
                    Sql = Sql & "WHERE p.id_pays=[c].[id_pays]  "
                    Sql = Sql & "AND Users.UserID= " & id_client & ";"

                    Sql = "SELECT c.LastName,  "
                    Sql = Sql & "c.FirstName,  "
                    Sql = Sql & "c.Address,  "
                    Sql = Sql & "c.Zip,  "
                    Sql = Sql & "c.City,  "
                    Sql = Sql & "c.id_pays,  "
                    Sql = Sql & "p.label_pays,  "
                    Sql = Sql & "c.Email,  "
                    Sql = Sql & "Users_1.UserEmailPass,  "
                    Sql = Sql & "c.id_livraison,  "
                    Sql = Sql & "c.fld2,  "
                    Sql = Sql & "c.fld3,  "
                    Sql = Sql & "c.phone,  "
                    Sql = Sql & "c.fax,  "
                    Sql = Sql & "c.SocieteId,  "
                    Sql = Sql & "c.Id_Contact,  "
                    Sql = Sql & "Users_1.phone AS cu_phone,  "
                    Sql = Sql & "Users_1.Portable AS cu_Portable,  "
                    Sql = Sql & "Users_1.fax AS cu_fax,  "
                    Sql = Sql & "Users.LastName AS DemName,  "
                    Sql = Sql & "Users.FirstName AS DemPnom,  "
                    Sql = Sql & "Users.UserEMail AS DemEmeal,  "
                    Sql = Sql & "Users.phone AS d_phone,  "
                    Sql = Sql & "Users.Portable AS d_Portable,  "
                    Sql = Sql & "Users.fax AS d_fax,  "
                    Sql = Sql & "Users.UserEmailPass AS demPassWord "
                    Sql = Sql & "FROM t_pays AS p, (t_R_Social AS c INNER JOIN  "
                    Sql = Sql & "Users AS Users_1 ON c.Id_Contact = Users_1.UserID)  "
                    Sql = Sql & "INNER JOIN Users ON c.SocieteId = Users.Id_Societes "
                    Sql = Sql & "WHERE p.id_pays=[c].[id_pays]  "
                     Sql = Sql & "AND Users.UserID= " & id_client & ";"

                    
                    
                    
                    
                    Set cur = Conn.Execute(Sql)
                        If Not cur.BOF Then
                        
                        
                        Session("NewUser") = 0
                            c_nom = Trim("" & cur(0))
                            c_prenom = Trim("" & cur(1))
                            c_adresse = Trim("" & cur(2))
                            c_codepostal = Trim("" & cur(3))
                            c_ville = Trim("" & cur(4))
                            c_id_pays = cur(5)
                            c_pays = cur(6)
                            c_email = Trim("" & cur(7))
                            c_Pass = Trim("" & cur(8))
                            c_numfna = Trim("" & cur(9))
                             c_societe = Trim("" & cur(11))
                             c_phone = Trim("" & cur(12))
'                             c_Portable = Trim("" & cur(12))
                             c_fax = Trim("" & cur(13))
                             c_Id_User = val(Trim("" & cur(14)))
                            If cur(9) = "" Or IsEmpty(cur(9)) Then
                                id_livraison = 0
                            Else
                                id_livraison = cur(9)
                            End If
                            cu_phone = Trim("" & cur(16))
                            cu_Portable = Trim("" & cur(17))
                            cu_Fax = Trim("" & cur(18))
                            
                            d_Name = Trim("" & cur(19))
                             d_P_Name = Trim("" & cur(20))
                            d_mail = Trim("" & cur(21))
                           
                            d_phone = Trim("" & cur(22))
                            d_Portable = Trim("" & cur(23))
                            d_Fax = Trim("" & cur(24))
                             d_Pass = Trim("" & cur(25))
                             c_NumIndiveClient = Format(cur!SocieteId, "000#")
                        End If
                        If Trim("" & cu_phone) = "" Then cu_phone = c_phone
                        If Trim("" & d_phone) = "" Then d_phone = c_phone
                        If Trim("" & cu_Fax) = "" Then cu_Fax = c_fax
                        If Trim("" & d_Fax) = "" Then d_Fax = c_fax
'                        If Trim("" & d_fax) = "" Then d_fax = c_fax
                    Set cur = Nothing

                    Sql = "select l.beneficiare_liv, "
                  
                    Sql = Sql & " l.adresse_liv, "
                    Sql = Sql & " l.cp_liv, "
                    Sql = Sql & " l.ville_liv, "
                    Sql = Sql & " l.id_pays, "
                    Sql = Sql & " p.label_pays "
                      Sql = Sql & ", l.Societe "
                    Sql = Sql & " from  t_livraison l, t_pays p "
                    Sql = Sql & " where l.id_livraison = " & id_livraison
                    Sql = Sql & " and   p.id_pays = l.id_pays"

                    Set cur = Conn.Execute(Sql)
                        If Not cur.BOF Then
                            
                            l_beneficiaire = cur(0)
                           
                            l_adresse = "" & cur(1)
                            l_cp = "" & cur(2)
                            l_ville = "" & cur(3)
                            l_id_pays = "" & cur(4)
                             l_societe = "" & cur(6)
                        End If
                
                    
                End If
                Set cur = Nothing
           
          
                        
'            If is_client > -1 Then
'            If Session("username") <> "guest" Then
'                If is_client = -1 Then
'                    Session("NewUser") = 1
'                Else
                    Session("NewUser") = 0
'                End If
                is_client = -1
                
'            Else
'                is_client = 0
'                Session("NewUser") = 1
'            End If
            
                pr ("<form name='form_etape" & Session("candidat_caddy_etape") & "' action='Contact.asp?mode=Ecom_Numcomade'?Id_Caddie= " & Id_Caddie & " method='post'>")
                etapesuivante = val("" & Session("candidat_caddy_etape")) + 1
                pr ("<input type='hidden' name='etape' value='" & etapesuivante & "'>")
                pr ("<input type='hidden' name='is_client' value='" & is_client & "'>")
                pr ("<input type='hidden' name='id_client' value='" & id_client & "'>")
                pr ("<input type='hidden' name='act' value='" & Request("act") & "'>")
                pr ("<input type='hidden' name='id_livraison' value='" & id_livraison & "'>")
                pr ("<input type='hidden' name='compte_client' value='" & Session("username") & "'>")
                pr ("<input type='hidden' name='modifie' value='0'>")
            
            pr ("<input type='hidden' name='Id_Caddie' value='" & Id_Caddie & "'>")
            'MESSAGE ERREUR EVENTUEL
            '=======================
        If Msg_Err <> "" Then pr ("<span class=""smalltext"">" & Msg_Err & "</span><br>")
        
        pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Adresse de Facturation ") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("N° Client") & ":</td>")
            
             pr ("<td width='74%'><input type='hidden' name='NumIndiveClient' value='" & c_NumIndiveClient & "'><input type='text' disabled  name='' value='" & c_NumIndiveClient & "' maxlength=40  size=20 class='champ'></td></tr>")
              pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_societe' value='" & c_societe & "' ><input type='text' disabled  name='' value='" & c_societe & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_adresse' value='" & c_adresse & "'><input type='text' disabled  name='' value='" & c_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_codepostal' value='" & c_codepostal & "'><input type='text' disabled  name='' value='" & c_codepostal & "' maxlength=10  size=10 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_ville' value='" & c_ville & "'><input type='text' disabled  name='' value='" & c_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td hidden='26%'>" & translate("Pays") & ":</td>")
'
              pr ("<td width='74%'>")
            pr ("<select name='OptionPays' class='champ' disabled >")
                pr ("<option value='' selected >[" & translate("Choisissez") & "]")

                        Sql = "select id_pays, label_pays from t_pays where livrable = 1 order by 2"
                        Set cur = Conn.Execute(Sql)
                        While Not cur.EOF
                            pr ("<option value=" & cur(0))
                                If (CInt(l_id_pays) = CInt(cur(0))) Or (CInt(Session("candidat_id_pays")) = CInt(cur(0))) Then
                                    pr ("SELECTED")
                                End If
                                pr (" >" & cur(1))
                            cur.MoveNext
                        Wend
                        Set cur = Nothing
                        pr ("</select><input type='hidden' name='c_id_pays' value='" & c_id_pays & "'></td></tr>")
                    pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_phone' value='" & c_phone & "'><input type='text' disabled  name='' value='" & c_phone & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_Fax' value='" & c_fax & "'><input type='text' disabled  name='' value='" & c_fax & "' maxlength=40  size=20 class='champ'></td></tr>")
               pr ("<tr><td colspan=2> &nbsp; </td></tr>")
               pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("coordonn&eacute;es du responsable") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
                        
                        
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Nom") & ":</td>")
             pr ("<td width='74%'><input type='hidden' name='c_nom' value='" & c_nom & "'><input type='text' disabled  name='' value='" & c_nom & "' maxlength=40  size=20 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Prénom") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='c_prenom' value='" & c_prenom & "'><input type='text' disabled  name='' value='" & c_prenom & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
'            pr ("<td width='74%'><input type='hidden' name='c_societe' value='" & c_societe & "'><input type='text' disabled  name='' value='" & c_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
                                    
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='cu_phone' value='" & cu_phone & "'><input type='text' disabled  name='' value='" & cu_phone & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='cu_fax' value='" & cu_Fax & "'><input type='text' disabled  name='' value='" & cu_Fax & "' maxlength=40  size=20 class='champ'></td></tr>")
            
           
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("E-Mail") & ":</td>")
            If c_Id_User = id_client Then
                pr ("<td width='74%'><input type='text' name='c_email' value='" & c_email & "' maxlength=60 size=20 class='champ'></td></tr>")
            Else
                 pr ("<td width='74%'><input type='hidden' name='c_email' value='" & c_email & "'><input type='text' disabled  name='' value='" & c_email & "' maxlength=60  size=20 class='champ'></td></tr>")
'                pr ("<td width='74%'><input type='text' disabled  name='c_email' value='" & c_email & "' maxlength=60 size=20 class='champ'></td></tr>")
            End If
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Pass word") & ":</td>")
            If c_Id_User = id_client Then
            pr ("<td width='74%'><input type='text' name='c_Pass' value='" & c_Pass & "' maxlength=60 size=20 class='champ'></td></tr>")
            Else
            pr ("<td width='74%'><input type='hidden' name='c_Pass' value='" & c_Pass & "'><input type='password' disabled name='' value='" & c_Pass & "' maxlength=60 size=20 class='champ'></td></tr>")
            End If
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           


'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
pr "<input type='hidden' name='c_Id_User' value='" & c_Id_User & "'>"
If c_Id_User <> id_client Then
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("coordonn&eacute;es du demandeur") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
                        

            pr ("<tr class='smalltext'><td width='26%'>" & translate("Nom") & ":</td>")
             pr ("<td width='74%'><input type='hidden' name='d_Name' value='" & d_Name & "'><input type='text' disabled  name='' value='" & d_Name & "' maxlength=40  size=20 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Prénom") & ":</td>")
            pr ("<td width='74%'><input type='hidden' name='d_P_Name' value='" & d_P_Name & "'><input type='text' disabled  name='' value='" & d_P_Name & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
'            pr ("<td width='74%'><input type='hidden' name='c_societe' value='" & c_societe & "'><input type='text' disabled  name='' value='" & c_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
                                    
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Téléphone") & ":</td>")
            pr ("<td width='74%'><input type='text'   name='d_phone' value='" & d_phone & "' maxlength=40  size=20 class='champ'></td></tr>")
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Portable") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_Portable' value='" & c_Portable & "' maxlength=40  size=20 class='champ'></td></tr>")
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Fax") & ":</td>")
            pr ("<td width='74%'><input type='text'   name='d_Fax' value='" & d_Fax & "' maxlength=40  size=20 class='champ'></td></tr>")
            
           
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("E-Mail") & ":</td>")
            pr ("<td width='74%'><input type='text' name='d_Mail' value='" & d_mail & "' maxlength=60 size=20 class='champ'></td></tr>")
            
            pr ("<tr class='smalltext'><td width='26%'>" & translate("Pass word") & ":</td>")
            pr ("<td width='74%'><input type='text' name='d_Pass' value='" & d_Pass & "' maxlength=60 size=20 class='champ'></td></tr>")
            
'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
'            pr ("<tr><td colspan=2> &nbsp; </td></tr>")


'            pr ("<tr class='smalltext'><td width='26%'>" & translate("Numéro FNA") & ":</td>")
'            pr ("<td width='74%'><input type='text' name='c_NumFNA' value='" & c_numfna & "' maxlength=60 size=20 class='champ'></td></tr>")
           
End If
'c_Pass
                If Request("act") = "devenirclient" Then
                'DONNE LOGIN ET MOT DE PASSE POUR LE NOUVEAU CLIENT
                '==================================================
                    pr ("<tr><td colspan=2 class=""smallheader"" >")
                        pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                            pr ("<tr class=""smallheader"">")
                            pr ("<td width=""50%"" background=""" & Session("candidat_EcomPathImages") & "entete_bg.gif"">&nbsp;</td>")
                            pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete1.gif""></td>")
                            pr ("<td align=""right"" background=""" & Session("candidat_EcomPathImages") & "entete2.gif"">" & translate("Informations de connexion au site") & "&nbsp; ")
                            pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""" & Session("candidat_EcomPathImages") & "entete3.gif""></td></tr>")
                            pr ("<tr height=""10""><td colspan=""4"">")
                            pr ("<img src=""" & Session("candidat_EcomPathImages") & "transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                        pr ("</table>")
                    pr ("</td></tr>")
                    pr ("<tr><td class=""smalltext"">" & translate("Votre login") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""text"" name=""c_login"" value="""" maxlength=16 size=20 class=""champ""></tr>")
                    pr ("<tr><td class=""smalltext"">" & translate("Mot de passe") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type=""password"" name=""c_passwd1"" value="""" maxlength=16 size=20 class=""champ""></tr>")
                    pr ("<tr><td class=""smalltext"">" & translate("Confirmez") & ":</td>")
                    pr ("<td  class=""smalltext"">")
                    pr ("<input type='password' name='c_passwd2' value='' maxlength=16 size=20 class=""champ""></tr>")
                    pr ("<input type='hidden' name='passwd_client' value=''>")
                    pr ("<tr><td colspan=2>&nbsp;</td></tr>")
                Else
                    pr ("<tr><td colspan=2>&nbsp;")
                    pr ("<input type='hidden' name='c_login' value='" & Session("username") & "'>")
                    pr ("<input type='hidden' name='c_passwd1' value='********'>")
                    pr ("<input type='hidden' name='c_passwd2' value='********'>")
                    pr ("</td></tr>")
                End If
                
                
            ' COORDONNES DE LIVRAISON
            '========================
            
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Coordonn&eacute;es de Livraison") & "&nbsp; ")
                   pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
                    
                    If c_Id_User <> id_client Then
                    pr ("<tr>")
                    pr ("<td colspan=""3"" align=""left""><span class='smallertext'><a href='javascript:recopie();'>")
                        pr ("<tr class='smalltext'>")
                        pr ("<td width='26%'>" & translate("Bénéficiaire") & ":</td>")
                        pr ("<td width='74%'><input type='hidden' name='l_beneficiaire' value='" & l_beneficiaire & "'><input type='text'  & disabled  name='' value='" & l_beneficiaire & "' maxlength=40  size=30 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
                        pr ("<td width='74%'><input type='hidden' name='l_societe' value='" & l_societe & "'><input type='text'  disabled  name='' value='" & l_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
                        pr ("<td width='74%'><input type='hidden' name='l_adresse' value='" & l_adresse & "'><input type='text'  disabled   name='' value='" & l_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
                        pr ("<td width='74%'><input type='hidden' name='l_cp' value='" & l_cp & "'><input type='text'  disabled   name='' value='" & l_cp & "' maxlength=10  size=10 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville:") & "</td>")
                        pr ("<td width='74%'><input type='hidden' name='l_ville' value='" & l_ville & "'><input type='text'  disabled   name='' value='" & l_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Pays") & ":</td><td width='74%'>")
                                    Sql = "select label_pays from t_pays where id_pays = " & Session("candidat_id_pays")
                                    Set cur = Conn.Execute(Sql)
                                        pr (cur("label_pays"))
                                    Set cur = Nothing
                        pr ("<input type='hidden' name='l_id_pays' value='" & Session("candidat_id_pays") & "'></td></tr>")
                    Else
                       pr ("<tr>")
                    pr ("<td colspan=""3"" align=""left""><span class='smallertext'><a href='javascript:recopie();'>")
                        pr ("<img src=""copiercoller.gif"" border=""0"" al=""" & translate("Recopier les informations personnelles") & """>&nbsp;&nbsp;" & translate("Recopier les informations personnelles") & "</a></span></td>")
                        pr ("<tr class='smalltext'>")
                        pr ("<td width='26%'>" & translate("Bénéficiaire") & ":</td>")
                        pr ("<td width='74%'><input type='text' " & disabled & " name='l_beneficiaire' value='" & l_beneficiaire & "' maxlength=40  size=30 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Société") & ":</td>")
                        pr ("<td width='74%'><input type='text'   name='l_societe' value='" & l_societe & "' maxlength=40  size=20 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Adresse") & ":</td>")
                        pr ("<td width='74%'><input type='text'   name='l_adresse' value='" & l_adresse & "' maxlength=150  size=50 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("CP") & ":</td>")
                        pr ("<td width='74%'><input type='text'   name='l_cp' value='" & l_cp & "' maxlength=10  size=10 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Ville:") & "</td>")
                        pr ("<td width='74%'><input type='text'   name='l_ville' value='" & l_ville & "' maxlength=60  size=20 class='champ'></td></tr>")
                        pr ("<tr class='smalltext'><td width='26%'>" & translate("Pays") & ":</td><td width='74%'>")
                        Sql = "select label_pays from t_pays where id_pays = " & Session("candidat_id_pays")
                        Set cur = Conn.Execute(Sql)
                            pr (cur("label_pays"))
                        Set cur = Nothing
                        pr ("<input type='hidden' name='l_id_pays' value='" & Session("candidat_id_pays") & "'></td></tr>")
                    End If
                    pr ("<td>&nbsp;</td></tr>")
                pr ("</table>")
            pr ("</td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' align=""right""><img src=""" & Session("candidat_EcomPathImages") & "cadeau.gif"" alt=""cadeau"">&nbsp;&nbsp;</td>")
'            pr ("<td width='74%'><input type='checkbox' value='1' name='l_kdo' class='champ'>" & translate("Cochez la case si cette commande est un cadeau") & "</td></tr>")
            
            pr ("<tr><td colspan=2> &nbsp; </td></tr>")
'            pr ("<tr class='smalltext'>")
'            pr ("<td width='26%' valign=""top"">" & translate("Message du cadeau") & ":</td>")
'            pr ("<td width='74%'><textarea name=""l_kdotxt"" cols=""40"" rows=""5"" wrap=""physical"" class=""champs"">&nbsp;</textarea></td></tr>")
            
            pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
              
'            'CONDITIONS GENERALES DE VENTES
'            '==============================
'            pr ("<tr class=""smallertext"">")
'            pr ("<td>&nbsp;</td>")
'            pr ("<td>")
'            pr ("<input type='checkbox' name='accepte'>&nbsp;" & translate("J'accepte les") & "<a href='" & GetDefault("EcomPathCGV", "../portal_ecom/commander/conditions/conditions.html") & "' target='_blank'>")
'            pr (translate("conditions générales de vente") & "</a>&nbsp;")
'            pr ("</td></tr>")
            
            'pr ("<tr><td colspan=""2"">" & ImgTransparent(1, 30) & "</td><tr>")
            
            pr ("</table>")
        
            'VALIDATION & COMMANDER
            '======================
        pr ("<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        pr ("<td align=""right""><a href='javascript:valide_" & Session("candidat_caddy_etape") & "();'><img src=""" & Session("candidat_EcomPathImages") & "poursuivrelacommande.gif"" border=""0""></a></td>")
        pr ("</tr></table></form>")
            
            'INFORMATIONS LEGALES
            '====================
        pr ("<table border=""0"" width=""100%"" cellpadding=""2"" cellspacing=""0"" class=""smallertext""><tr>")
        pr ("<td align=""left"">")
        pr ("Les informations qui vous concernent sont destinées à Encelade. Elles ne seront pas transmises à des tiers.")
        pr ("Vous disposez d'un droit d'accès, de modification, de rectification et de suppression des données qui vous concernent (art. 34 de la loi Informatique et Libertés)" & ".")
        pr ("Pour l'exercer, contactez-nous à" & " <a href=""mailto:" & GetDefault("EcomEmailContact", "contact@euxia.net", Session("candidat_ADOContact")) & """>" & Session("EcomEmailContact") & "</a></td>")
        pr ("</tr></table>")
        
End If
    Conn.Close
    Set Conn = Nothing
    Ecom_ValiderCommande4 = True
End Function
Public Function CONFIGCLICOMPTE_TableauRecap_New()
        
        
        
       
      
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
         
        pr ("<center><table border=""0"" width=""100%"">")
            pr ("<tr><td class=""smallerheader"" colspan=""4"">")
            
                 pr ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">")
                pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("N° Commande")) & "</td>")
                pr ("<td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signiation")) & "</td>")
                pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Montant Initial T.T.C.")) & "</td>")
'                pr ("<td align='right' class=""TextTrEntete"" valign=""center"">" & ImgEnteteColonne(translate("Montant Consommé")) & "</td>")
'                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Solde")) & "</td>") '& "</td></tr>")
'                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Cloturer")) & "</td>")
''                Verouiller
'                pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("V&eacute;rouiller")) & "</td></tr>")
'                    '
       
'        pr ("<input type='hidden' name='etape' value='" & val("" & Session("candidat_caddy_etape")) + 1 & "'>")
'       pr ("<input type=""hidden"" name=""Com"" value='" & Request("Com") & "'>")
'       pr ("<input type=""hidden"" name=""IdAvoire"" value="""">")
'       If Request("Com") <> "" Then
'        pr ("<input type=""hidden"" name=""mode"" value=""VALIDERCOMMANDE"">")
'       Else
'        pr ("<input type=""hidden"" name=""mode"" value=""Ecom_NumcomadeValider"">")
'      End If
     
            
            
             TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                pr ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                      pr ("<td > ")
                      
                      pr ("<input type=""text""  name=""New_Num_Com"" size=""60""  value='' height=""1000"" width=""1"">")
                       
                        pr "</td>"
                        pr ("<td >")
                    pr ("<input type=""text""  name='Libelle' value='' size=""60""  height=""1000"" width=""1"">")
                   
'                        If Request("Com") = "" Then pr "</a>"
                        pr "</td>"
                  pr ("<td >")
'                    If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr ("<input type=""text""  name='New_Montantinitial' value='' size=""60"" height=""1000"" width=""1"">")
                   
'                        If Request("Com") = "" Then pr "</a>"
'                        pr "</td>"
'                     pr ("<td align='right'>")
''                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
'                    pr ("<input type=""text""  name='New_MontantCommande' value='' height=""1000"" width=""1"">")
'
''                        pr Trim(MontantCommande)
''                        If Request("Com") = "" Then pr "</a>"
'                        pr ("</td>")
'                     pr ("<td align='Centrer'>")
''                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
'                       pr ("<input type=""text""  name='New_Solde' value='' height=""1000"" width=""1"" locked='false'>")
''                        pr Trim(Solde)
''                        If Request("Com") = "" Then pr "</a>"
'                        pr ("</td>")
'
'                 pr "<TD><input type=""checkbox"" name='New_CloturerCommande' value='Non'  onClick='Clik_Check(this.document.frm.New_CloturerCommande);'>"
'
''                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
''                pr ("<input type=""CloturerCommande""  name=""CloturerCommande" & TDbg & """ value='Non' height=""1000"" width='1' " & CloturerCommande & " >")
''                        pr CloturerCommande
''                        If Request("Com") = "" Then pr "</a>"
'                        pr "</TD>"
'                 pr "<TD><input type=""checkbox"" name='New_Verouiller' value='Non' onClick='Clik_Check(this.document.frm.New_Verouiller);')>"
''                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
'                        pr Verouiller
''                        If Request("Com") = "" Then pr "</a>"
'                        pr "</TD>"
                 'Verouiller
               
'                     pr ("<td align='right'>" & Trim(Solde) & "</td>")

'
           
        
               
'            pr ("<input type=""hidden"" name='NbCom' value='" & TDbg & "'></table>")
       
          TDbg = 0
          
        
    
     pr "</td></tr></table>"
    
'If Request("Com") <> "" Then
'' pr "<BR><br>"
'     mage = "etape2.gif"
'            Text = translate("Commande finale")
'pr (ImgTitreEcommerce(Text))
'
''pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
''pr ("<br><br>" & Text & " <br><br>")
''pr ("------------------------------------------------------<br>")
''pr ("</td></tr>")
''
''pr ("<tr><td>")
'
'            Call Ecom_NumCommandeValiderCommande(DSN)
'            End If
  
End Function

Public Function CONFIGCLICOMPTE_TableauRecap(DSN)
        pr ("<script language=javascript>")
'        pr ("function Valide_num_commande(ID,num_commande,chk,Verou){")
'        pr ("com=eval([this.document.frm.Com]);" & vbCrLf)
'        pr ("if(chk.value=='Checked'){" & vbCrLf)
'                pr ("alert('La commande N° '+ num_commande + ' est cloturer') ;" & vbCrLf)
'                pr ("} else { " & vbCrLf)
'                pr ("if(Verou.value=='OUI'){" & vbCrLf)
'                    pr ("alert('La commande N° '+ num_commande + ' est Verrouiller') ;" & vbCrLf)
'                    pr ("} else { " & vbCrLf)
'                    pr ("this.document.frm.Com.value=ID;")
''                    pr ("alert(this.document.frm.Com.value);")
'                    pr ("this.document.frm.submit();")
'                pr ("}")
'            pr ("}")
'        pr ("}")
        
        pr ("function Clik_Check(chk){" & vbCrLf)
        pr ("if(chk.value=='CHECKED'){" & vbCrLf)
        pr ("chk.value='';" & vbCrLf)
        pr ("} else { " & vbCrLf)
        pr ("chk.value='CHECKED';" & vbCrLf)
        pr ("}")
'        pr ("alert(chk.value);")
        pr ("}")
        pr ("</script >")
        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
       
       
        Sql = " SELECT T_Num_Commande.IdNumCommande,T_Num_Commande.NumCommande, T_Num_Commande.Montantinitial, T_Num_Commande.MontantCommande, [Montantinitial]-[MontantCommande] AS Solde, T_Num_Commande.CloturerCommande ,T_Num_Commande.Verouiller,T_Num_Commande.Libelle "
        Sql = Sql & "From T_Num_Commande "
        Sql = Sql & "WHERE T_Num_Commande.UserID=" & Request("id")
        
        
        Sql = "SELECT T_Avoire.IdAvoire,T_Num_Commande.IdNumCommande,T_Num_Commande.NumCommande, T_Avoire.Credit,  "
        Sql = Sql & "T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Num_Commande.CloturerCommande,  "
        Sql = Sql & "T_Num_Commande.Verouiller,T_Num_Commande.Libelle "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire  "
        Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.IdSociete=" & Session("id_client") & " "
        Sql = Sql & "AND T_Avoire.Cloturer=False "
'        If Request("IdAvoire") <> "" Then
'             Sql = Sql & "AND T_Avoire.IdAvoire=" & Request("IdAvoire")
'        End If
        Sql = Sql & ";"
        
'        If Request("Com") <> "" Then
'            Sql = Sql & " AND T_Num_Commande.IdNumCommande=" & Request("Com")
'        End If
'        Sql = Sql & ";"

'        If Request("Com") <> "" Then
'            Sql = Sql & " AND T_Num_Commande.IdNumCommande=" & Request("Com")
'        End If
'        Sql = Sql & ";"

Debug.Print Sql

        Set cur = Conn.Execute(Sql)
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
        
        pr ("<center><table border=""0"" width=""100%"">")
            pr ("<tr><td class=""smallerheader"" colspan=""4"">")
          
                 pr ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">")
                 pr ("<tr class=""TrEntete"" valign=""center"">")
                 pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Suprimer")) & "</td>")
                  pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Confirmer")) & "</td>")
                pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("N° Commande")) & "</td>")
                pr ("<td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signiation")) & "</td>")
                pr ("<td  class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Cr&eacute;dit T.T.C.")) & "</td>")
                pr ("<td align='right' class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;bit T.T.C.")) & "</td>")
                pr ("<td class='TextTrEntete' valign='center' align='center'>" & ImgEnteteColonne(translate("Solde T.T.C.")) & "</td>") '& "</td></tr>")
                pr ("<td class='TextTrEntete' valign='center' align='center'>" & ImgEnteteColonne(translate("Clotur&eacute;e")) & "</td>")
'                Verouiller
                pr ("<td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("V&eacute;rouill&eacute;e")) & "</td></tr>")
                    '
       
'        pr ("<input type='hidden' name='etape' value='" & val("" & Session("candidat_caddy_etape")) + 1 & "'>")
'       pr ("<input type=""hidden"" name=""Com"" value='" & Request("Com") & "'>")
       pr ("<input type=""hidden"" name=""IdAvoire"" value="""">")
        pr ("<input type=""hidden"" name=""id"" value='" & Request("id") & "'>")
         
'       If Request("Com") <> "" Then
'        pr ("<input type=""hidden"" name=""mode"" value=""VALIDERCOMMANDE"">")
'       Else
'        pr ("<input type=""hidden"" name=""mode"" value=""Ecom_NumcomadeValider"">")
'      End If
      While Not cur.EOF
      
            NumCommande = "" & cur("NumCommande")
            Montantinitial = "" & cur("credit")
            MontantCommande = "" & cur("debit")
            Solde = "" & cur("Solde")
            IdAvoire = "" & cur("IdAvoire")
            Libelle = "" & cur("Libelle")
            If cur("CloturerCommande") = True Then
            
            txtChecked = "CHECKED"
            Else
            
            txtChecked = ""
            End If
            
            If cur("Verouiller") = True Then
            
            txtChecked2 = "CHECKED"
            Else
            
            txtChecked2 = ""
            End If
            
        
             TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                pr ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                                     pr "<TD><input type=""checkbox"" name=""Sup_" & TDbg & """ value='Non'  onClick='Clik_Check(this.document.frm.Sup_" & TDbg & ");'>"
                 
                        pr "</TD>"
                 pr "<TD><input type=""checkbox"" name=""Confirmer_" & TDbg & """ value='Non' onClick='Clik_Check(this.document.frm.Confirmer_" & TDbg & ");')>"
                       
                        pr "</TD>"

                      pr ("<td > <input type=""hidden"" name='Id_Com_" & TDbg & "' value='" & cur("IdNumCommande") & "'>")
                      pr "<input type=""hidden"" name='IdAvoire_" & TDbg & "' value='" & cur("IdAvoire") & "'>"
                      
                      pr ("<input type=""text""  name=""Num_Com_" & TDbg & """ value=""" & NumCommande & """ height=""1000"" width=""1"">")
                       
                        pr "</td>"
                  pr ("<td >")
                   pr ("<input type=""text""  name=""Libelle_" & TDbg & """ value=""" & Libelle & """ height=""1000"" width=""1"">")
                       
                        pr "</td>"
                   pr ("<td >")
                  
'                    If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr ("<input type=""text""  name=""Montantinitial_" & TDbg & """ value=""" & Montantinitial & """ height=""1000"" width=""1"">")
                   
'                        If Request("Com") = "" Then pr "</a>"
                        pr "</td>"
                     pr ("<td align='right'>")
'                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr ("<input type=""text"" disabled name=""MontantCommande_" & TDbg & """ value=""" & MontantCommande & """ height=""1000"" width=""1"">")
                   
'                        pr Trim(MontantCommande)
'                        If Request("Com") = "" Then pr "</a>"
                        pr ("</td>")
                     pr ("<td align='right'>")
'                        If Request("Com") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdNumCommande") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                       pr ("<input type=""text"" disabled name=""Solde_" & TDbg & """ value=""" & Solde & """ height=""1000"" width=""1"" locked='false'>")
'                        pr Trim(Solde)
'                        If Request("Com") = "" Then pr "</a>"
                        pr ("</td>")
                     
                 pr "<TD><input type=""checkbox"" name=""CloturerCommande_" & TDbg & """ value='OUI' " & txtChecked & ">" '  onClick='Clik_Check(this.document.frm.CloturerCommande_" & TDbg & ");' >"
                 
                        pr "</TD>"
                        pr "<TD><input type=""checkbox"" name=""Verouiller_" & TDbg & """  value='OUI' " & txtChecked2 & ">" '  onClick='Clik_Check(this.document.frm.Verouiller_" & TDbg & ");' >"
'                 pr "<TD><input type=""checkbox"" name=""Verouiller_" & TDbg & """ value='" & txtChecked & " onClick='Clik_Check(this.document.frm.Verouiller_" & TDbg & ");' >"
                       
                        pr "</TD>"
                  pr ("</tr>")
            cur.MoveNext
        Wend
        
               
            pr ("<input type=""hidden"" name='NbCom' value='" & TDbg & "'></table>")
       
          TDbg = 0
          
        
    Conn.Close
    Set Conn = Nothing
     pr "</td></tr></table>"
    
'If Request("Com") <> "" Then
'' pr "<BR><br>"
'     mage = "etape2.gif"
'            Text = translate("Commande finale")
'pr (ImgTitreEcommerce(Text))
'
''pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
''pr ("<br><br>" & Text & " <br><br>")
''pr ("------------------------------------------------------<br>")
''pr ("</td></tr>")
''
''pr ("<tr><td>")
'
'            Call Ecom_NumCommandeValiderCommande(DSN)
'            End If
  
End Function
Public Function Ecom_Numcomade_TableauRecap(DSN, Id_Caddie As String)
        pr ("<script language=javascript>")
        pr ("function Valide_num_commande(ID,num_commande,chk,Verou){")
'        pr ("com=eval([this.document.frm.Com]);" & vbCrLf)
        pr ("if(chk.value=='OUI'){" & vbCrLf)
                pr ("alert('La commande N° '+ num_commande + ' est cloturée') ;" & vbCrLf)
                pr ("} else { " & vbCrLf)
                pr ("if(Verou.value=='OUI'){" & vbCrLf)
                    pr ("alert('La commande N° '+ num_commande + ' est Verrouillée') ;" & vbCrLf)
                    pr ("} else { " & vbCrLf)
                    pr ("this.document.frm.IdAvoire.value=ID;")
'                    pr ("alert(this.document.frm.Com.value);")
                    pr ("this.document.frm.submit();")
                pr ("}")
            pr ("}")
        pr ("}")
        
        pr ("function Clik_Check(chk){" & vbCrLf)
        pr ("if(chk.value=='OUI'){" & vbCrLf)
        pr ("chk.value='NON';" & vbCrLf)
        pr ("} else { " & vbCrLf)
        pr ("chk.value='OUI';" & vbCrLf)
        pr ("}")
'        pr ("alert(chk.value);")
        pr ("}")
        pr ("</script >")
        Set Conn = Server.CreateObject("adodb.connection")
        Conn.Open DSN
        
       
       
        Sql = "SELECT T_Num_Commande.IdNumCommande,T_Num_Commande.NumCommande, T_Num_Commande.Montantinitial, T_Num_Commande.MontantCommande, [Montantinitial]-[MontantCommande] AS Solde, T_Num_Commande.CloturerCommande ,T_Num_Commande.Verouiller,T_Num_Commande.Libelle "
        Sql = Sql & "From T_Num_Commande "
        Sql = Sql & "WHERE T_Num_Commande.UserID=" & Session("id_client")
        If Request("Com") <> "" Then
            Sql = Sql & " AND T_Num_Commande.IdNumCommande=" & Request("Com")
        End If
        Sql = Sql & ";"

        Sql = "SELECT T_Avoire.IdAvoire, T_Num_Commande.NumCommande, T_Avoire.Credit,  "
        Sql = Sql & "T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Num_Commande.CloturerCommande,  "
        Sql = Sql & "T_Num_Commande.Verouiller,T_Num_Commande.Libelle "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire  "
        Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.IdSociete=" & Session("c_Id_User") & " "
        Sql = Sql & "AND T_Avoire.Cloturer=False "
        If Request("IdAvoire") <> "" Then
             Sql = Sql & "AND T_Avoire.IdAvoire=" & Request("IdAvoire")
        End If
        Sql = Sql & ";"
       

Debug.Print Sql

        Set cur = Conn.Execute(Sql)
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
        pr ("<center><table border=""0"" width=""100%"">")
            pr ("<tr><td class=""smallerheader"" colspan=""4"">")
            
                 pr ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">")
                 pr ("<tr class=""TrEntete"" valign=""top"">")
                pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("N° Commande")) & "</td>")
                  pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("D&eacute;signiation")) & "</td>")
                pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("Cr&eacute;dit T.T.C.")) & "</td>")
              
                  pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("D&eacute;bit T.T.C.")) & "</td>")
'                pr ("<td align='right' class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("Montant Consommé")) & "</td>")
                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Solde")) & "</td>") '& "</td></tr>")
                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Clotur&eacute;e")) & "</td>")
'                Verouiller
                pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("V&eacute;rouill&eacute;e")) & "</td></tr>")
                    '
       pr ("<form name=""frm"" method=""post"" action='Contact.asp'>")
       pr ("<input type='hidden' name='Comptoir' value=''>")
       pr ("<input type='hidden' name='Id_Caddie' value='" & Id_Caddie & "'>")
        pr ("<input type='hidden' name='etape' value='" & val("" & Session("candidat_caddy_etape")) + 1 & "'>")
       pr ("<input type=""hidden"" name=""IdAvoire"" value='" & Request("IdAvoire") & "'>")
'       pr ("<input type=""hidden"" name=""IdAvoire"" value="""">")
       If Request("IdAvoire") <> "" Then
        pr ("<input type=""hidden"" name=""mode"" value=""VALIDERCOMMANDE"">")
       Else
        pr ("<input type=""hidden"" name=""mode"" value=""Ecom_NumcomadeValider"">")
      End If
      While Not cur.EOF
      
            NumCommande = cur("NumCommande")
            Montantinitial = cur("Credit")
            MontantCommande = cur("Debit")
            Solde = cur("Solde")
            Libelle = "" & cur("Libelle")
            
             Montantinitial = FomatNum("" & Montantinitial, 3)
            MontantCommande = FomatNum("" & MontantCommande, 3)
            Solde = FomatNum("" & Solde, 3)
           
            
            If cur("CloturerCommande") = True Then
            CloturerCommande = "OUI"
            Else
            CloturerCommande = "NON"
            End If
            
            If cur("Verouiller") = True Then
            Verouiller = "OUI"
            Else
            Verouiller = "NON"
            End If
            
            
            TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                pr ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                      pr ("<td > <input type=""hidden"" name='Id_Com_" & TDbg & "' value="""">")
                      If Request("IdAvoire") = "" Then
                      pr ("<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">")
                      End If
                      pr (NumCommande)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</td>"
                         pr ("<td >")
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr Libelle
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</td>"
                        
                        
                  pr ("<td >")
                    If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr Montantinitial
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</td>"
                     pr ("<td align='right'>")
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Trim(MontantCommande)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr ("</td>")
                     pr ("<td align='right'>")
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Trim(Solde)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr ("</td>")
                     
                 pr "<TD><input type=""hidden"" name=""checkbox" & TDbg & """ value='" & CloturerCommande & "'>"
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr CloturerCommande
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</TD>"
                 pr "<TD><input type=""hidden"" name=""Verouiller" & TDbg & """ value='" & Verouiller & "'>"
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Verouiller
                        If Request("Com") = "" Then pr "</a>"
                        pr "</TD>"
                 'Verouiller
               
'                     pr ("<td align='right'>" & Trim(Solde) & "</td>")

'
                  pr ("</tr>")
            cur.MoveNext
        Wend
        
            pr ("<input type=""hidden"" name='NbCom' value='" & TDbg & "'></form></table>")
        pr ("")
          TDbg = 0
          
        
    Conn.Close
    Set Conn = Nothing
     pr "</td></tr></table>"
    
If Request("IdAvoire") <> "" Then
' pr "<BR><br>"
     mage = "etape2.gif"
            Text = translate("Commande finale")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
'pr ("</td></tr>")
'
'pr ("<tr><td>")

            Call Ecom_NumCommandeValiderCommande(DSN, Id_Caddie)

            End If
End Function

Public Function Hitorique_Numcomade_TableauRecap(DSN, Id_Caddie As String)
'        pr ("<script language=javascript>")
'        pr ("function Valide_num_commande(ID,num_commande,chk,Verou){")
''        pr ("com=eval([this.document.frm.Com]);" & vbCrLf)
'        pr ("if(chk.value=='OUI'){" & vbCrLf)
'                pr ("alert('La commande N° '+ num_commande + ' est cloturer') ;" & vbCrLf)
'                pr ("} else { " & vbCrLf)
'                pr ("if(Verou.value=='OUI'){" & vbCrLf)
'                    pr ("alert('La commande N° '+ num_commande + ' est Verrouiller') ;" & vbCrLf)
'                    pr ("} else { " & vbCrLf)
'                    pr ("this.document.frm.IdAvoire.value=ID;")
''                    pr ("alert(this.document.frm.Com.value);")
'                    pr ("this.document.frm.submit();")
'                pr ("}")
'            pr ("}")
'        pr ("}")
'
'        pr ("function Clik_Check(chk){" & vbCrLf)
'        pr ("if(chk.value=='OUI'){" & vbCrLf)
'        pr ("chk.value='NON';" & vbCrLf)
'        pr ("} else { " & vbCrLf)
'        pr ("chk.value='OUI';" & vbCrLf)
'        pr ("}")
''        pr ("alert(chk.value);")
'        pr ("}")
'        pr ("</script >")
        Set Conn = OpenDb(DSN.ConnectionString)
        
       
       
        Sql = "SELECT T_Num_Commande.IdNumCommande,T_Num_Commande.NumCommande, T_Num_Commande.Montantinitial, T_Num_Commande.MontantCommande, [Montantinitial]-[MontantCommande] AS Solde, T_Num_Commande.CloturerCommande ,T_Num_Commande.Verouiller "
        Sql = Sql & "From T_Num_Commande "
        Sql = Sql & "WHERE T_Num_Commande.UserID=" & Session("id_client")
        If Request("Com") <> "" Then
            Sql = Sql & " AND T_Num_Commande.IdNumCommande=" & Request("Com")
        End If
        Sql = Sql & ";"

        Sql = "SELECT Users.UserID, Users.FirstName, Users.LastName, T_Avoire.IdAvoire, T_Num_Commande.NumCommande, "
        Sql = Sql & "T_Avoire.Credit, T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Num_Commande.CloturerCommande, T_Num_Commande.Verouiller "
        Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) "
        Sql = Sql & "ON Users.UserID = T_Num_Commande.UserID "
        Sql = Sql & "WHERE T_Avoire.Cloturer=False;"

       

Debug.Print Sql

        Set cur = Conn.Execute(Sql)
        rien = 0
        cpt = 0
        'total = 0#
        'totalf = 0#
        
'        pr ("<center><table border=""0"" width=""100%"">")
'            pr ("<tr><td class=""smallerheader"" colspan=""4"">")
            
                 pr ("<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">")
                  pr ("<tr bgcolor=""" & GetDefault("bglsttr", "#E4D7C7", Session("candidat_ADOContact")) & """>")
                 pr ("<td class=""smallerheader"" nowrap><b>N° Commande</b></td>")
'                pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("N° Commande")) & "</td>")
        '        pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("Prix")) & "</td>")
        pr ("<td nowrap><b>Cr&eacute;di</b></td>")
'                pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("Cr&eacute;dit")) & "</td>")
                pr ("<td nowrap><b>D&eacute;bit T.T.C.</b></td>")
'                  pr ("<td  class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("D&eacute;bit T.T.C.")) & "</td>")
                  
'                pr ("<td align='right' class=""TextTrEntete"" valign=""top"">" & ImgEnteteColonne(translate("Montant Consommé")) & "</td>")
                pr ("<td nowrap><b>Solde T.T.C.</b></td>")
'                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Solde")) & "</td>") '& "</td></tr>")
                pr ("<td nowrap><b>Clotur&eacute;e</b></td>")
'                pr ("<td class='TextTrEntete' valign=""top"" valign=""center"">" & ImgEnteteColonne(translate("Cloturer")) & "</td>")
                pr ("<td nowrap><b>V&eacute;rouill&eacute;e</b></td>")
'                Verouiller
'                pr ("<td class=""TextTrEntete"" align='center' valign=""top"">" & ImgEnteteColonne(translate("V&eacute;rouiller")) & "</td></tr>")
                    '
       pr ("<form name=""frm"" method=""post"" action='Contact.asp'>")
       pr ("<input type='hidden' name='Comptoir' value=''>")
        pr ("<input type='hidden' name='etape' value='" & val("" & Session("candidat_caddy_etape")) + 1 & "'>")
       pr ("<input type=""hidden"" name=""IdAvoire"" value='" & Request("IdAvoire") & "'>")
'       pr ("<input type=""hidden"" name=""IdAvoire"" value="""">")
       If Request("IdAvoire") <> "" Then
        pr ("<input type=""hidden"" name=""mode"" value=""VALIDERCOMMANDE"">")
       Else
        pr ("<input type=""hidden"" name=""mode"" value=""Ecom_NumcomadeValider"">")
      End If
      While Not cur.EOF
      
            NumCommande = cur("NumCommande")
            Montantinitial = cur("Credit")
            MontantCommande = cur("Debit")
            Solde = cur("Solde")
            
            If cur("CloturerCommande") = True Then
            CloturerCommande = "OUI"
            Else
            CloturerCommande = "NON"
            End If
            
            If cur("Verouiller") = True Then
            Verouiller = "OUI"
            Else
            Verouiller = "NON"
            End If
            
            
            TDbg = TDbg + 1
            If (TDbg / 2) = Int(TDbg / 2) Then
                bgcolor = GetDefault("EcomTdColor1", "#E3Efff", Session("candidat_ADOContact"))
            Else
                bgcolor = GetDefault("EcomTdColor2", "#D3DFEF", Session("candidat_ADOContact"))
            End If

            
                pr ("<tr class='smalltext' Bgcolor=" & bgcolor & " height=""30"">")
                      pr ("<td > <input type=""hidden"" name='Id_Com_" & TDbg & "' value="""">")
                      If Request("IdAvoire") = "" Then
                      pr ("<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">")
                      End If
                      pr (NumCommande)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</td>"
                  pr ("<td >")
                    If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                    pr Montantinitial
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</td>"
                     pr ("<td align='right'>")
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Trim(MontantCommande)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr ("</td>")
                     pr ("<td align='right'>")
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Trim(Solde)
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr ("</td>")
                     
                 pr "<TD><input type=""hidden"" name=""checkbox" & TDbg & """ value='" & CloturerCommande & "'>"
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr CloturerCommande
                        If Request("IdAvoire") = "" Then pr "</a>"
                        pr "</TD>"
                 pr "<TD><input type=""hidden"" name=""Verouiller" & TDbg & """ value='" & Verouiller & "'>"
                        If Request("IdAvoire") = "" Then pr "<a href=""javascript:Valide_num_commande('" & cur("IdAvoire") & "','" & NumCommande & "',this.document.frm.checkbox" & TDbg & ",this.document.frm.Verouiller" & TDbg & ");"">"
                        pr Verouiller
                        If Request("Com") = "" Then pr "</a>"
                        pr "</TD>"
                 'Verouiller
               
'                     pr ("<td align='right'>" & Trim(Solde) & "</td>")

'
                  pr ("</tr>")
            cur.MoveNext
        Wend
        
            pr ("<input type=""hidden"" name='NbCom' value='" & TDbg & "'></form></table>")
        pr ("")
          TDbg = 0
          
        
    Conn.Close
    Set Conn = Nothing
     pr "</td></tr></table>"
    
If Request("IdAvoire") <> "" Then
' pr "<BR><br>"
     mage = "etape2.gif"
            Text = translate("Commande finale")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
'pr ("</td></tr>")
'
'pr ("<tr><td>")

            Call Ecom_NumCommandeValiderCommande(DSN, Id_Caddie)

            End If
End Function
Public Function CONFIGCLICOMPTE(DSN)
    Session("NewUser") = 0
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
   Dim Sql As String
   Session("MesageMenu") = ""
   Dim ErrorUpdate  As String
   Dim ErrorInsert  As String
   Dim ErrorSuprim As String
   Dim NumErrorSuprimId As String
   Dim Error
   
If val(Trim("" & Request("NbCom"))) <> 0 Then
    For I = 1 To val(Trim("" & Request("NbCom")))
        DoEvents
        Sql = "SELECT T_Num_Commande.NumCommande From T_Num_Commande WHERE T_Num_Commande.NumCommande=" & noquote2(Request("Num_Com_" & I)) & " and  T_Num_Commande.IdNumCommande<>" & Request("Id_Com_" & I) & ";"
        Set cur = Conn.Execute(Sql)
        If cur.EOF = True Then
            Sql = "UPDATE T_Num_Commande "
            Sql = Sql & "SET T_Num_Commande.NumCommande =" & noquote2(Request("Num_Com_" & I)) & ", "
             Sql = Sql & "T_Num_Commande.Libelle=" & noquote2(Request("Libelle_" & I)) & ","
            If UCase(Request("CloturerCommande_" & I)) = "OUI" Then
                Sql = Sql & "T_Num_Commande.CloturerCommande = True, "
            Else
                Sql = Sql & "T_Num_Commande.CloturerCommande = false, "
            End If
            If UCase(Request("Verouiller_" & I)) = "OUI" Then
                Sql = Sql & "T_Num_Commande.Verouiller = True "
            Else
                Sql = Sql & "T_Num_Commande.Verouiller = false "
            End If
                Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & Request("Id_Com_" & I) & ";"
                Conn.Execute Sql
                
                
             
            Sql = "UPDATE T_Avoire SET T_Avoire.Libelle=" & noquote2(Request("Libelle_" & I)) & " "
            Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & Request("Id_Com_" & I) & " AND T_Avoire.NumAvoire=0;"
            
            
            
            
             
            
            
            
            Conn.Execute Sql
            
            Sql = "UPDATE T_Avoire SET T_Avoire.Credit =" & noquoteNum(Request("Montantinitial_" & I)) & "  "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("IdAvoire_" & I) & ";"
            Conn.Execute Sql
            DoEvents
            Conn.Execute Sql
        Else
            
        End If
        If Request("Sup_" & I) = "CHECKED" Then
            If Request("Confirmer_" & I) = "CHECKED" Then
                Sql = "DELETE T_Num_Commande.* From T_Num_Commande WHERE T_Num_Commande.IdNumCommande=" & Request("Id_Com_" & I) & ";"
                    Conn.Execute Sql
                    Conn.Execute Sql
            Else
                Sql = "SELECT t_Devis.numDevis "
                Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire =  "
                Sql = Sql & "t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
                Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & Request("Id_Com_" & I) & ";"
                Set cur = Conn.Execute(Sql)
                If cur.EOF = True Then
                    Sql = "DELETE T_Num_Commande.* From T_Num_Commande WHERE T_Num_Commande.IdNumCommande=" & Request("Id_Com_" & I) & ";"
                    Conn.Execute Sql
                    Conn.Execute Sql
                End If
            
            End If
       
       End If

    Next
End If
    If Trim("" & Request("New_Num_Com")) <> "" Then
     Sql = "SELECT T_Num_Commande.NumCommande,T_Num_Commande.IdNumCommande,T_Num_Commande.Libelle From T_Num_Commande WHERE T_Num_Commande.NumCommande=" & noquote2(Request("New_Num_Com")) & " and  T_Num_Commande.IdSociete=" & Request("Id") & ";"
        Set cur = Conn.Execute(Sql)
     If cur.EOF = True Then
          
            Sql = "INSERT INTO T_Num_Commande ( IdSociete, NumCommande, Montantinitial,Libelle )"
            Sql = Sql & "values (" & Request("id") & " , " & noquote2(Request("New_Num_Com")) & ", " & noquoteNum(Request("New_Montantinitial")) & " "
            Sql = Sql & ", " & noquote2(Request("Libelle")) & ");"
            Conn.Execute Sql
            cur.Requery
            Sql = "INSERT INTO T_Avoire ( IdNumCommande, Credit, Facturer,Libelle )"
            Sql = Sql & "VALUES ( " & cur("IdNumCommande") & ", " & noquoteNum(Request("New_Montantinitial")) & ", false "
            Sql = Sql & ", " & noquote2(Request("Libelle")) & ");"
Conn.Execute Sql
cur.Requery
        End If
    End If
        

   
    DoEvents
'
    pr "<script language=""javascript"">"
    pr "function valide(){" & vbCrLf
'    pr "documment.frm.mode='CONFIGCLICOMPTE'"
    pr "document.frm.action='Contact.asp?mode=CONFIGCLICOMPTE&NumIndiveClient=" & Request("NumIndiveClient") & "';"
    pr " document.frm.submit();"
    pr "}" & vbCrLf
    pr "</script>"
       
            'MsgErr si identifiant déjà utilisé.
            '-----------------------------------
             
            
        
'        pr Session("NewUser")
       

                    
                
'
     
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
    pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")

            image = "etape4.gif"
Set RsCodeCli = Conn.Execute("SELECT t_R_Social.fld3 From t_R_Social WHERE t_R_Social.SocieteId=" & Request("NumIndiveClient") & ";")
If RsCodeCli.EOF = False Then
CodeCli = "" & RsCodeCli!fld3
End If
  RsCodeCli.Close
  Set RsCodeCli = Nothing
            Text = translate("N° Client : " & CodeCli)
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
'pr ("<br><br>")
ViewHautPage
'pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")
pr ("<form name=""frm"" method=""post"" action='Contact.asp'>")
pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            
            
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("N° de Commande") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr></table>")

CONFIGCLICOMPTE_TableauRecap DSN
pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr align='center'><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Nouveau N° de Commande") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr></table>")
CONFIGCLICOMPTE_TableauRecap_New
 pr (ViewBasPage(0, "80%", "center"))
 If Trim("" & Session("Cli")) = "" Then Session("Cli") = Request("Id")
 pr ("<br><br><table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        pr ("<td align=""right""><a href='javascript:valide();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
'         If val(Request("Id")) <> "0" Then
'                      pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&id=" & Request("Id") & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
'                Else
'                    If val("" & id_client) <> 0 Then
'                        pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=ConfigCLICompte&id=" & id_client & "&NumIndiveClient=" & Session("NumIndiveClient") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_NumComptes.GIF"" border=""0""></a>")
'                    End If
'                End If
       
         pr ("&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=CONFIGCLI_New&id=" & Session("Cli") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>")
        pr ("</tr></table>")
pr ("</form>")
'pr ("<tr class='smallerheader'><td colspan='3'>")
'  pr ("</td></tr></table>")
   
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing
            
'    Conn.Close
    Set Conn = Nothing
End Function



Public Function AfficheAvenant(Id, Conn)
Dim Sql As String
Dim Rs As Recordset

If UCase(Request("Avenant")) = UCase("Aven") Then
    If UCase(Request("Facturer")) = UCase("true") Then
        MajFacturer = "True"
    Else
        MajFacturer = "False"
    End If
    If MajFacturer = "True" Then
        Sql = "SELECT T_Avoire.Cloturer From T_Avoire "
        Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & " "
        Sql = Sql & "AND T_Avoire.Cloturer=true;"
        Set RsNumCommande = Conn.Execute(Sql)
        If RsNumCommande.EOF = False Then
            Sql = "SELECT T_Num_Commande.IdNumCommande "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & ";"
            Set RsNumCommande = Conn.Execute(Sql)
            IdNumCommande = RsNumCommande!IdNumCommande
            Sql = "SELECT Count(T_Avoire.NumAvoire) AS [Count] "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "GROUP BY T_Num_Commande.IdNumCommande "
            Sql = Sql & "HAVING T_Num_Commande.IdNumCommande=" & RsNumCommande!IdNumCommande & ";"
            
             Set RsNumCommande = Conn.Execute(Sql)
            Sql = "UPDATE T_Num_Commande INNER JOIN T_Avoire  "
            Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande SET T_Avoire.Credit =  T_Avoire.Credit + " & Replace(Request("Soldes"), ",", ".") & " "
            Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & IdNumCommande & "  "
            Sql = Sql & "AND T_Avoire.NumAvoire=" & RsNumCommande!Count - 1 & ";"
            
            Conn.Execute Sql
            
            Sql = "UPDATE T_Avoire SET T_Avoire.Debit = " & Replace(Request("Credit"), ",", ".") & ", T_Avoire.AnCoursFacturation = False "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & ";"
                Conn.Execute Sql
        End If
        RsNumCommande.Close
        Set RsNumCommande = Nothing
    End If
    Sql = "UPDATE T_Avoire SET T_Avoire.Credit = " & Replace(Request("Credit"), ",", ".") & ", T_Avoire.Facturer = " & MajFacturer & ", T_Avoire.Libelle = " & noquote2(Request("Libelle")) & " "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("id") & ";"
    Conn.Execute Sql

End If
AfficheAvenant = AfficheAvenant & vbCrLf & "<script language='javascript'>"
AfficheAvenant = AfficheAvenant & vbCrLf & "function IsNumeric2(sText){"
'AfficheAvenant = AfficheAvenant & vbCrLf & "//vérifie si la chaine envoyée est de type numérique"
'AfficheAvenant = AfficheAvenant & vbCrLf & "{"
AfficheAvenant = AfficheAvenant & vbCrLf & "   var ValidChars = ""0123456789."";"
AfficheAvenant = AfficheAvenant & vbCrLf & "   var IsNumber=true;"
AfficheAvenant = AfficheAvenant & vbCrLf & "   var Char;"
AfficheAvenant = AfficheAvenant & vbCrLf & "  "
AfficheAvenant = AfficheAvenant & vbCrLf & " "
AfficheAvenant = AfficheAvenant & vbCrLf & "   for (i = 0; i < sText.length && IsNumber == true; i++)"
AfficheAvenant = AfficheAvenant & vbCrLf & "     {"
AfficheAvenant = AfficheAvenant & vbCrLf & "      Char = sText.charAt(i);"
AfficheAvenant = AfficheAvenant & vbCrLf & "      if (ValidChars.indexOf(Char) == -1)"
AfficheAvenant = AfficheAvenant & vbCrLf & "         {"
AfficheAvenant = AfficheAvenant & vbCrLf & "         IsNumber = false;"
AfficheAvenant = AfficheAvenant & vbCrLf & "         }"
AfficheAvenant = AfficheAvenant & vbCrLf & "      }"
AfficheAvenant = AfficheAvenant & vbCrLf & "   return IsNumber;"
AfficheAvenant = AfficheAvenant & vbCrLf & "    "
 AfficheAvenant = AfficheAvenant & vbCrLf & "  }"


AfficheAvenant = AfficheAvenant & vbCrLf & "function funIsNumeric(Txt,Debit,Solde,Soldes){"
AfficheAvenant = AfficheAvenant & vbCrLf & " Txt.value=Remplacer(''+Txt.value,',','.')       "
AfficheAvenant = AfficheAvenant & vbCrLf & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "    if (IsNumeric2(Remplacer(''+Txt.value,',','.'))==false){"
AfficheAvenant = AfficheAvenant & vbCrLf & "        alert('Le Champ Crédit : [ ' + Txt.value + ' ] doit être numérique' );"
AfficheAvenant = AfficheAvenant & vbCrLf & "        Txt.value='';"
AfficheAvenant = AfficheAvenant & vbCrLf & "        Txt.focus();"
AfficheAvenant = AfficheAvenant & vbCrLf & "        return;"
AfficheAvenant = AfficheAvenant & vbCrLf & "    } else {"
AfficheAvenant = AfficheAvenant & vbCrLf & "        var resultat =Remplacer(''+Txt.value,',','.')- Remplacer(''+Debit.value,',','.');"
AfficheAvenant = AfficheAvenant & vbCrLf & "        Solde.value=resultat;"
AfficheAvenant = AfficheAvenant & vbCrLf & "        Soldes.value= Solde.value;"
AfficheAvenant = AfficheAvenant & vbCrLf & "    }"
AfficheAvenant = AfficheAvenant & vbCrLf & "}"
AfficheAvenant = AfficheAvenant & vbCrLf & ""
AfficheAvenant = AfficheAvenant & vbCrLf & ""

AfficheAvenant = AfficheAvenant & vbCrLf & "function Remplacer(Txt,C,R){"
AfficheAvenant = AfficheAvenant & vbCrLf & "var a, tmp;"
AfficheAvenant = AfficheAvenant & vbCrLf & "tmp = '';"
AfficheAvenant = AfficheAvenant & vbCrLf & "a = ''+Txt;"
AfficheAvenant = AfficheAvenant & vbCrLf & "  "
AfficheAvenant = AfficheAvenant & vbCrLf & "for(var i = 0; i < a.length; i++)"
AfficheAvenant = AfficheAvenant & vbCrLf & "{"
AfficheAvenant = AfficheAvenant & vbCrLf & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "  "
AfficheAvenant = AfficheAvenant & vbCrLf & "    if (a.charAt(i) ==  C)"
AfficheAvenant = AfficheAvenant & vbCrLf & "    {"
AfficheAvenant = AfficheAvenant & vbCrLf & "    tmp = tmp + R;"
AfficheAvenant = AfficheAvenant & vbCrLf & "    } else{"
AfficheAvenant = AfficheAvenant & vbCrLf & "        tmp = tmp + a.charAt(i);"
AfficheAvenant = AfficheAvenant & vbCrLf & "    }"
AfficheAvenant = AfficheAvenant & vbCrLf & "}"
AfficheAvenant = AfficheAvenant & vbCrLf & "  "
AfficheAvenant = AfficheAvenant & vbCrLf & "return  tmp;"
'AfficheAvenant = AfficheAvenant & vbCrLf & "alert(a);"
AfficheAvenant = AfficheAvenant & vbCrLf & "}"
AfficheAvenant = AfficheAvenant & vbCrLf & ""
AfficheAvenant = AfficheAvenant & vbCrLf & ""

AfficheAvenant = AfficheAvenant & vbCrLf & "function ClickChec(){"
'AfficheAvenant = AfficheAvenant & vbCrLf & "        alert(Remplacer('A','A','B'));"
AfficheAvenant = AfficheAvenant & vbCrLf & "    if (this.document.Avenants.CommandExiste.value=='FALSE'){"

AfficheAvenant = AfficheAvenant & vbCrLf & "       alert('" & GetMessage("CommandesPasSoldees.", "Il existe des commandes qui n´ont pas été soldées.", DsnTableMenu(Session("candidat_ADOContact"))) & "'); "
AfficheAvenant = AfficheAvenant & vbCrLf & "            this.document.Avenants.Facturer.checked = false;"
AfficheAvenant = AfficheAvenant & vbCrLf & "            return;"
AfficheAvenant = AfficheAvenant & vbCrLf & "     }"
AfficheAvenant = AfficheAvenant & vbCrLf & "    if (this.document.Avenants.CommanLiv.value=='TRUE'){"

AfficheAvenant = AfficheAvenant & vbCrLf & "       alert('" & GetMessage("CommandesFraisPortsPasFactures.", "Il existe des commandes dont les frais de ports n´ont pas été facturés", DsnTableMenu(Session("candidat_ADOContact"))) & "'); "
AfficheAvenant = AfficheAvenant & vbCrLf & "            this.document.Avenants.Facturer.checked = false;"
AfficheAvenant = AfficheAvenant & vbCrLf & "            return;"
AfficheAvenant = AfficheAvenant & vbCrLf & "     }"
AfficheAvenant = AfficheAvenant & vbCrLf & "    if (this.document.Avenants.Facturer.checked== true){"


AfficheAvenant = AfficheAvenant & vbCrLf & "        var resultat =Remplacer(''+this.document.Avenants.Credit.value,',','.')- Remplacer(''+this.document.Avenants.Debit.value,',','.');"
AfficheAvenant = AfficheAvenant & vbCrLf & "        if (resultat<0){"

AfficheAvenant = AfficheAvenant & vbCrLf & "            alert('" & GetMessage("PasConsidererCommeFactureAvenantSoldInférieurZero", "Vous ne pouvez pas considérer comme facturé un avenant dont le solde est inférieur à zéro", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficheAvenant = AfficheAvenant & vbCrLf & "            this.document.Avenants.Facturer.checked = false"
AfficheAvenant = AfficheAvenant & vbCrLf & "        }"

AfficheAvenant = AfficheAvenant & vbCrLf & "     }"
AfficheAvenant = AfficheAvenant & vbCrLf & "    if(this.document.Avenants.Cloturer.checked== true){"
AfficheAvenant = AfficheAvenant & vbCrLf & "        if(this.document.Avenants.EnCoursFacturer.value== 'Non'){"
AfficheAvenant = AfficheAvenant & vbCrLf & "            if(this.document.Avenants.Facturer.checked== false){"

AfficheAvenant = AfficheAvenant & vbCrLf & "                alert('" & GetMessage("PasDecocherCaseFactureeAvenantCloture.", "Vous ne pouvez pas décocher la case facturée si l´avenant est clôturé.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficheAvenant = AfficheAvenant & vbCrLf & "                this.document.Avenants.Facturer.checked = true;"
AfficheAvenant = AfficheAvenant & vbCrLf & "             }"
AfficheAvenant = AfficheAvenant & vbCrLf & "        }"
AfficheAvenant = AfficheAvenant & vbCrLf & "     }"

AfficheAvenant = AfficheAvenant & vbCrLf & "}"
AfficheAvenant = AfficheAvenant & vbCrLf & "</script>"



Sql = "SELECT T_Avoire.IdAvoire, T_Frais_Transport.ModeTransport, T_Frais_Transport.Frais "
Sql = Sql & "FROM ((T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) INNER JOIN T_Frais_Transport ON t_Devis.numDevis =  "
Sql = Sql & "T_Frais_Transport.numDevis "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Id & "  "
Sql = Sql & "AND T_Frais_Transport.ModeTransport= "
Sql = Sql & "" & noquote2(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact")))) & " "
Sql = Sql & "AND T_Frais_Transport.Frais =0;"
Set Rs = Conn.Execute(Sql)
If Rs.EOF = False Then
    MyFraisLiv = "TRUE"
Else
    MyFraisLiv = "FALSE"
End If
ExecuterPayer = FunEmpoule(Conn, Id, "FALSE", "Chek")
Sql = "SELECT T_Avoire.IdAvoire, T_Num_Commande.NumCommande, T_Avoire.NumAvoire, T_Avoire.Credit, "
Sql = Sql & "T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Avoire.Cloturer, T_Avoire.Facturer, T_Avoire.AnCoursFacturation,T_Avoire.Libelle "
Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Id & ";"

Set Rs = Conn.Execute(Sql)

If Rs.EOF = False Then
AfficheAvenant = AfficheAvenant & vbCrLf & "<style type=""text/css"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "<!--"
AfficheAvenant = AfficheAvenant & vbCrLf & ".Style1 {bgcolor: #FF00FF}"

AfficheAvenant = AfficheAvenant & vbCrLf & "-->"
AfficheAvenant = AfficheAvenant & vbCrLf & "</style>"
AfficheAvenant = AfficheAvenant & vbCrLf & "<br>"
AfficheAvenant = AfficheAvenant & vbCrLf & "<Form method=""post"" name=""Avenants"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "<input type=""hidden"" name=""mode""  value= ""HISTORIQUE_EBOUTIQUE_COMMANDE"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "<input type=""hidden"" name=""Id""  value= """ & Id & """>"
AfficheAvenant = AfficheAvenant & vbCrLf & "<input type=""hidden"" name=""CommanLiv""  value= """ & MyFraisLiv & """>"
AfficheAvenant = AfficheAvenant & vbCrLf & "<input type=""hidden"" name=""CommandExiste""  value= """ & ExecuterPayer & """>"
AfficheAvenant = AfficheAvenant & vbCrLf & "  <input type=""hidden"" name=""Avenant""  value= ""AVEN"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "    <tr>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "bandeg.gif"" border=""0""></td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Avenant</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "banded.gif"" border=""0""></td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "    </tr>"
AfficheAvenant = AfficheAvenant & vbCrLf & "</table>"
    
    

AfficheAvenant = AfficheAvenant & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "    <tr>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("N° de Commande")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("N° d´Avenant")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signation")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Cr&eacute;dit T.T.C.")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;bit T.T.C.")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Solde T.T.C.")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Factur&eacute;")) & "</td>"
AfficheAvenant = AfficheAvenant & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Clotur&eacute;")) & "</td>"

AfficheAvenant = AfficheAvenant & vbCrLf & "<tr class='smalltext' Bgcolor=#D3DFEF height=""30"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""text""  name =""NumCommande"" value=""" & Rs("NumCommande") & """ disabled>"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"

AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""text""  name =""NumAvoire"" value=""" & Rs("NumAvoire") & """ disabled>"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"
If Rs("Cloturer") = False Or Rs("AnCoursFacturation") = True Then
    MyDisabled = ""
Else
    MyDisabled = " disabled "
End If
If Session("candidat_UserType") <> "Administrator" Then
    MyDisabled = " disabled "
    txtDisabled = " disabled "
Else
    txtDisabled = ""

End If
AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""text"" " & MyDisabled & " name =""Libelle"" value=""" & Rs("Libelle") & """ >"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"

AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""text"" " & MyDisabled & " name =""Credit"" value=""" & Rs("Credit") & """ onChange=""funIsNumeric(this.document.Avenants.Credit,this.document.Avenants.Debit,this.document.Avenants.Solde,this.document.Avenants.Soldes);"" >"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"



AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "         <input type=""text""  name =""Debit"" value=""" & Rs("Debit") & """ disabled>"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"

AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""text""  name =""Solde"" value=""" & Rs("Solde") & """ disabled>"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""hidden""  name =""Soldes"" value=""" & Rs("Solde") & """ >"
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"
'
AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
If Rs("facturer") = False Then
    MyChecked = "value=""TRUE"""
Else
     MyChecked = "value=""TRUE"" Checked "
End If
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""checkbox"" " & MyChecked & " " & MyDisabled & " name =""Facturer""    onclick=ClickChec();>"
If Rs("AnCoursFacturation") = True Then
    AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""hidden"" name =""EnCoursFacturer""   value=""Oui"" > "
Else
    AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""hidden"" name =""EnCoursFacturer""   value=""Non"">"
End If
AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"



If Rs("Cloturer") = False Then
    MyChecked = ""
Else
     MyChecked = "Checked "
End If

AfficheAvenant = AfficheAvenant & vbCrLf & "<td colspan=""0"" align=""left""><div align=""center"" class=""Style1"" ><span class=""ecomtitrecaddie"">"
AfficheAvenant = AfficheAvenant & vbCrLf & "          <input type=""checkbox""  name =""Cloturer"" value=""" & Rs("Cloturer") & """ disabled " & MyChecked & ">"

AfficheAvenant = AfficheAvenant & vbCrLf & "</span></div></td>"



AfficheAvenant = AfficheAvenant & vbCrLf & "</TR></table>"









AfficheAvenant = AfficheAvenant & vbCrLf & ""
AfficheAvenant = AfficheAvenant & vbCrLf & "</td></tr></Table>"
If Rs("Cloturer") = False Or Rs("AnCoursFacturation") = True Then
    If Session("candidat_UserType") = "Administrator" Then
        AfficheAvenant = AfficheAvenant & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
        AfficheAvenant = AfficheAvenant & vbCrLf & " <tr><td align=""right""><a href='javascript:this.document.Avenants.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a></TD><tr>"
        AfficheAvenant = AfficheAvenant & vbCrLf & "</Table>"
     End If
End If
AfficheAvenant = AfficheAvenant & vbCrLf & "<br>"






AfficheAvenant = AfficheAvenant & vbCrLf & "</Form>"


'
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""text""  name =""NumCommande"" value=""" & Rs("NumCommande") & """ disabled></td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""text""  name =""NumAvoire"" value=""" & Rs("NumAvoire") & """ disabled></td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""text""  name =""Credit"" value=""" & Rs("Credit") & """ ></td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""text""  name =""Debit"" value=""" & Rs("Debit") & """ disabled></td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""text""  name =""Solde"" value=""" & Rs("Solde") & """ disabled></td>"
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td align=""left"">&nbsp;</td>"
'If Rs("Cloturer") = False Then
'    MyChecked = ""
'Else
'     MyChecked = "Checked "
'End If
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""checkbox""  name =""Cloturer"" value=""" & Rs("Cloturer") & """ disabled " & MyChecked & "></td>"
'
'If Rs("Facturer") = False Then
'    MyChecked = ""
'Else
'     MyChecked = "Checked "
'End If
'AfficheAvenant = AfficheAvenant & vbCrLf & "          <td  width=""10%""  align=""center"" ><input type=""checkbox""  name =""Facturer"" value=""" & Rs("Cloturer") & """ disabled " & MyChecked & "></td>"
'
'
'AfficheAvenant = AfficheAvenant & vbCrLf & "                  </tr>"
'AfficheAvenant = AfficheAvenant & vbCrLf & " </Table>"
'
'AfficheAvenant = AfficheAvenant & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
'  AfficheAvenant = AfficheAvenant & vbCrLf & " <tr><td align=""right""><a href='javascript:this.document.Anenant.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a></TD><tr>"
'    AfficheAvenant = AfficheAvenant & vbCrLf & "</Table>"
'
'
'AfficheAvenant = AfficheAvenant & vbCrLf & "<br>"






'AfficheAvenant = AfficheAvenant & vbCrLf & "</Form>"
   
End If
End Function
Public Function Ecom_Numcomade(DSN, Id_Caddie As String)
    Session("NewUser") = 0
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    Session("NewUser") = Session("NewUser")
    DoEvents
'           liste_vars()
            c_Id_User = val(Trim(ChkString(Request("c_Id_User"))))
            NumIndiveClient = Trim(ChkString(Request("NumIndiveClient")))
            is_client = Trim(ChkString(Request("is_client")))
            id_client = Trim(Request("id_client"))
            id_livraison = Trim(Request("id_livraison"))
            c_nom = Trim(ChkString(Request("c_nom")))
            d_nom = Trim(ChkString(Request("d_Name")))
            c_prenom = Trim(ChkString(Request("c_prenom")))
           d_prenom = Trim(ChkString(Request("d_P_Name")))
            
            c_societe = Trim(ChkString(Request("c_societe")))
            c_adresse = Trim(ChkString(Request("c_adresse")))
            c_codepostal = Trim(ChkString(Request("c_codepostal")))
            c_ville = Trim(ChkString(Request("c_ville")))
            c_id_pays = Trim(ChkString(Request("c_id_pays")))
            c_email = Trim(ChkString(Request("c_email")))
            d_mail = Trim(ChkString(Request("d_Mail")))
            l_beneficiaire = Trim(ChkString(Request("l_beneficiaire")))
            l_adresse = Trim(ChkString(Request("l_adresse")))
            l_cp = Trim(ChkString(Request("l_cp")))
            l_ville = Trim(ChkString(Request("l_ville")))
            l_id_pays = Trim(ChkString(Request("l_id_pays")))
            l_societe = Trim(ChkString(Request("l_Societe")))
            c_phone = Trim(ChkString(Request("c_phone")))
            cu_phone = Trim(ChkString(Request("cu_phone")))
            d_phone = Trim(ChkString(Request("d_phone")))
'            c_Portable = Trim(ChkString(Request("c_Portable")))
            c_fax = Trim(ChkString(Request("c_Fax")))
             cu_Fax = Trim(ChkString(Request("cu_Fax")))
             d_Fax = Trim(ChkString(Request("d_Fax")))
'            l_kdo = CInt(Request("l_kdo"))
                If l_kdo <> 1 Then l_kdo = 0
'            l_kdotxt = Trim(ChkString(Request("l_kdotxt")))
'            c_numfna = Trim(ChkString(Request("c_Numfna")))
            c_Pass = Trim(ChkString(Request("c_Pass")))
            d_Pass = Trim(ChkString(Request("d_Pass")))
            login = Trim(ChkString(Request("c_login")))
            d_login = Trim(ChkString(Request("d_login")))
          
        If Session("username") = "guest" And Request("act") <> "commanderapide" Then
            'Check Login
            Sql = "SELECT UserLogin from users "
            Sql = Sql & " WHERE UserLogin='" & login & "'"
           
            'SQL = SQL & " OR UserEMail='" & Request("c_email") & "'""
            Set Rs = Conn.Execute(Sql)
            
            'MsgErr si identifiant déjà utilisé.
            '-----------------------------------
             
            If Not Rs.EOF Or Not Rs.BOF Then
                pr ("<div class=""alert"" align=""center"">" & translate("Vous devez donnez un autre login") & ".<br>")
                pr ("<i>[" & login & "]</i> " & translate("est actuellement utilisé") & ".<br>")
                pr (translate("Choisissez un nouvau login en cliquant sur Retour") & ".<br>")
                'pr ("<br><br>" & BoutonRetour(0, "") & " <div>")
                Exit Function
            End If
        End If
'        pr Session("NewUser")
            DoEvents
        If Trim("" & Session("NewUser")) = "1" Then 'nouveau client
 
                    Sql = "select max(UserId) from users"
                    Set cur = Conn.Execute(Sql)
                    id_client = cur(0)
                    If IsNull(id_client) Then
                        id_client = 1
                    End If
                    
                    Sql = "select max(id_livraison) from t_livraison"
                    Set cur = Conn.Execute(Sql)
                    id_livraison = cur(0)
                    If IsNull(id_livraison) Then
                        id_livraison = 1
                    End If
                    
                    id_client = id_client + 1
                    id_livraison = id_livraison + 1
                    
                    Session("NewUser") = 0
                    Session("id_client") = id_client
                    Session("id_livraison") = id_livraison

                    
                    'Mise à jour de Dbp_Users
                    UserLogin = c_nom & " " & c_prenom
'                    HashIt (passwd_client)
                    sql0 = "insert into users ( CId, UserId, UserLogin, [Password], LastName, FirstName, UserDisplayName, UserEMail, UserSecure, UserEmailPass, DateCreate ) values ("
                    sql0 = sql0 & Application("PortalId") & ", "
                    sql0 = sql0 & id_client & ", "
                    sql0 = sql0 & noquote2(login) & ", "
                    sql0 = sql0 & noquote2(Session("HashData")) & ", "
                    sql0 = sql0 & noquote2(c_nom) & ", "
                    sql0 = sql0 & noquote2(c_prenom) & ", "
                    sql0 = sql0 & noquote2(UserLogin) & ", "
                    sql0 = sql0 & noquote2(c_email) & ", "
                    sql0 = sql0 & noquote2(Session("HashSecure")) & ", "
                    sql0 = sql0 & noquote2(passwd_client) & ","
                    sql0 = sql0 & "Now())"
                    Conn.Execute (sql0)
                    
                    Sql1 = ""
                    'Mise à jour de Dbp_UserInfos
                    Sql1 = "insert into t_R_Social (CId, UserID, id_livraison, LastName, FirstName, Address, Zip, City, id_pays,  fld3, Email,phone,Fax) values ("
                    Sql1 = Sql1 & Application("PortalId") & ", "
                    Sql1 = Sql1 & id_client & ", "
                    Sql1 = Sql1 & id_livraison & ", "
                    Sql1 = Sql1 & noquote2(c_nom) & ", "
                    Sql1 = Sql1 & noquote2(c_prenom) & ", "
                    Sql1 = Sql1 & noquote2(c_adresse) & ", "
                    Sql1 = Sql1 & noquote2(c_codepostal) & ", "
                    Sql1 = Sql1 & noquote2(c_ville) & ", "
                    Sql1 = Sql1 & c_id_pays & ", "
'                    Sql1 = Sql1 & noquote2(c_numfna) & ", "
                    Sql1 = Sql1 & noquote2(c_societe) & ", "
                    Sql1 = Sql1 & noquote2(c_email) & ","
                    Sql1 = Sql1 & noquote2(c_phone) & ","
                    
'                        Sql1 = Sql1 & "Portable=" & noquote2(c_Portable) & ","
                        Sql1 = Sql1 & noquote2(c_fax) & ")"
                    Conn.Execute (Sql1)
                  
                    'Mise à jour de Dbp_GroupsPermission : Groupe Visiteur
'                    sql4 = "insert into Dbp_GroupsPermission (CId, GroupID, ObjTypeId, ObjPermId, ObjId, ObjPermType) values ("
'                    sql4 = sql4 & Application("PortalId") & ", "
'                    sql4 = sql4 & GetDefault("EcomGroupIdVisiteurs", "2", Session("candidat_ADOContact")) & ", "
'                    sql4 = sql4 & "50, "
'                    sql4 = sql4 & "1, "
'                    sql4 = sql4 & id_client & ", "
'                    sql4 = sql4 & "10)"
'                    conn.Execute (sql4)
                    
                    'Mise à jour de t_livraison
                    sql2 = "insert into t_livraison (id_livraison, id_pays, beneficiare_liv, adresse_liv, cp_liv, ville_liv, cadeau, cadeau_texte,Societe) values ("
                    sql2 = sql2 & id_livraison & ", "
                    sql2 = sql2 & l_id_pays & ", "
                    sql2 = sql2 & noquote2(l_beneficiaire) & ", "
                    sql2 = sql2 & noquote2(l_adresse) & ", "
                    sql2 = sql2 & noquote2(l_cp) & ", "
                    sql2 = sql2 & noquote2(l_ville) & ","
                    sql2 = sql2 & noquote2(l_kdo) & ","
                     sql2 = sql2 & noquote2(l_kdotxt) & ","
                    sql2 = sql2 & noquote2(l_societe) & ")"
                    
                    Conn.Execute (sql2)
                
                Session("userid") = id_client
                Session("HashData") = ""
                Session("HashSecure") = ""
                
                'Rappel du login et mot de passe pour un nouveau client.
                '-------------------------------------------------------
'             If Request("act") <> "commanderapide" Then
'                pr ("<span class=""smalltext""><b>" & translate("Vos informations ont été correctement enregistrées") & ".</b><br><br>")
'                    pr ("<span class=""alert""> " & translate("N'oubliez pas de noter vos") & " <b>" & translate("informations de connexion") & "</b> :</span><br>")
'                    pr ("<span class=""smalltext"">" & translate("Identifiant") & " : " & login & "</span> <br>")
'                    pr ("<span class=""smalltext"">" & translate("Mot de passe") & " : " & passwd_client & "</span>")
'                    pr ("<br><br>")
'              End If
                            
        Else                'déjà client
            If Session("c_id_pays") = "" Then Session("c_id_pays") = l_id_pays
               
                If c_Id_User = val(id_client) Then
                 UserDisplayName = Trim(c_nom) & " " & Trim(c_prenom)
                sql0 = "update users set "
                    sql0 = sql0 & " CId = " & Application("PortalId") & ", "
                    sql0 = sql0 & " NumIndiveClient = " & noquote2(NumIndiveClient) & ", "
                    sql0 = sql0 & " FirstName = " & noquote2(c_nom) & ", "
                    sql0 = sql0 & " LastName = " & noquote2(c_prenom) & ", "
                    sql0 = sql0 & " UserDisplayName = " & noquote2(UserDisplayName) & ", "
                    sql0 = sql0 & " UserEMail = " & noquote2(c_email) & ","
                    sql0 = sql0 & " Password = " & noquote2(c_Pass) & ", "
                    sql0 = sql0 & " UserEmailPass = " & noquote2(c_Pass) & ","
                    sql0 = sql0 & "phone= " & noquote2(cu_phone) & ","
                    sql0 = sql0 & "Fax  = " & noquote2(cu_Fax)
                    sql0 = sql0 & " where  UserID=" & id_client
                Else
                     UserDisplayName = Trim(d_nom) & " " & Trim(d_prenom)
                    sql0 = "update users set "
                    sql0 = sql0 & " CId = " & Application("PortalId") & ", "
                    sql0 = sql0 & " NumIndiveClient = " & noquote2(NumIndiveClient) & ", "
                    sql0 = sql0 & " FirstName = " & noquote2(d_nom) & ", "
                    sql0 = sql0 & " LastName = " & noquote2(d_prenom) & ", "
                    sql0 = sql0 & " UserDisplayName = " & noquote2(UserDisplayName) & ", "
                    sql0 = sql0 & " UserEMail = " & noquote2(d_mail) & ","
                    sql0 = sql0 & " Password = " & noquote2(d_Pass) & ", "
                    sql0 = sql0 & " UserEmailPass = " & noquote2(d_Pass) & ","
                    sql0 = sql0 & "phone= " & noquote2(d_phone) & ","
                    sql0 = sql0 & "Fax  = " & noquote2(d_Fax)
                    sql0 = sql0 & " where  UserID=" & id_client
                End If
                Conn.Execute (sql0)
'                    Sql1 = "SELECT t_R_Social.* FROM t_R_Social WHERE  t_R_Social.SocieteId=" & id_client
'                    Set RsRaison = Conn.Execute(Sql1)
'
'                    If RsRaison.EOF = False Then
'                    Sql1 = ""
'
'                        Sql1 = "update t_R_Social set "
'                        Sql1 = Sql1 & " CId = " & Application("PortalId") & ", "
'                        Sql1 = Sql1 & " LastName = " & noquote2(c_nom) & ", "
'                        Sql1 = Sql1 & " FirstName = " & noquote2(c_prenom) & ", "
'                        Sql1 = Sql1 & " fld3 = " & noquote2(c_societe) & ", "
'                        Sql1 = Sql1 & " Address = " & noquote2(c_adresse) & ", "
'                        Sql1 = Sql1 & " Zip = " & noquote2(c_codepostal) & ", "
'                        Sql1 = Sql1 & " City = " & noquote2(c_ville) & ", "
'                        Sql1 = Sql1 & " Email = " & noquote2(c_email) & ", "
'                        Sql1 = Sql1 & " fld2 = " & noquote2(c_numfna) & ", "
'                        Sql1 = Sql1 & " id_livraison = " & id_livraison & ", "
'                        Sql1 = Sql1 & " id_pays = " & Session("c_id_pays") & ","
'                        Sql1 = Sql1 & "phone= " & noquote2(c_phone) & ","
''                        Sql1 = Sql1 & "Portable=" & noquote2(c_Portable) & ","
'                        Sql1 = Sql1 & "Fax  = " & noquote2(c_Fax)
'                        Sql1 = Sql1 & " where  UserId=" & id_client
'                    Else
'                        Sql1 = "INSERT INTO t_R_Social ( "
'                        Sql1 = Sql1 & "CId, "
'                        Sql1 = Sql1 & "LastName, "
'                        Sql1 = Sql1 & "FirstName, "
'                        Sql1 = Sql1 & "fld3, "
'                        Sql1 = Sql1 & "Address, "
'                        Sql1 = Sql1 & "Zip, "
'                        Sql1 = Sql1 & "City, "
'                        Sql1 = Sql1 & "Email, "
'                        Sql1 = Sql1 & "fld2, "
'                        Sql1 = Sql1 & "id_livraison, "
'                        Sql1 = Sql1 & "id_pays, "
'                        Sql1 = Sql1 & "UserID,"
'                        Sql1 = Sql1 & "phone , "
''                        Sql1 = Sql1 & "Portable"
'                        Sql1 = Sql1 & "Fax) "
'                        Sql1 = Sql1 & "values (  "
'                        Sql1 = Sql1 & Application("PortalId") & ", "
'                        Sql1 = Sql1 & noquote2(c_nom) & ", "
'                        Sql1 = Sql1 & noquote2(c_prenom) & ", "
'                        Sql1 = Sql1 & noquote2(c_societe) & ", "
'                        Sql1 = Sql1 & noquote2(c_adresse) & ", "
'                        Sql1 = Sql1 & noquote2(c_codepostal) & ", "
'                        Sql1 = Sql1 & noquote2(c_ville) & ", "
'                        Sql1 = Sql1 & noquote2(c_email) & ", "
'                        Sql1 = Sql1 & noquote2(c_numfna) & ", "
'                        Sql1 = Sql1 & id_livraison & ", "
'                        Sql1 = Sql1 & c_id_pays & ", "
'                        Sql1 = Sql1 & id_client & ", "
'                         Sql1 = Sql1 & noquote2(c_phone) & ","
''                        Sql1 = Sql1 & noquote2(c_Portable) & ","
'                        Sql1 = Sql1 & noquote2(c_Fax)
'                        Sql1 = Sql1 & ");"
'
'
'                    End If
'                    RsRaison.Close
'                    Set RsRaison = Nothing
                    'vérifie si client a un identifiant de livraison
                    
                    sqltemp = "SELECT id_livraison FROM t_livraison where  id_livraison = " & id_livraison
                    Set test = Conn.Execute(sqltemp)
                    If test.BOF Then
                        'Insertion dans t_livraison
                        sql2 = "insert into t_livraison (id_livraison, id_pays, beneficiare_liv, adresse_liv, cp_liv, ville_liv, cadeau, cadeau_texte,Societe) values ("
                        sql2 = sql2 & id_livraison & ", "
                        sql2 = sql2 & l_id_pays & ", "
                        sql2 = sql2 & noquote2(l_beneficiaire) & ", "
                        sql2 = sql2 & noquote2(l_adresse) & ", "
                        sql2 = sql2 & noquote2(l_cp) & ", "
                        sql2 = sql2 & noquote2(l_ville) & ","
                        sql2 = sql2 & noquote2(l_kdo) & ","
                         sql2 = sql2 & noquote2(l_kdotxt) & ","
                        sql2 = sql2 & noquote2(l_societe) & ")"
                        
                    Else
                        'Mise à jour de t_livraison
                        sql2 = "update t_livraison set "
                        sql2 = sql2 & " id_pays=" & l_id_pays & ", "
                        sql2 = sql2 & " beneficiare_liv=" & noquote2(l_beneficiaire) & ", "
                        sql2 = sql2 & " adresse_liv=" & noquote2(l_adresse) & ", "
                        sql2 = sql2 & " cp_liv=" & noquote2(l_cp) & ", "
                        sql2 = sql2 & " ville_liv=" & noquote2(l_ville) & ", "
                        sql2 = sql2 & " cadeau=" & l_kdo & ","
                        sql2 = sql2 & " cadeau_texte=" & noquote2(l_kdotxt) & ", "
                        sql2 = sql2 & " Societe=" & noquote2(l_societe) & " "
                        sql2 = sql2 & " where  id_livraison = " & id_livraison
                    End If
                  
                    Set test = Nothing
                    
                Conn.Execute (sql2)
'                Conn.Execute (Sql1)
                
'                    pr ("<span class=""smallheader"">" & translate("Vos informations ont été correctement mises à jour") & ".</span><br><p>")
                End If
            Sql = "select max(id_commande) from t_commande"
            
            Set cur = Conn.Execute(Sql)
            id_commande = 1
            If Not cur.EOF Then
                id_commande = val("" & cur(0)) + 1
            End If
            Session("id_commande") = id_commande
'            Sql = "insert into t_commande (id_commande, id_client,  dcre_commande,etat_commande,currency_code) values ("
'            Sql = Sql & id_commande & ", "
'            Sql = Sql & id_client & ", "
'            Sql = Sql & " '" & Now() & "',1,978)"
'            conn.Execute (Sql)
'
'
'            Sql1 = "select c.id_produit,c.qte_produit,p.prix from t_caddie c, dbp_topics p where c.id_caddie=" & Session("candidat_id_caddy") & " and c.id_produit=p.TopicId "
'            Set cur = conn.Execute(Sql1)
'            While Not cur.EOF
'            sql2 = "insert into t_ligne_commande(id_commande,id_article,quantity,prix) values("
'            sql2 = sql2 & id_commande & ", "
'            sql2 = sql2 & cur("id_produit") & ", "
'            sql2 = sql2 & cur("qte_produit") & ", "
'            sql2 = sql2 & fmt(cur("prix")) & ")"
'            If cur("id_produit") <> "-1" Then
'
'            conn.Execute (sql2)
'            End If
'            cur.MoveNext
'            Wend
'Set rsnumdevis = Conn.Execute("SELECT t_NumDevis.* FROM t_NumDevis;")
'If rsnumdevis.EOF = True Then
'    Conn.Execute "INSERT INTO t_NumDevis ( NumDevis, Mydate ) SELECT 1 AS Expr1, Now() AS Expr2;"
'    numDevis = 1
'Else
'    If Format(rsnumdevis!Mydate, "dd/mm/yyyy") = Format(Date, "dd/mm/yyyy") Then
'        numDevis = rsnumdevis!numDevis + 1
'    Else
'        numDevis = 1
'    End If
'
'End If
'Conn.Execute "UPDATE t_NumDevis SET t_NumDevis.NumDevis =" & numDevis & ", t_NumDevis.Mydate = Now();"
'
'numDevis = "COM_" & Format(Date, "#") & "_" & numDevis
'            Sql = "INSERT INTO t_Devis ( id_caddie, id_r_social, Id_Menu, "
'            Sql = Sql & "id_produit, date_modif, qte_produit,  "
'            Sql = Sql & "TypePiece, RefProduit,numDevis,PrixU_produit,Designation ) "
'            Sql = Sql & "SELECT t_caddie.id_caddie, " & id_client & ", t_caddie.Id_Menu,  "
'            Sql = Sql & "t_caddie.id_produit, t_caddie.date_modif,  "
'            Sql = Sql & "t_caddie.qte_produit, t_caddie.TypePiece, t_caddie.RefProduit,'" & numDevis & "',PrixU_produit,t_caddie.Designation "
'            Sql = Sql & "FROM t_caddie WHERE t_caddie.id_caddie=" & Session("candidat_id_caddy") & ";"
'
'        Conn.Execute Sql
'
'            Conn.Execute "DELETE t_caddie.*  FROM t_caddie WHERE t_caddie.id_caddie=" & Session("candidat_id_caddy") & ";"
'            Session("Message_Caddy") = "Votre Commande a bien été prise en compte. <br> Num Commande: " & numDevis
'            HtmlDevis = CrerDevis(id_livraison, id_client, Conn, numDevis, GetDefault("email", "", DSN))
''                Response.Write HtmlDevis
''                Response.End
'''                Exit Function
'            If HtmlDevis = "" Then
'                Response.Redirect "Contact.asp?mode=CANDIDAT_CADDY"
'                Exit Function
'            End If
''            SendEmail2 GetDefault("email", "", DSN), GetDefault("email", "", DSN), GetDefault("EMAILSujetFourniseur", "", DSN) & " " & numDevis, HtmlDevis, True
''            SendEmail2 GetDefault("email", "", DSN), c_email, GetDefault("EMAILSujetClient", "", DSN) & " " & numDevis, HtmlDevis, True
'
'            Response.Redirect "Contact.asp?mode=Candidat_caddy"
'            Exit Function
     
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
    pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")

            image = "etape4.gif"
            Text = translate("N° commande")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("</td></tr>")

pr ("<tr><td>")
'pr ("<br><br>")
ViewHautPage
'pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")
Session("id_client") = id_client
            Session("id_livraison") = id_livraison
            Session("c_nom") = c_nom
            Session("c_prenom") = c_prenom
            Session("c_adresse") = c_adresse
            Session("c_codepostal") = c_codepostal
            Session("c_ville") = c_ville
            Session("c_id_pays") = c_id_pays
            
            Session("c_email") = c_email
            Session("l_beneficiaire") = l_beneficiaire
            Session("l_adresse") = l_adresse
            Session("l_cp") = l_cp
            Session("l_ville") = l_ville
            Session("l_id_pays") = l_id_pays
            Session("l_kdo") = l_kdo
            Session("l_kdotxt") = l_kdotxt
             Session("l_societe") = l_societe
            Session("id_client") = id_client
            Session("id_livraison") = id_livraison
            Session("c_Id_User") = c_Id_User
            
pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Sélectionnez votre N° Commande") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
            pr ("</td></tr></table>")
Ecom_Numcomade_TableauRecap DSN, Id_Caddie
'pr ("<tr class='smallerheader'><td colspan='3'>")
'  pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing
            
'    Conn.Close
    Set Conn = Nothing
End Function
Public Function Ecom_NumcomadeValider(DSN, Id_Caddie As String)
   
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
   

      
    pr ("<script language='javascript' src='../Portal_Ecom/ecom.js'></script>")
    pr ("<script language='javascript' src='../Portal_Java/Portal_Generic.js'></script>")
    pr ("<br><br>")
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

pr ("<tr class='smallerheader'><td colspan='3'>")

            image = "etape4.gif"
            Text = translate("R&eacute;capitulatif global de votre commande et choix du mode de livraison")
pr (ImgTitreEcommerce(Text))
                
'pr ("Etape " & Session("candidat_caddy_etape") & " : " & Text & " <br><br>")
'pr ("<br><br>" & Text & " <br><br>")
'pr ("------------------------------------------------------<br>")
pr ("<table border=0 cellpadding=0 width='100%'><tr class='smallheader'>")
            
            'SAISIE DES COORDONNEES PERSONNELLES
            '===================================
            pr ("<tr><td colspan=2 class=""smallheader"" >")
                pr ("<table border=""0"" width=""100%"" cellpadding=""0"" cellspacing=""0"">")
                    pr ("<tr class=""smallheader"">")
                    pr ("<td width=""50%"" background=""entete_bg.gif"">&nbsp;</td>")
                    pr ("<td width=""1%"" align=""right"" valign=""top""><img src=""entete1.gif""></td>")
                    pr ("<td align=""right"" background=""entete2.gif"">" & translate("Commande") & "&nbsp; ")
                    pr ("<td width=""1%"" align=""left"" valign=""top""><img src=""entete3.gif""></td></tr>")
                    pr ("<tr height=""10""><td colspan=""4"">")
                    pr ("<img src=""transparent.gif"" border=""0"" width=""1"" height=""10""></td></tr>")
                pr ("</table>")
pr ("</td></tr></table")

'pr ("<tr><td>")
pr ("<br>")
 If Request("Com") = "" Then
    pr ("<br>")
    End If
ViewHautPage
pr ("<table width=""80%"" border=""0"" cellpadding='0' cellspacing='0' align='center'>")

Ecom_Numcomade_TableauRecap DSN, Id_Caddie
pr ("<tr class='smallerheader'><td colspan='3'>")
  pr ("</td></tr></table>")
    pr (ViewBasPage(0, "80%", "center"))
pr ("<br><br></BODY></HTML>")

    Conn.Close
    Set Conn = Nothing
            
'    Conn.Close
    Set Conn = Nothing
End Function

Public Function Ecom_ValiderCommande5(DSN, Id_Caddie As String)
 
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN

                  
                    
                    
                    
                    
                    


            Sql = "select max(id_commande) from t_commande"
            
            Set cur = Conn.Execute(Sql)
            id_commande = 1
            If Not cur.EOF Then
                id_commande = val("" & cur(0)) + 1
            End If
            Session("id_commande") = id_commande
            

    
            numDevis = NumeroChrono("CD", "CD_")
       

Set RsCadi = Conn.Execute("SELECT t_caddie.RefProduit,t_caddie.Designation,t_caddie.id_caddie, t_caddie.qte_produit, t_caddie.id_produit, t_caddie.Id_Menu FROM t_caddie WHERE t_caddie.id_caddie=" & Session("candidat_id_caddy") & ";")
Dim RsAchaPice As Recordset
Session("Message_Caddy_Err") = ""
While RsCadi.EOF = False
    Sql = "SELECT Menu.CatId, Menu.Base From Menu WHERE Menu.CatId=" & RsCadi("Id_Menu") & ";"
    Set RsAchaPice = Conn.Execute(Sql)
    Set concadie = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RsAchaPice("Base"))
    Set RsAchaPice = concadie.Execute("SELECT Defaults.defName, Defaults.defValue From Defaults WHERE Defaults.defName='ChampQuantite';")
    champ = RsAchaPice("defValue")
      Set RsAchaPice = concadie.Execute("SELECT Defaults.defName, Defaults.defValue From Defaults WHERE Defaults.defName='StockEncelade';")
    StockEncelade = RsAchaPice("defValue")
    Set RsAchaPice = concadie.Execute("SELECT con_contacts.ContactID, con_contacts." & champ & ", con_contacts." & StockEncelade & " From con_contacts WHERE con_contacts.ContactID=" & RsCadi("id_produit") & ";")
    If val(Trim("" & Session("Droits_SockEncelade"))) = 0 Then
         If val("" & RsAchaPice(champ)) < val("" & RsCadi("qte_produit")) Then
'        MsgBox val("" & RsAchaPice(champ)) & " < " & val(rsCadi("qte_produit"))
            Session("Message_Caddy_Err") = Session("Message_Caddy_Err") & RsCadi("RefProduit") & " QtS= " & val("" & RsAchaPice(champ)) & "<br>"
         
    End If
    Else
       
             If val("" & RsAchaPice(champ)) + val("" & RsAchaPice(StockEncelade)) < val("" & RsCadi("qte_produit")) Then
        '        MsgBox val("" & RsAchaPice(champ)) & " < " & val(rsCadi("qte_produit"))
                    
                    Session("Message_Caddy_Err") = Session("Message_Caddy_Err") & RsCadi("RefProduit") & " QtS= " & val("" & RsAchaPice(champ)) + val("" & RsAchaPice(StockEncelade)) & "<br>"
                 
            End If
        End If
    
    RsCadi.MoveNext
Wend

If Trim("" & Session("Message_Caddy_Err")) <> "" Then
Session("Message_Caddy_Err") = Session("Message_Caddy_Err") & "<br>Veuillez modifier Votre Panier.<br>"
Response.Redirect "Contact.asp?mode=Candidat_caddy&Id_Caddie_0=" & Id_Caddie
                Exit Function
End If

         
            Sql = "INSERT INTO T_Devis ( Id_User,id_caddie, id_r_social, Id_Menu, "
            Sql = Sql & "id_produit, date_modif, qte_produit,  "
            Sql = Sql & "TypePiece, RefProduit,numDevis,PrixU_produit,Designation,Id_Avoire, TVA,PrixRevient,Remise ) "
            
'            Sql = Sql & "SELECT T_NumCadi.Id_User," & Session("id_client") & ", t_caddie.Id_Menu, , "
'            Sql = Sql & "t_caddie.id_produit, t_caddie.date_modif, t_caddie.qte_produit, t_caddie.TypePiece, , "
'            Sql = Sql & "t_caddie.RefProduit, '" & numDevis & "', t_caddie.PrixU_produit, t_caddie.Designation, , "
'            Sql = Sql & Request("IdAvoire") & ", t_caddie.TVA, t_caddie.PrixRevient "
'            Sql = Sql & "FROM T_NumCadi INNER JOIN t_caddie ON T_NumCadi.id = t_caddie.id_caddie "
'            Sql = Sql & "WHERE t_caddie.id_caddie=" & Id_Caddie & ";"
'
            
            Sql = Sql & "SELECT T_NumCadi.Id_User ,t_caddie.id_caddie, " & Session("id_client") & ", t_caddie.Id_Menu,  "
            Sql = Sql & "t_caddie.id_produit, t_caddie.date_modif,  "
            Sql = Sql & "t_caddie.qte_produit, t_caddie.TypePiece, t_caddie.RefProduit,'" & numDevis & "',PrixU_produit,t_caddie.Designation," & Request("IdAvoire") & ",t_caddie.TVA ,t_caddie.PrixRevient,t_caddie.Remise "
             Sql = Sql & "FROM T_NumCadi INNER JOIN t_caddie ON T_NumCadi.id = t_caddie.id_caddie "
            Sql = Sql & "WHERE t_caddie.id_caddie=" & Id_Caddie & ";"
        
        Conn.Execute Sql
             Sql = "INSERT INTO T_Frais_Transport ( numDevis, ModeTransport,TVA ) "
        If Request("Comptoir") = "OUI" Then
                Sql = Sql & "VALUES ( " & noquote2(numDevis) & ", " & noquote2(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DSN)) & "," & GetDefault("TVA", "19.6", DsnTableMenu(Session("candidat_ADOContact"))) & ");"
            Else
                Sql = Sql & "VALUES ( " & noquote2(numDevis) & ", " & noquote2(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DSN)) & "," & GetDefault("TVA", "19.6", DsnTableMenu(Session("candidat_ADOContact"))) & ");"
        End If
       ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
            Conn.Execute Sql
        ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
        Sql = "DELETE  T_NumCadi.*  FROM  T_NumCadi WHERE  T_NumCadi.id=" & Id_Caddie & ";"
       ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
            Conn.Execute Sql
         Session("candidat_num_id_caddy") = ""
'          Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & Session("UserID") & ";"
          
          Sql = "SELECT t_R_Social.SocieteId, t_R_Social.NumIndiveClient, t_R_Social.id_livraison, T_Num_Commande.NumCommande "
         Sql = Sql & "FROM ((Users INNER JOIN T_Num_Commande ON Users.Id_Societes = T_Num_Commande.IdSociete)  "
         Sql = Sql & "INNER JOIN (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande =  "
         Sql = Sql & "T_Avoire.IdNumCommande) INNER JOIN t_R_Social ON Users.UserID = t_R_Social.Id_Contact "
         Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"
' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
Set RsMail = Conn.Execute(Sql)

            Session("Message_Caddy") = "Votre Commande a bien été prise en compte. <br> N°Client: " & RsMail!NumIndiveClient & "<br>Commande: " & RsMail!NumCommande & "<br>N° Commande Encelade " & numDevis
            HtmlDevis = CrerDevis(RsMail!id_livraison, RsMail!SocieteId, Conn, numDevis, GetDefault("email", "", DSN))
'                Response.Write HtmlDevis
'                Response.End
'                Exit Function
            Session("candidat_id_caddy") = ""
            If Trim("" & Session("Id_Caddie_CadiDefault")) = Trim("" & Id_Caddie) Then
                Session("Id_Caddie_CadiDefault") = ""
            End If
            If HtmlDevis = "" Then
                Response.Redirect "Contact.asp?mode=CANDIDAT_CADDY"
                Exit Function
            End If
            Sql = "SELECT Sum(t_Devis.PrixU_produit) AS ValCadie, "
            Sql = Sql & "(SELECT T_Avoire.Avoire FROM T_Avoire WHERE  T_Avoire.IdNumCommande=" & Request("Id_Avoire") & " AND T_Avoire.Cloturer=0) AS Avoir "
            Sql = Sql & "From t_Devis "
            Sql = Sql & "WHERE t_Devis.Id_NumCommand=" & Request("Com") & ";"
            
           Sql = "SELECT Sum(([t_Devis].[qte_produit]*[t_Devis].[PrixU_produit])) AS ValCadie,  "
            Sql = Sql & "Sum((SELECT T_Avoire.Avoire FROM T_Avoire  "
            Sql = Sql & "WHERE  T_Avoire.IdNumCommande=" & Request("Id_Avoire") & " AND T_Avoire.Cloturer=0)) AS Avoir "
            Sql = Sql & "From t_Devis "
            Sql = Sql & "GROUP BY t_Devis.Id_NumCommand  "
            Sql = Sql & "HAVING t_Devis.Id_NumCommand=" & Request("Id_Avoire") & ";"


    Sql = "SELECT  Sum([qte_produit]*[PrixU_produit]+([qte_produit]*[PrixU_produit]*(1/100)*[tva])) AS SumCommande, T_Avoire.Credit,  "
            Sql = Sql & "T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Avoire.Cloturer, T_Avoire.Facturer "
            Sql = Sql & "FROM T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire "
            Sql = Sql & "GROUP BY T_Avoire.Credit, T_Avoire.Debit, [Credit]-[Debit],  "
            Sql = Sql & "T_Avoire.Cloturer, T_Avoire.Facturer, T_Avoire.IdAvoire, t_Devis.numDevis "
            Sql = Sql & "HAVING T_Avoire.Cloturer=False AND "
            Sql = Sql & "t_Devis.numDevis='" & numDevis & "' "

            Sql = Sql & "AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"


           Debug.Print Sql
           
          ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
            Set RsTotalCom = Conn.Execute(Sql)
            Dim Debiteur As Double
            If RsTotalCom.EOF = False Then
                Debiteur = val(Replace("" & RsTotalCom("Debit"), ",", ".")) + val(Replace("" & RsTotalCom("SumCommande"), ",", "."))
               
                
                Sql = "UPDATE T_Avoire SET T_Avoire.Debit = " & Replace("" & Debiteur, ",", ".") & " "
                Sql = Sql & "WHERE T_Avoire.Cloturer=False AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
               ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
                Conn.Execute Sql
                RsTotalCom.Requery
                If RsTotalCom("Solde") < 0 And RsTotalCom("Facturer") = True Then
                Debiteur = RsTotalCom("debit") + RsTotalCom("solde")
                Debiteur2 = RsTotalCom("debit") - RsTotalCom("credit")
                
                Sql = "UPDATE T_Avoire SET T_Avoire.Debit = " & Replace("" & Debiteur, ",", ".") & ",T_Avoire.Cloturer=true "
                Sql = Sql & "WHERE T_Avoire.Cloturer=False AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
                Conn.Execute Sql
                
                Sql = "SELECT T_Avoire.IdNumCommande  "
            Sql = Sql & "From T_Avoire "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
            Set Rs = Conn.Execute(Sql)
            
            idCommande = Rs("IdNumCommande")
            
            Sql = "SELECT Count(T_Avoire.IdNumCommande) AS NewAvoir "
            Sql = Sql & "From T_Avoire "
            Sql = Sql & "Where T_Avoire.IdNumCommande = " & idCommande & " "
            Sql = Sql & "GROUP BY T_Avoire.IdNumCommande;"
            Set Rs = Conn.Execute(Sql)
            
            Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Debit )"
            Sql = Sql & "VALUES ( " & idCommande & " , " & Rs("NewAvoir") & ", " & Replace(Debiteur2, ",", ".") & ");"
            Conn.Execute Sql
            
            Sql = "SELECT T_Avoire.IdAvoire, T_Avoire.IdNumCommande, T_Avoire.Cloturer "
            Sql = Sql & "From T_Avoire "
            Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & idCommande & " "
            Sql = Sql & "AND T_Avoire.Cloturer=False;"
            
            Set Rs = Conn.Execute(Sql)
            Id_Avoire = Rs("IdAvoire")
            
            Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & Id_Avoire & " "
            Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

             Conn.Execute Sql
            Rs.Close
            Set Rs = Nothing

                
                End If
          
' Debiteur
                 
'                 Sql = "UPDATE T_Num_Commande SET T_Num_Commande.MontantCommande = " & Replace(Debiteur, ",", ".") & " "
'                Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & Request("Com") & ";"
'                Conn.Execute (Sql)
            End If
           Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & Session("UserID") & ";"
           Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays "
            Sql = Sql & "FROM Users INNER JOIN (t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays)  "
            Sql = Sql & "ON Users.Id_Societes = t_R_Social.SocieteId "
            Sql = Sql & "WHERE Users.UserID=" & Session("UserID") & ";"
Set RsMail = Conn.Execute(Sql)


            If SendEmail2(GetDefault("email", "", DSN), GetDefault("email", "", DSN), GetDefault("EMAILSujetFourniseur", "", DSN) & " " & numDevis, HtmlDevis, True) = True Then
                SendEmail2 GetDefault("email", "", DSN), "" & RsMail!UserEMail, GetDefault("EMAILSujetClient", "", DSN) & " " & numDevis, HtmlDevis, True
            End If
NoSend:
Err.Clear
On Error GoTo 0
RsMail.Close
Set RsMail = Nothing
            Response.Redirect "Contact.asp?mode=Candidat_caddy"
            
            Exit Function
        pr ("<table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">")
        pr ("<tr>")
        pr ("<td class=""smallheader"" align=""center"" colspan=""2"">")
                pr (translate("Choisissez votre mode de règlement") & " :</td>")
           ' pr ("<td align=""left"">&nbsp;</td>")
            pr ("<td class=""smallertext"" width=""150"" align=""right"" colspan=""2"">")
                pr (translate("Sécurisé par") & "</td></tr>")
            pr ("<form name=""payer"" action=""" & GetDefault("EcomUrlPaiementBanque", "http://cyberplus.euxia.net/euxia/call_sips.asp", Session("candidat_ADOContact")) & """ method=""post"">")
            pr ("<input type=""hidden"" name=""transaction_id"" value=""" & id_commande & """>")
            
            montant_temp = FormatNumber(Session("total_eu"), 2)
            montant0 = Replace(montant_temp, ",", "")
            MONTANT = Replace(montant0, ".", "")
            MONTANT = Replace(MONTANT, " ", "")
            MONTANT = Format(MONTANT)
            pr ("<input type=""hidden"" name=""f_amount"" value=" & MONTANT & ">")
            pr ("<input type=""hidden"" name=""language"" value=""fr"">")
            
            pr ("<tr>")
                pr ("<td align=""center"">")
                    pr ("<a href=""../portal_ecom/cheque.asp"">")
                    pr ("<img src=""cheque.gif"" alt=""" & translate("Paiement par chèque") & """ border=0></a>&nbsp;&nbsp;")
                    pr ("<a href=""javascript:document.payer.submit();"">")
                    pr ("<img src=""cb.gif"" border=0 alt=""" & translate("Paiement sécurisé par CB") & """></a>")
                    pr ("</td>")
                pr ("<td align=""left"">&nbsp;</td>")
                pr ("<td align=""right"" valign=""top"">")
                    pr ("<a href=""http://www.cyberpluspaiement.com/"">")
                    pr ("<img src=""logobp.gif"" border=""0"" alt=""Cyberplus""></a>&nbsp;&nbsp;</td>")
                    pr ("<td align=""left"" valign=""top"" width=""2""><a href=""http://www.banquepopulaire.fr/"" target=""_blank"">")
                    pr ("<img src=""logobp2.gif"" border=""0"" alt=""Banque Populaire ""></a></td>")
            pr ("</tr>")
            pr ("<tr>")
                pr ("<td>&nbsp;</td>")
                pr ("<td align=""left"">&nbsp;</td>")
                pr ("<td align=""right"" valign=""top"" colspan=""2"">")
                    pr ("<img src=""logoscartes.gif"" border=0 alt=""" & translate("Paiement accepté par CB") & """>")
            pr ("</tr>")
            
            pr ("</table>")
            pr ("</form></center>")
            
            Session("id_client") = id_client
            Session("id_livraison") = id_livraison
            Session("c_nom") = c_nom
            Session("c_prenom") = c_prenom
            Session("c_adresse") = c_adresse
            Session("c_codepostal") = c_codepostal
            Session("c_ville") = c_ville
            Session("c_id_pays") = c_id_pays
            Session("c_email") = c_email
            Session("l_beneficiaire") = l_beneficiaire
            Session("l_adresse") = l_adresse
            Session("l_cp") = l_cp
            Session("l_ville") = l_ville
            Session("l_id_pays") = l_id_pays
            Session("l_kdo") = l_kdo
            Session("l_kdotxt") = l_kdotxt
            Session("id_client") = id_client
            Session("id_livraison") = id_livraison
    Conn.Close
    Set Conn = Nothing
    Session("candidat_caddy_etape") = ""
End Function
Public Function InsertDbCommandFourniseur(Con, Id_Cadie, RefGroupeCommande)
Dim RsMenu As Recordset
Dim RsDbMenu As Recordset
Dim RsFournisseurs As Recordset
Dim rsnumdevis As Recordset
Dim RsNumDevisFournisseur As Recordset
Dim Sql As String
Dim Lst As String
Dim MyCollectionIdFournisseurs As New Collection
Dim I As Long
Dim Men
Dim IdFour As Long
Dim IdMenFour
Lst = GetDefault("IdFornisuer", "lst9", DsnTableMenu(Session("candidat_ADOContact")))
Sql = "SELECT DISTINCT T_Caddie_Four.Id_Menu From T_Caddie_Four "
Sql = Sql & "Where T_Caddie_Four.id_caddie = " & Id_Cadie & " "
Sql = Sql & "ORDER BY T_Caddie_Four.Id_Menu;"
Set RsMenu = Con.Execute(Sql)
While RsMenu.EOF = False
    Sql = "SELECT Menu.Base From Menu WHERE Menu.CatId=" & RsMenu!Id_Menu & ";"
    Set RsDbMenu = Con.Execute(Sql)
    If RsDbMenu.EOF = False Then
        Sql = "SELECT DISTINCT  T_Caddie_Four.Id_Menu,FOURNISEUR.CatID AS ID_FOURNISEUR FROM T_Caddie_Four INNER JOIN "
        Sql = Sql & "(SELECT con_contacts.ContactID, " & Lst & ".CatID FROM con_contacts  "
        Sql = Sql & "INNER JOIN " & Lst & " ON con_contacts." & Lst & " = " & Lst & ".CatID IN '"
        Sql = Sql & RsDbMenu!Base & " "
        Sql = Sql & "') AS FOURNISEUR ON T_Caddie_Four.id_produit = FOURNISEUR.ContactID  "
        Sql = Sql & "Where T_Caddie_Four.id_caddie = " & Id_Cadie & "  "
        Sql = Sql & "AND T_Caddie_Four.Id_Menu=" & RsMenu!Id_Menu & " "
        Sql = Sql & "ORDER BY FOURNISEUR.CatID;"
        Set RsFournisseurs = Con.Execute(Sql)
        While RsFournisseurs.EOF = False
            MyCollectionIdFournisseurs.Add RsFournisseurs!Id_Menu & "_" & RsFournisseurs!ID_FOURNISEUR, "M_" & RsFournisseurs!Id_Menu & "F_" & RsFournisseurs!ID_FOURNISEUR
        
            RsFournisseurs.MoveNext
        Wend
        
    End If
    RsMenu.MoveNext
Wend
IdFour = -1
For I = 1 To MyCollectionIdFournisseurs.Count
IdMenFour = Split(MyCollectionIdFournisseurs(I), "_")
If IdFour <> val(IdMenFour(1)) Then
IdFour = val(IdMenFour(1))
    
    numDevis = NumeroChrono("CF", "CF_")
    
    Sql = "INSERT INTO T_Devis_Fournisseurs ( Commande, [Ref Groupe Commande],DateRecepPrevue,DateRelance )"
    Sql = Sql & "VALUES( '" & numDevis & "', '" & RefGroupeCommande & "',#" & Format(Request("DateRecep"), "yyyy-mm-dd hh:mm:ss") & "#,#" & FunDateRelance(CDate(Request("DateRecep"))) & "# );"
 Con.Execute Sql
 Sql = "SELECT T_Devis_Fournisseurs.Id From T_Devis_Fournisseurs "
    Sql = Sql & "WHERE T_Devis_Fournisseurs.[Ref Groupe Commande]='" & RefGroupeCommande & "' "
    Sql = Sql & "AND T_Devis_Fournisseurs.Commande='" & numDevis & "';"
Set RsNumDevisFournisseur = Con.Execute(Sql)
    If RsNumDevisFournisseur.EOF = False Then
        Id_DevisFour = RsNumDevisFournisseur!Id
    End If
    RsNumDevisFournisseur.Close
    Set RsNumDevisFournisseur = Nothing
    Sql = "INSERT INTO T_Devis_Four_Societe ( Id_Com_Four,numDevis, Nom, pNom, RaisonSocialLiv, AddLiv1, AddLiv2,  "
        Sql = Sql & "AddLiv3, CpLiv, VilleLiv, Id_Pays_Liv, TelLiv, FaxLiv, FormJuridique, Capital,  "
        Sql = Sql & "Creation, CodeApe, Activite, RcsVille, RCS, Siret, NumTva, RaisonSocialFac,  "
        Sql = Sql & "beneficiaire, AddFac1, AddFac2, AddFac3, CpLiFac, VilleFac, Id_PaysFac, TelFac,  "
        Sql = Sql & "FaxFac, Certif, OrganismeCertif, NumCertif, DateCertif ) "
        Sql = Sql & "SELECT " & Id_DevisFour & ",'" & numDevis & "' AS numDevis, T_Raison_Sociale_Societe.Nom, T_Raison_Sociale_Societe.pNom,  "
        Sql = Sql & "T_Raison_Sociale_Societe.RaisonSocialLiv, T_Raison_Sociale_Societe.AddLiv1,  "
        Sql = Sql & "T_Raison_Sociale_Societe.AddLiv2, T_Raison_Sociale_Societe.AddLiv3,  "
        Sql = Sql & "T_Raison_Sociale_Societe.CpLiv, T_Raison_Sociale_Societe.VilleLiv,  "
        Sql = Sql & "T_Raison_Sociale_Societe.Id_Pays_Liv, T_Raison_Sociale_Societe.TelLiv,  "
        Sql = Sql & "T_Raison_Sociale_Societe.FaxLiv, T_Raison_Sociale_Societe.FormJuridique,  "
        Sql = Sql & "T_Raison_Sociale_Societe.Capital, T_Raison_Sociale_Societe.Creation,  "
        Sql = Sql & "T_Raison_Sociale_Societe.CodeApe, T_Raison_Sociale_Societe.Activite,  "
        Sql = Sql & "T_Raison_Sociale_Societe.RcsVille, T_Raison_Sociale_Societe.RCS,  "
        Sql = Sql & "T_Raison_Sociale_Societe.Siret, T_Raison_Sociale_Societe.NumTva,  "
        Sql = Sql & "T_Raison_Sociale_Societe.RaisonSocialFac, T_Raison_Sociale_Societe.beneficiaire,  "
        Sql = Sql & "T_Raison_Sociale_Societe.AddFac1, T_Raison_Sociale_Societe.AddFac2,  "
        Sql = Sql & "T_Raison_Sociale_Societe.AddFac3, T_Raison_Sociale_Societe.CpLiFac,  "
        Sql = Sql & "T_Raison_Sociale_Societe.VilleFac, T_Raison_Sociale_Societe.Id_PaysFac,  "
        Sql = Sql & "T_Raison_Sociale_Societe.TelFac , T_Raison_Sociale_Societe.FaxFac,  "
        Sql = Sql & "T_Raison_Sociale_Societe.Certif, T_Raison_Sociale_Societe.OrganismeCertif, T_Raison_Sociale_Societe.NumCertif,  "
        Sql = Sql & "T_Raison_Sociale_Societe.DateCertif "
        Sql = Sql & "From T_Raison_Sociale_Societe "
        Sql = Sql & "WHERE T_Raison_Sociale_Societe.Societe='Entreprise';"
    Con.Execute Sql
    
    Sql = "SELECT Menu.Base From Menu WHERE Menu.CatId=" & IdMenFour(0) & ";"
    Set RsDbMenu = Con.Execute(Sql)
    If RsDbMenu.EOF = False Then
    
        Sql = "INSERT INTO T_Devis_Four_Raison_Social ( Id_Com_Four,numDevis, CatID, UserID, CatLevel, CatParent,  "
        Sql = Sql & "CatName, Adresse, Pays, Telephone, Fax,  CatName2 ) "
                Sql = Sql & "SELECT  " & Id_DevisFour & ",'" & numDevis & "' as numDevis, FOURNISEUR.CatID, FOURNISEUR.UserID,  "
        Sql = Sql & "FOURNISEUR.CatLevel, FOURNISEUR.CatParent,  "
        Sql = Sql & "FOURNISEUR.CatName, FOURNISEUR.Adresse, FOURNISEUR.Pays,  "
        Sql = Sql & "FOURNISEUR.Telephone, FOURNISEUR.Fax,  "
        Sql = Sql & "FOURNISEUR.CatName2 "
        Sql = Sql & "From   "
        Sql = Sql & "(SELECT  " & Lst & ".* "
        Sql = Sql & "FROM " & Lst & " IN '"
        Sql = Sql & RsDbMenu!Base
        Sql = Sql & "' where " & Lst & ".CatID=" & IdMenFour(1) & ") AS FOURNISEUR"
        
        Sql = "INSERT INTO T_Devis_Four_Raison_Social ( Id_Com_Four, numDevis, CatID, UserID, CatLevel, CatParent,  "
        Sql = Sql & "CatName, Adresse, Pays, Telephone, Fax, CatName2, Mail, Service )  "
        Sql = Sql & "SELECT " & Id_DevisFour & " AS Expr1, '" & numDevis & "' AS numDevis, FOURNISEUR.CatID, FOURNISEUR.UserID,  "
        Sql = Sql & "FOURNISEUR.CatLevel, FOURNISEUR.CatParent, FOURNISEUR.CatName, FOURNISEUR.Adresse,  "
        Sql = Sql & "FOURNISEUR.Pays, FOURNISEUR.Telephone, FOURNISEUR.Fax, FOURNISEUR.CatName2, FOURNISEUR.Mail, FOURNISEUR.Service "
        Sql = Sql & "FROM (SELECT   "
        Sql = Sql & Lst & ".* FROM  "
        Sql = Sql & Lst & " IN '"
        Sql = Sql & RsDbMenu!Base
        Sql = Sql & "'  "
        Sql = Sql & "where  "
        Sql = Sql & Lst & ".CatID=" & IdMenFour(1) & ") AS FOURNISEUR;"
        
        
        
        
        Con.Execute Sql
    End If


End If
Sql = "SELECT Menu.Base From Menu WHERE Menu.CatId=" & IdMenFour(0) & ";"
    Set RsDbMenu = Con.Execute(Sql)
    If RsDbMenu.EOF = False Then
        Sql = "INSERT INTO T_Devis_Four ( Id_Com_Four,numDevis, id_caddie, Id_Menu, id_produit, date_modif, qte_produit, TypePiece, RefProduit,  "
        Sql = Sql & "PrixU_produit, Designation, Id_Fournissuer,Remise ) "
        Sql = Sql & "SELECT DISTINCT  " & Id_DevisFour & " as Id_Com_Four,'" & numDevis & "' AS numDevis, T_Caddie_Four.id_caddie, T_Caddie_Four.Id_Menu, T_Caddie_Four.id_produit, "
        Sql = Sql & "T_Caddie_Four.date_modif, T_Caddie_Four.qte_produit, T_Caddie_Four.TypePiece, T_Caddie_Four.RefProduit,  "
        Sql = Sql & "T_Caddie_Four.PrixU_produit, T_Caddie_Four.Designation, FOURNISEUR.CatID AS ID_FOURNISEUR,T_Caddie_Four.Remise "
        Sql = Sql & "FROM T_Caddie_Four INNER JOIN [SELECT con_contacts.ContactID, " & Lst & ".CatID "
        Sql = Sql & "FROM con_contacts INNER JOIN " & Lst & " ON con_contacts." & Lst & " = " & Lst & ".CatID IN '"
        Sql = Sql & RsDbMenu!Base
        Sql = Sql & "']. AS FOURNISEUR ON T_Caddie_Four.id_produit = FOURNISEUR.ContactID "
        Sql = Sql & "Where T_Caddie_Four.id_caddie = " & Id_Cadie & "  "
        Sql = Sql & "And T_Caddie_Four.Id_Menu = " & IdMenFour(0) & " "
        Sql = Sql & "And FOURNISEUR.CatID = " & IdMenFour(1) & " "
        Sql = Sql & "ORDER BY FOURNISEUR.CatID;"
        Con.Execute Sql
    End If
Next
Sql = "DELETE T_Caddie_Four.* From T_Caddie_Four "
Sql = Sql & "WHERE T_Caddie_Four.id_caddie=" & Id_Cadie & ";"
Con.Execute Sql

RsMenu.Close
RsDbMenu.Close
RsFournisseurs.Close
'rsnumdevis.Close

Set RsMenu = Nothing
Set RsDbMenu = Nothing
Set RsFournisseurs = Nothing
Set rsnumdevis = Nothing
End Function

Public Function Ecom_ValiderFournisseuer(DSN)
 Dim rsnumdevis As Recordset
 Dim Sql As String
    Set Conn = Server.CreateObject("adodb.connection")
    Conn.Open DSN
    numDevis = NumeroChrono("GCF", "GCF_")
   InsertDbCommandFourniseur Conn, Session("candidat_id_caddy"), numDevis
   Conn.Close
   Set Conn = Nothing
   Response.Redirect "Contact.asp?mode=AfficheComGroupFour&GCF=" & numDevis & "&CommandeFournisseurGroupe=" & numDevis
                    
                    
'
'
'
'
'
'            sql = "select max(id_commande) from t_commande"
'
'            Set cur = Conn.Execute(sql)
'            id_commande = 1
'            If Not cur.EOF Then
'                id_commande = val("" & cur(0)) + 1
'            End If
'            Session("id_commande") = id_commande
'
'
'    Set rsnumdevis = Conn.Execute("SELECT t_NumDevis.* FROM t_NumDevis where t_NumDevis.type='CF';")
'    If rsnumdevis.EOF = True Then
'        Conn.Execute "INSERT INTO t_NumDevis ( NumDevis, Mydate,type ) values( 1 , Now() ,'CF');"
'        numDevis = 1
'    Else
'        If Format(rsnumdevis!Mydate, "dd/mm/yyyy") = Format(Date, "dd/mm/yyyy") Then
'            numDevis = rsnumdevis!numDevis + 1
'        Else
'            numDevis = 1
'        End If
'
'    End If
'    Conn.Execute "UPDATE t_NumDevis SET t_NumDevis.NumDevis =" & numDevis & ", t_NumDevis.Mydate = Now() where t_NumDevis.type='CF';"
'
'
'Set rsCadi = Conn.Execute("SELECT T_Caddie_Four.RefProduit,T_Caddie_Four.Designation,T_Caddie_Four.id_caddie, T_Caddie_Four.qte_produit, T_Caddie_Four.id_produit, T_Caddie_Four.Id_Menu FROM T_Caddie_Four WHERE T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy") & ";")
'Dim RsAchaPice As Recordset
''Session("Message_Caddy_Err") = ""
''While rsCadi.EOF = False
''    Sql = "SELECT Menu.CatId, Menu.Base From Menu WHERE Menu.CatId=" & rsCadi("Id_Menu") & ";"
''    Set RsAchaPice = Conn.Execute(Sql)
''    Set concadie = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RsAchaPice("Base"))
''    Set RsAchaPice = concadie.Execute("SELECT Defaults.defName, Defaults.defValue From Defaults WHERE Defaults.defName='ChampQuantite';")
''    champ = RsAchaPice("defValue")
''    Set RsAchaPice = concadie.Execute("SELECT con_contacts.ContactID, con_contacts." & champ & " From con_contacts WHERE con_contacts.ContactID=" & rsCadi("id_produit") & ";")
''    If val("" & RsAchaPice(champ)) < val("" & rsCadi("qte_produit")) Then
'''        MsgBox val("" & RsAchaPice(champ)) & " < " & val(rsCadi("qte_produit"))
''            Session("Message_Caddy_Err") = Session("Message_Caddy_Err") & rsCadi("RefProduit") & " QtS= " & val("" & RsAchaPice(champ)) & "<br>"
''
''    End If
''
''    rsCadi.MoveNext
''Wend
'
''If Trim("" & Session("Message_Caddy_Err")) <> "" Then
''Session("Message_Caddy_Err") = Session("Message_Caddy_Err") & "<br>Veuillez modifier Votre Panier.<br>"
''Response.Redirect "Contact.asp?mode=CANDIDAT_CADDY"
''                Exit Function
''End If
'
'         numDevis = "CF_" & Format(Date, "#") & "_" & numDevis
'            sql = "INSERT INTO T_Devis_Four ( id_caddie, id_r_social, Id_Menu, "
'            sql = sql & "id_produit, date_modif, qte_produit,  "
'            sql = sql & "TypePiece, RefProduit,numDevis,PrixU_produit,Designation,Id_Avoire ) "
'            sql = sql & "SELECT T_Caddie_Four_Four.id_caddie, " & Session("id_client") & ", T_Caddie_Four_Four.Id_Menu,  "
'            sql = sql & "T_Caddie_Four.id_produit, T_Caddie_Four.date_modif,  "
'            sql = sql & "T_Caddie_Four.qte_produit, T_Caddie_Four.TypePiece, T_Caddie_Four.RefProduit,'" & numDevis & "',PrixU_produit,T_Caddie_Four.Designation," & Request("IdAvoire") & " "
'            sql = sql & "FROM T_Caddie_Four WHERE T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy") & ";"
'
'        sql = "INSERT INTO T_Devis_Four ( id_caddie, id_r_social, Id_Menu, id_produit, date_modif,  "
'            sql = sql & "qte_produit, TypePiece, RefProduit, numDevis, PrixU_produit, Designation ) "
'            sql = sql & "SELECT T_Caddie_Four.id_caddie, " & val("" & Session("id_client")) & ",  "
'            sql = sql & "T_Caddie_Four.Id_Menu, T_Caddie_Four.id_produit,  "
'            sql = sql & "T_Caddie_Four.date_modif, T_Caddie_Four.qte_produit,  "
'            sql = sql & "T_Caddie_Four.TypePiece, T_Caddie_Four.RefProduit, '" & numDevis & "',  "
'            sql = sql & "T_Caddie_Four.PrixU_produit, T_Caddie_Four.Designation "
'            sql = sql & "From T_Caddie_Four "
'            sql = sql & "WHERE T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy") & ";"
'
'
'
'        Conn.Execute sql
''             Sql = "INSERT INTO T_Frais_Transport ( numDevis, ModeTransport ) "
''        If Request("Comptoir") = "OUI" Then
''                Sql = Sql & "VALUES ( " & noquote2(numDevis) & ", " & noquote2(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DSN)) & ");"
''            Else
''                Sql = Sql & "VALUES ( " & noquote2(numDevis) & ", " & noquote2(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DSN)) & ");"
''        End If
''            Conn.Execute Sql
'
'
'            Conn.Execute "DELETE T_Caddie_Four.*  FROM T_Caddie_Four WHERE T_Caddie_Four.id_caddie=" & Session("candidat_id_caddy") & ";"
''          Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & Session("UserID") & ";"
'
''          Sql = "SELECT T_Num_Commande.NumCommande, Users.NumIndiveClient "
''Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER  "
''Sql = Sql & "JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
''Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) ON Users.UserID = T_Num_Commande.UserID "
''Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"
''
''Set RsMail = Conn.Execute(Sql)
'
''            Session("Message_Caddy") = "Votre Commande a bien été prise en compte. <br> N°Client: " & RsMail!NumIndiveClient & "<br>Commande: " & RsMail!NumCommande & "<br>N° Commande Encelade " & numDevis
'            HtmlDevis = CrerDevis(id_livraison, id_client, Conn, numDevis, GetDefault("email", "", DSN))
'''                Response.Write HtmlDevis
'''                Response.End
'''                Exit Function
''            If HtmlDevis = "" Then
''                Response.Redirect "Contact.asp?mode=CANDIDAT_CADDY"
''                Exit Function
''            End If
''            Sql = "SELECT Sum(t_Devis.PrixU_produit) AS ValCadie, "
''            Sql = Sql & "(SELECT T_Avoire.Avoire FROM T_Avoire WHERE  T_Avoire.IdNumCommande=" & Request("Id_Avoire") & " AND T_Avoire.Cloturer=0) AS Avoir "
''            Sql = Sql & "From t_Devis "
''            Sql = Sql & "WHERE t_Devis.Id_NumCommand=" & Request("Com") & ";"
''
''           Sql = "SELECT Sum(([t_Devis].[qte_produit]*[t_Devis].[PrixU_produit])) AS ValCadie,  "
''            Sql = Sql & "Sum((SELECT T_Avoire.Avoire FROM T_Avoire  "
''            Sql = Sql & "WHERE  T_Avoire.IdNumCommande=" & Request("Id_Avoire") & " AND T_Avoire.Cloturer=0)) AS Avoir "
''            Sql = Sql & "From t_Devis "
''            Sql = Sql & "GROUP BY t_Devis.Id_NumCommand  "
''            Sql = Sql & "HAVING t_Devis.Id_NumCommand=" & Request("Id_Avoire") & ";"
''
''
''    Sql = "SELECT Sum([qte_produit]*[PrixU_produit]) AS SumCommande, T_Avoire.Credit,  "
''            Sql = Sql & "T_Avoire.Debit, [Credit]-[Debit] AS Solde, T_Avoire.Cloturer, T_Avoire.Facturer "
''            Sql = Sql & "FROM T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire "
''            Sql = Sql & "GROUP BY T_Avoire.Credit, T_Avoire.Debit, [Credit]-[Debit],  "
''            Sql = Sql & "T_Avoire.Cloturer, T_Avoire.Facturer, T_Avoire.IdAvoire, t_Devis.numDevis "
''            Sql = Sql & "HAVING T_Avoire.Cloturer=False AND "
''            Sql = Sql & "t_Devis.numDevis='" & numDevis & "' "
'
''            Sql = Sql & "AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
''
''
''           Debug.Print Sql
''
''
''            Set RsTotalCom = Conn.Execute(Sql)
''            Dim Debiteur As Double
''            If RsTotalCom.EOF = False Then
''                Debiteur = val(Replace("" & RsTotalCom("Debit"), ",", ".")) + val(Replace("" & RsTotalCom("SumCommande"), ",", "."))
''
''
''                Sql = "UPDATE T_Avoire SET T_Avoire.Debit = " & Replace("" & Debiteur, ",", ".") & " "
''                Sql = Sql & "WHERE T_Avoire.Cloturer=False AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
''                Conn.Execute Sql
''                RsTotalCom.Requery
''                If RsTotalCom("Solde") < 0 And RsTotalCom("Facturer") = True Then
''                Debiteur = RsTotalCom("debit") + RsTotalCom("solde")
''                Debiteur2 = RsTotalCom("debit") - RsTotalCom("credit")
'
''                Sql = "UPDATE T_Avoire SET T_Avoire.Debit = " & Replace("" & Debiteur, ",", ".") & ",T_Avoire.Cloturer=true "
''                Sql = Sql & "WHERE T_Avoire.Cloturer=False AND T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
''                Conn.Execute Sql
''
''                Sql = "SELECT T_Avoire.IdNumCommande  "
''            Sql = Sql & "From T_Avoire "
''            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & Request("IdAvoire") & ";"
''            Set Rs = Conn.Execute(Sql)
''
''            IdCommande = Rs("IdNumCommande")
''
''            Sql = "SELECT Count(T_Avoire.IdNumCommande) AS NewAvoir "
''            Sql = Sql & "From T_Avoire "
''            Sql = Sql & "Where T_Avoire.IdNumCommande = " & IdCommande & " "
''            Sql = Sql & "GROUP BY T_Avoire.IdNumCommande;"
''            Set Rs = Conn.Execute(Sql)
''
''            Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Debit )"
''            Sql = Sql & "VALUES ( " & IdCommande & " , " & Rs("NewAvoir") & ", " & Replace(Debiteur2, ",", ".") & ");"
''            Conn.Execute Sql
'
''            Sql = "SELECT T_Avoire.IdAvoire, T_Avoire.IdNumCommande, T_Avoire.Cloturer "
''            Sql = Sql & "From T_Avoire "
''            Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & IdCommande & " "
''            Sql = Sql & "AND T_Avoire.Cloturer=False;"
''
''            Set Rs = Conn.Execute(Sql)
''            Id_Avoire = Rs("IdAvoire")
''
''            Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & Id_Avoire & " "
''            Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"
''
''             Conn.Execute Sql
''            Rs.Close
''            Set Rs = Nothing
''
''
''                End If
''
''' Debiteur
''
'''                 Sql = "UPDATE T_Num_Commande SET T_Num_Commande.MontantCommande = " & Replace(Debiteur, ",", ".") & " "
'''                Sql = Sql & "WHERE T_Num_Commande.IdNumCommande=" & Request("Com") & ";"
'''                Conn.Execute (Sql)
''            End If
''           Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & 1 'Session("UserID") & ";"
''Set RsMail = Conn.Execute(Sql)
''
''
''            SendEmail2 GetDefault("email", "", DSN), GetDefault("email", "", DSN), GetDefault("EMAILSujetFourniseur", "", DSN) & " " & numDevis, HtmlDevis, True
''            SendEmail2 GetDefault("email", "", DSN), "" & RsMail!USEREMAIL, GetDefault("EMAILSujetClient", "", DSN) & " " & numDevis, HtmlDevis, True
''RsMail.Close
''Set RsMail = Nothing
''            Response.Redirect "Contact.asp?mode=Candidat_caddy"
''            Exit Function
''        pr ("<table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">")
''        pr ("<tr>")
''        pr ("<td class=""smallheader"" align=""center"" colspan=""2"">")
''                pr (translate("Choisissez votre mode de règlement") & " :</td>")
''           ' pr ("<td align=""left"">&nbsp;</td>")
''            pr ("<td class=""smallertext"" width=""150"" align=""right"" colspan=""2"">")
''                pr (translate("Sécurisé par") & "</td></tr>")
''            pr ("<form name=""payer"" action=""" & GetDefault("EcomUrlPaiementBanque", "http://cyberplus.euxia.net/euxia/call_sips.asp", Session("candidat_ADOContact")) & """ method=""post"">")
''            pr ("<input type=""hidden"" name=""transaction_id"" value=""" & id_commande & """>")
''
''            montant_temp = FormatNumber(Session("total_eu"), 2)
''            montant0 = Replace(montant_temp, ",", "")
''            MONTANT = Replace(montant0, ".", "")
''            MONTANT = Replace(MONTANT, " ", "")
''            MONTANT = Format(MONTANT)
''            pr ("<input type=""hidden"" name=""f_amount"" value=" & MONTANT & ">")
''            pr ("<input type=""hidden"" name=""language"" value=""fr"">")
''
''            pr ("<tr>")
''                pr ("<td align=""center"">")
''                    pr ("<a href=""../portal_ecom/cheque.asp"">")
''                    pr ("<img src=""cheque.gif"" alt=""" & translate("Paiement par chèque") & """ border=0></a>&nbsp;&nbsp;")
''                    pr ("<a href=""javascript:document.payer.submit();"">")
''                    pr ("<img src=""cb.gif"" border=0 alt=""" & translate("Paiement sécurisé par CB") & """></a>")
''                    pr ("</td>")
''                pr ("<td align=""left"">&nbsp;</td>")
''                pr ("<td align=""right"" valign=""top"">")
''                    pr ("<a href=""http://www.cyberpluspaiement.com/"">")
''                    pr ("<img src=""logobp.gif"" border=""0"" alt=""Cyberplus""></a>&nbsp;&nbsp;</td>")
''                    pr ("<td align=""left"" valign=""top"" width=""2""><a href=""http://www.banquepopulaire.fr/"" target=""_blank"">")
''                    pr ("<img src=""logobp2.gif"" border=""0"" alt=""Banque Populaire ""></a></td>")
''            pr ("</tr>")
''            pr ("<tr>")
''                pr ("<td>&nbsp;</td>")
''                pr ("<td align=""left"">&nbsp;</td>")
''                pr ("<td align=""right"" valign=""top"" colspan=""2"">")
''                    pr ("<img src=""logoscartes.gif"" border=0 alt=""" & translate("Paiement accepté par CB") & """>")
''            pr ("</tr>")
''
''            pr ("</table>")
''            pr ("</form></center>")
''
''            Session("id_client") = id_client
''            Session("id_livraison") = id_livraison
''            Session("c_nom") = c_nom
''            Session("c_prenom") = c_prenom
''            Session("c_adresse") = c_adresse
''            Session("c_codepostal") = c_codepostal
''            Session("c_ville") = c_ville
''            Session("c_id_pays") = c_id_pays
''            Session("c_email") = c_email
''            Session("l_beneficiaire") = l_beneficiaire
''            Session("l_adresse") = l_adresse
''            Session("l_cp") = l_cp
''            Session("l_ville") = l_ville
''            Session("l_id_pays") = l_id_pays
''            Session("l_kdo") = l_kdo
''            Session("l_kdotxt") = l_kdotxt
''            Session("id_client") = id_client
''            Session("id_livraison") = id_livraison
'    Conn.Close
'    Set Conn = Nothing
End Function

Public Function BoutonRetour(image, Class, Optional Bool As Boolean)
If Len(Class) > 1 Then
    css = "<span class=""" & Class & """>"
    fincss = "</span>"
Else
    css = ""
    fincss = ""
End If

If image = 1 Then
'If Session("PathImagesSite") = "" Then Session("PathImagesSite") = GetDefault("PathImagesSite", "../euxia/", Session("candidat_ADOContact"))
    If Bool = True Then
       LESTR = LESTR & vbCrLf & "<a onMouseOver='message(""" & translate("Retour") & """);return true;' href=""Contact.asp?mode=CON_lst"">"
    '   leStr = leStr & vbCrLf & "<a onMouseOver=""message(""" & translate("Retour") & """); return true;"" href=""javascript:history.go(-1);"">"
        LESTR = LESTR & vbCrLf & "<img src=""retour.gif"" border=""0""></a>"
    Else
   LESTR = LESTR & vbCrLf & "<a onMouseOver='message(""" & translate("Retour") & """);return true;' href=""javascript:history.go(-1);"">"
    '   leStr = leStr & vbCrLf & "<a onMouseOver=""message(""" & translate("Retour") & """); return true;"" href=""javascript:history.go(-1);"">"
        LESTR = LESTR & vbCrLf & "<img src=""retour.gif"" border=""0""></a>"
    End If
End If
BoutonRetour = LESTR
End Function

Public Function ImgTitreEcommerce(Titre)
    pr ("<table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">")
    pr ("<tr><td>")

        pr ("<table border=""0"" background=""bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">")
        pr ("<tr>")
            pr ("<td width=""5%"" align=""left""><img src=""bandeg.gif"" border=""0""></td>")
            pr ("<td class=""ecomtitrecaddie2""> " & Titre & "</td>")
            pr ("<td width=""5%"" align=""right""><img src=""banded.gif"" border=""0""></td>")
            pr ("</tr></table>")
            
    pr ("</tr>")
    pr ("<tr><td>" & ImgTransparent(1, 5) & "</td>")
    pr ("</tr></table>")
End Function

Public Function ImgTransparent(width, height)
    ImgTransparent = "<img src=""transparent.gif"" border=""0"" width=""" & width & """ height=""" & height & """>"
End Function

Public Function ImgEnteteColonne(Titre)
LESTR = "<table border=""0"" background='" & Session("contact_devis") & "titre_bg.gif' cellpadding=""0"" cellspacing=""0"" >"
LESTR = LESTR & vbCrLf & "<tr>"
LESTR = LESTR & vbCrLf & "<td align=""left""><img src='" & Session("contact_devis") & "titre_gauche.gif' border=""0""></td>"
LESTR = LESTR & vbCrLf & "<td class=""EcomTitreCaddie""> " & Titre & "</td>"
LESTR = LESTR & vbCrLf & "<td align=""right""><img src='" & Session("contact_devis") & "titre_droite.gif' border=""0""></td>"
LESTR = LESTR & vbCrLf & "</tr></table>"
ImgEnteteColonne = LESTR
End Function

Public Function ViewBasPage(category, twidth, align)

    LESTR = "<div align=""" & align & """>"
    LESTR = LESTR & vbCrLf & "<table border=""0"" width=""" & twidth & """ cellpadding=""0"" cellspacing=""0"">"
    LESTR = LESTR & vbCrLf & "<tr>"
        LESTR = LESTR & vbCrLf & "<td align=""left"">"
        If Session("CategoryAccueil_ID") = "" Then Session("CategoryAccueil_ID") = GetDefault("CategoryAccueil_ID", "3", Session("candidat_ADOContact"))
        If CInt(category) <> CInt(Session("CategoryAccueil_ID")) Then
            LESTR = LESTR & vbCrLf & BoutonRetour(1, "")
        Else
            LESTR = LESTR & vbCrLf & ImgTransparent(1, 1)
        End If
        LESTR = LESTR & vbCrLf & "</td>"
        LESTR = LESTR & vbCrLf & "<td align=""right"">"
'           leStr = leStr & vbCrLf & "<a onMouseOver='message(""" & translate("Retour") & """);return true;' href=""javascript:history.go(-1);"">"

        LESTR = LESTR & vbCrLf & "<a onMouseOver='message(""" & translate("Haut de page") & """);return true;' href=""#haut""><img src=""hautdepage.gif"" border=""0""></a>"
        LESTR = LESTR & vbCrLf & "</td></tr>"
    LESTR = LESTR & vbCrLf & "</table></div>"
    
    ViewBasPage = LESTR
End Function


Public Sub ViewBasPageCaddy(Optional ColSpan As Long = 3, Optional Id_Caddie As Long)


    pr ("<tr height=""30"" valign=""bottom""><td align=""left"">")
        
             pr ("<a onMouseOver='message(""" & translate("Retour") & """);return true;'href=""Contact.asp?mode=con_lst&Category=All"" >")
        
            If Request("ComFour") <> "" Then
                pr ("<img src=""" & Session("EcomPathImages") & "PorssuivreRd.gif"" border=""0""></a>")
            Else
                
                  
               
                    pr ("<img src=""" & Session("EcomPathImages") & "poursuivre.gif"" border=""0""></a>")
               
            End If
        pr ("</td>")
        pr ("<td colspan=""" & ColSpan & """>" & ImgTransparent(1, 1) & "</td>")
        pr ("<td align=""right"">")
        If Request("ComFour") <> "" Then
            MyComFour = "&ComFour=true"
        Else
            MyComFour = ""
        End If
        If Session("UserAcheter") = 1 Or Session("candidat_UserType") <> "Administrator" Then
            If Id_Caddie <> 0 Then
                pr ("<a onMouseOver='message(""" & translate("Enregistrer Commande") & """);return true;' href=""Contact.asp?mode=Candidat_caddyRempli" & MyComFour & "&id_caddie_2=" & Id_Caddie & """ >")
            Else
            pr ("<a onMouseOver='message(""" & translate("Enregistrer Commande") & """);return true;' href=""Contact.asp?mode=Candidat_caddyRempli" & MyComFour & """ >")
            End If
            pr ("<img src=""confirmerlacommande.gif"" border=""0""></a>")
         Else
                     pr ("<a onMouseOver='message(""" & translate("Enregistrer Commande") & """);return true;' href=""Contact.asp?mode=Candidat_caddyRempli" & MyComFour & """ >")
            pr ("<img src=""confirmerlacommande.gif"" border=""0""></a>")

        End If
        pr ("</td></tr>")
    
    
    'If Session("totalqte") < 10 Then
            pr ("<tr height=""30"">")
            pr ("<td>" & ImgTransparent(1, 60) & "</td>")
            pr ("<td colspan=""" & ColSpan + 1 & """ align=""right"" valign=""bottom"">")
            pr ("<a  onMouseOver='message(""" & translate("Haut de page") & """);return true;' href=""#haut""><img src=""hautdepage.gif"" border=""0""></a>")
            pr ("</td></tr>")
    'End If
End Sub


Public Sub ViewHautPage()
    pr ("<a name=""#haut""></a>")

End Sub


Function TOZS(V)
    V = V           ' AH, MICROSOFT... LE PIRE C'EST QUE CA MARCHE PLUS SANS CETTE LIGNE !
    If IsNull(V) Then
           TOZS = ""
    Else
           TOZS = CStr(V)
    End If
End Function

Function inc(I)
    If I <> "" Then
        inc = I + 1
    Else
        inc = 1
    End If
End Function
Function noquote2(s0)
numtxt = s0

numtxt = noquoteNum(numtxt)

If numtxt <> "NULL" Then s0 = numtxt
    If (CStr(s0) = "NULL") Or IsNull(s0) Or (Len(CStr(s0)) = 0) Then
        noquote2 = "NULL"
    Else
        
        noquote2 = "'" & noquote(s0) & "'"
       
       
    End If
End Function

Function fmt(V)
    w = V
    If IsNull(w) Then
        fmt = "0.00"
    Else
        w = Round(CDbl(w), 2)
        fmt = Replace(CStr(w), ",", ".")
    End If
End Function
Function noquote(s0)
'   s = ""
'   c = ""
'
'   For i = 1 To Len(s0)
'       c = Mid(s0, i, 1)
'       If c = "'" Then
'           s = s & "''"
'       Else
'           s = s & c
'       End If
'   Next
''
'   noquote = s
    noquote = Replace(Replace(CStr(s0), "'", "´"), Chr(34), Chr(34) & Chr(34))
End Function

Function SendEmail2(strEmailFrom, strEMailTo, strEmailSubject, strEmailText, bHTML) As Boolean
' GOAL : TIP : envoyer un EMail avec l'objet CDONTS
 Dim mailEnvoye
 Dim IndexMal As Long
 Dim txtAddressMal
Dim ParamServeur
SendEmail2 = True
On Error Resume Next
ParamServeur = Retourne_SMTP(Session("candidat_ADOContact"))
ParamServeur = Replace(ParamServeur, vbCrLf, "")
 txtAddressMal = Split(strEMailTo & ";", ";")
ParamServeur = Split(ParamServeur, ";")
For IndexMal = 0 To UBound(txtAddressMal) - 1
    MailEnvoi ParamServeur(1), val(ParamServeur(6)), ParamServeur(3), ParamServeur(5), ParamServeur(2), ParamServeur(9), ParamServeur(4), txtAddressMal(IndexMal), "", strEmailSubject, strEmailText, ""
 Exit Function
Next
'SendEmail2 = True
' txtAddressMal = Split(strEMailTo & ";", ";")
'Err.Clear
'For IndexMal = 0 To UBound(txtAddressMal) - 1
'    Set mailEnvoye = Server.CreateObject("CDONTS.NewMail")
'    If Err Then
'        Set mailEnvoye = Nothing
'        Err.Clear
'        SendEmail2 = False
'        Exit Function
'    End If

'     Set mailEnvoye = CreateObject("CDONTS.NewMail")
'    ' TIP : mailEnvoye.BodyFormat : 1=Text Only, 0=HTML
'    If bHTML = True Then
'        mailEnvoye.BodyFormat = 0
'        mailEnvoye.MailFormat = 0
'    Else
'        mailEnvoye.BodyFormat = 1
'    End If
'        mailEnvoye.Subject = strEmailSubject
'        mailEnvoye.To = txtAddressMal(IndexMal)
'        mailEnvoye.Body = strEmailText
'        mailEnvoye.Send (strEmailFrom)
'        If Err Then
'            SendEmail2 = False
'        End If
'        id_Num_caddie = val(Trim("" & Id_Caddie))
'        If Id_Caddie = 0 Then
'             Id_Caddie = val(Trim("" & Id_Caddie))
''
''        End If
'    Else
'        If Session("candidat_id_caddy") = "" Then
'         Set RS1 = GeneralTools.My_Conn.Execute("SELECT T_IdCaddy.IdCaddy FROM T_IdCaddy;")
'            If RS1.EOF = False Then
'                Session("candidat_id_caddy") = RS1!IdCaddy + 1
'                GeneralTools.My_Conn.Execute "UPDATE T_IdCaddy SET T_IdCaddy.IdCaddy = " & Session("candidat_id_caddy") & ";"
'            Else
'                Session("candidat_id_caddy") = 1
'                GeneralTools.My_Conn.Execute "INSERT INTO T_IdCaddy ( IdCaddy ) SELECT " & Session("candidat_id_caddy") & " AS Expr1;"
'            End If
'        End If
'           Session("Id_Caddie") = Session("candidat_id_caddy")
'           Id_Caddie = Session("candidat_id_caddy")
'    End If
'     Session("candidat_id_caddy") = Session("Id_Caddie")
'        Err.Clear
'
'    Set mailEnvoye = Nothing
' Next
' 'Response.write "SendEmail """ & strEmailFrom & """, """ & strEMailTo & """, """ & strEmailSubject & """, """ & strEmailText & """);<br>" & vbCrLf
End Function
Private Function QtsStock(Id_Menu, Conn, iIdProduit)
      Sql = "SELECT Menu.Base FROM Menu WHERE Menu.CatId=" & Id_Menu
    Set RsBase = Conn.Execute(Sql)
    Set conBase = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)}; DBQ=" & RsBase("Base"))
   ChampsQts = GetDefault("ChampQuantite", "txt1", "DRIVER={Microsoft Access Driver (*.mdb)}; DBQ=" & RsBase("Base"))
   Sql = "SELECT con_contacts.* FROM con_contacts WHERE con_contacts.ContactID=" & iIdProduit & ";"
   Set RsArticle = conBase.Execute(Sql)
   QtsStock = RsArticle(ChampsQts)
   RsBase.Close
   RsArticle.Close
   conBase.Close
   Set RsBase = Nothing
   Set RsArticle = Nothing
   Set conBase = Nothing
End Function
Function Affiche_devis(RefCommande As String, Optional Bl As Boolean, Optional NumBl As String, Optional VisuBl As Boolean) As String
Dim Sql As String
Dim Rs As Recordset
Set Conn = OpenDb(DsnTableMenu(Session("candidat_ADOContact")))
Sql = "SELECT DISTINCT t_livraison.id_livraison, Users.UserID, t_Devis.numDevis, t_Devis.id_caddie "
Sql = Sql & "FROM ((T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) INNER JOIN Users ON T_Num_Commande.IdSociete =  "
Sql = Sql & "Users.Id_Societes) INNER JOIN ((t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) INNER JOIN t_livraison  "
Sql = Sql & "ON t_R_Social.id_livraison = t_livraison.id_livraison) ON Users.Id_Societes = t_R_Social.SocieteId "
Sql = Sql & "WHERE t_Devis.numDevis='" & RefCommande & "'  "
Session("RefCommande") = RefCommande
Set Rs = Conn.Execute(Sql)
'Sql = Sql & "AND ((t_Devis.id_caddie)=503));"
Session("UserID") = "" & Rs!UserID
Session("id_livraison") = "" & Rs!id_livraison
 If Rs.EOF = False Then pr CrerDevis(Rs!id_livraison, Rs!UserID, Conn, Rs!numDevis, GetDefault("EMAIL", "test@euxia.net", DsnTableMenu(Session("candidat_ADOContact"))), True, Bl, NumBl, VisuBl)
End Function
Private Function CrerDevisFour(id_livraison, UserID, Conn, numDevis, NousContacter, Optional IsAdmin As Boolean, Optional Bl As Boolean, Optional NumBl As String, Optional VisuBl As Boolean)
Dim Sql As String
Dim Rs As Recordset
Dim UpdateDevis As Boolean
Dim RsCommande As Recordset
Dim My_NumCommande As String
Dim My_Num_Avoire As Long
Dim NumLigne As Long
Dim Id_Avoire As Long
Dim ValSolde As Double
Dim BlExiste As Boolean
If Bl = True And Trim("" & NumBl) = "" Then

Liv = NumeroChrono("BL", "BL_")
For I = 1 To val(Request("NumLigne"))
    Sql = "SELECT [qte_produit]-([t_Devis].[Reste]+" & Request("Dispo_" & I) & ") As Solde From t_Devis WHERE t_Devis.Id=" & Request("L_" & I) & ";"
    Set RsSolde = Conn.Execute(Sql)
    Sql = "INSERT INTO T_Commande_Liv ( Id_Devis, qte_produit,  NumLiv,reste ) "
    Sql = Sql & "Values (" & Request("L_" & I) & ", " & Request("Dispo_" & I) & ", '" & Liv & "'," & RsSolde!Solde
    Sql = Sql & " ); "
     RsSolde.Close
     Set RsSolde = Nothing
    Conn.Execute Sql
    
    Sql = "UPDATE t_Devis SET t_Devis.QtsDispo = 0, t_Devis.Reste = [t_Devis].[Reste]+" & Request("Dispo_" & I) & " "
    Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & I) & ";"
 Conn.Execute Sql

Next
Response.Redirect "Contact.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & Liv
Exit Function
End If

Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & Session("UserID") & ";"
Set Rs = Conn.Execute(Sql)
If Request("Maj") = "Liv" And Bl = False Then
    Sql = "SELECT T_Frais_Transport.Frais From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
    If RsCommande.EOF = False Then
        Sql = "UPDATE T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON "
        Sql = Sql & "t_Devis.numDevis = T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire =  "
        Sql = Sql & "t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]-" & val("" & RsCommande("Frais")) & " "
        Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
        Conn.Execute Sql
    End If
     RsCommande.Close
    Set RsCommande = Nothing

    Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.ModeTransport = '" & replaceAccent(Request("TypeLiv"), True, True) & "' "
    Sql = Sql & ", T_Frais_Transport.Tansporteur = Null, T_Frais_Transport.Frais = 0, T_Frais_Transport.Reference = Null, T_Frais_Transport.Telephone = Null "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
End If

If Request("Maj") = "Prix" And Bl = False Then
        For I = 1 To val(Request("NumLigne"))
            Sql = "UPDATE t_Devis SET t_Devis.QtsDispo =  " & val("" & Request("Dispo_" & I)) & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            Sql = "UPDATE t_Devis SET t_Devis.PrixU_produit =  " & Replace(val("" & Request("L_PrixU_produit_" & I)), ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]- " & Replace(val("" & Request("L_PrixU_produit_Avant_" & I)), ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]+ " & Replace(val("" & Request("L_PrixU_produit_" & I)), ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
        Next
        Sql = "SELECT T_Frais_Transport.Frais From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
        If RsCommande.EOF = False Then
            Sql = "UPDATE T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON "
            Sql = Sql & "t_Devis.numDevis = T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire =  "
            Sql = Sql & "t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]-" & val("" & RsCommande("Frais")) & " "
            Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
            Conn.Execute Sql
        End If
  
      
Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,[Credit]-[Debit] as reste,  "
Sql = Sql & "[Credit]-[Debit]-" & val("" & Request("ValTansport")) & "  AS Solde , T_Avoire.Facturer "
Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis) "
Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
        
Reprise:
   Set RsCommande = Conn.Execute(Sql)
   If RsCommande.EOF = True Then
        Sql = "UPDATE T_Avoire SET T_Avoire.Cloturer = True WHERE T_Avoire.IdAvoire=" & Id_Avoire & ";"
        Conn.Execute Sql
        Sql = "SELECT T_Num_Commande.NumCommande, Count(T_Avoire.NumAvoire) AS CompteDeNumAvoire  "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
        Sql = Sql & "T_Avoire.IdNumCommande "
        Sql = Sql & "GROUP BY T_Num_Commande.NumCommande "
        Sql = Sql & "HAVING T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
        Set RsCommande = Conn.Execute(Sql)
        
        If RsCommande.EOF = False Then
            My_Num_Avoire = RsCommande("CompteDeNumAvoire")
            Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Credit ) "
            Sql = Sql & "SELECT T_Num_Commande.IdNumCommande, " & RsCommande("CompteDeNumAvoire") & " AS NumAvoire, " & noquoteNum(ValSolde) & " AS Credit From T_Num_Commande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
            Conn.Execute Sql
            
                  Sql = "UPDATE T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
            Sql = Sql & "T_Avoire.IdNumCommande SET T_Avoire.Cloturer = True, T_Avoire.Debit = [T_Avoire].[Credit] "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'  "
            Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire - 1 & ";"
            Conn.Execute Sql
            
            
            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'"
            Sql = Sql & "AND T_Avoire.Cloturer=False;"
             Set RsCommande = Conn.Execute(Sql)
             If RsCommande.EOF = False Then
                    Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " "
                    Sql = Sql & " WHERE t_Devis.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
                    Conn.Execute Sql
              End If

         
             


            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-[Debit]-" & val("" & Request("ValTansport")) & " AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire & ";"
        UpdateDevis = True
        GoTo Reprise
        End If
   
    Else
        If RsCommande("Solde") < 0 And RsCommande("Facturer") = True Then
        ValSolde = RsCommande("reste")
        Id_Avoire = RsCommande("IdAvoire")
        My_NumCommande = RsCommande("NumCommande")
        Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-[Debit]-" & val("" & Request("ValTansport")) & " AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & RsCommande("NumAvoire") + 1 & ";"
        UpdateDevis = True
        GoTo Reprise
    Else
        If UpdateDevis = True Then
            UpdateDevis = False
            Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " WHERE t_Devis.numDevis='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "';"
            Conn.Execute Sql
        End If
    End If
    
    
   End If
        
        RsCommande.Close
        Set RsCommande = Nothing
        
         Sql = "UPDATE T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport ON "
            Sql = Sql & "t_Devis.numDevis = T_Frais_Transport.numDevis) ON T_Avoire.IdAvoire =  "
            Sql = Sql & "t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]+" & val("" & Request("ValTansport")) & " "
            Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
            Conn.Execute Sql
        
        Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.Tansporteur = '" & replaceAccent("" & Request("NamTansport"), True, True) & "',"
    Sql = Sql & "T_Frais_Transport.Frais = " & val("" & Request("ValTansport")) & ", "
    Sql = Sql & "T_Frais_Transport.Reference = '" & replaceAccent("" & Request("RefTansport"), True, True) & "', "
    Sql = Sql & "T_Frais_Transport.Telephone = '" & replaceAccent("" & Request("TelTansport"), True, True) & "' "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
    End If

CrerDevisFour = ""
CrerDevisFour = CrerDevisFour & vbCrLf & "<html>"
If IsAdmin = True Then
CrerDevisFour = CrerDevisFour & vbCrLf & "<SCRIPT LANGUAGE=""JAVASCRIPT""> "
CrerDevisFour = CrerDevisFour & vbCrLf & "function ValideQtsPris(L){"
CrerDevisFour = CrerDevisFour & vbCrLf & "var PrixU"
CrerDevisFour = CrerDevisFour & vbCrLf & "eval (""PrixU = this.document.MAJPrixLiveraison.L_PrixU_produit_""+L+"";"");"
CrerDevisFour = CrerDevisFour & vbCrLf & "var QTS"
CrerDevisFour = CrerDevisFour & vbCrLf & "eval (""QTS = this.document.MAJPrixLiveraison.L_QTS_""+L+"";"");"
CrerDevisFour = CrerDevisFour & vbCrLf & "var THT"
CrerDevisFour = CrerDevisFour & vbCrLf & "eval (""THT = this.document.MAJPrixLiveraison.L_Prix_THT_produit_""+L+"";"");"
CrerDevisFour = CrerDevisFour & vbCrLf & "if (IsNumeric2(Remplacer(PrixU.value,"","","".""))==false){"
CrerDevisFour = CrerDevisFour & vbCrLf & "    alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevisFour = CrerDevisFour & vbCrLf & "    var PrixU_Av"
CrerDevisFour = CrerDevisFour & vbCrLf & "    eval (""PrixU_Av = this.document.MAJPrixLiveraison.L_PrixU_produit_Avant_""+L+"";"");"
CrerDevisFour = CrerDevisFour & vbCrLf & "    PrixU.value=PrixU_Av.value;"
CrerDevisFour = CrerDevisFour & vbCrLf & "   PrixU.focus();"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"

CrerDevisFour = CrerDevisFour & vbCrLf & "THT.value =QTS.value*Remplacer(PrixU.value,"","",""."")"

CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "function IsNumeric2(sText){"
'AfficheAvenant = AfficheAvenant & vbCrLf & "//vérifie si la chaine envoyée est de type numérique"
'AfficheAvenant = AfficheAvenant & vbCrLf & "{"
CrerDevisFour = CrerDevisFour & vbCrLf & "   var ValidChars = ""0123456789."";"
CrerDevisFour = CrerDevisFour & vbCrLf & "   var IsNumber=true;"
CrerDevisFour = CrerDevisFour & vbCrLf & "   var Char;"
CrerDevisFour = CrerDevisFour & vbCrLf & "  "
CrerDevisFour = CrerDevisFour & vbCrLf & " "
CrerDevisFour = CrerDevisFour & vbCrLf & "   for (i = 0; i < sText.length && IsNumber == true; i++)"
CrerDevisFour = CrerDevisFour & vbCrLf & "     {"
CrerDevisFour = CrerDevisFour & vbCrLf & "      Char = sText.charAt(i);"
CrerDevisFour = CrerDevisFour & vbCrLf & "      if (ValidChars.indexOf(Char) == -1)"
CrerDevisFour = CrerDevisFour & vbCrLf & "         {"
CrerDevisFour = CrerDevisFour & vbCrLf & "         IsNumber = false;"
CrerDevisFour = CrerDevisFour & vbCrLf & "         }"
CrerDevisFour = CrerDevisFour & vbCrLf & "      }"
CrerDevisFour = CrerDevisFour & vbCrLf & "   return IsNumber;"
CrerDevisFour = CrerDevisFour & vbCrLf & "    "
 CrerDevisFour = CrerDevisFour & vbCrLf & "  }"



CrerDevisFour = CrerDevisFour & vbCrLf & ""

CrerDevisFour = CrerDevisFour & vbCrLf & "function Remplacer(Txt,C,R){"
CrerDevisFour = CrerDevisFour & vbCrLf & "var a, tmp;"
CrerDevisFour = CrerDevisFour & vbCrLf & "tmp = '';"
CrerDevisFour = CrerDevisFour & vbCrLf & "a = Txt;"
CrerDevisFour = CrerDevisFour & vbCrLf & "  "
CrerDevisFour = CrerDevisFour & vbCrLf & "for(var i = 0; i < a.length; i++)"
CrerDevisFour = CrerDevisFour & vbCrLf & "{"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "  "
CrerDevisFour = CrerDevisFour & vbCrLf & "    if (a.charAt(i) ==  C)"
CrerDevisFour = CrerDevisFour & vbCrLf & "    {"
CrerDevisFour = CrerDevisFour & vbCrLf & "    tmp = tmp + R;"
CrerDevisFour = CrerDevisFour & vbCrLf & "    } else{"
CrerDevisFour = CrerDevisFour & vbCrLf & "        tmp = tmp + a.charAt(i);"
CrerDevisFour = CrerDevisFour & vbCrLf & "    }"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "  "
CrerDevisFour = CrerDevisFour & vbCrLf & "return  tmp;"
'CrerDevisFour = CrerDevisFour & vbCrLf & "alert(a);"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "function ValideLivraison(Txt){"
'CrerDevisFour = CrerDevisFour & vbCrLf & "alert(this.document.MAJLiveraison.zzz.value);"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJLiveraison.TypeLiv.value=Txt;"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJLiveraison.ACTION=""Contact.asp"";"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJLiveraison.submit();"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "function ValideBl(){"
CrerDevisFour = CrerDevisFour & vbCrLf & "var Execute"
CrerDevisFour = CrerDevisFour & vbCrLf & "Execute=false;"
CrerDevisFour = CrerDevisFour & vbCrLf & "var aa"
'CrerDevisFour = CrerDevisFour & vbCrLf & "alert(this.document.MAJPrixLiveraison.NumLigne.value);"
CrerDevisFour = CrerDevisFour & vbCrLf & "for(i=0;i<this.document.MAJPrixLiveraison.NumLigne.value ;i++) {"
CrerDevisFour = CrerDevisFour & vbCrLf & "i2=i+1"
CrerDevisFour = CrerDevisFour & vbCrLf & "eval (""aa = this.document.MAJPrixLiveraison.Dispo_""+i2+"".value;"");"
'CrerDevisFour = CrerDevisFour & vbCrLf & "alert(aa);"
CrerDevisFour = CrerDevisFour & vbCrLf & "if (aa!=0){"
CrerDevisFour = CrerDevisFour & vbCrLf & "Execute=true;"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "if (Execute==false){"
CrerDevisFour = CrerDevisFour & vbCrLf & "alert('" & GetMessage("UneQteLivree", "Vous devez saisir au moins une valeur dans le champs Qté Livrée", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevisFour = CrerDevisFour & vbCrLf & "return;"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJPrixLiveraison.mode.value=""Hisorique_Bl"";"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJPrixLiveraison.ACTION=""Contact.asp"";"
CrerDevisFour = CrerDevisFour & vbCrLf & "this.document.MAJPrixLiveraison.submit();"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "function Reste(L){"
CrerDevisFour = CrerDevisFour & vbCrLf & "if (IsNumeric2 (QtsDebit.value)==false){"
CrerDevisFour = CrerDevisFour & vbCrLf & "alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevisFour = CrerDevisFour & vbCrLf & "QtsDebit.value=0;"
CrerDevisFour = CrerDevisFour & vbCrLf & "return;"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value-QtsDebit.value;"

CrerDevisFour = CrerDevisFour & vbCrLf & "  if (Qts_R_Sortie.value<0){"

CrerDevisFour = CrerDevisFour & vbCrLf & "      alert('" & GetMessage("QteSaisie", "La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value + '" & GetMessage("SupperieurQteRestanteLivrer : ", " est suppérieur à la Qté Restante à livrer : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsCommand);"
CrerDevisFour = CrerDevisFour & vbCrLf & "QtsDebit.value=0;"
CrerDevisFour = CrerDevisFour & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value;"
CrerDevisFour = CrerDevisFour & vbCrLf & "return;"
CrerDevisFour = CrerDevisFour & vbCrLf & "  }"
CrerDevisFour = CrerDevisFour & vbCrLf & "  if (QtsDebit.value<0){"
CrerDevisFour = CrerDevisFour & vbCrLf & "      alert('" & GetMessage("QteSaisie", "La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value + ' < 0');"
CrerDevisFour = CrerDevisFour & vbCrLf & "QtsDebit.value=0;"
CrerDevisFour = CrerDevisFour & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value;"
CrerDevisFour = CrerDevisFour & vbCrLf & "return;"
CrerDevisFour = CrerDevisFour & vbCrLf & "  }"
CrerDevisFour = CrerDevisFour & vbCrLf & "}"
CrerDevisFour = CrerDevisFour & vbCrLf & "</SCRIPT> "
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "<head>"
If Trim("" & NumBl) <> "" Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "<title>BL N° " & NumBl & "</title>"
Else
    CrerDevisFour = CrerDevisFour & vbCrLf & "<title>Commande N° " & numDevis & "</title>"
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"
If VisuBl = True Then
CrerDevisFour = CrerDevisFour & vbCrLf & HISTORIQUE_BL("" & numDevis, Conn, BlExiste)
Else

CrerDevisFour = CrerDevisFour & vbCrLf & "<center><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "logo.gif"" border=""0"" ></center><br>"
'CrerDevisFour = CrerDevisFour & vbCrLf & "<center><img src=""" & Session("contact_devis")
'<img src="cid:picture.gif" border="0" alt='. $alt_meteo. '>';

'CrerDevisFour = CrerDevisFour & vbCrLf & "logo.gif"" border=""0""></center><br>"
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "<tr><td background=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgh2.gif"">"
If Trim("" & NumBl) <> "" Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">Bordereau de Livraison</font></b></font>"

Else
    CrerDevisFour = CrerDevisFour & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">R&eacute;capitulatif de votre Commande</font></b></font>"
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</tr><tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td bgcolor=""#EBE3D7"">"

'CrerDevisFour = CrerDevisFour & vbCrLf & AfficheAvenant(numDevis)
If Session("VisuDevis") = "TRUE" Then
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
If Bl = False Then
  CrerDevisFour = CrerDevisFour & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Commande&Id=" & Session("IdAvoire") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD><tr>"
  Else
    CrerDevisFour = CrerDevisFour & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & Session("RefCommande") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD><tr>"

  End If
    CrerDevisFour = CrerDevisFour & vbCrLf & "</Table>"
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >R&eacute;f&eacute;rence &agrave; rappeler  </td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
Sql = "SELECT T_Num_Commande.NumCommande, Users.NumIndiveClient "
Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER  "
Sql = Sql & "JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire)  "
Sql = Sql & "ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) ON Users.UserID = T_Num_Commande.UserID "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set RsLiv = Conn.Execute(Sql)

CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"


CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Num&eacute;ro de Client</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "
CrerDevisFour = CrerDevisFour & vbCrLf & RsLiv!NumIndiveClient
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"

CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Num&eacute;ro de Commande</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "
CrerDevisFour = CrerDevisFour & vbCrLf & RsLiv!NumCommande
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"

CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>N°de Commande Encelade</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "
CrerDevisFour = CrerDevisFour & vbCrLf & numDevis
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>En Date du </td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "

CrerDevisFour = CrerDevisFour & vbCrLf & CovertCommDate("" & numDevis)
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
If Bl = True Then


CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>N°de Livraison</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "

'
'Sql = "SELECT T_Commande_Liv.NumLiv FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
'Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "'"
'Sql = Sql & "ORDER BY T_Commande_Liv.NumLiv Desc;"
'Set rsNumLiv = Conn.Execute(Sql)
CrerDevisFour = CrerDevisFour & vbCrLf & NumBl
'rsNumLiv.Close
'Set rsNumLiv = Nothing
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>En Date du</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "

CrerDevisFour = CrerDevisFour & vbCrLf & CovertCommDate("" & NumBl)
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
End If
RsLiv.Close
Set RsLiv = Nothing


CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"



CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Nous Contacter</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Service technique </td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td><A href='mailto:" & NousContacter & "'>" & NousContacter & "</A></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "   </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"






CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Coordonn&eacute;es du demandeur</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Nom / Pr&eacute;nom</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!LastName & " " & Rs!FirstName & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "   </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    "
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Soci&eacute;t&eacute;</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >" & Rs!fld3 & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
'CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
'CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Num&eacute;ro FNA</td>"
'CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >" & Rs!fld2 & "</td>"
'CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    "
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >Adresse</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!Address & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>CP</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!Zip & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >Ville / Pays</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!City & " " & Rs!label_pays & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    "
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Email</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> <A href='mailto:" & Rs!EMail & "'>" & Rs!EMail & "</A></td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>T&eacute;l&eacute;phone / Fax</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "
                                            If Trim("" & Rs!phone) <> "" Then
CrerDevisFour = CrerDevisFour & vbCrLf & Rs!phone
                                                If Trim("" & Rs!fax) <> "" Then
CrerDevisFour = CrerDevisFour & vbCrLf & "          / " & Rs!fax
                                                End If
                                            Else
                                                If Trim("" & Rs!fax) = "" Then
CrerDevisFour = CrerDevisFour & vbCrLf & Rs!fax
                                                Else
CrerDevisFour = CrerDevisFour & vbCrLf & "&nbsp;"
                                                End If
                                            End If
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"





CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" > Adresse de livraison</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
Sql = ""
Sql = Sql & "SELECT t_livraison.id_livraison, t_livraison.id_pays, t_livraison.beneficiare_liv,  "
Sql = Sql & "t_livraison.adresse_liv, t_livraison.cp_liv, t_livraison.ville_liv,  "
Sql = Sql & "t_livraison.date_liv, t_livraison.cadeau, t_livraison.cadeau_texte "
Sql = Sql & "From t_livraison "
Sql = Sql & "WHERE t_livraison.id_livraison=" & Session("id_livraison") & ";"

Set Rs = Conn.Execute(Sql)

CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >B&eacute;n&eacute;ficiaire</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!beneficiare_liv & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td >Adresse</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!adresse_liv & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>CP</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!cp_liv & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Ville</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>" & Rs!ville_liv & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"

CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td>Mode de livraison</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td> "

Sql = "SELECT T_Frais_Transport.ModeTransport From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & numDevis & "';"
Set RsLiv = Conn.Execute(Sql)
CrerDevisFour = CrerDevisFour & vbCrLf & RsLiv!ModeTransport
CrerDevisFour = CrerDevisFour & vbCrLf & "</td> "
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"




CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"


If Session("candidat_UserType") = "Administrator" And Bl = False Then
CrerDevisFour = CrerDevisFour & vbCrLf & "<Form method=""post"" Name=""MAJLiveraison""  >"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""TypeLiv"" value="""">"
'CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""zzz"" value=""Du Con"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""mode""  value= ""HISTORIQUE_Eboutique_Affiche_Commande"">"

CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""Maj""  value= ""Liv"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""RefCommande""  value= """ & numDevis & """ > "

CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Modifer le mode de livraison</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"


CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
If UCase(RsLiv!ModeTransport) = UCase(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact")))) Then
    MyChecked = "Checked"
Else
    MyChecked = "onClick=""ValideLivraison('" & GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"""
End If

CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" >"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""1%""><input type=""radio"" name=""M_Liv"" " & MyChecked & "></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""99%"">" & GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact"))) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" >"

If UCase(Trim("" & RsLiv!ModeTransport)) = Trim("" & UCase(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))))) Then
    MyChecked = "Checked"
Else
    MyChecked = "onClick=""ValideLivraison('" & GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"""
End If

CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""1%""><input type=""radio"" name=""M_Liv"" " & MyChecked & "></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""99%"">" & GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""
CrerDevisFour = CrerDevisFour & vbCrLf & ""



CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"

CrerDevisFour = CrerDevisFour & vbCrLf & ""


CrerDevisFour = CrerDevisFour & vbCrLf & "</form>"
End If

CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
If Trim("" & NumBl) <> "" Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail de la Livraison</td>"
Else
    CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail de la Commande</td>"
End If
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""

CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signation")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute;")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>"



If IsAdmin = True Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qté Livrée")) & "</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Reste")) & "</td>"
End If

CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<Form Name=""MAJPrixLiveraison"" method=""post""  >"
Sql = ""
Sql = Sql & "SELECT t_Devis.*, t_Devis.numDevis "
Sql = Sql & "From t_Devis "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set Rs = Conn.Execute(Sql)

TotalHt = 0
While Rs.EOF = False
  
    iIdMenu = Rs!Id_Menu
    iIdProduit = Rs!id_produit
    iQuantite = Rs!qte_produit
    ValQtsStock = QtsStock(Rs!Id_Menu, Conn, iIdProduit)
If IsAdmin = False Then
    If ValQtsStock - iQuantite < 0 Then
    MyLib = Replace(Replace("" & Rs!Designation, Chr(10), " "), Chr(13), "")
            Session("Message_Caddy") = "§erre§ La quantit&eacute;e de : " & MyLib & " en stock est de : " & ValQtsStock & " veuillez modifier ou supprimer cet article de Votre Panier"

        Sql = "INSERT INTO t_caddie ( id_caddie, Id_Menu, id_produit, date_modif, qte_produit, TypePiece, RefProduit, PrixU_produit, Designation ) "
        Sql = Sql & "SELECT t_Devis.id_caddie, t_Devis.Id_Menu, t_Devis.id_produit, t_Devis.date_modif, t_Devis.qte_produit, t_Devis.TypePiece, t_Devis.RefProduit, t_Devis.PrixU_produit, t_Devis.Designation "
        Sql = Sql & "From t_Devis "
        Sql = Sql & "GROUP BY t_Devis.id_caddie, t_Devis.Id_Menu, t_Devis.id_produit, t_Devis.date_modif, t_Devis.qte_produit, t_Devis.TypePiece, t_Devis.RefProduit, t_Devis.PrixU_produit, t_Devis.Designation "
        Sql = Sql & "HAVING t_Devis.id_caddie=" & Session("candidat_id_caddy") & ";"
        Conn.Execute (Sql)
        Sql = "DELETE t_Devis.*   FROM t_Devis WHERE t_Devis.id_caddie=" & Session("candidat_id_caddy") & ";"
        Conn.Execute (Sql)
        CrerDevisFour = ""
        Exit Function
    End If
    End If
    MettreAJourQuantite iIdMenu, iIdProduit, iQuantite
    NumLigne = NumLigne + 1
    If IsAdmin = False Then
        CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""10%"">"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!Designation & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"">" & Rs!RefProduit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!qte_produit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"">" & Rs!PrixU_produit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!PrixU_produit * Rs!qte_produit & "</td>"
    Else
        CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""10%"">"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!Designation & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"">" & Rs!RefProduit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!qte_produit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >"
        CrerDevisFour = CrerDevisFour & vbCrLf & "         <input type=""hidden"" name=""L_PrixU_produit_Avant_" & NumLigne & """ value=""" & Rs!PrixU_produit & """ >"
        If Session("candidat_UserType") = "Administrator" Then
         CrerDevisFour = CrerDevisFour & vbCrLf & "          <input type=""text"" name=""L_PrixU_produit_" & NumLigne & """ value=""" & Rs!PrixU_produit & """ onchange=""ValideQtsPris('" & NumLigne & "');"" ></td>"
         Else
                  CrerDevisFour = CrerDevisFour & vbCrLf & Rs!PrixU_produit & "</td>"

         End If
'        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"">" & Rs!PrixU_produit & "</td>"
         CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" ><input type=""hidden"" name=""L_QTS_" & NumLigne & """ value=""" & Rs!qte_produit & """ >"
         If Session("candidat_UserType") = "Administrator" Then
            CrerDevisFour = CrerDevisFour & vbCrLf & "          <input type=""text"" disabled name=""L_Prix_THT_produit_" & NumLigne & """ value=""" & Rs!PrixU_produit * Rs!qte_produit & """ ></td>"
        Else
            CrerDevisFour = CrerDevisFour & vbCrLf & Rs!PrixU_produit * Rs!qte_produit & "</td>"
        End If

'        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & Rs!PrixU_produit * Rs!qte_produit & "</td>"
    End If
    TotalHt = TotalHt + (Rs!PrixU_produit * Rs!qte_produit)
    If IsAdmin = True Then
    
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" ><input type=""hidden"" name=""L_" & NumLigne & """ value=""" & Rs!Id & """ >"
    If Bl = True Then
        MyDisabled = " disabled "
    Else
        MyDisabled = ""
    End If
    If Bl = True Then
        Sql = "SELECT T_Commande_Liv.qte_produit FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
        Sql = Sql & "Where T_Commande_Liv.Id_Devis = " & Rs!Id & " "
        Sql = Sql & "ORDER BY T_Commande_Liv.NumLiv Desc;"
        
        Sql = "SELECT T_Commande_Liv.qte_produit, T_Commande_Liv.Reste "
        Sql = Sql & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
        Sql = Sql & "WHERE T_Commande_Liv.Id_Devis=" & Rs!Id & " "
        Sql = Sql & "AND T_Commande_Liv.NumLiv='" & NumBl & "';"

        Set rsQtsLiv = Conn.Execute(Sql)
        CrerDevisFour = CrerDevisFour & vbCrLf & rsQtsLiv!qte_produit & "</td>"
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!Reste & "</td>"
'        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!qte_produit & "</td>"
'NumBl
    Else
      If Session("candidat_UserType") = "Administrator" Then
            CrerDevisFour = CrerDevisFour & vbCrLf & "          <input type=""text"" " & MyDisabled & " name =""Dispo_" & NumLigne & """ value=""" & Rs!QtsDispo & """ onchange=""Reste('" & Rs!qte_produit & "',this.document.MAJPrixLiveraison.Dispo_" & NumLigne & ",this.document.MAJPrixLiveraison.Reste_" & NumLigne & ",this.document.MAJPrixLiveraison.txt_Reste_" & NumLigne & ");""></td>"
            CrerDevisFour = CrerDevisFour & vbCrLf & "          <td><input type=""hidden"" disabled  name =""Reste_" & NumLigne & """ value=""" & Rs!qte_produit - (Rs!QtsDispo + Rs!Reste) & """>"
            CrerDevisFour = CrerDevisFour & vbCrLf & "          <input type=""text"" disabled  name =""txt_Reste_" & NumLigne & """ value=""" & Rs!qte_produit - (Rs!QtsDispo + Rs!Reste) & """></td>"
     Else
            CrerDevisFour = CrerDevisFour & vbCrLf & Rs!QtsDispo & "</td>"
            CrerDevisFour = CrerDevisFour & vbCrLf & "          <td>" & Rs!qte_produit - (Rs!QtsDispo + Rs!Reste) & "</td>"

     End If
 End If
    End If
    Rs.MoveNext
Wend
 CrerDevisFour = CrerDevisFour & vbCrLf & "                  </tr>"
Sql = "SELECT T_Frais_Transport.Frais From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "'  "
Sql = Sql & "AND T_Frais_Transport.Frais<>0;"
Set RsCommande = Conn.Execute(Sql)
If RsCommande.EOF = False Then
TotalHt = TotalHt + RsCommande("Frais")
    CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
'    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >Fais de transport</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" colspan=""4"">Fais de transport</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & RsCommande("Frais") & "</td>"
    If IsAdmin = True Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >&nbsp</td>"
     CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >&nbsp</td>"
    End If
    CrerDevisFour = CrerDevisFour & vbCrLf & "                  </tr>"
End If


CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" colspan=""4"">Total H.T</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & TotalHt & "</td>"
    If IsAdmin = True Then
        CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >&nbsp</td>"
         CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >&nbsp</td>"
    End If
    CrerDevisFour = CrerDevisFour & vbCrLf & "                  </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"

If IsAdmin = True And Bl = False Then
If UCase(RsLiv!ModeTransport) = UCase(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact")))) Then


CrerDevisFour = CrerDevisFour & vbCrLf & "<br>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Frais de transport.</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevisFour = CrerDevisFour & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</table>"
CrerDevisFour = CrerDevisFour & vbCrLf & ""

CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Transporteur")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence du Colis")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("T&eacute;l&eacute;phone")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "    </tr>"

Sql = "SELECT T_Frais_Transport.Tansporteur, T_Frais_Transport.Frais, T_Frais_Transport.Reference, "
Sql = Sql & "T_Frais_Transport.Telephone From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
 Set RsCommande = Conn.Execute(Sql)
 If RsCommande.EOF = False Then
    NamTansport = "" & RsCommande("Tansporteur")
    RefTansport = "" & RsCommande("Reference")
    TelTansport = "" & RsCommande("Telephone")
    ValTansport = "" & RsCommande("Frais")
    
    
 End If
 RsCommande.Close
 Set RsCommande = Nothing

If Session("candidat_UserType") = "Administrator" Then
    CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""NamTansport"" size=""100%"" Value=""" & NamTansport & """> </td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center""><input type=""text"" name=""RefTansport"" size=""15%"" Value=""" & RefTansport & """ ></td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""TelTansport"" size=""15%"" Value=""" & TelTansport & """></td>"
'    CrerDevisFour = CrerDevisFour & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""15%"" Value=""" & ValTansport & """></td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                  </tr>"
Else
     CrerDevisFour = CrerDevisFour & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & NamTansport & "</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"">" & RefTansport & "</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                    "
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & TelTansport & "</td>"
'    CrerDevisFour = CrerDevisFour & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "          <td align=""center"" >" & ValTansport & "</td>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "                  </tr>"
End If
     CrerDevisFour = CrerDevisFour & vbCrLf & "                  </Table>"
    
  
End If
 If Session("candidat_UserType") = "Administrator" Then
  CrerDevisFour = CrerDevisFour & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
  CrerDevisFour = CrerDevisFour & vbCrLf & " <td align=""right"" ><a href='javascript:ValideBl();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Livraison.GIF"" border=""0""></a>&nbsp&nbsp&nbsp"
  CrerDevisFour = CrerDevisFour & vbCrLf & " <a href='javascript:this.document.MAJPrixLiveraison.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a></TD><tr>"
    CrerDevisFour = CrerDevisFour & vbCrLf & "</Table>"
    End If
     CrerDevisFour = CrerDevisFour & vbCrLf & "          <input type=""hidden"" name =""NumLigne"" value=""" & NumLigne & """>"
     CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""TypeLiv"" value="""">"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""mode""  value= ""HISTORIQUE_Eboutique_Affiche_Commande"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""Maj""  value= ""Prix"">"
CrerDevisFour = CrerDevisFour & vbCrLf & "  <input type=""hidden"" name=""RefCommande""  value= """ & numDevis & """ > "

CrerDevisFour = CrerDevisFour & vbCrLf & "</Form >"
    
    End If
  RsLiv.Close
Set RsLiv = Nothing


CrerDevisFour = CrerDevisFour & vbCrLf & "</td><td background=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
CrerDevisFour = CrerDevisFour & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</tr></table>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</body>"
CrerDevisFour = CrerDevisFour & vbCrLf & "</html>"
Rs.Close
Set Rs = Nothing
End Function
Private Function CrerFacture(id_Avenant, NumFacture, Conn)
Dim Sql As String
Dim Rs As Recordset
Dim UpdateDevis As Boolean
Dim RsCommande As Recordset
Dim My_NumCommande As String
Dim My_Num_Avoire As Long
Dim NumLigne As Long
Dim Id_Avoire As Long
Dim ValSolde As Double
Dim MyTotal As Double

  
   
 Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays,  t_R_Social.SocieteId "
Sql = Sql & "FROM Users INNER JOIN ((t_R_Social INNER  "
Sql = Sql & "JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) INNER  "
Sql = Sql & "JOIN (T_Num_Commande INNER  "
Sql = Sql & "JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "ON t_R_Social.SocieteId = T_Num_Commande.IdSociete)  "
Sql = Sql & "ON Users.Id_Societes = t_R_Social.SocieteId "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & id_Avenant & " ;"


Set Rs = Conn.Execute(Sql)
CrerFacture = ""
CrerFacture = CrerFacture & vbCrLf & "<html>"


CrerFacture = CrerFacture & vbCrLf & "<head>"
CrerFacture = CrerFacture & vbCrLf & "<title>Facture N° " & NumFacture & "</title>"
CrerFacture = CrerFacture & vbCrLf & "<SCRIPT LANGUAGE=""JAVASCRIPT""> "
CrerFacture = CrerFacture & vbCrLf & "function Imprimer(){"
        CrerFacture = CrerFacture & vbCrLf & "document.getElementById(""PRINT"").style.display = 'none';"
        CrerFacture = CrerFacture & vbCrLf & "window.print();"
         CrerFacture = CrerFacture & vbCrLf & "   document.getElementById(""PRINT"").style.display ='block';"
        CrerFacture = CrerFacture & vbCrLf & ""
        CrerFacture = CrerFacture & vbCrLf & "}"
CrerFacture = CrerFacture & vbCrLf & "function ApercuFacture() {"

CrerFacture = CrerFacture & vbCrLf & "window.open('contactSansMenu.asp?mode=HISTORIQUE_Eboutique_Affiche_Facture&ID=" & id_Avenant & "&Print=OK&ModeFacture=" & Request("ModeFacture") & "&RefFacture=" & NumFacture & "');"
CrerFacture = CrerFacture & vbCrLf & "}"

CrerFacture = CrerFacture & vbCrLf & "function MailCommade() {"

CrerFacture = CrerFacture & vbCrLf & "window.open('contactSansMenu.asp?mode=CrerFacture&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "');"
CrerFacture = CrerFacture & vbCrLf & "}"

CrerFacture = CrerFacture & vbCrLf & "</script>"
CrerFacture = CrerFacture & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
CrerFacture = CrerFacture & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
CrerFacture = CrerFacture & vbCrLf & ""
CrerFacture = CrerFacture & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"

CrerFacture = CrerFacture & vbCrLf & "<div align=""right""><br>"
CrerFacture = CrerFacture & vbCrLf & "<table width=""15%""><tr>"

If Request("Print") = "" Then
    CrerFacture = CrerFacture & vbCrLf & "<td width=""47"">" & AfficheBounton("Aperçu", "PRINT", "'javascript:ApercuFacture();'") & "</td>"
'    CrerFacture = CrerFacture & vbCrLf & "<td width=""50""><img  src=""" & Session("contact_devis")
'    CrerFacture = CrerFacture & vbCrLf & "louperd.gif"" width=""47"" height=""50"" /  OnClick=""ApercuFacture();"" id=""PRINT""></td>"
Else
    CrerFacture = CrerFacture & vbCrLf & "<td width=""47"">" & AfficheBounton("Imprimer", "PRINT", "'javascript:Imprimer();'") & "</td>"
'    CrerFacture = CrerFacture & vbCrLf & "<td width=""50%""><img  src=""" & Session("contact_devis")
'        CrerFacture = CrerFacture & vbCrLf & "PRINT.gif"" width=""67"" height=""70"" /  OnClick=""Imprimer();"" id=""PRINT""></td>"
End If
CrerFacture = CrerFacture & vbCrLf & "</tr></table></div>"""



CrerFacture = CrerFacture & vbCrLf & "<center><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "logo.gif"" border=""0"" ></center><br>"

CrerFacture = CrerFacture & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> </tr>"
CrerFacture = CrerFacture & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
CrerFacture = CrerFacture & vbCrLf & "<td background=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
CrerFacture = CrerFacture & vbCrLf & "<tr><td background=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgh2.gif"">"
CrerFacture = CrerFacture & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">R&eacute;capitulatif de votre Facture</font></b></font>"
CrerFacture = CrerFacture & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
CrerFacture = CrerFacture & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
CrerFacture = CrerFacture & vbCrLf & "</tr><tr>"
CrerFacture = CrerFacture & vbCrLf & "<td background=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
CrerFacture = CrerFacture & vbCrLf & "<td bgcolor=""#EBE3D7"">"

'CrerFacture = CrerFacture & vbCrLf & AfficheAvenant(numDevis)
'If Session("ModeFacture") = "TRUE" Then
'CrerFacture = CrerFacture & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
'If Bl = False Then
'    If Request("ApprecuBL") = "" Then
'    CrerFacture = CrerFacture & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Commande&Id=" & Session("IdAvoire") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD></tr>"
'  End If
'  Else
'    If Request("ApprecuBL") = "" Then
'      CrerFacture = CrerFacture & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & Session("RefCommande") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD></tr>"
'    End If
'  End If
'    CrerFacture = CrerFacture & vbCrLf & "</Table>"
'End If
CrerFacture = CrerFacture & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerFacture = CrerFacture & vbCrLf & "    <tr>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""ecomtitrecaddie2"" >R&eacute;f&eacute;rence &agrave; rappeler  </td>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "banded.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
Sql = "SELECT T_Num_Commande.NumCommande, Users.NumIndiveClient "
Sql = Sql & "FROM Users INNER JOIN (T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande) ON Users.Id_Societes = T_Num_Commande.IdSociete "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & id_Avenant & ";"



Sql = "SELECT T_Num_Commande.NumCommande, t_R_Social.NumIndiveClient "
Sql = Sql & "FROM t_R_Social INNER JOIN ((Users INNER JOIN T_Num_Commande ON Users.Id_Societes =  "
Sql = Sql & "T_Num_Commande.IdSociete) INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
Sql = Sql & "T_Avoire.IdNumCommande) ON t_R_Social.SocieteId = Users.Id_Societes "
Sql = Sql & "WHERE T_Avoire.IdAvoire=" & id_Avenant & ";"

Set RsLiv = Conn.Execute(Sql)
'
CrerFacture = CrerFacture & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"


CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Num&eacute;ro de Client</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> "
CrerFacture = CrerFacture & vbCrLf & RsLiv!NumIndiveClient
CrerFacture = CrerFacture & vbCrLf & "</td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"

CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Num&eacute;ro de Commande</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> "
CrerFacture = CrerFacture & vbCrLf & RsLiv!NumCommande
CrerFacture = CrerFacture & vbCrLf & "</td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"

CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>N°de Facture</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> "
CrerFacture = CrerFacture & vbCrLf & NumFacture
CrerFacture = CrerFacture & vbCrLf & "</td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>En Date du </td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> "

CrerFacture = CrerFacture & vbCrLf & CovertCommDate("" & NumFacture)
CrerFacture = CrerFacture & vbCrLf & "</td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
CrerFacture = CrerFacture & vbCrLf & "<br>"
'
'

CrerFacture = CrerFacture & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerFacture = CrerFacture & vbCrLf & "    <tr>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Nous Contacter</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "banded.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
CrerFacture = CrerFacture & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerFacture = CrerFacture & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Service technique </td>"
CrerFacture = CrerFacture & vbCrLf & "        <td><A href='mailto:" & GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))) & "'>" & GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))) & "</A></td>"
CrerFacture = CrerFacture & vbCrLf & "   </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
CrerFacture = CrerFacture & vbCrLf & "<br>"
'
'
'
'
'
'
CrerFacture = CrerFacture & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerFacture = CrerFacture & vbCrLf & "    <tr>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Coordonn&eacute;es du demandeur</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "banded.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
CrerFacture = CrerFacture & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerFacture = CrerFacture & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Nom / Pr&eacute;nom</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td>" & Rs!LastName & " " & Rs!FirstName & "</td>"
CrerFacture = CrerFacture & vbCrLf & "   </tr>"
CrerFacture = CrerFacture & vbCrLf & "    "
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Soci&eacute;t&eacute;</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td >" & Rs!fld3 & "</td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & ""
CrerFacture = CrerFacture & vbCrLf & "    "
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td >Adresse</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td>" & Rs!Address & "</td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & ""
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>CP</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td>" & Rs!Zip & "</td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & ""
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td >Ville / Pays</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td>" & Rs!City & " " & Rs!label_pays & "</td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "    "
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>Email</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> <A href='mailto:" & Rs!EMail & "'>" & Rs!EMail & "</A></td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerFacture = CrerFacture & vbCrLf & "        <td>T&eacute;l&eacute;phone / Fax</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td> "
                                            If Trim("" & Rs!phone) <> "" Then
CrerFacture = CrerFacture & vbCrLf & Rs!phone
                                                If Trim("" & Rs!fax) <> "" Then
CrerFacture = CrerFacture & vbCrLf & "          / " & Rs!fax
                                                End If
                                            Else
                                                If Trim("" & Rs!fax) = "" Then
CrerFacture = CrerFacture & vbCrLf & Rs!fax
                                                Else
CrerFacture = CrerFacture & vbCrLf & "&nbsp;"
                                                End If
                                            End If
CrerFacture = CrerFacture & vbCrLf & "</td> "
CrerFacture = CrerFacture & vbCrLf & "    </tr>"







CrerFacture = CrerFacture & vbCrLf & "</table>"
CrerFacture = CrerFacture & vbCrLf & "<br>"
CrerFacture = CrerFacture & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerFacture = CrerFacture & vbCrLf & "    <tr>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""ecomtitrecaddie2"" >* R&eacute;capitulatif des commandes</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerFacture = CrerFacture & vbCrLf & "banded.gif"" border=""0""></td>"
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "</table>"
'CrerFacture = CrerFacture & vbCrLf & "</td> "
'CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "<table border='0' cellspacing='3' cellpadding='0' width='100%'>    <tr>"
Sql = ""
CrerFacture = CrerFacture & vbCrLf & "    <tr>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("N° De Commande ")) & "</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("T.V.A. %")) & "</td>"
CrerFacture = CrerFacture & vbCrLf & "       <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("T.V.A. ")) & "</td>"
CrerFacture = CrerFacture & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.T.T.C. ")) & "</td>"


CrerFacture = CrerFacture & vbCrLf & ""
CrerFacture = CrerFacture & vbCrLf & "    </tr>"
CrerFacture = CrerFacture & vbCrLf & "<Form Name=""MAJPrixLiveraison""  method=""post"" >"
CrerFacture = CrerFacture & vbCrLf & "<input type=""hidden"" name=""CreateBl"" value="""" >"
Sql = " "
Sql = Sql & "SELECT T_Facturation_Cli.NumCammande, ([RestePayer]+[Frais])/(1+([tva]/100)) AS RestePayers,  "
Sql = Sql & "T_Facturation_Cli.TVA, ([RestePayer]+[Frais])-(([RestePayer]+[Frais])/(1+([tva]/100))) AS PrixTva,  "
Sql = Sql & "[RestePayer]+[Frais] AS PrixTTC "
Sql = Sql & "From T_Facturation_Cli "
Sql = Sql & "WHERE T_Facturation_Cli.NumFacture='" & NumFacture & "';"


Set Rs = Conn.Execute(Sql)

TotalHt = 0
RestePayer = 0
PrixTva = 0
PrixTTC = 0

While Rs.EOF = False

    If Session("candidat_UserType") = "Administrator" Then
        CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""10%"">"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & Rs!NumCammande & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & Rs!RestePayers, 3) & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & Rs!tva & "%</td>"
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & Rs!PrixTva, 3) & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Rs!PrixTTC, 3) & "</td>"
       
    Else
         CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""10%"">"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & Rs!NumCammande & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & Rs!RestePayers, 3) & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "                    "
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Rs!tva, 3) & "%</td>"
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & Rs!PrixTva, 3) & "</td>"
        CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Rs!PrixTTC, 3) & "</td>"
       
    End If
                         

    
    NumLigne = NumLigne + 1
    
        
        RestePayer = RestePayer + Rs!RestePayers
        PrixTva = PrixTva + Rs!PrixTva
        PrixTTC = PrixTTC + Rs!PrixTTC
   
  

    Rs.MoveNext
Wend
  If Session("candidat_UserType") = "Administrator" Then
   

    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">Total</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & RestePayer, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >&nbsp;</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & PrixTva, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & PrixTTC, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    
    Sql = "SELECT T_Avoire.Credit  From T_Avoire "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & id_Avenant & ";"
    Set Rs = Conn.Execute(Sql)
    
    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" colspan=""4"">D&eacutej&agrave; Pay&eacute;</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Rs!Credit, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" colspan=""4"">Reste &agrave; Payer</td>"
    ResetPayer = Rs!Credit - PrixTTC
    If ResetPayer > 0 Then ResetPayer = 0
    
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Abs(ResetPayer), 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    CrerFacture = CrerFacture & vbCrLf & "</table>"
Else


    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">Total</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & Abs(RestePayer), 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >&nbsp;</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"">" & FomatNum("" & PrixTva, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & PrixTTC, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    
    Sql = "SELECT T_Avoire.Credit  From T_Avoire "
    Sql = Sql & "WHERE T_Avoire.IdAvoire=" & id_Avenant & ";"
    Set Rs = Conn.Execute(Sql)
    
    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" colspan=""4"">D&eacutej&agrave; Pay&eacute;</td>"
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Rs!Credit, 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    CrerFacture = CrerFacture & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerFacture = CrerFacture & vbCrLf & "                    "
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" colspan=""4"">Reste &agrave; Payer</td>"
    ResetPayer = Rs!Credit - PrixTTC
    If ResetPayer > 0 Then ResetPayer = 0
    
    CrerFacture = CrerFacture & vbCrLf & "          <td align=""center"" >" & FomatNum("" & Abs(ResetPayer), 3) & "</td>"
    CrerFacture = CrerFacture & vbCrLf & "                  </tr>"
    CrerFacture = CrerFacture & vbCrLf & "</table>"
End If
CrerFacture = CrerFacture & vbCrLf & "<br> " & GetDefault("InfoFacture", "* Reportez vous à vos différentes commandes ou connectez vous Sur notre site web &agrave; la rubrique Outil, Historique, Commandes.", OpenDb(DsnTableMenu(Session("candidat_ADOContact"))))

 

CrerFacture = CrerFacture & vbCrLf & "</td><td background=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
CrerFacture = CrerFacture & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
CrerFacture = CrerFacture & vbCrLf & "<td background=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
CrerFacture = CrerFacture & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
CrerFacture = CrerFacture & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
CrerFacture = CrerFacture & vbCrLf & "</tr></table>"
CrerFacture = CrerFacture & vbCrLf & "</body>"
CrerFacture = CrerFacture & vbCrLf & "</html>"
Rs.Close
Set Rs = Nothing
End Function
Private Function CrerDevis(id_livraison, UserID, Conn, numDevis, NousContacter, Optional IsAdmin As Boolean, Optional Bl As Boolean, Optional NumBl As String, Optional VisuBl As Boolean)
Dim Sql As String
Dim Rs As Recordset
Dim UpdateDevis As Boolean
Dim RsCommande As Recordset
Dim My_NumCommande As String
Dim My_Num_Avoire As Long
Dim NumLigne As Long
Dim Id_Avoire As Long
Dim ValSolde As Double
Dim MyTotal As Double
Dim BlExiste As Boolean
Dim TotalPrixProduit As Double
Dim ChangePrix As Boolean
Dim Remise As Double
Dim TotalPrixU_produit As Double
Dim tva As Double
Dim TotalTVA As Double
Dim ttc As Double
Dim PrixU_produit As Double
'         TotalTva_Total = TotalTVA + TotalTva_Total
Dim TotalTTC As Double
CrerDevis = ""
If Request("CreateBl") <> "" Then Bl = True
Sql = "SELECT t_Devis.Id_Avoire From t_Devis "
        Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"
        Set RsCommande = Conn.Execute(Sql)
        idavoir = RsCommande!Id_Avoire
        RsCommande.Close
        Set RsCommande = Nothing

If Bl = True And Trim("" & NumBl) = "" Then
'            Wend
If val(Request("NumLigne")) > 0 Then
 If Request("Maj") = "Liv" Then
    Sql = "SELECT T_Frais_Transport.Frais From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
    If RsCommande.EOF = False Then
        Sql = "UPDATE T_Avoire  "
        Sql = Sql & "SET T_Avoire.Debit = [Debit]-" & Replace("" & RsCommande("Frais"), ",", ".") & " "
        Sql = Sql & "WHERE T_Avoire.IdAvoire = " & idavoir & ";"
        Conn.Execute Sql
    End If
     RsCommande.Close
    Set RsCommande = Nothing

    Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.ModeTransport = '" & replaceAccent(Request("TypeLiv"), True, True) & "' "
    Sql = Sql & ", T_Frais_Transport.Tansporteur = Null, T_Frais_Transport.Frais = 0, T_Frais_Transport.Reference = Null, T_Frais_Transport.Telephone = Null "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
End If

If Request("Maj") = "Prix" Then
        For I = 1 To val(Request("NumLigne"))
            Sql = "UPDATE t_Devis SET t_Devis.QtsDispo =  " & val("" & Request("Dispo_" & I)) & ", t_Devis.qte_produit =" & Request("L_qte_produit_" & I) & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            Sql = "UPDATE t_Devis SET t_Devis.PrixU_produit =  " & Replace("" & Request("L_PrixU_produit_" & I), ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            PrixT = val(Replace("" & Request("L_PrixU_produit_Avant_" & I), ",", ".")) * val(Request("L_QTS_" & I))
            Prix = PrixT * (1 / 100) * val(Replace("" & Request("L_TVA_" & I), ",", "."))
            Prix = Prix + PrixT
            
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]- " & Replace("" & Prix, ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
             PrixT = val(Replace("" & Request("L_PrixU_produit_" & I), ",", ".")) * val(Request("L_qte_produit_" & I))
            Prix = PrixT * (1 / 100) * val(Replace("" & Request("L_TVA_" & I), ",", "."))
            Prix = Prix + PrixT
            
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]+ " & Replace("" & Prix, ",", ".") & "  "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
        Next
        Sql = "SELECT T_Frais_Transport.Frais , T_Frais_Transport.tva From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
        If RsCommande.EOF = False Then
        tva = val(Replace("" & RsCommande("tva"), ",", "."))
        FraisT = val(Replace("" & RsCommande("Frais"), ",", "."))
        Frais = FraisT * (1 / 100) * val(Replace("" & tva, ",", "."))
        Frais = FraisT + Frais
            Sql = "UPDATE T_Avoire "
            Sql = Sql & " SET T_Avoire.Debit = [Debit]-" & Replace("" & Frais, ",", ".") & " "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & idavoir & ";"
            Conn.Execute Sql
        End If
  
        FraisT = val(Replace("" & Request("ValTansport"), ",", "."))
       Frais = FraisT * (1 / 100) * val(Replace("" & tva, ",", "."))
       Frais = FraisT + Frais
Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,[Credit]-[Debit] as reste,  "
Sql = Sql & "[Credit]-[Debit]-" & val(Replace("" & Frais, ",", ".")) & "  AS Solde , T_Avoire.Facturer "
Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis) "
Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
        
Reprise:
   Set RsCommande = Conn.Execute(Sql)
   If RsCommande.EOF = True Then
        Sql = "UPDATE T_Avoire SET T_Avoire.Cloturer = True WHERE T_Avoire.IdAvoire=" & Id_Avoire & ";"
        Conn.Execute Sql
        Sql = "SELECT T_Num_Commande.NumCommande, Count(T_Avoire.NumAvoire) AS CompteDeNumAvoire  "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
        Sql = Sql & "T_Avoire.IdNumCommande "
        Sql = Sql & "GROUP BY T_Num_Commande.NumCommande "
        Sql = Sql & "HAVING T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
        Set RsCommande = Conn.Execute(Sql)
        
        If RsCommande.EOF = False Then
            My_Num_Avoire = RsCommande("CompteDeNumAvoire")
            Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Credit ) "
            Sql = Sql & "SELECT T_Num_Commande.IdNumCommande, " & RsCommande("CompteDeNumAvoire") & " AS NumAvoire, " & noquoteNum(ValSolde) & " AS Credit From T_Num_Commande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
            Conn.Execute Sql
            
                  Sql = "UPDATE T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
            Sql = Sql & "T_Avoire.IdNumCommande SET T_Avoire.Cloturer = True, T_Avoire.Debit = [T_Avoire].[Credit] "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'  "
            Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire - 1 & ";"
            Conn.Execute Sql
            
            
            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'"
            Sql = Sql & "AND T_Avoire.Cloturer=False;"
             Set RsCommande = Conn.Execute(Sql)
             If RsCommande.EOF = False Then
                    Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " "
                    Sql = Sql & " WHERE t_Devis.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
                    Conn.Execute Sql
              End If

         
             


            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-[Debit]-" & val("" & Request("ValTansport")) & " AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire & ";"
        UpdateDevis = True
        GoTo Reprise
        End If
   
    Else
        If RsCommande("Solde") < 0 And RsCommande("Facturer") = True Then
        ValSolde = RsCommande("reste")
        Id_Avoire = RsCommande("IdAvoire")
        My_NumCommande = RsCommande("NumCommande")
        Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-[Debit]-" & Replace("" & Frais, ",", ".") & " AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & RsCommande("NumAvoire") + 1 & ";"
        UpdateDevis = True
        GoTo Reprise
    Else
        If UpdateDevis = True Then
            UpdateDevis = False
            Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " WHERE t_Devis.numDevis='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "';"
            Conn.Execute Sql
        End If
    End If
    
    
   End If
        
        RsCommande.Close
        Set RsCommande = Nothing
        
         Sql = "UPDATE T_Avoire  "
            Sql = Sql & "SET T_Avoire.Debit = [Debit]+" & Replace("" & Frais, ",", ".") & " "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & idavoir & ";"
            Conn.Execute Sql
        
        Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.Tansporteur = '" & replaceAccent("" & Request("NamTansport"), True, True) & "',"
    Sql = Sql & "T_Frais_Transport.Frais = " & Replace(val(Replace("" & Request("ValTansport"), ",", ".")), ",", ".") & ", "
    Sql = Sql & "T_Frais_Transport.Reference = '" & replaceAccent("" & Request("RefTansport"), True, True) & "', "
    Sql = Sql & "T_Frais_Transport.Telephone = '" & replaceAccent("" & Request("TelTansport"), True, True) & "' "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
    End If
  Sql = "SELECT t_Devis.numDevis, [qte_produit]-[Reste] AS Solde From t_Devis "
    Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "' "
    Sql = Sql & "AND [qte_produit]-[Reste]>0;"
    If Session("SaveBl") = "" Then
    Session("SaveBl") = "Ok"
    Session("SaveBlReste") = ""
Set RsResteDevis = Conn.Execute(Sql)

If RsResteDevis.EOF = False Then
    Liv = NumeroChrono("BL", "BL_")
DoEvents

    For I = 1 To val(Request("NumLigne"))
        Sql = "SELECT [qte_produit]-([t_Devis].[Reste]+" & Request("Dispo_" & I) & ") As Solde From t_Devis WHERE t_Devis.Id=" & Request("L_" & I) & ";"
        Set RsSolde = Conn.Execute(Sql)
        Sql = "INSERT INTO T_Commande_Liv ( Id_Devis, qte_produit,  NumLiv,reste ) "
        Sql = Sql & "Values (" & Request("L_" & I) & ", " & Request("Dispo_" & I) & ", '" & Liv & "'," & RsSolde!Solde
        Sql = Sql & " ); "
         RsSolde.Close
         Set RsSolde = Nothing
        Conn.Execute Sql
        
        Sql = "UPDATE t_Devis SET t_Devis.QtsDispo = 0, t_Devis.Reste = [t_Devis].[Reste]+" & Request("Dispo_" & I) & " "
        Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & I) & ";"
     Conn.Execute Sql
    
    Next
        Response.Redirect "Contact.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & Liv & "&ModeFacture=" & Request("ModeFacture")
    Exit Function
    End If
    RsResteDevis.Close
    Set RsResteDevis = Nothing
        Response.Redirect "contact.asp?mode=HISTORIQUE_Eboutique_Commande&Id=" & Session("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & ""
         Exit Function
        Else
         Bl = False
    End If
    End If
    End If
Debug.Print Request("mode")

'IdSup
If Request("Maj") = "Sup" Then

    Sql = "SELECT  T_Avoire.IdNumCommande,([PrixU_produit]*[qte_produit])+(([PrixU_produit]*[qte_produit])*[TVA]*(1/100))  AS Solde "
    Sql = Sql & "FROM T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire "
    Sql = Sql & "WHERE t_Devis.Id=" & Request("IdSup") & ";"
Set rsSupArticle = Conn.Execute(Sql)
IdNumCommande = rsSupArticle!IdNumCommande
Solde = rsSupArticle!Solde
Sql = "SELECT Count([NumAvoire]) AS Compte From T_Avoire "
Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & IdNumCommande & ";"
Set rsSupArticle = Conn.Execute(Sql)
compte = rsSupArticle!compte - 1
rsSupArticle.Close
Set rsSupArticle = Nothing
Sql = "UPDATE T_Avoire SET T_Avoire.Credit = T_Avoire.Credit + " & Replace(Solde, ",", ".") & "  "
    Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & IdNumCommande & "  "
    Sql = Sql & "AND T_Avoire.NumAvoire=" & compte & ";"

'
'    Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire set T_Avoire.Debit = [Debit]-([PrixU_produit]*[qte_produit]) "
'    Sql = Sql & "WHERE t_Devis.Id=" & Request("IdSup") & ";"
    Conn.Execute Sql
            
Sql = "DELETE t_Devis.* From t_Devis "
Sql = Sql & "WHERE t_Devis.Id=" & Request("IdSup") & ";"
            Conn.Execute Sql
Sql = "SELECT t_Devis.* From t_Devis "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"
 Set RsDev = Conn.Execute(Sql)
 If RsDev.EOF = True Then
    Sql = "SELECT  [Frais]+([Frais]*[TVA]*(1/100)) AS Solde From T_Frais_Transport "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & numDevis & "';"
    Set RsFraisTransport = Conn.Execute(Sql)
    FraisTransport = RsFraisTransport!Solde
    RsFraisTransport.Close
    Set RsFraisTransport = Nothing
   
    Sql = "UPDATE T_Avoire SET T_Avoire.Credit = T_Avoire.Credit + " & Replace(FraisTransport, ",", ".") & "  "
    Sql = Sql & "WHERE T_Avoire.IdNumCommande=" & IdNumCommande & "  "
    Sql = Sql & "AND T_Avoire.NumAvoire=" & compte & ";"
    Conn.Execute Sql

    Sql = "DELETE T_Frais_Transport.* From T_Frais_Transport "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & numDevis & "';"
    Conn.Execute Sql
    Response.Redirect "Contact.asp?mode=HISTORIQUE_Compte_Detail&ID=" & Session("IdCommande") & "&ModeFacture=" & Request("ModeFacture")
    Exit Function
 End If

End If
If Request("Maj") = "Liv" And Bl = False Then
    Sql = "SELECT T_Frais_Transport.Frais From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
    If RsCommande.EOF = False Then
        Sql = "UPDATE T_Avoire  "
        Sql = Sql & "SET T_Avoire.Debit = [Debit]-" & Replace("" & RsCommande("Frais"), ",", ".") & " "
        Sql = Sql & "WHERE T_Avoire.IdAvoire = " & idavoir & ";"
        Conn.Execute Sql
    End If
     RsCommande.Close
    Set RsCommande = Nothing

    Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.ModeTransport = '" & replaceAccent(Request("TypeLiv"), True, True) & "' "
    Sql = Sql & ", T_Frais_Transport.Tansporteur = Null, T_Frais_Transport.Frais = 0, T_Frais_Transport.Reference = Null, T_Frais_Transport.Telephone = Null "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
End If

If Request("Maj") = "Prix" And Bl = False Then
        For I = 1 To val(Request("NumLigne"))
            Sql = "UPDATE t_Devis SET t_Devis.QtsDispo =  " & val("" & Request("Dispo_" & I)) & ", t_Devis.qte_produit =" & Request("L_qte_produit_" & I) & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            TotalPrixProduit = TotalPrixProduit + val(Replace("" & Request("L_PrixU_produit_" & I), ",", "."))
            Sql = "UPDATE t_Devis SET t_Devis.PrixU_produit =  " & Replace("" & Request("L_PrixU_produit_" & I), ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
              If Request("L_PrixU_produit_" & I) <> Request("L_PrixU_produit_Avant_" & I) Then ChangePrix = True
            PrixT = val(Replace("" & Request("L_PrixU_produit_Avant_" & I), ",", ".")) * val(Request("L_QTS_" & I))
            Prix = PrixT * (1 / 100) * val(Replace("" & Request("L_TVA_" & I), ",", "."))
            Prix = Prix + PrixT
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]- " & Replace("" & Prix, ",", ".") & "   "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
            
            
             PrixT = val(Replace("" & Request("L_PrixU_produit_" & I), ",", ".")) * val(Request("L_qte_produit_" & I))
            Prix = PrixT * (1 / 100) * val(Replace("" & Request("L_TVA_" & I), ",", "."))
            Prix = Prix + PrixT
            Sql = "UPDATE T_Avoire INNER JOIN t_Devis ON T_Avoire.IdAvoire = t_Devis.Id_Avoire SET T_Avoire.Debit = [Debit]+ " & Replace(Prix, ",", ".") & " "
            Sql = Sql & "WHERE t_Devis.Id=" & Request("L_" & CStr(I)) & ";"
            Conn.Execute Sql
        Next
        Sql = "SELECT T_Frais_Transport.Frais ,T_Frais_Transport.TVA From T_Frais_Transport WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
    Set RsCommande = Conn.Execute(Sql)
        If RsCommande.EOF = False Then
            Frais = RsCommande!Frais
            tva = RsCommande!tva
            TotalTVA = Frais * (1 / 100) * tva
            ttc = Frais + TotalTVA
            Sql = "UPDATE T_Avoire "
            'Replace("" & TotalPrixProduit + (TotalPrixProduit * (TVA / 100)), ",", ".") &
            Sql = Sql & " SET T_Avoire.Debit = [Debit]-" & " + " & Replace(val(Replace("" & ttc, ",", ".")), ",", ".") & " "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & idavoir & ";"
            Conn.Execute Sql
        End If
tva = val(GetDefault("TVA", "19.6", DsnTableMenu(Session("candidat_ADOContact"))))
Frais = val(Replace("" & Request("ValTansport"), ",", "."))
TotalTVA = Frais * (1 / 100) * tva
ttc = Frais + TotalTVA
Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,[Credit]-[Debit] as reste,  "
Sql = Sql & "[Credit]-[Debit]-" & Replace(val(Replace("" & ttc, ",", ".")), ",", ".") & "  AS Solde , T_Avoire.Facturer "
Sql = Sql & "FROM T_Num_Commande INNER JOIN (T_Avoire INNER JOIN (t_Devis INNER JOIN T_Frais_Transport  "
Sql = Sql & "ON t_Devis.numDevis = T_Frais_Transport.numDevis) "
Sql = Sql & "ON T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
        
Reprise2:
   Set RsCommande = Conn.Execute(Sql)
   If RsCommande.EOF = True Then
        Sql = "UPDATE T_Avoire SET T_Avoire.Cloturer = True WHERE T_Avoire.IdAvoire=" & Id_Avoire & ";"
        Conn.Execute Sql
        Sql = "SELECT T_Num_Commande.NumCommande, Count(T_Avoire.NumAvoire) AS CompteDeNumAvoire  "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
        Sql = Sql & "T_Avoire.IdNumCommande "
        Sql = Sql & "GROUP BY T_Num_Commande.NumCommande "
        Sql = Sql & "HAVING T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
        Set RsCommande = Conn.Execute(Sql)
        
        If RsCommande.EOF = False Then
            My_Num_Avoire = RsCommande("CompteDeNumAvoire")
            Sql = "INSERT INTO T_Avoire ( IdNumCommande, NumAvoire, Credit ) "
            If ChangePrix = False Then
                Sql = Sql & "SELECT T_Num_Commande.IdNumCommande, " & RsCommande("CompteDeNumAvoire") & " AS NumAvoire, " & noquoteNum(ValSolde + TotalPrixProduit + (TotalPrixProduit * tva / 100) + Frais + (Frais * tva / 100)) & " AS Credit From T_Num_Commande "
            Else
                Sql = Sql & "SELECT T_Num_Commande.IdNumCommande, " & RsCommande("CompteDeNumAvoire") & " AS NumAvoire, " & noquoteNum(ValSolde + TotalPrixProduit + (TotalPrixProduit * tva / 100)) & " AS Credit From T_Num_Commande "
            End If
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "';"
            Conn.Execute Sql
            
            Sql = "UPDATE T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande =  "
            Sql = Sql & "T_Avoire.IdNumCommande SET T_Avoire.Cloturer = True, T_Avoire.Debit = [T_Avoire].[Credit]   "
             
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'  "
            Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire - 1 & ";"
            Conn.Execute Sql
            
            
            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.Cloturer "
            Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
            Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & My_NumCommande, True, True) & "'"
            Sql = Sql & "AND T_Avoire.Cloturer=False;"
             Set RsCommande = Conn.Execute(Sql)
             If RsCommande.EOF = False Then
                    Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " "
                    Sql = Sql & " WHERE t_Devis.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
                    Conn.Execute Sql
                    Id_Avoire2 = RsCommande("IdAvoire")
              End If

         
             


            
            Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-([Debit]+" & Replace(val("" & Request("ValTansport")), ",", ".") & "+ 4.829)  AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & My_Num_Avoire & ";"
        UpdateDevis = True
        GoTo Reprise2
        End If
   
    Else
        If RsCommande("Solde") < 0 And RsCommande("Facturer") = True Then
        ValSolde = RsCommande("reste")
        Id_Avoire = RsCommande("IdAvoire")
        My_NumCommande = RsCommande("NumCommande")
        Sql = "SELECT T_Num_Commande.NumCommande, T_Avoire.IdAvoire, T_Avoire.NumAvoire,  "
        Sql = Sql & "[Credit]-[Debit]-" & Replace(val(Replace("" & Request("ValTansport"), ",", ".")), ",", ".") & " AS Solde, T_Avoire.Facturer,[Credit]-[Debit]   "
        Sql = Sql & "FROM T_Num_Commande INNER JOIN T_Avoire ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande "
        Sql = Sql & "WHERE T_Num_Commande.NumCommande='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "'    "
        Sql = Sql & "AND T_Avoire.NumAvoire=" & RsCommande("NumAvoire") + 1 & ";"
        UpdateDevis = True
        GoTo Reprise2
    Else
        If UpdateDevis = True Then
            UpdateDevis = False
            Sql = "UPDATE t_Devis SET t_Devis.Id_Avoire = " & RsCommande("IdAvoire") & " WHERE t_Devis.numDevis='" & replaceAccent("" & RsCommande("NumCommande"), True, True) & "';"
            Conn.Execute Sql
        End If
    End If
    
    
   End If
        
        RsCommande.Close
        Set RsCommande = Nothing
        If Trim("" & Id_Avoire2) <> "" Then
            idavoir = Id_Avoire2
           
                ttc = ttc + TotalPrixProduit + (TotalPrixProduit * tva / 100)
           
         End If
         Sql = "UPDATE T_Avoire  "
            Sql = Sql & "SET T_Avoire.Debit = [Debit]+" & Replace(val(Replace("" & ttc, ",", ".")), ",", ".") & " "
            Sql = Sql & "WHERE T_Avoire.IdAvoire=" & idavoir & ";"
            Session("IdAvoire") = idavoir
            Conn.Execute Sql
        
        Sql = "UPDATE T_Frais_Transport SET T_Frais_Transport.Tansporteur = '" & replaceAccent("" & Request("NamTansport"), True, True) & "',"
    Sql = Sql & "T_Frais_Transport.Frais = " & Replace(val(Replace("" & Request("ValTansport"), ",", ".")), ",", ".") & ", "
    Sql = Sql & "T_Frais_Transport.Reference = '" & replaceAccent("" & Request("RefTansport"), True, True) & "', "
    Sql = Sql & "T_Frais_Transport.Telephone = '" & replaceAccent("" & Request("TelTansport"), True, True) & "', "
    Sql = Sql & "T_Frais_Transport.TVA = " & Replace("" & tva, ",", ".") & " "
    Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
     Conn.Execute (Sql)
    End If
 Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = "
 Sql = Sql & "Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & UserID & ";"
 
 Sql = "SELECT Users_1.*, t_R_Social.*, t_pays.label_pays "
 Sql = Sql & "FROM (Users INNER JOIN Users AS Users_1 ON Users.Id_Societes = Users_1.Id_Societes) INNER JOIN  "
 Sql = Sql & "(t_R_Social INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays) ON Users_1.UserID = t_R_Social.Id_Contact "
 Sql = Sql & "WHERE Users.UserID=" & Session("UserID") & ";"

Set Rs = Conn.Execute(Sql)
CrerDevis = ""
CrerDevis = CrerDevis & vbCrLf & "<html>"
If Session("candidat_UserType") = "Administrator" Then
CrerDevis = CrerDevis & vbCrLf & "<script language='javascript' src='../Portal_Java/FunJava.js'></script>"
CrerDevis = CrerDevis & vbCrLf & "<SCRIPT LANGUAGE=""JAVASCRIPT""> "

CrerDevis = CrerDevis & vbCrLf & "function ValideQtsPrix(L){"
'CrerDevis = CrerDevis & vbCrLf & " alert('');"
CrerDevis = CrerDevis & vbCrLf & "var PrixU;"
CrerDevis = CrerDevis & vbCrLf & "PrixU =  document.forms['MAJPrixLiveraison'].elements['L_PrixU_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "var QTS;"
CrerDevis = CrerDevis & vbCrLf & "QTS =  document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "var THT;"
CrerDevis = CrerDevis & vbCrLf & "THT =  document.forms['MAJPrixLiveraison'].elements['L_Prix_THT_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "if (IsNumeric2(Remplacer(PrixU.value,"","","".""))==false){"
CrerDevis = CrerDevis & vbCrLf & "    alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "    var PrixU_Av"
CrerDevis = CrerDevis & vbCrLf & "    PrixU_Av = document.forms['MAJPrixLiveraison'].elements['L_PrixU_produit_Avant_'+L];"
CrerDevis = CrerDevis & vbCrLf & "    PrixU.value=PrixU_Av.value;"
CrerDevis = CrerDevis & vbCrLf & "   PrixU.focus();"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "THT.value =QTS.value*Remplacer(PrixU.value,"","",""."")"
CrerDevis = CrerDevis & vbCrLf & "}"

CrerDevis = CrerDevis & vbCrLf & "function ValideQts(L){"
CrerDevis = CrerDevis & vbCrLf & "var QtsChange;"
CrerDevis = CrerDevis & vbCrLf & "QtsChange = document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "var QTS;"
CrerDevis = CrerDevis & vbCrLf & "QTS = document.forms['MAJPrixLiveraison'].elements['L_QTS_'+L];"
CrerDevis = CrerDevis & vbCrLf & "var Reste;"
CrerDevis = CrerDevis & vbCrLf & "Reste = document.forms['MAJPrixLiveraison'].elements['txt_Reste_'+L];"
CrerDevis = CrerDevis & vbCrLf & "if (!testEntier(QtsChange.value)){"

CrerDevis = CrerDevis & vbCrLf & "    alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "   Err='Err';"
'CrerDevis = CrerDevis & vbCrLf & "    return;"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "var Err='Err' "
CrerDevis = CrerDevis & vbCrLf & " Err=funMath(QtsChange.value,Reste.value,'-',false)     "
'CrerDevis = CrerDevis & vbCrLf & "alert(Err);"
CrerDevis = CrerDevis & vbCrLf & "  if (Err<0) {"
CrerDevis = CrerDevis & vbCrLf & "      if (funMath(Reste.value,Err,'+',false)<0){"

CrerDevis = CrerDevis & vbCrLf & "      alert('" & GetMessage("QuantitéTenirCommteQuantiteLivree.", "La quantité saisie doit tenir compte de la quantité déjà livrée.", DsnTableMenu(Session("candidat_ADOContact"))) & "'); "
CrerDevis = CrerDevis & vbCrLf & "  Err='Err';"
CrerDevis = CrerDevis & vbCrLf & "      }"
CrerDevis = CrerDevis & vbCrLf & "  }"
CrerDevis = CrerDevis & vbCrLf & "  if (Err=='Err') {"
CrerDevis = CrerDevis & vbCrLf & "    QtsChange.value=QTS.value;"
'CrerDevis = CrerDevis & vbCrLf & "   return;"
CrerDevis = CrerDevis & vbCrLf & "   }"
CrerDevis = CrerDevis & vbCrLf & "   ValideQtsPrix(L);"
CrerDevis = CrerDevis & vbCrLf & "  "
CrerDevis = CrerDevis & vbCrLf & "FunReste2(L);"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "function Isdouble(Obj){"
CrerDevis = CrerDevis & vbCrLf & "  var MyObj;"
CrerDevis = CrerDevis & vbCrLf & "  MyObj = document.forms['MAJPrixLiveraison'].elements[Obj];"
CrerDevis = CrerDevis & vbCrLf & "   MyObj.value=Remplacer(jsTrim(MyObj.value),',','.');"
CrerDevis = CrerDevis & vbCrLf & "  if (!testFloat(MyObj.value)) {"
CrerDevis = CrerDevis & vbCrLf & "       alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "       MyObj.value='';"
CrerDevis = CrerDevis & vbCrLf & "       return;"
CrerDevis = CrerDevis & vbCrLf & "   }"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "function IsNumeric2(sText){"
'AfficheAvenant = AfficheAvenant & vbCrLf & "//vérifie si la chaine envoyée est de type numérique"
'AfficheAvenant = AfficheAvenant & vbCrLf & "{"
CrerDevis = CrerDevis & vbCrLf & "   var ValidChars = ""0123456789."";"
CrerDevis = CrerDevis & vbCrLf & "   var IsNumber=true;"
CrerDevis = CrerDevis & vbCrLf & "   var Char;"
CrerDevis = CrerDevis & vbCrLf & "  "
CrerDevis = CrerDevis & vbCrLf & " "
CrerDevis = CrerDevis & vbCrLf & "   for (i = 0; i < sText.length && IsNumber == true; i++)"
CrerDevis = CrerDevis & vbCrLf & "     {"
CrerDevis = CrerDevis & vbCrLf & "      Char = sText.charAt(i);"
CrerDevis = CrerDevis & vbCrLf & "      if (ValidChars.indexOf(Char) == -1)"
CrerDevis = CrerDevis & vbCrLf & "         {"
CrerDevis = CrerDevis & vbCrLf & "         IsNumber = false;"
CrerDevis = CrerDevis & vbCrLf & "         }"
CrerDevis = CrerDevis & vbCrLf & "      }"
CrerDevis = CrerDevis & vbCrLf & "   return IsNumber;"
CrerDevis = CrerDevis & vbCrLf & "    "
 CrerDevis = CrerDevis & vbCrLf & "  }"



CrerDevis = CrerDevis & vbCrLf & ""

'CrerDevis = CrerDevis & vbCrLf & "function Remplacer(Txt,C,R){"
'CrerDevis = CrerDevis & vbCrLf & "var a, tmp;"
'CrerDevis = CrerDevis & vbCrLf & "tmp = '';"
'CrerDevis = CrerDevis & vbCrLf & "a = Txt;"
'CrerDevis = CrerDevis & vbCrLf & "  "
'CrerDevis = CrerDevis & vbCrLf & "for(var i = 0; i < a.length; i++)"
'CrerDevis = CrerDevis & vbCrLf & "{"
'CrerDevis = CrerDevis & vbCrLf & ""
'CrerDevis = CrerDevis & vbCrLf & "  "
'CrerDevis = CrerDevis & vbCrLf & "    if (a.charAt(i) ==  C)"
'CrerDevis = CrerDevis & vbCrLf & "    {"
'CrerDevis = CrerDevis & vbCrLf & "    tmp = tmp + R;"
'CrerDevis = CrerDevis & vbCrLf & "    } else{"
'CrerDevis = CrerDevis & vbCrLf & "        tmp = tmp + a.charAt(i);"
'CrerDevis = CrerDevis & vbCrLf & "    }"
'CrerDevis = CrerDevis & vbCrLf & "}"
'CrerDevis = CrerDevis & vbCrLf & "  "
'CrerDevis = CrerDevis & vbCrLf & "return  tmp;"
''CrerDevis = CrerDevis & vbCrLf & "alert(a);"
'CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "function ValideLivraison(Txt){"
'CrerDevis = CrerDevis & vbCrLf & "alert(this.document.MAJLiveraison.zzz.value);"
CrerDevis = CrerDevis & vbCrLf & "this.document.MAJLiveraison.TypeLiv.value=Txt;"
CrerDevis = CrerDevis & vbCrLf & "this.document.MAJLiveraison.ACTION=""Contact.asp"";"
CrerDevis = CrerDevis & vbCrLf & "this.document.MAJLiveraison.submit();"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "function SuppirmerArticle(L){"
CrerDevis = CrerDevis & vbCrLf & "var L_RefProduit;"
CrerDevis = CrerDevis & vbCrLf & "var IdSource;"
CrerDevis = CrerDevis & vbCrLf & "var IdCible;"
CrerDevis = CrerDevis & vbCrLf & "IdSource= document.forms['MAJPrixLiveraison'].elements['L_'+L];"
CrerDevis = CrerDevis & vbCrLf & "IdCible= document.forms['MAJPrixLiveraison'].elements['IdSup'];"
CrerDevis = CrerDevis & vbCrLf & "L_RefProduit= document.forms['MAJPrixLiveraison'].elements['L_RefProduit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "var Qts;"
CrerDevis = CrerDevis & vbCrLf & "var Reste;"
CrerDevis = CrerDevis & vbCrLf & "Qts= document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Reste = document.forms['MAJPrixLiveraison'].elements['Reste_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Qts.value=Remplacer(Qts.value,',','.');"
CrerDevis = CrerDevis & vbCrLf & "Reste.value=Remplacer(Reste.value,',','.');"
CrerDevis = CrerDevis & vbCrLf & "if (Qts.value!==Reste.value) {"

CrerDevis = CrerDevis & vbCrLf & "  alert('" & GetMessage("DeclareLivreProduitsReference", "Vous avez déclaré avoir livré des produits sur cette Référence ", DsnTableMenu(Session("candidat_ADOContact"))) & "'+L_RefProduit.value+'." & GetMessage("SuppressionPpaEffectue", "\nLa suppression ne pourra pas être effectué.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "  return;"
CrerDevis = CrerDevis & vbCrLf & "}"

CrerDevis = CrerDevis & vbCrLf & "  if (confirm('" & GetMessage("SupprimerCetteReference", "Voulez vous vraiment  supprimer cette référence : ", DsnTableMenu(Session("candidat_ADOContact"))) & "'+L_RefProduit.value+'" & GetMessage("QuantitesSuppriméesPasReintégrees", "\n\nAttention les quantités supprimées ne seront pas réintégrées dans la base E boutique .", DsnTableMenu(Session("candidat_ADOContact"))) & "')) {"
'CrerDevis = CrerDevis & vbCrLf & "      alert(IdSource.value);"
CrerDevis = CrerDevis & vbCrLf & "      IdCible.value=IdSource.value;"
'CrerDevis = CrerDevis & vbCrLf & "      alert(IdCible.value);"
CrerDevis = CrerDevis & vbCrLf & "      this.document.MAJPrixLiveraison.Maj.value='Sup';"
 CrerDevis = CrerDevis & vbCrLf & "this.document.MAJPrixLiveraison.ACTION=""Contact.asp"";"
CrerDevis = CrerDevis & vbCrLf & "this.document.MAJPrixLiveraison.submit();"
CrerDevis = CrerDevis & vbCrLf & "    }"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "function ValideBl(){"
CrerDevis = CrerDevis & vbCrLf & "var Execute"
CrerDevis = CrerDevis & vbCrLf & "Execute=false;"
CrerDevis = CrerDevis & vbCrLf & "var aa"
'CrerDevis = CrerDevis & vbCrLf & "alert(this.document.MAJPrixLiveraison.NumLigne.value);"
CrerDevis = CrerDevis & vbCrLf & "for(i=0;i<this.document.MAJPrixLiveraison.NumLigne.value ;i++) {"
CrerDevis = CrerDevis & vbCrLf & "i2=i+1"
CrerDevis = CrerDevis & vbCrLf & "eval (""aa = this.document.MAJPrixLiveraison.Dispo_""+i2+"".value;"");"
'CrerDevis = CrerDevis & vbCrLf & "alert(aa);"
CrerDevis = CrerDevis & vbCrLf & "if (aa!=0){"
CrerDevis = CrerDevis & vbCrLf & "Execute=true;"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "if (Execute==false){"

CrerDevis = CrerDevis & vbCrLf & "alert('" & GetMessage("UneQteLivree", "Vous devez saisir au moins une valeur dans le champs Qté Livrée", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "var MyForm;"
CrerDevis = CrerDevis & vbCrLf & "eval(""MyForm=this.document.MAJPrixLiveraison;"");"
'CrerDevis = CrerDevis & vbCrLf & "alert(MyForm.mode.value);"
CrerDevis = CrerDevis & vbCrLf & "MyForm.CreateBl.value='Ok';"
CrerDevis = CrerDevis & vbCrLf & "MyForm.mode.value=""Historique_Bl"";"
'CrerDevis = CrerDevis & vbCrLf & "alert(MyForm.mode.value);"
CrerDevis = CrerDevis & vbCrLf & "MyForm.ACTION='Contact.asp';"
CrerDevis = CrerDevis & vbCrLf & "MyForm.submit();"
CrerDevis = CrerDevis & vbCrLf & "}"

CrerDevis = CrerDevis & vbCrLf & "function FunReste2(L){"
CrerDevis = CrerDevis & vbCrLf & "   var Mytxt_Reste;"
CrerDevis = CrerDevis & vbCrLf & "var QtsCommand;"
CrerDevis = CrerDevis & vbCrLf & "var QtsDebit;"
CrerDevis = CrerDevis & vbCrLf & "var QtsChange;"
CrerDevis = CrerDevis & vbCrLf & "var QtsChange;"
CrerDevis = CrerDevis & vbCrLf & "MyReste= document.forms['MAJPrixLiveraison'].elements['Reste_'+L];"
CrerDevis = CrerDevis & vbCrLf & "QtsCommand = document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit = document.forms['MAJPrixLiveraison'].elements['Dispo_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Entrer = document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie = document.forms['MAJPrixLiveraison'].elements['txt_Reste_'+L];"


CrerDevis = CrerDevis & vbCrLf & "if (IsNumeric2(QtsDebit.value)==false){"
CrerDevis = CrerDevis & vbCrLf & "alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value-QtsDebit.value;"

CrerDevis = CrerDevis & vbCrLf & "  if (Qts_R_Sortie.value+QtsDebit.value.value>QtsCommand.value){"

CrerDevis = CrerDevis & vbCrLf & "      alert('" & GetMessage("QteSaisie", "La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsCommand.value + '" & GetMessage("InferieurQteRestanteLivre", " est inférieur à la Qté Restante à livrer : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value);"
'CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "QtsCommand.value=(MyReste.value*1) + (QtsDebit.value*1);"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=(QtsCommand.value*1) - (QtsDebit.value*1);"

CrerDevis = CrerDevis & vbCrLf & "   ValideQtsPrix(L);"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "  }"
CrerDevis = CrerDevis & vbCrLf & "  if (QtsDebit.value<0){"
CrerDevis = CrerDevis & vbCrLf & "      alert('" & GetMessage("QteSaisie", "La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value + ' < 0');"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value;"

CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "  }"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "function FunReste(L){"
CrerDevis = CrerDevis & vbCrLf & "   var Mytxt_Reste;"
CrerDevis = CrerDevis & vbCrLf & "var QtsCommand;"
CrerDevis = CrerDevis & vbCrLf & "var QtsDebit;"
CrerDevis = CrerDevis & vbCrLf & "var QtsChange;"
CrerDevis = CrerDevis & vbCrLf & "var QtsChange;"
CrerDevis = CrerDevis & vbCrLf & "QtsCommand = document.forms['MAJPrixLiveraison'].elements['L_qte_produit_'+L];"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit = document.forms['MAJPrixLiveraison'].elements['Dispo_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Entrer = document.forms['MAJPrixLiveraison'].elements['Reste_'+L];"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie = document.forms['MAJPrixLiveraison'].elements['txt_Reste_'+L];"


CrerDevis = CrerDevis & vbCrLf & "if (IsNumeric2(QtsDebit.value)==false){"
CrerDevis = CrerDevis & vbCrLf & "alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=QtsCommand.value-QtsDebit.value;"
'CrerDevis = CrerDevis & vbCrLf & "alert('Qts_R_Sortie '+Qts_R_Sortie.value);"
'CrerDevis = CrerDevis & vbCrLf & "alert('QtsCommand '+QtsCommand.value);"
'CrerDevis = CrerDevis & vbCrLf & "alert('QtsDebit '+QtsDebit.value);"
'CrerDevis = CrerDevis & vbCrLf & "alert('Qts_R_Entrer '+Qts_R_Entrer.value);"
CrerDevis = CrerDevis & vbCrLf & "  if (Qts_R_Sortie.value+Qts_R_Entrer.value<0){"

CrerDevis = CrerDevis & vbCrLf & "      alert('" & GetMessage("ChangeQuantiteInitialeCommande", "Vous avez changé la quantité initiale de la commande \n et vous n´avez pas valider votre choix\nOu La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value + '" & GetMessage("SupperieurQteRestanteLivrer : ", " est suppérieur à la Qté Restante à livrer : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsCommand);"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value;"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "  }"
CrerDevis = CrerDevis & vbCrLf & "  if (QtsDebit.value<0){"
CrerDevis = CrerDevis & vbCrLf & "      alert('" & GetMessage("QteSaisie", "La Qté Saisie : ", DsnTableMenu(Session("candidat_ADOContact"))) & "' + QtsDebit.value + ' < 0');"
CrerDevis = CrerDevis & vbCrLf & "QtsDebit.value=0;"
CrerDevis = CrerDevis & vbCrLf & "Qts_R_Sortie.value=Qts_R_Entrer.value;"
CrerDevis = CrerDevis & vbCrLf & "return;"
CrerDevis = CrerDevis & vbCrLf & "  }"
CrerDevis = CrerDevis & vbCrLf & "}"
CrerDevis = CrerDevis & vbCrLf & "</SCRIPT> "
End If
CrerDevis = CrerDevis & vbCrLf & "<head>"
If Trim("" & NumBl) <> "" Then
    CrerDevis = CrerDevis & vbCrLf & "<title>BL N° " & NumBl & "</title>"
Else
    CrerDevis = CrerDevis & vbCrLf & "<title>Commande N° " & numDevis & "</title>"
End If
CrerDevis = CrerDevis & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
CrerDevis = CrerDevis & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"
If Trim("" & NumBl) <> "" Then
   
    If Request("ApprecuBL") <> "" Then
        CrerDevis = CrerDevis & vbCrLf & "<SCRIPT LANGUAGE=""JAVASCRIPT""> "
        CrerDevis = CrerDevis & vbCrLf & "function Imprimer(){"
        CrerDevis = CrerDevis & vbCrLf & "document.getElementById(""PRINT"").style.display = 'none';"
        CrerDevis = CrerDevis & vbCrLf & "window.print();"
         CrerDevis = CrerDevis & vbCrLf & "   document.getElementById(""PRINT"").style.display ='block';"
        CrerDevis = CrerDevis & vbCrLf & ""
        CrerDevis = CrerDevis & vbCrLf & "}"
        CrerDevis = CrerDevis & vbCrLf & "function AppercuBl() {"
        CrerDevis = CrerDevis & vbCrLf & "window.open('contactSansMenu.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & NumBl & "&ApprecuBL=Ok');"
        CrerDevis = CrerDevis & vbCrLf & "}"
        CrerDevis = CrerDevis & vbCrLf & "</SCRIPT> "
        CrerDevis = CrerDevis & vbCrLf & "<div align=""right"">"
        CrerDevis = CrerDevis & vbCrLf & "<table width=""15%""><tr>"
        CrerDevis = CrerDevis & vbCrLf & "<td width=""47"">" & AfficheBounton("Imprimer", "PRINT", "'javascript:Imprimer();'") & "</td>"
'        CrerDevis = CrerDevis & vbCrLf & "<td width=""50%""><br><img  src=""" & Session("contact_devis")
'        CrerDevis = CrerDevis & vbCrLf & "PRINT.gif"" width=""67"" height=""70"" /  OnClick=""Imprimer();"" id=""PRINT""></td>"
        CrerDevis = CrerDevis & vbCrLf & "</tr></table>"
    Else
        CrerDevis = CrerDevis & vbCrLf & "<SCRIPT LANGUAGE=""JAVASCRIPT""> "
        CrerDevis = CrerDevis & vbCrLf & "function AppercuBl() {"
        CrerDevis = CrerDevis & vbCrLf & "window.open('contactSansMenu.asp?mode=Hisorique_Bl_Visu&RefCommande=" & numDevis & "&Liv=" & NumBl & "&ApprecuBL=Ok');"
        CrerDevis = CrerDevis & vbCrLf & "}"
        CrerDevis = CrerDevis & vbCrLf & "</SCRIPT> "
        CrerDevis = CrerDevis & vbCrLf & "<div align=""right"">"
        CrerDevis = CrerDevis & vbCrLf & "<table width=""15%""><tr>"
        
'        CrerDevis = CrerDevis & vbCrLf & "<td width=""50""><img  src=""" & Session("contact_devis")
'        CrerDevis = CrerDevis & vbCrLf & "louperd.gif"" width=""47"" height=""50"" /  OnClick=""AppercuBl();"" id=""PRINT""></td>"
        CrerDevis = CrerDevis & vbCrLf & "<td width=""47"">" & AfficheBounton("Aperçu", "PRINT", "'javascript:AppercuBl();'") & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "</tr></table>"
   End If
End If
If Trim("" & Session("ErrDevis")) <> "" Then
    CrerDevis = CrerDevis & vbCrLf & "<center><br><br><font size=""1"" color=""" & GetDefault("colormsg", "red", DsnTableMenu(Session("candidat_ADOContact"))) & """>" & Session("ErrDevis") & "<b></b></font></center>"
    Session("ErrDevis") = ""
End If
txt_HISTORIQUE_BL = HISTORIQUE_BL("" & numDevis, Conn, BlExiste)
If VisuBl = True Then
CrerDevis = CrerDevis & vbCrLf & txt_HISTORIQUE_BL
Else

CrerDevis = CrerDevis & vbCrLf & "<center><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "logo.gif"" border=""0"" ></center><br>"
'CrerDevis = CrerDevis & vbCrLf & "<center><img src=""" & Session("contact_devis")
'<img src="cid:picture.gif" border="0" alt='. $alt_meteo. '>';

'CrerDevis = CrerDevis & vbCrLf & "logo.gif"" border=""0""></center><br>"
End If
CrerDevis = CrerDevis & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> "
CrerDevis = CrerDevis & vbCrLf & "<tr><td width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
CrerDevis = CrerDevis & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
CrerDevis = CrerDevis & vbCrLf & "<tr><td background=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgh2.gif"">"
If Trim("" & NumBl) <> "" Then
    CrerDevis = CrerDevis & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">Bordereau de Livraison</font></b></font>"

Else
    CrerDevis = CrerDevis & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">R&eacute;capitulatif de votre Commande</font></b></font>"
End If
CrerDevis = CrerDevis & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
CrerDevis = CrerDevis & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
CrerDevis = CrerDevis & vbCrLf & "</tr><tr>"
CrerDevis = CrerDevis & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
CrerDevis = CrerDevis & vbCrLf & "<td bgcolor=""#EBE3D7"">"

'CrerDevis = CrerDevis & vbCrLf & AfficheAvenant(numDevis)
If Session("VisuDevis") = "TRUE" Then
CrerDevis = CrerDevis & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
If Bl = False Then
    If Request("ApprecuBL") = "" Then
    CrerDevis = CrerDevis & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Commande&Id=" & Session("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD></tr>"
  End If
  Else
    If Request("ApprecuBL") = "" Then
      CrerDevis = CrerDevis & vbCrLf & " <tr><td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & Session("RefCommande") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD></tr>"
    End If
  End If
    CrerDevis = CrerDevis & vbCrLf & "</Table>"
End If
CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >R&eacute;f&eacute;rence &agrave; rappeler  </td>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
Sql = "SELECT T_Num_Commande.NumCommande, t_R_Social.SocieteId "
Sql = Sql & "FROM t_R_Social INNER JOIN (Users INNER JOIN (T_Num_Commande INNER JOIN (T_Avoire INNER JOIN t_Devis ON  "
Sql = Sql & "T_Avoire.IdAvoire = t_Devis.Id_Avoire) ON T_Num_Commande.IdNumCommande = T_Avoire.IdNumCommande)  "
Sql = Sql & "ON Users.Id_Societes = T_Num_Commande.IdSociete) ON t_R_Social.SocieteId = Users.Id_Societes "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set RsLiv = Conn.Execute(Sql)
'
CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"


CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Num&eacute;ro de Client</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "
CrerDevis = CrerDevis & vbCrLf & Format(RsLiv!SocieteId, "000#")
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"

CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Num&eacute;ro de Commande</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "
CrerDevis = CrerDevis & vbCrLf & RsLiv!NumCommande
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"

CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>N°de Commande Encelade</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "
CrerDevis = CrerDevis & vbCrLf & numDevis
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>En Date du </td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "

CrerDevis = CrerDevis & vbCrLf & CovertCommDate("" & numDevis)
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"


CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Demandeur</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "
Sql = "SELECT Users.FirstName, Users.LastName "
Sql = Sql & "FROM t_Devis INNER JOIN Users ON t_Devis.Id_User = Users.UserID "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set RsDemendeur = Conn.Execute(Sql)
If RsDemendeur.EOF = False Then
CrerDevis = CrerDevis & vbCrLf & RsDemendeur!FirstName & " " & RsDemendeur!LastName
End If
RsDemendeur.Close
Set RsDemendeur = Nothing
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
If Bl = True Then


CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>N°de Livraison</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "


Sql = "SELECT T_Commande_Liv.NumLiv FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "'"
Sql = Sql & "ORDER BY T_Commande_Liv.NumLiv Desc;"
Set rsNumLiv = Conn.Execute(Sql)
CrerDevis = CrerDevis & vbCrLf & NumBl
rsNumLiv.Close
Set rsNumLiv = Nothing
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>En Date du</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "

CrerDevis = CrerDevis & vbCrLf & CovertCommDate("" & NumBl)
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
End If
RsLiv.Close
Set RsLiv = Nothing


CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & "<br>"
'
'

CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Nous Contacter</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis = CrerDevis & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Service technique </td>"
CrerDevis = CrerDevis & vbCrLf & "        <td><A href='mailto:" & NousContacter & "'>" & NousContacter & "</A></td>"
CrerDevis = CrerDevis & vbCrLf & "   </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & "<br>"
'
'
'
'
'
'
CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Coordonn&eacute;es du demandeur</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis = CrerDevis & vbCrLf & "   <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Nom / Pr&eacute;nom</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!LastName & " " & Rs!FirstName & "</td>"
CrerDevis = CrerDevis & vbCrLf & "   </tr>"
CrerDevis = CrerDevis & vbCrLf & "    "
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Soci&eacute;t&eacute;</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td >" & Rs!fld3 & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
'CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
'CrerDevis = CrerDevis & vbCrLf & "        <td>Num&eacute;ro FNA</td>"
'CrerDevis = CrerDevis & vbCrLf & "        <td >" & Rs!fld2 & "</td>"
'CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "    "
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td >Adresse</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!Address & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>CP</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!Zip & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td >Ville / Pays</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!City & " " & Rs!label_pays & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "    "
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Email</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> <A href='mailto:" & Rs!EMail & "'>" & Rs!EMail & "</A></td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>T&eacute;l&eacute;phone / Fax</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "
                                            If Trim("" & Rs!phone) <> "" Then
CrerDevis = CrerDevis & vbCrLf & Rs!phone
                                                If Trim("" & Rs!fax) <> "" Then
CrerDevis = CrerDevis & vbCrLf & "          / " & Rs!fax
                                                End If
                                            Else
                                                If Trim("" & Rs!fax) = "" Then
CrerDevis = CrerDevis & vbCrLf & Rs!fax
                                                Else
CrerDevis = CrerDevis & vbCrLf & "&nbsp;"
                                                End If
                                            End If
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & "<br>"
CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" > Adresse de livraison</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
Sql = ""
Sql = Sql & "SELECT t_livraison.id_livraison, t_livraison.id_pays, t_livraison.beneficiare_liv,  "
Sql = Sql & "t_livraison.adresse_liv, t_livraison.cp_liv, t_livraison.ville_liv,  "
Sql = Sql & "t_livraison.date_liv, t_livraison.cadeau, t_livraison.cadeau_texte "
Sql = Sql & "From t_livraison "
Sql = Sql & "WHERE t_livraison.id_livraison=" & Session("id_livraison") & ";"

Set Rs = Conn.Execute(Sql)

CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td >B&eacute;n&eacute;ficiaire</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!beneficiare_liv & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td >Adresse</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!adresse_liv & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>CP</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!cp_liv & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & ""
CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Ville</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td>" & Rs!ville_liv & "</td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"

CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
CrerDevis = CrerDevis & vbCrLf & "        <td>Mode de livraison</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td> "

Sql = "SELECT T_Frais_Transport.ModeTransport From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & numDevis & "';"
Set RsFrais_Transport = Conn.Execute(Sql)
CrerDevis = CrerDevis & vbCrLf & RsFrais_Transport!ModeTransport
CrerDevis = CrerDevis & vbCrLf & "</td> "
CrerDevis = CrerDevis & vbCrLf & "    </tr>"




CrerDevis = CrerDevis & vbCrLf & "</table>"
'
'
If Session("candidat_UserType") = "Administrator" And Bl = False Then
Sql = "SELECT T_Frais_Transport.* From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & numDevis & "';"
Set RsFrais_Transport = Conn.Execute(Sql)
    If (BlExiste = False) Or (RsFrais_Transport!Frais = 0 And RsFrais_Transport!ModeTransport = GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact")))) Then
        CrerDevis = CrerDevis & vbCrLf & "<Form Name=""MAJLiveraison""  method=""post"" >"
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""ModeFacture"" value='" & Request("ModeFacture") & "'>"
        
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""TypeLiv"" value="""">"
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""ModeFacture"" value='" & Request("ModeFacture") & "'>"
        'CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""zzz"" value=""Du Con"">"
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""mode""  value= ""HISTORIQUE_Eboutique_Affiche_Commande"">"
        
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""Maj""  value= ""Liv"">"
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""IdSup""  value= """">"
        CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""RefCommande""  value= """ & numDevis & """ > "
        
        CrerDevis = CrerDevis & vbCrLf & "<br>"
        CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
        CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
        CrerDevis = CrerDevis & vbCrLf & "    <tr>"
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
        CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
        CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Modifer le mode de livraison</td>"
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
        CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
        CrerDevis = CrerDevis & vbCrLf & "    </tr>"
        CrerDevis = CrerDevis & vbCrLf & "</table>"
    
    
        CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
        If UCase(RsFrais_Transport!ModeTransport) = UCase(GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact")))) Then
            MyChecked = "Checked"
        Else
            MyChecked = "onClick=""ValideLivraison('" & GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"""
        End If
    
        CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" >"
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""1%""><input type=""radio"" name=""M_Liv"" " & MyChecked & "></td>"
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""99%"">" & GetDefault("LivraisonComtoire", "Je désire  que ma commande me soit remise au comptoir.", DsnTableMenu(Session("candidat_ADOContact"))) & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "    </tr>"
        CrerDevis = CrerDevis & vbCrLf & ""
        CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" >"
    
        If UCase(Trim("" & RsFrais_Transport!ModeTransport)) = Trim("" & UCase(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))))) Then
            MyChecked = "Checked"
        Else
            MyChecked = "onClick=""ValideLivraison('" & GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"""
        End If
        
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""1%""><input type=""radio"" name=""M_Liv"" " & MyChecked & "></td>"
        CrerDevis = CrerDevis & vbCrLf & "        <td width=""99%"">" & GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact"))) & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "    </tr>"
        CrerDevis = CrerDevis & vbCrLf & ""
        CrerDevis = CrerDevis & vbCrLf & ""
        
        
        
        CrerDevis = CrerDevis & vbCrLf & "</table>"
        
        CrerDevis = CrerDevis & vbCrLf & ""
        
        
        CrerDevis = CrerDevis & vbCrLf & "</form>"
    End If
End If

CrerDevis = CrerDevis & vbCrLf & "<br>"
CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
If Trim("" & NumBl) <> "" Then
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail de la Livraison</td>"
Else
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail de la Commande</td>"
End If
CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"
CrerDevis = CrerDevis & vbCrLf & ""
'
'CrerDevis = CrerDevis & vbCrLf & "<td background=""" & Session("contact_devis")
'CrerDevis = CrerDevis & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
'CrerDevis = CrerDevis & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
''CrerDevis = CrerDevis & vbCrLf & "<td bgcolor=""#EBE3D7"">"
'
''CrerDevis = CrerDevis & vbCrLf & AfficheAvenant(numDevis)
If Session("VisuDevis") = "TRUE" Then
CrerDevis = CrerDevis & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
If Bl = False Then


  CrerDevis = CrerDevis & vbCrLf & " <tr>"
  If Session("candidat_UserType") = "Administrator" Then
   CrerDevis = CrerDevis & vbCrLf & " <td width=""60%"" align=""right"" >&nbsp;</td>"
'   CrerDevis = CrerDevis & vbCrLf & " <td align=""right"" >&nbsp;</td>"
'   CrerDevis = CrerDevis & vbCrLf & " <td align=""right"" >&nbsp;</td>"
    CrerDevis = CrerDevis & vbCrLf & " <td align=""right"" ><a href='javascript:ValideBl();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Livraison.GIF"" border=""0""></a></TD>"
    CrerDevis = CrerDevis & vbCrLf & " <td align=""right"" ><a href='javascript:this.document.MAJPrixLiveraison.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a></TD>"
  End If
  If Session("candidat_UserType") = "Administrator" Then
    CrerDevis = CrerDevis & vbCrLf & "<td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Commande&Id=" & Session("IdAvoire") & "&ModeFacture=" & Request("ModeFacture") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD>"
 End If
  Else
   If Request("ApprecuBL") = "" And Session("candidat_UserType") = "Administrator" Then
    If NumBl = "" Then
        CrerDevis = CrerDevis & vbCrLf & " <td align=""right""><a href='contact.asp?mode=HISTORIQUE_Eboutique_Affiche_Commande&RefCommande=" & Session("RefCommande") & "&ModeFacture=" & Request("ModeFacture") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_annuler.GIF"" border=""0""></a></TD>"
     End If
    End If
  End If
    CrerDevis = CrerDevis & vbCrLf & "</tr></Table>"
End If

CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
CrerDevis = CrerDevis & vbCrLf & "    <tr>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signation")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute;")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Remise %")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.H.T. ")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("T.V.A. ")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.T.T.C. ")) & "</td>"


If Session("candidat_UserType") = "Administrator" Or Bl = True Then
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute; Livr&eacute;e")) & "</td>"
CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Reste")) & "</td>"
    If Bl = False Then
        CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Supprimer")) & "</td>"
    End If
End If

CrerDevis = CrerDevis & vbCrLf & "    </tr>"
CrerDevis = CrerDevis & vbCrLf & "<Form Name=""MAJPrixLiveraison""  method=""post"" >"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""ModeFacture"" value='" & Request("ModeFacture") & "'>"

CrerDevis = CrerDevis & vbCrLf & "<input type=""hidden"" name=""CreateBl"" value="""" >"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""ModeFacture"" value='" & Request("ModeFacture") & "'>"

Sql = ""
Sql = Sql & "SELECT t_Devis.*, t_Devis.numDevis "
Sql = Sql & "From t_Devis "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set Rs = Conn.Execute(Sql)
'CrerDevis = CrerDevis & vbCrLf & "</table>"
'CrerDevis = CrerDevis & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
TotalHt = 0
If Session("SaveBlReste") = "" Then
    Session("SaveBlReste") = "True"
Else
    Session("SaveBlReste") = ""
End If
While Rs.EOF = False

    iIdMenu = Rs!Id_Menu
    iIdProduit = Rs!id_produit
    iQuantite = Rs!qte_produit
    ValQtsStock = QtsStock(Rs!Id_Menu, Conn, iIdProduit)
    
If Session("candidat_UserType") <> "Administrator" Then
        If Session("VisuDevis") = "" Then
            
'            If ValQtsStock - iQuantite < 0 Then
'                MyLib = Replace(Replace("" & Rs!Designation, Chr(10), " "), Chr(13), "")
'                Session("Message_Caddy") = "§erre§ La quantit&eacute; de : " & MyLib & " en stock est de : " & ValQtsStock & " veuillez modifier ou supprimer cet article de Votre Panier"
'
'                Sql = "INSERT INTO t_caddie ( id_caddie, Id_Menu, id_produit, date_modif, qte_produit, TypePiece, RefProduit, PrixU_produit, Designation ) "
'                Sql = Sql & "SELECT t_Devis.id_caddie, t_Devis.Id_Menu, t_Devis.id_produit, t_Devis.date_modif, t_Devis.qte_produit, t_Devis.TypePiece, t_Devis.RefProduit, t_Devis.PrixU_produit, t_Devis.Designation "
'                Sql = Sql & "From t_Devis "
'                Sql = Sql & "GROUP BY t_Devis.id_caddie, t_Devis.Id_Menu, t_Devis.id_produit, t_Devis.date_modif, t_Devis.qte_produit, t_Devis.TypePiece, t_Devis.RefProduit, t_Devis.PrixU_produit, t_Devis.Designation "
'                Sql = Sql & "HAVING t_Devis.id_caddie=" & Session("candidat_id_caddy") & ";"
'                Conn.Execute (Sql)
'                Sql = "DELETE t_Devis.*   FROM t_Devis WHERE t_Devis.id_caddie=" & Session("candidat_id_caddy") & ";"
'                Conn.Execute (Sql)
'                CrerDevis = ""
'                Exit Function
'            End If
        End If
    End If
    If Session("VisuDevis") = "" Then
        MettreAJourQuantite iIdMenu, iIdProduit, iQuantite
    End If
    NumLigne = NumLigne + 1
    Remise = Rs!Remise
    Remise2 = 1 - Remise
    Remise = 100 * Remise
     PrixU_produit = Rs!PrixU_produit
         TotalPrixU_produit = CDbl(Rs!PrixU_produit * Rs!qte_produit) * Remise2
         tva = Rs!tva
         TotalTVA = TotalPrixU_produit * (1 / 100) * tva
         ttc = TotalPrixU_produit + TotalTVA
'         TotalTva_Total = TotalTVA + TotalTva_Total
         TotalTTC = TotalTTC + ttc
         
'         Remise = FomatNum(Remise, 3)
'         TotalPrixU_produit = FomatNum(TotalPrixU_produit, 3)
'         tva = FomatNum(tva, 3)
'         TotalTVA = FomatNum(TotalTVA, 3)
'         ttc = FomatNum(ttc, 3)
''         TotalTva_Total = TotalTVA + TotalTva_Total
'         TotalTTC = FomatNum(TotalTTC, 3)
'        PrixU_produit = FomatNum(PrixU_produit, 3)
'        ttc = FomatNum(ttc, 3)
    If Session("candidat_UserType") <> "Administrator" Then
        CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""100%"" >"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""20%"">" & Rs!Designation & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%"">" & Rs!RefProduit & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & Rs!qte_produit & "</td>"
         CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"">" & FomatNum(PrixU_produit, 3) & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"">" & FomatNum(Remise, 3) & "</td>"
         
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & FomatNum(TotalPrixU_produit, 3) & "</td>"
'            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TVA & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & FomatNum(TotalTVA, 3) & "</td>"
         CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & FomatNum(ttc, 3) & "</td>"

    Else
        
        CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF width=""100%"" >"
        CrerDevis = CrerDevis & vbCrLf & "           "
        Designation = "" & Rs!Designation
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""20%"">" & Replace(Replace(Designation, Chr(10), ""), Chr(13), "") & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%""><input type=""hidden"" name=""L_RefProduit_" & NumLigne & """ value='" & Rs!RefProduit & "' >" & Rs!RefProduit & "</td>"
        CrerDevis = CrerDevis & vbCrLf & " "
        If Session("candidat_UserType") = "Administrator" Then
            If Bl = True Then
                CrerDevis = CrerDevis & vbCrLf & "          <td align=""right"" >" & Rs!qte_produit & "</td>"
            Else
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""right"" width=""10%""><input  size=""10%"" type=""text"" name=""L_qte_produit_" & NumLigne & """ value=""" & Rs!qte_produit & """ onchange=""ValideQts('" & NumLigne & "');"" ></td>"
            End If
        Else
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""right"" >" & Rs!qte_produit & "</td>"
        End If
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%"">"
        
      
        CrerDevis = CrerDevis & vbCrLf & "         <input type=""hidden"" name=""L_PrixU_produit_Avant_" & NumLigne & """ value=""" & FomatNum(PrixU_produit, 3) & """ >"
        If Session("candidat_UserType") = "Administrator" Then
             If Bl = True Then
                CrerDevis = CrerDevis & vbCrLf & "          " & FomatNum("" & PrixU_produit, 3) & "</td>"
             Else
                CrerDevis = CrerDevis & vbCrLf & "          <input  size=""10%"" type=""text"" name=""L_PrixU_produit_" & NumLigne & """ value=""" & FomatNum(PrixU_produit, 3) & """ onchange=""ValideQtsPrix('" & NumLigne & "');"" ></td>"
            End If
         Else
                  CrerDevis = CrerDevis & vbCrLf & PrixU_produit & "</td>"

         End If
'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"">" & Rs!PrixU_produit & "</td>"
         
         
         If Session("candidat_UserType") = "Administrator" Then
            If Bl = True Then
                CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" width=""10%""> <input size=""10%"" type=""hidden"" disabled name=""Remise_" & NumLigne & """ value=""" & "" & Remise & """ > " & FomatNum(Remise, 3) & "</td>"
                CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%""><input type=""hidden"" name=""L_TotalPrixU_produit_" & NumLigne & """ value='" & TotalPrixU_produit & "' >"
                CrerDevis = CrerDevis & vbCrLf & FomatNum("" & TotalPrixU_produit, 3) & "</td>"
                CrerDevis = CrerDevis & vbCrLf & "          <input type=""hidden"" name=""L_TVA_" & NumLigne & """ value='" & tva & "' ></td>" '<td align=""center"" width=""10%"">
'                CrerDevis = CrerDevis & vbCrLf & "          " & TVA & "</td>"
                CrerDevis = CrerDevis & vbCrLf & "          <td align='center' width='10%'><input type='hidden' name='L_TotalTva_" & NumLigne & "' value='" & FomatNum("" & TotalTVA, 3) & "' >"
                CrerDevis = CrerDevis & vbCrLf & FomatNum("" & TotalTVA, 3) & "</td>"
                 If Request("ApprecuBL") <> "" Then TotalTVA = FomatNum(TotalTVA, 3)
                   
               
                  
             
                CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" width=""10%""><input type=""hidden"" name=""L_TTC_" & NumLigne & """ value='" & ttc & "' >"
                If Request("ApprecuBL") <> "" Then ttc = FomatNum(ttc, 3)
                CrerDevis = CrerDevis & vbCrLf & "          " & FomatNum("" & ttc, 3) & "</td>"
            Else
                
                
                CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" width=""10%""> <input size=""10%"" type=""hidden"" disabled name=""Remise_" & NumLigne & """ value=""" & "" & Remise & """ ><input size=""10%"" type=""text"" disabled value=""" & "" & FomatNum(Remise, 3) & """ ></td>"
                CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%"" ><input type=""hidden"" name=""L_QTS_" & NumLigne & """ value='" & Rs!qte_produit & "' >"
                CrerDevis = CrerDevis & vbCrLf & "          <input size=""10%"" type=""text"" disabled name=""L_Prix_THT_produit_" & NumLigne & """ value=""" & FomatNum("" & TotalPrixU_produit, 3) & """ ></td>"
'                CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%""><input type=""hidden"" name=""L_TVA_" & NumLigne & """ value='" & TVA & "' >"
'                CrerDevis = CrerDevis & vbCrLf & "          <input  size=""10%"" type=""text"" disabled name=""L_TVAS_" & NumLigne & """ value=""" & TVA & """ ></td>"
                CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%""><input type=""hidden"" name=""L_TVA_" & NumLigne & """ value='" & tva & "' >"
                CrerDevis = CrerDevis & vbCrLf & " <input type=""hidden"" name=""L_TotalTva_" & NumLigne & """ value='" & TotalTVA & "' >"
                CrerDevis = CrerDevis & vbCrLf & "          <input  size=""10%"" type=""text"" disabled name=""L_TotalTvaS_" & NumLigne & """ value=""" & FomatNum("" & TotalTVA, 3) & """ ></td>"
                CrerDevis = CrerDevis & vbCrLf & "          <td align=""center""width=""10%"" ><input type=""hidden"" name=""L_TTC_" & NumLigne & """ value='" & ttc & "' >"
                CrerDevis = CrerDevis & vbCrLf & "          <input size=""10%"" type=""text"" disabled name=""L_TTCS_" & NumLigne & """ value=""" & FomatNum("" & ttc, 3) & """ ></td>"
                                
            End If
        Else
            CrerDevis = CrerDevis & vbCrLf & TotalPrixU_produit & "</td>"
        End If


'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & Rs!PrixU_produit * Rs!qte_produit & "</td>"
    End If
    TotalHt = TotalHt + TotalPrixU_produit
    TotalTva_Total = TotalTVA + TotalTva_Total
    TTC_Total = TTC_Total + ttc
   
        TotalHt = FomatNum(TotalHt, 3)
        TotalTva_Total = FomatNum(TotalTva_Total, 3)
    TTC_Total = FomatNum(TTC_Total, 3)
       
 
    If Session("candidat_UserType") = "Administrator" Then

    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" width=""10%""><input type=""hidden"" name=""L_" & NumLigne & """ value=""" & Rs!Id & """ >"
    If Bl = True Then
        MyDisabled = " disabled "
    Else
        MyDisabled = ""
    End If
    If Bl = True Then
        Sql = "SELECT T_Commande_Liv.qte_produit FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
        Sql = Sql & "Where T_Commande_Liv.Id_Devis = " & Rs!Id & " "
        Sql = Sql & "ORDER BY T_Commande_Liv.NumLiv Desc;"

        Sql = "SELECT T_Commande_Liv.qte_produit, T_Commande_Liv.Reste "
        Sql = Sql & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
        Sql = Sql & "WHERE T_Commande_Liv.Id_Devis=" & Rs!Id & " "
        Sql = Sql & "AND T_Commande_Liv.NumLiv='" & NumBl & "';"

        Set rsQtsLiv = Conn.Execute(Sql)
        CrerDevis = CrerDevis & vbCrLf & rsQtsLiv!qte_produit & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!Reste & "</td>"
'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!qte_produit & "</td>"
'NumBl
    Else
      If Session("candidat_UserType") = "Administrator" Then
      MyQtsDispo = val("" & Rs!QtsDispo)
      If Session("SaveBl") <> "" Then MyQtsDispo = 0
            CrerDevis = CrerDevis & vbCrLf & "          <input  size=""10%"" type=""text"" " & MyDisabled & " name =""Dispo_" & NumLigne & """ value=""" & MyQtsDispo & """ onchange=""FunReste(" & NumLigne & ");""></td>"
            LeReste = Rs!Reste
            LeReste2 = Rs!qte_produit - (Rs!QtsDispo + Rs!Reste)
            If LeReste < 0 Then LeReste = 0
            
            CrerDevis = CrerDevis & vbCrLf & "          <td width=""10%""><input type=""hidden"" disabled  name =""Reste_" & NumLigne & """ value=""" & LeReste & """>"
            CrerDevis = CrerDevis & vbCrLf & "          <input size=""10%"" type=""text"" disabled  name =""txt_Reste_" & NumLigne & """ value=""" & LeReste2 & """></td>"
     Else
            CrerDevis = CrerDevis & vbCrLf & Rs!QtsDispo & "</td>"
            CrerDevis = CrerDevis & vbCrLf & "          <td width=""10%"">" & Rs!qte_produit - (Rs!QtsDispo + Rs!Reste) & "</td>"

     End If
 End If
    If Bl = False Then
    CrerDevis = CrerDevis & vbCrLf & "           <td align=""center"" width=""10%""><a href='javascript:SuppirmerArticle(" & NumLigne & ");'><img width=""15"" height=""15"" src=""" & Session("candidat_EcomPathImages") & "icon_delete_reply.gif"" border=""0""></a></TD>"
    End If
    Else
        If Bl = True Then
            Sql = "SELECT T_Commande_Liv.qte_produit FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
            Sql = Sql & "Where T_Commande_Liv.Id_Devis = " & Rs!Id & " "
            Sql = Sql & "ORDER BY T_Commande_Liv.NumLiv Desc;"
    
            Sql = "SELECT T_Commande_Liv.qte_produit, T_Commande_Liv.Reste "
            Sql = Sql & "FROM t_Devis INNER JOIN T_Commande_Liv ON t_Devis.Id = T_Commande_Liv.Id_Devis "
            Sql = Sql & "WHERE T_Commande_Liv.Id_Devis=" & Rs!Id & " "
            Sql = Sql & "AND T_Commande_Liv.NumLiv='" & NumBl & "';"
    
            Set rsQtsLiv = Conn.Execute(Sql)
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!qte_produit & "</td>"
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & rsQtsLiv!Reste & "</td>"
        End If
    End If

    Rs.MoveNext
Wend
If Session("SaveBlReste") = "" Then
    Session("SaveBl") = ""
End If
 CrerDevis = CrerDevis & vbCrLf & "                  </tr>"
Sql = "SELECT T_Frais_Transport.Frais,T_Frais_Transport.tva From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "'  "
Sql = Sql & "AND T_Frais_Transport.Frais<>0;"
Set RsCommande = Conn.Execute(Sql)
If RsCommande.EOF = False Then
Frais = RsCommande("Frais")
TotalHt = TotalHt + Frais
tva = RsCommande!tva
TotalTVA = Frais * (1 / 100) * tva
ttc = TotalTVA + Frais
TotalTva_Total = TotalTVA + TotalTva_Total
TTC_Total = TTC_Total + ttc
    CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevis = CrerDevis & vbCrLf & "                    "
'    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >Fais de transport</td>"
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" colspan=""4"">Fais de transport</td>"
     ttc = FomatNum(ttc, 3)
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >"
     
            Frais = FomatNum(Frais, 3)
            TotalHt = FomatNum(TotalHt, 3)
            TotalTVA = FomatNum(TotalTVA, 3)
            ttc = FomatNum(ttc, 3)

    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & Frais & "</td>"
'    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TVA & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TotalTVA & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & ttc & "</td>"
        
    If Session("candidat_UserType") = "Administrator" Or Bl = True Then
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        If Bl = False Then
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        End If
    End If
    CrerDevis = CrerDevis & vbCrLf & "                  </tr>"
End If


CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevis = CrerDevis & vbCrLf & "                    "
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" colspan=""5"">Total</td>"
     TotalHt = FomatNum("" & TotalHt, 3)
     TTC_Total = FomatNum("" & TTC_Total, 3)
     TotalTva_Total = FomatNum("" & TotalTva_Total, 3)
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TotalHt & "</td>"
'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" > &nbsp </td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TotalTva_Total & "</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TTC_Total & "</td>"
        
'     TotalTva_Total TTC_Total
    
    If Session("candidat_UserType") = "Administrator" Or Bl = True Then
'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
'         If Request("ApprecuBL") <> "" Then TotalTva_Total = FomatNum("" & TotalTva_Total, 3)
'        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TotalTva_Total & "</td>"
''        If Bl = False Then
' If Request("ApprecuBL") <> "" Then TotalTTC = FomatNum("" & TotalTTC, 3)
'            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TotalTTC & "</td>"
'            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
             CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        If Bl = False Then
       
            CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >&nbsp</td>"
        End If

    End If
    CrerDevis = CrerDevis & vbCrLf & "                  </tr>"
CrerDevis = CrerDevis & vbCrLf & "</table>"

Sql = "SELECT T_Frais_Transport.Tansporteur, T_Frais_Transport.Frais, T_Frais_Transport.Reference, "
Sql = Sql & "T_Frais_Transport.Telephone From T_Frais_Transport "
Sql = Sql & "WHERE T_Frais_Transport.numDevis='" & replaceAccent("" & numDevis, True, True) & "';"
 Set RsCommande = Conn.Execute(Sql)
 
If (Session("candidat_UserType") = "Administrator" And Bl = False) Or RsCommande.EOF = False Then
If UCase(RsFrais_Transport!ModeTransport) = UCase(GetDefault("LivraisonTransporteur", "Je désire  que ma commande me soit remise par transporteur suivant les conditions générales de ventes.", DsnTableMenu(Session("candidat_ADOContact")))) Then
    

    CrerDevis = CrerDevis & vbCrLf & "<br>"
    CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
    CrerDevis = CrerDevis & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
    CrerDevis = CrerDevis & vbCrLf & "    <tr>"
    CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
    CrerDevis = CrerDevis & vbCrLf & "bandeg.gif"" border=""0""></td>"
    If (Session("candidat_UserType") = "Administrator" And Bl = False) Then
        CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Frais de transport.</td>"
    Else
        CrerDevis = CrerDevis & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Information Transporteur.</td>"
    End If
    CrerDevis = CrerDevis & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
    CrerDevis = CrerDevis & vbCrLf & "banded.gif"" border=""0""></td>"
    CrerDevis = CrerDevis & vbCrLf & "    </tr>"
    CrerDevis = CrerDevis & vbCrLf & "</table>"
    CrerDevis = CrerDevis & vbCrLf & ""

    CrerDevis = CrerDevis & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
    CrerDevis = CrerDevis & vbCrLf & "    <tr>"
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Transporteur")) & "</td>"
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence du Colis")) & "</td>"
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("T&eacute;l&eacute;phone")) & "</td>"


If (Session("candidat_UserType") = "Administrator" And Bl = False) Or RsCommande("Frais") = 0 Then
    CrerDevis = CrerDevis & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P. U.H.T. ")) & "</td>"
End If

    CrerDevis = CrerDevis & vbCrLf & "        "

    CrerDevis = CrerDevis & vbCrLf & "    </tr>"
 If RsCommande.EOF = False Then
    NamTansport = "" & RsCommande("Tansporteur")
    RefTansport = "" & RsCommande("Reference")
    TelTansport = "" & RsCommande("Telephone")
    ValTansport = "" & RsCommande("Frais")


 End If
 RsCommande.Close
 Set RsCommande = Nothing

If Session("candidat_UserType") = "Administrator" And val("" & ValTansport) = 0 Or BlExiste = False Then
   If Session("candidat_UserType") = "Administrator" Then
        CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""NamTansport"" size=""100%"" Value=""" & NamTansport & """> </td>"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center""><input type=""text"" name=""RefTansport"" size=""15%"" Value=""" & RefTansport & """ ></td>"
        CrerDevis = CrerDevis & vbCrLf & "                    "
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""TelTansport"" size=""15%"" Value=""" & TelTansport & """></td>"
    '    CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
        CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""15%"" Value=""" & ValTansport & """ onchange=""Isdouble('ValTansport');""></td>"
        CrerDevis = CrerDevis & vbCrLf & "                  </tr>"
   End If
   
   End If
If Session("candidat_UserType") <> "Administrator" Or BlExiste = True Then
 If val("" & ValTansport) <> 0 Then
    CrerDevis = CrerDevis & vbCrLf & "         <input type=""hidden"" name=""NamTansport""  Value=""" & NamTansport & """>"
    CrerDevis = CrerDevis & vbCrLf & "                "
   
        CrerDevis = CrerDevis & vbCrLf & "          <input type=""hidden"" name=""RefTansport""  Value=""" & RefTansport & """ >"
    
    CrerDevis = CrerDevis & vbCrLf & "                    "
    CrerDevis = CrerDevis & vbCrLf & "         <input type=""hidden"" name=""TelTansport""  Value=""" & TelTansport & """>"
'    CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
    CrerDevis = CrerDevis & vbCrLf & "          <input type=""hidden"" name=""ValTansport""  Value=""" & ValTansport & """ >"
End If
If val("" & ValTansport) <> 0 Then
     CrerDevis = CrerDevis & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
    CrerDevis = CrerDevis & vbCrLf & "                    "
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & NamTansport & "</td>"
    CrerDevis = CrerDevis & vbCrLf & "                    "
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"">" & RefTansport & "</td>"
    CrerDevis = CrerDevis & vbCrLf & "                    "
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & TelTansport & "</td>"
    End If
'    CrerDevis = CrerDevis & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
If (Session("candidat_UserType") = "Administrator" And Bl = False) Then
    CrerDevis = CrerDevis & vbCrLf & "          <td align=""center"" >" & ValTansport & "</td>"
End If
    CrerDevis = CrerDevis & vbCrLf & "                  </tr>"
End If
     CrerDevis = CrerDevis & vbCrLf & "                  </Table>"


End If
 If Session("candidat_UserType") = "Administrator" Then
  CrerDevis = CrerDevis & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
  If NumBl = "" Then
    CrerDevis = CrerDevis & vbCrLf & " <td align=""right"" ><a href='javascript:ValideBl();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Livraison.GIF"" border=""0""></a>&nbsp&nbsp&nbsp"
    CrerDevis = CrerDevis & vbCrLf & " <a href='javascript:this.document.MAJPrixLiveraison.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a></TD></tr>"
    End If
    CrerDevis = CrerDevis & vbCrLf & "</Table>"
    
    End If
     CrerDevis = CrerDevis & vbCrLf & "          <input type=""hidden"" name =""NumLigne"" value=""" & NumLigne & """>"
     CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""TypeLiv"" value="""">"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""mode""  value= ""HISTORIQUE_Eboutique_Affiche_Commande"">"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""IdSup""  value= """">"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""Maj""  value= ""Prix"">"
CrerDevis = CrerDevis & vbCrLf & "  <input type=""hidden"" name=""RefCommande""  value= """ & numDevis & """ > "

CrerDevis = CrerDevis & vbCrLf & "</Form >"

    End If
  RsFrais_Transport.Close
Set RsLiv = Nothing


CrerDevis = CrerDevis & vbCrLf & "</td><td background=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
CrerDevis = CrerDevis & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
CrerDevis = CrerDevis & vbCrLf & "<td background=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
CrerDevis = CrerDevis & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
CrerDevis = CrerDevis & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
CrerDevis = CrerDevis & vbCrLf & "</tr></table>"
CrerDevis = CrerDevis & vbCrLf & "</body>"
CrerDevis = CrerDevis & vbCrLf & "</html>"
Rs.Close
Set Rs = Nothing
End Function
Private Function AfficherCommande(Conn, numDevis, Optional Afficher As Boolean, Optional Bl As Boolean, Optional NumBl As String, Optional VisuBl As Boolean)
Dim Sql As String
Dim Rs As Recordset
Dim UpdateDevis As Boolean
Dim RsCommande As Recordset
Dim My_NumCommande As String
Dim My_Num_Avoire As Long
Dim NumLigne As Long
Dim Id_Avoire As Long
Dim ValSolde As Double
Debug.Print Request("BR")
Dim RsMenu As Recordset
Dim Br_Id As Long
Dim L As Long
Dim RsBr As Recordset
Dim BrNotCloturer As Boolean
Dim Entete_Champs() As String
Dim PrixFraisTransportPonderer As Double
Dim PrixFraisTransport As Double
Dim Prix_T As Double
Dim GeneDateRecepPrevue As String
Dim GeneDateRelance As String
Dim Br As Boolean
If UCase("" & Request("BR")) = "YES" Then
    Br = True
Else
    Br = False
End If
'EntateChamps
Sql = "SELECT T_BR.Solder From T_BR  "
Sql = Sql & "WHERE T_BR.Solder=False "
Sql = Sql & "AND T_BR.Id_Com_Four=" & numDevis & ";"
 Set rsCommandeValider = Conn.Execute(Sql)
BrNotCloturer = rsCommandeValider.EOF
myQts = False

    Sql = "SELECT T_Devis_Four_Raison_Social.CommandeValider,T_Devis_Four_Raison_Social.EnvoyeMail From T_Devis_Four_Raison_Social "
    Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"
 Set rsCommandeValider = Conn.Execute(Sql)
 Afficher = rsCommandeValider!CommandeValider
 EnvoyeMail = rsCommandeValider!EnvoyeMail
 Lst = GetDefault("IdFornisuer", "lst9", DsnTableMenu(Session("candidat_ADOContact")))
 If Request("ACT") = "UpdateFraisLiv" Then
    Sql = "SELECT T_Frais_de_transport_Four.* From T_Frais_de_transport_Four "
    Sql = Sql & "WHERE T_Frais_de_transport_Four.Id_Com_Four=" & numDevis & ";"
     Set rsFrais = Conn.Execute(Sql)
     If rsFrais.EOF = False Then
        Sql = "UPDATE T_Frais_de_transport_Four SET "
        Sql = Sql & "T_Frais_de_transport_Four.Transporteur = " & noquote2(Request("NamTansport")) & ", "
        Sql = Sql & "T_Frais_de_transport_Four.ReffColis =  " & noquote2(Request("RefTansport")) & ", "
        Sql = Sql & "T_Frais_de_transport_Four.Telephone = " & noquote2(Request("TelTansport")) & ", "
        Sql = Sql & "T_Frais_de_transport_Four.PHT = " & Replace(Request("ValTansport"), ",", ".") & " "
        Sql = Sql & "WHERE T_Frais_de_transport_Four.Id_Com_Four=" & numDevis & ";"

       

     Else
'        NamTansport RefTansport TelTansport ValTansport
         Sql = "INSERT INTO T_Frais_de_transport_Four ( Transporteur, ReffColis, Telephone, PHT, Id_Com_Four ) "
        Sql = Sql & "VALUES (" & noquote2(Request("NamTansport")) & ", " & noquote2(Request("RefTansport")) & ", " & noquote2(Request("TelTansport")) & " , " & Replace(Request("ValTansport"), ",", ".") & " , " & numDevis & " );"
     End If
      Conn.Execute (Sql)
      rsFrais.Close
      Set rsFrais = Nothing
 End If
 If Request("ACT") = "UpdateFraisDivers" Then
 For I = 1 To val(Request("Douane_Desing_Nb_Ligne"))
    Sql = "UPDATE T_Frais_Divers_Four SET  "
        Sql = Sql & "T_Frais_Divers_Four.Type_Frais = " & Request("Douane_Type_" & I) & ",  "
        Sql = Sql & "T_Frais_Divers_Four.RefTypeFrais = " & noquote2(Request("Douane_Desing_" & I)) & ",  "
        Sql = Sql & "T_Frais_Divers_Four.PHT = " & Replace("" & Request("Douane_PrixHt_" & I), ",", ".") & ",  "
        Sql = Sql & "T_Frais_Divers_Four.QTS = " & Replace("" & Request("Douane_Qts_" & I), ",", ".") & ", "
        Sql = Sql & " T_Frais_Divers_Four.PTHT = " & Replace("" & Request("Douane_Qts_X_PHT_" & I), ",", ".") & " "
        Sql = Sql & "WHERE T_Frais_Divers_Four.Id=" & Request("Douane_Desing_Id" & I) & ";"
        Conn.Execute Sql
        
        If Trim("" & Request("Douane_Delete_" & I)) <> "" Then
           Sql = "DELETE T_Frais_Divers_Four.* From T_Frais_Divers_Four "
            Sql = Sql & "WHERE T_Frais_Divers_Four.Id=" & Request("Douane_Desing_Id" & I) & ";"
            Conn.Execute Sql
        End If
       
        
'        New_

 Next
     If Trim("" & Request("New_Lib")) <> "" Then
     New_Lib_id = 0
            Sql = "SELECT T_Type_De_Frais.* From T_Type_De_Frais "
            Sql = Sql & "WHERE T_Type_De_Frais.Libelle=" & noquote2(Request("New_Lib")) & ";"
            Set RsNew_Lib = Conn.Execute(Sql)
            If RsNew_Lib.EOF = True Then
                Sql = "INSERT INTO T_Type_De_Frais ( Libelle ) values(" & noquote2(Request("New_Lib")) & ");"
                Conn.Execute Sql
              
            End If
             
             RsNew_Lib.Requery
             New_Lib_id = RsNew_Lib!Id
        End If
        If Trim(Request("New_Douane_Desing")) <> "" Then
            Sql = "INSERT INTO T_Frais_Divers_Four ( Id_Com_Four, Type_Frais, RefTypeFrais, PHT, QTS, PTHT )"
            Sql = Sql & " Values (" & numDevis & ", "
             If val(New_Lib_id) > 0 Then
               Sql = Sql & New_Lib_id
             Else
                 Sql = Sql & Request("New_Douane_Type")
             End If
            Sql = Sql & "," & noquote2(Request("New_Douane_Desing")) & ", " & Replace("" & Request("New_Douane_PrixHt"), ",", ".") & " , " & Replace("" & Request("New_Douane_Qts"), ",", ".")
            Sql = Sql & " , " & Replace("" & Request("New_Douane_Qts_X_PHT"), ",", ".") & ") ;"
            Conn.Execute Sql
        Else
        
        End If
        
 End If
 If Request("ACT") = "UpdateBR" Then
    Session("CmadFourLivrableSave") = ""
    Sql = "SELECT T_BR.* From T_BR WHERE  T_BR.BrValider=False "
    Sql = Sql & "AND T_BR.Id_Com_Four=" & numDevis & " "
    Sql = Sql & "AND T_BR.Solder=false;"
    Set RsBr = Conn.Execute(Sql)
     
   
    If RsBr.EOF = True Then
        NumBr = NumeroChrono("BR", "BR_")
        Sql = "INSERT INTO T_BR ( Id_Com_Four, NumBr ) "
        Sql = Sql & "VALUES(" & numDevis & ",'" & NumBr & "')"
        Conn.Execute Sql
    End If
    
    RsBr.Requery
    Br_Id = RsBr!Id
    RsBr.Close
    Set RsBr = Nothing
    
    For I = 1 To Request("l")
    If val(Request("l_" & I & "_Qte_Rec")) <> 0 Then
        myQts = True
        Sql = "SELECT Br_Fournisseurs.Id "
        Sql = Sql & "From Br_Fournisseurs "
        Sql = Sql & "WHERE Br_Fournisseurs.Id_Br =" & Br_Id & " "
        Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & " "
        Sql = Sql & "And DateEntreStock  Is Null;"
        Set RsBr = Conn.Execute(Sql)
        
        If RsBr.EOF = True Then
            Sql = "INSERT INTO Br_Fournisseurs ( Id_Br, Id_Menu, Id_Fournissuer, id_produit, date_modif, qte_produit, "
            Sql = Sql & "TypePiece, RefProduit, PrixU_produit, Designation, creation, Id_Avoire, QtsDispo, Reste, MyDate, remise ) "
            Sql = Sql & "SELECT " & Br_Id & " AS Id_Br, T_Devis_Four.Id_Menu, T_Devis_Four.Id_Fournissuer, T_Devis_Four.id_produit, T_Devis_Four.date_modif, "
            Sql = Sql & "T_Devis_Four.qte_produit, T_Devis_Four.TypePiece, T_Devis_Four.RefProduit, T_Devis_Four.PrixU_produit, "
            Sql = Sql & "T_Devis_Four.Designation, T_Devis_Four.creation, T_Devis_Four.Id_Avoire, T_Devis_Four.QtsDispo, T_Devis_Four.Reste, "
            Sql = Sql & "T_Devis_Four.MyDate, T_Devis_Four.remise "
            Sql = Sql & "From T_Devis_Four "
            Sql = Sql & "WHERE T_Devis_Four.id_produit=" & Request("l_" & I & "_id_produit") & " "
            Sql = Sql & "AND T_Devis_Four.Id_Com_Four=" & numDevis & ";"
            Conn.Execute Sql
            
            End If
            
            Sql = "UPDATE Br_Fournisseurs SET  "
            Sql = Sql & "Br_Fournisseurs.SokEbotique= " & FormatChamp(Request("L_" & I & "_Stock_Eboutique")) & ",  "
            Sql = Sql & "Br_Fournisseurs.SokeEncelade= " & FormatChamp(Request("L_" & I & "_Stock_Encelade")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Reste = " & FormatChamp(Request("L_" & I & "Rec_Reste")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qte_Rec = " & FormatChamp(Request("l_" & I & "_Qte_Rec")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qt_non_Conf = " & FormatChamp(Request("l_" & I & "_Qt_non_Conf")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qt_Deterior =" & FormatChamp(Request("l_" & I & "_Qt_Deterior")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Retour_Four =" & FormatChamp(Request("l_" & I & "_Retour_Four")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Type =" & FormatChamp(Request("l_" & I & "_MType")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Attendue_le =" & FormatChamp(Request("l_" & I & "_Attendue_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Relancer_le =" & FormatChamp(Request("l_" & I & "_Relancer_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Rec_le = " & FormatChamp(Request("l_" & I & "_Rec_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Ecart_Rec = " & FormatChamp(Request("l_" & I & "_Ecart_Rec")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Flag = " & FormatChamp(Request("l_" & I & "_Flag")) & "  "
            Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & "  "
            Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & ";"

             Conn.Execute Sql
           
            
            
            
            
            
            
        
        Else
            Sql = "DELETE Br_Fournisseurs.* From Br_Fournisseurs "
            Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & "  "
            Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & " "
            Sql = Sql & "And DateEntreStock  Is Null;"
            Conn.Execute (Sql)
        End If
        a = Request("l_" & I & "_id_produit")
        
    Next
    If myQts = False Then
         Sql = "DELETE T_BR.* From T_BR WHERE T_BR.Id=" & Br_Id & ";"
        Conn.Execute Sql
    End If
 End If
 If Request("ACT") = "ValiderBr" And Session("CmadFourLivrable") = "Ok" And Session("CmadFourLivrableSave") = "" Then
 
 Session("CmadFourLivrableSave") = "ok"
    Sql = "SELECT T_BR.* From T_BR WHERE  T_BR.BrValider=False "
    Sql = Sql & "AND T_BR.Id_Com_Four=" & numDevis & " "
    Sql = Sql & "AND T_BR.Solder=false;"
    
    Set RsBr = Conn.Execute(Sql)
    
    If RsBr.EOF = True Then
        NumBr = NumeroChrono("BR", "BR_")
        Sql = "INSERT INTO T_BR ( Id_Com_Four, NumBr ) "
        Sql = Sql & "VALUES(" & numDevis & ",'" & NumBr & "')"
        Conn.Execute Sql
    End If
    
    RsBr.Requery
    Br_Id = RsBr!Id
    RsBr.Close
    Set RsBr = Nothing
    
    For I = 1 To Request("l")
    If val(Request("l_" & I & "_Qte_Rec")) <> 0 Then
        Sql = "SELECT Br_Fournisseurs.Id From Br_Fournisseurs "
        Sql = Sql & "WHERE Br_Fournisseurs.Id_Br =" & Br_Id & " "
        Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & " "
        Sql = Sql & "And DateEntreStock  Is Null;"
        Set RsBr = Conn.Execute(Sql)
        
        If RsBr.EOF = True Then
            Sql = "INSERT INTO Br_Fournisseurs ( Id_Br, Id_Menu, Id_Fournissuer, id_produit, date_modif, qte_produit, "
            Sql = Sql & "TypePiece, RefProduit, PrixU_produit, Designation, creation, Id_Avoire, QtsDispo, Reste, MyDate, remise ) "
            Sql = Sql & "SELECT " & Br_Id & " AS Id_Br, T_Devis_Four.Id_Menu, T_Devis_Four.Id_Fournissuer, T_Devis_Four.id_produit, T_Devis_Four.date_modif, "
            Sql = Sql & "T_Devis_Four.qte_produit, T_Devis_Four.TypePiece, T_Devis_Four.RefProduit, T_Devis_Four.PrixU_produit, "
            Sql = Sql & "T_Devis_Four.Designation, T_Devis_Four.creation, T_Devis_Four.Id_Avoire, T_Devis_Four.QtsDispo, T_Devis_Four.Reste, "
            Sql = Sql & "T_Devis_Four.MyDate, T_Devis_Four.remise "
            Sql = Sql & "From T_Devis_Four "
            Sql = Sql & "WHERE T_Devis_Four.id_produit=" & Request("l_" & I & "_id_produit") & " "
            Sql = Sql & "AND T_Devis_Four.Id_Com_Four=" & numDevis & ";"
            Conn.Execute Sql
            
            End If
            
            Sql = "UPDATE Br_Fournisseurs SET  "
            Sql = Sql & "Br_Fournisseurs.SokEbotique= " & FormatChamp(Request("L_" & I & "_Stock_Eboutique")) & ",  "
            Sql = Sql & "Br_Fournisseurs.SokeEncelade= " & FormatChamp(Request("L_" & I & "_Stock_Encelade")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Reste = " & FormatChamp(Request("L_" & I & "Rec_Reste")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qte_Rec = " & FormatChamp(Request("l_" & I & "_Qte_Rec")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qt_non_Conf = " & FormatChamp(Request("l_" & I & "_Qt_non_Conf")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Qt_Deterior =" & FormatChamp(Request("l_" & I & "_Qt_Deterior")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Retour_Four =" & FormatChamp(Request("l_" & I & "_Retour_Four")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Type =" & FormatChamp(Request("l_" & I & "_MType")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Attendue_le =" & FormatChamp(Request("l_" & I & "_Attendue_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Relancer_le =" & FormatChamp(Request("l_" & I & "_Relancer_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Rec_le = " & FormatChamp(Request("l_" & I & "_Rec_le")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Ecart_Rec = " & FormatChamp(Request("l_" & I & "_Ecart_Rec")) & ",  "
            Sql = Sql & "Br_Fournisseurs.Flag = " & FormatChamp(Request("l_" & I & "_Flag")) & "  "
            Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & "  "
            Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & ";"

             Conn.Execute Sql
            
            
            
            
            
            
        
        Else
            Sql = "DELETE Br_Fournisseurs.* From Br_Fournisseurs "
            Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & "  "
            Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Request("l_" & I & "_id_produit") & " "
            Sql = Sql & "And DateEntreStock  Is Null;"
            Conn.Execute (Sql)
        End If
        a = Request("l_" & I & "_id_produit")
        
    Next
    Sql = "SELECT Sum(Br_Fournisseurs.PrixU_produit) AS SommeDePrixU_produit From Br_Fournisseurs "
     Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & ";  "
'    Sql = Sql & "And DateEntreStock  Is Null;"
    Set RsBr = Conn.Execute(Sql)
     If RsBr.EOF = False Then
        SommeDePrixU_produit = val(Replace(Trim("" & RsBr!SommeDePrixU_produit), ",", "."))
        
    End If
    Sql = "SELECT T_BR.Id_Com_Four,Br_Fournisseurs.* FROM T_BR INNER JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br "
    Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Br_Id & "  "
    Sql = Sql & "And DateEntreStock  Is Null;"
    Set RsBr = Conn.Execute(Sql)
    
    
    
    While RsBr.EOF = False
'        Sql = "SELECT Sum(T_Frais_de_transport_Four.PHT) AS SommeDePHT From T_Frais_de_transport_Four "
'        Sql = Sql & "WHERE T_Frais_de_transport_Four.Id_Com_Four=" & RsBr!Id_Com_Four & ";"
'        Set RsFraisTransport = Conn.Execute(Sql)
'         PrixFraisTransport = 0
'        If RsFraisTransport.EOF = False Then
'            PrixFraisTransport = val(Replace(Trim("" & RsFraisTransport!SommeDePHT), ",", "."))
'        End If
'        RsFraisTransport.Close
'        Set RsFraisTransport = Nothing
        Sql = "SELECT Sum(T_Frais_Divers_Four.PTHT) AS SommeDePTHT From T_Frais_Divers_Four "
        Sql = Sql & "WHERE T_Frais_Divers_Four.Id_Com_Four=" & RsBr!Id_Com_Four & ";"
        Set RsFraisTransport = Conn.Execute(Sql)
         If RsFraisTransport.EOF = False Then
            PrixFraisTransport = val(Replace(Trim("" & RsFraisTransport!SommeDePTHT), ",", "."))
        End If
         RsFraisTransport.Close
        Set RsFraisTransport = Nothing
        Sql = "SELECT Sum(frm.Prix_T) AS Prix_T "
        Sql = Sql & "FROM (SELECT T_Devis_Four.Id_Com_Four, [qte_produit]*[PrixU_produit] AS Prix_T From T_Devis_Four "
        Sql = Sql & "WHERE T_Devis_Four.Id_Com_Four=" & RsBr!Id_Com_Four & ") AS frm;"
        
        Set RsTotal = Conn.Execute(Sql)
        If RsTotal.EOF = False Then
            Prix_T = RsTotal!Prix_T
        End If
        PourCent = (RsBr!PrixU_produit * RsBr!qte_produit) * (1 / Prix_T)
       PrixFraisTransportPonderer = PrixFraisTransport * PourCent / RsBr!qte_produit
       
'         PrixFraisTransportPonderer = val(Replace(Trim("" & RsBr!PrixU_produit), ",", ".")) * (1 / PrixFraisTransport)
         
        MajEbotique RsBr, Conn, val(Replace(Trim("" & PrixFraisTransportPonderer), ",", "."))
        RsBr.MoveNext
    Wend
 End If
If Request("ACT") = "UpdateFournisseur" Then
    If Request("ID_Four") <> "" And Request("ID_Four") <> 0 Then
   
    SqlFour = "UPDATE " & Lst & " SET "
    SqlFour = SqlFour & Lst & ".CatName = '" & replaceAccent(Request("SocieteFour"), True) & "', "
    SqlFour = SqlFour & Lst & ".Adresse = '" & replaceAccent(Request("AdresseFour"), True, True) & "', "
    SqlFour = SqlFour & Lst & ".Pays = '" & replaceAccent(Request("PaysFour"), True) & "', "
    SqlFour = SqlFour & Lst & ".Telephone = '" & replaceAccent(Request("TelephoneFour"), True, True) & "', "
    SqlFour = SqlFour & Lst & ".Fax = '" & replaceAccent(Request("FaxFour"), True, True) & "', "
    SqlFour = SqlFour & Lst & ".Service ='" & replaceAccent(Request("ServiceFour"), True, True) & "', "
    SqlFour = SqlFour & Lst & ".Mail = '" & replaceAccent(Request("MailFour"), True, True) & "' "
    SqlFour = SqlFour & "WHERE " & Lst & ".CatID= " & Request("ID_Four") & ";"
    Set RsMenu = Conn.Execute("SELECT Menu.* FROM Menu ;")
    ExecSqlListe RsMenu, SqlFour
    End If
    
    Sql = "UPDATE T_Devis_Four_Raison_Social SET "
    Sql = Sql & "T_Devis_Four_Raison_Social.CatName = '" & replaceAccent(Request("SocieteFour"), True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Adresse = '" & replaceAccent(Request("AdresseFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Pays = '" & replaceAccent(Request("PaysFour"), True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Telephone = '" & replaceAccent(Request("TelephoneFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Fax = '" & replaceAccent(Request("FaxFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Service ='" & replaceAccent(Request("ServiceFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.VosReff ='" & replaceAccent(Request("VosRefFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Contact ='" & replaceAccent(Request("ContactFour"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Raison_Social.Mail = '" & replaceAccent(Request("MailFour"), True, True) & "' "
    Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four= " & numDevis & ";"
   
   Conn.Execute Sql
End If
If Request("ACT") = "UpdateAdresseLiv" Then
    Sql = "UPDATE T_Devis_Four_Societe SET  "
    Sql = Sql & "T_Devis_Four_Societe.RaisonSocialLiv = '" & replaceAccent(Request("SocieteLiv"), True, True) & "',  "
    Sql = Sql & "T_Devis_Four_Societe.AddLiv1 = '" & replaceAccent(Request("AddLiv1"), True, True) & "',  "
    Sql = Sql & "T_Devis_Four_Societe.AddLiv2 = '" & replaceAccent(Request("AddLiv2"), True, True) & "',  "
    Sql = Sql & "T_Devis_Four_Societe.AddLiv3 = '" & replaceAccent(Request("AddLiv3"), True, True) & "',  "
    Sql = Sql & "T_Devis_Four_Societe.CpLiv = '" & replaceAccent(Request("CpLiv"), True, True) & "',"
    Sql = Sql & "T_Devis_Four_Societe.VilleLiv ='" & replaceAccent(Request("VilleLiv"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Societe.TelLiv = '" & replaceAccent(Request("TelLiv"), True, True) & "',  "
    Sql = Sql & "T_Devis_Four_Societe.FaxLiv = '" & replaceAccent(Request("FaxLiv"), True, True) & "',  "
 
    Sql = Sql & "T_Devis_Four_Societe.beneficiaire = '" & replaceAccent(Request("beneficiaire"), True, True) & "' "
    Sql = Sql & "WHERE T_Devis_Four_Societe.Id_Com_Four= " & numDevis & ";"
    Conn.Execute Sql
End If
If Request("ACT") = "UpdateCondition" Then
    Sql = "UPDATE T_Devis_Fournisseurs INNER JOIN T_Devis_Four_Societe ON T_Devis_Fournisseurs.Id = T_Devis_Four_Societe.Id_Com_Four SET "
    Sql = Sql & "T_Devis_Four_Societe.ConditionPaiement = '" & replaceAccent(Request("ConditionPaiement"), True, True) & "', "
    Sql = Sql & "T_Devis_Four_Societe.DateLivraison = '" & replaceAccent(Request("DateLivraison"), True, True) & "',"
    Sql = Sql & "T_Devis_Fournisseurs.DateRecepPrevue = #" & Format(Request("DateLivraison"), "yyyy-mm-dd hh:mm:ss") & "#,"
     Sql = Sql & "T_Devis_Fournisseurs.DateRelance = #" & Format(Request("DateLivraison"), "yyyy-mm-dd hh:mm:ss") & "# - 3 "
    Sql = Sql & "WHERE T_Devis_Four_Societe.Id_Com_Four= " & numDevis & ";"
    Conn.Execute Sql
End If
If Request("ACT") = "ConfirmeComande" Then
    Sql = "UPDATE T_Devis_Four_Raison_Social SET T_Devis_Four_Raison_Social.CommandeValider = True "
    Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four= " & numDevis & ";"
    Conn.Execute Sql
    Afficher = True
End If
AfficherCommande = ""

AfficherCommande = AfficherCommande & vbCrLf & "<head>"
Sql = "SELECT T_Devis_Fournisseurs.* From T_Devis_Fournisseurs "
Sql = Sql & "WHERE T_Devis_Fournisseurs.Id=" & numDevis & ";"
Set Rscom = Conn.Execute(Sql)
GeneDateRelance = Format("" & Rscom![DateRelance], "dd/mm/yyyy")
GeneDateRecepPrevue = Format("" & Rscom![DateRecepPrevue], "dd/mm/yyyy")
commande = "" & Rscom!commande
DateCommande = GeneDateRecepPrevue
Rscom.Close
Set Rscom = Nothing

    AfficherCommande = AfficherCommande & vbCrLf & "<title>Commande N° " & commande & "</title>"
AfficherCommande = AfficherCommande & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
AfficherCommande = AfficherCommande & vbCrLf & "<link rel=""stylesheet"" href=""" & Session("contact_devis") & "encelade.css""></head>"
AfficherCommande = AfficherCommande & vbCrLf & ""
AfficherCommande = AfficherCommande & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"
AfficherCommande = AfficherCommande & vbCrLf & "<script language='javascript' src='../Portal_Java/FunJava.js'></script>"
'AfficherCommande = AfficherCommande & vbCrLf & "<script language='javaScript' src=/FunJava.js'></script>"
AfficherCommande = AfficherCommande & vbCrLf & "<script language='javascript'>"
AfficherCommande = AfficherCommande & vbCrLf & "function StockEboutique(frm,QtsRecue,QtsPreleve,QtsReste,RetourFour){"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyQtsRecue;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyQtsPreleve;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyRetourFour;"
AfficherCommande = AfficherCommande & vbCrLf & "    var Err=false;"
AfficherCommande = AfficherCommande & vbCrLf & "    MyQtsRecue = document.forms[frm].elements[QtsRecue];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyQtsPreleve = document.forms[frm].elements[QtsPreleve];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyQtsReste= document.forms[frm].elements[QtsReste];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyRetourFour = document.forms[frm].elements[RetourFour];"
'AfficherCommande = AfficherCommande & vbCrLf & "    alert(MyQtsRecue.Value);"
AfficherCommande = AfficherCommande & vbCrLf & "     if (!testEntier(MyQtsRecue.value)){"

AfficherCommande = AfficherCommande & vbCrLf & "    alert('" & GetMessage("SaisirQuantiteReceptionnee", "Vous deviez d´abord saisir une quantité réceptionnée.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficherCommande = AfficherCommande & vbCrLf & "     MyQtsPreleve.value='';"
AfficherCommande = AfficherCommande & vbCrLf & "    return;"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "     if (!testEntier(MyQtsPreleve.value)){"
AfficherCommande = AfficherCommande & vbCrLf & "        alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "        MyQtsPreleve.value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        MyQtsReste.value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        return;"
AfficherCommande = AfficherCommande & vbCrLf & "      }"
AfficherCommande = AfficherCommande & vbCrLf & "var QtsFour=parseInt(MyRetourFour.value);"
AfficherCommande = AfficherCommande & vbCrLf & "     if (!testEntier(MyRetourFour.value)) QtsFour=0;"
AfficherCommande = AfficherCommande & vbCrLf & " funerror=funMath(parseInt(MyQtsRecue.value),parseInt(MyQtsPreleve.value) + parseInt(QtsFour),'-',true)"
AfficherCommande = AfficherCommande & vbCrLf & "     if (funerror=='Err'){"
'AfficherCommande = AfficherCommande & vbCrLf & "         alert('Vous devez saisir une valeur inférieure ou égale à la valeur reçue.');"
AfficherCommande = AfficherCommande & vbCrLf & "         MyQtsPreleve.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "         MyQtsReste.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "         return;"
AfficherCommande = AfficherCommande & vbCrLf & "     "
AfficherCommande = AfficherCommande & vbCrLf & "      }"
AfficherCommande = AfficherCommande & vbCrLf & "    MyQtsReste.value=funerror;"
AfficherCommande = AfficherCommande & vbCrLf & "}"
AfficherCommande = AfficherCommande & vbCrLf & "function Isdouble(FRM,Obj){"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyObj;"
AfficherCommande = AfficherCommande & vbCrLf & "    MyObj = document.forms[FRM].elements[Obj];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyObj.value=jsTrim(MyObj.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyObj.value.length > 0) {"
AfficherCommande = AfficherCommande & vbCrLf & "        MyObj.value=Remplacer(MyObj.value,',','.');"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testFloat(MyObj.value)) {"
AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficherCommande = AfficherCommande & vbCrLf & "            MyObj.value='';"
AfficherCommande = AfficherCommande & vbCrLf & "            return;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "function SousQts(frm,Entrer1,Entrer2,Sorite1,Sorite2,Feff_Sortie,Signe,negatif,ResetEntre,entier,index)"
AfficherCommande = AfficherCommande & vbCrLf & "{"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyEntrer1;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyEntrer2"
AfficherCommande = AfficherCommande & vbCrLf & "    var MySorite1;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MySorite2"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyFeff_Sortie;"
AfficherCommande = AfficherCommande & vbCrLf & "    var Err=false;"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer1 = document.forms[frm].elements[Entrer1];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer2 = document.forms[frm].elements[Entrer2];"
AfficherCommande = AfficherCommande & vbCrLf & "    MySorite1 = document.forms[frm].elements[Sorite1];"
AfficherCommande = AfficherCommande & vbCrLf & "    MySorite2 = document.forms[frm].elements[Sorite2];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyFeff_Sortie = document.forms[frm].elements[Feff_Sortie];"

AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer1.value=MyTrim(MyEntrer1.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer2.value=MyTrim(MyEntrer2.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer1.value=MyTrim(MyEntrer1.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer2.value=MyTrim(MyEntrer2.value);"

AfficherCommande = AfficherCommande & vbCrLf & "    if (entier==true) {"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testEntier(MyEntrer1.value)){"
AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer1.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "            Err=true;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "     } else {"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testFloat(MyEntrer1.value)){"

AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirNombre", "Vous devez saisir un nombre.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer1.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "             Err=true;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "     }"

AfficherCommande = AfficherCommande & vbCrLf & "    if (entier==true) {"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testEntier(MyEntrer2.value)){"
AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer2.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "             Err=true;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "    } else {"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testFloat(MyEntrer2.value)){"
AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirNombre", "Vous devez saisir un nombre.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer2.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "             Err=true;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "    }"

AfficherCommande = AfficherCommande & vbCrLf & "    var ReturnError='';"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer1.value=parseInt(MyEntrer1.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyEntrer2.value=parseInt(MyEntrer2.value);"
AfficherCommande = AfficherCommande & vbCrLf & "                if (MyEntrer2.value<0){"

AfficherCommande = AfficherCommande & vbCrLf & "                    alert('" & GetMessage("SaisirNegative", "Vous ne pouvez pas saisir une valeur négative.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficherCommande = AfficherCommande & vbCrLf & "                    MyEntrer2.value='0';"
AfficherCommande = AfficherCommande & vbCrLf & "                     ReturnError='Err';"
AfficherCommande = AfficherCommande & vbCrLf & "                   "
AfficherCommande = AfficherCommande & vbCrLf & "                }"


AfficherCommande = AfficherCommande & vbCrLf & "    ReturnError=funMath(MyEntrer1.value,MyEntrer2.value,Signe,negatif);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (ReturnError=='Err') {"

AfficherCommande = AfficherCommande & vbCrLf & "        Err=true;"
AfficherCommande = AfficherCommande & vbCrLf & "      }"
AfficherCommande = AfficherCommande & vbCrLf & "    if (Err==true) {"
AfficherCommande = AfficherCommande & vbCrLf & "        MySorite1.value=MyFeff_Sortie.value;"
AfficherCommande = AfficherCommande & vbCrLf & "        MySorite2.value=MyFeff_Sortie.value;"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Qt_non_Conf'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Qt_Deterior'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Retour_Four'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Stock_Encelade'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Stock_Eboutique'].value='';"

AfficherCommande = AfficherCommande & vbCrLf & "        if (ResetEntre==1){"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer1.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "        } else {"
AfficherCommande = AfficherCommande & vbCrLf & "            MyEntrer2.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "        return;"
AfficherCommande = AfficherCommande & vbCrLf & "       }"
AfficherCommande = AfficherCommande & vbCrLf & "        MySorite1.value=ReturnError"
AfficherCommande = AfficherCommande & vbCrLf & "        MySorite2.value=ReturnError"
'AfficherCommande = AfficherCommande & vbCrLf & "        MySorite2.value=MyFeff_Sortie.value;"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Qt_non_Conf'].value='';"
'AfficherCommande = AfficherCommande & vbCrLf & "        alert(MySorite2.value);"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Qt_Deterior'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Retour_Four'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Stock_Encelade'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "        document.forms[frm].elements['L_'+index+'_Stock_Eboutique'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "}"
AfficherCommande = AfficherCommande & vbCrLf & "function ControlRetourFournisseurs(frm,Obj,PasInf,index){"
AfficherCommande = AfficherCommande & vbCrLf & "    ControlEntier(frm,Obj,PasInf);"
AfficherCommande = AfficherCommande & vbCrLf & "    document.forms[frm].elements['L_'+index+'_Stock_Encelade'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & "    document.forms[frm].elements['L_'+index+'_Stock_Eboutique'].value='';"
AfficherCommande = AfficherCommande & vbCrLf & ""
AfficherCommande = AfficherCommande & vbCrLf & "}"
'('frmBr','L_" & L & "_Retour_Four','L_" & L & "_Qte_Rec')"
AfficherCommande = AfficherCommande & vbCrLf & "function MultipliValeur(FRM,OperateurEntier,MuliplicateurDouble,ValRetourer){"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyOperateur;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyMultiplicateur;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyValRetourer"
AfficherCommande = AfficherCommande & vbCrLf & "    MyOperateur= document.forms[FRM].elements[OperateurEntier];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyMultiplicateur= document.forms[FRM].elements[MuliplicateurDouble];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyValRetourer= document.forms[FRM].elements[ValRetourer];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyOperateur.value=jsTrim(MyOperateur.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyOperateur.value.length > 0) {"
AfficherCommande = AfficherCommande & vbCrLf & "        if (testFloat(MyOperateur.value)) {"
AfficherCommande = AfficherCommande & vbCrLf & "            MyOperateur.value=MyOperateur.value * 1;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testEntier(MyOperateur.value)){"
AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyOperateur.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "    MyMultiplicateur.value=jsTrim(MyMultiplicateur.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyMultiplicateur.value.length > 0) {"
AfficherCommande = AfficherCommande & vbCrLf & "    MyMultiplicateur.value=Remplacer(MyMultiplicateur.value,',','.');"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testFloat(MyMultiplicateur.value)) {"

AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirNumerique", "Vous devez saisir une valeur numérique.", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficherCommande = AfficherCommande & vbCrLf & "            MyMultiplicateur.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "   MyValRetourer.value= MyMultiplicateur.value * MyOperateur.value"
AfficherCommande = AfficherCommande & vbCrLf & "}"
AfficherCommande = AfficherCommande & vbCrLf & "function ControlEntier(frm,Obj,PasInf){"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyObj;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyPasInf;"
AfficherCommande = AfficherCommande & vbCrLf & "    MyObj= document.forms[frm].elements[Obj];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyPasInf= document.forms[frm].elements[PasInf];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyPasInf.value=MyTrim(MyPasInf.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyPasInf.value=MyTrim(MyPasInf.value);"
AfficherCommande = AfficherCommande & vbCrLf & "        if (!testEntier(MyObj.value)){"

AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("SaisirEntier", "Vous devez saisir un nombre Entier.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyObj.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "            return;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"

AfficherCommande = AfficherCommande & vbCrLf & "        MyObj.value=parseInt(MyObj.value);"
AfficherCommande = AfficherCommande & vbCrLf & "        MyPasInf.value=parseInt(MyPasInf.value);"
AfficherCommande = AfficherCommande & vbCrLf & "        if (parseInt(MyObj.value)>parseInt(MyPasInf.value)){"

AfficherCommande = AfficherCommande & vbCrLf & "            alert('" & GetMessage("ValinferieureOuEgale", "Vous devez saisir une valeur\ninférieure\nou\négale à la valeur reçue.", DsnTableMenu(Session("candidat_ADOContact"))) & "') ;"
AfficherCommande = AfficherCommande & vbCrLf & "            MyObj.value=0;"
AfficherCommande = AfficherCommande & vbCrLf & "            return;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"

AfficherCommande = AfficherCommande & vbCrLf & "}"
'
AfficherCommande = AfficherCommande & vbCrLf & "function EcatDate(frm,Format,DateDeb,DateFin,SortieEcart)"
AfficherCommande = AfficherCommande & vbCrLf & "{"
'AfficherCommande = AfficherCommande & vbCrLf & " alert(Format);"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyDateDeb;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MyDateFin;"
AfficherCommande = AfficherCommande & vbCrLf & "    var MySortieEcart;"
AfficherCommande = AfficherCommande & vbCrLf & "    MyDateDeb = document.forms[frm].elements[DateDeb];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyDateFin = document.forms[frm].elements[DateFin];"
AfficherCommande = AfficherCommande & vbCrLf & "    MySortieEcart = document.forms[frm].elements[SortieEcart];"
AfficherCommande = AfficherCommande & vbCrLf & "    MyDateDeb.value=MyTrim( MyDateDeb.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    MyDateFin.value=MyTrim( MyDateFin.value);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyDateDeb.value==''){"
AfficherCommande = AfficherCommande & vbCrLf & "       MySortieEcart.value=''; "
AfficherCommande = AfficherCommande & vbCrLf & "       return;"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyDateFin.value==''){"
AfficherCommande = AfficherCommande & vbCrLf & "       MySortieEcart.value=''; "
AfficherCommande = AfficherCommande & vbCrLf & "       return;"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "    SaisieDate(frm,DateDeb);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyDateDeb.value==''){"
AfficherCommande = AfficherCommande & vbCrLf & "       MySortieEcart.value=''; "
AfficherCommande = AfficherCommande & vbCrLf & "       return;"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "    SaisieDate(frm,DateFin);"
AfficherCommande = AfficherCommande & vbCrLf & "    if (MyDateFin.value==''){"
AfficherCommande = AfficherCommande & vbCrLf & "       MySortieEcart.value=''; "
AfficherCommande = AfficherCommande & vbCrLf & "       return;"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "    MySortieEcart.value=DateDif(Format,MyDateDeb.value,MyDateFin.value);"
AfficherCommande = AfficherCommande & vbCrLf & "}"
AfficherCommande = AfficherCommande & vbCrLf & "</script>"




'AfficherCommande = AfficherCommande & vbCrLf & "<Form name=""zoneimpression"">"
AfficherCommande = AfficherCommande & vbCrLf & "<script language='javascript'>"
AfficherCommande = AfficherCommande & vbCrLf & "function Imprimer(){"
AfficherCommande = AfficherCommande & vbCrLf & "document.getElementById(""PRINT"").style.display = 'none';"
AfficherCommande = AfficherCommande & vbCrLf & "document.getElementById(""Mail"").style.display = 'none';"
AfficherCommande = AfficherCommande & vbCrLf & "window.print();"
 AfficherCommande = AfficherCommande & vbCrLf & "   document.getElementById(""PRINT"").style.display ='block';"
 AfficherCommande = AfficherCommande & vbCrLf & "   document.getElementById(""Mail"").style.display ='block';"
 AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFour.action='contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&ValideBr=OK&NumerBr=" & Request("NumerBr") & "'"
 
 AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFour.submit();"
AfficherCommande = AfficherCommande & vbCrLf & ""
AfficherCommande = AfficherCommande & vbCrLf & "}"

'contactSansMenu.asp?mode=AfficherCommande&ID=" & numDevis & "

AfficherCommande = AfficherCommande & vbCrLf & "function ConfirmeCommade() {"

AfficherCommande = AfficherCommande & vbCrLf & "    if (confirm(""" & GetMessage("AfficheCm", "Votre commande ne pourra plus être affichée en mode édition.\nVoulez vous continuer.", DsnTableMenu(Session("candidat_ADOContact"))) & """)) {"
AfficherCommande = AfficherCommande & vbCrLf & "        this.document.FrmFour.ACT.value='ConfirmeComande';"
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFour.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "function ConfirmeBr() {"
AfficherCommande = AfficherCommande & vbCrLf & "    if (confirm(""" & GetMessage("AfficheBr", "Votre Bordereau de réception ne pourra plus être affichée en mode édition.\nVoulez vous continuer.", DsnTableMenu(Session("candidat_ADOContact"))) & """)) {"
AfficherCommande = AfficherCommande & vbCrLf & "        this.document.FrmFour.ACT.value='ConfirmeBr';"
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFour.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "}"
'
AfficherCommande = AfficherCommande & vbCrLf & "function ValiderBr() {"

AfficherCommande = AfficherCommande & vbCrLf & "    if (confirm(""" & GetMessage("AfficheBr", "Votre Bordereau de réception ne pourra plus être affichée en mode édition.\nVoulez vous continuer.", DsnTableMenu(Session("candidat_ADOContact"))) & """)) {"
AfficherCommande = AfficherCommande & vbCrLf & "        var trouve=false;"
AfficherCommande = AfficherCommande & vbCrLf & "        var ErrDateAtent='';"
AfficherCommande = AfficherCommande & vbCrLf & "        var ErrRec='';"
AfficherCommande = AfficherCommande & vbCrLf & "        var msgErr='';"
AfficherCommande = AfficherCommande & vbCrLf & "        var i = 0;"
AfficherCommande = AfficherCommande & vbCrLf & "        while (i !== parseInt(document.forms['frmBr'].elements['L'].value)) {"
AfficherCommande = AfficherCommande & vbCrLf & "            i++"
'AfficherCommande = AfficherCommande & vbCrLf & "            alert(document.forms['frmBr'].elements['L_'+i+'_Qte_Rec'].value);"
AfficherCommande = AfficherCommande & vbCrLf & "            if (document.forms['frmBr'].elements['L_'+i+'_Qte_Rec'].value!=='') {"
AfficherCommande = AfficherCommande & vbCrLf & "                if (parseInt(document.forms['frmBr'].elements['L_'+i+'_Qte_Rec'].value)!==0) {"
AfficherCommande = AfficherCommande & vbCrLf & "                    if (document.forms['frmBr'].elements['L_'+i+'_Retour_Four'].value!==document.forms['frmBr'].elements['L_'+i+'_Qte_Rec'].value) {"

AfficherCommande = AfficherCommande & vbCrLf & "                        if (document.forms['frmBr'].elements['L_'+i+'_Stock_Encelade'].value=='') {"
'AfficherCommande = AfficherCommande & vbCrLf & "                                alert('True');"
'AfficherCommande = AfficherCommande & vbCrLf & "                        } else {"
'AfficherCommande = AfficherCommande & vbCrLf & "                                alert('False');"
AfficherCommande = AfficherCommande & vbCrLf & "                            if (document.forms['frmBr'].elements['L_'+i+'_Stock_Eboutique'].value=='') {"

'AfficherCommande = AfficherCommande & vbCrLf & "                            } else {"

AfficherCommande = AfficherCommande & vbCrLf & "                                alert('" & GetMessage("SaisirValeurStockEnceladeE_Boutique", "Vous devez saisir la valeur du stock (Encelade ou E Boutique).", DsnTableMenu(Session("candidat_ADOContact"))) & "');"
AfficherCommande = AfficherCommande & vbCrLf & "                                return;"
AfficherCommande = AfficherCommande & vbCrLf & "                            }"
AfficherCommande = AfficherCommande & vbCrLf & "                        }"
AfficherCommande = AfficherCommande & vbCrLf & "                    }"
AfficherCommande = AfficherCommande & vbCrLf & "                }"

msgErr = GetMessage("ErrDateAtent", "Voues n´avez pas saisie de valeur dans le champs [Attendue le].", DsnTableMenu(Session("candidat_ADOContact")))
AfficherCommande = AfficherCommande & vbCrLf & "                    trouve=true;"
AfficherCommande = AfficherCommande & vbCrLf & "                    if (document.forms['frmBr'].elements['L_'+i+'_Attendue_le'].value=='') ErrDateAtent='" & GetMessage("ErrDateAtent", "Voues n´avez pas saisie de valeur dans le champs [Attendue le].", DsnTableMenu(Session("candidat_ADOContact"))) & "';"
AfficherCommande = AfficherCommande & vbCrLf & "                    if (document.forms['frmBr'].elements['L_'+i+'_Rec_le'].value=='') ErrRec='" & GetMessage("ErrRec", "Voues n´avez pas saisie de valeur dans le champs [Rec. le].", DsnTableMenu(Session("candidat_ADOContact"))) & "';"
AfficherCommande = AfficherCommande & vbCrLf & "                }"

AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "        if (trouve==false) {"

AfficherCommande = AfficherCommande & vbCrLf & "            msgErr='" & GetMessage("ReceptionnerReference", "Vous devez réceptionner au moins une Référence.", DsnTableMenu(Session("candidat_ADOContact"))) & "';"
AfficherCommande = AfficherCommande & vbCrLf & "        } else {"
AfficherCommande = AfficherCommande & vbCrLf & "            msgErr=ErrDateAtent +'\n'+ErrRec;"
AfficherCommande = AfficherCommande & vbCrLf & "       }"
AfficherCommande = AfficherCommande & vbCrLf & "        if (msgErr!=='\n'){"
AfficherCommande = AfficherCommande & vbCrLf & "            alert(msgErr);"
AfficherCommande = AfficherCommande & vbCrLf & "            return;"
AfficherCommande = AfficherCommande & vbCrLf & "        }"
AfficherCommande = AfficherCommande & vbCrLf & "        this.document.frmBr.ACT.value='ValiderBr';"
AfficherCommande = AfficherCommande & vbCrLf & "        this.document.frmBr.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "}"



AfficherCommande = AfficherCommande & vbCrLf & "function ApercuCommade() {"

AfficherCommande = AfficherCommande & vbCrLf & "window.open('contactSansMenu.asp?mode=AfficherCommande&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "');"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "function MailCommade() {"
AfficherCommande = AfficherCommande & vbCrLf & "window.open('contactSansMenu.asp?mode=AfficherCommande&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "');"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "</script>"
'informatique1_20_9.gif
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "<div align=""right"">"
            AfficherCommande = AfficherCommande & vbCrLf & "<table width=""15%""><tr>"
     If Request("BR") <> "" Then
      
'              AfficherCommande = AfficherCommande & vbCrLf & "<img align=""right"" src=""" & Session("contact_devis")
'              AfficherCommande = AfficherCommande & vbCrLf & "Save.gif"" width=""27"" height=""30"" /  OnClick=""ValiderBr();"" id=""PRINT"">"
              AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"">" & AfficheBounton("Enregistrer", "PRINT", "'javascript:ValiderBr();'") & "</td>" ', <img align=""right"" src=""" & Session("contact_devis")

       
     Else
     
         AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"">" & AfficheBounton("Enregistrer", "", "'javascript:ConfirmeCommade();'") & "</td>" ', <img align=""right"" src=""" & Session("contact_devis")
'         AfficherCommande = AfficherCommande & vbCrLf & "Save.gif"" width=""27"" height=""30"" /  OnClick=""ConfirmeCommade();"" id=""PRINT""></td>"
    End If

Else
    If Request("Print") <> "" And Session("MSGCommande") <> "PaAffiche" Then
        AfficherCommande = AfficherCommande & vbCrLf & "<div align=""right""><br>"
        AfficherCommande = AfficherCommande & vbCrLf & "<table width=""15%""><tr>"
'        If Trim("" & Request("NumerBr")) = "" Then
'            AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"" ><a href='contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&ValideBr=OK&NumerBr=" & Request("NumerBr") & "'><img  border=""0"" src=""" & Session("contact_devis")
'            AfficherCommande = AfficherCommande & vbCrLf & "cd2.gif"" width=""67"" height=""50"" /   id=""Mail"">&nbsp;&nbsp;</a></TD>"
'        End If
'        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%""><img  src=""" & Session("contact_devis")
'        AfficherCommande = AfficherCommande & vbCrLf & "PRINT.gif"" width=""67"" height=""70"" /  OnClick=""Imprimer();"" id=""PRINT""></td>"

        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"">" & AfficheBounton("Email", "Mail", "'contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "'") & "</rd>" '<a href='contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "'><img  border=""0"" src=""" & Session("contact_devis")
'        AfficherCommande = AfficherCommande & vbCrLf & "Mail.gif"" width=""67"" height=""50"" /   id=""Mail"">&nbsp;&nbsp;</a></TD>"
        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"">" & AfficheBounton("Imprimer", "PRINT", "'javascript:Imprimer();'") & "</td>" '<img  src=""" & Session("contact_devis")
'        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""> " & AfficheBounton("toto") & "</td>"
'        AfficherCommande = AfficherCommande & vbCrLf & "PRINT.gif"" width=""67"" height=""70"" /  OnClick=""Imprimer();"" id=""PRINTaa""></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""100%"">&nbsp;&nbsp;</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "</tr>" '<tr>"
         If Trim("" & Request("NumerBr")) = "" Then
'            AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"" align=""center""><a href='contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&ValideBr=OK&NumerBr=" & Request("NumerBr") & "'>Enregistrer</a></TD>"
        End If
'        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"" align=""center""><a href='contactSansMenu.asp?mode=MailCommande&ID=" & numDevis & "&Print=OK&NumerBr=" & Request("NumerBr") & "'>Email</a></TD>"
'        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"" align=""center""><a href='javascript:Imprimer();' >Imprimer </a></td>"
'        AfficherCommande = AfficherCommande & vbCrLf & "<td width=""100%"" align=""center"">&nbsp;&nbsp;</td>"
         AfficherCommande = AfficherCommande & vbCrLf & "</table></div>"
    Else
        If Session("MSGCommande") <> "PaAffiche" Then
           AfficherCommande = AfficherCommande & vbCrLf & "<div align=""right"">"
           AfficherCommande = AfficherCommande & vbCrLf & "<table width=""15%""><tr>"
'            AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""> " & AfficheBounton("toto") & "</td>"
             If Request("BR") <> "" Then
'                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "  '><img  src=""" & Session("contact_devis")
                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""> " & AfficheBounton("Retour", "", "'Contact.asp?mode=AfficherCommande&ID=" & numDevis & "'") & "</td>" '& "<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img  src=""" & Session("contact_devis")
            Else
            
                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""> " & AfficheBounton("Retour", "", "'Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'") & "</td>" '& "<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img  src=""" & Session("contact_devis")
            End If
'            AfficherCommande = AfficherCommande & vbCrLf & "boulerose.gif"" width=""30"" height=""33"" border=""0"" id=""PRINTaa""></a></td>"
            
            If EnvoyeMail <> "00:00:00" Then
                If Request("BR") <> "" Then
                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%"">" & AfficheBounton("Enregistrer", "PRINT", "'javascript:ValiderBr();'") & "</td>"
'                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50%""><img  src=""" & Session("contact_devis")
'                    AfficherCommande = AfficherCommande & vbCrLf & "Save.gif"" width=""27"" height=""30"" /  OnClick=""ValiderBr();"" id=""PRINT""></td>"
'                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""100%"">&nbsp;&nbsp;</td>"
                Else
                    If Request("NumerBr") = "" Then
                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""> " & AfficheBounton("BR", "'Doc'", "'Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&BR=Yes'") & "</td>"
'                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&BR=Yes'><img  src=""" & Session("contact_devis")
'                    AfficherCommande = AfficherCommande & vbCrLf & "doc.gif"" width=""30"" height=""33"" border=""0"" id=""Doc""></a></td>"
                  End If
                End If
            End If
            If Request("BR") = "" Then
                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50"">" & AfficheBounton("Aperçu", "", "'javascript:ApercuCommade();'") & "</td"
'                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><img  src=""" & Session("contact_devis")
'                    AfficherCommande = AfficherCommande & vbCrLf & "louperd.gif"" width=""47"" height=""50"" /  OnClick=""ApercuCommade();"" id=""PRINT""></td>"
               
            End If
            AfficherCommande = AfficherCommande & vbCrLf & "</tr><tr>"
'
'            If Request("BR") <> "" Then
'                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "'>"
'            Else
'
'                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'>"
'            End If
'            AfficherCommande = AfficherCommande & vbCrLf & "Retour</a></td>"
            
'            AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='javascript:AppercuNumBr();'>Aperçu</a></td>"
'            AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50"">&nbsp;</td>"
'            If EnvoyeMail <> "00:00:00" And Request("BR") = "" Then
'                If Request("NumerBr") = "" Then
'                    AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='Contact.asp?mode=AfficherCommande&ID=" & numDevis & "&BR=Yes'>BR</a></td>"
'                End If
'            End If
'
'            If Request("BR") = "" Then
'            If Request("NumerBr") <> "" Then
'                 AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='javascript:ApercuCommade();'>Aperçu</a></td>"
'            Else
'                AfficherCommande = AfficherCommande & vbCrLf & "<td width=""50""><a href='javascript:ApercuCommade();'>Valider<br>Envoyer<br>Imprimer</a></td>"
'            End If
'
'            End If
             AfficherCommande = AfficherCommande & vbCrLf & "</tr></table></div>"
        End If
    End If
End If

If Request("Print") <> "" Then
    AfficherCommande = AfficherCommande & vbCrLf & "<center><img src=""" & Session("contact_devis")
    AfficherCommande = AfficherCommande & vbCrLf & "logo.gif"" border=""0"" ></center><br>"
Else
    AfficherCommande = AfficherCommande & vbCrLf & HISTORIQUE_BR("" & numDevis, Conn)
End If
If Session("MSGCommande") <> "" And Session("MSGCommande") <> "PaAffiche" Then
    AfficherCommande = AfficherCommande & vbCrLf & "<br>"
    AfficherCommande = AfficherCommande & vbCrLf & "<CENTER><FONT COLOR=""RED""><B>" & Session("MSGCommande") & "</B></FONT></CENTER>"
    AfficherCommande = AfficherCommande & vbCrLf & "<br>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "<table width=""95%"" border=""0"" cellpadding=""0"" cellspacing=""0"" align=""center""> <tr>"
AfficherCommande = AfficherCommande & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "hg.gif"" width=""17"" height=""22""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "<td background=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgh.gif""><table width=""100%"" border=""0"" cellpadding=""0"" cellspacing=""0"">"
AfficherCommande = AfficherCommande & vbCrLf & "<tr><td background=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgh2.gif"">"
If Request("NumerBr") <> "" Then
    AfficherCommande = AfficherCommande & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">Bordereau de r&eacute;ception N° : " & Request("NumerBr") & "</font></b></font>"
Else
    AfficherCommande = AfficherCommande & vbCrLf & "<font face=""Arial, Helvetica, sans-serif"" size=""1""><b><font size=""2"" color=""#868AB4"">COMMANDE DE FOURNITURES OU DE MATERIEL</font></b></font>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> <td><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgh3.gif"" width=""16"" height=""22""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr></table></td><td width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "hd.gif"" width=""18"" height=""22""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr><tr>"

AfficherCommande = AfficherCommande & vbCrLf & "<td background=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgg.gif"" width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgg.gif"" width=""17"" height=""8""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "<td bgcolor=""#EBE3D7"">"


'AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
'AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Information  Fournisseur</td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Information  Fournisseur")


Sql = "SELECT T_Devis_Four_Raison_Social.* "
Sql = Sql & "From T_Devis_Four_Raison_Social "
Sql = Sql & "WHERE T_Devis_Four_Raison_Social.Id_Com_Four=" & numDevis & ";"
Set Rscom = Conn.Execute(Sql)

AfficherCommande = AfficherCommande & vbCrLf & "<script language='javascript'>"

AfficherCommande = AfficherCommande & vbCrLf & "function ValideFournisseur() {"

AfficherCommande = AfficherCommande & vbCrLf & "    if (confirm(""" & GetMessage("MdificationsFournisseurs", "Voulez vous apporter les modifications dans la table Fournisseurs ?", DsnTableMenu(Session("candidat_ADOContact"))) & """)) {"
AfficherCommande = AfficherCommande & vbCrLf & "        this.document.FrmFour.ID_Four.value='" & Rscom!CatId & "';"
AfficherCommande = AfficherCommande & vbCrLf & "    }"
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFour.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "}"


AfficherCommande = AfficherCommande & vbCrLf & "function ValideCondition() {"
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmCondi.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "</script>"
If Request("br") = "" Then
AfficherCommande = AfficherCommande & vbCrLf & "<form name=""FrmFour"" method=""post"" action=""Contact.asp"" >"
End If
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID_Four"" value="""">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value='" & numDevis & "'>"

AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateFournisseur"">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"


AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Soci&eacute;t&eacute;</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""SocieteFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & vbCrLf & Rscom!catname
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Service</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""ServiceFour"" size=""100"" value='"
End If

AfficherCommande = AfficherCommande & vbCrLf & Rscom!Service
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Adresse</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""AdresseFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & Replace("" & Rscom!Adresse, vbCrLf, " ")
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Pays</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""PaysFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & vbCrLf & Rscom!Pays
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Contact</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""ContactFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & Rscom!Contact
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>T&eacute;l&eacute;phone</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""TelephoneFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & vbCrLf & Rscom!Telephone
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>FAX</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""FaxFour"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & Rscom!fax
If Afficher = False Then
    AfficherCommande = AfficherCommande & vbCrLf & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"


AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Mail</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""MailFour"" size=""100"" value='" & Rscom!Mail & "'>"
Else
    AfficherCommande = AfficherCommande & vbCrLf & "<A href='mailto:" & Rscom!Mail & "'>" & Rscom!Mail & "</A>"
End If

AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"


AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Vos R&eacute;f&eacute;rences</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""VosRefFour"" size=""100"" value='"
End If

AfficherCommande = AfficherCommande & Rscom!VosReff
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
AfficherCommande = AfficherCommande & vbCrLf & "</table>"

If Afficher = False Then
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideFournisseur();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
AfficherCommande = AfficherCommande & vbCrLf & "&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>"

AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
If Request("br") = "" Then
    AfficherCommande = AfficherCommande & vbCrLf & "</form>"
End If
'AfficherCommande = AfficherCommande & vbCrLf & "<br>" AfficheComGroupFour Request("CommandeFournisseurGroupe")
End If
AfficherCommande = AfficherCommande & vbCrLf & "<br>"
If Request("br") = "" Then
AfficherCommande = AfficherCommande & vbCrLf & "<form name=""FrmCondi"" method=""post"" action=""Contact.asp"" >"
End If
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID_Four"" value="""">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value='" & numDevis & "'>"

AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateCondition"">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
'AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
'AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Information sur la Commande</td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Information sur la Commande")

AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Commande N°</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & commande
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"


AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Date de la Commande</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & DateCommande
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & "<br>"

Sql = "SELECT T_Devis_Four_Societe.* "
Sql = Sql & "From T_Devis_Four_Societe "
Sql = Sql & "WHERE T_Devis_Four_Societe.Id_Com_Four=" & numDevis & ";"
Set RsContactEncelade = Conn.Execute(Sql)

AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Contact pour la Soci&eacute;t&eacute; " & RsContactEncelade!RaisonSocialFac & "</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
AfficherCommande = AfficherCommande & vbCrLf & "</table>"

AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Responsable</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!Nom & " " & RsContactEncelade!pNom
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>D&eacute;partement / Service</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!Service
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>T&eacute;l&eacute;phone</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!TelFac
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Fax</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!FaxFac
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Mail</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & "<A href='mailto:" & GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))) & "'>" & GetDefault("email", "luis.carreira@encelade.fr", DsnTableMenu(Session("candidat_ADOContact"))) & "</A>"
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"


AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & "<br>"
'
'AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
'AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Adresse de Facturation</td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Adresse de Facturation")
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Soci&eacute;t&eacute;</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!RaisonSocialFac
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Adresse</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!AddFac1 & "<br>" & RsContactEncelade!AddFac2 & "<br>" & RsContactEncelade!AddFac3
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Code Postal</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!CpLiFac
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Ville</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!VilleFac
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Condition de paiement</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""ConditionPaiement"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!ConditionPaiement
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Date de livraison</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""DateLivraison"" size=""8"" value='"
End If
AfficherCommande = AfficherCommande & DateCommande
If Afficher = False Then
    AfficherCommande = AfficherCommande & "' onchange=""SaisieDate('FrmCondi','DateLivraison');""> <a href=""javascript:AfficherCalendar('FrmCondi','DateLivraison');""><img src=""c_btn.bmp"" border=""0""></a>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"


AfficherCommande = AfficherCommande & vbCrLf & "</table>"

If Afficher = False Then
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideCondition();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
AfficherCommande = AfficherCommande & vbCrLf & "&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
If Request("br") = "" Then
AfficherCommande = AfficherCommande & vbCrLf & "</form>" '<br>" AfficheComGroupFour Request("CommandeFournisseurGroupe")
End If
End If


AfficherCommande = AfficherCommande & vbCrLf & "<br>"

AfficherCommande = AfficherCommande & vbCrLf & "<script language='javascript'>"
AfficherCommande = AfficherCommande & vbCrLf & "function AfficherCalendar(test,txt) {"
''FrmCondi','DateLivraison'
AfficherCommande = AfficherCommande & vbCrLf & " window.open('calendar.asp?jour='+ this.document.forms[test].elements[txt].value+'&test='+test+'&txt='+txt+'','dlgcat','resizable=yes,status=no,top=200,left=600,width=200,height=400')"

'AfficherCommande = AfficherCommande & vbCrLf & "window.open('testCalandar.htm?test=tes&txt=txt','resizable=yes,status=no,top=200,left=200,width=300,height=400');"
AfficherCommande = AfficherCommande & vbCrLf & "}"
AfficherCommande = AfficherCommande & vbCrLf & "function ValideAdresseLiv() {"
AfficherCommande = AfficherCommande & vbCrLf & "   "
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmLiv.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "function ValideFrmFrais() {"
AfficherCommande = AfficherCommande & vbCrLf & "   "
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmFrais.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "function ValideFrmFraisDivers() {"
'AfficherCommande = AfficherCommande & vbCrLf & "  this.document.FrmFrais.ACT='UpdateFraisDivers"" "
AfficherCommande = AfficherCommande & vbCrLf & "this.document.FrmDouane.submit();"
AfficherCommande = AfficherCommande & vbCrLf & "}"

AfficherCommande = AfficherCommande & vbCrLf & "</script>"
If Request("br") = "" Then
AfficherCommande = AfficherCommande & vbCrLf & "<form name=""FrmLiv"" method=""post"" action=""Contact.asp"" >"
End If
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID_Four"" value="""">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value='" & numDevis & "'>"

AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateAdresseLiv"">"
AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
'AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
'AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Adresse de Livraison</td>"
'AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
'AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
'AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Adresse de Livraison")
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Soci&eacute;t&eacute;</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""SocieteLiv"" size=""100"" value='"
End If

AfficherCommande = AfficherCommande & vbCrLf & RsContactEncelade!RaisonSocialLiv
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If

AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Adresse</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "

If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""AddLiv1"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!AddLiv1
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & "<br>"


If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""AddLiv2"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!AddLiv2
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & "<br>"

If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""AddLiv3"" size=""100"" value='"
End If
  AfficherCommande = AfficherCommande & RsContactEncelade!AddLiv3
  If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If


AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Code Postal</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""CpLiv"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!CpLiv
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Ville</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""VilleLiv"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!VilleLiv
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Contact</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""beneficiaire"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!beneficiaire
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>T&eacute;l&eacutephone</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""TelLiv"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!TelLiv
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
AfficherCommande = AfficherCommande & vbCrLf & "        <td width=20%>Fax</td>"
AfficherCommande = AfficherCommande & vbCrLf & "        <td> "
If Afficher = False Then
    AfficherCommande = AfficherCommande & "<input type=""text"" name=""FaxLiv"" size=""100"" value='"
End If
AfficherCommande = AfficherCommande & RsContactEncelade!FaxLiv
If Afficher = False Then
    AfficherCommande = AfficherCommande & "'>"
End If
AfficherCommande = AfficherCommande & vbCrLf & "</td> "
AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"

AfficherCommande = AfficherCommande & vbCrLf & "</table>"

If Afficher = False Then

'AfficherCommande = AfficherCommande & vbCrLf & "</td> "
'AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>"
AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideAdresseLiv();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
AfficherCommande = AfficherCommande & vbCrLf & "&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
If Request("br") = "" Then
AfficherCommande = AfficherCommande & vbCrLf & "</form>"
End If

End If

AfficherCommande = AfficherCommande & vbCrLf & "<br>"
If Request("NumerBr") <> "" Then
'    AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
'    AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
'    AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
'    AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
'    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail du bordereau de r&eacute;ception</td>"
'    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
'    AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
'    AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
'    AfficherCommande = AfficherCommande & vbCrLf & "</table>"
AfficherCommande = AfficherCommande & vbCrLf & SousRubique("D&eacute;tail du bordereau de r&eacute;ception")

Else
    AfficherCommande = AfficherCommande & vbCrLf & "<form name=""FrmFrais"" method=""post"" action=""Contact.asp"" >"
'    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID_Four"" value="""">"
'    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value='" & numDevis & "'>"
'
'    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateFraisLiv"">"
'    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
'    AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Frais de transport.")
'
'
'
'
'    AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
'    AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
'      ReDim Entete_Champs(3)
'    Entete_Champs(0) = "Transporteur"
'    Entete_Champs(1) = "R&eacute;f&eacute;rence du Colis"
'    Entete_Champs(2) = "T&eacute;l&eacute;phone"
'    Entete_Champs(3) = "P.H.T. "
'    AfficherCommande = AfficherCommande & vbCrLf & EnteteChamps(Entete_Champs)
'
'
'
'
'AfficherCommande = AfficherCommande & vbCrLf & "    </td></tr>"
'Sql = "SELECT T_Frais_de_transport_Four.* From T_Frais_de_transport_Four "
'    Sql = Sql & "WHERE T_Frais_de_transport_Four.Id_Com_Four=" & numDevis & ";"
'     Set rsFrais = Conn.Execute(Sql)
'     If rsFrais.EOF = False Then
'        NamTansport = "" & rsFrais!Transporteur
'        RefTansport = "" & rsFrais!ReffColis
'        TelTansport = "" & rsFrais!Telephone
'        ValTansport = "" & rsFrais!PHT
'     End If
'rsFrais.Close
'Set rsFrais = Nothing
'If Afficher = False Then
'End If
'AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
'        AfficherCommande = AfficherCommande & vbCrLf & "                    "
'        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""NamTansport"" size=""100%"" Value="""
'        End If
'            AfficherCommande = AfficherCommande & vbCrLf & NamTansport
'        If Afficher = False Then
'        AfficherCommande = AfficherCommande & vbCrLf & """> "
'        End If
'        AfficherCommande = AfficherCommande & vbCrLf & "     </td>"
'        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"">"
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""RefTansport"" size=""15%"" Value="""
'        End If
'            AfficherCommande = AfficherCommande & vbCrLf & RefTansport
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & """ ></td>"
'         End If
'        AfficherCommande = AfficherCommande & vbCrLf & "                    "
'        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""TelTansport"" size=""15%"" Value="""
'        End If
'            AfficherCommande = AfficherCommande & vbCrLf & TelTansport
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & """></td>"
'        End If
'    '    AfficherCommande = AfficherCommande & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
'        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""ValTansport"" size=""15%"" Value='"
'        End If
'            AfficherCommande = AfficherCommande & vbCrLf & ValTansport
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & "' onchange=""Isdouble('FrmFrais','ValTansport');""></td>"
'         End If
'        AfficherCommande = AfficherCommande & vbCrLf & "                  </tr>"
'
'        If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'><tr>"
'            AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideFrmFrais();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
'            AfficherCommande = AfficherCommande & vbCrLf & "&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>"
'            AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
'        Else
'             AfficherCommande = AfficherCommande & vbCrLf & "<tr>"
''            AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideFrmFrais();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
'            AfficherCommande = AfficherCommande & vbCrLf & "<td align=""right"">&nbsp;</td>"
'            AfficherCommande = AfficherCommande & vbCrLf & "</tr>"
'        End If
AfficherCommande = AfficherCommande & vbCrLf & "</form>"

AfficherCommande = AfficherCommande & vbCrLf & "<form name=""FrmDouane"" method=""post"" action=""Contact.asp"" >"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID_Four"" value="""">"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value='" & numDevis & "'>"
    If Br = True Then
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""BR"" value='Yes'>"
End If
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateFraisDivers"">"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
    AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Frais de divers.")
    AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
    AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
    
      If Br = True Or Afficher = False Then
        ReDim Entete_Champs(5)
     Else
        ReDim Entete_Champs(4)
     End If
    Entete_Champs(0) = "Type"
    Entete_Champs(1) = "R&eacute;f&eacute;rence"
    Entete_Champs(2) = "Qts"
    Entete_Champs(3) = "P.H.T. "
    Entete_Champs(4) = "P.T.H.T."
      If Br = True Or Afficher = False Then
      Entete_Champs(5) = "<img src=""" & Session("contact_devis") & "icon_delete_reply.gif"" border=""0"">"
     End If
    
    AfficherCommande = AfficherCommande & vbCrLf & EnteteChamps(Entete_Champs)
    
    

    AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
Sql = "SELECT T_Frais_de_transport_Four.* From T_Frais_de_transport_Four "
    Sql = Sql & "WHERE T_Frais_de_transport_Four.Id_Com_Four=" & numDevis & ";"
    
    Sql = "SELECT T_Frais_Divers_Four.* From T_Frais_Divers_Four "
    Sql = Sql & "Where T_Frais_Divers_Four.Id_Com_Four = " & numDevis & " "
    Sql = Sql & "ORDER BY T_Frais_Divers_Four.Id;"

     Set rsFrais = Conn.Execute(Sql)

If Afficher = False Then
End If


I = 0
While rsFrais.EOF = False
'
'        NamTansport = "" & rsFrais!Transporteur
'        RefTansport = "" & rsFrais!ReffColis
'        TelTansport = "" & rsFrais!Telephone
'        ValTansport = "" & rsFrais!PHT
      
     
I = I + 1
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
        AfficherCommande = AfficherCommande & vbCrLf & "                    "
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
          If Br = True Or Afficher = False Then
              AfficherCommande = AfficherCommande & vbCrLf & ListeType("" & rsFrais!Type_Frais, "Douane_Type_" & I, Conn)
         Else
            AfficherCommande = AfficherCommande & vbCrLf & ListeType("" & rsFrais!Type_Frais, "Douane_Type_" & I, Conn, True)
        End If
            
        AfficherCommande = AfficherCommande & vbCrLf & "     </td>"
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"">"
        If Br = True Or Afficher = False Then
         AfficherCommande = AfficherCommande & vbCrLf & " <input type=""hidden"" name=""Douane_Desing_Id" & I & """ value='" & rsFrais!Id & "'>"
         
            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""Douane_Desing_" & I & """ size=""15%"" Value="""
        End If
            AfficherCommande = AfficherCommande & vbCrLf & rsFrais!RefTypeFrais
         If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & """ ></td>"
         End If
        AfficherCommande = AfficherCommande & vbCrLf & "                    "
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
         If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""Douane_Qts_" & I & """ size=""15%"" Value="""
        End If
            AfficherCommande = AfficherCommande & vbCrLf & rsFrais!Qts
       If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & """ onchange=""MultipliValeur('FrmDouane','Douane_Qts_" & I & "','Douane_PrixHt_" & I & "','Douane_Qts_X_PHT_" & I & "');""></td>"
        End If
    '    AfficherCommande = AfficherCommande & vbCrLf & "         <td align=""center"" ><input type=""text"" name=""ValTansport"" size=""10%"" disabled></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
        If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""Douane_PrixHt_" & I & """ size=""15%"" Value='"
        End If
            AfficherCommande = AfficherCommande & vbCrLf & rsFrais!PHT
         If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & "' onchange=""MultipliValeur('FrmDouane','Douane_Qts_" & I & "','Douane_PrixHt_" & I & "','Douane_Qts_X_PHT_" & I & "');"">"
         End If
        AfficherCommande = AfficherCommande & vbCrLf & " </td>"
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
         If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""Douane_Qts_X_PHT_" & I & """ size=""15%"" Value='"
        End If
            AfficherCommande = AfficherCommande & vbCrLf & rsFrais!PTHT
            PTHT = PTHT + val(Replace(Trim("" & rsFrais!PTHT), ",", "."))
         If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & "' onchange=""MultipliValeur('FrmDouane','Douane_Qts_" & I & "','Douane_PrixHt_" & I & "','Douane_Qts_X_PHT_" & I & "');"">"
         End If
        AfficherCommande = AfficherCommande & vbCrLf & " </td>"
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
        'If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " Nouveau"
         'End If
         
         
          If Br = True Or Afficher = False Then
            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""Checkbox"" name=""Douane_Delete_" & I & """ size=""15%"" Value='TRUE' >"
        End If
'            AfficherCommande = AfficherCommande & vbCrLf & ValTansport
        'If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & ">"
         'End If
         
         
         
         
        AfficherCommande = AfficherCommande & vbCrLf & " </td>"
        AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
        rsFrais.MoveNext
        
Wend
    
rsFrais.Close
Set rsFrais = Nothing
   AfficherCommande = AfficherCommande & vbCrLf & " <input type=""hidden"" name=""Douane_Desing_Nb_Ligne"" value='" & I & "'>"
    
       
         'End If
         
'
'         'If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & " <input type=""Checkbox"" name=""New"" size=""15%"" Value='TRUE' "
'        'End If
''            AfficherCommande = AfficherCommande & vbCrLf & ValTansport
'        'If Afficher = False Then
'            AfficherCommande = AfficherCommande & vbCrLf & ">"
         'End If
         
         
         
         
        AfficherCommande = AfficherCommande & vbCrLf & " </td>"
        AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
           If Br = True Or Afficher = False Then

          
                AfficherCommande = AfficherCommande & vbCrLf & SousRubique("Ajouter Frais de divers.")
                AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
                AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
                AfficherCommande = AfficherCommande & vbCrLf & "    "
                ReDim Entete_Champs(5)
                Entete_Champs(0) = "Type"
                Entete_Champs(1) = "Nouvelle Rubrique"
                Entete_Champs(2) = "R&eacute;f&eacute;rence"
                Entete_Champs(3) = "Qts"
                Entete_Champs(4) = "P.H.T. "
                Entete_Champs(5) = "P.T.H.T."
                
                AfficherCommande = AfficherCommande & vbCrLf & EnteteChamps(Entete_Champs)

                AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
                AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"">"
                AfficherCommande = AfficherCommande & vbCrLf & "                    "
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
                AfficherCommande = AfficherCommande & vbCrLf & ListeType("", "New_Douane_Type", Conn)
            
                AfficherCommande = AfficherCommande & vbCrLf & "     </td>"
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
                AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""New_Lib"" size=""15%""  >"
         
                AfficherCommande = AfficherCommande & vbCrLf & " </td>"
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"">"
                AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""New_Douane_Desing"" size=""15%"" Value="""
                AfficherCommande = AfficherCommande & vbCrLf & """ ></td>"
                AfficherCommande = AfficherCommande & vbCrLf & "                    "
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
                AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""New_Douane_Qts"" size=""15%"" Value="""
            
                AfficherCommande = AfficherCommande & vbCrLf & """ onchange=""MultipliValeur('FrmDouane','New_Douane_Qts','New_Douane_PrixHt','New_Douane_Qts_X_PHT');""></td>"
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
                AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""New_Douane_PrixHt"" size=""15%"" Value='"
                AfficherCommande = AfficherCommande & vbCrLf & "' onchange=""MultipliValeur('FrmDouane','New_Douane_Qts','New_Douane_PrixHt','New_Douane_Qts_X_PHT');"">"
                AfficherCommande = AfficherCommande & vbCrLf & " </td>"
                AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
                AfficherCommande = AfficherCommande & vbCrLf & " <input type=""text"" name=""New_Douane_Qts_X_PHT"" size=""15%"" Value='"
                AfficherCommande = AfficherCommande & vbCrLf & "' onchange=""MultipliValeur('FrmDouane','New_Douane_Qts','New_Douane_PrixHt','New_Douane_Qts_X_PHT');"">"
                AfficherCommande = AfficherCommande & vbCrLf & " </td>"
        
                AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
        
                AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'><tr>"
                AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideFrmFraisDivers();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
                AfficherCommande = AfficherCommande & vbCrLf & "&nbsp;&nbsp;&nbsp;<a href='Contact.asp?mode=AfficheComGroupFour&CommandeFournisseurGroupe=" & Session("CommandeFournisseurGroupe") & "'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Annuler.GIF"" border=""0""></a></td>"
                AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
            
        Else
        
              AfficherCommande = AfficherCommande & vbCrLf & "    <tr  height=""10"" ><td colspan=""6"">&nbsp;</td></tr>"
                
         
       End If
        'If Afficher = False Then
            
'        Else
'             AfficherCommande = AfficherCommande & vbCrLf & "<tr>"
''            AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:ValideFrmFrais();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
'            AfficherCommande = AfficherCommande & vbCrLf & "<td align=""right"">&nbsp;</td>"
'            AfficherCommande = AfficherCommande & vbCrLf & "</tr>"
'        End If
AfficherCommande = AfficherCommande & vbCrLf & "</form>"



    AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
    AfficherCommande = AfficherCommande & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
    AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
    AfficherCommande = AfficherCommande & vbCrLf & "bandeg.gif"" border=""0""></td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""ecomtitrecaddie2"" >D&eacute;tail de la commande</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
    AfficherCommande = AfficherCommande & vbCrLf & "banded.gif"" border=""0""></td>"
    AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "</table>"
End If
If Request("br") <> "" Or Request("NumerBr") <> "" Then
    AfficherCommande = AfficherCommande & vbCrLf & "<form name=""frmBr"" action=""Contact.asp"" method=""post"">"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ACT"" value=""UpdateBR"">"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""mode"" value=""AfficherCommande"">"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""ID"" value=""" & numDevis & """>"
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""BR"" value=""Yes"">"
    AfficherCommande = AfficherCommande & vbCrLf & "<table border=""0"" cellspacing=""3"" cellpadding=""0"" width=""100%"">"
    
    Sql = "SELECT T_Devis_Four.* From T_Devis_Four "
    Sql = Sql & "WHERE T_Devis_Four.Id_Com_Four=" & numDevis & ";"
    Set RsDetailCommandFour = Conn.Execute(Sql)
    PrixTotalTtc = 0
   Session("CmadFourLivrable") = ""
    While RsDetailCommandFour.EOF = False
    L = L + 1
    
    Sql = "SELECT Br_Fournisseurs.*, T_BR.BrValider, T_BR.BrMailDate FROM T_BR INNER JOIN Br_Fournisseurs ON T_BR.Id = Br_Fournisseurs.Id_Br "
    Sql = Sql & "WHERE T_BR.BrValider=False "
    Sql = Sql & "AND T_BR.Id_Com_Four=" & numDevis & " "
    Sql = Sql & "AND Br_Fournisseurs.id_produit=" & RsDetailCommandFour!id_produit & " "
    If Request("NumerBr") <> "" Then
        Sql = Sql & "And T_BR.NumBr='" & Request("NumerBr") & "';"
    Else
        Sql = Sql & "And DateEntreStock  Is Null;"
    End If
    Set RsBr = Conn.Execute(Sql)
    If RsBr.EOF = False Then
        Reste_Rec = "" & RsBr!Reste
        
   

        Qte_Rec = "" & RsBr!Qte_Rec
        Qt_non_Conf = "" & RsBr!Qt_non_Conf
        Qt_Deterior = "" & RsBr!Qt_Deterior
        Retour_Four = "" & RsBr!Retour_Four
        MType = "" & RsBr!Type
        Relancer_le = "" & RsBr!Relancer_le
        Attendue_le = "" & RsBr!Attendue_le
        Rec_le = "" & RsBr!Rec_le
        Ecart_Rec = "" & RsBr!Ecart_Rec
        Flag = "" & RsBr!Flag
        BrValider = "" & RsBr!BrValider
        BrMailDate = "" & RsBr!BrMailDate
        Relancer_le = "" & RsBr!Relancer_le
        Stock_Encelade = "" & RsBr!SokeEncelade
        Stock_Eboutique = "" & RsBr!SokEbotique
    Else
        Reste_Rec = ""
        Qte_Rec = ""
        Qt_non_Conf = ""
        Qt_Deterior = ""
        Retour_Four = ""
        MType = ""
        Relancer_le = ""
        Rec_le = ""
        Ecart_Rec = ""
        Flag = ""
        BrValider = ""
        BrMailDate = ""
        Relancer_le = ""
        Stock_Encelade = ""
        Stock_Eboutique = ""
    End If
    RsBr.Close
    Set RsBr = Nothing
    'Linge Titre 1
    AfficherCommande = AfficherCommande & vbCrLf & "    <tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("D&eacute;signation")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute;")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("P.U.H.T")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute; Rec.")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Reste à Rec.")) & "</td>"

    
    AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
    'Linge Data 1
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
       id_produit = RsDetailCommandFour!id_produit
       PrixU_produit = RsDetailCommandFour!PrixU_produit
       RefProduit = RsDetailCommandFour!RefProduit
       qte_produit = RsDetailCommandFour!qte_produit
        Reste = RsDetailCommandFour!Reste
  
        Reste = qte_produit + Reste
        If Session("CmadFourLivrableSave") = "" Then
         Session("CmadFourLivrable") = "Ok"
'         Else
'            Qte_Rec = 0
         End If
              AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" size=""10""   name='L_" & L & "_Feff_Sortie' value=""" & Reste & """ >"
       Designation = RsDetailCommandFour!Designation
       AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name='L_" & L & "_Id_Produit' value=""" & id_produit & """>"
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Designation & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><INPUT disabled TYPE=""TEXT"" size=""100"" name='L_" & L & "_Designation' value=""" & Designation & """></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & RefProduit & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><INPUT disabled  TYPE=""TEXT"" size=""10""  name='L_" & L & "_RefProduit' value=""" & RefProduit & """></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & qte_produit & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><INPUT disabled  TYPE=""TEXT"" size=""10""  name='L_" & L & "_qte_produit' value=""" & qte_produit & """></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & PrixU_produit & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><INPUT disabled  TYPE=""TEXT"" size=""10""  name='L_" & L & "_PrixU_produit'  value=""" & PrixU_produit & """></td>"
        End If
        
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          " & Qte_Rec & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <input type=""text"" size=""10""   name='L_" & L & "_Qte_Rec' value=""" & Qte_Rec & "" & """ onchange=""SousQts('frmBr','L_" & L & "_Feff_Sortie','L_" & L & "_Qte_Rec','L_" & L & "_Reste','L_" & L & "Rec_Reste','L_" & L & "_Feff_Sortie','-',true,2,true," & L & ");""></td>"
        End If
         AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >"
        If Request("NumerBr") = "" Then
                
            AfficherCommande = AfficherCommande & vbCrLf & "          <input  type=""hidden"" size=""10""  name='L_" & L & "Rec_Reste' value=""" & Reste & """>"
            AfficherCommande = AfficherCommande & vbCrLf & " <input disabled type=""text"" size=""10""  name='L_" & L & "_Reste' value='"
         End If
       
        If Trim("" & Reste_Rec) <> "" Then Reste = Reste_Rec
          AfficherCommande = AfficherCommande & vbCrLf & Reste
         If Request("NumerBr") = "" Then
             AfficherCommande = AfficherCommande & vbCrLf & "'>"
        End If
        AfficherCommande = AfficherCommande & vbCrLf & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
     
     'Linge Titre 2
       AfficherCommande = AfficherCommande & vbCrLf & " <tr>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Type")) & "</td>"
      
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt non Conf.")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt D&eacute;t&eacute;rior.")) & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt Retour Four.")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Stock Encelade")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Stock E Boutique")) & "</td>"

 
    
    AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
     'Linge Data 2
        
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
           If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & MType & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""100""  name='L_" & L & "_MType'  value=""" & MType & """></td>"
        End If
        
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Qt_non_Conf & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""10""  name='L_" & L & "_Qt_non_Conf'  value=""" & Qt_non_Conf & """ onchange=""ControlEntier('frmBr','L_" & L & "_Qt_non_Conf','L_" & L & "_Qte_Rec');""></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Qt_Deterior & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""10""  name='L_" & L & "_Qt_Deterior'  value=""" & Qt_Deterior & """ onchange=""ControlEntier('frmBr','L_" & L & "_Qt_Deterior','L_" & L & "_Qte_Rec');""></td>"
        End If
        If Request("NumerBr") <> "" Then
                        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Retour_Four & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""10""  name='L_" & L & "_Retour_Four'  value=""" & Retour_Four & """ onchange=""ControlRetourFournisseurs('frmBr','L_" & L & "_Retour_Four','L_" & L & "_Qte_Rec','" & L & "');""></td>"
        End If
       
   If Request("NumerBr") <> "" Then
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Stock_Encelade & "</td>"
    Else
        AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text""   size=""10""  name='L_" & L & "_Stock_Encelade' value=""" & Stock_Encelade & """ onchange=""StockEboutique('frmBr','L_" & L & "_Qte_Rec','L_" & L & "_Stock_Encelade' ,'L_" & L & "_Stock_Eboutique','L_" & L & "_Retour_Four');""></td>"
    End If
    If Request("NumerBr") <> "" Then
        AfficherCommande = AfficherCommande & vbCrLf & "          <td colspan=""4"" align=""center"" >" & Stock_Eboutique & "</td>"
    Else
        AfficherCommande = AfficherCommande & vbCrLf & "          <td colspan=""4"" align=""center"" ><input type=""text""  size=""10""  name='L_" & L & "_Stock_Eboutique' value=""" & Stock_Eboutique & """ onchange=""StockEboutique('frmBr','L_" & L & "_Qte_Rec' ,'L_" & L & "_Stock_Eboutique','L_" & L & "_Stock_Encelade','L_" & L & "_Retour_Four');"");"" ></td>"
    End If
    
        AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
        AfficherCommande = AfficherCommande & vbCrLf & "</tr>"
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
    
    
     
         'Linge Titre 3
        AfficherCommande = AfficherCommande & vbCrLf & "        <td  class=""TextTrEntete"" valign=""top"">"
    AfficherCommande = AfficherCommande & vbCrLf & "            <table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
    AfficherCommande = AfficherCommande & vbCrLf & "                  <tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td align=""left"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td class=""ecomtitrecaddie"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td align=""right"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      </tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "            </table>"
    AfficherCommande = AfficherCommande & vbCrLf & "        </td>"
    
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Attendue le")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Relancer le")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Rec. le")) & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Ecart Rec.")) & "</td>"


    AfficherCommande = AfficherCommande & vbCrLf & "        <td  class=""TextTrEntete"" valign=""top"">"
    AfficherCommande = AfficherCommande & vbCrLf & "            <table border=""0"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
    AfficherCommande = AfficherCommande & vbCrLf & "                  <tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td align=""left"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td class=""ecomtitrecaddie"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      <td align=""right"">&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "                      </tr>"
    AfficherCommande = AfficherCommande & vbCrLf & "            </table>"
    AfficherCommande = AfficherCommande & vbCrLf & "        </td>"
    AfficherCommande = AfficherCommande & vbCrLf & "</tr>"
     'Linge Data 3  GeneDateRecepPrevue
     If Attendue_le = "" Then Attendue_le = GeneDateRecepPrevue
       If Relancer_le = "" Then Relancer_le = GeneDateRelance
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF height=""10"" width=""100%"">"
        AfficherCommande = AfficherCommande & vbCrLf & "<td align=""right"">&nbsp;</td>"
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Attendue_le & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text""   size=""8""  name='L_" & L & "_Attendue_le' value=""" & Attendue_le & """ onchange=""EcatDate('frmBr','j','L_" & L & "_Attendue_le','L_" & L & "_Rec_le','L_" & L & "_Ecart_Rec');""><a href=""javascript:AfficherCalendar('frmBr','L_" & L & "_Attendue_le');""><img src=""c_btn.bmp"" border=""0""></a></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Relancer_le & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text""  size=""8""  name='L_" & L & "_Relancer_le' value=""" & Relancer_le & """ onchange=""SaisieDate('frmBr','L_" & L & "_Relancer_le');"" ><a href=""javascript:AfficherCalendar('frmBr','L_" & L & "_Relancer_le');""><img src=""c_btn.bmp"" border=""0""></a></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Rec_le & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""8""  name='L_" & L & "_Rec_le' value=""" & Rec_le & """ onchange=""EcatDate('frmBr','j','L_" & L & "_Attendue_le','L_" & L & "_Rec_le','L_" & L & "_Ecart_Rec');"" ><a href=""javascript:AfficherCalendar('frmBr','L_" & L & "_Rec_le');""><img src=""c_btn.bmp"" border=""0""></a></td>"
        End If
        If Request("NumerBr") <> "" Then
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" >" & Ecart_Rec & "</td>"
        Else
            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""10""  name='L_" & L & "_Ecart_Rec' value=""" & Ecart_Rec & """>"
        End If
'        If Request("NumerBr") <> "" Then hidden
            AfficherCommande = AfficherCommande & vbCrLf & "          <input type=""hidden"" size=""10""  name='L_" & L & "_Flag' value=""" & Flag & """></td>"
'        Else
'            AfficherCommande = AfficherCommande & vbCrLf & "          <td align=""center"" ><input type=""text"" size=""10""  name='L_" & L & "_Flag' value=""" & Flag & """></td>"
'        End If
AfficherCommande = AfficherCommande & vbCrLf & "<td align=""right"">&nbsp;</td>"
        AfficherCommande = AfficherCommande & vbCrLf & " </tr>"
         AfficherCommande = AfficherCommande & vbCrLf & " </tr><td>&nbsp;</td></tr>"
    RsDetailCommandFour.MoveNext
    Wend
    AfficherCommande = AfficherCommande & vbCrLf & "<input type=""hidden"" name=""L"" value=""" & L & """>"
    AfficherCommande = AfficherCommande & vbCrLf & "</table>"
    If Request("NumerBr") = "" Then
        AfficherCommande = AfficherCommande & vbCrLf & ("<table border=0 width='100%' cellpadding='2' cellspacing='0' class='smallheader'>")
        AfficherCommande = AfficherCommande & vbCrLf & ("<td align=""right""><a href='javascript:this.document.frmBr.submit();'><img src=""" & Session("candidat_EcomPathImages") & "Eb_Valider.GIF"" border=""0""></a>")
        AfficherCommande = AfficherCommande & vbCrLf & ("</tr></table>")
     End If
    AfficherCommande = AfficherCommande & vbCrLf & "</Form>"
Else
    AfficherCommande = AfficherCommande & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
    AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#CDD2F1 height=""10"">"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=50% align=""center"">D&eacute;signation</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">R&eacute;f&eacute;rence</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">Quantit&eacute;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">Prix Unit. H.T. </td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">Remise %</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">Prix total H.T. </td>"
    AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
    
    Sql = "SELECT T_Devis_Four.* From T_Devis_Four "
    Sql = Sql & "WHERE T_Devis_Four.Id_Com_Four=" & numDevis & ";"
    Set RsDetailCommandFour = Conn.Execute(Sql)
    PrixTotalTtc = 0
    While RsDetailCommandFour.EOF = False
        
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF  height=""10"">"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=50% align=""Left"">" & RsDetailCommandFour!Designation & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center"">" & RsDetailCommandFour!RefProduit & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & RsDetailCommandFour!qte_produit & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & RsDetailCommandFour!PrixU_produit & "</td>"
           AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & RsDetailCommandFour!Remise * 100 & "</td>"
        PrixTotalTtc = PrixTotalTtc + RsDetailCommandFour!qte_produit * RsDetailCommandFour!PrixU_produit * (1 - val(Replace("" & RsDetailCommandFour!Remise, ",", ".")))
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & RsDetailCommandFour!qte_produit * RsDetailCommandFour!PrixU_produit * (1 - val(Replace("" & RsDetailCommandFour!Remise, ",", "."))) & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
        RsDetailCommandFour.MoveNext
    Wend
    RsDetailCommandFour.Close
    Set RsDetailCommandFour = Nothing
     If val(Replace(Trim(ValTansport), ",", ".")) <> 0 Then
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF  height=""10"">"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=50% align=""Left"">Frais de transport</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center""></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
           AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
        PrixTotalTtc = PrixTotalTtc + ValTansport
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & ValTansport & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
     End If
     If val(Replace(Trim(PTHT), ",", ".")) <> 0 Then
        AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF  height=""10"">"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=50% align=""Left"">Frais divers</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""center""></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
           AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right""></td>"
        PrixTotalTtc = PrixTotalTtc + PTHT
        AfficherCommande = AfficherCommande & vbCrLf & "        <td width=10% align=""right"">" & PTHT & "</td>"
        AfficherCommande = AfficherCommande & vbCrLf & "    </tr>"
     End If
    AfficherCommande = AfficherCommande & vbCrLf & "    <tr  bgcolor=#FFFFFF  height=""10"">"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td align=""right"" colspan=""5"">Total H.T.&nbsp;&nbsp;</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "        <td align=""right"" >" & PrixTotalTtc & "</td>"
    AfficherCommande = AfficherCommande & vbCrLf & "</table>"
End If
'AfficherCommande = AfficherCommande & vbCrLf & "</Form >"


AfficherCommande = AfficherCommande & vbCrLf & "</td><td background=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgd.gif"" width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgd.gif"" width=""18"" height=""8""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr><tr><td width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bg.gif"" width=""17"" height=""16""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "<td background=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgb.gif""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bgb.gif"" width=""11"" height=""16""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "<td width=""1""><img src=""" & Session("contact_devis")
AfficherCommande = AfficherCommande & vbCrLf & "bd.gif"" width=""18"" height=""16""></td>"
AfficherCommande = AfficherCommande & vbCrLf & "</tr></table>"
AfficherCommande = AfficherCommande & vbCrLf & "</body>"
AfficherCommande = AfficherCommande & vbCrLf & "</html>"

 Session("MSGCommande") = ""
End Function
Public Sub MettreAJourQuantite(inMENU, inPRODUIT, inQTE)
 Sql = "SELECT Path FROM BaseDefault"
 Set Conn1 = OpenDb(Session("candidat_ADOContact"))
 Dim Rs As Recordset
 Set Rs = Conn1.Execute(Sql)
 sPath = Rs("Path")
 Rs.Close
 Conn1.Close
 Set Conn1 = Nothing
 Set Conn1 = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & sPath)
 Sql = "SELECT Base FROM Menu WHERE CatId = " & inMENU
 Set Rs = Conn1.Execute(Sql)
 sField = GetDefault("ChampQuantite", "txt11", "DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Base"))
 StockEncelade = GetDefault("StockEncelade", "TXT81", "DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Base"))
 Set ConnQuantite = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & Rs("Base"))
 Rs.Close
 Sql = "SELECT " & sField & " AS qte , " & StockEncelade & " AS qte2 FROM con_contacts WHERE ContactID = " & inPRODUIT
 Set Rs = ConnQuantite.Execute(Sql)
 If Rs("qte2") & "§§" = "§§" Then
   
    iQte2 = 0
    iQte2 = iQte2 - inQTE
    
 Else
    iQte2 = CInt(Rs("qte2")) - inQTE
    
 End If
 If Rs("qte") & "§§" = "§§" Then
    iQte = 0
    
    iQte = iQte - inQTE
    
 Else
    iQte = CInt(Rs("qte")) - inQTE
    
 End If
 If val(Trim("" & Session("Droits_SockEncelade"))) = 1 Then
    If iQte < 0 Then
     iQte2 = CInt(Rs("qte2")) - Abs(iQte)
     iQte = 0
    Else
     iQte2 = CInt(Rs("qte2"))
 End If
 Else
   iQte2 = CInt(Rs("qte2"))
 End If

 Rs.Close
 Set Rs = Nothing
' If val(Trim("" & Session("Droits_SockEncelade"))) = 1 Then
 Sql = "UPDATE con_contacts SET " & sField & " = '" & iQte & "' ," & StockEncelade & " = '" & iQte2 & "' , con_contacts.DeleteDate = '" & Format(Date, "yyyy-mm-dd hh:mm:ss") & "'WHERE ContactID = " & inPRODUIT
 ConnQuantite.Execute (Sql)
 ConnQuantite.Close
 Set ConnQuantite = Nothing
 Conn1.Close
 Set Conn1 = Nothing
End Sub

Private Function CrerDevis2(id_livraison, UserID, Conn, numDevis, NousContacter)
Dim Sql As String
Dim Rs As Recordset
Sql = "SELECT Users.*, t_R_Social.*, t_pays.label_pays FROM (t_R_Social INNER JOIN Users ON  t_R_Social.SocieteId = Users.UserID) INNER JOIN t_pays ON t_R_Social.id_pays = t_pays.id_pays WHERE  t_R_Social.SocieteId=" & UserID & ";"
Set Rs = Conn.Execute(Sql)
CrerDevis2 = ""
CrerDevis2 = CrerDevis2 & vbCrLf & "<html>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<head>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<title>Devis N° " & numDevis & "</title>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<meta http-equiv=""Content-Type"" content=""text/html; charset=iso-8859-1"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "</head>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "<body bgcolor=""#FFFFFF"" text=""#000000"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table width=""94%"" border=""0""  >"
CrerDevis2 = CrerDevis2 & vbCrLf & "<tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<td width=""20%""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<td width=""60%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table width=""100%"" border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "Encelade.jpg"" >"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        "
CrerDevis2 = CrerDevis2 & vbCrLf & "    <td width=""100%"" height=""57"">&nbsp;</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<br>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Nous Contacter</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "   <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Service technique :</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td><A href='mailto:" & NousContacter & "'>" & NousContacter & "</A></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "   </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<br>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Coordonn&eacute;es du demandeur</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "   <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Nom / Pr&eacute;nom:</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!LastName & " " & Rs!FirstName & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "   </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    "
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Soci&eacute;t&eacute;</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >" & Rs!fld3 & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
'CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Num&eacute;ro FNA</td>"
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >" & Rs!fld2 & "</td>"
'CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    "
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >Adresse</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!Address & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>CP</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!Zip & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >Ville / Pays</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!City & " " & Rs!label_pays & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    "
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Email</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> <A href='mailto:" & Rs!EMail & "'>" & Rs!EMail & "</A></td> "
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>T&eacute;l&eacute;phone / Fax</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> "
                                            If Trim("" & Rs!phone) <> "" Then
CrerDevis2 = CrerDevis2 & vbCrLf & Rs!phone
                                                If Trim("" & Rs!fax) <> "" Then
CrerDevis2 = CrerDevis2 & vbCrLf & "          / " & Rs!fax
                                                End If
                                            Else
                                                If Trim("" & Rs!fax) = "" Then
CrerDevis2 = CrerDevis2 & vbCrLf & Rs!fax
                                                Else
CrerDevis2 = CrerDevis2 & vbCrLf & "&nbsp;"
                                                End If
                                            End If
CrerDevis2 = CrerDevis2 & vbCrLf & "</td> "
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
'CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Portable</td>"
'                                            If Trim("" & Rs!Portable) = "" Then
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> &nbsp;</td> "
'                                            Else
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> " & Rs!Portable & "</td> "
'                                            End If
'
'CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
'CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Fax</td>"
'                                            If Trim("" & Rs!Fax) = "" Then
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> &nbsp;</td> "
'                                            Else
'CrerDevis2 = CrerDevis2 & vbCrLf & "        <td> " & Rs!Fax & "</td> "
'                                            End If
'
'CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<br>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""ecomtitrecaddie2"" > Adresse de livraison</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
Sql = ""
Sql = Sql & "SELECT t_livraison.id_livraison, t_livraison.id_pays, t_livraison.beneficiare_liv,  "
Sql = Sql & "t_livraison.adresse_liv, t_livraison.cp_liv, t_livraison.ville_liv,  "
Sql = Sql & "t_livraison.date_liv, t_livraison.cadeau, t_livraison.cadeau_texte "
Sql = Sql & "From t_livraison "
Sql = Sql & "WHERE t_livraison.id_livraison=" & id_livraison & ";"

Set Rs = Conn.Execute(Sql)

CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >B&eacute;n&eacute;ficiaire:</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!beneficiare_liv & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td >Adresse</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!adresse_liv & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>CP</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!cp_liv & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>Ville</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td>" & Rs!ville_liv & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<br>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=""0"" background=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandebg.gif"" cellpadding=""0"" cellspacing=""0"" width=""100%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""left"" ><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "bandeg.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""ecomtitrecaddie2"" >Devis N°: " & numDevis & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td width=""5%"" align=""right""><img src=""" & Session("contact_devis") & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "banded.gif"" border=""0""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & ""
CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=""0"" width=""100%"">"
CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr>"

CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Type de pi&egrave;ce")) & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        "
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("R&eacute;f&eacute;rence")) & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "        <td class=""TextTrEntete"" valign='center' align='center'>" & ImgEnteteColonne(translate("Qt&eacute;")) & "</td>"


CrerDevis2 = CrerDevis2 & vbCrLf & "    </tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</Table>"
Sql = ""
Sql = Sql & "SELECT t_Devis.*, t_Devis.numDevis "
Sql = Sql & "From t_Devis "
Sql = Sql & "WHERE t_Devis.numDevis='" & numDevis & "';"

Set Rs = Conn.Execute(Sql)

CrerDevis2 = CrerDevis2 & vbCrLf & "<table border=0 width=""100%"" cellpadding=""0"" cellspacing=""1"">"
While Rs.EOF = False
    CrerDevis2 = CrerDevis2 & vbCrLf & "    <tr  bgcolor=#D3DFEF height=""10"">"
    CrerDevis2 = CrerDevis2 & vbCrLf & "                    "
    CrerDevis2 = CrerDevis2 & vbCrLf & "          <td width=""247"">" & Rs!TypePiece & "</td>"
    CrerDevis2 = CrerDevis2 & vbCrLf & "                    "
    CrerDevis2 = CrerDevis2 & vbCrLf & "          <td width=""195"" >" & Rs!RefProduit & "</td>"
    CrerDevis2 = CrerDevis2 & vbCrLf & "                    "
    CrerDevis2 = CrerDevis2 & vbCrLf & "          <td align='right' width=""114"">" & Rs!qte_produit & "</td>"
    CrerDevis2 = CrerDevis2 & vbCrLf & "                  </tr>"
    Rs.MoveNext
Wend
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "<td width=""20%""></td>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</tr>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</table>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</body>"
CrerDevis2 = CrerDevis2 & vbCrLf & "</html>"
Rs.Close
Set Rs = Nothing
End Function

Function ExecSqlListe(RsMenu As Recordset, STRSQL)
On Error Resume Next
While RsMenu.EOF = False
                Set ConnLst = OpenDb("DRIVER={Microsoft Access Driver (*.mdb)};DBQ=" & RsMenu!Base)
                ConnLst.Execute (STRSQL)
                RsMenu.MoveNext
                
            Wend
            ConnLst.Close
            Set ConnLst = Nothing
            Err.Clear
End Function

Private Sub Class_Terminate()
 'MsgBox "toto"
End Sub
Function InsertEntrpriseCommandFor(Conn, Id_Menu, IdPiece, ResonSocial) As Long

End Function
Public Function NumeroChrono(Recherche, Prefix) As String


Dim txtValue As String
Set Conn = OpenDb(DsnTableMenu(Session("candidat_ADOContact")))
txtValue = GetDefault(Recherche, Prefix, DsnTableMenu(Session("candidat_ADOContact")))
Set rsnumdevis = Conn.Execute("SELECT t_NumDevis.* FROM t_NumDevis where t_NumDevis.type='" & Recherche & "';")
    If rsnumdevis.EOF = True Then
        Conn.Execute "INSERT INTO t_NumDevis ( NumDevis, Mydate,type ) values( 1 , Now() ,'" & Recherche & "');"
        NumeroChrono = 1
    Else
        If Format(rsnumdevis!MyDate, "dd/mm/yyyy") = Format(Date, "dd/mm/yyyy") Then
            NumeroChrono = rsnumdevis!numDevis + 1
        Else
            NumeroChrono = 1
        End If
        
    End If
    Sql = "UPDATE t_NumDevis SET t_NumDevis.NumDevis =" & NumeroChrono & ", t_NumDevis.Mydate = Now() where t_NumDevis.type='" & Recherche & "';"
   ' Session("MySql") =' Session("MySql") & vbCrLf & Sql & "<br><br>"
    Conn.Execute Sql
    
    NumeroChrono = Prefix & Format(Date, "#") & "_" & NumeroChrono
End Function
Public Function Fun_ID_Cadie(NumCadi, Conn) As Long
Sql = "INSERT INTO T_NumCadi ( NumCadi,Id_User ) VALUES( '" & NumCadi & "'," & Session("UserId") & " );"
        Conn.Execute (Sql)
        Sql = "SELECT T_NumCadi.id From T_NumCadi "
        Sql = Sql & "WHERE T_NumCadi.NumCadi='" & NumCadi & "';"
        Set Rs = Conn.Execute(Sql)
        If Rs.EOF = False Then
           Id_Caddie = Rs("id")
           Session("candidat_num_id_caddy") = Id_Caddie
            Session("candidat_id_caddy") = Id_Caddie
            Fun_ID_Cadie = Session("candidat_num_id_caddy")
        End If
        Rs.Close
        Set Rs = Nothing
End Function

Public Function FormatChamp(D) As String
If Trim("" & D) = "" Then
    FormatChamp = "NULL"
Else
    If IsDate(D) Then
        FormatChamp = "#" & Format(D, "yyyy-mm-dd h:m:s") & "#"
    Else
        FormatChamp = noquoteNum(D)
      If Not IsNumeric(FormatChamp) Then
                FormatChamp = noquote2(D)
        End If
    End If
End If
End Function

Sub MajEbotique(Rs As Recordset, Conn, Frai As Double)
Dim Sql As String
Dim RsEb As Recordset
Dim DbEb As String
Dim MoteurJet As String
Coeff = val(GetDefault("CoefficientVante", "3", DsnTableMenu(Session("candidat_ADOContact"))))
Prixderevient = (val("" & Rs!Qte_Rec) - val("" & Rs!Retour_Four)) * Rs!PrixU_produit
Prixderevient = Prixderevient + (Frai * (val("" & Rs!Qte_Rec) - val("" & Rs!Retour_Four)))
valQtsProduit = Prixderevient * Coeff



QtRec = (val("" & Rs!Qte_Rec) - val("" & Rs!Retour_Four))
DateEntreStock = (val("" & Rs!DateEntreStock))
SokeEncelade = (val("" & Rs!SokeEncelade))
SokEbotique = (val("" & Rs!SokEbotique))
MoteurJet = "DRIVER={Microsoft Access Driver (*.mdb)}; DBQ="
Sql = "SELECT Menu.Base  From Menu "
Sql = Sql & "WHERE Menu.CatId=" & Rs!Id_Menu & ";"
Set RsEb = Conn.Execute(Sql)
If RsEb.EOF = False Then
        DbEb = "" & RsEb!Base
End If
If Trim("" & DbEb) <> "" Then
    RefCaddyPrixU = GetDefault("RefCaddyPrixU", "txt9", MoteurJet & DbEb)
    ChampQuantite = GetDefault("ChampQuantite", "txt11", MoteurJet & DbEb)
    ChampQuantiteEncelade = GetDefault("ChampQuantiteEncelade", "txt81", MoteurJet & DbEb)
    ChampStockInitial = GetDefault("ChampStockInitial", "txt48", MoteurJet & DbEb)
    ChampPrixderevient = GetDefault("Prixderevient", "txt47", MoteurJet & DbEb)
    

    Sql = "SELECT  Connecteur." & ChampPrixderevient & " AS [Prixderevient],Connecteur." & ChampQuantite & " AS [SokEbotique], Connecteur." & ChampStockInitial & " AS [Qts Initial],  "
    Sql = Sql & "Connecteur." & ChampQuantiteEncelade & " AS [Stock Encelade], Connecteur." & RefCaddyPrixU & " AS [PU HT en ] "
    Sql = Sql & "FROM (SELECT  con_contacts.* FROM  con_contacts   "
    Sql = Sql & "IN '" & DbEb & "')  AS Connecteur "
    Sql = Sql & "WHERE Connecteur.ContactID=" & Rs!id_produit & ";"
    Set RsEb = Conn.Execute(Sql)
    QtsInitial = val("" & RsEb![Qts Initial])
    Prixderevient = Prixderevient + (QtsInitial * val(Replace("" & RsEb!Prixderevient, ",", ".")))
     
   
    PUHT = val(Replace("" & RsEb![PU HT en ], ",", "."))
    PrixPonderrer = QtsInitial * PUHT
    PrixPonderrer = valQtsProduit + PrixPonderrer
     PrixPonderrer = PrixPonderrer * (1 / (QtRec + QtsInitial))
     
    Prixderevient = Prixderevient * (1 / (QtRec + QtsInitial))
    
    SokEbotiqueEb = val("" & RsEb![SokEbotique])
    StockEnceladeEb = val("" & RsEb![Stock Encelade])
    QtsInitial = QtRec + SokEbotiqueEb + StockEnceladeEb
    SokeEncelade = SokeEncelade + StockEnceladeEb
    SokEbotique = SokEbotique + SokEbotiqueEb
    QtsInitial = SokeEncelade + SokEbotique
   

    Sql = "UPDATE (SELECT  con_contacts.* FROM  con_contacts    "
    Sql = Sql & "IN '" & DbEb & "') AS Mytable  "
    Sql = Sql & "SET Mytable." & ChampQuantite & "  = '" & SokEbotique & "',    "
    Sql = Sql & "Mytable." & ChampPrixderevient & "  = '" & Prixderevient & "',    "
     Sql = Sql & "Mytable.ModificationDate='" & Format(Now, "yyyy-mm-dd hh:mm:ss") & "', "
    Sql = Sql & "Mytable." & ChampStockInitial & " = '" & QtsInitial & "',    "
    Sql = Sql & "Mytable." & ChampQuantiteEncelade & " = '" & SokeEncelade & "',    "
    Sql = Sql & "Mytable." & RefCaddyPrixU & " = '" & Replace(PrixPonderrer, ",", ".") & " ' "
    Sql = Sql & "WHERE Mytable.ContactID=" & Rs!id_produit & " "
    
    Conn.Execute Sql
    
    Sql = "UPDATE ((T_Devis_Fournisseurs INNER JOIN T_Devis_Four ON T_Devis_Fournisseurs.Id = T_Devis_Four.Id_Com_Four) "
    Sql = Sql & "INNER JOIN T_BR ON T_Devis_Fournisseurs.Id = T_BR.Id_Com_Four) "
    Sql = Sql & "INNER JOIN Br_Fournisseurs ON (Br_Fournisseurs.id_produit = T_Devis_Four.id_produit) "
    Sql = Sql & "AND (T_BR.Id = Br_Fournisseurs.Id_Br) "
    Sql = Sql & "SET T_Devis_Four.Reste =Val('' & [T_Devis_Four].[Reste])-Val('' & [Qte_Rec])+Val('' & [Br_Fournisseurs].[Retour_Four]) , "
    Sql = Sql & "Br_Fournisseurs.Reste = val('' & [Br_Fournisseurs].[Reste])-val('' & [Qte_Rec])+Val('' & [Br_Fournisseurs].[Retour_Four]) "
    Sql = Sql & "WHERE Br_Fournisseurs.id_produit=" & Rs!id_produit & " "
    Sql = Sql & "AND T_BR.Id=" & Rs!Id_Br & ";"

    Conn.Execute Sql
    
    
    
    Sql = "UPDATE Br_Fournisseurs SET  "
    Sql = Sql & "Br_Fournisseurs.DateEntreStock= " & FormatChamp(Now) & "  "
    Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Rs!Id_Br & "  "
    Sql = Sql & "AND Br_Fournisseurs.id_produit=" & Rs!id_produit & ";"
            
    Conn.Execute Sql
            
    Sql = "SELECT Sum(Br_Fournisseurs.Reste) AS TotalReste From Br_Fournisseurs "
    Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Rs!Id_Br & "; "
   
     Set RsBrSolder = Conn.Execute(Sql)
    If RsBrSolder!TotalReste = 0 Then
        Sql = "UPDATE T_Devis_Fournisseurs INNER JOIN (T_BR INNER JOIN Br_Fournisseurs ON T_BR.Id =  "
        Sql = Sql & "Br_Fournisseurs.Id_Br) ON T_Devis_Fournisseurs.Id = T_BR.Id_Com_Four SET T_Devis_Fournisseurs.brSolder = True "
        Sql = Sql & "WHERE Br_Fournisseurs.Id_Br=" & Rs!Id_Br & ";"
        Conn.Execute Sql
        
    End If
    
    Sql = "UPDATE T_BR SET T_BR.Solder = True "
    Sql = Sql & "WHERE T_BR.ID=" & Rs!Id_Br & ";"
    Conn.Execute Sql
    
End If
End Sub
Sub IsRecherche(Optional boolExec As Boolean = True)
Dim Recherche As Boolean
Debug.Print UCase(Trim(Request("mode")))
Recherche = val(Trim("" & Session("portal_candidat_Recherhe")))
Recherche = Recherche And boolExec
If UCase(Trim("" & Session("ESPACECLIENT"))) = "ESPACECLIENT" Then Recherche = False

'Select Case UCase(Trim(Request("mode")))
'            Case "ESPACECLIENT"
'                Recherche = False
'            Case "ECOM_NUMCOMADE"
'                Recherche = False
'            Case "CANDIDAT_CADDY"
'                Recherche = False
'            Case "CANDIDAT_CADDYREMPLI"
'                Recherche = False
'            Case "VALIDERCOMMANDE"
'                Recherche = False
'            Case "ECOM_NUMCOMADEVALIDER"
'                Recherche = False
'            Case "SEARCH"
'                Recherche = False
'            Case "LSTCATEGORY"
'                Recherche = False
'            Case "SUBCATEGORY"
'                 Recherche = False
'            Case "CON_FRMSETTING"
'                 Recherche = False
'            Case "CON_FRMFIELD"
'                 Recherche = False
'            Case "CON_FRMSETFIELD"
'                 Recherche = False
'            Case "CONFIG"
'                 Recherche = False
'            Case "RAISONSICIALENCELADE"
'                 Recherche = False
'            Case "CONFIGCLI"
'                 Recherche = False
'            Case "CONFIGCLI"
'                 Recherche = False
'
''            Case "CONFIGCLI_NEW"
'
'End Select
 If Len("" & Session("CloseWereSearch")) <> 0 Then Recherche = False
If Recherche = True Then Response.Redirect "Contact.asp?mode=SEARCH"
'
' If UCase(Trim("" & Session("ESPACECLIENT"))) <> "ESPACECLIENT" Then
'         If Session("portal_candidat_Recherhe") = 1 Then
'            If UCase(Trim(Request("mode"))) <> "ECOM_NUMCOMADE" Then
'             If UCase(Trim(Request("mode"))) <> "CANDIDAT_CADDY" Then
'                If UCase(Trim(Request("mode"))) <> "CANDIDAT_CADDYREMPLI" Then
'                    If UCase(Trim(Request("mode"))) <> "VALIDERCOMMANDE" Then
'                         If UCase(Trim(Request("mode"))) <> "ECOM_NUMCOMADEVALIDER" Then
'                             If (Len("" & Session("CloseWereSearch")) = 0) And (UCase(Trim(Request("mode"))) <> "SEARCH") Then
'                             Response.Redirect "Contact.asp?mode=SEARCH"
'                'Exit Sub
'                             End If
'                         End If
'                    End If
'                End If
'             End If
'       End If
'    End If
'
'End If
End Sub
Function ListeType(valueSelect As String, Name, Con, Optional Afficher As Boolean) As String
Sql = "SELECT T_Type_De_Frais.* From T_Type_De_Frais ORDER BY T_Type_De_Frais.Id;"

Set RsTypeFrais = Con.Execute(Sql)
Dim TableauTypFrais() As String
Dim selected As String
ListeType = ""
If Afficher = False Then
    ListeType = ListeType & vbCrLf & "<select name='" & Name & "' class='champ'>"
      
    ListeType = ListeType & vbCrLf & "<option value='' " & selected & ">"
 End If
 
While RsTypeFrais.EOF = False
If valueSelect = CStr(RsTypeFrais!Id) Then
    selected = " selected "
Else
    selected = ""
End If
If Afficher = True Then
    If Trim("" & selected) = "selected" Then
        ListeType = "" & RsTypeFrais!Libelle
        Exit Function
    End If
Else
  ListeType = ListeType & vbCrLf & "<option value='" & RsTypeFrais!Id & "' " & selected & ">" & RsTypeFrais!Libelle
End If
'TableauTypFrais(UBound(TableauTypFrais)) = "" & RsTypeFraismovenext!Libelle
    RsTypeFrais.MoveNext
Wend
If Afficher = False Then
ListeType = ListeType & vbCrLf & "</select>"
End If
End Function
Function LireId_Cadie(Id_Caddie, Conn) As Long
If Trim("" & Id_Caddie) <> "" Then
        
        
'        If Id_Caddie = 0 Then
'             Id_Caddie = val(Trim("" & Id_Caddie))
'
'        End If
    Else
  
        
        
      
        
        If Session("candidat_id_caddy") = "" Then
         Id_Caddie = Fun_ID_Cadie(NumeroChrono("CAD", "CAD_"), Conn)
         Else
         Id_Caddie = Session("candidat_id_caddy")
        End If
         
           
    End If
      Session("Id_Caddie") = Id_Caddie
         Session("candidat_id_caddy") = Id_Caddie
'     Session("candidat_id_caddy") = Session("Id_Caddie")
LireId_Cadie = val(Trim("" & Id_Caddie))
End Function

